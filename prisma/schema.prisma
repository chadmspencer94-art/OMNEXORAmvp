// Prisma Schema for OMNEXORA MVP
// NOTE: Using SQLite locally; migrations were created with sqlite.
// 
// SETUP INSTRUCTIONS:
// 1. Install Prisma: npm install prisma @prisma/client
// 2. Set DATABASE_URL in .env.local (e.g., file:./dev.db)
// 3. After modifying this schema, run:
//    npx prisma migrate dev --name add_user_ban_fields
//    npx prisma generate
//
// This will create the database tables and generate the Prisma Client.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  passwordHash String
  
  createdAt DateTime @default(now())
  
  // Role and verification
  role              String  @default("tradie")
  verificationStatus String @default("unverified")
  verifiedAt        DateTime?
  
  // Admin control
  isBanned      Boolean @default(false)
  accountStatus String  @default("ACTIVE")
  
  // Plan and billing
  planTier    String   @default("FREE")
  planStatus  String   @default("TRIAL")
  trialEndsAt DateTime?
  
  // Activity tracking
  lastLoginAt    DateTime?
  lastActivityAt DateTime?
  totalJobs      Int      @default(0)
  totalJobPacks  Int      @default(0)
  
  // Business details (flattened from businessDetails object)
  businessName        String?
  tradingName         String?
  abn                 String?
  tradeTypes  String?   // store comma-separated list for now
  serviceArea         String?
  serviceAreaCity     String?
  serviceAreaRadiusKm Int?
  
  // Business Profile fields (for quoting and job matching)
  primaryTrade        String?   // e.g. "Painter", "Plumber"
  doesResidential     Boolean   @default(true)
  doesCommercial      Boolean   @default(false)
  doesStrata          Boolean   @default(false)
  serviceRadiusKm     Int?      // typical max distance they travel from base
  servicePostcodes    String?   // comma/line separated postcodes/suburbs, free text
  hourlyRate          Int?      // hourly rate in dollars (stored as Int)
  calloutFee          Int?      // callout fee in dollars
  ratePerM2Interior   Int?      // rate per square metre interior
  ratePerM2Exterior   Int?      // rate per square metre exterior
  ratePerLmTrim       Int?      // rate per linear metre (e.g. trims, handrails)
  
  // Digital signature (for document signing)
  signatureImage      String?   // Data URL or image path for user signature
  signatureUpdatedAt  DateTime? // Last update timestamp
  
  // Password reset tokens
  passwordResetTokens PasswordResetToken[]
  
  // Job document signatures (as signer)
  jobDocumentSignatures JobDocumentSignature[]
  
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String   // hashed version of the token
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@map("password_reset_tokens")
}

model JobDocumentSignature {
  id            String   @id @default(cuid())
  jobId         String
  signedById    String?
  signedBy      User?    @relation(fields: [signedById], references: [id], onDelete: SetNull)
  signedName    String   // full name as typed by client
  role          String   // e.g. "CLIENT" (reserve for future like "BUILDER_CLIENT")
  docType       String   // e.g. "QUOTE" | "VARIATION" | "EOT" | "HANDOVER"
  docKey        String?  // optional: variation ID or document identifier if available
  signatureImage String? // data URL or path for client's drawn signature
  ipAddress     String?  // capture best effort for audit
  userAgent     String?  // best effort for audit
  signedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  
  @@map("job_document_signatures")
  @@index([jobId, docType, docKey])
}
