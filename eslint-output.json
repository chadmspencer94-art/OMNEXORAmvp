[{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\account-suspended\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\feedback\\FeedbackLogClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\feedback\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\pricing\\PriceListsClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLists' is assigned a value but never used.","line":19,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useTransition } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport {\n  createPriceList,\n  deletePriceList,\n  type PriceList,\n  type PriceListType,\n} from \"./actions\";\n\ninterface PriceListsClientProps {\n  initialLists: PriceList[];\n}\n\nexport default function PriceListsClient({ initialLists }: PriceListsClientProps) {\n  const router = useRouter();\n  const [lists, setLists] = useState<PriceList[]>(initialLists);\n  const [isPending, startTransition] = useTransition();\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [createForm, setCreateForm] = useState({\n    name: \"\",\n    type: \"TRADE\" as PriceListType,\n    description: \"\",\n  });\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(\"\");\n\n  const handleCreate = async () => {\n    if (!createForm.name.trim()) {\n      setError(\"Name is required\");\n      return;\n    }\n\n    setError(\"\");\n    setSuccess(\"\");\n\n    startTransition(async () => {\n      const result = await createPriceList(createForm.name, createForm.type, createForm.description);\n      if (result.success && result.id) {\n        setSuccess(\"Price list created successfully\");\n        setShowCreateModal(false);\n        setCreateForm({ name: \"\", type: \"TRADE\", description: \"\" });\n        // Refresh the page to get updated lists\n        router.refresh();\n      } else {\n        setError(result.error || \"Failed to create price list\");\n      }\n    });\n  };\n\n  const handleDelete = async (listId: string, listName: string) => {\n    if (!confirm(`Are you sure you want to delete \"${listName}\"? This will also delete all items in this list.`)) {\n      return;\n    }\n\n    setError(\"\");\n    setSuccess(\"\");\n\n    startTransition(async () => {\n      const result = await deletePriceList(listId);\n      if (result.success) {\n        setSuccess(\"Price list deleted successfully\");\n        router.refresh();\n      } else {\n        setError(result.error || \"Failed to delete price list\");\n      }\n    });\n  };\n\n  return (\n    <div>\n      {/* Messages */}\n      {error && (\n        <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\n          {error}\n        </div>\n      )}\n      {success && (\n        <div className=\"mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700\">\n          {success}\n        </div>\n      )}\n\n      {/* Actions */}\n      <div className=\"mb-6 flex justify-between items-center\">\n        <div className=\"text-sm text-slate-600\">\n          {lists.length} {lists.length === 1 ? \"list\" : \"lists\"}\n        </div>\n        <button\n          onClick={() => setShowCreateModal(true)}\n          className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors\"\n        >\n          Create Price List\n        </button>\n      </div>\n\n      {/* Lists Grid */}\n      {lists.length === 0 ? (\n        <div className=\"bg-white rounded-xl border border-slate-200 p-12 text-center\">\n          <p className=\"text-slate-500 mb-4\">No price lists yet.</p>\n          <button\n            onClick={() => setShowCreateModal(true)}\n            className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors\"\n          >\n            Create Your First Price List\n          </button>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {lists.map((list) => (\n            <div\n              key={list.id}\n              className=\"bg-white rounded-xl border border-slate-200 p-6 hover:shadow-lg transition-shadow\"\n            >\n              <div className=\"flex items-start justify-between mb-4\">\n                <div className=\"flex-1\">\n                  <h3 className=\"text-lg font-semibold text-slate-900 mb-1\">{list.name}</h3>\n                  <span\n                    className={`inline-block px-2 py-1 text-xs font-medium rounded ${\n                      list.type === \"TRADE\"\n                        ? \"bg-blue-100 text-blue-700\"\n                        : \"bg-green-100 text-green-700\"\n                    }`}\n                  >\n                    {list.type}\n                  </span>\n                </div>\n              </div>\n\n              {list.description && (\n                <p className=\"text-sm text-slate-600 mb-4 line-clamp-2\">{list.description}</p>\n              )}\n\n              <div className=\"text-sm text-slate-500 mb-4\">\n                {list.items.length} {list.items.length === 1 ? \"item\" : \"items\"}\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Link\n                  href={`/admin/pricing/${list.id}`}\n                  className=\"flex-1 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors text-center\"\n                >\n                  View & Edit\n                </Link>\n                <button\n                  onClick={() => handleDelete(list.id, list.name)}\n                  disabled={isPending}\n                  className=\"px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50\"\n                >\n                  Delete\n                </button>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* Create Modal */}\n      {showCreateModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl p-6 max-w-md w-full mx-4\">\n            <h2 className=\"text-xl font-bold text-slate-900 mb-4\">Create Price List</h2>\n\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Name *</label>\n                <input\n                  type=\"text\"\n                  value={createForm.name}\n                  onChange={(e) => setCreateForm({ ...createForm, name: e.target.value })}\n                  className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                  placeholder=\"e.g., Paint Supplies Trade List\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Type *</label>\n                <select\n                  value={createForm.type}\n                  onChange={(e) => setCreateForm({ ...createForm, type: e.target.value as PriceListType })}\n                  className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                >\n                  <option value=\"TRADE\">Trade</option>\n                  <option value=\"SHELF\">Shelf</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Description</label>\n                <textarea\n                  value={createForm.description}\n                  onChange={(e) => setCreateForm({ ...createForm, description: e.target.value })}\n                  className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\n                  rows={3}\n                  placeholder=\"Optional description...\"\n                />\n              </div>\n            </div>\n\n            <div className=\"flex gap-3 mt-6\">\n              <button\n                onClick={handleCreate}\n                disabled={isPending || !createForm.name.trim()}\n                className=\"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {isPending ? \"Creating...\" : \"Create\"}\n              </button>\n              <button\n                onClick={() => {\n                  setShowCreateModal(false);\n                  setCreateForm({ name: \"\", type: \"TRADE\", description: \"\" });\n                  setError(\"\");\n                }}\n                disabled={isPending}\n                className=\"px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-sm font-medium rounded-lg transition-colors\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\pricing\\[listId]\\PriceListDetailClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setList' is assigned a value but never used.","line":21,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useTransition } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport {\r\n  addPriceListItem,\r\n  updatePriceListItem,\r\n  deletePriceListItem,\r\n  importPriceListItemsFromCSV,\r\n  type PriceList,\r\n  type PriceListItem,\r\n} from \"../actions\";\r\n\r\ninterface PriceListDetailClientProps {\r\n  initialList: PriceList;\r\n}\r\n\r\nexport default function PriceListDetailClient({ initialList }: PriceListDetailClientProps) {\r\n  const router = useRouter();\r\n  const [list, setList] = useState<PriceList>(initialList);\r\n  const [isPending, startTransition] = useTransition();\r\n  const [showAddModal, setShowAddModal] = useState(false);\r\n  const [showImportModal, setShowImportModal] = useState(false);\r\n  const [editingItem, setEditingItem] = useState<PriceListItem | null>(null);\r\n  const [itemForm, setItemForm] = useState<Omit<PriceListItem, \"id\">>({\r\n    name: \"\",\r\n    sku: \"\",\r\n    unit: \"\",\r\n    tradePrice: undefined,\r\n    shelfPrice: undefined,\r\n    cost: undefined,\r\n    notes: \"\",\r\n  });\r\n  const [csvContent, setCsvContent] = useState(\"\");\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(\"\");\r\n\r\n  const resetForm = () => {\r\n    setItemForm({\r\n      name: \"\",\r\n      sku: \"\",\r\n      unit: \"\",\r\n      tradePrice: undefined,\r\n      shelfPrice: undefined,\r\n      cost: undefined,\r\n      notes: \"\",\r\n    });\r\n    setEditingItem(null);\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n  };\r\n\r\n  const handleAddItem = async () => {\r\n    if (!itemForm.name.trim()) {\r\n      setError(\"Item name is required\");\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n\r\n    startTransition(async () => {\r\n      const result = await addPriceListItem(list.id, itemForm);\r\n      if (result.success) {\r\n        setSuccess(\"Item added successfully\");\r\n        setShowAddModal(false);\r\n        resetForm();\r\n        router.refresh();\r\n      } else {\r\n        setError(result.error || \"Failed to add item\");\r\n      }\r\n    });\r\n  };\r\n\r\n  const handleUpdateItem = async () => {\r\n    if (!itemForm.name.trim()) {\r\n      setError(\"Item name is required\");\r\n      return;\r\n    }\r\n\r\n    if (!editingItem?.id) {\r\n      setError(\"Cannot update item: missing item ID.\");\r\n      return;\r\n    }\r\n\r\n    const itemId = editingItem.id;\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n\r\n    startTransition(async () => {\r\n      const result = await updatePriceListItem(itemId, itemForm);\r\n      if (result.success) {\r\n        setSuccess(\"Item updated successfully\");\r\n        setShowAddModal(false);\r\n        resetForm();\r\n        router.refresh();\r\n      } else {\r\n        setError(result.error || \"Failed to update item\");\r\n      }\r\n    });\r\n  };\r\n\r\n  const handleDeleteItem = async (itemId: string, itemName: string) => {\r\n    if (!confirm(`Are you sure you want to delete \"${itemName}\"?`)) {\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n\r\n    startTransition(async () => {\r\n      const result = await deletePriceListItem(itemId);\r\n      if (result.success) {\r\n        setSuccess(\"Item deleted successfully\");\r\n        router.refresh();\r\n      } else {\r\n        setError(result.error || \"Failed to delete item\");\r\n      }\r\n    });\r\n  };\r\n\r\n  const handleImportCSV = async () => {\r\n    if (!csvContent.trim()) {\r\n      setError(\"CSV content is required\");\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n\r\n    startTransition(async () => {\r\n      const result = await importPriceListItemsFromCSV(list.id, csvContent);\r\n      if (result.success) {\r\n        setSuccess(`Successfully imported ${result.imported} items`);\r\n        if (result.errors.length > 0) {\r\n          setError(`Some errors occurred: ${result.errors.join(\", \")}`);\r\n        }\r\n        setShowImportModal(false);\r\n        setCsvContent(\"\");\r\n        router.refresh();\r\n      } else {\r\n        setError(result.errors.join(\", \") || \"Failed to import CSV\");\r\n      }\r\n    });\r\n  };\r\n\r\n  const openEditModal = (item: PriceListItem) => {\r\n    setEditingItem(item);\r\n    setItemForm({\r\n      name: item.name,\r\n      sku: item.sku || \"\",\r\n      unit: item.unit || \"\",\r\n      tradePrice: item.tradePrice,\r\n      shelfPrice: item.shelfPrice,\r\n      cost: item.cost,\r\n      notes: item.notes || \"\",\r\n    });\r\n    setShowAddModal(true);\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      {/* Header */}\r\n      <div className=\"mb-6\">\r\n        <Link\r\n          href=\"/admin/pricing\"\r\n          className=\"text-sm text-purple-600 hover:text-purple-700 font-medium mb-4 inline-block\"\r\n        >\r\n          ÔåÉ Back to Price Lists\r\n        </Link>\r\n        <div className=\"flex items-center justify-between mt-4\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-slate-900\">{list.name}</h1>\r\n            <div className=\"flex items-center gap-3 mt-2\">\r\n              <span\r\n                className={`inline-block px-2 py-1 text-xs font-medium rounded ${\r\n                  list.type === \"TRADE\"\r\n                    ? \"bg-blue-100 text-blue-700\"\r\n                    : \"bg-green-100 text-green-700\"\r\n                }`}\r\n              >\r\n                {list.type}\r\n              </span>\r\n              {list.description && (\r\n                <p className=\"text-sm text-slate-600\">{list.description}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <button\r\n              onClick={() => {\r\n                resetForm();\r\n                setShowImportModal(true);\r\n              }}\r\n              className=\"px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors\"\r\n            >\r\n              Import CSV\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                resetForm();\r\n                setShowAddModal(true);\r\n              }}\r\n              className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors\"\r\n            >\r\n              Add Item\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Messages */}\r\n      {error && (\r\n        <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\r\n          {error}\r\n        </div>\r\n      )}\r\n      {success && (\r\n        <div className=\"mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700\">\r\n          {success}\r\n        </div>\r\n      )}\r\n\r\n      {/* Items Table */}\r\n      {list.items.length === 0 ? (\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-12 text-center\">\r\n          <p className=\"text-slate-500 mb-4\">No items in this list yet.</p>\r\n          <div className=\"flex gap-2 justify-center\">\r\n            <button\r\n              onClick={() => {\r\n                resetForm();\r\n                setShowAddModal(true);\r\n              }}\r\n              className=\"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors\"\r\n            >\r\n              Add Item\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                resetForm();\r\n                setShowImportModal(true);\r\n              }}\r\n              className=\"px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors\"\r\n            >\r\n              Import CSV\r\n            </button>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"bg-white rounded-xl border border-slate-200 overflow-hidden\">\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead className=\"bg-slate-50 border-b border-slate-200\">\r\n                <tr>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase\">\r\n                    Name\r\n                  </th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase\">\r\n                    SKU\r\n                  </th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase\">\r\n                    Unit\r\n                  </th>\r\n                  {list.type === \"TRADE\" && (\r\n                    <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-700 uppercase\">\r\n                      Trade Price\r\n                    </th>\r\n                  )}\r\n                  {list.type === \"SHELF\" && (\r\n                    <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-700 uppercase\">\r\n                      Shelf Price\r\n                    </th>\r\n                  )}\r\n                  <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-700 uppercase\">\r\n                    Cost\r\n                  </th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-700 uppercase\">\r\n                    Notes\r\n                  </th>\r\n                  <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-700 uppercase\">\r\n                    Actions\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"divide-y divide-slate-200\">\r\n                {list.items.map((item) => (\r\n                  <tr key={item.id} className=\"hover:bg-slate-50\">\r\n                    <td className=\"px-4 py-3 text-sm font-medium text-slate-900\">{item.name}</td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-600\">{item.sku || \"-\"}</td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-600\">{item.unit || \"-\"}</td>\r\n                    {list.type === \"TRADE\" && (\r\n                      <td className=\"px-4 py-3 text-sm text-slate-900 text-right\">\r\n                        {item.tradePrice !== undefined ? `$${item.tradePrice.toFixed(2)}` : \"-\"}\r\n                      </td>\r\n                    )}\r\n                    {list.type === \"SHELF\" && (\r\n                      <td className=\"px-4 py-3 text-sm text-slate-900 text-right\">\r\n                        {item.shelfPrice !== undefined ? `$${item.shelfPrice.toFixed(2)}` : \"-\"}\r\n                      </td>\r\n                    )}\r\n                    <td className=\"px-4 py-3 text-sm text-slate-900 text-right\">\r\n                      {item.cost !== undefined ? `$${item.cost.toFixed(2)}` : \"-\"}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-sm text-slate-600 max-w-xs truncate\">\r\n                      {item.notes || \"-\"}\r\n                    </td>\r\n                    <td className=\"px-4 py-3 text-right\">\r\n                      <div className=\"flex gap-2 justify-end\">\r\n                        <button\r\n                          onClick={() => openEditModal(item)}\r\n                          className=\"text-purple-600 hover:text-purple-700 text-sm font-medium\"\r\n                        >\r\n                          Edit\r\n                        </button>\r\n                        <button\r\n                          onClick={() => handleDeleteItem(item.id!, item.name)}\r\n                          disabled={isPending}\r\n                          className=\"text-red-600 hover:text-red-700 text-sm font-medium disabled:opacity-50\"\r\n                        >\r\n                          Delete\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Add/Edit Item Modal */}\r\n      {showAddModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n          <div className=\"bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto\">\r\n            <h2 className=\"text-xl font-bold text-slate-900 mb-4\">\r\n              {editingItem ? \"Edit Item\" : \"Add Item\"}\r\n            </h2>\r\n\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Name *</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={itemForm.name}\r\n                  onChange={(e) => setItemForm({ ...itemForm, name: e.target.value })}\r\n                  className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                  placeholder=\"Item name\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">SKU</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={itemForm.sku}\r\n                    onChange={(e) => setItemForm({ ...itemForm, sku: e.target.value })}\r\n                    className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                    placeholder=\"Product code\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">Unit</label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={itemForm.unit}\r\n                    onChange={(e) => setItemForm({ ...itemForm, unit: e.target.value })}\r\n                    className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                    placeholder=\"e.g., Each, Litre, Box\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                {list.type === \"TRADE\" && (\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                      Trade Price\r\n                    </label>\r\n                    <input\r\n                      type=\"number\"\r\n                      step=\"0.01\"\r\n                      value={itemForm.tradePrice ?? \"\"}\r\n                      onChange={(e) =>\r\n                        setItemForm({\r\n                          ...itemForm,\r\n                          tradePrice: e.target.value ? parseFloat(e.target.value) : undefined,\r\n                        })\r\n                      }\r\n                      className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                      placeholder=\"0.00\"\r\n                    />\r\n                  </div>\r\n                )}\r\n\r\n                {list.type === \"SHELF\" && (\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                      Shelf Price\r\n                    </label>\r\n                    <input\r\n                      type=\"number\"\r\n                      step=\"0.01\"\r\n                      value={itemForm.shelfPrice ?? \"\"}\r\n                      onChange={(e) =>\r\n                        setItemForm({\r\n                          ...itemForm,\r\n                          shelfPrice: e.target.value ? parseFloat(e.target.value) : undefined,\r\n                        })\r\n                      }\r\n                      className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                      placeholder=\"0.00\"\r\n                    />\r\n                  </div>\r\n                )}\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">Cost</label>\r\n                  <input\r\n                    type=\"number\"\r\n                    step=\"0.01\"\r\n                    value={itemForm.cost ?? \"\"}\r\n                    onChange={(e) =>\r\n                      setItemForm({\r\n                        ...itemForm,\r\n                        cost: e.target.value ? parseFloat(e.target.value) : undefined,\r\n                      })\r\n                    }\r\n                    className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                    placeholder=\"0.00\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Notes</label>\r\n                <textarea\r\n                  value={itemForm.notes}\r\n                  onChange={(e) => setItemForm({ ...itemForm, notes: e.target.value })}\r\n                  className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500\"\r\n                  rows={3}\r\n                  placeholder=\"Optional notes...\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex gap-3 mt-6\">\r\n              <button\r\n                onClick={editingItem ? handleUpdateItem : handleAddItem}\r\n                disabled={isPending || !itemForm.name.trim()}\r\n                className=\"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50\"\r\n              >\r\n                {isPending ? (editingItem ? \"Updating...\" : \"Adding...\") : editingItem ? \"Update\" : \"Add\"}\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setShowAddModal(false);\r\n                  resetForm();\r\n                }}\r\n                disabled={isPending}\r\n                className=\"px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-sm font-medium rounded-lg transition-colors\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Import CSV Modal */}\r\n      {showImportModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n          <div className=\"bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto\">\r\n            <h2 className=\"text-xl font-bold text-slate-900 mb-4\">Import Items from CSV</h2>\r\n\r\n            <div className=\"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg\">\r\n              <p className=\"text-sm text-blue-800 font-medium mb-2\">CSV Format:</p>\r\n              <p className=\"text-xs text-blue-700 font-mono mb-2\">\r\n                name,sku,unit,trade price,shelf price,cost,notes\r\n              </p>\r\n              <p className=\"text-xs text-blue-700\">\r\n                Required: name. Optional: sku, unit, trade price, shelf price, cost, notes\r\n              </p>\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">CSV Content</label>\r\n              <textarea\r\n                value={csvContent}\r\n                onChange={(e) => setCsvContent(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm\"\r\n                rows={10}\r\n                placeholder=\"name,sku,unit,trade price,shelf price,cost,notes&#10;Paint White,PAINT-001,Litre,25.50,35.00,20.00,Interior paint&#10;Brush 2inch,BRUSH-002,Each,12.00,18.00,8.00,Quality brush\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex gap-3 mt-6\">\r\n              <button\r\n                onClick={handleImportCSV}\r\n                disabled={isPending || !csvContent.trim()}\r\n                className=\"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50\"\r\n              >\r\n                {isPending ? \"Importing...\" : \"Import\"}\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setShowImportModal(false);\r\n                  setCsvContent(\"\");\r\n                  setError(\"\");\r\n                }}\r\n                disabled={isPending}\r\n                className=\"px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-sm font-medium rounded-lg transition-colors\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\pricing\\[listId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\pricing\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[975,978],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[975,978],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1178,1181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1178,1181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1455,1458],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1455,1458],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2277,2280],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2277,2280],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2771,2774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2771,2774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":135,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4004,4007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4004,4007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":167,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4824,4827],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4824,4827],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":191,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5512,5515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5512,5515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":216,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":216,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6241,6244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6241,6244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":248,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":248,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7241,7244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7241,7244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":257,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":257,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7468,7471],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7468,7471],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":282,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":282,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8304,8307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8304,8307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":291,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8531,8534],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8531,8534],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'skuIndex' is assigned a value but never used.","line":320,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":320,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":360,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":360,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11288,11291],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11288,11291],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nfunction toCents(value: number | string | undefined | null) {\r\n  const n = Number(value);\r\n  if (!Number.isFinite(n)) return 0;\r\n  return Math.round(n * 100);\r\n}\r\n\r\nexport type PriceListType = \"TRADE\" | \"SHELF\";\r\n\r\nexport interface PriceListItem {\r\n  id?: string;\r\n  name: string;\r\n  sku?: string;\r\n  unit?: string;\r\n  tradePrice?: number;\r\n  shelfPrice?: number;\r\n  cost?: number;\r\n  notes?: string;\r\n}\r\n\r\nexport interface PriceList {\r\n  id: string;\r\n  name: string;\r\n  type: PriceListType; // Maps to pricingType in Prisma\r\n  description?: string; // Maps to locationLabel or supplier in Prisma (for display purposes)\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  items: PriceListItem[];\r\n}\r\n\r\n/**\r\n * Get all price lists\r\n */\r\nexport async function getPriceLists(): Promise<PriceList[]> {\r\n  try {\r\n    const prisma = getPrisma();\r\n    const lists = await (prisma as any).priceList.findMany({\r\n      orderBy: { createdAt: \"desc\" },\r\n      include: {\r\n        items: {\r\n          orderBy: { skuName: \"asc\" },\r\n        },\r\n      },\r\n    });\r\n\r\n    return lists.map((list: any) => ({\r\n      id: list.id,\r\n      name: list.name,\r\n      type: list.pricingType as PriceListType,\r\n      description: list.locationLabel || list.supplier || undefined,\r\n      createdAt: list.createdAt,\r\n      updatedAt: list.updatedAt,\r\n      items: list.items.map((item: any) => ({\r\n        id: item.id,\r\n        name: item.skuName,\r\n        sku: item.brand || undefined,\r\n        unit: item.unit || undefined,\r\n        tradePrice: list.pricingType === \"TRADE\" ? Number(item.priceExGstCents) / 100 : undefined,\r\n        shelfPrice: list.pricingType === \"SHELF\" ? Number(item.priceExGstCents) / 100 : undefined,\r\n        cost: undefined, // Not stored separately in schema\r\n        notes: item.notes || undefined,\r\n      })),\r\n    }));\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error fetching price lists:\", error);\r\n    throw new Error(\"Failed to fetch price lists\");\r\n  }\r\n}\r\n\r\n/**\r\n * Get a single price list by ID\r\n */\r\nexport async function getPriceListById(listId: string): Promise<PriceList | null> {\r\n  try {\r\n    const prisma = getPrisma();\r\n    const list = await (prisma as any).priceList.findUnique({\r\n      where: { id: listId },\r\n      include: {\r\n        items: {\r\n          orderBy: { skuName: \"asc\" },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!list) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      id: list.id,\r\n      name: list.name,\r\n      type: list.pricingType as PriceListType,\r\n      description: list.locationLabel || list.supplier || undefined,\r\n      createdAt: list.createdAt,\r\n      updatedAt: list.updatedAt,\r\n      items: list.items.map((item: any) => ({\r\n        id: item.id,\r\n        name: item.skuName,\r\n        sku: item.brand || undefined,\r\n        unit: item.unit || undefined,\r\n        tradePrice: list.pricingType === \"TRADE\" ? Number(item.priceExGstCents) / 100 : undefined,\r\n        shelfPrice: list.pricingType === \"SHELF\" ? Number(item.priceExGstCents) / 100 : undefined,\r\n        cost: undefined, // Not stored separately in schema\r\n        notes: item.notes || undefined,\r\n      })),\r\n    };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error fetching price list:\", error);\r\n    throw new Error(\"Failed to fetch price list\");\r\n  }\r\n}\r\n\r\n/**\r\n * Create a new price list\r\n */\r\nexport async function createPriceList(\r\n  name: string,\r\n  type: PriceListType,\r\n  description?: string\r\n): Promise<{ success: boolean; id?: string; error?: string }> {\r\n  try {\r\n    if (!name || name.trim() === \"\") {\r\n      return { success: false, error: \"Name is required\" };\r\n    }\r\n\r\n    // For admin/demo purposes, use a placeholder orgId\r\n    // In production, this should come from the authenticated user's organization\r\n    const orgId = process.env.NODE_ENV === \"development\" ? \"admin-demo\" : \"admin\";\r\n\r\n    const prisma = getPrisma();\r\n    const list = await (prisma as any).priceList.create({\r\n      data: {\r\n        orgId,\r\n        name: name.trim(),\r\n        pricingType: type,\r\n        locationLabel: description?.trim() || null,\r\n      },\r\n    });\r\n\r\n    revalidatePath(\"/admin/pricing\");\r\n    return { success: true, id: list.id };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error creating price list:\", error);\r\n    return { success: false, error: \"Failed to create price list\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Update a price list\r\n */\r\nexport async function updatePriceList(\r\n  listId: string,\r\n  name: string,\r\n  type: PriceListType,\r\n  description?: string\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    if (!name || name.trim() === \"\") {\r\n      return { success: false, error: \"Name is required\" };\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    await (prisma as any).priceList.update({\r\n      where: { id: listId },\r\n      data: {\r\n        name: name.trim(),\r\n        pricingType: type,\r\n        locationLabel: description?.trim() || null,\r\n      },\r\n    });\r\n\r\n    revalidatePath(\"/admin/pricing\");\r\n    revalidatePath(`/admin/pricing/${listId}`);\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error updating price list:\", error);\r\n    return { success: false, error: \"Failed to update price list\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a price list\r\n */\r\nexport async function deletePriceList(listId: string): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const prisma = getPrisma();\r\n    await (prisma as any).priceList.delete({\r\n      where: { id: listId },\r\n    });\r\n\r\n    revalidatePath(\"/admin/pricing\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error deleting price list:\", error);\r\n    return { success: false, error: \"Failed to delete price list\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Add an item to a price list (manual entry)\r\n */\r\nexport async function addPriceListItem(\r\n  listId: string,\r\n  item: Omit<PriceListItem, \"id\">\r\n): Promise<{ success: boolean; id?: string; error?: string }> {\r\n  try {\r\n    if (!item.name || item.name.trim() === \"\") {\r\n      return { success: false, error: \"Item name is required\" };\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const createdItem = await (prisma as any).priceListItem.create({\r\n      data: {\r\n        priceListId: listId,\r\n        skuName: item.name.trim(),\r\n        unit: item.unit?.trim() || null,\r\n        priceExGstCents: toCents(item.tradePrice ?? item.shelfPrice ?? item.cost),\r\n        notes: item.notes?.trim() || null,\r\n      },\r\n    });\r\n\r\n    revalidatePath(`/admin/pricing/${listId}`);\r\n    revalidatePath(\"/admin/pricing\");\r\n    return { success: true, id: createdItem.id };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error adding price list item:\", error);\r\n    return { success: false, error: \"Failed to add item\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Update a price list item\r\n */\r\nexport async function updatePriceListItem(\r\n  itemId: string,\r\n  item: Omit<PriceListItem, \"id\">\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    if (!item.name || item.name.trim() === \"\") {\r\n      return { success: false, error: \"Item name is required\" };\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const existingItem = await (prisma as any).priceListItem.findUnique({\r\n      where: { id: itemId },\r\n      select: { priceListId: true },\r\n    });\r\n\r\n    if (!existingItem) {\r\n      return { success: false, error: \"Item not found\" };\r\n    }\r\n\r\n    await (prisma as any).priceListItem.update({\r\n      where: { id: itemId },\r\n      data: {\r\n        skuName: item.name.trim(),\r\n        unit: item.unit?.trim() || null,\r\n        priceExGstCents: toCents(item.tradePrice ?? item.shelfPrice ?? item.cost),\r\n        notes: item.notes?.trim() || null,\r\n      },\r\n    });\r\n\r\n    revalidatePath(`/admin/pricing/${existingItem.priceListId}`);\r\n    revalidatePath(\"/admin/pricing\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error updating price list item:\", error);\r\n    return { success: false, error: \"Failed to update item\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a price list item\r\n */\r\nexport async function deletePriceListItem(itemId: string): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const prisma = getPrisma();\r\n    const existingItem = await (prisma as any).priceListItem.findUnique({\r\n      where: { id: itemId },\r\n      select: { priceListId: true },\r\n    });\r\n\r\n    if (!existingItem) {\r\n      return { success: false, error: \"Item not found\" };\r\n    }\r\n\r\n    await (prisma as any).priceListItem.delete({\r\n      where: { id: itemId },\r\n    });\r\n\r\n    revalidatePath(`/admin/pricing/${existingItem.priceListId}`);\r\n    revalidatePath(\"/admin/pricing\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error deleting price list item:\", error);\r\n    return { success: false, error: \"Failed to delete item\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Import items from CSV\r\n */\r\nexport async function importPriceListItemsFromCSV(\r\n  listId: string,\r\n  csvContent: string\r\n): Promise<{ success: boolean; imported: number; errors: string[] }> {\r\n  try {\r\n    const lines = csvContent.split(\"\\n\").filter((line) => line.trim() !== \"\");\r\n    if (lines.length === 0) {\r\n      return { success: false, imported: 0, errors: [\"CSV file is empty\"] };\r\n    }\r\n\r\n    // Parse header row\r\n    const header = lines[0].split(\",\").map((h) => h.trim().toLowerCase());\r\n    const nameIndex = header.findIndex((h) => h === \"name\" || h === \"product name\" || h === \"item name\");\r\n    const skuIndex = header.findIndex((h) => h === \"sku\" || h === \"product code\" || h === \"code\");\r\n    const unitIndex = header.findIndex((h) => h === \"unit\" || h === \"uom\" || h === \"unit of measure\");\r\n    const tradePriceIndex = header.findIndex(\r\n      (h) => h === \"trade price\" || h === \"trade\" || h === \"wholesale\" || h === \"wholesale price\"\r\n    );\r\n    const shelfPriceIndex = header.findIndex(\r\n      (h) => h === \"shelf price\" || h === \"retail\" || h === \"retail price\" || h === \"shelf\"\r\n    );\r\n    const costIndex = header.findIndex((h) => h === \"cost\" || h === \"cost price\");\r\n    const notesIndex = header.findIndex((h) => h === \"notes\" || h === \"description\" || h === \"note\");\r\n\r\n    if (nameIndex === -1) {\r\n      return { success: false, imported: 0, errors: [\"CSV must contain a 'name' column\"] };\r\n    }\r\n\r\n    const errors: string[] = [];\r\n    let imported = 0;\r\n\r\n    const prisma = getPrisma();\r\n    // Process data rows\r\n    for (let i = 1; i < lines.length; i++) {\r\n      const values = lines[i].split(\",\").map((v) => v.trim());\r\n      const name = values[nameIndex]?.trim();\r\n\r\n      if (!name || name === \"\") {\r\n        errors.push(`Row ${i + 1}: Missing name, skipped`);\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        const tradePrice = tradePriceIndex >= 0 && values[tradePriceIndex]\r\n          ? parseFloat(values[tradePriceIndex].replace(/[^0-9.-]/g, \"\"))\r\n          : undefined;\r\n        const shelfPrice = shelfPriceIndex >= 0 && values[shelfPriceIndex]\r\n          ? parseFloat(values[shelfPriceIndex].replace(/[^0-9.-]/g, \"\"))\r\n          : undefined;\r\n        const cost = costIndex >= 0 && values[costIndex]\r\n          ? parseFloat(values[costIndex].replace(/[^0-9.-]/g, \"\"))\r\n          : undefined;\r\n\r\n        await (prisma as any).priceListItem.create({\r\n          data: {\r\n            priceListId: listId,\r\n            skuName: name,\r\n            unit: unitIndex >= 0 && values[unitIndex] ? values[unitIndex] : null,\r\n            priceExGstCents: toCents(\r\n              tradePrice && !isNaN(tradePrice) ? tradePrice :\r\n              shelfPrice && !isNaN(shelfPrice) ? shelfPrice :\r\n              cost && !isNaN(cost) ? cost : undefined\r\n            ),\r\n            notes: notesIndex >= 0 && values[notesIndex] ? values[notesIndex] : null,\r\n          },\r\n        });\r\n\r\n        imported++;\r\n      } catch (error) {\r\n        errors.push(`Row ${i + 1}: ${error instanceof Error ? error.message : \"Failed to import\"}`);\r\n      }\r\n    }\r\n\r\n    revalidatePath(`/admin/pricing/${listId}`);\r\n    revalidatePath(\"/admin/pricing\");\r\n\r\n    return {\r\n      success: imported > 0,\r\n      imported,\r\n      errors,\r\n    };\r\n  } catch (error) {\r\n    console.error(\"[pricing] Error importing CSV:\", error);\r\n    return {\r\n      success: false,\r\n      imported: 0,\r\n      errors: [error instanceof Error ? error.message : \"Failed to import CSV\"],\r\n    };\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\pricing\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\users\\AdminUsersPageContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":117,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4122,4125],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4122,4125],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4964,4967],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4964,4967],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'accountStatusFilter', 'planStatusFilter', 'searchQuery', and 'verificationFilter'. Either include them or remove the dependency array.","line":248,"column":6,"nodeType":"ArrayExpression","endLine":248,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [accountStatusFilter, planStatusFilter, searchParams, searchQuery, verificationFilter]","fix":{"range":[8702,8716],"text":"[accountStatusFilter, planStatusFilter, searchParams, searchQuery, verificationFilter]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatLastLogin' is assigned a value but never used.","line":314,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":314,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport PaginationControls from \"@/app/components/PaginationControls\";\n\ninterface User {\n  id: string;\n  email: string;\n  name?: string;\n  createdAt: string;\n  role: string;\n  verificationStatus: string;\n  verifiedAt: string | null;\n  emailVerifiedAt: string | null; // Email verification status\n  isAdmin: boolean;\n  // Plan fields\n  planTier?: string;\n  planStatus?: string;\n  trialEndsAt?: string | null;\n  // Account status\n  accountStatus?: string;\n  isBanned?: boolean;\n  // Activity fields\n  lastLoginAt?: string | null;\n  lastActivityAt?: string | null;\n  totalJobs?: number;\n  totalJobPacks?: number;\n  businessDetails?: {\n    businessName?: string;\n    tradingName?: string;\n    abn?: string;\n    tradeTypes?: string[];\n    serviceArea?: string;\n    serviceAreaCity?: string;\n    serviceAreaRadiusKm?: number;\n  };\n  businessName?: string;\n  onboardingCompletedAt?: string | null;\n  onboardingDismissed?: boolean;\n  onboardingBusinessProfileDone?: boolean;\n  onboardingRatesDone?: boolean;\n  onboardingServiceAreaDone?: boolean;\n  onboardingVerificationDone?: boolean;\n  onboardingFirstJobDone?: boolean;\n}\n\nexport default function AdminUsersPageContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const [isAdmin, setIsAdmin] = useState(false);\n  const [currentUserId, setCurrentUserId] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [users, setUsers] = useState<User[]>([]);\n  const [pagination, setPagination] = useState({\n    page: 1,\n    pageSize: 20,\n    totalItems: 0,\n    totalPages: 0,\n  });\n  const [error, setError] = useState(\"\");\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  const [updateError, setUpdateError] = useState<string | null>(null);\n  const [updateSuccess, setUpdateSuccess] = useState<string | null>(null);\n  const [isUpdating, setIsUpdating] = useState(false);\n  // Search and filter state from URL\n  const [searchQuery, setSearchQuery] = useState(searchParams.get(\"search\") || \"\");\n  const [verificationFilter, setVerificationFilter] = useState<string>(\n    searchParams.get(\"verificationStatus\") || \"all\"\n  );\n  const [planStatusFilter, setPlanStatusFilter] = useState<string>(\n    searchParams.get(\"planStatus\") || \"all\"\n  );\n  const [accountStatusFilter, setAccountStatusFilter] = useState<string>(\n    searchParams.get(\"accountStatus\") || \"all\"\n  );\n\n  const fetchUsers = useCallback(async () => {\n    try {\n      setIsLoading(true);\n      setError(\"\");\n      // Build query params\n      const params = new URLSearchParams();\n      const currentPage = searchParams.get(\"page\") || \"1\";\n      params.set(\"page\", currentPage);\n      if (searchQuery) params.set(\"search\", searchQuery);\n      if (verificationFilter !== \"all\") params.set(\"verificationStatus\", verificationFilter);\n      if (planStatusFilter !== \"all\") params.set(\"planStatus\", planStatusFilter);\n      if (accountStatusFilter !== \"all\") params.set(\"accountStatus\", accountStatusFilter);\n\n      const response = await fetch(`/api/admin/users?${params.toString()}`);\n      if (response.ok) {\n        const data = await response.json();\n        setIsAdmin(true);\n        setUsers(Array.isArray(data.items) ? data.items : []);\n        setPagination({\n          page: data.page || 1,\n          pageSize: data.pageSize || 20,\n          totalItems: data.totalItems || 0,\n          totalPages: data.totalPages || 0,\n        });\n      } else if (response.status === 403) {\n        setIsAdmin(false);\n        setError(\"Access denied. Admin privileges required.\");\n      } else if (response.status === 401) {\n        router.push(\"/login\");\n      } else {\n        let errorData: { error?: string } = {};\n        try {\n          errorData = await response.json();\n        } catch {\n          // If JSON parsing fails, use default error message\n        }\n        setError(errorData?.error || \"Failed to load users. Please try again.\");\n      }\n    } catch (err: any) {\n      console.error(\"[admin-users] error fetching users:\", err);\n      const errorMessage = err?.message || \"Failed to load users. Please try again.\";\n      setError(errorMessage);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [router, searchParams, searchQuery, verificationFilter, planStatusFilter, accountStatusFilter]);\n\n  // Fetch current user ID on mount\n  useEffect(() => {\n    const fetchCurrentUser = async () => {\n      try {\n        const response = await fetch(\"/api/auth/me\");\n        if (response.ok) {\n          const data = await response.json();\n          if (data.user) {\n            setCurrentUserId(data.user.id);\n          }\n        }\n      } catch {\n        // Ignore errors\n      }\n    };\n    fetchCurrentUser();\n  }, []);\n\n  // Update user via API\n  const updateUserField = async (field: string, value: any) => {\n    if (!selectedUser) return;\n\n    setIsUpdating(true);\n    setUpdateError(null);\n    setUpdateSuccess(null);\n\n    try {\n      const response = await fetch(`/api/admin/users/${selectedUser.id}`, {\n        method: \"PATCH\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ [field]: value }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        const errorMessage = data.error || \"Could not update user. Please try again.\";\n        setUpdateError(errorMessage);\n        console.error(\"Update failed:\", errorMessage, data);\n        setIsUpdating(false);\n        return;\n      }\n\n      const data = await response.json();\n      const updatedUser = data.user;\n\n      // Update selectedUser state\n      setSelectedUser(updatedUser);\n\n      // Refresh users list to reflect changes\n      fetchUsers();\n\n      // Show success message\n      if (field === \"isAdmin\") {\n        setUpdateSuccess(value ? \"User is now an admin\" : \"Admin privileges removed\");\n      } else {\n        setUpdateSuccess(\"User updated successfully\");\n      }\n\n      // Clear success message after 3 seconds\n      setTimeout(() => {\n        setUpdateSuccess(null);\n      }, 3000);\n\n      setUpdateError(null);\n    } catch (err) {\n      console.error(\"Error updating user:\", err);\n      const errorMessage = err instanceof Error ? err.message : \"Could not update user. Please try again.\";\n      setUpdateError(errorMessage);\n    } finally {\n      setIsUpdating(false);\n    }\n  };\n\n  const handleToggleAdmin = () => {\n    if (!selectedUser) return;\n    updateUserField(\"isAdmin\", !selectedUser.isAdmin);\n  };\n\n  const handlePlanStatusChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n    updateUserField(\"planStatus\", e.target.value);\n  };\n\n  // Update URL when filters change and reset to page 1\n  const updateFilters = useCallback((updates: {\n    search?: string;\n    verificationStatus?: string;\n    planStatus?: string;\n    accountStatus?: string;\n  }) => {\n    const params = new URLSearchParams();\n    const newSearch = updates.search !== undefined ? updates.search : searchQuery;\n    const newVerification = updates.verificationStatus !== undefined ? updates.verificationStatus : verificationFilter;\n    const newPlanStatus = updates.planStatus !== undefined ? updates.planStatus : planStatusFilter;\n    const newAccountStatus = updates.accountStatus !== undefined ? updates.accountStatus : accountStatusFilter;\n\n    if (newSearch) params.set(\"search\", newSearch);\n    if (newVerification !== \"all\") params.set(\"verificationStatus\", newVerification);\n    if (newPlanStatus !== \"all\") params.set(\"planStatus\", newPlanStatus);\n    if (newAccountStatus !== \"all\") params.set(\"accountStatus\", newAccountStatus);\n    // Reset to page 1 when filters change\n    // params.delete(\"page\"); // page 1 is default\n\n    router.push(`/admin/users?${params.toString()}`);\n  }, [router, searchQuery, verificationFilter, planStatusFilter, accountStatusFilter]);\n\n  useEffect(() => {\n    fetchUsers();\n  }, [fetchUsers]);\n\n  // Sync URL params with state\n  useEffect(() => {\n    const urlSearch = searchParams.get(\"search\") || \"\";\n    const urlVerification = searchParams.get(\"verificationStatus\") || \"all\";\n    const urlPlanStatus = searchParams.get(\"planStatus\") || \"all\";\n    const urlAccountStatus = searchParams.get(\"accountStatus\") || \"all\";\n\n    if (urlSearch !== searchQuery) setSearchQuery(urlSearch);\n    if (urlVerification !== verificationFilter) setVerificationFilter(urlVerification);\n    if (urlPlanStatus !== planStatusFilter) setPlanStatusFilter(urlPlanStatus);\n    if (urlAccountStatus !== accountStatusFilter) setAccountStatusFilter(urlAccountStatus);\n  }, [searchParams]);\n\n  const getRoleBadgeColor = (role: string) => {\n    switch (role) {\n      case \"admin\":\n        return \"bg-purple-100 text-purple-700 border-purple-300\";\n      case \"builder\":\n        return \"bg-blue-100 text-blue-700 border-blue-300\";\n      case \"tradie\":\n        return \"bg-green-100 text-green-700 border-green-300\";\n      case \"client\":\n        return \"bg-amber-100 text-amber-700 border-amber-300\";\n      case \"supplier\":\n        return \"bg-slate-100 text-slate-700 border-slate-300\";\n      default:\n        return \"bg-slate-100 text-slate-700 border-slate-300\";\n    }\n  };\n\n  const getStatusBadgeColor = (status: string) => {\n    switch (status) {\n      case \"verified\":\n        return \"bg-green-100 text-green-700 border-green-300\";\n      case \"pending\":\n        return \"bg-amber-100 text-amber-700 border-amber-300\";\n      case \"unverified\":\n        return \"bg-slate-100 text-slate-500 border-slate-300\";\n      default:\n        return \"bg-slate-100 text-slate-500 border-slate-300\";\n    }\n  };\n\n  const getPlanTierBadgeColor = (tier?: string) => {\n    switch (tier) {\n      case \"FOUNDER\":\n        return \"bg-purple-100 text-purple-700 border-purple-300\";\n      case \"PRO\":\n        return \"bg-blue-100 text-blue-700 border-blue-300\";\n      case \"BUSINESS\":\n        return \"bg-indigo-100 text-indigo-700 border-indigo-300\";\n      case \"TRIAL\":\n        return \"bg-amber-100 text-amber-700 border-amber-300\";\n      case \"FREE\":\n        return \"bg-slate-100 text-slate-500 border-slate-300\";\n      default:\n        return \"bg-slate-100 text-slate-500 border-slate-300\";\n    }\n  };\n\n  const getPlanStatusBadgeColor = (status?: string) => {\n    switch (status) {\n      case \"ACTIVE\":\n        return \"bg-green-100 text-green-700 border-green-300\";\n      case \"TRIAL\":\n        return \"bg-amber-100 text-amber-700 border-amber-300\";\n      case \"PAST_DUE\":\n        return \"bg-red-100 text-red-700 border-red-300\";\n      case \"CANCELLED\":\n        return \"bg-slate-100 text-slate-500 border-slate-300\";\n      case \"SUSPENDED\":\n        return \"bg-amber-100 text-amber-700 border-amber-300\";\n      default:\n        return \"bg-slate-100 text-slate-500 border-slate-300\";\n    }\n  };\n\n  const formatLastLogin = (dateString: string | null | undefined) => {\n    if (!dateString) return \"Never logged in\";\n    const date = new Date(dateString);\n    const now = new Date();\n    const diffMs = now.getTime() - date.getTime();\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n    \n    if (diffDays === 0) return \"Today\";\n    if (diffDays === 1) return \"Yesterday\";\n    if (diffDays < 7) return `${diffDays} days ago`;\n    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;\n    return date.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\", year: \"numeric\" });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[calc(100vh-4rem)]\">\n        <div className=\"text-slate-500\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!isAdmin) {\n    return (\n      <div className=\"max-w-2xl mx-auto px-4 py-12\">\n        <div className=\"bg-white rounded-xl border border-slate-200 p-8 text-center\">\n          <h1 className=\"text-xl font-semibold text-slate-900 mb-2\">Access Denied</h1>\n          <p className=\"text-slate-600 mb-6\">\n            You don&apos;t have permission to access this page.\n          </p>\n          <Link\n            href=\"/dashboard\"\n            className=\"inline-flex items-center px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors\"\n          >\n            Back to Dashboard\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"max-w-6xl mx-auto px-4 py-8\">\n      {/* Admin Navigation */}\n      <div className=\"mb-6 flex gap-3\">\n        <Link\n          href=\"/admin/dashboard\"\n          className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors cursor-pointer\"\n        >\n          Dashboard\n        </Link>\n        <span className=\"px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg\">\n          Users\n        </span>\n        <Link\n          href=\"/admin/verification\"\n          className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors cursor-pointer\"\n        >\n          Verifications\n        </Link>\n        <Link\n          href=\"/admin/feedback\"\n          className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors cursor-pointer\"\n        >\n          Feedback Log\n        </Link>\n      </div>\n\n      <div className=\"mb-8\">\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">All Users</h1>\n        <p className=\"text-slate-600\">\n          Manage all registered users in the system. {pagination.totalItems} total user{pagination.totalItems !== 1 ? \"s\" : \"\"}.\n        </p>\n      </div>\n\n      {/* Search and Filters */}\n      <div className=\"mb-6 space-y-4\">\n        <div className=\"flex gap-4 flex-wrap\">\n          {/* Search */}\n          <div className=\"flex-1 min-w-[200px]\">\n            <input\n              type=\"text\"\n              placeholder=\"Search usersÔÇª\"\n              value={searchQuery}\n              onChange={(e) => {\n                setSearchQuery(e.target.value);\n                updateFilters({ search: e.target.value });\n              }}\n              onKeyDown={(e) => {\n                if (e.key === \"Enter\") {\n                  updateFilters({ search: searchQuery });\n                }\n              }}\n              className=\"w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n            />\n          </div>\n\n          {/* Verification Status Filter */}\n          <select\n            value={verificationFilter}\n            onChange={(e) => {\n              setVerificationFilter(e.target.value);\n              updateFilters({ verificationStatus: e.target.value });\n            }}\n            className=\"px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n          >\n            <option value=\"all\">All Verification Status</option>\n            <option value=\"verified\">Verified</option>\n            <option value=\"pending\">Pending</option>\n            <option value=\"unverified\">Unverified</option>\n          </select>\n\n          {/* Plan Status Filter */}\n          <select\n            value={planStatusFilter}\n            onChange={(e) => {\n              setPlanStatusFilter(e.target.value);\n              updateFilters({ planStatus: e.target.value });\n            }}\n            className=\"px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n          >\n            <option value=\"all\">All Plan Status</option>\n            <option value=\"ACTIVE\">Active</option>\n            <option value=\"TRIAL\">Trial</option>\n            <option value=\"PAST_DUE\">Past Due</option>\n            <option value=\"CANCELLED\">Cancelled</option>\n            <option value=\"SUSPENDED\">Suspended</option>\n          </select>\n\n          {/* Account Status Filter */}\n          <select\n            value={accountStatusFilter}\n            onChange={(e) => {\n              setAccountStatusFilter(e.target.value);\n              updateFilters({ accountStatus: e.target.value });\n            }}\n            className=\"px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n          >\n            <option value=\"all\">All Account Status</option>\n            <option value=\"ACTIVE\">Active</option>\n            <option value=\"SUSPENDED\">Suspended</option>\n            <option value=\"BANNED\">Banned</option>\n          </select>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\n          {error}\n          <button\n            onClick={() => setError(\"\")}\n            className=\"ml-2 text-red-500 hover:text-red-700\"\n          >\n            Ô£ò\n          </button>\n        </div>\n      )}\n\n      {users.length === 0 && !isLoading ? (\n        <div className=\"bg-white rounded-xl border border-slate-200 p-8 text-center\">\n          <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n            <svg className=\"w-8 h-8 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n            </svg>\n          </div>\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-2\">\n            {pagination.totalItems === 0 ? \"No Users Yet\" : \"No Users Match Filters\"}\n          </h2>\n          <p className=\"text-slate-600\">\n            {pagination.totalItems === 0\n              ? \"No users have registered yet.\"\n              : \"Try adjusting your search or filter criteria.\"}\n          </p>\n        </div>\n      ) : (\n        <div className=\"bg-white rounded-xl border border-slate-200 overflow-hidden\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"bg-slate-50 border-b border-slate-200\">\n                <tr>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Name\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Email\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Role\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Plan\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Status\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Verification\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Actions\n                  </th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-200\">\n                {users.map((user) => {\n                  const accountStatus = user.accountStatus || (user.isBanned ? \"BANNED\" : \"ACTIVE\");\n\n                  return (\n                    <tr\n                      key={user.id}\n                      className=\"hover:bg-slate-50 cursor-pointer\"\n                      onClick={() => setSelectedUser(user)}\n                    >\n                      <td className=\"px-4 py-4\">\n                        <div className=\"text-sm font-medium text-slate-900\">{user.businessName || user.name || user.email.split(\"@\")[0]}</div>\n                        {user.businessName && user.email && (\n                          <div className=\"text-xs text-slate-500 mt-0.5\">{user.email}</div>\n                        )}\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <div className=\"text-sm text-slate-900\">{user.email}</div>\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${\n                          user.isAdmin || user.role === \"admin\"\n                            ? \"bg-purple-100 text-purple-700 border-purple-300\"\n                            : \"bg-slate-100 text-slate-700 border-slate-300\"\n                        }`}>\n                          {user.isAdmin || user.role === \"admin\" ? \"Admin\" : user.role || \"User\"}\n                        </span>\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <div className=\"flex flex-col gap-1\">\n                          <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${getPlanTierBadgeColor(user.planTier)}`}>\n                            {user.planTier || \"FREE\"}\n                          </span>\n                          <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${getPlanStatusBadgeColor(user.planStatus)}`}>\n                            {user.planStatus || \"TRIAL\"}\n                          </span>\n                        </div>\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${\n                          accountStatus === \"BANNED\" || user.isBanned\n                            ? \"bg-red-100 text-red-700 border-red-300\"\n                            : accountStatus === \"SUSPENDED\"\n                            ? \"bg-amber-100 text-amber-700 border-amber-300\"\n                            : \"bg-green-100 text-green-700 border-green-300\"\n                        }`}>\n                          {accountStatus === \"BANNED\" ? \"Banned\" : accountStatus === \"SUSPENDED\" ? \"Suspended\" : \"Active\"}\n                        </span>\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${getStatusBadgeColor(user.verificationStatus)}`}>\n                          {user.verificationStatus === \"pending\" ? \"Pending review\" : user.verificationStatus === \"verified\" ? \"Verified\" : \"Not submitted\"}\n                        </span>\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <button\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            setSelectedUser(user);\n                          }}\n                          className=\"text-sm text-purple-600 hover:text-purple-700 font-medium\"\n                        >\n                          View Details\n                        </button>\n                      </td>\n                    </tr>\n                  );\n                })}\n              </tbody>\n            </table>\n          </div>\n          {/* Pagination Controls */}\n          {pagination.totalPages > 1 && (\n            <div className=\"px-6 py-4 border-t border-slate-200\">\n              <PaginationControls\n                page={pagination.page}\n                totalPages={pagination.totalPages}\n                totalItems={pagination.totalItems}\n                pageSize={pagination.pageSize}\n              />\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* User Detail Modal */}\n      {selectedUser && (\n        <div\n          className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\"\n          onClick={() => setSelectedUser(null)}\n        >\n          <div\n            className=\"bg-white rounded-xl border border-slate-200 max-w-2xl w-full max-h-[90vh] overflow-y-auto\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"p-6 border-b border-slate-200 flex items-center justify-between\">\n              <h2 className=\"text-xl font-bold text-slate-900\">User Details</h2>\n              <button\n                onClick={() => setSelectedUser(null)}\n                className=\"text-slate-400 hover:text-slate-600\"\n              >\n                <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                </svg>\n              </button>\n            </div>\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Email</label>\n                <p className=\"mt-1 text-sm text-slate-900\">{selectedUser.email}</p>\n              </div>\n              <div>\n                <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">User ID</label>\n                <p className=\"mt-1 text-sm font-mono text-slate-600\">{selectedUser.id}</p>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Role</label>\n                  <p className=\"mt-1\">\n                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getRoleBadgeColor(selectedUser.role)}`}>\n                      {selectedUser.role}\n                    </span>\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Verification Status</label>\n                  <p className=\"mt-1\">\n                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getStatusBadgeColor(selectedUser.verificationStatus)}`}>\n                      {selectedUser.verificationStatus === \"pending\" ? \"Pending\" : selectedUser.verificationStatus === \"verified\" ? \"Verified\" : \"Unverified\"}\n                    </span>\n                  </p>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Plan Tier</label>\n                  <p className=\"mt-1\">\n                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getPlanTierBadgeColor(selectedUser.planTier)}`}>\n                      {selectedUser.planTier || \"FREE\"}\n                    </span>\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Plan Status</label>\n                  <p className=\"mt-1\">\n                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getPlanStatusBadgeColor(selectedUser.planStatus)}`}>\n                      {selectedUser.planStatus || \"TRIAL\"}\n                    </span>\n                  </p>\n                </div>\n              </div>\n              {selectedUser.trialEndsAt && (\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Trial Ends At</label>\n                  <p className=\"mt-1 text-sm text-slate-900\">\n                    {new Date(selectedUser.trialEndsAt).toLocaleString()}\n                  </p>\n                </div>\n              )}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Created At</label>\n                  <p className=\"mt-1 text-sm text-slate-900\">\n                    {new Date(selectedUser.createdAt).toLocaleString()}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Business Verified At</label>\n                  <p className=\"mt-1 text-sm text-slate-900\">\n                    {selectedUser.verifiedAt ? new Date(selectedUser.verifiedAt).toLocaleString() : \"Not verified\"}\n                  </p>\n                </div>\n              </div>\n              <div>\n                <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Email Verified</label>\n                <p className=\"mt-1\">\n                  {selectedUser.emailVerifiedAt ? (\n                    <div className=\"flex flex-col gap-1\">\n                      <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-300\">\n                        Ô£ô Verified\n                      </span>\n                      <span className=\"text-sm text-slate-600\">\n                        {new Date(selectedUser.emailVerifiedAt).toLocaleString()}\n                      </span>\n                    </div>\n                  ) : (\n                    <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700 border border-amber-300\">\n                      Not structured\n                    </span>\n                  )}\n                </p>\n              </div>\n              {/* Onboarding Status */}\n              {selectedUser.role !== \"client\" && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-3\">\n                    Onboarding\n                  </label>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-slate-600\">Onboarding completed:</span>\n                      <span className=\"text-sm text-slate-900\">\n                        {selectedUser.onboardingCompletedAt\n                          ? new Date(selectedUser.onboardingCompletedAt).toLocaleString()\n                          : \"Not yet\"}\n                      </span>\n                    </div>\n                    {selectedUser.onboardingBusinessProfileDone !== undefined && (\n                      <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                        <div className=\"flex items-center gap-2\">\n                          {selectedUser.onboardingBusinessProfileDone ? (\n                            <span className=\"text-green-600\">Ô£ô</span>\n                          ) : (\n                            <span className=\"text-slate-300\">Ôùï</span>\n                          )}\n                          <span className=\"text-slate-600\">Business profile</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {selectedUser.onboardingRatesDone ? (\n                            <span className=\"text-green-600\">Ô£ô</span>\n                          ) : (\n                            <span className=\"text-slate-300\">Ôùï</span>\n                          )}\n                          <span className=\"text-slate-600\">Rates</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {selectedUser.onboardingServiceAreaDone ? (\n                            <span className=\"text-green-600\">Ô£ô</span>\n                          ) : (\n                            <span className=\"text-slate-300\">Ôùï</span>\n                          )}\n                          <span className=\"text-slate-600\">Service area</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {selectedUser.onboardingVerificationDone ? (\n                            <span className=\"text-green-600\">Ô£ô</span>\n                          ) : (\n                            <span className=\"text-slate-300\">Ôùï</span>\n                          )}\n                          <span className=\"text-slate-600\">Verification</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {selectedUser.onboardingFirstJobDone ? (\n                            <span className=\"text-green-600\">Ô£ô</span>\n                          ) : (\n                            <span className=\"text-slate-300\">Ôùï</span>\n                          )}\n                          <span className=\"text-slate-600\">First job</span>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Last Login</label>\n                  <p className=\"mt-1 text-sm text-slate-900\">\n                    {selectedUser.lastLoginAt ? new Date(selectedUser.lastLoginAt).toLocaleString() : \"Never\"}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Last Activity</label>\n                  <p className=\"mt-1 text-sm text-slate-900\">\n                    {selectedUser.lastActivityAt ? new Date(selectedUser.lastActivityAt).toLocaleString() : \"Never\"}\n                  </p>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Total Jobs</label>\n                  <p className=\"mt-1 text-sm text-slate-900\">\n                    {selectedUser.totalJobs ?? 0}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Admin</label>\n                  <p className=\"mt-1\">\n                    {selectedUser.isAdmin ? (\n                      <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700 border border-purple-300\">\n                        Yes\n                      </span>\n                    ) : (\n                      <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-500 border border-slate-300\">\n                        No\n                      </span>\n                    )}\n                  </p>\n                </div>\n              </div>\n              {selectedUser.businessDetails && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Business Details</label>\n                  <div className=\"mt-2 space-y-2\">\n                    {selectedUser.businessDetails.businessName && (\n                      <div>\n                        <span className=\"text-xs text-slate-500\">Business Name: </span>\n                        <span className=\"text-sm text-slate-900\">{selectedUser.businessDetails.businessName}</span>\n                      </div>\n                    )}\n                    {selectedUser.businessDetails.tradingName && (\n                      <div>\n                        <span className=\"text-xs text-slate-500\">Trading Name: </span>\n                        <span className=\"text-sm text-slate-900\">{selectedUser.businessDetails.tradingName}</span>\n                      </div>\n                    )}\n                    {selectedUser.businessDetails.abn && (\n                      <div>\n                        <span className=\"text-xs text-slate-500\">ABN: </span>\n                        <span className=\"text-sm font-mono text-slate-900\">{selectedUser.businessDetails.abn}</span>\n                      </div>\n                    )}\n                    {selectedUser.businessDetails.tradeTypes && selectedUser.businessDetails.tradeTypes.length > 0 && (\n                      <div>\n                        <span className=\"text-xs text-slate-500\">Trade Types: </span>\n                        <span className=\"text-sm text-slate-900\">{selectedUser.businessDetails.tradeTypes.join(\", \")}</span>\n                      </div>\n                    )}\n                    {selectedUser.businessDetails.serviceArea && (\n                      <div>\n                        <span className=\"text-xs text-slate-500\">Service Area: </span>\n                        <span className=\"text-sm text-slate-900\">{selectedUser.businessDetails.serviceArea}</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n              \n              {/* Admin Controls */}\n              <div className=\"pt-4 border-t border-slate-200\">\n                <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 block\">\n                  Admin Controls\n                </label>\n                <div className=\"space-y-4\">\n                  {/* Admin Status Toggle */}\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-sm font-medium text-slate-900\">Admin Status</p>\n                      <p className=\"text-xs text-slate-500 mt-0.5\">\n                        {selectedUser.isAdmin ? \"User has admin privileges\" : \"User does not have admin privileges\"}\n                      </p>\n                    </div>\n                    <button\n                      onClick={handleToggleAdmin}\n                      disabled={isUpdating || (currentUserId === selectedUser.id && selectedUser.isAdmin)}\n                      className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${\n                        selectedUser.isAdmin\n                          ? \"bg-red-100 hover:bg-red-200 text-red-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n                          : \"bg-purple-100 hover:bg-purple-200 text-purple-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n                      }`}\n                    >\n                      {isUpdating\n                        ? \"...\"\n                        : selectedUser.isAdmin\n                        ? currentUserId === selectedUser.id\n                          ? \"Cannot Remove Own Admin\"\n                          : \"Remove Admin\"\n                        : \"Make Admin\"}\n                    </button>\n                  </div>\n\n                  {/* Plan Status */}\n                  <div>\n                    <label className=\"text-sm font-medium text-slate-900 mb-2 block\">Plan Status</label>\n                    <select\n                      value={selectedUser.planStatus || \"TRIAL\"}\n                      onChange={handlePlanStatusChange}\n                      disabled={isUpdating}\n                      className=\"w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed\"\n                    >\n                      <option value=\"TRIAL\">TRIAL</option>\n                      <option value=\"ACTIVE\">ACTIVE</option>\n                      <option value=\"PAST_DUE\">PAST_DUE</option>\n                      <option value=\"CANCELLED\">CANCELLED</option>\n                    </select>\n                  </div>\n\n                  {/* Success Message */}\n                  {updateSuccess && (\n                    <div className=\"p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm flex items-center gap-2\">\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                      </svg>\n                      {updateSuccess}\n                    </div>\n                  )}\n\n                  {/* Error Message */}\n                  {updateError && (\n                    <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\n                      {updateError}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n            <div className=\"p-6 border-t border-slate-200 flex justify-end gap-3\">\n              <button\n                onClick={() => setSelectedUser(null)}\n                className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium\"\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\verification\\AdminVerificationPageContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1281,1284],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1281,1284],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1928,1931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1928,1931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { CheckCircle, Clock, XCircle } from \"lucide-react\";\n\ninterface Verification {\n  id: string;\n  userId: string;\n  status: string;\n  businessName: string | null;\n  abn: string | null;\n  primaryTrade: string | null;\n  workTypes: string | null;\n  createdAt: string;\n  updatedAt: string;\n  user: {\n    id: string;\n    email: string;\n    role: string;\n  };\n}\n\nexport default function AdminVerificationPageContent() {\n  const router = useRouter();\n  const [isAdmin, setIsAdmin] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [verifications, setVerifications] = useState<Verification[]>([]);\n  const [error, setError] = useState(\"\");\n\n  const fetchVerifications = useCallback(async () => {\n    try {\n      setIsLoading(true);\n      setError(\"\");\n      const response = await fetch(\"/api/admin/verification\");\n      if (response.ok) {\n        const data = await response.json();\n        setIsAdmin(true);\n        // Filter out any verifications with missing user relations (defensive check)\n        const validVerifications = Array.isArray(data.verifications) \n          ? data.verifications.filter((v: any) => v.user !== null && v.user !== undefined)\n          : [];\n        setVerifications(validVerifications);\n      } else if (response.status === 403) {\n        setIsAdmin(false);\n        setError(\"Access denied. Admin privileges required.\");\n      } else if (response.status === 401) {\n        router.push(\"/login\");\n      } else {\n        let errorData: { error?: string } = {};\n        try {\n          errorData = await response.json();\n        } catch {\n          // If JSON parsing fails, use default error message\n        }\n        setError(errorData?.error || \"Failed to load verifications. Please try again.\");\n      }\n    } catch (err: any) {\n      console.error(\"[admin-verifications] error fetching verifications:\", err);\n      const errorMessage = err?.message || \"Failed to load verifications. Please try again.\";\n      setError(errorMessage);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [router]);\n\n  useEffect(() => {\n    fetchVerifications();\n  }, [fetchVerifications]);\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"verified\":\n        return (\n          <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700\">\n            <CheckCircle className=\"w-3 h-3\" />\n            Verified\n          </span>\n        );\n      case \"pending\":\n        return (\n          <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700\">\n            <Clock className=\"w-3 h-3\" />\n            Pending\n          </span>\n        );\n      case \"rejected\":\n        return (\n          <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700\">\n            <XCircle className=\"w-3 h-3\" />\n            Rejected\n          </span>\n        );\n      default:\n        return (\n          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700\">\n            Unverified\n          </span>\n        );\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[calc(100vh-4rem)]\">\n        <div className=\"text-slate-500\">Loading...</div>\n      </div>\n    );\n  }\n\n  if (!isAdmin) {\n    return (\n      <div className=\"max-w-2xl mx-auto px-4 py-12\">\n        <div className=\"bg-white rounded-xl border border-slate-200 p-8 text-center\">\n          <h1 className=\"text-xl font-semibold text-slate-900 mb-2\">Access Denied</h1>\n          <p className=\"text-slate-600 mb-6\">\n            You don&apos;t have permission to access this page.\n          </p>\n          <Link\n            href=\"/dashboard\"\n            className=\"inline-flex items-center px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors\"\n          >\n            Back to Dashboard\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  const pendingVerifications = verifications.filter((v) => v.status === \"pending\");\n  const verifiedVerifications = verifications.filter((v) => v.status === \"verified\");\n  const rejectedVerifications = verifications.filter((v) => v.status === \"rejected\");\n\n  return (\n    <div className=\"max-w-6xl mx-auto px-4 py-8\">\n      {/* Admin Navigation */}\n      <div className=\"mb-6 flex gap-3\">\n        <Link\n          href=\"/admin/dashboard\"\n          className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors cursor-pointer\"\n        >\n          Dashboard\n        </Link>\n        <Link\n          href=\"/admin/users\"\n          className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors cursor-pointer\"\n        >\n          Users\n        </Link>\n        <span className=\"px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg\">\n          Verifications\n        </span>\n        <Link\n          href=\"/admin/feedback\"\n          className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors cursor-pointer\"\n        >\n          Feedback Log\n        </Link>\n      </div>\n\n      <div className=\"mb-8\">\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Business verification</h1>\n        <p className=\"text-slate-600\">\n          Review and approve tradie business verifications.\n        </p>\n      </div>\n\n      {/* Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\n        <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4\">\n          <div className=\"text-2xl font-bold text-amber-900\">{pendingVerifications.length}</div>\n          <div className=\"text-sm text-amber-700\">Pending Review</div>\n        </div>\n        <div className=\"bg-green-50 border border-green-200 rounded-lg p-4\">\n          <div className=\"text-2xl font-bold text-green-900\">{verifiedVerifications.length}</div>\n          <div className=\"text-sm text-green-700\">Verified</div>\n        </div>\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n          <div className=\"text-2xl font-bold text-red-900\">{rejectedVerifications.length}</div>\n          <div className=\"text-sm text-red-700\">Rejected</div>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\n          {error}\n          <button\n            onClick={() => setError(\"\")}\n            className=\"ml-2 text-red-500 hover:text-red-700\"\n          >\n            Ô£ò\n          </button>\n        </div>\n      )}\n\n      {verifications.length === 0 ? (\n        <div className=\"bg-white rounded-xl border border-slate-200 p-8 text-center\">\n          <div className=\"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n            <CheckCircle className=\"w-8 h-8 text-green-600\" />\n          </div>\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-2\">No Verifications</h2>\n          <p className=\"text-slate-600\">\n            No verification records found.\n          </p>\n        </div>\n      ) : (\n        <div className=\"bg-white rounded-xl border border-slate-200 overflow-hidden\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"bg-slate-50 border-b border-slate-200\">\n                <tr>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Email\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Business Name\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    ABN\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Primary Trade\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Status\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Actions\n                  </th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-200\">\n                {verifications.map((verification) => (\n                  <tr key={verification.id} className=\"hover:bg-slate-50\">\n                    <td className=\"px-4 py-4\">\n                      <div className=\"text-sm font-medium text-slate-900\">{verification.user?.email || \"N/A\"}</div>\n                      <div className=\"text-xs text-slate-500\">\n                        {verification.createdAt ? new Date(verification.createdAt).toLocaleDateString() : \"N/A\"}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <div className=\"text-sm text-slate-900\">\n                        {verification.businessName || \"-\"}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <div className=\"text-sm font-mono text-slate-900\">\n                        {verification.abn || \"-\"}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <div className=\"text-sm text-slate-900\">\n                        {verification.primaryTrade || \"-\"}\n                      </div>\n                      {verification.workTypes && (\n                        <div className=\"text-xs text-slate-500 mt-1\">\n                          {verification.workTypes}\n                        </div>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      {getStatusBadge(verification.status)}\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <Link\n                        href={`/admin/verification/${verification.userId}`}\n                        className=\"inline-flex items-center px-3 py-1.5 bg-amber-600 hover:bg-amber-700 text-white text-sm font-medium rounded-lg transition-colors\"\n                      >\n                        Review\n                      </Link>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\verification\\[userId]\\VerificationDetailView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_adminUserId' is defined but never used.","line":23,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1880,1883],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1880,1883],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { Loader2, CheckCircle, XCircle, Clock } from \"lucide-react\";\nimport type { UserVerification } from \"@prisma/client\";\n\ninterface VerificationDetailViewProps {\n  verification: UserVerification;\n  user: {\n    id: string;\n    email: string;\n    role: string;\n    createdAt: Date;\n  };\n  adminUserId: string;\n}\n\nexport default function VerificationDetailView({\n  verification,\n  user,\n  adminUserId: _adminUserId,\n}: VerificationDetailViewProps) {\n  const router = useRouter();\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(\"\");\n  const [adminNotes, setAdminNotes] = useState(verification.adminNotes || \"\");\n  const [rejectionReason, setRejectionReason] = useState(verification.rejectionReason || \"\");\n\n  const handleStatusChange = async (status: \"verified\" | \"pending\" | \"rejected\") => {\n    if (status === \"rejected\" && !rejectionReason.trim()) {\n      setError(\"Please provide a rejection reason\");\n      return;\n    }\n\n    setIsLoading(true);\n    setError(\"\");\n    setSuccess(\"\");\n\n    try {\n      const response = await fetch(`/api/admin/verification/${user.id}/status`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          status,\n          adminNotes: adminNotes || null,\n          rejectionReason: status === \"rejected\" ? rejectionReason : null,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || \"Failed to update status\");\n      }\n\n      setSuccess(`Verification ${status}`);\n      // Refresh page after a short delay\n      setTimeout(() => {\n        router.refresh();\n      }, 1000);\n    } catch (err: any) {\n      setError(err.message || \"Failed to update status\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"-\";\n    return new Date(date).toLocaleDateString(\"en-AU\", {\n      day: \"numeric\",\n      month: \"long\",\n      year: \"numeric\",\n    });\n  };\n\n  return (\n    <div className=\"max-w-4xl mx-auto px-4 py-8\">\n      {/* Back Link */}\n      <Link\n        href=\"/admin/verification\"\n        className=\"inline-flex items-center text-sm text-slate-600 hover:text-slate-900 mb-6\"\n      >\n        <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n        </svg>\n        Back to Verification List\n      </Link>\n\n      {/* Header */}\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Verification Review</h1>\n        <div className=\"flex items-center gap-4 text-sm text-slate-600\">\n          <span>{user.email}</span>\n          <span>ÔÇó</span>\n          <span>{user.role}</span>\n          <span>ÔÇó</span>\n          <Link href={`/admin/users/${user.id}`} className=\"text-amber-600 hover:text-amber-700\">\n            View User ÔåÆ\n          </Link>\n        </div>\n      </div>\n\n      {/* Status Badge */}\n      <div className=\"mb-6\">\n        {verification.status === \"verified\" && (\n          <span className=\"inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg font-medium\">\n            <CheckCircle className=\"w-5 h-5\" />\n            Verified\n          </span>\n        )}\n        {verification.status === \"pending\" && (\n          <span className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-700 rounded-lg font-medium\">\n            <Clock className=\"w-5 h-5\" />\n            Pending review\n          </span>\n        )}\n        {verification.status === \"rejected\" && (\n          <span className=\"inline-flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg font-medium\">\n            <XCircle className=\"w-5 h-5\" />\n            Rejected\n          </span>\n        )}\n        {verification.status === \"unverified\" && (\n          <span className=\"inline-flex items-center gap-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium\">\n            Not submitted\n          </span>\n        )}\n      </div>\n\n      {/* Messages */}\n      {error && (\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\n          {error}\n        </div>\n      )}\n      {success && (\n        <div className=\"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700\">\n          {success}\n        </div>\n      )}\n\n      {/* Verification Details */}\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 space-y-8\">\n        {/* Business Details */}\n        <div>\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Business Details</h2>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <p className=\"text-sm font-medium text-slate-500 mb-1\">Business Name</p>\n              <p className=\"text-slate-900\">{verification.businessName || \"-\"}</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-slate-500 mb-1\">ABN</p>\n              <p className=\"text-slate-900 font-mono\">{verification.abn || \"-\"}</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-slate-500 mb-1\">Primary Trade</p>\n              <p className=\"text-slate-900\">{verification.primaryTrade || \"-\"}</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-slate-500 mb-1\">Work Types</p>\n              <p className=\"text-slate-900\">{verification.workTypes || \"-\"}</p>\n            </div>\n          </div>\n          {verification.abnEvidenceUrl && (\n            <div className=\"mt-4\">\n              <p className=\"text-sm font-medium text-slate-500 mb-1\">ABN Evidence</p>\n              <a\n                href={verification.abnEvidenceUrl}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-amber-600 hover:text-amber-700 underline\"\n              >\n                {verification.abnEvidenceUrl}\n              </a>\n            </div>\n          )}\n        </div>\n\n        {/* Licence Details */}\n        {(verification.licenceNumber || verification.licenceType || verification.licenceExpiry) && (\n          <div className=\"pt-6 border-t border-slate-200\">\n            <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Licence Details</h2>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {verification.licenceType && (\n                <div>\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Licence Type</p>\n                  <p className=\"text-slate-900\">{verification.licenceType}</p>\n                </div>\n              )}\n              {verification.licenceNumber && (\n                <div>\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Licence Number</p>\n                  <p className=\"text-slate-900 font-mono\">{verification.licenceNumber}</p>\n                </div>\n              )}\n              {verification.licenceExpiry && (\n                <div>\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Expiry Date</p>\n                  <p className=\"text-slate-900\">{formatDate(verification.licenceExpiry)}</p>\n                </div>\n              )}\n            </div>\n            {verification.licenceEvidenceUrl && (\n              <div className=\"mt-4\">\n                <p className=\"text-sm font-medium text-slate-500 mb-1\">Licence Evidence</p>\n                <a\n                  href={verification.licenceEvidenceUrl}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"text-amber-600 hover:text-amber-700 underline\"\n                >\n                  {verification.licenceEvidenceUrl}\n                </a>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Insurance Details */}\n        {(verification.insuranceProvider ||\n          verification.insurancePolicyNumber ||\n          verification.insuranceExpiry) && (\n          <div className=\"pt-6 border-t border-slate-200\">\n            <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Insurance Details</h2>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {verification.insuranceProvider && (\n                <div>\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Provider</p>\n                  <p className=\"text-slate-900\">{verification.insuranceProvider}</p>\n                </div>\n              )}\n              {verification.insurancePolicyNumber && (\n                <div>\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Policy Number</p>\n                  <p className=\"text-slate-900 font-mono\">{verification.insurancePolicyNumber}</p>\n                </div>\n              )}\n              {verification.insuranceExpiry && (\n                <div>\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Expiry Date</p>\n                  <p className=\"text-slate-900\">{formatDate(verification.insuranceExpiry)}</p>\n                </div>\n              )}\n              {verification.insuranceCoverageNotes && (\n                <div className=\"md:col-span-2\">\n                  <p className=\"text-sm font-medium text-slate-500 mb-1\">Coverage Notes</p>\n                  <p className=\"text-slate-900\">{verification.insuranceCoverageNotes}</p>\n                </div>\n              )}\n            </div>\n            {verification.insuranceEvidenceUrl && (\n              <div className=\"mt-4\">\n                <p className=\"text-sm font-medium text-slate-500 mb-1\">Insurance Evidence</p>\n                <a\n                  href={verification.insuranceEvidenceUrl}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"text-amber-600 hover:text-amber-700 underline\"\n                >\n                  {verification.insuranceEvidenceUrl}\n                </a>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Admin Controls */}\n        <div className=\"pt-6 border-t border-slate-200\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Admin Controls</h2>\n          \n          <div className=\"space-y-4\">\n            <div>\n              <label htmlFor=\"adminNotes\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                Admin Notes (Internal Only)\n              </label>\n              <textarea\n                id=\"adminNotes\"\n                value={adminNotes}\n                onChange={(e) => setAdminNotes(e.target.value)}\n                rows={3}\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-none\"\n                placeholder=\"Internal notes for admin reference...\"\n                disabled={isLoading}\n              />\n            </div>\n\n            <div>\n              <label htmlFor=\"rejectionReason\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                Rejection reason (visible to user)\n              </label>\n              <textarea\n                id=\"rejectionReason\"\n                value={rejectionReason}\n                onChange={(e) => setRejectionReason(e.target.value)}\n                rows={2}\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-none\"\n                placeholder=\"Reason for rejection (shown to user)...\"\n                disabled={isLoading}\n              />\n            </div>\n\n            <div className=\"flex flex-wrap gap-3 pt-4\">\n              <button\n                onClick={() => handleStatusChange(\"verified\")}\n                disabled={isLoading || verification.status === \"verified\"}\n                className=\"inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                {isLoading ? (\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                ) : (\n                  <CheckCircle className=\"w-4 h-4\" />\n                )}\n                Approve\n              </button>\n\n              <button\n                onClick={() => handleStatusChange(\"pending\")}\n                disabled={isLoading || verification.status === \"pending\"}\n                className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                {isLoading ? (\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                ) : (\n                  <Clock className=\"w-4 h-4\" />\n                )}\n                Request more info\n              </button>\n\n              <button\n                onClick={() => handleStatusChange(\"rejected\")}\n                disabled={isLoading || verification.status === \"rejected\" || !rejectionReason.trim()}\n                className=\"inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                {isLoading ? (\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                ) : (\n                  <XCircle className=\"w-4 h-4\" />\n                )}\n                Reject\n              </button>\n            </div>\n          </div>\n        </div>\n\n        {/* Timestamps */}\n        <div className=\"pt-6 border-t border-slate-200 text-sm text-slate-500\">\n          <p>Created: {formatDate(verification.createdAt)}</p>\n          <p>Last Updated: {formatDate(verification.updatedAt)}</p>\n          {verification.reviewedByAdminId && (\n            <p>Reviewed by: {verification.reviewedByAdminId}</p>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\verification\\[userId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\admin\\verification\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\feedback\\[id]\\messages\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\feedback\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\impersonate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\jobs\\[id]\\assign\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\tradies\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/admin/tradies\r\n * Admin-only endpoint to list all active tradie/business users\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // Auth check - admin only\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    if (!isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Forbidden - admin access required\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Fetch all active tradie/business users\r\n    const prisma = getPrisma();\r\n    const tradies = await prisma.user.findMany({\r\n      where: {\r\n        role: {\r\n          in: [\"tradie\", \"builder\", \"business\", \"supplier\"],\r\n        },\r\n        isBanned: false,\r\n        accountStatus: \"ACTIVE\",\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        businessName: true,\r\n        tradingName: true,\r\n        primaryTrade: true,\r\n      },\r\n      orderBy: [\r\n        { tradingName: \"asc\" },\r\n        { businessName: \"asc\" },\r\n        { email: \"asc\" },\r\n      ],\r\n    });\r\n\r\n    return NextResponse.json({\r\n      tradies: tradies.map((t) => ({\r\n        id: t.id,\r\n        email: t.email,\r\n        businessName: t.tradingName || t.businessName,\r\n        primaryTrade: t.primaryTrade,\r\n      })),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching tradies:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch tradies\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\users\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RouteParams' is defined but never used.","line":5,"column":6,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":62,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2060,2063],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2060,2063],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":214,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":214,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin, updateUser, getUserById } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\ntype RouteParams = {\r\n  params: {\r\n    id: string;\r\n  };\r\n};\r\n\r\n/**\r\n * PATCH /api/admin/users/[id]\r\n * Update a user's admin status, plan status, plan tier, or trial end date.\r\n * Only accessible by admins.\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n): Promise<NextResponse> {\r\n  try {\r\n    // Check authentication and admin status\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    if (!isAdmin(currentUser)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Await params (Next.js 16+ requires params to be a Promise)\r\n    const params = await context.params;\r\n    const userId = params.id;\r\n\r\n    console.log(`[Admin API] Updating user with ID: ${userId}`);\r\n\r\n    // Get the user to update from KV store (primary source)\r\n    let targetUser = await getUserById(userId);\r\n    let actualUserId = userId; // Default to route param ID\r\n    \r\n    if (!targetUser) {\r\n      console.error(`[Admin API] User ${userId} not found in KV store. Attempting fallback lookup...`);\r\n      \r\n      // Fallback: Try to find user by checking if this is a Prisma ID\r\n      // and then look up the corresponding KV user by email\r\n      const prisma = getPrisma();\r\n      try {\r\n        const prismaUser = await prisma.user.findUnique({\r\n          where: { id: userId },\r\n        });\r\n        \r\n        if (prismaUser) {\r\n          console.log(`[Admin API] Found user in Prisma: ${prismaUser.email}, looking up in KV...`);\r\n          // Try to find in KV by email\r\n          const { kv } = await import(\"@/lib/kv\");\r\n          const kvUser = (await kv.get(`user:email:${prismaUser.email.toLowerCase()}`)) as any;\r\n          if (kvUser && kvUser.id) {\r\n            console.log(`[Admin API] Found KV user with ID: ${kvUser.id}`);\r\n            targetUser = await getUserById(kvUser.id);\r\n            if (targetUser) {\r\n              // Use the KV user ID for updates\r\n              actualUserId = targetUser.id;\r\n            }\r\n          }\r\n        }\r\n      } catch (prismaError) {\r\n        console.warn(\"[Admin API] Could not check Prisma for user:\", prismaError);\r\n      }\r\n    } else {\r\n      // User found in KV, use their ID\r\n      actualUserId = targetUser.id;\r\n    }\r\n    \r\n    if (!targetUser) {\r\n      console.error(`[Admin API] User ${userId} not found in either KV store or Prisma`);\r\n      return NextResponse.json(\r\n        { error: `User not found. User ID: ${userId}. Please ensure the user exists in the system.` },\r\n        { status: 404 }\r\n      );\r\n    }\r\n    \r\n    console.log(`[Admin API] Found user: ${targetUser.email} (KV ID: ${actualUserId}), current role: ${targetUser.role}, isAdmin: ${targetUser.isAdmin ?? false}`);\r\n\r\n    // Parse request body\r\n    const body = await request.json().catch(() => ({}));\r\n\r\n    // Prevent admin from removing their own admin status\r\n    // Check both the route param ID and the actual user ID\r\n    if ((currentUser.id === userId || currentUser.id === actualUserId) && body.isAdmin === false) {\r\n      return NextResponse.json(\r\n        { error: \"You cannot remove your own admin status\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    const updates: {\r\n      isAdmin?: boolean;\r\n      role?: \"admin\" | \"tradie\" | \"builder\" | \"client\" | \"supplier\";\r\n      verificationStatus?: \"unverified\" | \"pending\" | \"verified\";\r\n      verifiedAt?: string | null;\r\n      planStatus?: \"TRIAL\" | \"ACTIVE\" | \"PAST_DUE\" | \"CANCELLED\";\r\n      planTier?: \"FREE\" | \"TRIAL\" | \"FOUNDER\" | \"PRO\" | \"BUSINESS\";\r\n      trialEndsAt?: string | null;\r\n    } = {};\r\n\r\n    // Only include fields that are actually provided (not undefined)\r\n    if (typeof body.isAdmin === \"boolean\") {\r\n      updates.isAdmin = body.isAdmin;\r\n      // If making admin, also set role to \"admin\" and auto-verify (admins don't need business verification)\r\n      if (body.isAdmin === true) {\r\n        updates.role = \"admin\";\r\n        updates.verificationStatus = \"verified\";\r\n        // Set verifiedAt if not already set\r\n        if (!targetUser.verifiedAt) {\r\n          updates.verifiedAt = new Date().toISOString();\r\n        }\r\n      } else {\r\n        // If removing admin, reset role to \"tradie\" (default non-admin role)\r\n        // Keep verification status as-is (don't remove verification)\r\n        updates.role = \"tradie\";\r\n      }\r\n    }\r\n\r\n    if (typeof body.planStatus === \"string\") {\r\n      // Validate plan status (mapping SUSPENDED to CANCELLED for compatibility)\r\n      const validStatuses = [\"TRIAL\", \"ACTIVE\", \"PAST_DUE\", \"CANCELLED\", \"SUSPENDED\"];\r\n      if (validStatuses.includes(body.planStatus)) {\r\n        // Map SUSPENDED to CANCELLED since it's not in the PlanStatus type\r\n        updates.planStatus = body.planStatus === \"SUSPENDED\" ? \"CANCELLED\" : (body.planStatus as \"TRIAL\" | \"ACTIVE\" | \"PAST_DUE\" | \"CANCELLED\");\r\n      }\r\n    }\r\n\r\n    if (typeof body.planTier === \"string\") {\r\n      const validTiers = [\"FREE\", \"TRIAL\", \"FOUNDER\", \"PRO\", \"BUSINESS\"];\r\n      if (validTiers.includes(body.planTier)) {\r\n        updates.planTier = body.planTier as \"FREE\" | \"TRIAL\" | \"FOUNDER\" | \"PRO\" | \"BUSINESS\";\r\n      }\r\n    }\r\n\r\n    if (body.trialEndsAt !== undefined) {\r\n      // Allow null or ISO date string\r\n      if (body.trialEndsAt === null) {\r\n        updates.trialEndsAt = null;\r\n      } else if (typeof body.trialEndsAt === \"string\") {\r\n        // Validate it's a valid date\r\n        const date = new Date(body.trialEndsAt);\r\n        if (!isNaN(date.getTime())) {\r\n          updates.trialEndsAt = date.toISOString();\r\n        }\r\n      }\r\n    }\r\n\r\n    // If no valid updates, return error\r\n    if (Object.keys(updates).length === 0) {\r\n      return NextResponse.json(\r\n        { error: \"No valid fields to update\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Update the user in KV store using the actual KV user ID\r\n    console.log(`[Admin API] Updating user ${actualUserId} with updates:`, updates);\r\n    const updatedUser = await updateUser(actualUserId, updates);\r\n    if (!updatedUser) {\r\n      console.error(`[Admin API] Failed to update user ${actualUserId} in KV store. updateUser returned null.`);\r\n      return NextResponse.json(\r\n        { error: `Failed to update user in database. User ID: ${actualUserId}` },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    \r\n    console.log(`[Admin API] Successfully updated user in KV store: ${updatedUser.email}, role: ${updatedUser.role}, isAdmin: ${updatedUser.isAdmin}`);\r\n\r\n    // Also update Prisma if user exists there (for role and admin status)\r\n    if (updates.role || updates.isAdmin !== undefined) {\r\n      const prisma = getPrisma();\r\n      try {\r\n        // Find user by email (since KV and Prisma may use different IDs)\r\n        const prismaUser = await prisma.user.findUnique({\r\n          where: { email: targetUser.email },\r\n        });\r\n\r\n        if (prismaUser) {\r\n          // Update Prisma user - always update role to match KV store\r\n          await prisma.user.update({\r\n            where: { id: prismaUser.id },\r\n            data: {\r\n              role: updates.role || (updates.isAdmin === false ? \"tradie\" : prismaUser.role),\r\n              // Note: Prisma User model doesn't have isAdmin field, but role=\"admin\" is sufficient\r\n            },\r\n          });\r\n        }\r\n      } catch (prismaError) {\r\n        // Log but don't fail - KV update succeeded\r\n        console.warn(\"Failed to update Prisma user (non-critical):\", prismaError);\r\n      }\r\n    }\r\n\r\n    // Return the updated user (safe, without password hash)\r\n    // Re-fetch to ensure we have the latest normalized data\r\n    let finalUser = await getUserById(actualUserId);\r\n    \r\n    // If still not found, use the updatedUser from updateUser response\r\n    if (!finalUser) {\r\n      finalUser = await getUserById(updatedUser.id);\r\n    }\r\n    \r\n    const safeUser = finalUser ? (() => {\r\n      const { passwordHash: _, ...safe } = finalUser!;\r\n      return safe;\r\n    })() : updatedUser;\r\n\r\n    // Ensure isAdmin is properly set based on role if not explicitly set\r\n    const isAdminValue = safeUser.isAdmin ?? (safeUser.role === \"admin\");\r\n\r\n    console.log(`[Admin API] Update complete. User: ${safeUser.email}, role: ${safeUser.role}, isAdmin: ${isAdminValue}`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      user: {\r\n        id: safeUser.id,\r\n        email: safeUser.email,\r\n        role: safeUser.role,\r\n        verificationStatus: safeUser.verificationStatus,\r\n        verifiedAt: safeUser.verifiedAt,\r\n        isAdmin: isAdminValue,\r\n        planTier: safeUser.planTier,\r\n        planStatus: safeUser.planStatus,\r\n        trialEndsAt: safeUser.trialEndsAt,\r\n        lastLoginAt: safeUser.lastLoginAt,\r\n        lastActivityAt: safeUser.lastActivityAt,\r\n        totalJobs: safeUser.totalJobs,\r\n        totalJobPacks: safeUser.totalJobPacks,\r\n        businessDetails: safeUser.businessDetails,\r\n        createdAt: safeUser.createdAt,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating user:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\users\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2204,2207],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2204,2207],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":204,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6799,6802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6799,6802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { buildPagination, buildPaginatedResult, type PaginatedResult } from \"@/lib/pagination\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\ninterface UserListItem {\r\n  id: string;\r\n  email: string;\r\n  name?: string;\r\n  createdAt: string;\r\n  role: string;\r\n  verificationStatus: string;\r\n  verifiedAt: string | null;\r\n  isAdmin: boolean;\r\n  planTier?: string;\r\n  planStatus?: string;\r\n  trialEndsAt?: string | null;\r\n  accountStatus?: string;\r\n  isBanned?: boolean;\r\n  lastLoginAt?: string | null;\r\n  lastActivityAt?: string | null;\r\n  totalJobs?: number;\r\n  businessName?: string;\r\n  businessDetails?: {\r\n    businessName?: string;\r\n    tradingName?: string;\r\n    abn?: string;\r\n    tradeTypes?: string[];\r\n    serviceArea?: string;\r\n    serviceAreaCity?: string;\r\n    serviceAreaRadiusKm?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * GET /api/admin/users\r\n * Returns paginated users in the system (admin only)\r\n * Query params: page, search, verificationStatus, planStatus, accountStatus\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    console.log(\"[admin-users] loading users list\");\r\n    // Check authentication and admin status\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    if (!isAdmin(currentUser)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Parse query params\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const pageParam = searchParams.get(\"page\");\r\n    const searchQuery = searchParams.get(\"search\") || \"\";\r\n    const verificationFilter = searchParams.get(\"verificationStatus\") || \"all\";\r\n    const planStatusFilter = searchParams.get(\"planStatus\") || \"all\";\r\n    const accountStatusFilter = searchParams.get(\"accountStatus\") || \"all\";\r\n\r\n    // Build pagination\r\n    const { page, pageSize, skip, take } = buildPagination(pageParam, 20);\r\n\r\n    const prisma = getPrisma();\r\n    // Build Prisma where clause\r\n    const where: any = {};\r\n\r\n    // Search filter (email, businessName)\r\n    if (searchQuery.trim()) {\r\n      const query = searchQuery.trim().toLowerCase();\r\n      where.OR = [\r\n        { email: { contains: query, mode: \"insensitive\" } },\r\n        { businessName: { contains: query, mode: \"insensitive\" } },\r\n        { tradingName: { contains: query, mode: \"insensitive\" } },\r\n      ];\r\n    }\r\n\r\n    // Verification status filter\r\n    if (verificationFilter !== \"all\") {\r\n      where.verificationStatus = verificationFilter;\r\n    }\r\n\r\n    // Plan status filter\r\n    if (planStatusFilter !== \"all\") {\r\n      where.planStatus = planStatusFilter;\r\n    }\r\n\r\n    // Account status filter\r\n    if (accountStatusFilter !== \"all\") {\r\n      if (accountStatusFilter === \"BANNED\") {\r\n        where.isBanned = true;\r\n      } else {\r\n        where.accountStatus = accountStatusFilter;\r\n        where.isBanned = false;\r\n      }\r\n    }\r\n\r\n    // Get total count with same filters\r\n    const totalItems = await prisma.user.count({ where });\r\n\r\n    // Get paginated users\r\n    const prismaUsers = await prisma.user.findMany({\r\n      where,\r\n      skip,\r\n      take,\r\n      orderBy: { createdAt: \"desc\" },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        createdAt: true,\r\n        role: true,\r\n        verificationStatus: true,\r\n        verifiedAt: true,\r\n        emailVerifiedAt: true, // Email verification status\r\n        isBanned: true,\r\n        accountStatus: true,\r\n        planTier: true,\r\n        planStatus: true,\r\n        trialEndsAt: true,\r\n        lastLoginAt: true,\r\n        lastActivityAt: true,\r\n        totalJobs: true,\r\n        businessName: true,\r\n        tradingName: true,\r\n        abn: true,\r\n        primaryTrade: true,\r\n        tradeTypes: true,\r\n        serviceArea: true,\r\n        serviceAreaCity: true,\r\n        serviceRadiusKm: true,\r\n        onboardingCompletedAt: true,\r\n        onboardingDismissed: true,\r\n        onboardingBusinessProfileDone: true,\r\n        onboardingRatesDone: true,\r\n        onboardingServiceAreaDone: true,\r\n        onboardingVerificationDone: true,\r\n        onboardingFirstJobDone: true,\r\n      },\r\n    });\r\n\r\n    // Check admin status from KV (since isAdmin might not be in Prisma)\r\n    const { getAllUsers } = await import(\"@/lib/auth\");\r\n    const allKvUsers = await getAllUsers();\r\n    const kvUserMap = new Map(allKvUsers.map((u) => [u.id, u]));\r\n\r\n    // Map to response format\r\n    const users: UserListItem[] = prismaUsers.map((user) => {\r\n      const kvUser = kvUserMap.get(user.id);\r\n      const isAdminFlag = kvUser?.isAdmin ?? false;\r\n\r\n      return {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: user.email.split(\"@\")[0],\r\n        businessName: user.businessName || undefined,\r\n        role: user.role,\r\n        isAdmin: isAdminFlag,\r\n        planTier: user.planTier || \"FREE\",\r\n        planStatus: user.planStatus || \"TRIAL\",\r\n        accountStatus: user.accountStatus || (user.isBanned ? \"BANNED\" : \"ACTIVE\"),\r\n        isBanned: user.isBanned,\r\n        createdAt: user.createdAt.toISOString(),\r\n        lastLoginAt: user.lastLoginAt?.toISOString() || null,\r\n        lastActivityAt: user.lastActivityAt?.toISOString() || null,\r\n        totalJobs: user.totalJobs || 0,\r\n        verificationStatus: user.verificationStatus,\r\n        verifiedAt: user.verifiedAt?.toISOString() || null,\r\n        emailVerifiedAt: user.emailVerifiedAt?.toISOString() || null, // Email verification status\r\n        businessDetails: {\r\n          businessName: user.businessName || undefined,\r\n          tradingName: user.tradingName || undefined,\r\n          abn: user.abn || undefined,\r\n          tradeTypes: user.tradeTypes ? (() => {\r\n            try {\r\n              return JSON.parse(user.tradeTypes);\r\n            } catch {\r\n              // If JSON parsing fails, return as string array or undefined\r\n              return user.tradeTypes.includes(\",\") ? user.tradeTypes.split(\",\").map(t => t.trim()) : undefined;\r\n            }\r\n          })() : undefined,\r\n          serviceArea: user.serviceArea || undefined,\r\n          serviceAreaCity: user.serviceAreaCity || undefined,\r\n          serviceAreaRadiusKm: user.serviceRadiusKm || undefined,\r\n        },\r\n        trialEndsAt: user.trialEndsAt?.toISOString() || null,\r\n      };\r\n    });\r\n\r\n    const result: PaginatedResult<UserListItem> = buildPaginatedResult(\r\n      users,\r\n      page,\r\n      pageSize,\r\n      totalItems\r\n    );\r\n\r\n    console.log(`[admin-users] loaded ${users.length} users (page ${page}, total ${totalItems})`);\r\n    return NextResponse.json(result);\r\n  } catch (error: any) {\r\n    console.error(\"[admin-users] error fetching users:\", error);\r\n    const errorMessage = error?.message || \"Failed to load users. Please try again.\";\r\n    return NextResponse.json(\r\n      { error: errorMessage },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\verification\\[userId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\verification\\[userId]\\status\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\admin\\verification\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NextRequest' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getVerificationsByStatus' is defined but never used.","line":3,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1359,1362],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1359,1362],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getAllVerifications, getVerificationsByStatus } from \"@/lib/verification\";\r\n\r\n/**\r\n * GET /api/admin/verification\r\n * Returns all verification records, sorted by status (pending first) then createdAt desc\r\n */\r\nexport async function GET() {\r\n  try {\r\n    console.log(\"[admin-verifications] loading verifications list\");\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    if (!isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const verifications = await getAllVerifications();\r\n    const pending = verifications.filter((v) => v.status === \"pending\");\r\n    \r\n    console.log(`[admin-verifications] loaded ${verifications.length} verifications (${pending.length} pending)`);\r\n\r\n    return NextResponse.json({\r\n      verifications,\r\n      counts: {\r\n        pending: pending.length,\r\n        verified: verifications.filter((v) => v.status === \"verified\").length,\r\n        rejected: verifications.filter((v) => v.status === \"rejected\").length,\r\n        total: verifications.length,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"[admin-verifications] error fetching verifications:\", error);\r\n    const errorMessage = error?.message || \"Failed to load verifications. Please try again.\";\r\n    return NextResponse.json(\r\n      { error: errorMessage },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\forgot-password\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\login\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\logout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\me\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\register\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\reset-password\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\send-verification-email\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":17,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { Resend } from \"resend\";\r\nimport { createEmailVerificationToken } from \"@/lib/email-verification\";\r\n\r\nconst resend = process.env.RESEND_API_KEY\r\n  ? new Resend(process.env.RESEND_API_KEY)\r\n  : null;\r\n\r\nconst DEFAULT_FROM = process.env.EMAIL_FROM || \"OMNEXORA <onboarding@resend.dev>\";\r\n\r\n/**\r\n * POST /api/auth/send-verification-email\r\n * Sends an email verification link to the current user\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Check authentication\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Check if user is already verified\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: currentUser.email },\r\n      select: { id: true, emailVerifiedAt: true },\r\n    });\r\n\r\n    if (prismaUser?.emailVerifiedAt) {\r\n      return NextResponse.json(\r\n        { success: true, alreadyVerified: true },\r\n        { status: 200 }\r\n      );\r\n    }\r\n\r\n    // Rate limiting: Check if a token was created recently (within last 5 minutes)\r\n    const recentToken = await prisma.emailVerificationToken.findFirst({\r\n      where: {\r\n        userId: prismaUser!.id,\r\n        createdAt: {\r\n          gte: new Date(Date.now() - 5 * 60 * 1000), // 5 minutes ago\r\n        },\r\n      },\r\n    });\r\n\r\n    if (recentToken) {\r\n      return NextResponse.json(\r\n        { error: \"Please wait a few minutes before requesting another verification email.\" },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    // Create email verification token\r\n    const rawToken = await createEmailVerificationToken(prismaUser!.id);\r\n\r\n    // Build base URL\r\n    const baseUrl =\r\n      process.env.NEXT_PUBLIC_APP_URL ??\r\n      (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null) ??\r\n      \"http://localhost:3000\";\r\n\r\n    // Build verify URL\r\n    const verifyUrl = `${baseUrl}/verify-email?token=${encodeURIComponent(rawToken)}`;\r\n\r\n    // Build email content\r\n    const emailHtml = `\r\n      <!DOCTYPE html>\r\n      <html>\r\n        <head>\r\n          <meta charset=\"utf-8\">\r\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n          <title>Verify Your Email</title>\r\n        </head>\r\n        <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #1e293b; max-width: 600px; margin: 0 auto; padding: 20px;\">\r\n          <div style=\"background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; text-align: center; border-radius: 8px 8px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">OMNEXORA</h1>\r\n          </div>\r\n          <div style=\"background: white; padding: 30px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px;\">\r\n            <h2 style=\"color: #1e293b; margin-top: 0;\">Verify Your Email</h2>\r\n            <p>Welcome to OMNEXORA! Please verify your email address to unlock all features.</p>\r\n            <p>Click the button below to verify your email. This link will expire in 24 hours.</p>\r\n            <div style=\"text-align: center; margin: 30px 0;\">\r\n              <a href=\"${verifyUrl}\" style=\"display: inline-block; background: #f59e0b; color: #1e293b; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 600;\">Verify Email</a>\r\n            </div>\r\n            <p style=\"font-size: 14px; color: #64748b;\">If the button doesn't work, copy and paste this link into your browser:</p>\r\n            <p style=\"font-size: 12px; color: #64748b; word-break: break-all;\">${verifyUrl}</p>\r\n            <p style=\"font-size: 14px; color: #64748b; margin-top: 30px;\">If you didn't create an account, you can safely ignore this email.</p>\r\n          </div>\r\n        </body>\r\n      </html>\r\n    `;\r\n\r\n    const emailText = `\r\nVerify Your Email\r\n\r\nWelcome to OMNEXORA! Please verify your email address to unlock all features.\r\n\r\nClick the link below to verify your email. This link will expire in 24 hours.\r\n\r\n${verifyUrl}\r\n\r\nIf you didn't create an account, you can safely ignore this email.\r\n    `.trim();\r\n\r\n    // Send email via Resend\r\n    if (resend) {\r\n      try {\r\n        const { error } = await resend.emails.send({\r\n          from: DEFAULT_FROM,\r\n          to: currentUser.email,\r\n          subject: \"Verify your OMNEXORA email\",\r\n          html: emailHtml,\r\n          text: emailText,\r\n        });\r\n\r\n        if (error) {\r\n          console.error(\"Failed to send verification email:\", error);\r\n          // Still return success, but log the error\r\n        } else {\r\n          console.log(`Verification email sent to ${currentUser.email}`);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Error sending verification email:\", err);\r\n        // Still return success, but log the error\r\n      }\r\n    } else {\r\n      console.warn(\"RESEND_API_KEY not set, verification email not sent\");\r\n      console.log(`Would have sent verification email to ${currentUser.email}`);\r\n      console.log(`Verify URL: ${verifyUrl}`);\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { success: true },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Error in send-verification-email endpoint:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to send verification email. Please try again.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\auth\\verify-email\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1561,1564],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1561,1564],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { consumeEmailVerificationToken } from \"@/lib/email-verification\";\r\n\r\n/**\r\n * POST /api/auth/verify-email\r\n * Verifies an email address using a token from the verification link\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { token } = body;\r\n\r\n    if (!token || typeof token !== \"string\") {\r\n      return NextResponse.json(\r\n        { error: \"Verification token is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Consume the token (verifies and deletes it for single-use)\r\n    const verificationToken = await consumeEmailVerificationToken(token);\r\n\r\n    if (!verificationToken) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid or expired link\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Get the user\r\n    const prisma = getPrisma();\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: verificationToken.userId },\r\n    });\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Update user's emailVerifiedAt\r\n    await prisma.user.update({\r\n      where: { id: user.id },\r\n      data: {\r\n        emailVerifiedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    // Also update KV store if user exists there\r\n    try {\r\n      const { kv } = await import(\"@/lib/kv\");\r\n      const kvUser = (await kv.get(`user:email:${user.email.toLowerCase()}`)) as any;\r\n      if (kvUser) {\r\n        kvUser.emailVerifiedAt = new Date().toISOString();\r\n        await kv.set(`user:id:${kvUser.id}`, kvUser);\r\n        await kv.set(`user:email:${user.email.toLowerCase()}`, kvUser);\r\n      }\r\n    } catch (kvError) {\r\n      console.warn(\"Failed to update KV store with emailVerifiedAt (non-critical):\", kvError);\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { success: true },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Error in verify-email endpoint:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to verify email. Please try again.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\client\\jobs\\[id]\\accept\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\client\\jobs\\[id]\\decline\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'declineReason' is assigned a value but never used.","line":55,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":55,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { requireClientUser } from \"@/lib/auth\";\r\nimport { getJobById, saveJob, type ClientStatus } from \"@/lib/jobs\";\r\n\r\n/**\r\n * POST /api/client/jobs/[id]/decline\r\n * Allows a client to decline a job pack\r\n */\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await requireClientUser();\r\n    const { id } = await context.params;\r\n\r\n    // Load the job\r\n    const job = await getJobById(id);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Ensure this job belongs to this client\r\n    const normalizedClientEmail = user.email.toLowerCase().trim();\r\n    const jobClientEmail = job.clientEmail?.toLowerCase().trim();\r\n\r\n    if (jobClientEmail !== normalizedClientEmail) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized to decline this job\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Check current status - only allow decline if status is \"sent\" or \"draft\"\r\n    const currentStatus: ClientStatus = (job.clientStatus || \"draft\") as ClientStatus;\r\n    if (currentStatus === \"declined\") {\r\n      return NextResponse.json(\r\n        { error: \"This job pack has already been declined\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (currentStatus === \"accepted\") {\r\n      return NextResponse.json(\r\n        { error: \"Cannot decline a job pack that has already been accepted\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const declineReason = body.reason?.trim() || null;\r\n\r\n    // Update job status\r\n    const now = new Date().toISOString();\r\n    job.clientStatus = \"declined\";\r\n    job.clientDeclinedAt = now;\r\n    job.clientStatusUpdatedAt = now;\r\n\r\n    // Store decline reason if provided (we can add a field for this if needed)\r\n    // For now, we'll just update the status\r\n\r\n    // Save job\r\n    await saveJob(job);\r\n\r\n    // Optionally update job workflow status to \"cancelled\" if it makes sense\r\n    if (!job.jobStatus || job.jobStatus === \"pending\") {\r\n      job.jobStatus = \"cancelled\";\r\n      await saveJob(job);\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      clientStatus: job.clientStatus,\r\n      clientDeclinedAt: job.clientDeclinedAt,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error declining job pack:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to decline job pack\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\clients\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\clients\\note\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\demo\\reset\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3164,3167],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3164,3167],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { createRequire } from \"module\";\r\n\r\nconst require = createRequire(import.meta.url);\r\nconst bcrypt = require(\"bcryptjs\");\r\n\r\nconst DEMO_PASSWORD = \"demo123\";\r\n\r\nconst DEMO_USERS = [\r\n  {\r\n    email: \"chad.omnexora@outlook.com\",\r\n    role: \"admin\",\r\n    planTier: \"FOUNDER\",\r\n    planStatus: \"ACTIVE\",\r\n    verificationStatus: \"verified\",\r\n    accountStatus: \"ACTIVE\",\r\n  },\r\n  {\r\n    email: \"chadmspencer94@gmail.com\",\r\n    role: \"admin\",\r\n    planTier: \"FOUNDER\",\r\n    planStatus: \"ACTIVE\",\r\n    verificationStatus: \"verified\",\r\n    accountStatus: \"ACTIVE\",\r\n  },\r\n];\r\n\r\n/**\r\n * Reset demo data by re-running demo:seed logic (idempotent)\r\n * Only accessible to superadmins when DEMO_MODE=true\r\n */\r\nexport async function resetDemoData(): Promise<{ success: boolean; message?: string; error?: string }> {\r\n  // Only allow in demo mode\r\n  if (process.env.DEMO_MODE !== \"true\") {\r\n    return {\r\n      success: false,\r\n      error: \"Demo mode is not enabled\",\r\n    };\r\n  }\r\n\r\n  try {\r\n    // Check authentication and authorization\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return {\r\n        success: false,\r\n        error: \"Not authenticated\",\r\n      };\r\n    }\r\n\r\n    // Only superadmins can reset demo data\r\n    if (!isAdmin(user)) {\r\n      return {\r\n        success: false,\r\n        error: \"Not authorized. Only superadmins can reset demo data.\",\r\n      };\r\n    }\r\n\r\n    // Re-run demo seed logic (idempotent)\r\n    const prisma = getPrisma();\r\n    for (const userData of DEMO_USERS) {\r\n      const normalizedEmail = userData.email.toLowerCase().trim();\r\n      \r\n      // Hash password\r\n      const passwordHash = await bcrypt.hash(DEMO_PASSWORD, 12);\r\n\r\n      // Check if user already exists\r\n      const existingUser = await prisma.user.findUnique({\r\n        where: { email: normalizedEmail },\r\n      });\r\n\r\n      // Use upsert for idempotent operation\r\n      await prisma.user.upsert({\r\n        where: { email: normalizedEmail },\r\n        update: {\r\n          role: userData.role,\r\n          planTier: userData.planTier,\r\n          planStatus: userData.planStatus,\r\n          verificationStatus: userData.verificationStatus,\r\n          accountStatus: userData.accountStatus,\r\n          isBanned: false,\r\n          verifiedAt: existingUser?.verifiedAt || new Date(),\r\n          passwordHash, // Update password\r\n        },\r\n        create: {\r\n          email: normalizedEmail,\r\n          passwordHash,\r\n          role: userData.role,\r\n          planTier: userData.planTier,\r\n          planStatus: userData.planStatus,\r\n          verificationStatus: userData.verificationStatus,\r\n          accountStatus: userData.accountStatus,\r\n          isBanned: false,\r\n          verifiedAt: new Date(),\r\n        },\r\n      });\r\n    }\r\n\r\n    // Revalidate relevant pages\r\n    revalidatePath(\"/dashboard\");\r\n    revalidatePath(\"/admin/dashboard\");\r\n    revalidatePath(\"/\");\r\n\r\n    return {\r\n      success: true,\r\n      message: \"Demo data reset successfully\",\r\n    };\r\n  } catch (error: any) {\r\n    console.error(\"[demo/reset] Error resetting demo data:\", error);\r\n    return {\r\n      success: false,\r\n      error: error.message || \"Failed to reset demo data\",\r\n    };\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\dev\\force-verify-me\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PRIMARY_ADMIN_EMAIL' is assigned a value but never used.","line":4,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getCurrentUser, updateUser } from \"@/lib/auth\";\r\n\r\nconst PRIMARY_ADMIN_EMAIL = \"chad.omnexora@outlook.com\";\r\nconst SUPERADMIN_EMAILS = [\r\n  \"chad.omnexora@outlook.com\",\r\n  \"chadmspencer94@gmail.com\",\r\n];\r\n\r\nexport async function POST() {\r\n  // Block this route in production\r\n  if (process.env.NODE_ENV === \"production\") {\r\n    return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n  }\r\n\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const now = new Date().toISOString();\r\n    const isAdminEmail = SUPERADMIN_EMAILS.includes(user.email.toLowerCase());\r\n\r\n    // Update user to verified (and admin if applicable)\r\n    const updatedUser = await updateUser(user.id, {\r\n      verificationStatus: \"verified\",\r\n      verifiedAt: now,\r\n      ...(isAdminEmail && { isAdmin: true }),\r\n    });\r\n\r\n    if (!updatedUser) {\r\n      return NextResponse.json(\r\n        { error: \"Failed to update user\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    console.log(`[DEV] Force-verified user: ${user.email} (isAdmin: ${isAdminEmail})`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Account force-verified\",\r\n      user: {\r\n        id: updatedUser.id,\r\n        email: updatedUser.email,\r\n        verificationStatus: updatedUser.verificationStatus,\r\n        verifiedAt: updatedUser.verifiedAt,\r\n        isAdmin: updatedUser.isAdmin,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[DEV] Force-verify error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\docs\\confirm\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2814,2817],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2814,2817],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Document Confirm API Route\r\n * \r\n * POST /api/docs/confirm\r\n * Sets document status to CONFIRMED (user has reviewed and confirmed content)\r\n * \r\n * Requires DOC_ENGINE_V1 feature flag.\r\n */\r\n\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById } from \"@/lib/jobs\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { featureFlags } from \"@/lib/featureFlags\";\r\nimport type { DocType } from \"@/lib/docEngine/types\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * POST /api/docs/confirm\r\n * Confirm document content (sets status to CONFIRMED)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  if (!featureFlags.DOC_ENGINE_V1) {\r\n    return NextResponse.json(\r\n      { error: \"Document engine V1 is not enabled\" },\r\n      { status: 403 }\r\n    );\r\n  }\r\n\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { jobId, docType } = body;\r\n\r\n    if (!jobId || !docType) {\r\n      return NextResponse.json(\r\n        { error: \"jobId and docType are required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verify job exists and user has access\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Forbidden\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get existing draft\r\n    const prisma = getPrisma();\r\n    const existingDraft = await prisma.documentDraft.findUnique({\r\n      where: {\r\n        jobId_docType: {\r\n          jobId,\r\n          docType: docType as DocType,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!existingDraft) {\r\n      return NextResponse.json(\r\n        { error: \"Document draft not found. Please create a draft first.\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Update to CONFIRMED status\r\n    const draft = await prisma.documentDraft.update({\r\n      where: {\r\n        jobId_docType: {\r\n          jobId,\r\n          docType: docType as DocType,\r\n        },\r\n      },\r\n      data: {\r\n        status: \"CONFIRMED\",\r\n        confirmedAt: new Date(),\r\n        approved: true,\r\n        approvedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      draft: {\r\n        id: draft.id,\r\n        jobId: draft.jobId,\r\n        docType: draft.docType,\r\n        status: draft.status,\r\n        confirmedAt: draft.confirmedAt?.toISOString() ?? null,\r\n        updatedAt: draft.updatedAt.toISOString(),\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"[docs/confirm] POST error:\", error);\r\n    return NextResponse.json(\r\n      { error: error?.message || \"Failed to confirm document\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\docs\\draft\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3203,3206],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3203,3206],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":216,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":216,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5499,5502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5499,5502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Document Draft API Routes\n * \n * GET /api/docs/draft?jobId=...&docType=...\n * POST /api/docs/draft (upsert by jobId+docType)\n * \n * Requires DOC_ENGINE_V1 feature flag.\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\nimport { getJobById } from \"@/lib/jobs\";\nimport { getPrisma } from \"@/lib/prisma\";\nimport { featureFlags } from \"@/lib/featureFlags\";\nimport type { DocType } from \"@/lib/docEngine/types\";\n\nexport const dynamic = \"force-dynamic\";\n\n/**\n * GET /api/docs/draft\n * Get draft for a job + document type\n */\nexport async function GET(request: NextRequest) {\n  if (!featureFlags.DOC_ENGINE_V1) {\n    return NextResponse.json(\n      { error: \"Document engine V1 is not enabled\" },\n      { status: 403 }\n    );\n  }\n\n  try {\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized\" },\n        { status: 401 }\n      );\n    }\n\n    const { searchParams } = new URL(request.url);\n    const jobId = searchParams.get(\"jobId\");\n    const docType = searchParams.get(\"docType\");\n\n    if (!jobId || !docType) {\n      return NextResponse.json(\n        { error: \"jobId and docType are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Verify job exists and user has access\n    const job = await getJobById(jobId);\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden\" },\n        { status: 403 }\n      );\n    }\n\n    // Get draft from database\n    const prisma = getPrisma();\n    const draft = await prisma.documentDraft.findUnique({\n      where: {\n        jobId_docType: {\n          jobId,\n          docType: docType as DocType,\n        },\n      },\n    });\n\n    if (!draft) {\n      return NextResponse.json({\n        success: true,\n        draft: null,\n      });\n    }\n\n    // Parse JSON data\n    let dataJson;\n    try {\n      dataJson = typeof draft.dataJson === \"string\" \n        ? JSON.parse(draft.dataJson) \n        : draft.dataJson;\n    } catch {\n      dataJson = null;\n    }\n\n    // Parse issuer data if present\n    let issuerData = null;\n    if (draft.issuerDataJson) {\n      try {\n        issuerData = typeof draft.issuerDataJson === \"string\"\n          ? JSON.parse(draft.issuerDataJson)\n          : draft.issuerDataJson;\n      } catch {\n        issuerData = null;\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      draft: {\n        id: draft.id,\n        jobId: draft.jobId,\n        docType: draft.docType,\n        data: dataJson,\n        approved: draft.approved ?? false,\n        approvedAt: draft.approvedAt?.toISOString() ?? null,\n        // Lifecycle status fields\n        status: draft.status ?? \"DRAFT\",\n        confirmedAt: draft.confirmedAt?.toISOString() ?? null,\n        issuedAt: draft.issuedAt?.toISOString() ?? null,\n        issuedRecordId: draft.issuedRecordId ?? null,\n        issuer: issuerData,\n        createdAt: draft.createdAt.toISOString(),\n        updatedAt: draft.updatedAt.toISOString(),\n      },\n    });\n  } catch (error: any) {\n    console.error(\"[docs/draft] GET error:\", error);\n    return NextResponse.json(\n      { error: error?.message || \"Failed to fetch draft\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/docs/draft\n * Create or update draft for a job + document type\n */\nexport async function POST(request: NextRequest) {\n  if (!featureFlags.DOC_ENGINE_V1) {\n    return NextResponse.json(\n      { error: \"Document engine V1 is not enabled\" },\n      { status: 403 }\n    );\n  }\n\n  try {\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized\" },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const { jobId, docType, data, approved } = body;\n\n    if (!jobId || !docType || !data) {\n      return NextResponse.json(\n        { error: \"jobId, docType, and data are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Verify job exists and user has access\n    const job = await getJobById(jobId);\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden\" },\n        { status: 403 }\n      );\n    }\n\n    // Upsert draft\n    const prisma = getPrisma();\n    const dataJsonString = typeof data === \"string\" ? data : JSON.stringify(data);\n\n    const draft = await prisma.documentDraft.upsert({\n      where: {\n        jobId_docType: {\n          jobId,\n          docType: docType as DocType,\n        },\n      },\n      create: {\n        jobId,\n        docType: docType as DocType,\n        dataJson: dataJsonString,\n        approved: approved === true,\n        approvedAt: approved === true ? new Date() : null,\n      },\n      update: {\n        dataJson: dataJsonString,\n        approved: approved === true ? true : undefined, // Only update if explicitly set to true\n        approvedAt: approved === true ? new Date() : undefined, // Only update if explicitly set to true\n      },\n    });\n\n    return NextResponse.json({\n      success: true,\n      draft: {\n        id: draft.id,\n        jobId: draft.jobId,\n        docType: draft.docType,\n        updatedAt: draft.updatedAt.toISOString(),\n      },\n    });\n  } catch (error: any) {\n    console.error(\"[docs/draft] POST error:\", error);\n    return NextResponse.json(\n      { error: error?.message || \"Failed to save draft\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\docs\\issue\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5293,5296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5293,5296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Document Issue API Route\r\n * \r\n * POST /api/docs/issue\r\n * Issues document for client export. This:\r\n * - Validates issuer (business profile) has required fields\r\n * - Sets status to ISSUED\r\n * - Generates unique issued record ID\r\n * - Snapshots issuer data for audit trail\r\n * \r\n * Requires DOC_ENGINE_V1 feature flag.\r\n */\r\n\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById } from \"@/lib/jobs\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { featureFlags } from \"@/lib/featureFlags\";\r\nimport type { DocType } from \"@/lib/docEngine/types\";\r\nimport { validateIssuerForDoc, extractIssuerFromUser } from \"@/lib/docEngine/validateIssuer\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * Generate a unique issued record ID\r\n */\r\nfunction generateIssuedRecordId(docType: string): string {\r\n  const prefix = docType.substring(0, 3).toUpperCase();\r\n  const timestamp = Date.now().toString(36).toUpperCase();\r\n  const random = Math.random().toString(36).substring(2, 6).toUpperCase();\r\n  return `${prefix}-${timestamp}-${random}`;\r\n}\r\n\r\n/**\r\n * POST /api/docs/issue\r\n * Issue document for client export\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  if (!featureFlags.DOC_ENGINE_V1) {\r\n    return NextResponse.json(\r\n      { error: \"Document engine V1 is not enabled\" },\r\n      { status: 403 }\r\n    );\r\n  }\r\n\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { jobId, docType, strict = true } = body;\r\n\r\n    if (!jobId || !docType) {\r\n      return NextResponse.json(\r\n        { error: \"jobId and docType are required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verify job exists and user has access\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Forbidden\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n\r\n    // Get existing draft\r\n    const existingDraft = await prisma.documentDraft.findUnique({\r\n      where: {\r\n        jobId_docType: {\r\n          jobId,\r\n          docType: docType as DocType,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!existingDraft) {\r\n      return NextResponse.json(\r\n        { error: \"Document draft not found. Please create a draft first.\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Load full user profile for issuer validation\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n      select: {\r\n        email: true,\r\n        businessName: true,\r\n        tradingName: true,\r\n        abn: true,\r\n        businessAddressLine1: true,\r\n        businessAddressLine2: true,\r\n        businessSuburb: true,\r\n        businessState: true,\r\n        businessPostcode: true,\r\n        businessPhone: true,\r\n        businessLogoUrl: true,\r\n        gstRegistered: true,\r\n        serviceArea: true,\r\n      },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User profile not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Extract and validate issuer profile\r\n    const issuer = extractIssuerFromUser(prismaUser);\r\n    const validation = validateIssuerForDoc(docType as DocType, issuer, strict);\r\n\r\n    if (!validation.canIssue) {\r\n      return NextResponse.json(\r\n        { \r\n          error: \"Cannot issue document due to missing business details\",\r\n          validation: {\r\n            missingRequired: validation.missingRequired,\r\n            missingRecommended: validation.missingRecommended,\r\n            warnings: validation.warnings,\r\n          },\r\n          redirectTo: \"/settings/business-profile\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Generate unique issued record ID\r\n    const issuedRecordId = generateIssuedRecordId(docType);\r\n\r\n    // Update draft to ISSUED status with issuer snapshot\r\n    const draft = await prisma.documentDraft.update({\r\n      where: {\r\n        jobId_docType: {\r\n          jobId,\r\n          docType: docType as DocType,\r\n        },\r\n      },\r\n      data: {\r\n        status: \"ISSUED\",\r\n        issuedAt: new Date(),\r\n        issuedRecordId,\r\n        issuerDataJson: JSON.stringify(issuer),\r\n        // Also mark as approved/confirmed if not already\r\n        approved: true,\r\n        approvedAt: existingDraft.approvedAt || new Date(),\r\n        confirmedAt: existingDraft.confirmedAt || new Date(),\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      draft: {\r\n        id: draft.id,\r\n        jobId: draft.jobId,\r\n        docType: draft.docType,\r\n        status: draft.status,\r\n        issuedAt: draft.issuedAt?.toISOString() ?? null,\r\n        issuedRecordId: draft.issuedRecordId,\r\n        updatedAt: draft.updatedAt.toISOString(),\r\n      },\r\n      issuer,\r\n      validation: {\r\n        missingRecommended: validation.missingRecommended,\r\n        warnings: validation.warnings,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"[docs/issue] POST error:\", error);\r\n    return NextResponse.json(\r\n      { error: error?.message || \"Failed to issue document\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\docs\\prefill\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2106,2109],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2106,2109],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3289,3292],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3289,3292],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4688,4691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4688,4691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Document Prefill API Route\n * \n * POST /api/docs/prefill\n * Generates a pre-filled document model from job data.\n * \n * Requires DOC_ENGINE_V1 feature flag.\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\nimport { getJobById } from \"@/lib/jobs\";\nimport { getPrisma } from \"@/lib/prisma\";\nimport { featureFlags } from \"@/lib/featureFlags\";\nimport { loadTemplate } from \"@/lib/docEngine/loadTemplate\";\nimport { generateRenderModel } from \"@/lib/docEngine/renderModel\";\nimport type { DocType } from \"@/lib/docEngine/types\";\nimport {\n  mapCommon,\n  mapVariation,\n  mapEot,\n  mapInvoice,\n  mapHandover,\n  mapMaintenance,\n} from \"@/lib/docEngine/prefill\";\n\nexport const dynamic = \"force-dynamic\";\n\n/**\n * POST /api/docs/prefill\n * Generate pre-filled document model\n */\nexport async function POST(request: NextRequest) {\n  if (!featureFlags.DOC_ENGINE_V1) {\n    return NextResponse.json(\n      { error: \"Document engine V1 is not enabled\" },\n      { status: 403 }\n    );\n  }\n\n  let docType: string | undefined; // Declare outside try block for use in catch\n  try {\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized\" },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const { jobId, docType: extractedDocType, includeMaterialsMarkup } = body; // Optional flag for including markup\n    docType = extractedDocType; // Assign to outer variable\n\n    if (!jobId || !docType) {\n      return NextResponse.json(\n        { error: \"jobId and docType are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Load job\n    const job = await getJobById(jobId);\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden\" },\n        { status: 403 }\n      );\n    }\n\n    // Ensure job has materials pricing fields for invoice generation\n    const jobWithMaterials: any = {\n      ...job,\n      materialsSubtotal: job.materialsSubtotal ?? null,\n      materialsMarkupTotal: job.materialsMarkupTotal ?? null,\n      materialsTotal: job.materialsTotal ?? null,\n    };\n\n    // Load company data from Prisma\n    const prisma = getPrisma();\n    const prismaUser = await prisma.user.findUnique({\n      where: { email: user.email },\n      select: {\n        businessName: true,\n        abn: true,\n        serviceArea: true,\n        email: true,\n      },\n    });\n\n    const companyData = {\n      legalName: prismaUser?.businessName || user.businessDetails?.businessName || \"\",\n      abn: prismaUser?.abn || user.businessDetails?.abn || \"\",\n      address: prismaUser?.serviceArea || user.businessDetails?.serviceArea || \"\",\n      email: prismaUser?.email || user.email || \"\",\n      phone: \"\",\n    };\n\n    // Load client data (if available)\n    const clientData = {\n      name: job.clientName || \"\",\n      email: job.clientEmail || \"\",\n      phone: \"\",\n      billingAddress: job.address || \"\",\n    };\n\n    // Map common fields\n    const commonData = mapCommon(jobWithMaterials, user, companyData, clientData);\n\n    // Map doc-specific fields\n    let prefillData: any = commonData;\n    \n    // Count existing documents for numbering\n    const existingDocs = await prisma.documentDraft.findMany({\n      where: { jobId },\n      select: { docType: true },\n    });\n    \n    const docTypeCount = existingDocs.filter((d) => d.docType === docType).length;\n\n    switch (docType as DocType) {\n      case \"VARIATION_CHANGE_ORDER\":\n        prefillData = mapVariation(jobWithMaterials, commonData, docTypeCount);\n        break;\n      case \"EXTENSION_OF_TIME\":\n        prefillData = mapEot(jobWithMaterials, commonData, docTypeCount);\n        break;\n      case \"PROGRESS_CLAIM_TAX_INVOICE\":\n        prefillData = mapInvoice(jobWithMaterials, commonData, docTypeCount, includeMaterialsMarkup === true);\n        break;\n      case \"HANDOVER_PRACTICAL_COMPLETION\":\n        prefillData = mapHandover(jobWithMaterials, commonData);\n        break;\n      case \"MAINTENANCE_CARE_GUIDE\":\n        prefillData = mapMaintenance(jobWithMaterials, commonData);\n        break;\n      default:\n        return NextResponse.json(\n          { error: `Unsupported document type: ${docType}` },\n          { status: 400 }\n        );\n    }\n\n    // Load template\n    const template = loadTemplate(docType as DocType);\n\n    // Generate render model\n    const model = generateRenderModel(template, prefillData);\n\n    return NextResponse.json({\n      success: true,\n      model,\n    });\n  } catch (error: any) {\n    console.error(\"[docs/prefill] Error:\", error);\n    \n    // Provide more specific error messages\n    let errorMessage = error?.message || \"Failed to generate document\";\n    const docTypeForError = docType || \"unknown\";\n    \n    if (errorMessage.includes(\"Template not found\")) {\n      errorMessage = `Document template not found for type: ${docTypeForError}. Please contact support.`;\n    } else if (errorMessage.includes(\"Template validation failed\")) {\n      errorMessage = `Document template validation failed. Please contact support.`;\n    } else if (errorMessage.includes(\"Cannot read\") || errorMessage.includes(\"undefined\")) {\n      errorMessage = \"Failed to load document data. Please refresh and try again.\";\n    } else if (errorMessage.includes(\"Prisma\") || errorMessage.includes(\"database\")) {\n      errorMessage = \"Database error. Please try again or contact support.\";\n    }\n    \n    return NextResponse.json(\n      { error: errorMessage },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\docs\\render\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":41,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'swmsText' is defined but never used.","line":303,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":303,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\nimport { requireVerifiedEmail } from \"@/lib/authChecks\";\nimport { getJobById } from \"@/lib/jobs\";\nimport { loadTemplate } from \"@/lib/docEngine/loadTemplate\";\nimport { generateRenderModel } from \"@/lib/docEngine/renderModel\";\nimport { renderModelToPdf } from \"@/lib/docEngine/renderPdf\";\nimport type { DocType, DocumentAudience, IssuerProfile } from \"@/lib/docEngine/types\";\nimport { featureFlags } from \"@/lib/featureFlags\";\nimport { hasDocumentFeatureAccess } from \"@/lib/documentAccess\";\nimport { extractIssuerFromUser, validateIssuerForDoc } from \"@/lib/docEngine/validateIssuer\";\n\n/**\n * POST /api/docs/render\n * \n * Generates a PDF document from a template and job data.\n * Requires DOC_ENGINE_V1 feature flag to be enabled.\n */\nexport async function POST(request: NextRequest) {\n  // Check feature flag\n  if (!featureFlags.DOC_ENGINE_V1) {\n    return NextResponse.json(\n      { error: \"Document engine feature is not enabled\" },\n      { status: 403 }\n    );\n  }\n\n  try {\n    // Authenticate user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Not authenticated\" },\n        { status: 401 }\n      );\n    }\n\n    // Require verified email for document generation\n    try {\n      await requireVerifiedEmail(user);\n    } catch (error) {\n      return NextResponse.json(\n        { error: \"Email verification required. Please verify your email address to generate documents.\" },\n        { status: 403 }\n      );\n    }\n\n    // Parse request body\n    const body = await request.json();\n    const { jobId, docType, recordId, renderModel, audience = \"INTERNAL\" } = body;\n    \n    // Validate audience parameter\n    const validAudiences: DocumentAudience[] = [\"INTERNAL\", \"CLIENT\"];\n    if (!validAudiences.includes(audience)) {\n      return NextResponse.json(\n        { error: `Invalid audience. Must be one of: ${validAudiences.join(\", \")}` },\n        { status: 400 }\n      );\n    }\n\n    if (!jobId || !docType) {\n      return NextResponse.json(\n        { error: \"jobId and docType are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Validate docType\n    const validDocTypes: DocType[] = [\n      \"SWMS\",\n      \"PAYMENT_CLAIM_WA\",\n      \"TOOLBOX_TALK\",\n      \"VARIATION_CHANGE_ORDER\",\n      \"EXTENSION_OF_TIME\",\n      \"PROGRESS_CLAIM_TAX_INVOICE\",\n      \"HANDOVER_PRACTICAL_COMPLETION\",\n      \"MAINTENANCE_CARE_GUIDE\",\n    ];\n    if (!validDocTypes.includes(docType)) {\n      return NextResponse.json(\n        { error: `Invalid docType. Must be one of: ${validDocTypes.join(\", \")}` },\n        { status: 400 }\n      );\n    }\n\n    // Load job\n    const job = await getJobById(jobId);\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n        // Verify user has access to this job\n        if (user.role !== \"admin\" && job.userId !== user.id) {\n          return NextResponse.json(\n            { error: \"Unauthorized\" },\n            { status: 403 }\n          );\n        }\n\n        // Get plan info for access control (for PDF export)\n        let planTier = \"FREE\";\n        let planStatus = \"TRIAL\";\n        try {\n          const { getPrisma } = await import(\"@/lib/prisma\");\n          const prisma = getPrisma();\n          const prismaUser = await prisma.user.findUnique({\n            where: { email: user.email },\n            select: { planTier: true, planStatus: true },\n          });\n          if (prismaUser?.planTier) {\n            planTier = prismaUser.planTier;\n          }\n          if (prismaUser?.planStatus) {\n            planStatus = prismaUser.planStatus;\n          }\n        } catch (error) {\n          console.warn(\"Failed to fetch plan info:\", error);\n        }\n\n        // Check document feature access (for PDF export)\n        if (!hasDocumentFeatureAccess(user, { planTier, planStatus, isAdmin: isAdmin(user) })) {\n          return NextResponse.json(\n            { error: \"A paid plan or pilot program membership is required to download PDFs. Free users can create job packs only.\" },\n            { status: 403 }\n          );\n        }\n\n    // Load draft info and issuer data\n    let isApproved = false;\n    let draftStatus = \"DRAFT\";\n    let issuedRecordId: string | null = null;\n    let issuedAt: string | null = null;\n    let issuerData: IssuerProfile | null = null;\n    \n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\");\n      const prisma = getPrisma();\n      \n      // Load draft with all lifecycle fields\n      const draft = await prisma.documentDraft.findUnique({\n        where: {\n          jobId_docType: {\n            jobId,\n            docType,\n          },\n        },\n        select: { \n          approved: true,\n          status: true,\n          issuedRecordId: true,\n          issuedAt: true,\n          issuerDataJson: true,\n        },\n      });\n      \n      if (draft) {\n        isApproved = draft.approved ?? false;\n        draftStatus = draft.status ?? \"DRAFT\";\n        issuedRecordId = draft.issuedRecordId ?? null;\n        issuedAt = draft.issuedAt?.toISOString() ?? null;\n        \n        // Parse issuer data if available\n        if (draft.issuerDataJson) {\n          try {\n            issuerData = JSON.parse(draft.issuerDataJson);\n          } catch {\n            issuerData = null;\n          }\n        }\n      }\n      \n      // For CLIENT audience, require ISSUED status OR load issuer from user profile\n      if (audience === \"CLIENT\") {\n        if (draftStatus !== \"ISSUED\") {\n          // If not issued, check if we can auto-issue (user has valid issuer profile)\n          const prismaUser = await prisma.user.findUnique({\n            where: { email: user.email },\n            select: {\n              email: true,\n              businessName: true,\n              tradingName: true,\n              abn: true,\n              businessAddressLine1: true,\n              businessAddressLine2: true,\n              businessSuburb: true,\n              businessState: true,\n              businessPostcode: true,\n              businessPhone: true,\n              businessLogoUrl: true,\n              gstRegistered: true,\n              serviceArea: true,\n            },\n          });\n          \n          if (prismaUser) {\n            const extractedIssuer = extractIssuerFromUser(prismaUser);\n            const validation = validateIssuerForDoc(docType as DocType, extractedIssuer, false);\n            \n            if (validation.canIssue) {\n              issuerData = extractedIssuer;\n            } else {\n              return NextResponse.json(\n                { \n                  error: \"Cannot generate client PDF: missing required business details\",\n                  validation: {\n                    missingRequired: validation.missingRequired,\n                    missingRecommended: validation.missingRecommended,\n                  },\n                  redirectTo: \"/settings/business-profile\",\n                },\n                { status: 400 }\n              );\n            }\n          }\n        }\n      }\n    } catch (error) {\n      console.warn(\"[docs/render] Failed to check approval status:\", error);\n    }\n\n    // Use provided renderModel if available (edited version), otherwise generate from template\n    let finalRenderModel;\n    \n    if (renderModel) {\n      // Use the edited render model from the client\n      finalRenderModel = renderModel;\n      // Ensure recordId matches\n      if (recordId) {\n        finalRenderModel.recordId = recordId;\n      }\n    } else {\n      // Generate from template (legacy path)\n      const template = loadTemplate(docType);\n\n      // Prepare job data\n      const jobData = {\n        jobId: job.id,\n        jobTitle: job.title || \"\",\n        tradeType: job.tradeType || \"\",\n        propertyType: job.propertyType || \"\",\n        address: job.address || \"\",\n        clientName: job.clientName || \"\",\n        clientEmail: job.clientEmail || \"\",\n        businessName: \"\", // Will be filled from user profile if available\n        abn: \"\", // Will be filled from user profile if available\n        createdAt: job.createdAt || new Date().toISOString(),\n        notes: job.notes || \"\",\n        // Add any template-specific data from job\n        hazards: job.swmsText ? parseHazardsFromSwms(job.swmsText) : [],\n        paymentItems: [], // Will be populated from job pricing if available\n        attendees: [],\n      };\n\n      // Generate render model\n      finalRenderModel = generateRenderModel(template, jobData);\n\n      // Override record ID if provided\n      if (recordId) {\n        finalRenderModel.recordId = recordId;\n      }\n    }\n\n    // Render to PDF with audience-based options\n    const pdf = renderModelToPdf(finalRenderModel, {\n      approved: isApproved,\n      audience: audience as DocumentAudience,\n      issuer: issuerData,\n      issuedRecordId: issuedRecordId,\n      issuedAt: issuedAt,\n    });\n\n    // Return PDF as blob\n    const blob = pdf.getBlob();\n    const arrayBuffer = await blob.arrayBuffer();\n    const buffer = Buffer.from(arrayBuffer);\n\n    // Use issued record ID for filename if available (for client exports)\n    const filenameId = (audience === \"CLIENT\" && issuedRecordId) \n      ? issuedRecordId \n      : finalRenderModel.recordId;\n\n    return new NextResponse(buffer, {\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"${docType.toLowerCase()}-${filenameId}.pdf\"`,\n      },\n    });\n  } catch (error) {\n    console.error(\"[docs/render] Error generating PDF:\", error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"Failed to generate PDF\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Helper to parse hazards from SWMS text (basic implementation)\n */\nfunction parseHazardsFromSwms(swmsText: string): Array<Record<string, string>> {\n  // This is a basic parser - in production, you'd want more sophisticated parsing\n  // or store hazards in a structured format\n  const hazards: Array<Record<string, string>> = [];\n  \n  // Try to extract hazard information from structured text\n  // For now, return empty array - templates will handle empty state\n  return hazards;\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\feedback\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\health\\db\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\health\\openai\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[518,521],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[518,521],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\nexport async function GET() {\r\n  try {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"OPENAI_API_KEY is missing on server runtime\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const client = new OpenAI({ apiKey });\r\n    await client.models.list();\r\n\r\n    return NextResponse.json({ ok: true });\r\n  } catch (err: any) {\r\n    const message = err?.message ?? \"Unknown error\";\r\n    const status = err?.status ?? 500;\r\n    return NextResponse.json({ ok: false, error: message }, { status });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\job-templates\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2112,2115],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2112,2115],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * PUT /api/job-templates/[id]\r\n * Update an existing job template\r\n */\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Only tradie/business users can update templates\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot update job templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma by email\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n\r\n    // Verify template exists and belongs to user\r\n    const existingTemplate = await prisma.jobTemplate.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!existingTemplate) {\r\n      return NextResponse.json(\r\n        { error: \"Template not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (existingTemplate.userId !== prismaUser.id) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized to update this template\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      title,\r\n      tradeType,\r\n      propertyType,\r\n      addressLine1,\r\n      suburb,\r\n      state,\r\n      postcode,\r\n      notes,\r\n      defaultClientNotes,\r\n      defaultMaterialsNotes,\r\n      includeSwms,\r\n      includeVariationDoc,\r\n      includeEotDoc,\r\n      includeProgressClaim,\r\n      includeHandoverChecklist,\r\n      includeMaintenanceGuide,\r\n    } = body;\r\n\r\n    // Build update data (only include fields that are provided)\r\n    const updateData: any = {};\r\n    if (title !== undefined) updateData.title = title.trim();\r\n    if (tradeType !== undefined) updateData.tradeType = tradeType.trim();\r\n    if (propertyType !== undefined) updateData.propertyType = propertyType.trim();\r\n    if (addressLine1 !== undefined) updateData.addressLine1 = addressLine1?.trim() || null;\r\n    if (suburb !== undefined) updateData.suburb = suburb?.trim() || null;\r\n    if (state !== undefined) updateData.state = state?.trim() || null;\r\n    if (postcode !== undefined) updateData.postcode = postcode?.trim() || null;\r\n    if (notes !== undefined) updateData.notes = notes?.trim() || null;\r\n    if (defaultClientNotes !== undefined) updateData.defaultClientNotes = defaultClientNotes?.trim() || null;\r\n    if (defaultMaterialsNotes !== undefined) updateData.defaultMaterialsNotes = defaultMaterialsNotes?.trim() || null;\r\n    if (includeSwms !== undefined) updateData.includeSwms = includeSwms === true;\r\n    if (includeVariationDoc !== undefined) updateData.includeVariationDoc = includeVariationDoc === true;\r\n    if (includeEotDoc !== undefined) updateData.includeEotDoc = includeEotDoc === true;\r\n    if (includeProgressClaim !== undefined) updateData.includeProgressClaim = includeProgressClaim === true;\r\n    if (includeHandoverChecklist !== undefined) updateData.includeHandoverChecklist = includeHandoverChecklist === true;\r\n    if (includeMaintenanceGuide !== undefined) updateData.includeMaintenanceGuide = includeMaintenanceGuide === true;\r\n\r\n    // Update template\r\n    const template = await prisma.jobTemplate.update({\r\n      where: { id },\r\n      data: updateData,\r\n    });\r\n\r\n    return NextResponse.json({ template });\r\n  } catch (error) {\r\n    console.error(\"Error updating job template:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to update job template\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/job-templates/[id]\r\n * Delete a job template\r\n */\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Only tradie/business users can delete templates\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot delete job templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma by email\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n\r\n    // Verify template exists and belongs to user\r\n    const existingTemplate = await prisma.jobTemplate.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!existingTemplate) {\r\n      return NextResponse.json(\r\n        { error: \"Template not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (existingTemplate.userId !== prismaUser.id) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized to delete this template\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Delete template\r\n    await prisma.jobTemplate.delete({\r\n      where: { id },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Error deleting job template:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to delete job template\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\job-templates\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/job-templates\r\n * List all job templates for the current user\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Only tradie/business users can access templates\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot access job templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma by email\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Fetch templates for this user\r\n    const templates = await prisma.jobTemplate.findMany({\r\n      where: { userId: prismaUser.id },\r\n      orderBy: { updatedAt: \"desc\" },\r\n    });\r\n\r\n    return NextResponse.json({ templates });\r\n  } catch (error) {\r\n    console.error(\"Error fetching job templates:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch job templates\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/job-templates\r\n * Create a new job template\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Only tradie/business users can create templates\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot create job templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma by email\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      title,\r\n      tradeType,\r\n      propertyType,\r\n      addressLine1,\r\n      suburb,\r\n      state,\r\n      postcode,\r\n      notes,\r\n      defaultClientNotes,\r\n      defaultMaterialsNotes,\r\n      includeSwms,\r\n      includeVariationDoc,\r\n      includeEotDoc,\r\n      includeProgressClaim,\r\n      includeHandoverChecklist,\r\n      includeMaintenanceGuide,\r\n    } = body;\r\n\r\n    // Validate required fields\r\n    if (!title || typeof title !== \"string\" || title.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Title is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!tradeType || typeof tradeType !== \"string\" || tradeType.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Trade type is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!propertyType || typeof propertyType !== \"string\" || propertyType.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Property type is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Create template\r\n    const template = await prisma.jobTemplate.create({\r\n      data: {\r\n        userId: prismaUser.id,\r\n        title: title.trim(),\r\n        tradeType: tradeType.trim(),\r\n        propertyType: propertyType.trim(),\r\n        addressLine1: addressLine1?.trim() || null,\r\n        suburb: suburb?.trim() || null,\r\n        state: state?.trim() || null,\r\n        postcode: postcode?.trim() || null,\r\n        notes: notes?.trim() || null,\r\n        defaultClientNotes: defaultClientNotes?.trim() || null,\r\n        defaultMaterialsNotes: defaultMaterialsNotes?.trim() || null,\r\n        includeSwms: includeSwms === true,\r\n        includeVariationDoc: includeVariationDoc === true,\r\n        includeEotDoc: includeEotDoc === true,\r\n        includeProgressClaim: includeProgressClaim === true,\r\n        includeHandoverChecklist: includeHandoverChecklist === true,\r\n        includeMaintenanceGuide: includeMaintenanceGuide === true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ template });\r\n  } catch (error) {\r\n    console.error(\"Error creating job template:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create job template\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\accept\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\attachments\\[attachmentId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\attachments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\client-details\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RouteParams' is defined but never used.","line":6,"column":6,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4224,4227],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4224,4227],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, saveJob } from \"@/lib/jobs\";\r\nimport { isDemoUser } from \"@/lib/demo\";\r\n\r\ntype RouteParams = {\r\n  params: {\r\n    id: string;\r\n  };\r\n};\r\n\r\n/**\r\n * PATCH /api/jobs/[id]/client-details\r\n * Updates client details for a job (manual entry after AI generation)\r\n * Only accessible by non-client users who own the job, or superadmins, or demo users\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n): Promise<NextResponse> {\r\n  try {\r\n    // Check authentication\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Only non-client users can update client details\r\n    if (isClient(currentUser)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot update client details\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Await params (Next.js 16+ requires params to be a Promise)\r\n    const params = await context.params;\r\n    const jobId = params.id;\r\n\r\n    // Get the job\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check if user is a superadmin or demo user\r\n    const isSuperAdmin = isAdmin(currentUser);\r\n    const userIsDemoUser = isDemoUser(currentUser.email);\r\n\r\n    // Verify ownership - superadmins, demo users, or job owners can update\r\n    if (job.userId !== currentUser.id && !isSuperAdmin && !userIsDemoUser) {\r\n      return NextResponse.json(\r\n        { error: \"You don't have permission to edit this job.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Plan check: free users cannot save client details (bypass for superadmins and demo users)\r\n    if (!isSuperAdmin && !userIsDemoUser) {\r\n      const { hasPaidPlan } = await import(\"@/lib/planChecks\");\r\n      \r\n      if (!hasPaidPlan(currentUser)) {\r\n        // Get plan tier from Prisma\r\n        let planTier = \"FREE\";\r\n        try {\r\n          const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\r\n          const prismaUser = await prisma.user.findUnique({\r\n            where: { email: currentUser.email },\r\n            select: { planTier: true },\r\n          });\r\n          if (prismaUser?.planTier) {\r\n            planTier = prismaUser.planTier;\r\n          }\r\n        } catch (error) {\r\n          console.warn(\"Failed to fetch plan tier:\", error);\r\n        }\r\n        \r\n        if (planTier === \"FREE\") {\r\n          return NextResponse.json(\r\n            {\r\n              error: \"A paid membership is required to save client details and send job packs. Please upgrade your plan to continue.\",\r\n              code: \"PAID_PLAN_REQUIRED\"\r\n            },\r\n            { status: 403 }\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const { clientName, clientEmail } = body;\r\n\r\n    // Validate\r\n    if (!clientName || typeof clientName !== \"string\" || clientName.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Client name is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!clientEmail || typeof clientEmail !== \"string\" || clientEmail.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Client email is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Basic email validation\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(clientEmail.trim())) {\r\n      return NextResponse.json(\r\n        { error: \"Please enter a valid email address\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Update job with client details\r\n    job.clientName = clientName.trim();\r\n    job.clientEmail = clientEmail.trim().toLowerCase();\r\n    await saveJob(job);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      job: {\r\n        id: job.id,\r\n        clientName: job.clientName,\r\n        clientEmail: job.clientEmail,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Error updating client details:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\client-status\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\decline\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\delete\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\documents\\[type]\\pdf\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":67,"suggestions":[{"messageId":"suggestPropertyKey","fix":{"range":[424,433],"text":"PropertyKey"},"desc":"Use `PropertyKey` instead, this is more explicit than `keyof any`."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":94,"suggestions":[{"messageId":"suggestPropertyKey","fix":{"range":[451,460],"text":"PropertyKey"},"desc":"Use `PropertyKey` instead, this is more explicit than `keyof any`."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4376,4379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4376,4379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\nimport { getJobById } from \"@/lib/jobs\";\nimport { hasDocumentFeatureAccess } from \"@/lib/documentAccess\";\nimport { PdfDocument } from \"@/lib/pdfGenerator\";\n\ntype DocumentType = \"SWMS\" | \"VARIATION\" | \"EOT\" | \"PROGRESS_CLAIM\" | \"HANDOVER\" | \"MAINTENANCE\";\n\nconst DOCUMENT_FIELDS: Record<DocumentType, { textField: keyof any; confirmedField: keyof any }> = {\n  SWMS: { textField: \"swmsText\", confirmedField: \"swmsConfirmed\" },\n  VARIATION: { textField: \"variationText\", confirmedField: \"variationConfirmed\" },\n  EOT: { textField: \"eotText\", confirmedField: \"eotConfirmed\" },\n  PROGRESS_CLAIM: { textField: \"progressClaimText\", confirmedField: \"progressClaimConfirmed\" },\n  HANDOVER: { textField: \"handoverText\", confirmedField: \"handoverConfirmed\" },\n  MAINTENANCE: { textField: \"maintenanceText\", confirmedField: \"maintenanceConfirmed\" },\n};\n\n/**\n * POST /api/jobs/[id]/documents/[type]/pdf\n * Generate PDF for a document\n */\nexport async function POST(\n  request: NextRequest,\n  context: { params: Promise<{ id: string; type: string }> }\n) {\n  try {\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Not authenticated\" },\n        { status: 401 }\n      );\n    }\n\n    const { id, type } = await context.params;\n    const docType = type.toUpperCase() as DocumentType;\n\n    if (!DOCUMENT_FIELDS[docType]) {\n      return NextResponse.json(\n        { error: \"Invalid document type\" },\n        { status: 400 }\n      );\n    }\n\n    const job = await getJobById(id);\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check permissions\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Not authorized\" },\n        { status: 403 }\n      );\n    }\n\n    // Get plan info and business profile for access control and PDF header\n    let planTier = \"FREE\";\n    let planStatus = \"TRIAL\";\n    let businessProfile: {\n      legalName?: string;\n      tradingName?: string;\n      abn?: string;\n      email?: string;\n      phone?: string;\n      addressLine1?: string;\n      addressLine2?: string;\n      suburb?: string;\n      state?: string;\n      postcode?: string;\n    } | null = null;\n    \n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\");\n      const prisma = getPrisma();\n      const prismaUser = await prisma.user.findUnique({\n        where: { email: user.email },\n        select: { \n          planTier: true, \n          planStatus: true,\n          businessName: true,\n          tradingName: true,\n          abn: true,\n          email: true,\n          businessPhone: true,\n          businessAddressLine1: true,\n          businessAddressLine2: true,\n          businessSuburb: true,\n          businessState: true,\n          businessPostcode: true,\n        },\n      });\n      if (prismaUser?.planTier) {\n        planTier = prismaUser.planTier;\n      }\n      if (prismaUser?.planStatus) {\n        planStatus = prismaUser.planStatus;\n      }\n      if (prismaUser?.businessName) {\n        businessProfile = {\n          legalName: prismaUser.businessName || undefined,\n          tradingName: prismaUser.tradingName || undefined,\n          abn: prismaUser.abn || undefined,\n          email: prismaUser.email || undefined,\n          phone: prismaUser.businessPhone || undefined,\n          addressLine1: prismaUser.businessAddressLine1 || undefined,\n          addressLine2: prismaUser.businessAddressLine2 || undefined,\n          suburb: prismaUser.businessSuburb || undefined,\n          state: prismaUser.businessState || undefined,\n          postcode: prismaUser.businessPostcode || undefined,\n        };\n      }\n    } catch (error) {\n      console.warn(\"Failed to fetch plan info:\", error);\n    }\n\n    // Check document feature access\n    if (!hasDocumentFeatureAccess(user, { planTier, planStatus, isAdmin: isAdmin(user) })) {\n      return NextResponse.json(\n        { error: \"A paid plan or pilot program membership is required to download PDFs. Free users can create job packs only.\" },\n        { status: 403 }\n      );\n    }\n\n    // Get document content from request body or job\n    const body = await request.json().catch(() => ({}));\n    const content = body.content || (job as any)[DOCUMENT_FIELDS[docType].textField];\n\n    if (!content) {\n      return NextResponse.json(\n        { error: \"Document content not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Generate PDF\n    const pdf = new PdfDocument();\n    const docLabel = docType.replace(/_/g, \" \").replace(/\\b\\w/g, (l) => l.toUpperCase());\n\n    // Business Header\n    if (businessProfile?.legalName) {\n      pdf.addBusinessHeader(businessProfile);\n    }\n\n    // Document Title\n    pdf.addTitle(docLabel);\n    pdf.addSeparator();\n\n    // Metadata\n    pdf.addMetadata([\n      { label: \"Job\", value: job.title || \"\" },\n      { label: \"Trade\", value: job.tradeType || \"\" },\n      { label: \"Location\", value: job.address || \"\" },\n      { label: \"Date\", value: new Date().toLocaleDateString(\"en-AU\") },\n    ]);\n\n    // AI Warning (only for internal/no business profile)\n    if (!businessProfile?.legalName) {\n      pdf.addAiWarning();\n    }\n\n    // Document content\n    const sections = content.split(\"\\n\\n\");\n    for (const section of sections) {\n      if (section.trim()) {\n        // Check if it's a heading (starts with # or all caps)\n        if (section.match(/^#+\\s/) || (section.length < 100 && section === section.toUpperCase() && !section.includes(\".\"))) {\n          pdf.addSectionHeading(section.replace(/^#+\\s/, \"\").trim());\n        } else {\n          pdf.addParagraph(section.trim());\n        }\n      }\n    }\n\n    // Footer\n    if (businessProfile?.legalName) {\n      pdf.addIssuedFooter(businessProfile.legalName, `${docType}-${id.slice(0, 8).toUpperCase()}`);\n    } else {\n      pdf.addStandardFooters();\n    }\n\n    // Return PDF\n    const blob = pdf.getBlob();\n    const arrayBuffer = await blob.arrayBuffer();\n    const buffer = Buffer.from(arrayBuffer);\n\n    return new NextResponse(buffer, {\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"${docType.toLowerCase()}-${id.slice(0, 8)}.pdf\"`,\n      },\n    });\n  } catch (error) {\n    console.error(\"Error generating PDF:\", error);\n    return NextResponse.json(\n      { error: \"Failed to generate PDF\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\documents\\[type]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":67,"suggestions":[{"messageId":"suggestPropertyKey","fix":{"range":[334,343],"text":"PropertyKey"},"desc":"Use `PropertyKey` instead, this is more explicit than `keyof any`."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":94,"suggestions":[{"messageId":"suggestPropertyKey","fix":{"range":[361,370],"text":"PropertyKey"},"desc":"Use `PropertyKey` instead, this is more explicit than `keyof any`."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1983,1986],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1983,1986],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2067,2070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2067,2070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":148,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4209,4212],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4209,4212],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":149,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4263,4266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4263,4266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\r\nimport { getJobById, saveJob } from \"@/lib/jobs\";\r\n\r\ntype DocumentType = \"SWMS\" | \"VARIATION\" | \"EOT\" | \"PROGRESS_CLAIM\" | \"HANDOVER\" | \"MAINTENANCE\";\r\n\r\nconst DOCUMENT_FIELDS: Record<DocumentType, { textField: keyof any; confirmedField: keyof any }> = {\r\n  SWMS: { textField: \"swmsText\", confirmedField: \"swmsConfirmed\" },\r\n  VARIATION: { textField: \"variationText\", confirmedField: \"variationConfirmed\" },\r\n  EOT: { textField: \"eotText\", confirmedField: \"eotConfirmed\" },\r\n  PROGRESS_CLAIM: { textField: \"progressClaimText\", confirmedField: \"progressClaimConfirmed\" },\r\n  HANDOVER: { textField: \"handoverText\", confirmedField: \"handoverConfirmed\" },\r\n  MAINTENANCE: { textField: \"maintenanceText\", confirmedField: \"maintenanceConfirmed\" },\r\n};\r\n\r\n/**\r\n * GET /api/jobs/[id]/documents/[type]\r\n * Get document content and confirmation status\r\n */\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string; type: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const { id, type } = await context.params;\r\n    const docType = type.toUpperCase() as DocumentType;\r\n\r\n    if (!DOCUMENT_FIELDS[docType]) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid document type\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const job = await getJobById(id);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check permissions\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const fields = DOCUMENT_FIELDS[docType];\r\n    const content = (job as any)[fields.textField] as string | null | undefined;\r\n    const confirmed = (job as any)[fields.confirmedField] as boolean | null | undefined;\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      content: content || null,\r\n      confirmed: confirmed || false,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching document:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch document\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * PUT /api/jobs/[id]/documents/[type]\r\n * Update document content and confirmation status\r\n */\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string; type: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients from editing documents\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot edit documents\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id, type } = await context.params;\r\n    const docType = type.toUpperCase() as DocumentType;\r\n\r\n    if (!DOCUMENT_FIELDS[docType]) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid document type\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const job = await getJobById(id);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check permissions\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { content, confirmed } = body;\r\n\r\n    if (typeof content !== \"string\") {\r\n      return NextResponse.json(\r\n        { error: \"Content must be a string\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (typeof confirmed !== \"boolean\") {\r\n      return NextResponse.json(\r\n        { error: \"Confirmed must be a boolean\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const fields = DOCUMENT_FIELDS[docType];\r\n    \r\n    // Update job fields\r\n    (job as any)[fields.textField] = content.trim();\r\n    (job as any)[fields.confirmedField] = confirmed;\r\n\r\n    await saveJob(job);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      content: content.trim(),\r\n      confirmed,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating document:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to update document\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\duplicate\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RouteParams' is defined but never used.","line":5,"column":6,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1950,1953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1950,1953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, cloneJobForUser } from \"@/lib/jobs\";\r\n\r\ntype RouteParams = {\r\n  params: {\r\n    id: string;\r\n  };\r\n};\r\n\r\n/**\r\n * POST /api/jobs/[id]/duplicate\r\n * Duplicates a job for the current user\r\n * Only accessible by non-client users (tradie/business/builder/admin)\r\n */\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n): Promise<NextResponse> {\r\n  try {\r\n    // Check authentication\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Only non-client users can duplicate jobs\r\n    if (isClient(currentUser)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot duplicate jobs\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Await params (Next.js 16+ requires params to be a Promise)\r\n    const params = await context.params;\r\n    const jobId = params.id;\r\n\r\n    // Verify the job exists and belongs to the user\r\n    const sourceJob = await getJobById(jobId);\r\n    if (!sourceJob) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Authorization: ensure user owns this job OR is admin (admins can duplicate any job)\r\n    if (sourceJob.userId !== currentUser.id && !isAdmin(currentUser)) {\r\n      return NextResponse.json(\r\n        { error: \"You do not have permission to duplicate this job\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Clone the job\r\n    const clonedJob = await cloneJobForUser({\r\n      jobId,\r\n      userId: currentUser.id,\r\n    });\r\n\r\n    // Return success with the new job ID\r\n    return NextResponse.json({\r\n      success: true,\r\n      jobId: clonedJob.id,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Error duplicating job:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\eot\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saveJob' is defined but never used.","line":3,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5706,5709],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5706,5709],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6508,6511],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6508,6511],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\nimport { getJobById, saveJob } from \"@/lib/jobs\";\nimport { openai, isOpenAIAvailable } from \"@/lib/openai\";\n\n/**\n * POST /api/jobs/[id]/eot\n * Generates an Extension of Time (EOT) notice for the specified job\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to generate documents for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Block clients from generating documents\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. Document generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    // Check if OpenAI is available\n    if (!isOpenAIAvailable()) {\n      return NextResponse.json(\n        { error: \"AI service is not available. Please contact support.\" },\n        { status: 503 }\n      );\n    }\n\n    // Load business profile data if available\n    let businessName = \"\";\n    let abn = \"\";\n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n      const prismaUser = await prisma.user.findUnique({\n        where: { email: user.email },\n        select: {\n          businessName: true,\n          abn: true,\n        },\n      });\n      if (prismaUser) {\n        businessName = prismaUser.businessName || \"\";\n        abn = prismaUser.abn || \"\";\n      }\n    } catch {\n      // Continue without business profile data\n    }\n\n    // Build EOT prompt\n    const systemPrompt = `You are an expert in Australian construction and trades contract administration. Your task is to generate a professional Extension of Time (EOT) notice for a specific job.\n\nThe EOT notice must be structured clearly with the following sections:\n\n1. **Job and Contractor Details**\n   - Job title and reference\n   - Contractor business name and ABN (if available)\n   - Client name and contact details\n   - Property address\n\n2. **Cause of Delay**\n   - Clear description of the cause(s) of delay\n   - Common causes include: weather conditions, client delays, access issues, supplier/material delays, unforeseen site conditions, variations, etc.\n   - Be specific and factual\n\n3. **Period of Extension Requested**\n   - Number of additional days requested\n   - Clear statement of the extension period\n\n4. **Indicative Revised Completion Date**\n   - Calculate and state the revised completion date\n   - Note that this is indicative and subject to confirmation\n   - Reference the original completion date if available\n\n5. **Statement Referencing Fair and Reasonable Adjustment**\n   - Statement that the extension is a fair and reasonable adjustment to the program\n   - Reference to Australian construction industry standards\n   - Professional and courteous tone\n\n6. **Signature Section**\n   - Contractor signature line with name and date\n   - Space for client acknowledgment\n\nFormat the response as clear, structured text with section headings. Use bullet points where appropriate. Make it professional and suitable for Australian residential/commercial construction context.`;\n\n    // Build user prompt with job details\n    const tradeInfo = job.tradeType || \"general trade\";\n    const propertyInfo = job.propertyType || \"property\";\n    const location = job.address || \"Western Australia\";\n    const clientInfo = job.clientName ? `Client: ${job.clientName}${job.clientEmail ? ` (${job.clientEmail})` : \"\"}` : \"Client details not specified\";\n    \n    // Calculate dates (rough estimate)\n    const createdAt = new Date(job.createdAt);\n    const estimatedCompletion = new Date(createdAt);\n    estimatedCompletion.setDate(estimatedCompletion.getDate() + 14); // Rough 2-week estimate\n\n    const userPrompt = `Generate an Extension of Time (EOT) notice for a ${tradeInfo} job.\n\n**Job Title:** ${job.title}\n**Trade Type:** ${tradeInfo}\n**Property Type:** ${propertyInfo}\n**Location:** ${location}\n**${clientInfo}**\n**Job Created:** ${createdAt.toLocaleDateString(\"en-AU\")}\n**Estimated Original Completion:** ${estimatedCompletion.toLocaleDateString(\"en-AU\")}\n${businessName ? `**Contractor Business Name:** ${businessName}` : \"\"}\n${abn ? `**ABN:** ${abn}` : \"\"}\n\nCreate a professional EOT notice that clearly explains the delay cause and requests a reasonable extension. Use Australian construction terminology and formatting.`;\n\n    // Call OpenAI\n    let documentContent = \"\";\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: userPrompt },\n        ],\n        temperature: 0.7,\n        max_tokens: 3000,\n      });\n\n      documentContent = response.choices[0]?.message?.content || \"\";\n\n      if (!documentContent.trim()) {\n        return NextResponse.json(\n          { error: \"Failed to generate EOT notice. No content received from AI service.\" },\n          { status: 500 }\n        );\n      }\n    } catch (openaiError: any) {\n      console.error(\"[eot] OpenAI API error:\", openaiError);\n      if (openaiError?.message?.includes(\"API key\") || openaiError?.code === \"invalid_api_key\") {\n        return NextResponse.json(\n          { error: \"AI service is not available. Please contact support.\" },\n          { status: 503 }\n        );\n      }\n      throw openaiError; // Re-throw to be caught by outer catch\n    }\n\n    // Save document as draft (not confirmed)\n    const { saveJob } = await import(\"@/lib/jobs\");\n    job.eotText = documentContent.trim();\n    job.eotConfirmed = false;\n    await saveJob(job);\n\n    return NextResponse.json(\n      {\n        success: true,\n        title: `Extension of Time Notice ÔÇô ${job.title}`,\n        body: documentContent.trim(),\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"[eot] Error generating EOT:\", error);\n    \n    // If it's already a handled OpenAI error, return it\n    if (error?.message && (error.message.includes(\"AI service\") || error.message.includes(\"API key\"))) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 503 }\n      );\n    }\n    \n    // Generic error fallback\n    return NextResponse.json(\n      { error: error?.message || \"Failed to generate EOT notice. Please try again.\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\generate-swms\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saveJob' is defined but never used.","line":3,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1605,1608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1605,1608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, generateSWMS, saveJob } from \"@/lib/jobs\";\r\n\r\n/**\r\n * POST /api/jobs/[id]/generate-swms\r\n * Generates a SWMS (Safe Work Method Statement) for the specified job\r\n */\r\nexport async function POST(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    // Get current user\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized. Please log in.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Get job ID from params\r\n    const { id } = await params;\r\n    console.log(`[jobs] generate swms for job ${id}`);\r\n    \r\n    const job = await getJobById(id);\r\n\r\n    if (!job) {\r\n      console.error(`[jobs] job ${id} not found for SWMS generation`);\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check if user owns the job or is an admin\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      console.error(`[jobs] user ${user.id} not authorized to generate SWMS for job ${id}`);\r\n      return NextResponse.json(\r\n        { error: \"Forbidden. You don't have permission to generate SWMS for this job.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Generate SWMS\r\n    const updatedJob = await generateSWMS(job, user);\r\n    console.log(`[jobs] successfully generated SWMS for job ${id}`);\r\n\r\n    return NextResponse.json({ job: updatedJob }, { status: 200 });\r\n  } catch (error: any) {\r\n    console.error(\"[jobs] error generating SWMS:\", error);\r\n    const errorMessage = error?.message || \"Failed to generate SWMS. Please try again.\";\r\n    \r\n    // Check if it's an OpenAI API key error\r\n    if (errorMessage.includes(\"API key\") || errorMessage.includes(\"OpenAI\")) {\r\n      return NextResponse.json(\r\n        { error: \"OpenAI API key is not configured. Please contact support.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    \r\n    return NextResponse.json(\r\n      { error: errorMessage },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\handover\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":163,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5657,5660],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5657,5660],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":187,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6429,6432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6429,6432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\nimport { getJobById, saveJob } from \"@/lib/jobs\";\nimport { openai, isOpenAIAvailable } from \"@/lib/openai\";\n\n/**\n * POST /api/jobs/[id]/handover\n * Generates a Handover & Practical Completion checklist for the specified job\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to generate documents for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Block clients from generating documents\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. Document generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    // Check if OpenAI is available\n    if (!isOpenAIAvailable()) {\n      return NextResponse.json(\n        { error: \"AI service is not available. Please contact support.\" },\n        { status: 503 }\n      );\n    }\n\n    // Load business profile data if available\n    let businessName = \"\";\n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n      const prismaUser = await prisma.user.findUnique({\n        where: { email: user.email },\n        select: {\n          businessName: true,\n        },\n      });\n      if (prismaUser) {\n        businessName = prismaUser.businessName || \"\";\n      }\n    } catch {\n      // Continue without business profile data\n    }\n\n    // Build Handover prompt\n    const systemPrompt = `You are an expert in Australian construction and trades project completion and handover procedures. Your task is to generate a professional Handover & Practical Completion checklist for a specific job.\n\nThe Handover document must be structured clearly with the following sections:\n\n1. **Job Details**\n   - Project/job title\n   - Property address\n   - Client name and contact details\n   - Trade type\n\n2. **Statement of Practical Completion**\n   - Clear statement that works are practically complete subject to minor defects\n   - Reference to Australian construction standards\n   - Date of practical completion\n\n3. **Checklist Items**\n   Create a comprehensive checklist relevant to the trade type, including items such as:\n   - All areas completed as per scope\n   - Surfaces cleaned and prepared\n   - Rubbish and materials removed\n   - Client walkthrough completed\n   - Touch-ups completed (if applicable)\n   - Keys/fobs/access returned (if applicable)\n   - Final inspection completed\n   - Any trade-specific completion items\n\n4. **Space for Client Comments**\n   - Section for client to note any defects or concerns\n   - Space for additional notes\n\n5. **Practical Completion Date**\n   - Date field for recording completion date\n\n6. **Signature Lines**\n   - Contractor signature line with name and date\n   - Client signature line with name and date\n   - Space for acknowledgment of practical completion\n\nFormat the response as clear, structured text with section headings. Use checkboxes (ÔÿÉ) for checklist items. Make it professional and suitable for Australian residential/commercial construction context.`;\n\n    // Build user prompt with job details\n    const tradeInfo = job.tradeType || \"general trade\";\n    const propertyInfo = job.propertyType || \"property\";\n    const location = job.address || \"Western Australia\";\n    const clientInfo = job.clientName ? `Client: ${job.clientName}${job.clientEmail ? ` (${job.clientEmail})` : \"\"}` : \"Client details not specified\";\n    const jobScope = job.aiScopeOfWork || job.notes || job.title || \"general tasks for the trade\";\n    \n    // Include inclusions/exclusions if available\n    let inclusionsInfo = \"\";\n    if (job.aiInclusions) {\n      inclusionsInfo = `\\n\\nIncluded items:\\n${job.aiInclusions}`;\n    }\n\n    const userPrompt = `Generate a Handover & Practical Completion checklist for a ${tradeInfo} job.\n\n**Job Title:** ${job.title}\n**Trade Type:** ${tradeInfo}\n**Property Type:** ${propertyInfo}\n**Location:** ${location}\n**${clientInfo}**\n**Scope of Work:** ${jobScope}${inclusionsInfo}\n${businessName ? `**Contractor Business Name:** ${businessName}` : \"\"}\n\nCreate a comprehensive handover checklist that is specific to ${tradeInfo} work. Include all relevant completion items for this trade type. Use Australian construction terminology and formatting.`;\n\n    // Call OpenAI\n    let documentContent = \"\";\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: userPrompt },\n        ],\n        temperature: 0.7,\n        max_tokens: 3000,\n      });\n\n      documentContent = response.choices[0]?.message?.content || \"\";\n\n      if (!documentContent.trim()) {\n        return NextResponse.json(\n          { error: \"Failed to generate Handover checklist. No content received from AI service.\" },\n          { status: 500 }\n        );\n      }\n    } catch (openaiError: any) {\n      console.error(\"[handover] OpenAI API error:\", openaiError);\n      if (openaiError?.message?.includes(\"API key\") || openaiError?.code === \"invalid_api_key\") {\n        return NextResponse.json(\n          { error: \"AI service is not available. Please contact support.\" },\n          { status: 503 }\n        );\n      }\n      throw openaiError; // Re-throw to be caught by outer catch\n    }\n\n    // Save document as draft (not confirmed)\n    job.handoverText = documentContent.trim();\n    job.handoverConfirmed = false;\n    await saveJob(job);\n\n    return NextResponse.json(\n      {\n        success: true,\n        title: `Handover & Practical Completion ÔÇô ${job.title}`,\n        body: documentContent.trim(),\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"[handover] Error generating Handover:\", error);\n    \n    // If it's already a handled OpenAI error, return it\n    if (error?.message && (error.message.includes(\"AI service\") || error.message.includes(\"API key\"))) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 503 }\n      );\n    }\n    \n    // Generic error fallback\n    return NextResponse.json(\n      { error: error?.message || \"Failed to generate Handover checklist. Please try again.\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\maintenance\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":129,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4633,4636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4633,4636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":178,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6310,6313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6310,6313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":202,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7084,7087],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7084,7087],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\nimport { getJobById, saveJob } from \"@/lib/jobs\";\nimport { openai, isOpenAIAvailable } from \"@/lib/openai\";\n\n/**\n * POST /api/jobs/[id]/maintenance\n * Generates a Maintenance & Care Guide for the specified job\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to generate documents for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Block clients from generating documents\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. Document generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    // Check if OpenAI is available\n    if (!isOpenAIAvailable()) {\n      return NextResponse.json(\n        { error: \"AI service is not available. Please contact support.\" },\n        { status: 503 }\n      );\n    }\n\n    // Load business profile data if available\n    let businessName = \"\";\n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n      const prismaUser = await prisma.user.findUnique({\n        where: { email: user.email },\n        select: {\n          businessName: true,\n        },\n      });\n      if (prismaUser) {\n        businessName = prismaUser.businessName || \"\";\n      }\n    } catch {\n      // Continue without business profile data\n    }\n\n    // Build Maintenance Guide prompt\n    const systemPrompt = `You are an expert in Australian construction and trades maintenance and care guidance. Your task is to generate a comprehensive Maintenance & Care Guide for a specific job.\n\nThe Maintenance Guide must be structured clearly with the following sections:\n\n1. **Overview of Works Performed**\n   - Brief summary of what work was completed\n   - Specific details relevant to the trade (e.g., \"Internal repaint of 3x2 with low-sheen walls and semi-gloss trims\")\n   - Materials used (if relevant)\n\n2. **Cleaning and Care**\n   - How to clean the completed work\n   - Recommended cleaning products and methods\n   - What products to avoid (e.g., harsh chemicals, abrasive cleaners)\n   - Frequency of cleaning recommendations\n\n3. **Touch-Up Guidance**\n   - How and when to touch up small marks or scratches\n   - Recommended touch-up products\n   - Step-by-step touch-up instructions\n   - When professional touch-ups may be needed\n\n4. **Recommended Recoat Intervals**\n   - Interior work: typically 5-7 years (or trade-specific guidance)\n   - Exterior work: more frequent intervals based on exposure\n   - Factors affecting recoat timing (weather, usage, exposure)\n\n5. **Moisture/Ventilation/UV Considerations**\n   - Moisture management (if applicable)\n   - Ventilation requirements\n   - UV protection considerations\n   - Climate-specific advice for Australian conditions\n\n6. **Simple Warranty Summary**\n   - What is typically covered (workmanship, materials)\n   - What is not covered (damage from impact, moisture ingress, neglect, etc.)\n   - How to report issues\n   - Keep it simple and non-legal, but clear\n\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it practical, easy to understand, and suitable for Australian residential context. Focus on helping the client maintain their investment.`;\n\n    // Build user prompt with job details\n    const tradeInfo = job.tradeType || \"general trade\";\n    const propertyInfo = job.propertyType || \"property\";\n    const location = job.address || \"Western Australia\";\n    const jobScope = job.aiScopeOfWork || job.notes || job.title || \"general tasks for the trade\";\n    \n    // Include materials info if available\n    let materialsInfo = \"\";\n    if (job.aiMaterials) {\n      try {\n        const materials = JSON.parse(job.aiMaterials);\n        if (Array.isArray(materials)) {\n          materialsInfo = `\\n\\nMaterials used:\\n${materials.map((m: any) => `- ${m.item || m}`).join(\"\\n\")}`;\n        } else {\n          materialsInfo = `\\n\\nMaterials: ${job.aiMaterials}`;\n        }\n      } catch {\n        materialsInfo = `\\n\\nMaterials: ${job.aiMaterials}`;\n      }\n    } else if (job.materialsOverrideText) {\n      materialsInfo = `\\n\\nMaterials: ${job.materialsOverrideText}`;\n    }\n\n    // Include summary if available\n    let summaryInfo = \"\";\n    if (job.aiSummary) {\n      summaryInfo = `\\n\\nWork Summary: ${job.aiSummary}`;\n    }\n\n    const userPrompt = `Generate a Maintenance & Care Guide for a ${tradeInfo} job.\n\n**Job Title:** ${job.title}\n**Trade Type:** ${tradeInfo}\n**Property Type:** ${propertyInfo}\n**Location:** ${location}\n**Scope of Work:** ${jobScope}${summaryInfo}${materialsInfo}\n${businessName ? `**Contractor:** ${businessName}` : \"\"}\n\nCreate a comprehensive maintenance guide that is specific to ${tradeInfo} work. Include practical, easy-to-follow advice for Australian conditions. Focus on helping the client maintain the completed work.`;\n\n    // Call OpenAI\n    let documentContent = \"\";\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: userPrompt },\n        ],\n        temperature: 0.7,\n        max_tokens: 3000,\n      });\n\n      documentContent = response.choices[0]?.message?.content || \"\";\n\n      if (!documentContent.trim()) {\n        return NextResponse.json(\n          { error: \"Failed to generate Maintenance Guide. No content received from AI service.\" },\n          { status: 500 }\n        );\n      }\n    } catch (openaiError: any) {\n      console.error(\"[maintenance] OpenAI API error:\", openaiError);\n      if (openaiError?.message?.includes(\"API key\") || openaiError?.code === \"invalid_api_key\") {\n        return NextResponse.json(\n          { error: \"AI service is not available. Please contact support.\" },\n          { status: 503 }\n        );\n      }\n      throw openaiError; // Re-throw to be caught by outer catch\n    }\n\n    // Save document as draft (not confirmed)\n    job.maintenanceText = documentContent.trim();\n    job.maintenanceConfirmed = false;\n    await saveJob(job);\n\n    return NextResponse.json(\n      {\n        success: true,\n        title: `Maintenance & Care Guide ÔÇô ${job.title}`,\n        body: documentContent.trim(),\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"[maintenance] Error generating Maintenance Guide:\", error);\n    \n    // If it's already a handled OpenAI error, return it\n    if (error?.message && (error.message.includes(\"AI service\") || error.message.includes(\"API key\"))) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 503 }\n      );\n    }\n    \n    // Generic error fallback\n    return NextResponse.json(\n      { error: error?.message || \"Failed to generate Maintenance Guide. Please try again.\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\matches\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\materials\\[materialId]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1440,1443],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1440,1443],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1768,1771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1768,1771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2991,2994],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2991,2994],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5211,5214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5211,5214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":171,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5512,5515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5512,5515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById } from \"@/lib/jobs\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { recalcJobMaterialsTotals } from \"@/lib/materials\";\r\n\r\n/**\r\n * PATCH /api/jobs/[id]/materials/[materialId]\r\n * Update a JobMaterial line item\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string; materialId: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage job materials\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId, materialId } = await context.params;\r\n    const body = await request.json();\r\n\r\n    // Check job ownership\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Check material ownership\r\n    const prisma = getPrisma();\r\n    const existing = await (prisma as any).jobMaterial.findUnique({\r\n      where: { id: materialId },\r\n    });\r\n\r\n    if (!existing || existing.jobId !== jobId || existing.userId !== user.id) {\r\n      return NextResponse.json(\r\n        { error: \"Job material not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Build update data\r\n    const updateData: any = {};\r\n    if (body.name !== undefined) updateData.name = body.name.trim();\r\n    if (body.unitLabel !== undefined) updateData.unitLabel = body.unitLabel.trim();\r\n    if (body.unitCost !== undefined) updateData.unitCost = body.unitCost != null ? body.unitCost : null;\r\n    if (body.quantity !== undefined) updateData.quantity = body.quantity;\r\n    if (body.markupPercent !== undefined) updateData.markupPercent = body.markupPercent != null ? body.markupPercent : null;\r\n    if (body.notes !== undefined) updateData.notes = body.notes?.trim() || null;\r\n\r\n    // Recalculate line total\r\n    const finalUnitCost = updateData.unitCost !== undefined ? (updateData.unitCost || 0) : (existing.unitCost ? Number(existing.unitCost) : 0);\r\n    const finalQuantity = updateData.quantity !== undefined ? updateData.quantity : existing.quantity;\r\n    const finalMarkupPercent = updateData.markupPercent !== undefined ? (updateData.markupPercent || 0) : (existing.markupPercent ? Number(existing.markupPercent) : 0);\r\n\r\n    const baseCost = finalUnitCost * finalQuantity;\r\n    const markupAmount = baseCost * (finalMarkupPercent / 100);\r\n    updateData.lineTotal = baseCost + markupAmount;\r\n\r\n    const jobMaterial = await (prisma as any).jobMaterial.update({\r\n      where: { id: materialId },\r\n      data: updateData,\r\n    });\r\n\r\n    // Recalculate job totals\r\n    const totals = await recalcJobMaterialsTotals(jobId, user.id);\r\n\r\n    return NextResponse.json({\r\n      material: {\r\n        id: jobMaterial.id,\r\n        materialItemId: jobMaterial.materialItemId,\r\n        name: jobMaterial.name,\r\n        unitLabel: jobMaterial.unitLabel,\r\n        unitCost: jobMaterial.unitCost ? Number(jobMaterial.unitCost) : null,\r\n        quantity: jobMaterial.quantity,\r\n        markupPercent: jobMaterial.markupPercent ? Number(jobMaterial.markupPercent) : null,\r\n        notes: jobMaterial.notes,\r\n        lineTotal: jobMaterial.lineTotal ? Number(jobMaterial.lineTotal) : null,\r\n        createdAt: jobMaterial.createdAt.toISOString(),\r\n        updatedAt: jobMaterial.updatedAt.toISOString(),\r\n      },\r\n      totals,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating job material:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to update job material\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/jobs/[id]/materials/[materialId]\r\n * Remove a JobMaterial line item\r\n */\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string; materialId: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage job materials\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId, materialId } = await context.params;\r\n\r\n    // Check job ownership\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Check material ownership\r\n    const prisma = getPrisma();\r\n    const existing = await (prisma as any).jobMaterial.findUnique({\r\n      where: { id: materialId },\r\n    });\r\n\r\n    if (!existing || existing.jobId !== jobId || existing.userId !== user.id) {\r\n      return NextResponse.json(\r\n        { error: \"Job material not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    await (prisma as any).jobMaterial.delete({\r\n      where: { id: materialId },\r\n    });\r\n\r\n    // Recalculate job totals\r\n    const totals = await recalcJobMaterialsTotals(jobId, user.id);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      totals,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error deleting job material:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to delete job material\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\materials\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1707,1710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1707,1710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":157,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4030,4033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4030,4033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":170,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4529,4532],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4529,4532],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById } from \"@/lib/jobs\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { recalcJobMaterialsTotals } from \"@/lib/materials\";\r\n\r\n/**\r\n * GET /api/jobs/[id]/materials\r\n * List JobMaterial line items for a job\r\n */\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot view job materials\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId } = await context.params;\r\n\r\n    // Check job ownership\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const jobMaterials = await prisma.jobMaterial.findMany({\r\n      where: {\r\n        jobId,\r\n        userId: user.id,\r\n      },\r\n      orderBy: { createdAt: \"asc\" },\r\n      include: {\r\n        material: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            category: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      materials: jobMaterials.map((m: any) => ({\r\n        id: m.id,\r\n        materialItemId: m.materialItemId,\r\n        name: m.name,\r\n        unitLabel: m.unitLabel,\r\n        unitCost: m.unitCost ? Number(m.unitCost) : null,\r\n        quantity: m.quantity,\r\n        markupPercent: m.markupPercent ? Number(m.markupPercent) : null,\r\n        notes: m.notes,\r\n        lineTotal: m.lineTotal ? Number(m.lineTotal) : null,\r\n        createdAt: m.createdAt.toISOString(),\r\n        updatedAt: m.updatedAt.toISOString(),\r\n      })),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching job materials:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch job materials\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/jobs/[id]/materials\r\n * Add a new JobMaterial line item\r\n */\r\nexport async function POST(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage job materials\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId } = await context.params;\r\n    const body = await request.json();\r\n\r\n    // Check job ownership\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const {\r\n      materialItemId,\r\n      name,\r\n      unitLabel,\r\n      unitCost,\r\n      quantity,\r\n      markupPercent,\r\n      notes,\r\n    } = body;\r\n\r\n    if (!name || !unitLabel || quantity == null) {\r\n      return NextResponse.json(\r\n        { error: \"Name, unitLabel, and quantity are required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // If materialItemId is provided, optionally fetch defaults\r\n    const prisma = getPrisma();\r\n    let finalUnitCost = unitCost != null ? unitCost : null;\r\n    if (materialItemId && finalUnitCost == null) {\r\n      const materialItem = await (prisma as any).materialItem.findUnique({\r\n        where: { id: materialItemId },\r\n      });\r\n      if (materialItem && materialItem.userId === user.id) {\r\n        finalUnitCost = materialItem.unitCost ? Number(materialItem.unitCost) : null;\r\n      }\r\n    }\r\n\r\n    // Calculate line total\r\n    const baseCost = (finalUnitCost || 0) * (quantity || 0);\r\n    const markupAmount = baseCost * ((markupPercent || 0) / 100);\r\n    const lineTotal = baseCost + markupAmount;\r\n\r\n    const jobMaterial = await (prisma as any).jobMaterial.create({\r\n      data: {\r\n        jobId,\r\n        userId: user.id,\r\n        materialItemId: materialItemId || null,\r\n        name: name.trim(),\r\n        unitLabel: unitLabel.trim(),\r\n        unitCost: finalUnitCost,\r\n        quantity: quantity,\r\n        markupPercent: markupPercent != null ? markupPercent : null,\r\n        notes: notes?.trim() || null,\r\n        lineTotal: lineTotal,\r\n      },\r\n    });\r\n\r\n    // Recalculate job totals\r\n    const totals = await recalcJobMaterialsTotals(jobId, user.id);\r\n\r\n    return NextResponse.json({\r\n      material: {\r\n        id: jobMaterial.id,\r\n        materialItemId: jobMaterial.materialItemId,\r\n        name: jobMaterial.name,\r\n        unitLabel: jobMaterial.unitLabel,\r\n        unitCost: jobMaterial.unitCost ? Number(jobMaterial.unitCost) : null,\r\n        quantity: jobMaterial.quantity,\r\n        markupPercent: jobMaterial.markupPercent ? Number(jobMaterial.markupPercent) : null,\r\n        notes: jobMaterial.notes,\r\n        lineTotal: jobMaterial.lineTotal ? Number(jobMaterial.lineTotal) : null,\r\n        createdAt: jobMaterial.createdAt.toISOString(),\r\n        updatedAt: jobMaterial.updatedAt.toISOString(),\r\n      },\r\n      totals,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error creating job material:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create job material\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\pack-sections\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1402,1405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1402,1405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":69,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2143,2146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2143,2146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, saveJob } from \"@/lib/jobs\";\r\n\r\n/**\r\n * PATCH /api/jobs/[id]/pack-sections\r\n * Updates job pack section fields (e.g. aiScopeOfWork, aiInclusions, aiExclusions, etc.)\r\n */\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function PATCH(\r\n  req: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json({ error: \"Unauthorised\" }, { status: 401 });\r\n    }\r\n\r\n    const { id: jobId } = await params;\r\n    console.log(`[pack-sections] updating job ${jobId} pack sections`);\r\n\r\n    // Load job and check ownership\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json({ error: \"Job not found\" }, { status: 404 });\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n\r\n    // Parse request body to get field updates\r\n    const body = await req.json();\r\n    const allowedFields = [\r\n      \"aiScopeOfWork\",\r\n      \"aiInclusions\",\r\n      \"aiExclusions\",\r\n      \"aiMaterials\",\r\n      \"aiQuote\",\r\n      \"aiClientNotes\",\r\n      \"aiSummary\",\r\n    ];\r\n\r\n    // Validate that only allowed fields are being updated\r\n    const updates: any = {};\r\n    for (const field of allowedFields) {\r\n      if (field in body) {\r\n        // Allow null, empty string, or valid strings\r\n        const value = body[field];\r\n        updates[field] = value === \"\" || value === null ? null : String(value);\r\n      }\r\n    }\r\n\r\n    if (Object.keys(updates).length === 0) {\r\n      return NextResponse.json(\r\n        { error: \"No valid fields to update\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Apply updates to job\r\n    const updatedJob = { ...job, ...updates };\r\n    await saveJob(updatedJob);\r\n\r\n    console.log(`[pack-sections] successfully updated job ${jobId} pack sections`);\r\n    return NextResponse.json({ success: true, job: updatedJob }, { status: 200 });\r\n  } catch (error: any) {\r\n    console.error(\"[pack-sections] error updating pack sections:\", error);\r\n    const errorMessage = error?.message || \"Failed to update pack sections. Please try again.\";\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/jobs/[id]/pack-sections\r\n * Stub route for regenerating / fetching job pack sections.\r\n * Currently returns 501 Not Implemented.\r\n */\r\nexport async function POST(\r\n  req: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  const user = await getCurrentUser();\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorised\" }, { status: 401 });\r\n  }\r\n\r\n  const { id: jobId } = await params;\r\n\r\n  // Basic ownership/admin check\r\n  try {\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json({ error: \"Job not found\" }, { status: 404 });\r\n    }\r\n\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[pack-sections] error checking job\", error);\r\n    return NextResponse.json(\r\n      { error: \"Error checking job ownership\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n\r\n  // Stub response for now\r\n  return NextResponse.json(\r\n    {\r\n      status: \"not_implemented\",\r\n      message:\r\n        \"Pack sections regeneration API is not implemented yet. Use PATCH to update individual sections.\",\r\n    },\r\n    { status: 501 }\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\progress-claim\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6219,6222],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6219,6222],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7004,7007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7004,7007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\nimport { getJobById, saveJob } from \"@/lib/jobs\";\nimport { openai, isOpenAIAvailable } from \"@/lib/openai\";\n\n/**\n * POST /api/jobs/[id]/progress-claim\n * Generates a Progress Claim / Tax Invoice for the specified job\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to generate documents for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Block clients from generating documents\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. Document generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    // Check if OpenAI is available\n    if (!isOpenAIAvailable()) {\n      return NextResponse.json(\n        { error: \"AI service is not available. Please contact support.\" },\n        { status: 503 }\n      );\n    }\n\n    // Load business profile data if available\n    let businessName = \"\";\n    let abn = \"\";\n    let businessAddress = \"\";\n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n      const prismaUser = await prisma.user.findUnique({\n        where: { email: user.email },\n        select: {\n          businessName: true,\n          abn: true,\n          serviceArea: true,\n        },\n      });\n      if (prismaUser) {\n        businessName = prismaUser.businessName || \"\";\n        abn = prismaUser.abn || \"\";\n        businessAddress = prismaUser.serviceArea || \"\";\n      }\n    } catch {\n      // Continue without business profile data\n    }\n\n    // Build Progress Claim prompt\n    const systemPrompt = `You are an expert in Australian construction and trades invoicing and contract administration. Your task is to generate a professional Progress Claim / Tax Invoice document for a specific job.\n\nThe Progress Claim document must be structured clearly with the following sections:\n\n1. **Contractor Details**\n   - Business name\n   - ABN (if available)\n   - Contact details (email, phone if available)\n   - Business address (if available)\n   - Bank details section (use placeholder if not available)\n\n2. **Client Details**\n   - Client name\n   - Client email\n   - Property address\n\n3. **Job Reference**\n   - Job title\n   - Job reference/ID\n   - Invoice/Claim number (e.g., \"Progress Claim 1\" or \"Invoice #001\")\n\n4. **Claim Summary Table (as formatted text)**\n   Create a clear table showing:\n   - Contract / Estimated Value: [amount]\n   - Previous Claims Total: [amount or $0.00]\n   - This Claim Amount: [amount]\n   - Balance to Complete: [amount]\n   - Include GST breakdown if applicable\n\n5. **Payment Terms**\n   - Payment terms (e.g., \"Payment due within 14 days\" or \"7 days EOM\")\n   - Payment method (e.g., \"Bank transfer to account details below\")\n   - Include bank account details section (use placeholders if not available)\n\n6. **Work Description**\n   - Brief description of work completed or progress made\n   - Reference to original scope\n\nFormat the response as clear, structured text with section headings. Use formatted text tables (using dashes, pipes, or spacing) for the claim summary. Make it professional and suitable for Australian tax invoice requirements. Include placeholders clearly marked (e.g., \"[Amount to be confirmed]\") where exact figures are not available.`;\n\n    // Build user prompt with job details\n    const tradeInfo = job.tradeType || \"general trade\";\n    const propertyInfo = job.propertyType || \"property\";\n    const location = job.address || \"Western Australia\";\n    const clientInfo = job.clientName ? `Client: ${job.clientName}${job.clientEmail ? ` (${job.clientEmail})` : \"\"}` : \"Client details not specified\";\n    \n    // Get pricing info if available\n    let pricingInfo = \"\";\n    let estimatedTotal = \"\";\n    if (job.aiQuote) {\n      try {\n        const quote = JSON.parse(job.aiQuote);\n        if (quote.totalEstimate?.totalJobEstimate) {\n          estimatedTotal = quote.totalEstimate.totalJobEstimate;\n          pricingInfo = `\\n\\nOriginal quote estimate: ${estimatedTotal}`;\n        }\n      } catch {\n        // Ignore parse errors\n      }\n    }\n\n    const userPrompt = `Generate a Progress Claim / Tax Invoice for a ${tradeInfo} job.\n\n**Job Title:** ${job.title}\n**Job ID/Reference:** ${job.id.slice(0, 8)}\n**Trade Type:** ${tradeInfo}\n**Property Type:** ${propertyInfo}\n**Location:** ${location}\n**${clientInfo}**\n${pricingInfo}\n${businessName ? `**Contractor Business Name:** ${businessName}` : \"\"}\n${abn ? `**ABN:** ${abn}` : \"\"}\n${businessAddress ? `**Business Address:** ${businessAddress}` : \"\"}\n**Contractor Email:** ${user.email}\n\nCreate a professional Progress Claim / Tax Invoice that includes all required sections. Use placeholders for amounts and bank details if not available. Use Australian tax invoice formatting and terminology.`;\n\n    // Call OpenAI\n    let documentContent = \"\";\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: userPrompt },\n        ],\n        temperature: 0.7,\n        max_tokens: 3000,\n      });\n\n      documentContent = response.choices[0]?.message?.content || \"\";\n\n      if (!documentContent.trim()) {\n        return NextResponse.json(\n          { error: \"Failed to generate Progress Claim. No content received from AI service.\" },\n          { status: 500 }\n        );\n      }\n    } catch (openaiError: any) {\n      console.error(\"[progress-claim] OpenAI API error:\", openaiError);\n      if (openaiError?.message?.includes(\"API key\") || openaiError?.code === \"invalid_api_key\") {\n        return NextResponse.json(\n          { error: \"AI service is not available. Please contact support.\" },\n          { status: 503 }\n        );\n      }\n      throw openaiError; // Re-throw to be caught by outer catch\n    }\n\n    // Save document as draft (not confirmed)\n    job.progressClaimText = documentContent.trim();\n    job.progressClaimConfirmed = false;\n    await saveJob(job);\n\n    return NextResponse.json(\n      {\n        success: true,\n        title: `Progress Claim / Tax Invoice ÔÇô ${job.title}`,\n        body: documentContent.trim(),\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"[progress-claim] Error generating Progress Claim:\", error);\n    \n    // If it's already a handled OpenAI error, return it\n    if (error?.message && (error.message.includes(\"AI service\") || error.message.includes(\"API key\"))) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 503 }\n      );\n    }\n    \n    // Generic error fallback\n    return NextResponse.json(\n      { error: error?.message || \"Failed to generate Progress Claim. Please try again.\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\quote-versions\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1371,1374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1371,1374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1546,1549],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1546,1549],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient } from \"@/lib/auth\";\r\nimport { getJobById } from \"@/lib/jobs\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/jobs/[id]/quote-versions\r\n * Get quote version history for a job\r\n */\r\nexport async function GET(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot view quote history\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n\r\n    // Load job to verify ownership\r\n    const job = await getJobById(id);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Authorization: ensure user owns this job or is admin\r\n    if (job.userId !== user.id && user.role !== \"admin\") {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized to access this job\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Fetch quote versions\r\n    const prisma = getPrisma();\r\n    const versions = await (prisma as any).jobQuoteVersion.findMany({\r\n      where: { jobId: id },\r\n      orderBy: { version: \"desc\" },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      versions: versions.map((v: any) => ({\r\n        id: v.id,\r\n        version: v.version,\r\n        sentAt: v.sentAt.toISOString(),\r\n        quoteExpiryAt: v.quoteExpiryAt ? v.quoteExpiryAt.toISOString() : null,\r\n        totalInclGst: v.totalInclGst != null ? Number(v.totalInclGst) : null,\r\n        summary: v.summary,\r\n        scopeOfWork: v.scopeOfWork,\r\n        inclusions: v.inclusions,\r\n        exclusions: v.exclusions,\r\n        materialsText: v.materialsText,\r\n        clientNotes: v.clientNotes,\r\n      })),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching quote versions:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch quote versions\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\regenerate\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2386,2389],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2386,2389],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\nimport { getJobById, saveJob, generateJobPack } from \"@/lib/jobs\";\n\n/**\n * POST /api/jobs/[id]/regenerate - Regenerate the AI job pack\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // Block clients from regenerating AI job packs\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. AI job pack generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json({ error: \"Job not found\" }, { status: 404 });\n    }\n\n    // Authorization: ensure user owns this job OR is admin (admins can regenerate any job pack)\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    // Don't allow regeneration if AI pack is confirmed\n    if (job.aiReviewStatus === \"confirmed\") {\n      return NextResponse.json(\n        { error: \"Cannot regenerate a confirmed job pack. For major changes, create a new job or duplicate this one.\" },\n        { status: 403 }\n      );\n    }\n\n    // Don't allow regeneration if client has accepted and signed\n    if (job.clientStatus === \"accepted\") {\n      return NextResponse.json(\n        { error: \"This pack has been signed by the client. Create a variation instead of regenerating the original scope.\" },\n        { status: 403 }\n      );\n    }\n\n    // Don't allow regeneration if already generating or initial generation is pending\n    if (job.status === \"generating\" || job.status === \"ai_pending\") {\n      return NextResponse.json(\n        { error: \"Job pack is already being generated\" },\n        { status: 409 }\n      );\n    }\n\n    // Set status to generating\n    job.status = \"generating\";\n    await saveJob(job);\n\n    try {\n      // Generate the new job pack (pass user to load business profile rates)\n      const updatedJob = await generateJobPack(job, user);\n      return NextResponse.json({ job: updatedJob });\n    } catch (error: any) {\n      // If generation fails, mark as failed\n      console.error(\"Error generating job pack:\", error);\n      \n      // Handle specific error types with better messages\n      let errorMessage = \"Failed to generate job pack. Please try again.\";\n      let statusCode = 500;\n      \n      if (error?.message?.includes(\"EMAIL_NOT_VERIFIED\")) {\n        errorMessage = \"Please verify your email address before generating job packs. Check your email for a verification link.\";\n        statusCode = 403;\n      } else if (error?.message) {\n        // Include the actual error message for debugging\n        errorMessage = error.message;\n      }\n      \n      // Mark job as failed\n      try {\n        job.status = \"ai_failed\";\n        await saveJob(job);\n      } catch (saveError) {\n        console.error(\"Error saving failed status:\", saveError);\n      }\n      \n      return NextResponse.json(\n        { error: errorMessage },\n        { status: statusCode }\n      );\n    }\n  } catch (error) {\n    console.error(\"Error in regenerate endpoint:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4396,4399],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4396,4399],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, saveJob } from \"@/lib/jobs\";\r\nimport { isDemoUser } from \"@/lib/demo\";\r\n\r\n/**\r\n * GET /api/jobs/[id]\r\n * Fetch a single job by ID\r\n */\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const { id } = await params;\r\n    const job = await getJobById(id);\r\n\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check ownership - user must own the job or be an admin\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Forbidden\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Don't return deleted jobs (unless admin)\r\n    if (job.isDeleted === true && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({ job });\r\n  } catch (error) {\r\n    console.error(\"Error fetching job:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * PATCH /api/jobs/[id]\r\n * Update client details for a job (clientName, clientEmail only)\r\n * Only accessible by job owner, superadmin, or demo users\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    // Check authentication\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId } = await params;\r\n\r\n    // Get the job\r\n    const job = await getJobById(jobId);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check if user is a superadmin or demo user\r\n    const isSuperAdmin = isAdmin(currentUser);\r\n    const userIsDemoUser = isDemoUser(currentUser.email);\r\n\r\n    // Verify ownership - superadmins, demo users, or job owners can update\r\n    if (job.userId !== currentUser.id && !isSuperAdmin && !userIsDemoUser) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Permission denied\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const { clientName, clientEmail } = body;\r\n\r\n    // Only allow updating clientName and clientEmail\r\n    // Validate and update allowed fields\r\n    const updates: { clientName?: string; clientEmail?: string } = {};\r\n\r\n    if (clientName !== undefined) {\r\n      if (typeof clientName !== \"string\") {\r\n        return NextResponse.json(\r\n          { success: false, error: \"clientName must be a string\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      updates.clientName = clientName.trim() || undefined;\r\n    }\r\n\r\n    if (clientEmail !== undefined) {\r\n      if (typeof clientEmail !== \"string\") {\r\n        return NextResponse.json(\r\n          { success: false, error: \"clientEmail must be a string\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      const trimmedEmail = clientEmail.trim().toLowerCase();\r\n      \r\n      // Basic email validation\r\n      if (trimmedEmail && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(trimmedEmail)) {\r\n        return NextResponse.json(\r\n          { success: false, error: \"Please enter a valid email address\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      \r\n      updates.clientEmail = trimmedEmail || undefined;\r\n    }\r\n\r\n    // Update job with allowed fields only\r\n    if (updates.clientName !== undefined) {\r\n      job.clientName = updates.clientName;\r\n    }\r\n    if (updates.clientEmail !== undefined) {\r\n      job.clientEmail = updates.clientEmail;\r\n    }\r\n\r\n    // Save the updated job\r\n    await saveJob(job);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      job: {\r\n        id: job.id,\r\n        clientName: job.clientName,\r\n        clientEmail: job.clientEmail,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Error updating job:\", error);\r\n    return NextResponse.json(\r\n      { success: false, error: error.message || \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\safety\\[docId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\safety\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":116,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":116,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'businessName' is assigned a value but never used.","line":175,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":175,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":368,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":368,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13371,13374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13371,13374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { requireVerifiedEmail } from \"@/lib/authChecks\";\r\nimport { getJobById } from \"@/lib/jobs\";\r\nimport { getPrisma, getSafeErrorMessage, isPrismaError } from \"@/lib/prisma\";\r\n\r\n// User-friendly error messages for safety document operations\r\nconst SAFETY_ERROR_MESSAGES = {\r\n  load: \"Safety documents aren't available right now. Please try again shortly.\",\r\n  generate: \"Unable to generate safety document right now. Please try again shortly.\",\r\n  save: \"Unable to save safety document right now. Please try again shortly.\",\r\n};\r\n\r\n/**\r\n * GET /api/jobs/[id]/safety\r\n * Get all safety documents for a job\r\n * Auth: tradie/business only, must own the job\r\n */\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized. Please log in.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients from accessing safety documents\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Access denied. Safety documents are internal only.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId } = await params;\r\n    const job = await getJobById(jobId);\r\n\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check if user owns the job or is an admin\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Forbidden. You don't have permission to view safety documents for this job.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get all safety documents for this job\r\n    const prisma = getPrisma();\r\n    let documents;\r\n    try {\r\n      documents = await prisma.jobSafetyDocument.findMany({\r\n        where: { jobId },\r\n        orderBy: { createdAt: \"desc\" },\r\n      });\r\n    } catch (dbError) {\r\n      console.error(\"[safety] Database error fetching documents:\", dbError);\r\n      return NextResponse.json(\r\n        { error: SAFETY_ERROR_MESSAGES.load },\r\n        { status: 503 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({ documents }, { status: 200 });\r\n  } catch (error) {\r\n    console.error(\"Error fetching safety documents:\", error);\r\n    const safeMessage = isPrismaError(error) \r\n      ? SAFETY_ERROR_MESSAGES.load \r\n      : getSafeErrorMessage(error, SAFETY_ERROR_MESSAGES.load);\r\n    return NextResponse.json(\r\n      { error: safeMessage },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/jobs/[id]/safety/generate\r\n * Generate a safety document (SWMS, Risk Assessment, or Toolbox Talk)\r\n * Auth: tradie/business only, must own the job\r\n */\r\nexport async function POST(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized. Please log in.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients from generating safety documents\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Access denied. Safety document generation is available to trades and businesses only.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Require verified email for safety document generation\r\n    try {\r\n      await requireVerifiedEmail(user);\r\n    } catch (error) {\r\n      return NextResponse.json(\r\n        { error: \"Email verification required. Please verify your email address to generate safety documents.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id: jobId } = await params;\r\n    const job = await getJobById(jobId);\r\n\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Check if user owns the job or is an admin\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Forbidden. You don't have permission to generate safety documents for this job.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { type } = body;\r\n\r\n    if (!type || ![\"SWMS\", \"RISK_ASSESSMENT\", \"TOOLBOX_TALK\"].includes(type)) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid document type. Must be SWMS, RISK_ASSESSMENT, or TOOLBOX_TALK\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Load user business profile from Prisma\r\n    let userPrimaryTrade: string | null = null;\r\n    let userTradeTypes: string | null = null;\r\n    let businessName: string | null = null;\r\n    const workTypes: string[] = [];\r\n\r\n    const prisma = getPrisma();\r\n    try {\r\n      const prismaUser = await prisma.user.findUnique({\r\n        where: { email: user.email },\r\n        select: {\r\n          primaryTrade: true,\r\n          tradeTypes: true,\r\n          businessName: true,\r\n          tradingName: true,\r\n          doesResidential: true,\r\n          doesCommercial: true,\r\n          doesStrata: true,\r\n        },\r\n      });\r\n\r\n      if (prismaUser) {\r\n        userPrimaryTrade = prismaUser.primaryTrade || null;\r\n        userTradeTypes = prismaUser.tradeTypes || null;\r\n        businessName = prismaUser.businessName || prismaUser.tradingName || null;\r\n        \r\n        if (prismaUser.doesResidential) workTypes.push(\"residential\");\r\n        if (prismaUser.doesCommercial) workTypes.push(\"commercial\");\r\n        if (prismaUser.doesStrata) workTypes.push(\"strata\");\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"Failed to load Prisma user for safety document:\", error);\r\n    }\r\n\r\n    const tradeType = userPrimaryTrade || job.tradeType;\r\n    const tradeTypes = userTradeTypes ? userTradeTypes.split(\",\").map(t => t.trim()).join(\", \") : null;\r\n    const workTypeContext = workTypes.length > 0 ? workTypes.join(\", \") : (job.propertyType || \"residential\");\r\n\r\n    // Generate content using OpenAI\r\n    const { openai } = await import(\"@/lib/openai\");\r\n\r\n    let systemPrompt = \"\";\r\n    let userPrompt = \"\";\r\n\r\n    if (type === \"SWMS\") {\r\n      systemPrompt = `You are an expert safety consultant specialising in Australian construction and trades work safety compliance. You create comprehensive Safe Work Method Statements (SWMS) that comply with Australian Work Health and Safety (WHS) regulations.\r\n\r\nYour SWMS documents must be:\r\n- Clear, structured, and professional\r\n- Compliant with Australian WHS standards\r\n- Specific to the trade and work type described\r\n- Practical and actionable for tradies on site\r\n- Well-formatted with clear headings and sections\r\n\r\nFormat your response as structured text with clear sections using headings and bullet points.`;\r\n\r\n      userPrompt = `Generate a comprehensive Safe Work Method Statement (SWMS) for this ${tradeType.toLowerCase()} job:\r\n\r\n**Job Title:** ${job.title}\r\n**Trade Type:** ${tradeType}${tradeTypes ? ` (Specialisations: ${tradeTypes})` : \"\"}\r\n**Work Type:** ${workTypeContext}\r\n**Property Type:** ${job.propertyType}\r\n**Location:** ${job.address || \"Western Australia\"}\r\n\r\n${job.aiScopeOfWork ? `**Scope of Work:**\\n${job.aiScopeOfWork}` : \"\"}\r\n\r\n${job.notes ? `**Additional Job Details:**\\n${job.notes}` : \"\"}\r\n\r\nCreate a complete SWMS document with the following sections:\r\n\r\n1. **Scope of Works**\r\n   - Clear description of the work to be performed\r\n   - Location and site details\r\n   - Duration and timing considerations\r\n\r\n2. **Key Hazards**\r\n   - List all identified hazards relevant to this trade and work type\r\n   - Include physical, chemical, environmental, and ergonomic hazards\r\n   - Be specific to the work described\r\n\r\n3. **Risk Controls**\r\n   - For each hazard, specify control measures\r\n   - Include engineering controls, administrative controls, and PPE\r\n   - Reference Australian standards where relevant\r\n\r\n4. **Personal Protective Equipment (PPE) Required**\r\n   - List all required PPE items\r\n   - Specify when and where each item must be worn\r\n   - Include any special requirements\r\n\r\n5. **Step-by-Step Work Process**\r\n   - Detailed sequence of work steps\r\n   - Include safety controls embedded in each step\r\n   - Reference hazards and controls from earlier sections\r\n\r\n6. **Emergency Procedures**\r\n   - First aid procedures\r\n   - Emergency contact information\r\n   - Incident reporting requirements\r\n   - Evacuation procedures if applicable\r\n\r\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it professional and suitable for site use.`;\r\n    } else if (type === \"RISK_ASSESSMENT\") {\r\n      systemPrompt = `You are an expert in Australian workplace health and safety (WHS) risk assessment for the construction and trades industry. You create comprehensive risk assessment documents that comply with Australian WHS standards.\r\n\r\nYour risk assessments must be:\r\n- Clear and structured\r\n- Compliant with Australian WHS standards\r\n- Specific to the trade and work type\r\n- Practical and actionable\r\n- Well-formatted with clear sections\r\n\r\nFormat your response as structured text with clear sections using headings and bullet points.`;\r\n\r\n      userPrompt = `Generate a comprehensive Risk Assessment for this ${tradeType.toLowerCase()} job:\r\n\r\n**Job Title:** ${job.title}\r\n**Trade Type:** ${tradeType}${tradeTypes ? ` (Specialisations: ${tradeTypes})` : \"\"}\r\n**Work Type:** ${workTypeContext}\r\n**Property Type:** ${job.propertyType}\r\n**Location:** ${job.address || \"Western Australia\"}\r\n\r\n${job.aiScopeOfWork ? `**Scope of Work:**\\n${job.aiScopeOfWork}` : \"\"}\r\n\r\n${job.notes ? `**Additional Job Details:**\\n${job.notes}` : \"\"}\r\n\r\nCreate a complete Risk Assessment document with the following sections:\r\n\r\n1. **Hazard Identification**\r\n   - List all potential hazards relevant to this trade and work type\r\n   - Include physical, chemical, environmental, and ergonomic hazards\r\n   - Be specific to the work described\r\n\r\n2. **Risk Rating (Before Controls)**\r\n   - For each hazard, assess the risk level (Low/Medium/High)\r\n   - Consider likelihood and consequence\r\n   - Use standard risk matrix terminology\r\n\r\n3. **Control Measures**\r\n   - For each hazard, specify control measures\r\n   - Include engineering controls, administrative controls, and PPE\r\n   - Reference Australian standards where relevant\r\n\r\n4. **Residual Risk**\r\n   - After controls are applied, reassess the risk level\r\n   - Document the residual risk rating\r\n   - Note any remaining risks that require ongoing monitoring\r\n\r\n5. **Review and Monitoring**\r\n   - Specify when this risk assessment should be reviewed\r\n   - Note any conditions that would trigger an immediate review\r\n\r\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it professional and suitable for site use.`;\r\n    } else if (type === \"TOOLBOX_TALK\") {\r\n      systemPrompt = `You are an expert in Australian workplace health and safety (WHS) for the construction and trades industry. You create comprehensive toolbox talk outlines that help tradies conduct effective safety briefings.\r\n\r\nYour toolbox talks must be:\r\n- Clear and engaging\r\n- Specific to the trade and work type\r\n- Practical and actionable\r\n- Well-formatted with clear sections\r\n- Suitable for on-site briefings\r\n\r\nFormat your response as structured text with clear sections using headings and bullet points.`;\r\n\r\n      userPrompt = `Generate a comprehensive Toolbox Talk outline for this ${tradeType.toLowerCase()} job:\r\n\r\n**Job Title:** ${job.title}\r\n**Trade Type:** ${tradeType}${tradeTypes ? ` (Specialisations: ${tradeTypes})` : \"\"}\r\n**Work Type:** ${workTypeContext}\r\n**Property Type:** ${job.propertyType}\r\n**Location:** ${job.address || \"Western Australia\"}\r\n\r\n${job.aiScopeOfWork ? `**Scope of Work:**\\n${job.aiScopeOfWork}` : \"\"}\r\n\r\n${job.notes ? `**Additional Job Details:**\\n${job.notes}` : \"\"}\r\n\r\nCreate a complete Toolbox Talk outline with the following sections:\r\n\r\n1. **Topic Summary**\r\n   - Brief overview of the work to be discussed\r\n   - Key safety focus areas\r\n\r\n2. **Key Points to Cover**\r\n   - Main safety topics to discuss\r\n   - Specific hazards and controls relevant to this job\r\n   - PPE requirements\r\n   - Emergency procedures\r\n\r\n3. **Attendance Section**\r\n   - Template text for recording attendance\r\n   - Note that signatures will be collected on site\r\n\r\n4. **Discussion Questions**\r\n   - Questions to engage the team\r\n   - Points to confirm understanding\r\n\r\n5. **Action Items**\r\n   - Any specific actions required before work begins\r\n   - Equipment checks or setup requirements\r\n\r\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it professional and suitable for on-site briefings.`;\r\n    }\r\n\r\n    console.log(`[jobs] generating safety document type ${type} for job ${jobId}`);\r\n    \r\n    let completion;\r\n    try {\r\n      completion = await openai.chat.completions.create({\r\n        model: \"gpt-4o-mini\",\r\n        messages: [\r\n          { role: \"system\", content: systemPrompt },\r\n          { role: \"user\", content: userPrompt },\r\n        ],\r\n        temperature: 0.7,\r\n        max_tokens: 2000,\r\n      });\r\n    } catch (openaiError: any) {\r\n      console.error(\"[jobs] OpenAI API error generating safety document:\", openaiError);\r\n      if (openaiError?.message?.includes(\"API key\") || openaiError?.code === \"invalid_api_key\") {\r\n        throw new Error(\"OpenAI API key is not configured. Please contact support.\");\r\n      }\r\n      throw new Error(`Failed to generate safety document: ${openaiError?.message || \"Unknown error\"}`);\r\n    }\r\n\r\n    const content = completion.choices[0]?.message?.content || \"\";\r\n    if (!content) {\r\n      throw new Error(\"Failed to generate safety document content\");\r\n    }\r\n\r\n    // Determine title based on type\r\n    const title = type === \"SWMS\" \r\n      ? \"Safe Work Method Statement (SWMS)\"\r\n      : type === \"RISK_ASSESSMENT\"\r\n      ? \"Risk Assessment\"\r\n      : \"Toolbox Talk Outline\";\r\n\r\n    // Check if document already exists for this job + type and save to database\r\n    let document;\r\n    try {\r\n      const existing = await prisma.jobSafetyDocument.findFirst({\r\n        where: { jobId, type },\r\n      });\r\n\r\n      if (existing) {\r\n        // Update existing document\r\n        document = await prisma.jobSafetyDocument.update({\r\n          where: { id: existing.id },\r\n          data: {\r\n            title,\r\n            content,\r\n            status: \"generated\",\r\n          },\r\n        });\r\n      } else {\r\n        // Create new document\r\n        document = await prisma.jobSafetyDocument.create({\r\n          data: {\r\n            jobId,\r\n            type,\r\n            title,\r\n            content,\r\n            status: \"generated\",\r\n          },\r\n        });\r\n      }\r\n    } catch (dbError) {\r\n      console.error(\"[safety] Database error saving document:\", dbError);\r\n      return NextResponse.json(\r\n        { error: SAFETY_ERROR_MESSAGES.save },\r\n        { status: 503 }\r\n      );\r\n    }\r\n\r\n    console.log(`[jobs] successfully generated safety document ${document.id} for job ${jobId}`);\r\n    return NextResponse.json({ document }, { status: 200 });\r\n  } catch (error: unknown) {\r\n    console.error(\"[jobs] error generating safety document:\", error);\r\n    \r\n    // Check if it's a Prisma/database error - return friendly message\r\n    if (isPrismaError(error)) {\r\n      return NextResponse.json(\r\n        { error: SAFETY_ERROR_MESSAGES.generate },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    \r\n    // Check if it's an OpenAI API key error\r\n    const errorMessage = error instanceof Error ? error.message : \"\";\r\n    if (errorMessage.includes(\"API key\") || errorMessage.includes(\"OpenAI\")) {\r\n      return NextResponse.json(\r\n        { error: \"AI service is not available. Please contact support.\" },\r\n        { status: 503 }\r\n      );\r\n    }\r\n    \r\n    // Return a safe error message (filters out sensitive info)\r\n    return NextResponse.json(\r\n      { error: getSafeErrorMessage(error, SAFETY_ERROR_MESSAGES.generate) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\schedule\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\send-to-client\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2165,2168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2165,2168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":201,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6308,6311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6308,6311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, saveJob } from \"@/lib/jobs\";\r\nimport { sendJobPackEmail, buildJobPackEmailHtml, buildJobPackEmailText } from \"@/lib/email\";\r\nimport { ensureQuoteNumber, getNextQuoteVersion } from \"@/lib/quotes\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\ninterface SendToClientRequestBody {\r\n  clientEmail: string;\r\n  subject?: string;\r\n  message?: string;\r\n}\r\n\r\ninterface TotalEstimateQuote {\r\n  description?: string;\r\n  totalJobEstimate?: string;\r\n}\r\n\r\ninterface ParsedQuote {\r\n  totalEstimate?: TotalEstimateQuote;\r\n}\r\n\r\nexport async function POST(\r\n  request: Request,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params;\r\n\r\n    // Auth check\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Load job\r\n    const job = await getJobById(id);\r\n    if (!job) {\r\n      return NextResponse.json(\r\n        { error: \"Job not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Authorization: ensure user owns this job OR is admin (admins can send any job pack)\r\n    if (job.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized to access this job\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Plan check: free users cannot send job packs to clients\r\n    const { hasPaidPlan } = await import(\"@/lib/planChecks\");\r\n    \r\n    if (!hasPaidPlan(user) && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        {\r\n          error: \"PAID_PLAN_REQUIRED\",\r\n          message: \"A paid membership is required to send job packs to clients. Please upgrade your plan to continue.\",\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Email verification check: require verified email (for paid users)\r\n    if (hasPaidPlan(user) && !isAdmin(user)) {\r\n      try {\r\n        const { requireVerifiedEmail } = await import(\"@/lib/authChecks\");\r\n        await requireVerifiedEmail(user);\r\n      } catch (error: any) {\r\n        if (error.name === \"EmailNotVerifiedError\") {\r\n          return NextResponse.json(\r\n            {\r\n              error: \"EMAIL_NOT_VERIFIED\",\r\n              message: \"Please verify your email before sending job packs to clients.\",\r\n            },\r\n            { status: 403 }\r\n          );\r\n        }\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    // Business verification check: only verified tradies can send emails to clients\r\n    if (user.verificationStatus !== \"verified\") {\r\n      return NextResponse.json(\r\n        { \r\n          error: \"Your business must be verified before you can send job packs to clients. Please complete business verification first.\",\r\n          code: \"VERIFICATION_REQUIRED\"\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Parse request body\r\n    const body = (await request.json()) as SendToClientRequestBody;\r\n    const { clientEmail, subject, message } = body;\r\n\r\n    // Validate client email\r\n    if (!clientEmail || typeof clientEmail !== \"string\" || !clientEmail.trim()) {\r\n      return NextResponse.json(\r\n        { error: \"Client email is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Basic email validation\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(clientEmail.trim())) {\r\n      return NextResponse.json(\r\n        { error: \"Please enter a valid email address\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Generate quote number and version before sending\r\n    const quoteNumber = await ensureQuoteNumber(job.id);\r\n    const nextVersion = await getNextQuoteVersion(job.id);\r\n\r\n    // Determine expiry date (MVP: 30 days from now)\r\n    const expiryDays = 30; // TODO: make configurable per user later\r\n    const quoteExpiryAt = new Date(Date.now() + expiryDays * 24 * 60 * 60 * 1000);\r\n\r\n    // Build email subject (include quote number and version)\r\n    const emailSubject = subject?.trim() || `Job pack for ${job.title} - ${quoteNumber} v${nextVersion}`;\r\n\r\n    // Parse quote to get price range\r\n    let priceRange = \"\";\r\n    if (job.aiQuote) {\r\n      try {\r\n        const quote: ParsedQuote = JSON.parse(job.aiQuote);\r\n        if (quote.totalEstimate?.totalJobEstimate) {\r\n          priceRange = quote.totalEstimate.totalJobEstimate;\r\n        }\r\n      } catch {\r\n        // Ignore parse errors\r\n      }\r\n    }\r\n\r\n    // Format expiry date for email\r\n    const expiryDateFormatted = quoteExpiryAt.toLocaleDateString(\"en-AU\", {\r\n      day: \"numeric\",\r\n      month: \"long\",\r\n      year: \"numeric\",\r\n    });\r\n\r\n    // Common email content options\r\n    const emailContentOptions = {\r\n      clientName: job.clientName,\r\n      title: job.title,\r\n      address: job.address,\r\n      summary: job.aiSummary,\r\n      scopeOfWork: job.aiScopeOfWork,\r\n      inclusions: job.aiInclusions,\r\n      exclusions: job.aiExclusions,\r\n      priceRange,\r\n      clientNotes: job.aiClientNotes,\r\n      aiMaterials: job.aiMaterials,\r\n      materialsOverrideText: job.materialsOverrideText,\r\n      materialsAreRoughEstimate: job.materialsAreRoughEstimate,\r\n      customMessage: message?.trim(),\r\n      quoteNumber,\r\n      quoteVersion: nextVersion,\r\n      quoteExpiryAt: expiryDateFormatted,\r\n    };\r\n\r\n    // Build email HTML content\r\n    const emailHtml = buildJobPackEmailHtml(emailContentOptions);\r\n\r\n    // Build plain-text version\r\n    const emailText = buildJobPackEmailText(emailContentOptions);\r\n\r\n    // Send the email via Resend\r\n    const emailResult = await sendJobPackEmail({\r\n      jobId: id,\r\n      to: clientEmail.trim(),\r\n      subject: emailSubject,\r\n      html: emailHtml,\r\n      text: emailText,\r\n    });\r\n\r\n    // Check if email send failed\r\n    if (!emailResult.success) {\r\n      console.error(`[JOB] Email send FAILED for job ${job.id} to ${clientEmail.trim()}`);\r\n      return NextResponse.json(\r\n        { \r\n          error: \"Email failed to send. Please try again or contact support.\",\r\n          details: emailResult.error,\r\n        },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Create quote version snapshot before updating job\r\n    const prisma = getPrisma();\r\n    try {\r\n      await (prisma as any).jobQuoteVersion.create({\r\n        data: {\r\n          jobId: job.id,\r\n          version: nextVersion,\r\n          sentAt: new Date(),\r\n          quoteExpiryAt,\r\n          labourHoursEstimate: job.labourHoursEstimate,\r\n          labourSubtotal: job.labourSubtotal != null ? job.labourSubtotal : null,\r\n          materialsTotal: job.materialsTotal != null ? job.materialsTotal : null,\r\n          subtotal: job.subtotal != null ? job.subtotal : null,\r\n          gstAmount: job.gstAmount != null ? job.gstAmount : null,\r\n          totalInclGst: job.totalInclGst != null ? job.totalInclGst : null,\r\n          summary: job.aiSummary || null,\r\n          scopeOfWork: job.aiScopeOfWork || null,\r\n          inclusions: job.aiInclusions || null,\r\n          exclusions: job.aiExclusions || null,\r\n          materialsText: job.materialsOverrideText || job.aiMaterials || null,\r\n          clientNotes: job.aiClientNotes || null,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Failed to create quote version snapshot:\", error);\r\n      // Don't fail the send if snapshot creation fails, but log it\r\n    }\r\n\r\n    // Email sent successfully - update job with sent timestamp, quote metadata, and client status\r\n    const now = new Date().toISOString();\r\n    job.sentToClientAt = now;\r\n    job.quoteNumber = quoteNumber;\r\n    job.quoteVersion = nextVersion;\r\n    job.quoteExpiryAt = quoteExpiryAt.toISOString();\r\n    job.quoteLastSentAt = now;\r\n    \r\n    // Only auto-update to \"sent\" if still in \"draft\" status\r\n    // Don't override \"accepted\", \"declined\", etc. on resends\r\n    if (!job.clientStatus || job.clientStatus === \"draft\") {\r\n      job.clientStatus = \"sent\";\r\n      job.clientStatusUpdatedAt = now;\r\n    }\r\n    \r\n    await saveJob(job);\r\n\r\n    // Log the successful send action\r\n    console.log(`[JOB] Job pack SENT for job ${job.id} to ${clientEmail.trim()} by user ${user.email}`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      sentToClientAt: job.sentToClientAt,\r\n      clientStatus: job.clientStatus,\r\n      clientStatusUpdatedAt: job.clientStatusUpdatedAt,\r\n    });\r\n  } catch (error) {\r\n    const errorMessage = error instanceof Error ? error.message : String(error);\r\n    console.error(\"Error sending job pack to client:\", errorMessage);\r\n    console.error(\"Full error:\", error);\r\n    return NextResponse.json(\r\n      { \r\n        error: \"An unexpected error occurred. Please try again.\",\r\n        details: errorMessage,\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\sign-document\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\signature\\[signatureId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\status\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\swms\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":261,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7594,7597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7594,7597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\nimport { getJobById, saveJob } from \"@/lib/jobs\";\nimport { openai } from \"@/lib/openai\";\n\n/**\n * GET /api/jobs/[id]/swms\n * Returns the current SWMS text for a job if it exists\n */\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to view SWMS for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Return SWMS text if it exists\n    return NextResponse.json(\n      { success: true, swmsText: job.swmsText || null },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error(\"Error fetching SWMS:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch SWMS.\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PUT /api/jobs/[id]/swms\n * Updates the SWMS text for a job (manual save)\n */\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to update SWMS for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Parse request body\n    const body = await request.json();\n    const { swmsText } = body;\n\n    if (typeof swmsText !== \"string\") {\n      return NextResponse.json(\n        { error: \"Invalid request. swmsText must be a string.\" },\n        { status: 400 }\n      );\n    }\n\n    // Save SWMS to job\n    job.swmsText = swmsText.trim() || null;\n    await saveJob(job);\n\n    return NextResponse.json(\n      { success: true, swmsText: job.swmsText },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error(\"Error saving SWMS:\", error);\n    return NextResponse.json(\n      { error: \"Failed to save SWMS. Please try again.\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/jobs/[id]/swms\n * Generates a Safe Work Method Statement (SWMS) for the specified job\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to generate SWMS for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Block clients from generating SWMS\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. SWMS generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    // Build SWMS prompt\n    const systemPrompt = `You are an expert in Australian workplace health and safety (WHS) for the construction and trades industry. Your task is to generate a comprehensive Safe Work Method Statement (SWMS) for a specific job.\n\nThe SWMS must be structured clearly with the following sections:\n\n1. **Scope of Work**\n   - Brief description of the job tasks\n   - Location and site details\n   - Duration and timing considerations\n\n2. **Key Hazards**\n   - List all identified hazards relevant to this trade and work type\n   - Include physical, chemical, environmental, and ergonomic hazards\n   - Be specific to the work described\n\n3. **Risk Controls**\n   - For each hazard, specify control measures\n   - Include engineering controls, administrative controls, and PPE\n   - Reference Australian standards where relevant\n\n4. **Personal Protective Equipment (PPE) Required**\n   - List all required PPE items\n   - Specify when and where each item must be worn\n   - Include any special requirements\n\n5. **Tools & Equipment**\n   - List all tools and equipment required\n   - Include any safety requirements for tool use\n   - Note any equipment that requires certification or training\n\n6. **Step-by-Step Work Process**\n   - Detailed sequence of work steps\n   - Include safety controls embedded in each step\n   - Reference hazards and controls from earlier sections\n\n7. **Emergency Procedures**\n   - First aid procedures\n   - Emergency contact information\n   - Incident reporting requirements\n   - Evacuation procedures if applicable\n\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it professional and suitable for site use. Ensure compliance with Australian WHS standards.`;\n\n    // Build user prompt with job details\n    const tradeInfo = job.tradeType || \"general trade\";\n    const propertyInfo = job.propertyType || \"property\";\n    const location = job.address || \"Western Australia\";\n    const jobScope = job.aiScopeOfWork || job.notes || job.title || \"general tasks for the trade\";\n    \n    // Include materials info if available\n    let materialsInfo = \"\";\n    if (job.aiMaterials) {\n      materialsInfo = `\\n\\nMaterials to be used:\\n${job.aiMaterials}`;\n    }\n\n    const userPrompt = `Generate a SWMS for a ${tradeInfo} job.\n\n**Job Title:** ${job.title}\n**Trade Type:** ${tradeInfo}\n**Property Type:** ${propertyInfo}\n**Location:** ${location}\n**Job Description/Scope:** ${jobScope}${materialsInfo}\n\nFocus on common hazards and controls for this type of work in an Australian context. Be specific to the trade type and work described.`;\n\n    // Call OpenAI\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: 0.7,\n      max_tokens: 3000,\n    });\n\n    const swmsContent = response.choices[0]?.message?.content || \"\";\n\n    if (!swmsContent.trim()) {\n      return NextResponse.json(\n        { error: \"Failed to generate SWMS content\" },\n        { status: 500 }\n      );\n    }\n\n    // Save SWMS to job as draft (not confirmed)\n    job.swmsText = swmsContent.trim();\n    job.swmsConfirmed = false;\n    await saveJob(job);\n\n    return NextResponse.json(\n      { success: true, swms: swmsContent.trim() },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"[jobs] error generating SWMS:\", error);\n    const errorMessage = error?.message || \"Failed to generate SWMS. Please try again.\";\n    \n    // Check if it's an OpenAI API key error\n    if (errorMessage.includes(\"API key\") || errorMessage.includes(\"OpenAI\") || error?.code === \"invalid_api_key\") {\n      return NextResponse.json(\n        { error: \"OpenAI API key is not configured. Please contact support.\" },\n        { status: 500 }\n      );\n    }\n    \n    return NextResponse.json(\n      { error: errorMessage },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\[id]\\variation\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":176,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5934,5937],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5934,5937],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":200,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6687,6690],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6687,6690],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { getCurrentUser, isAdmin, isClient } from \"@/lib/auth\";\nimport { getJobById, saveJob } from \"@/lib/jobs\";\nimport { openai, isOpenAIAvailable } from \"@/lib/openai\";\n\n/**\n * POST /api/jobs/[id]/variation\n * Generates a Variation / Change Order document for the specified job\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // Get current user\n    const user = await getCurrentUser();\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    // Get job ID from params\n    const { id } = await params;\n    const job = await getJobById(id);\n\n    if (!job) {\n      return NextResponse.json(\n        { error: \"Job not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Check if user owns the job or is an admin\n    if (job.userId !== user.id && !isAdmin(user)) {\n      return NextResponse.json(\n        { error: \"Forbidden. You don't have permission to generate documents for this job.\" },\n        { status: 403 }\n      );\n    }\n\n    // Block clients from generating documents\n    if (isClient(user)) {\n      return NextResponse.json(\n        { error: \"Clients can only post jobs. Document generation is available to structured trades and businesses.\" },\n        { status: 403 }\n      );\n    }\n\n    // Check if OpenAI is available\n    if (!isOpenAIAvailable()) {\n      return NextResponse.json(\n        { error: \"AI service is not available. Please contact support.\" },\n        { status: 503 }\n      );\n    }\n\n    // Load business profile data if available\n    let businessName = \"\";\n    let abn = \"\";\n    try {\n      const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n      const prismaUser = await prisma.user.findUnique({\n        where: { email: user.email },\n        select: {\n          businessName: true,\n          abn: true,\n        },\n      });\n      if (prismaUser) {\n        businessName = prismaUser.businessName || \"\";\n        abn = prismaUser.abn || \"\";\n      }\n    } catch {\n      // Continue without business profile data\n    }\n\n    // Build Variation prompt\n    const systemPrompt = `You are an expert in Australian construction and trades contract administration. Your task is to generate a professional Variation / Change Order document for a specific job.\n\nThe Variation document must be structured clearly with the following sections:\n\n1. **Job and Contractor Details**\n   - Job title and reference\n   - Contractor business name and ABN (if available)\n   - Client name and contact details\n   - Property address\n\n2. **Reference to Original Quote/Job**\n   - Reference to the original job/quote\n   - Date of original quote\n   - Brief description of original scope\n\n3. **Description of Variation**\n   - Clear description of the change in scope\n   - What is being added, removed, or modified\n   - Specific details of the variation\n\n4. **Reason for Variation**\n   - Explanation of why the variation is required\n   - Client request, site conditions, or other factors\n\n5. **Cost Impact**\n   - Additional cost or credit amount\n   - Breakdown if applicable\n   - GST implications\n   - Use placeholders like \"[Amount to be confirmed]\" if exact figures are not available\n\n6. **Time Impact**\n   - Number of additional days required (if any)\n   - Impact on completion date\n   - Revised completion date if applicable\n\n7. **Signature/Acceptance Section**\n   - Contractor signature line with name and date\n   - Client signature line with name and date\n   - Space for acceptance/rejection\n\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it professional and suitable for Australian residential/commercial construction context.`;\n\n    // Build user prompt with job details\n    const tradeInfo = job.tradeType || \"general trade\";\n    const propertyInfo = job.propertyType || \"property\";\n    const location = job.address || \"Western Australia\";\n    const jobScope = job.aiScopeOfWork || job.notes || job.title || \"general tasks for the trade\";\n    const clientInfo = job.clientName ? `Client: ${job.clientName}${job.clientEmail ? ` (${job.clientEmail})` : \"\"}` : \"Client details not specified\";\n    \n    // Get pricing info if available\n    let pricingInfo = \"\";\n    if (job.aiQuote) {\n      try {\n        const quote = JSON.parse(job.aiQuote);\n        if (quote.totalEstimate?.totalJobEstimate) {\n          pricingInfo = `\\n\\nOriginal quote estimate: ${quote.totalEstimate.totalJobEstimate}`;\n        }\n      } catch {\n        // Ignore parse errors\n      }\n    }\n\n    const userPrompt = `Generate a Variation / Change Order document for a ${tradeInfo} job.\n\n**Job Title:** ${job.title}\n**Trade Type:** ${tradeInfo}\n**Property Type:** ${propertyInfo}\n**Location:** ${location}\n**${clientInfo}**\n**Original Job Description/Scope:** ${jobScope}${pricingInfo}\n${businessName ? `**Contractor Business Name:** ${businessName}` : \"\"}\n${abn ? `**ABN:** ${abn}` : \"\"}\n\nCreate a professional Variation document that clearly outlines the change in scope, cost impact, and time implications. Use Australian construction terminology and formatting.`;\n\n    // Call OpenAI\n    let documentContent = \"\";\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: userPrompt },\n        ],\n        temperature: 0.7,\n        max_tokens: 3000,\n      });\n\n      documentContent = response.choices[0]?.message?.content || \"\";\n\n      if (!documentContent.trim()) {\n        return NextResponse.json(\n          { error: \"Failed to generate Variation document. No content received from AI service.\" },\n          { status: 500 }\n        );\n      }\n    } catch (openaiError: any) {\n      console.error(\"[variation] OpenAI API error:\", openaiError);\n      if (openaiError?.message?.includes(\"API key\") || openaiError?.code === \"invalid_api_key\") {\n        return NextResponse.json(\n          { error: \"AI service is not available. Please contact support.\" },\n          { status: 503 }\n        );\n      }\n      throw openaiError; // Re-throw to be caught by outer catch\n    }\n\n    // Save document as draft (not confirmed)\n    job.variationText = documentContent.trim();\n    job.variationConfirmed = false;\n    await saveJob(job);\n\n    return NextResponse.json(\n      {\n        success: true,\n        title: `Variation ÔÇô ${job.title}`,\n        body: documentContent.trim(),\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"[variation] Error generating Variation:\", error);\n    \n    // If it's already a handled OpenAI error, return it\n    if (error?.message && (error.message.includes(\"AI service\") || error.message.includes(\"API key\"))) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 503 }\n      );\n    }\n    \n    // Generic error fallback\n    return NextResponse.json(\n      { error: error?.message || \"Failed to generate Variation document. Please try again.\" },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\jobs\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5962,5965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5962,5965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":191,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7021,7024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7021,7024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":218,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":218,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":309,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11577,11580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11577,11580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":347,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":347,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12990,12993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12990,12993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getCurrentUser, incrementUserJobCount, getRealUserFromSession, isImpersonating, SESSION_COOKIE_NAME, isClient } from \"@/lib/auth\";\r\nimport { cookies } from \"next/headers\";\r\nimport { createAuditLog } from \"@/lib/audit\";\r\nimport { createEmptyJob, generateJobPack, saveJob, type CreateJobData, type TradeType } from \"@/lib/jobs\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\nexport async function POST(request: Request) {\r\n  let jobId: string | null = null;\r\n\r\n  try {\r\n    console.log(\"[jobs] creating new job\");\r\n    // Check authentication\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized. Please log in.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const { \r\n      title, \r\n      tradeType, \r\n      propertyType, \r\n      address, \r\n      notes, \r\n      clientName, \r\n      clientEmail,\r\n      labourRatePerHour,\r\n      helperRatePerHour, // Legacy - kept for backwards compatibility\r\n      helpers, // New: array of helpers\r\n      materialsAreRoughEstimate,\r\n      rateTemplateId,\r\n    } = body;\r\n\r\n    // Validate required fields\r\n    if (!title || typeof title !== \"string\" || title.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Title is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!propertyType || typeof propertyType !== \"string\" || propertyType.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"Property type is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Check if user is a client - clients don't need to provide client details\r\n    const userIsClient = isClient(user);\r\n\r\n    // Gate client job posting - require email verification\r\n    const prisma = getPrisma();\r\n    if (userIsClient) {\r\n      const prismaUser = await prisma.user.findUnique({\r\n        where: { email: user.email },\r\n        select: { emailVerifiedAt: true },\r\n      });\r\n\r\n      if (!prismaUser?.emailVerifiedAt) {\r\n        return NextResponse.json(\r\n          { error: \"Please verify your email before posting a job.\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Client details are NOT required at job creation for privacy/safety\r\n    // They will be entered manually after AI generation\r\n    // Only validate if provided (for backwards compatibility with existing jobs)\r\n    if (clientEmail && typeof clientEmail === \"string\" && clientEmail.trim() !== \"\") {\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      if (!emailRegex.test(clientEmail.trim())) {\r\n        return NextResponse.json(\r\n          { error: \"Please enter a valid email address\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Validate trade type (if provided, must be valid; defaults to \"Painter\" if not provided)\r\n    const validTradeTypes: TradeType[] = [\"Painter\", \"Plasterer\", \"Carpenter\", \"Electrician\", \"Other\"];\r\n    if (tradeType !== undefined && !validTradeTypes.includes(tradeType)) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid trade type. Must be one of: Painter, Plasterer, Carpenter, Electrician, Other\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    const normalizedTradeType: TradeType = tradeType && validTradeTypes.includes(tradeType) \r\n      ? tradeType \r\n      : \"Painter\";\r\n\r\n    // Parse and validate optional pricing fields (only relevant for tradies)\r\n    const parsedLabourRate = !userIsClient && labourRatePerHour !== undefined && labourRatePerHour !== null && labourRatePerHour !== \"\"\r\n      ? Number(labourRatePerHour)\r\n      : null;\r\n    const parsedHelperRate = !userIsClient && helperRatePerHour !== undefined && helperRatePerHour !== null && helperRatePerHour !== \"\"\r\n      ? Number(helperRatePerHour)\r\n      : null;\r\n\r\n    // Validate rates are positive numbers if provided (only for tradies)\r\n    if (!userIsClient) {\r\n      if (parsedLabourRate !== null && (isNaN(parsedLabourRate) || parsedLabourRate <= 0)) {\r\n        return NextResponse.json(\r\n          { error: \"Labour rate must be a positive number\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      if (parsedHelperRate !== null && (isNaN(parsedHelperRate) || parsedHelperRate <= 0)) {\r\n        return NextResponse.json(\r\n          { error: \"Helper rate must be a positive number\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      // Validate helpers array if provided\r\n      if (helpers !== undefined && helpers !== null) {\r\n        if (!Array.isArray(helpers)) {\r\n          return NextResponse.json(\r\n            { error: \"Helpers must be an array\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n        for (const helper of helpers) {\r\n          if (!helper.id || typeof helper.id !== \"string\") {\r\n            return NextResponse.json(\r\n              { error: \"Each helper must have a valid id\" },\r\n              { status: 400 }\r\n            );\r\n          }\r\n          if (!helper.ratePerHour || typeof helper.ratePerHour !== \"number\" || helper.ratePerHour <= 0) {\r\n            return NextResponse.json(\r\n              { error: \"Each helper must have a positive rate per hour\" },\r\n              { status: 400 }\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // For clients, use their own email/name\r\n    // For tradies, client details are optional at creation (will be entered manually after AI generation)\r\n    const finalClientName = userIsClient \r\n      ? (user.email.split(\"@\")[0] || \"Client\") \r\n      : (clientName?.trim() || \"\");\r\n    const finalClientEmail = userIsClient \r\n      ? user.email \r\n      : (clientEmail?.trim().toLowerCase() || \"\");\r\n\r\n    // Auto-select default rate template if none provided and user is not a client\r\n    let finalRateTemplateId = rateTemplateId || null;\r\n    if (!userIsClient && !finalRateTemplateId) {\r\n      try {\r\n        const defaultTemplate = await (prisma as any).rateTemplate.findFirst({\r\n          where: {\r\n            userId: user.id,\r\n            isDefault: true,\r\n            AND: [\r\n              {\r\n                OR: [\r\n                  { tradeType: null },\r\n                  { tradeType: normalizedTradeType },\r\n                ],\r\n              },\r\n              {\r\n                OR: [\r\n                  { propertyType: null },\r\n                  { propertyType: propertyType.trim() },\r\n                ],\r\n              },\r\n            ],\r\n          },\r\n        });\r\n        if (defaultTemplate) {\r\n          finalRateTemplateId = defaultTemplate.id;\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Failed to auto-select default rate template:\", error);\r\n      }\r\n    }\r\n\r\n    // If rate template is selected, optionally pre-fill job rates from template\r\n    let finalLabourRate = parsedLabourRate;\r\n    let finalHelperRate = parsedHelperRate;\r\n    if (!userIsClient && finalRateTemplateId && !finalLabourRate && !finalHelperRate) {\r\n      try {\r\n        const template = await (prisma as any).rateTemplate.findUnique({\r\n          where: { id: finalRateTemplateId },\r\n        });\r\n        if (template) {\r\n          // Pre-fill rates from template (user can still override)\r\n          if (template.hourlyRate != null) {\r\n            finalLabourRate = template.hourlyRate;\r\n          }\r\n          if (template.helperHourlyRate != null) {\r\n            finalHelperRate = template.helperHourlyRate;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Failed to load rate template for pre-fill:\", error);\r\n      }\r\n    }\r\n\r\n    // If no hourly rate provided and no rate template, use user's default hourlyRate from business settings\r\n    if (!userIsClient && !finalLabourRate) {\r\n      try {\r\n        const prismaUser = await prisma.user.findUnique({\r\n          where: { email: user.email },\r\n          select: { hourlyRate: true },\r\n        });\r\n        if (prismaUser?.hourlyRate != null) {\r\n          finalLabourRate = prismaUser.hourlyRate;\r\n        }\r\n      } catch (error) {\r\n        // Silently fail - don't break job creation if business settings can't be loaded\r\n      }\r\n    }\r\n\r\n    // Prepare job data\r\n    const jobData: CreateJobData = {\r\n      title: title.trim(),\r\n      tradeType: normalizedTradeType,\r\n      propertyType: propertyType.trim(),\r\n      address: address?.trim() || undefined,\r\n      notes: notes?.trim() || undefined,\r\n      clientName: finalClientName,\r\n      clientEmail: finalClientEmail,\r\n      labourRatePerHour: finalLabourRate,\r\n      helperRatePerHour: finalHelperRate, // Legacy\r\n      helpers: helpers && Array.isArray(helpers) && helpers.length > 0 ? helpers : undefined, // New: array of helpers\r\n      materialsAreRoughEstimate: materialsAreRoughEstimate === true,\r\n      rateTemplateId: finalRateTemplateId,\r\n    };\r\n\r\n    // Get real admin if impersonating (for audit logging)\r\n    const cookieStore = await cookies();\r\n    const sessionId = cookieStore.get(SESSION_COOKIE_NAME)?.value;\r\n    const impersonating = sessionId ? await isImpersonating() : false;\r\n    const realAdmin = impersonating && sessionId ? await getRealUserFromSession(sessionId) : null;\r\n\r\n    // Create the job\r\n    const job = await createEmptyJob(user.id, jobData);\r\n    jobId = job.id;\r\n\r\n    // Set assignment metadata for client jobs\r\n    let updatedJob = job;\r\n    if (userIsClient) {\r\n      updatedJob.leadSource = \"CLIENT_PORTAL\";\r\n      updatedJob.clientUserId = user.id;\r\n      updatedJob.assignmentStatus = \"UNASSIGNED\";\r\n      updatedJob.status = \"draft\"; // No AI generation for client posts\r\n      await saveJob(updatedJob);\r\n    } else {\r\n      // For tradie-created jobs, set leadSource to MANUAL\r\n      updatedJob.leadSource = \"MANUAL\";\r\n      \r\n      // Link to Client CRM if client details are provided\r\n      if (finalClientName && finalClientEmail) {\r\n        try {\r\n          const { findOrCreateClientForJob } = await import(\"@/lib/clientCrm\");\r\n          // Extract suburb from address if available\r\n          const suburb = address ? extractSuburbFromAddress(address) : undefined;\r\n          \r\n          const { clientId } = await findOrCreateClientForJob({\r\n            ownerUserId: user.id,\r\n            name: finalClientName,\r\n            email: finalClientEmail,\r\n            suburb: suburb,\r\n          });\r\n          \r\n          updatedJob.clientId = clientId;\r\n        } catch (error) {\r\n          // Log but don't fail job creation if client linking fails\r\n          console.error(\"Failed to link client to job:\", error);\r\n        }\r\n      }\r\n      \r\n      await saveJob(updatedJob);\r\n    }\r\n\r\n    // Track activity and increment job count\r\n    incrementUserJobCount(user.id).catch((err) => {\r\n      console.error(\"Failed to increment job count:\", err);\r\n    });\r\n\r\n    // Log audit if impersonating\r\n    if (impersonating && realAdmin) {\r\n      createAuditLog({\r\n        adminId: realAdmin.id,\r\n        actingAsUserId: user.id,\r\n        action: \"JOB_CREATED_AS_USER\",\r\n        metadata: { jobId: job.id, jobTitle: job.title },\r\n      }).catch((err) => {\r\n        console.error(\"Failed to create audit log:\", err);\r\n      });\r\n    }\r\n\r\n    // Only generate AI job pack for tradies (not for client job posts)\r\n    if (!userIsClient) {\r\n      try {\r\n        console.log(`[jobs] generating job pack for job ${updatedJob.id}`);\r\n        // Generate AI job pack (pass user to load business profile rates)\r\n        updatedJob = await generateJobPack(updatedJob, user);\r\n        console.log(`[jobs] successfully generated job pack for job ${updatedJob.id}`);\r\n      } catch (packError: any) {\r\n        console.error(\"Error generating job pack:\", packError);\r\n        \r\n        // Handle specific error types with better messages\r\n        let errorMessage = \"Failed to generate job pack. Please try again.\";\r\n        let statusCode = 500;\r\n        \r\n        if (packError?.message?.includes(\"EMAIL_NOT_VERIFIED\")) {\r\n          errorMessage = \"Please verify your email address before generating job packs. Check your email for a verification link.\";\r\n          statusCode = 403;\r\n        } else if (packError?.message) {\r\n          // Include the actual error message for debugging\r\n          errorMessage = packError.message;\r\n        }\r\n        \r\n        // Mark job as failed\r\n        if (jobId) {\r\n          try {\r\n            const { getJobById } = await import(\"@/lib/jobs\");\r\n            const failedJob = await getJobById(jobId);\r\n            if (failedJob) {\r\n              failedJob.status = \"ai_failed\";\r\n              await saveJob(failedJob);\r\n            }\r\n          } catch (saveError) {\r\n            console.error(\"Error saving failed status:\", saveError);\r\n          }\r\n        }\r\n        \r\n        return NextResponse.json(\r\n          { error: errorMessage },\r\n          { status: statusCode }\r\n        );\r\n      }\r\n    }\r\n\r\n    console.log(`[jobs] successfully created job ${updatedJob.id}`);\r\n    return NextResponse.json({ job: updatedJob }, { status: 200 });\r\n  } catch (error: any) {\r\n    console.error(\"[jobs] error creating job:\", error);\r\n\r\n    // If we have a job ID, try to mark it as failed\r\n    if (jobId) {\r\n      try {\r\n        const { getJobById } = await import(\"@/lib/jobs\");\r\n        const failedJob = await getJobById(jobId);\r\n        if (failedJob) {\r\n          failedJob.status = \"ai_failed\";\r\n          await saveJob(failedJob);\r\n        }\r\n      } catch (saveError) {\r\n        console.error(\"Error saving failed status:\", saveError);\r\n      }\r\n    }\r\n\r\n    // Provide more specific error messages\r\n    let errorMessage = \"Failed to generate job pack. Please try again.\";\r\n    if (error?.message?.includes(\"EMAIL_NOT_VERIFIED\")) {\r\n      errorMessage = \"Please verify your email address before generating job packs. Check your email for a verification link.\";\r\n    } else if (error?.message) {\r\n      errorMessage = error.message;\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { error: errorMessage },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to extract suburb from address string\r\n */\r\nfunction extractSuburbFromAddress(address: string): string | undefined {\r\n  // Try to extract suburb (word before postcode, or common suburb patterns)\r\n  const postcodeMatch = address.match(/\\b(\\d{4})\\b/);\r\n  if (postcodeMatch) {\r\n    const beforePostcode = address.substring(0, address.indexOf(postcodeMatch[1])).trim();\r\n    const words = beforePostcode.split(/[,\\s]+/);\r\n    if (words.length > 0) {\r\n      return words[words.length - 1]; // Last word before postcode\r\n    }\r\n  }\r\n  return undefined;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\matching\\jobs-for-me\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\materials\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[912,915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[912,915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1329,1332],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1329,1332],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3463,3466],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3463,3466],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3924,3927],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3924,3927],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * PATCH /api/materials/[id]\r\n * Update a MaterialItem\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage materials library\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n    const body = await request.json();\r\n\r\n    // Check ownership (unless admin)\r\n    const prisma = getPrisma();\r\n    const existing = await (prisma as any).materialItem.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!existing) {\r\n      return NextResponse.json(\r\n        { error: \"Material not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (existing.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const material = await (prisma as any).materialItem.update({\r\n      where: { id },\r\n      data: {\r\n        name: body.name !== undefined ? body.name.trim() : undefined,\r\n        category: body.category !== undefined ? (body.category?.trim() || null) : undefined,\r\n        supplier: body.supplier !== undefined ? (body.supplier?.trim() || null) : undefined,\r\n        unitLabel: body.unitLabel !== undefined ? body.unitLabel.trim() : undefined,\r\n        unitCost: body.unitCost !== undefined ? (body.unitCost != null ? body.unitCost : null) : undefined,\r\n        notes: body.notes !== undefined ? (body.notes?.trim() || null) : undefined,\r\n        isArchived: body.isArchived !== undefined ? body.isArchived : undefined,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      material: {\r\n        id: material.id,\r\n        name: material.name,\r\n        category: material.category,\r\n        supplier: material.supplier,\r\n        unitLabel: material.unitLabel,\r\n        unitCost: material.unitCost ? Number(material.unitCost) : null,\r\n        notes: material.notes,\r\n        isArchived: material.isArchived,\r\n        createdAt: material.createdAt.toISOString(),\r\n        updatedAt: material.updatedAt.toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating material:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to update material\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/materials/[id]\r\n * Soft delete a MaterialItem (set isArchived = true)\r\n */\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage materials library\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n\r\n    // Check ownership (unless admin)\r\n    const prisma = getPrisma();\r\n    const existing = await (prisma as any).materialItem.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!existing) {\r\n      return NextResponse.json(\r\n        { error: \"Material not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (existing.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Soft delete (set isArchived = true)\r\n    const material = await (prisma as any).materialItem.update({\r\n      where: { id },\r\n      data: { isArchived: true },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      material: {\r\n        id: material.id,\r\n        isArchived: material.isArchived,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error deleting material:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to delete material\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\materials\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[923,926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[923,926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1368,1371],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1368,1371],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1576,1579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1576,1579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3000,3003],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3000,3003],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/materials\r\n * List current user's materials library (with optional search)\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients from accessing materials library\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage materials library\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const search = searchParams.get(\"search\") || \"\";\r\n    const includeArchived = searchParams.get(\"includeArchived\") === \"true\";\r\n\r\n    const where: any = {\r\n      userId: user.id,\r\n    };\r\n\r\n    if (!includeArchived) {\r\n      where.isArchived = false;\r\n    }\r\n\r\n    if (search.trim()) {\r\n      where.OR = [\r\n        { name: { contains: search, mode: \"insensitive\" } },\r\n        { category: { contains: search, mode: \"insensitive\" } },\r\n        { supplier: { contains: search, mode: \"insensitive\" } },\r\n      ];\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const materials = await (prisma as any).materialItem.findMany({\r\n      where,\r\n      orderBy: [\r\n        { isArchived: \"asc\" },\r\n        { name: \"asc\" },\r\n      ],\r\n    });\r\n\r\n    return NextResponse.json({\r\n      materials: materials.map((m: any) => ({\r\n        id: m.id,\r\n        name: m.name,\r\n        category: m.category,\r\n        supplier: m.supplier,\r\n        unitLabel: m.unitLabel,\r\n        unitCost: m.unitCost ? Number(m.unitCost) : null,\r\n        notes: m.notes,\r\n        isArchived: m.isArchived,\r\n        createdAt: m.createdAt.toISOString(),\r\n        updatedAt: m.updatedAt.toISOString(),\r\n      })),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching materials:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch materials\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/materials\r\n * Create a new MaterialItem\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage materials library\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { name, category, supplier, unitLabel, unitCost, notes } = body;\r\n\r\n    if (!name || !unitLabel) {\r\n      return NextResponse.json(\r\n        { error: \"Name and unitLabel are required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const material = await (prisma as any).materialItem.create({\r\n      data: {\r\n        userId: user.id,\r\n        name: name.trim(),\r\n        category: category?.trim() || null,\r\n        supplier: supplier?.trim() || null,\r\n        unitLabel: unitLabel.trim(),\r\n        unitCost: unitCost != null ? unitCost : null,\r\n        notes: notes?.trim() || null,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      material: {\r\n        id: material.id,\r\n        name: material.name,\r\n        category: material.category,\r\n        supplier: material.supplier,\r\n        unitLabel: material.unitLabel,\r\n        unitCost: material.unitCost ? Number(material.unitCost) : null,\r\n        notes: material.notes,\r\n        isArchived: material.isArchived,\r\n        createdAt: material.createdAt.toISOString(),\r\n        updatedAt: material.updatedAt.toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error creating material:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create material\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\me\\analytics\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":10,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient } from \"@/lib/auth\";\r\nimport { getUserJobAnalytics } from \"@/lib/analytics\";\r\n\r\n/**\r\n * GET /api/me/analytics\r\n * Returns job analytics for the current user\r\n * Only accessible by tradie/business/builder users (not clients)\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Return minimal data for clients (they have their own dashboard)\r\n    if (isClient(user)) {\r\n      return NextResponse.json({\r\n        totalJobs: 0,\r\n        jobsLast30Days: 0,\r\n        jobsLast7Days: 0,\r\n        quoteCounts: {\r\n          draft: 0,\r\n          sent: 0,\r\n          accepted: 0,\r\n          declined: 0,\r\n          cancelled: 0,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Compute analytics for tradie/business users\r\n    const analytics = await getUserJobAnalytics(user.id);\r\n\r\n    return NextResponse.json(analytics);\r\n  } catch (error) {\r\n    console.error(\"Error fetching analytics:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch analytics\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\me\\onboarding\\dismiss\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * POST /api/me/onboarding/dismiss\r\n * Dismisses the onboarding checklist for the current user\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: currentUser.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Update user to mark onboarding as dismissed\r\n    await prisma.user.update({\r\n      where: { id: prismaUser.id },\r\n      data: {\r\n        onboardingDismissed: true,\r\n        onboardingCompletedAt: new Date(), // Set completion date when dismissed\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Error dismissing onboarding:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to dismiss onboarding\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\onboarding\\check\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":10,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { needsOnboarding } from \"@/lib/onboarding\";\r\n\r\n/**\r\n * GET /api/onboarding/check\r\n * Checks if the current user needs onboarding\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Clients don't need onboarding\r\n    if (user.role === \"client\") {\r\n      return NextResponse.json({\r\n        needsOnboarding: false,\r\n        skipped: false,\r\n      });\r\n    }\r\n\r\n    // Find user in Prisma (need all fields for needsOnboarding check)\r\n    // Wrap in try-catch to handle database connection issues gracefully\r\n    const prisma = getPrisma();\r\n    let prismaUser;\r\n    try {\r\n      prismaUser = await prisma.user.findUnique({\r\n        where: { email: user.email },\r\n      });\r\n    } catch (dbError) {\r\n      // If database query fails, assume user needs onboarding (safe default)\r\n      console.error(\"[onboarding] Database error in onboarding check:\", dbError);\r\n      return NextResponse.json({\r\n        onboarded: false,\r\n        needsOnboarding: true,\r\n        skipped: false,\r\n        error: \"check_failed\",\r\n      }, { status: 200 });\r\n    }\r\n\r\n    // If user doesn't exist in Prisma yet, treat as needing onboarding\r\n    if (!prismaUser) {\r\n      return NextResponse.json({\r\n        onboarded: false,\r\n        needsOnboarding: true,\r\n        skipped: false,\r\n      });\r\n    }\r\n\r\n    // Check onboarding status with error handling\r\n    let needs = true;\r\n    let skipped = false;\r\n    try {\r\n      needs = needsOnboarding(prismaUser);\r\n      skipped = !!prismaUser.onboardingSkippedAt;\r\n    } catch (onboardingError) {\r\n      // If needsOnboarding check fails, default to needing onboarding\r\n      console.error(\"[onboarding] Error computing onboarding status:\", onboardingError);\r\n      needs = true;\r\n      skipped = false;\r\n    }\r\n\r\n    return NextResponse.json({\r\n      onboarded: !needs,\r\n      needsOnboarding: needs,\r\n      skipped,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[onboarding] Error checking onboarding status:\", error);\r\n    // Return safe default instead of 500 error\r\n    return NextResponse.json({\r\n      onboarded: false,\r\n      needsOnboarding: true,\r\n      skipped: false,\r\n      error: \"check_failed\",\r\n    }, { status: 200 });\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\onboarding\\complete\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * POST /api/onboarding/complete\r\n * Marks the user's onboarding as complete\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Mark onboarding as complete\r\n    await prisma.user.update({\r\n      where: { id: prismaUser.id },\r\n      data: {\r\n        profileCompletedAt: new Date(),\r\n        hasSeenOnboarding: true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Error completing onboarding:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to complete onboarding\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\onboarding\\skip\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * POST /api/onboarding/skip\r\n * Marks the user's onboarding as skipped (not completed)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!prismaUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Mark onboarding as skipped (not completed)\r\n    await prisma.user.update({\r\n      where: { id: prismaUser.id },\r\n      data: {\r\n        onboardingSkippedAt: new Date(),\r\n        hasSeenOnboarding: true,\r\n        // Do NOT set profileCompletedAt - user can complete onboarding later\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Error skipping onboarding:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to skip onboarding\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\rate-templates\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[915,918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[915,918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2587,2590],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2587,2590],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2887,2890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2887,2890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4534,4537],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4534,4537],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6332,6335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6332,6335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6816,6819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6816,6819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * PATCH /api/rate-templates/[id]\r\n * Update a rate template\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage rate templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n    const body = await request.json();\r\n\r\n    // Check ownership (unless admin)\r\n    const prisma = getPrisma();\r\n    const existing = await (prisma as any).rateTemplate.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!existing) {\r\n      return NextResponse.json(\r\n        { error: \"Rate template not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (existing.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Validate name if provided\r\n    if (body.name !== undefined && (!body.name || !body.name.trim())) {\r\n      return NextResponse.json(\r\n        { error: \"Template name is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate numeric fields\r\n    const numericFields = [\r\n      \"hourlyRate\",\r\n      \"helperHourlyRate\",\r\n      \"dayRate\",\r\n      \"calloutFee\",\r\n      \"minCharge\",\r\n      \"ratePerM2Interior\",\r\n      \"ratePerM2Exterior\",\r\n      \"ratePerLmTrim\",\r\n    ];\r\n\r\n    for (const field of numericFields) {\r\n      if (body[field] !== undefined && body[field] != null) {\r\n        if (typeof body[field] !== \"number\" || body[field] < 0) {\r\n          return NextResponse.json(\r\n            { error: `${field} must be a number >= 0` },\r\n            { status: 400 }\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (body.materialMarkupPercent !== undefined && body.materialMarkupPercent != null) {\r\n      if (typeof body.materialMarkupPercent !== \"number\" || body.materialMarkupPercent < 0) {\r\n        return NextResponse.json(\r\n          { error: \"materialMarkupPercent must be a number >= 0\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // If setting as default, clear other defaults\r\n    if (body.isDefault === true) {\r\n      await (prisma as any).rateTemplate.updateMany({\r\n        where: {\r\n          userId: user.id,\r\n          isDefault: true,\r\n          id: { not: id }, // exclude current template\r\n        },\r\n        data: {\r\n          isDefault: false,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Build update data\r\n    const updateData: any = {};\r\n    if (body.name !== undefined) updateData.name = body.name.trim();\r\n    if (body.tradeType !== undefined) updateData.tradeType = body.tradeType?.trim() || null;\r\n    if (body.propertyType !== undefined) updateData.propertyType = body.propertyType?.trim() || null;\r\n    if (body.hourlyRate !== undefined) updateData.hourlyRate = body.hourlyRate != null ? Math.round(body.hourlyRate) : null;\r\n    if (body.helperHourlyRate !== undefined) updateData.helperHourlyRate = body.helperHourlyRate != null ? Math.round(body.helperHourlyRate) : null;\r\n    if (body.dayRate !== undefined) updateData.dayRate = body.dayRate != null ? Math.round(body.dayRate) : null;\r\n    if (body.calloutFee !== undefined) updateData.calloutFee = body.calloutFee != null ? Math.round(body.calloutFee) : null;\r\n    if (body.minCharge !== undefined) updateData.minCharge = body.minCharge != null ? Math.round(body.minCharge) : null;\r\n    if (body.ratePerM2Interior !== undefined) updateData.ratePerM2Interior = body.ratePerM2Interior != null ? Math.round(body.ratePerM2Interior) : null;\r\n    if (body.ratePerM2Exterior !== undefined) updateData.ratePerM2Exterior = body.ratePerM2Exterior != null ? Math.round(body.ratePerM2Exterior) : null;\r\n    if (body.ratePerLmTrim !== undefined) updateData.ratePerLmTrim = body.ratePerLmTrim != null ? Math.round(body.ratePerLmTrim) : null;\r\n    if (body.materialMarkupPercent !== undefined) updateData.materialMarkupPercent = body.materialMarkupPercent != null ? body.materialMarkupPercent : null;\r\n    if (body.isDefault !== undefined) updateData.isDefault = body.isDefault === true;\r\n\r\n    const template = await (prisma as any).rateTemplate.update({\r\n      where: { id },\r\n      data: updateData,\r\n    });\r\n\r\n    return NextResponse.json({\r\n      template: {\r\n        id: template.id,\r\n        name: template.name,\r\n        tradeType: template.tradeType,\r\n        propertyType: template.propertyType,\r\n        hourlyRate: template.hourlyRate,\r\n        helperHourlyRate: template.helperHourlyRate,\r\n        dayRate: template.dayRate,\r\n        calloutFee: template.calloutFee,\r\n        minCharge: template.minCharge,\r\n        ratePerM2Interior: template.ratePerM2Interior,\r\n        ratePerM2Exterior: template.ratePerM2Exterior,\r\n        ratePerLmTrim: template.ratePerLmTrim,\r\n        materialMarkupPercent: template.materialMarkupPercent,\r\n        isDefault: template.isDefault,\r\n        createdAt: template.createdAt.toISOString(),\r\n        updatedAt: template.updatedAt.toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating rate template:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to update rate template\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/rate-templates/[id]\r\n * Delete a rate template\r\n */\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage rate templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { id } = await context.params;\r\n\r\n    // Check ownership (unless admin)\r\n    const prisma = getPrisma();\r\n    const existing = await (prisma as any).rateTemplate.findUnique({\r\n      where: { id },\r\n    });\r\n\r\n    if (!existing) {\r\n      return NextResponse.json(\r\n        { error: \"Rate template not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (existing.userId !== user.id && !isAdmin(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Not authorized\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Delete the template (safe to delete - jobs keep their own rate copies)\r\n    await (prisma as any).rateTemplate.delete({\r\n      where: { id },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error deleting rate template:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to delete rate template\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\rate-templates\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[732,735],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[732,735],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[978,981],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[978,981],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3759,3762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3759,3762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3993,3996],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3993,3996],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser, isClient } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/rate-templates\r\n * List current user's rate templates\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage rate templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const templates = await (prisma as any).rateTemplate.findMany({\r\n      where: {\r\n        userId: user.id,\r\n      },\r\n      orderBy: [\r\n        { isDefault: \"desc\" },\r\n        { name: \"asc\" },\r\n      ],\r\n    });\r\n\r\n    return NextResponse.json({\r\n      templates: templates.map((t: any) => ({\r\n        id: t.id,\r\n        name: t.name,\r\n        tradeType: t.tradeType,\r\n        propertyType: t.propertyType,\r\n        hourlyRate: t.hourlyRate,\r\n        helperHourlyRate: t.helperHourlyRate,\r\n        dayRate: t.dayRate,\r\n        calloutFee: t.calloutFee,\r\n        minCharge: t.minCharge,\r\n        ratePerM2Interior: t.ratePerM2Interior,\r\n        ratePerM2Exterior: t.ratePerM2Exterior,\r\n        ratePerLmTrim: t.ratePerLmTrim,\r\n        materialMarkupPercent: t.materialMarkupPercent,\r\n        isDefault: t.isDefault,\r\n        createdAt: t.createdAt.toISOString(),\r\n        updatedAt: t.updatedAt.toISOString(),\r\n      })),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching rate templates:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch rate templates\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/rate-templates\r\n * Create a new rate template\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Block clients\r\n    if (isClient(user)) {\r\n      return NextResponse.json(\r\n        { error: \"Clients cannot manage rate templates\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      name,\r\n      tradeType,\r\n      propertyType,\r\n      hourlyRate,\r\n      helperHourlyRate,\r\n      dayRate,\r\n      calloutFee,\r\n      minCharge,\r\n      ratePerM2Interior,\r\n      ratePerM2Exterior,\r\n      ratePerLmTrim,\r\n      materialMarkupPercent,\r\n      isDefault,\r\n    } = body;\r\n\r\n    if (!name || !name.trim()) {\r\n      return NextResponse.json(\r\n        { error: \"Template name is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate numeric fields\r\n    const numericFields = {\r\n      hourlyRate,\r\n      helperHourlyRate,\r\n      dayRate,\r\n      calloutFee,\r\n      minCharge,\r\n      ratePerM2Interior,\r\n      ratePerM2Exterior,\r\n      ratePerLmTrim,\r\n    };\r\n\r\n    for (const [field, value] of Object.entries(numericFields)) {\r\n      if (value != null && (typeof value !== \"number\" || value < 0)) {\r\n        return NextResponse.json(\r\n          { error: `${field} must be a number >= 0` },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    if (materialMarkupPercent != null && (typeof materialMarkupPercent !== \"number\" || materialMarkupPercent < 0)) {\r\n      return NextResponse.json(\r\n        { error: \"materialMarkupPercent must be a number >= 0\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    // If setting as default, clear other defaults\r\n    if (isDefault === true) {\r\n      await (prisma as any).rateTemplate.updateMany({\r\n        where: {\r\n          userId: user.id,\r\n          isDefault: true,\r\n        },\r\n        data: {\r\n          isDefault: false,\r\n        },\r\n      });\r\n    }\r\n\r\n    const template = await (prisma as any).rateTemplate.create({\r\n      data: {\r\n        userId: user.id,\r\n        name: name.trim(),\r\n        tradeType: tradeType?.trim() || null,\r\n        propertyType: propertyType?.trim() || null,\r\n        hourlyRate: hourlyRate != null ? Math.round(hourlyRate) : null,\r\n        helperHourlyRate: helperHourlyRate != null ? Math.round(helperHourlyRate) : null,\r\n        dayRate: dayRate != null ? Math.round(dayRate) : null,\r\n        calloutFee: calloutFee != null ? Math.round(calloutFee) : null,\r\n        minCharge: minCharge != null ? Math.round(minCharge) : null,\r\n        ratePerM2Interior: ratePerM2Interior != null ? Math.round(ratePerM2Interior) : null,\r\n        ratePerM2Exterior: ratePerM2Exterior != null ? Math.round(ratePerM2Exterior) : null,\r\n        ratePerLmTrim: ratePerLmTrim != null ? Math.round(ratePerLmTrim) : null,\r\n        materialMarkupPercent: materialMarkupPercent != null ? materialMarkupPercent : null,\r\n        isDefault: isDefault === true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      template: {\r\n        id: template.id,\r\n        name: template.name,\r\n        tradeType: template.tradeType,\r\n        propertyType: template.propertyType,\r\n        hourlyRate: template.hourlyRate,\r\n        helperHourlyRate: template.helperHourlyRate,\r\n        dayRate: template.dayRate,\r\n        calloutFee: template.calloutFee,\r\n        minCharge: template.minCharge,\r\n        ratePerM2Interior: template.ratePerM2Interior,\r\n        ratePerM2Exterior: template.ratePerM2Exterior,\r\n        ratePerLmTrim: template.ratePerLmTrim,\r\n        materialMarkupPercent: template.materialMarkupPercent,\r\n        isDefault: template.isDefault,\r\n        createdAt: template.createdAt.toISOString(),\r\n        updatedAt: template.updatedAt.toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error creating rate template:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create rate template\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\settings\\business-profile\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4059,4062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4059,4062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5284,5287],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5284,5287],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5504,5507],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5504,5507],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8152,8155],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8152,8155],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":220,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8615,8618],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8615,8618],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":267,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":267,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10939,10942],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10939,10942],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/settings/business-profile\r\n * Returns the current user's business profile fields from Prisma\r\n */\r\nexport async function GET() {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Find user in Prisma by email (since KV and Prisma may use different IDs)\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n      select: {\r\n        businessName: true,\r\n        abn: true,\r\n        primaryTrade: true,\r\n        tradeTypes: true,\r\n        doesResidential: true,\r\n        doesCommercial: true,\r\n        doesStrata: true,\r\n        serviceRadiusKm: true,\r\n        servicePostcodes: true,\r\n        hourlyRate: true,\r\n        calloutFee: true,\r\n        ratePerM2Interior: true,\r\n        ratePerM2Exterior: true,\r\n        ratePerLmTrim: true,\r\n      },\r\n    });\r\n\r\n    // Return business profile data (or defaults if user not found in Prisma yet)\r\n    return NextResponse.json({\r\n      businessProfile: prismaUser ? {\r\n        businessName: prismaUser.businessName ?? null,\r\n        abn: prismaUser.abn ?? null,\r\n        primaryTrade: prismaUser.primaryTrade ?? null,\r\n        tradeTypes: prismaUser.tradeTypes ?? null,\r\n        doesResidential: prismaUser.doesResidential ?? true,\r\n        doesCommercial: prismaUser.doesCommercial ?? false,\r\n        doesStrata: prismaUser.doesStrata ?? false,\r\n        serviceRadiusKm: prismaUser.serviceRadiusKm ?? null,\r\n        servicePostcodes: prismaUser.servicePostcodes ?? null,\r\n        hourlyRate: prismaUser.hourlyRate ?? null,\r\n        calloutFee: prismaUser.calloutFee ?? null,\r\n        ratePerM2Interior: prismaUser.ratePerM2Interior ?? null,\r\n        ratePerM2Exterior: prismaUser.ratePerM2Exterior ?? null,\r\n        ratePerLmTrim: prismaUser.ratePerLmTrim ?? null,\r\n      } : {\r\n        businessName: null,\r\n        abn: null,\r\n        primaryTrade: null,\r\n        tradeTypes: null,\r\n        doesResidential: true,\r\n        doesCommercial: false,\r\n        doesStrata: false,\r\n        serviceRadiusKm: null,\r\n        servicePostcodes: null,\r\n        hourlyRate: null,\r\n        calloutFee: null,\r\n        ratePerM2Interior: null,\r\n        ratePerM2Exterior: null,\r\n        ratePerLmTrim: null,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching business profile:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/settings/business-profile\r\n * Updates the current user's business profile fields in Prisma\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    console.log(`[business-profile] saving details for user ${user.id}`);\r\n\r\n    const body = await request.json();\r\n    const {\r\n      businessName,\r\n      abn,\r\n      primaryTrade,\r\n      tradeTypes,\r\n      doesResidential,\r\n      doesCommercial,\r\n      doesStrata,\r\n      serviceRadiusKm,\r\n      servicePostcodes,\r\n      hourlyRate,\r\n      calloutFee,\r\n      ratePerM2Interior,\r\n      ratePerM2Exterior,\r\n      ratePerLmTrim,\r\n    } = body;\r\n\r\n    // Validate primary trade if provided\r\n    const validTradeTypes = [\"Painter\", \"Plasterer\", \"Carpenter\", \"Electrician\", \"Other\"];\r\n    if (primaryTrade !== undefined && primaryTrade !== null && primaryTrade !== \"\" && !validTradeTypes.includes(primaryTrade)) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid primary trade. Must be one of: Painter, Plasterer, Carpenter, Electrician, Other\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate numeric fields\r\n    const validateInt = (value: any, fieldName: string, min?: number) => {\r\n      if (value === undefined || value === null || value === \"\") return null;\r\n      const num = Number(value);\r\n      if (isNaN(num) || num < 0 || (min !== undefined && num < min)) {\r\n        throw new Error(`${fieldName} must be a non-negative number${min ? ` >= ${min}` : \"\"}`);\r\n      }\r\n      return Math.round(num); // Convert to Int\r\n    };\r\n\r\n    let parsedServiceRadiusKm: number | null = null;\r\n    let parsedHourlyRate: number | null = null;\r\n    let parsedCalloutFee: number | null = null;\r\n    let parsedRatePerM2Interior: number | null = null;\r\n    let parsedRatePerM2Exterior: number | null = null;\r\n    let parsedRatePerLmTrim: number | null = null;\r\n\r\n    try {\r\n      parsedServiceRadiusKm = validateInt(serviceRadiusKm, \"Service radius\");\r\n      parsedHourlyRate = validateInt(hourlyRate, \"Hourly rate\");\r\n      parsedCalloutFee = validateInt(calloutFee, \"Callout fee\");\r\n      parsedRatePerM2Interior = validateInt(ratePerM2Interior, \"Rate per m┬▓ interior\");\r\n      parsedRatePerM2Exterior = validateInt(ratePerM2Exterior, \"Rate per m┬▓ exterior\");\r\n      parsedRatePerLmTrim = validateInt(ratePerLmTrim, \"Rate per linear metre\");\r\n    } catch (validationError: any) {\r\n      return NextResponse.json(\r\n        { error: validationError.message },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Build update object (only include fields that are provided)\r\n    const updateData: any = {};\r\n    if (businessName !== undefined) updateData.businessName = businessName?.trim() || null;\r\n    if (abn !== undefined) updateData.abn = abn?.trim() || null;\r\n    if (primaryTrade !== undefined) updateData.primaryTrade = primaryTrade?.trim() || null;\r\n    if (tradeTypes !== undefined) updateData.tradeTypes = tradeTypes?.trim() || null;\r\n    if (doesResidential !== undefined) updateData.doesResidential = Boolean(doesResidential);\r\n    if (doesCommercial !== undefined) updateData.doesCommercial = Boolean(doesCommercial);\r\n    if (doesStrata !== undefined) updateData.doesStrata = Boolean(doesStrata);\r\n    if (serviceRadiusKm !== undefined) updateData.serviceRadiusKm = parsedServiceRadiusKm;\r\n    if (servicePostcodes !== undefined) updateData.servicePostcodes = servicePostcodes?.trim() || null;\r\n    if (hourlyRate !== undefined) updateData.hourlyRate = parsedHourlyRate;\r\n    if (calloutFee !== undefined) updateData.calloutFee = parsedCalloutFee;\r\n    if (ratePerM2Interior !== undefined) updateData.ratePerM2Interior = parsedRatePerM2Interior;\r\n    if (ratePerM2Exterior !== undefined) updateData.ratePerM2Exterior = parsedRatePerM2Exterior;\r\n    if (ratePerLmTrim !== undefined) updateData.ratePerLmTrim = parsedRatePerLmTrim;\r\n\r\n    // Check if user exists in Prisma\r\n    const prisma = getPrisma();\r\n    const existingUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    let updatedUser;\r\n    if (existingUser) {\r\n      // Update existing user\r\n      console.log(`[business-profile] updating existing user ${user.id} in Prisma`);\r\n      updatedUser = await prisma.user.update({\r\n        where: { email: user.email },\r\n        data: updateData,\r\n      });\r\n      console.log(`[business-profile] successfully updated user ${user.id}`);\r\n    } else {\r\n      // User doesn't exist in Prisma yet - try to upsert using the user ID\r\n      // This handles the case where user exists in KV but not in Prisma\r\n      console.log(`[business-profile] user ${user.id} not found in Prisma, attempting upsert`);\r\n      try {\r\n        updatedUser = await prisma.user.upsert({\r\n          where: { id: user.id },\r\n          update: updateData,\r\n          create: {\r\n            id: user.id,\r\n            email: user.email,\r\n            role: user.role || \"tradie\",\r\n            ...updateData,\r\n            // Set minimal required fields for Prisma\r\n            passwordHash: \"\", // Placeholder - actual password is in KV\r\n            createdAt: new Date(),\r\n          },\r\n        });\r\n        console.log(`[business-profile] successfully upserted user ${user.id} in Prisma`);\r\n      } catch (upsertError: any) {\r\n        // If upsert fails (e.g., due to unique constraint on email), try update by email\r\n        console.warn(`[business-profile] upsert failed, trying update by email:`, upsertError);\r\n        try {\r\n          updatedUser = await prisma.user.update({\r\n            where: { email: user.email },\r\n            data: updateData,\r\n          });\r\n          console.log(`[business-profile] successfully updated user by email`);\r\n        } catch (updateError: any) {\r\n          console.error(`[business-profile] failed to save user data to Prisma:`, updateError);\r\n          // Still return success with the data - it will be synced later\r\n          // But log the error for debugging\r\n          return NextResponse.json({\r\n            success: true,\r\n            businessProfile: {\r\n              businessName: updateData.businessName ?? null,\r\n              abn: updateData.abn ?? null,\r\n              primaryTrade: updateData.primaryTrade ?? null,\r\n              tradeTypes: updateData.tradeTypes ?? null,\r\n              doesResidential: updateData.doesResidential ?? true,\r\n              doesCommercial: updateData.doesCommercial ?? false,\r\n              doesStrata: updateData.doesStrata ?? false,\r\n              serviceRadiusKm: updateData.serviceRadiusKm ?? null,\r\n              servicePostcodes: updateData.servicePostcodes ?? null,\r\n              hourlyRate: updateData.hourlyRate ?? null,\r\n              calloutFee: updateData.calloutFee ?? null,\r\n              ratePerM2Interior: updateData.ratePerM2Interior ?? null,\r\n              ratePerM2Exterior: updateData.ratePerM2Exterior ?? null,\r\n              ratePerLmTrim: updateData.ratePerLmTrim ?? null,\r\n            },\r\n            warning: \"Data saved but user sync to database may be incomplete. Please contact support if data doesn't persist.\",\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      businessProfile: {\r\n        businessName: updatedUser.businessName ?? null,\r\n        abn: updatedUser.abn ?? null,\r\n        primaryTrade: updatedUser.primaryTrade ?? null,\r\n        tradeTypes: updatedUser.tradeTypes ?? null,\r\n        doesResidential: updatedUser.doesResidential ?? true,\r\n        doesCommercial: updatedUser.doesCommercial ?? false,\r\n        doesStrata: updatedUser.doesStrata ?? false,\r\n        serviceRadiusKm: updatedUser.serviceRadiusKm ?? null,\r\n        servicePostcodes: updatedUser.servicePostcodes ?? null,\r\n        hourlyRate: updatedUser.hourlyRate ?? null,\r\n        calloutFee: updatedUser.calloutFee ?? null,\r\n        ratePerM2Interior: updatedUser.ratePerM2Interior ?? null,\r\n        ratePerM2Exterior: updatedUser.ratePerM2Exterior ?? null,\r\n        ratePerLmTrim: updatedUser.ratePerLmTrim ?? null,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"[business-profile] error updating business profile:\", error);\r\n    const errorMessage = error?.message || \"Internal server error\";\r\n    return NextResponse.json(\r\n      { error: errorMessage },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\settings\\business-rates\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2862,2865],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2862,2865],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3350,3353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3350,3353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":133,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4408,4411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4408,4411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":162,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":162,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5281,5284],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5281,5284],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/settings/business-rates\r\n * Returns the current user's business rates and defaults from Prisma\r\n */\r\nexport async function GET() {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n      select: {\r\n        gstRegistered: true,\r\n        defaultMarginPct: true,\r\n        defaultDepositPct: true,\r\n        defaultPaymentTerms: true,\r\n        tradeRatesJson: true,\r\n        dayRate: true,\r\n        hourlyRate: true,\r\n        calloutFee: true,\r\n      },\r\n    });\r\n\r\n    // Parse tradeRatesJson if it exists\r\n    let tradeRates = null;\r\n    if (prismaUser?.tradeRatesJson) {\r\n      try {\r\n        tradeRates = JSON.parse(prismaUser.tradeRatesJson);\r\n      } catch {\r\n        tradeRates = null;\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({\r\n      businessRates: prismaUser ? {\r\n        gstRegistered: prismaUser.gstRegistered ?? false,\r\n        defaultMarginPct: prismaUser.defaultMarginPct ? Number(prismaUser.defaultMarginPct) : null,\r\n        defaultDepositPct: prismaUser.defaultDepositPct ? Number(prismaUser.defaultDepositPct) : null,\r\n        defaultPaymentTerms: prismaUser.defaultPaymentTerms ?? null,\r\n        tradeRates: tradeRates,\r\n        dayRate: prismaUser.dayRate ?? null,\r\n        hourlyRate: prismaUser.hourlyRate ?? null,\r\n        calloutFee: prismaUser.calloutFee ?? null,\r\n      } : {\r\n        gstRegistered: false,\r\n        defaultMarginPct: null,\r\n        defaultDepositPct: null,\r\n        defaultPaymentTerms: null,\r\n        tradeRates: null,\r\n        dayRate: null,\r\n        hourlyRate: null,\r\n        calloutFee: null,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching business rates:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/settings/business-rates\r\n * Updates the current user's business rates and defaults in Prisma\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Not authenticated\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      gstRegistered,\r\n      defaultMarginPct,\r\n      defaultDepositPct,\r\n      defaultPaymentTerms,\r\n      tradeRates,\r\n      dayRate,\r\n      hourlyRate,\r\n      calloutFee,\r\n    } = body;\r\n\r\n    // Validate numeric fields\r\n    const validateDecimal = (value: any, fieldName: string, min?: number, max?: number) => {\r\n      if (value === undefined || value === null || value === \"\") return null;\r\n      const num = Number(value);\r\n      if (isNaN(num) || num < 0 || (min !== undefined && num < min) || (max !== undefined && num > max)) {\r\n        throw new Error(`${fieldName} must be a number${min !== undefined ? ` >= ${min}` : \"\"}${max !== undefined ? ` <= ${max}` : \"\"}`);\r\n      }\r\n      return num;\r\n    };\r\n\r\n    const validateInt = (value: any, fieldName: string, min?: number) => {\r\n      if (value === undefined || value === null || value === \"\") return null;\r\n      const num = Number(value);\r\n      if (isNaN(num) || num < 0 || (min !== undefined && num < min)) {\r\n        throw new Error(`${fieldName} must be a non-negative number${min ? ` >= ${min}` : \"\"}`);\r\n      }\r\n      return Math.round(num);\r\n    };\r\n\r\n    let parsedDefaultMarginPct: number | null = null;\r\n    let parsedDefaultDepositPct: number | null = null;\r\n    let parsedDayRate: number | null = null;\r\n    let parsedHourlyRate: number | null = null;\r\n    let parsedCalloutFee: number | null = null;\r\n\r\n    try {\r\n      parsedDefaultMarginPct = validateDecimal(defaultMarginPct, \"Default margin %\", 0, 100);\r\n      parsedDefaultDepositPct = validateDecimal(defaultDepositPct, \"Default deposit %\", 0, 100);\r\n      parsedDayRate = validateInt(dayRate, \"Day rate\");\r\n      parsedHourlyRate = validateInt(hourlyRate, \"Hourly rate\");\r\n      parsedCalloutFee = validateInt(calloutFee, \"Call-out fee\");\r\n    } catch (validationError: any) {\r\n      return NextResponse.json(\r\n        { error: validationError.message },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate defaultPaymentTerms length\r\n    if (defaultPaymentTerms !== undefined && defaultPaymentTerms !== null && defaultPaymentTerms.length > 100) {\r\n      return NextResponse.json(\r\n        { error: \"Default payment terms must be 100 characters or less\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate and stringify tradeRates JSON\r\n    let tradeRatesJson: string | null = null;\r\n    if (tradeRates !== undefined && tradeRates !== null) {\r\n      try {\r\n        tradeRatesJson = JSON.stringify(tradeRates);\r\n      } catch {\r\n        return NextResponse.json(\r\n          { error: \"Invalid trade rates format\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Build update object\r\n    const updateData: any = {};\r\n    if (gstRegistered !== undefined) updateData.gstRegistered = Boolean(gstRegistered);\r\n    if (defaultMarginPct !== undefined) updateData.defaultMarginPct = parsedDefaultMarginPct;\r\n    if (defaultDepositPct !== undefined) updateData.defaultDepositPct = parsedDefaultDepositPct;\r\n    if (defaultPaymentTerms !== undefined) updateData.defaultPaymentTerms = defaultPaymentTerms?.trim() || null;\r\n    if (tradeRates !== undefined) updateData.tradeRatesJson = tradeRatesJson;\r\n    if (dayRate !== undefined) updateData.dayRate = parsedDayRate;\r\n    if (hourlyRate !== undefined) updateData.hourlyRate = parsedHourlyRate;\r\n    if (calloutFee !== undefined) updateData.calloutFee = parsedCalloutFee;\r\n\r\n    // Check if user exists in Prisma\r\n    const prisma = getPrisma();\r\n    const existingUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n\r\n    if (!existingUser) {\r\n      return NextResponse.json(\r\n        { error: \"User not found in database\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Update user\r\n    const updatedUser = await prisma.user.update({\r\n      where: { email: user.email },\r\n      data: updateData,\r\n    });\r\n\r\n    // Parse tradeRatesJson for response\r\n    let responseTradeRates = null;\r\n    if (updatedUser.tradeRatesJson) {\r\n      try {\r\n        responseTradeRates = JSON.parse(updatedUser.tradeRatesJson);\r\n      } catch {\r\n        responseTradeRates = null;\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      businessRates: {\r\n        gstRegistered: updatedUser.gstRegistered,\r\n        defaultMarginPct: updatedUser.defaultMarginPct ? Number(updatedUser.defaultMarginPct) : null,\r\n        defaultDepositPct: updatedUser.defaultDepositPct ? Number(updatedUser.defaultDepositPct) : null,\r\n        defaultPaymentTerms: updatedUser.defaultPaymentTerms ?? null,\r\n        tradeRates: responseTradeRates,\r\n        dayRate: updatedUser.dayRate ?? null,\r\n        hourlyRate: updatedUser.hourlyRate ?? null,\r\n        calloutFee: updatedUser.calloutFee ?? null,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating business rates:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\settings\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\settings\\signature\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":9,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\n/**\r\n * GET /api/settings/signature\r\n * Returns the current user's signature\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized. Please log in.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { id: user.id },\r\n      select: {\r\n        signatureImage: true,\r\n        signatureUpdatedAt: true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      signatureImage: prismaUser?.signatureImage || null,\r\n      signatureUpdatedAt: prismaUser?.signatureUpdatedAt?.toISOString() || null,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching signature:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch signature.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/settings/signature\r\n * Saves or updates the current user's signature\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized. Please log in.\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { dataUrl } = body;\r\n\r\n    if (typeof dataUrl !== \"string\") {\r\n      return NextResponse.json(\r\n        { error: \"Invalid request. dataUrl must be a string.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Basic size check (limit to ~500KB for data URLs)\r\n    if (dataUrl.length > 500000) {\r\n      return NextResponse.json(\r\n        { error: \"Signature image is too large. Please try again with a smaller image.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate it's a data URL\r\n    if (!dataUrl.startsWith(\"data:image/\")) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid image format. Please use a valid image data URL.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Update signature\r\n    const prisma = getPrisma();\r\n    const updatedUser = await prisma.user.update({\r\n      where: { id: user.id },\r\n      data: {\r\n        signatureImage: dataUrl,\r\n        signatureUpdatedAt: new Date(),\r\n      },\r\n      select: {\r\n        signatureImage: true,\r\n        signatureUpdatedAt: true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      signatureImage: updatedUser.signatureImage,\r\n      signatureUpdatedAt: updatedUser.signatureUpdatedAt?.toISOString() || null,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error saving signature:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to save signature. Please try again.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\settings\\verification\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\api\\test-email\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\billing\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\calendar\\CalendarView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useState' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useMemo } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { ChevronLeft, ChevronRight } from \"lucide-react\";\r\nimport type { Job } from \"@/lib/jobs\";\r\n\r\ninterface CalendarViewProps {\r\n  year: number;\r\n  month: number;\r\n  jobs: Job[];\r\n}\r\n\r\nfunction getStatusColor(status: string | undefined): string {\r\n  const colors: Record<string, string> = {\r\n    pending: \"bg-amber-100 text-amber-700 border-amber-200\",\r\n    booked: \"bg-blue-100 text-blue-700 border-blue-200\",\r\n    completed: \"bg-green-100 text-green-700 border-green-200\",\r\n    cancelled: \"bg-slate-100 text-slate-500 border-slate-200\",\r\n  };\r\n  return colors[status || \"pending\"] || \"bg-slate-100 text-slate-700 border-slate-200\";\r\n}\r\n\r\nfunction formatTime(dateString: string): string {\r\n  return new Date(dateString).toLocaleTimeString(\"en-AU\", {\r\n    hour: \"numeric\",\r\n    minute: \"2-digit\",\r\n    hour12: true,\r\n  });\r\n}\r\n\r\nexport default function CalendarView({ year, month, jobs }: CalendarViewProps) {\r\n  const router = useRouter();\r\n  \r\n  // Get first day of month and number of days\r\n  const firstDay = new Date(year, month - 1, 1);\r\n  const lastDay = new Date(year, month, 0);\r\n  const daysInMonth = lastDay.getDate();\r\n  const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.\r\n  \r\n  // Adjust for Monday-first week (0 = Monday, 6 = Sunday)\r\n  const adjustedStartingDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;\r\n  \r\n  // Group jobs by date\r\n  const jobsByDate = useMemo(() => {\r\n    const grouped: Record<string, Job[]> = {};\r\n    jobs.forEach((job) => {\r\n      if (!job.scheduledStartAt) return;\r\n      const date = new Date(job.scheduledStartAt);\r\n      const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, \"0\")}-${String(date.getDate()).padStart(2, \"0\")}`;\r\n      if (!grouped[dateKey]) {\r\n        grouped[dateKey] = [];\r\n      }\r\n      grouped[dateKey].push(job);\r\n    });\r\n    return grouped;\r\n  }, [jobs]);\r\n  \r\n  // Navigate to previous/next month\r\n  const navigateMonth = (direction: \"prev\" | \"next\") => {\r\n    let newYear = year;\r\n    let newMonth = month;\r\n    \r\n    if (direction === \"prev\") {\r\n      newMonth -= 1;\r\n      if (newMonth < 1) {\r\n        newMonth = 12;\r\n        newYear -= 1;\r\n      }\r\n    } else {\r\n      newMonth += 1;\r\n      if (newMonth > 12) {\r\n        newMonth = 1;\r\n        newYear += 1;\r\n      }\r\n    }\r\n    \r\n    router.push(`/calendar?year=${newYear}&month=${newMonth}`);\r\n  };\r\n  \r\n  // Get today's date for highlighting\r\n  const today = new Date();\r\n  const isCurrentMonth = today.getFullYear() === year && today.getMonth() + 1 === month;\r\n  const todayDate = isCurrentMonth ? today.getDate() : null;\r\n  \r\n  // Generate calendar days\r\n  const calendarDays: Array<{ day: number | null; dateKey: string | null; isToday: boolean; isCurrentMonth: boolean }> = [];\r\n  \r\n  // Add empty cells for days before the first day of the month\r\n  for (let i = 0; i < adjustedStartingDay; i++) {\r\n    calendarDays.push({ day: null, dateKey: null, isToday: false, isCurrentMonth: false });\r\n  }\r\n  \r\n  // Add days of the month\r\n  for (let day = 1; day <= daysInMonth; day++) {\r\n    const dateKey = `${year}-${String(month).padStart(2, \"0\")}-${String(day).padStart(2, \"0\")}`;\r\n    calendarDays.push({\r\n      day,\r\n      dateKey,\r\n      isToday: day === todayDate,\r\n      isCurrentMonth: true,\r\n    });\r\n  }\r\n  \r\n  // Month name\r\n  const monthName = firstDay.toLocaleDateString(\"en-AU\", { month: \"long\", year: \"numeric\" });\r\n  \r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n      {/* Calendar Header */}\r\n      <div className=\"px-6 py-4 border-b border-slate-200\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <h2 className=\"text-xl font-semibold text-slate-900\">{monthName}</h2>\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              onClick={() => navigateMonth(\"prev\")}\r\n              className=\"p-2 hover:bg-slate-100 rounded-lg transition-colors\"\r\n              aria-label=\"Previous month\"\r\n            >\r\n              <ChevronLeft className=\"w-5 h-5 text-slate-600\" />\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                const now = new Date();\r\n                router.push(`/calendar?year=${now.getFullYear()}&month=${now.getMonth() + 1}`);\r\n              }}\r\n              className=\"px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors\"\r\n            >\r\n              Today\r\n            </button>\r\n            <button\r\n              onClick={() => navigateMonth(\"next\")}\r\n              className=\"p-2 hover:bg-slate-100 rounded-lg transition-colors\"\r\n              aria-label=\"Next month\"\r\n            >\r\n              <ChevronRight className=\"w-5 h-5 text-slate-600\" />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Calendar Grid */}\r\n      <div className=\"p-6\">\r\n        {/* Day names header */}\r\n        <div className=\"grid grid-cols-7 gap-2 mb-2\">\r\n          {[\"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\", \"Sun\"].map((dayName) => (\r\n            <div\r\n              key={dayName}\r\n              className=\"text-center text-xs font-semibold text-slate-500 py-2\"\r\n            >\r\n              {dayName}\r\n            </div>\r\n          ))}\r\n        </div>\r\n        \r\n        {/* Calendar days */}\r\n        <div className=\"grid grid-cols-7 gap-2\">\r\n          {calendarDays.map((calDay, idx) => {\r\n            if (calDay.day === null) {\r\n              return (\r\n                <div\r\n                  key={`empty-${idx}`}\r\n                  className=\"aspect-square border border-slate-100 rounded-lg bg-slate-50\"\r\n                />\r\n              );\r\n            }\r\n            \r\n            const dayJobs = calDay.dateKey ? jobsByDate[calDay.dateKey] || [] : [];\r\n            \r\n            return (\r\n              <div\r\n                key={calDay.dateKey}\r\n                className={`aspect-square border rounded-lg p-2 overflow-y-auto ${\r\n                  calDay.isToday\r\n                    ? \"border-amber-500 bg-amber-50\"\r\n                    : calDay.isCurrentMonth\r\n                    ? \"border-slate-200 bg-white\"\r\n                    : \"border-slate-100 bg-slate-50\"\r\n                }`}\r\n              >\r\n                <div\r\n                  className={`text-sm font-medium mb-1 ${\r\n                    calDay.isToday\r\n                      ? \"text-amber-700\"\r\n                      : calDay.isCurrentMonth\r\n                      ? \"text-slate-900\"\r\n                      : \"text-slate-400\"\r\n                  }`}\r\n                >\r\n                  {calDay.day}\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  {dayJobs.slice(0, 3).map((job) => (\r\n                    <Link\r\n                      key={job.id}\r\n                      href={`/jobs/${job.id}`}\r\n                      className={`block px-2 py-1 rounded text-xs font-medium border truncate hover:opacity-80 transition-opacity ${getStatusColor(job.jobStatus)}`}\r\n                      title={`${job.title} - ${formatTime(job.scheduledStartAt!)}`}\r\n                    >\r\n                      <div className=\"truncate\">{job.title}</div>\r\n                      <div className=\"text-xs opacity-75\">{formatTime(job.scheduledStartAt!)}</div>\r\n                    </Link>\r\n                  ))}\r\n                  {dayJobs.length > 3 && (\r\n                    <div className=\"text-xs text-slate-500 px-2\">\r\n                      +{dayJobs.length - 3} more\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Legend */}\r\n      <div className=\"px-6 py-4 border-t border-slate-200 bg-slate-50\">\r\n        <div className=\"flex flex-wrap items-center gap-4 text-xs\">\r\n          <span className=\"font-medium text-slate-700\">Status:</span>\r\n          <span className=\"inline-flex items-center px-2 py-0.5 rounded bg-amber-100 text-amber-700 border border-amber-200\">\r\n            Pending\r\n          </span>\r\n          <span className=\"inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200\">\r\n            Booked\r\n          </span>\r\n          <span className=\"inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-700 border border-green-200\">\r\n            Completed\r\n          </span>\r\n          <span className=\"inline-flex items-center px-2 py-0.5 rounded bg-slate-100 text-slate-500 border border-slate-200\">\r\n            Cancelled\r\n          </span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\calendar\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\client\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\client\\jobs\\[id]\\ClientAcceptanceForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PenTool' is defined but never used.","line":5,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'clientEmail' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'quoteVersion' is defined but never used.","line":27,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2896,2899],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2896,2899],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3718,3721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3718,3721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { CheckCircle, XCircle, Loader2, PenTool } from \"lucide-react\";\r\nimport type { ClientStatus } from \"@/lib/jobs\";\r\n\r\ninterface ClientAcceptanceFormProps {\r\n  jobId: string;\r\n  currentStatus: ClientStatus;\r\n  clientEmail: string;\r\n  quoteExpiryAt?: string | null;\r\n  quoteNumber?: string | null;\r\n  quoteVersion?: number | null;\r\n  clientAcceptedAt?: string | null;\r\n  clientAcceptedByName?: string | null;\r\n  clientAcceptanceNote?: string | null;\r\n  clientAcceptedQuoteVer?: number | null;\r\n}\r\n\r\nexport default function ClientAcceptanceForm({\r\n  jobId,\r\n  currentStatus,\r\n  clientEmail,\r\n  quoteExpiryAt,\r\n  quoteNumber,\r\n  quoteVersion,\r\n  clientAcceptedAt,\r\n  clientAcceptedByName,\r\n  clientAcceptanceNote,\r\n  clientAcceptedQuoteVer,\r\n}: ClientAcceptanceFormProps) {\r\n  const router = useRouter();\r\n  const [isAccepting, setIsAccepting] = useState(false);\r\n  const [isDeclining, setIsDeclining] = useState(false);\r\n  const [showDeclineForm, setShowDeclineForm] = useState(false);\r\n  const [fullName, setFullName] = useState(\"\");\r\n  const [acceptanceNote, setAcceptanceNote] = useState(\"\");\r\n  const [confirmAgreement, setConfirmAgreement] = useState(false);\r\n  const [declineReason, setDeclineReason] = useState(\"\");\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(\"\");\r\n\r\n  const canAcceptOrDecline = currentStatus === \"sent\" || currentStatus === \"draft\";\r\n  const isExpired = quoteExpiryAt ? new Date(quoteExpiryAt) < new Date() : false;\r\n  const canAccept = canAcceptOrDecline && !isExpired;\r\n\r\n  const handleAccept = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!fullName.trim()) {\r\n      setError(\"Please enter your full name\");\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setIsAccepting(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/client/jobs/${jobId}/accept`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          fullName: fullName.trim(),\r\n          note: acceptanceNote.trim() || undefined,\r\n          confirm: confirmAgreement,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        // Handle specific error types\r\n        if (data.error === \"QUOTE_EXPIRED\") {\r\n          throw new Error(data.message || \"This quote has expired. Please contact your tradie to get an updated job pack.\");\r\n        }\r\n        if (data.error === \"QUOTE_DECLINED\") {\r\n          throw new Error(data.message || \"This job pack was declined; contact your tradie for a new quote.\");\r\n        }\r\n        throw new Error(data.error || data.message || \"Failed to accept job pack\");\r\n      }\r\n\r\n      setSuccess(\"Thanks ÔÇô your approval has been recorded.\");\r\n      router.refresh();\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to accept job pack\");\r\n    } finally {\r\n      setIsAccepting(false);\r\n    }\r\n  };\r\n\r\n  const handleDecline = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setIsDeclining(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/client/jobs/${jobId}/decline`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          reason: declineReason.trim() || undefined,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Failed to decline job pack\");\r\n      }\r\n\r\n      setSuccess(\"Your decline has been recorded. Your tradie will be notified.\");\r\n      router.refresh();\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to decline job pack\");\r\n    } finally {\r\n      setIsDeclining(false);\r\n      setShowDeclineForm(false);\r\n    }\r\n  };\r\n\r\n  if (currentStatus === \"accepted\") {\r\n    return (\r\n      <div className=\"bg-emerald-50 border border-emerald-200 rounded-xl p-6\">\r\n        <div className=\"flex items-start gap-3\">\r\n          <CheckCircle className=\"w-6 h-6 text-emerald-600 flex-shrink-0 mt-0.5\" />\r\n          <div className=\"flex-1\">\r\n            <h3 className=\"text-lg font-semibold text-emerald-900 mb-2\">Job Pack Accepted</h3>\r\n            <div className=\"space-y-2 text-sm text-emerald-700\">\r\n              {clientAcceptedAt && (\r\n                <p>\r\n                  <span className=\"font-medium\">Accepted on:</span>{\" \"}\r\n                  {new Date(clientAcceptedAt).toLocaleString(\"en-AU\", {\r\n                    day: \"numeric\",\r\n                    month: \"long\",\r\n                    year: \"numeric\",\r\n                    hour: \"numeric\",\r\n                    minute: \"2-digit\",\r\n                  })}\r\n                </p>\r\n              )}\r\n              {clientAcceptedByName && (\r\n                <p>\r\n                  <span className=\"font-medium\">Accepted by:</span> {clientAcceptedByName}\r\n                </p>\r\n              )}\r\n              {quoteNumber && clientAcceptedQuoteVer && (\r\n                <p>\r\n                  <span className=\"font-medium\">Quote:</span> {quoteNumber} v{clientAcceptedQuoteVer}\r\n                </p>\r\n              )}\r\n              {clientAcceptanceNote && (\r\n                <div className=\"mt-3 pt-3 border-t border-emerald-200\">\r\n                  <p className=\"font-medium mb-1\">Your note:</p>\r\n                  <p className=\"text-emerald-600 whitespace-pre-wrap\">{clientAcceptanceNote}</p>\r\n                </div>\r\n              )}\r\n              <p className=\"mt-3 text-emerald-600\">\r\n                Your tradie has been notified and can proceed with the work.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (currentStatus === \"declined\") {\r\n    return (\r\n      <div className=\"bg-rose-50 border border-rose-200 rounded-xl p-6\">\r\n        <div className=\"flex items-start gap-3\">\r\n          <XCircle className=\"w-6 h-6 text-rose-600 flex-shrink-0 mt-0.5\" />\r\n          <div className=\"flex-1\">\r\n            <h3 className=\"text-lg font-semibold text-rose-900 mb-2\">Quote Declined</h3>\r\n            <p className=\"text-rose-700 text-sm mb-3\">\r\n              You have declined this job pack. If you have questions or would like to discuss alternatives, please contact your tradie.\r\n            </p>\r\n            {jobId && (\r\n              <a\r\n                href={`mailto:?subject=Re: Job Pack ${jobId}`}\r\n                className=\"text-sm text-rose-700 underline hover:text-rose-900\"\r\n              >\r\n                Contact your tradie ÔåÆ\r\n              </a>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!canAcceptOrDecline) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6\">\r\n      <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Approve This Job Pack</h2>\r\n      \r\n      {success && (\r\n        <div className=\"mb-4 p-4 bg-emerald-50 border border-emerald-200 rounded-lg\">\r\n          <p className=\"text-sm text-emerald-700\">{success}</p>\r\n        </div>\r\n      )}\r\n\r\n      {error && (\r\n        <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n          <p className=\"text-sm text-red-700\">{error}</p>\r\n        </div>\r\n      )}\r\n\r\n      {!showDeclineForm ? (\r\n        <>\r\n          {isExpired && (\r\n            <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n              <p className=\"text-sm text-red-700 font-medium mb-1\">\r\n                This quote has expired\r\n              </p>\r\n              <p className=\"text-sm text-red-600\">\r\n                Please contact your tradie to get an updated job pack.\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          <p className=\"text-slate-600 mb-6 text-sm\">\r\n            If you&apos;re happy with this job pack and estimate, you can approve it below so your tradie can lock in the job.\r\n          </p>\r\n\r\n          <form onSubmit={handleAccept} className=\"space-y-4\">\r\n            <div>\r\n              <label htmlFor=\"fullName\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Full Name <span className=\"text-red-500\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                id=\"fullName\"\r\n                value={fullName}\r\n                onChange={(e) => setFullName(e.target.value)}\r\n                required\r\n                placeholder=\"Enter your full name\"\r\n                className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                disabled={isAccepting || isDeclining || !canAccept}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-500\">\r\n                This will be recorded as your digital signature.\r\n              </p>\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"acceptanceNote\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Notes <span className=\"text-slate-400\">(optional)</span>\r\n              </label>\r\n              <textarea\r\n                id=\"acceptanceNote\"\r\n                value={acceptanceNote}\r\n                onChange={(e) => setAcceptanceNote(e.target.value)}\r\n                placeholder=\"Any additional notes or comments...\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-y\"\r\n                disabled={isAccepting || isDeclining || !canAccept}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex items-start gap-3 p-4 bg-slate-50 rounded-lg\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"confirmAgreement\"\r\n                checked={confirmAgreement}\r\n                onChange={(e) => setConfirmAgreement(e.target.checked)}\r\n                disabled={isAccepting || isDeclining || !canAccept}\r\n                className=\"mt-1 w-4 h-4 text-amber-600 border-slate-300 rounded focus:ring-amber-500\"\r\n                required\r\n              />\r\n              <label htmlFor=\"confirmAgreement\" className=\"text-sm text-slate-700 flex-1\">\r\n                I confirm I have read and agree to this job pack and authorise the tradie to proceed on this basis.\r\n              </label>\r\n            </div>\r\n\r\n            <div className=\"flex gap-3 pt-2\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={isAccepting || isDeclining || !fullName.trim() || !confirmAgreement || !canAccept}\r\n                className=\"flex-1 inline-flex items-center justify-center px-6 py-3 bg-emerald-500 hover:bg-emerald-400 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                title={isExpired ? \"This quote has expired. Please contact your tradie for an updated job pack.\" : undefined}\r\n              >\r\n                {isAccepting ? (\r\n                  <>\r\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                    Accepting...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\r\n                    Accept Job Pack\r\n                  </>\r\n                )}\r\n              </button>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowDeclineForm(true)}\r\n                disabled={isAccepting || isDeclining}\r\n                className=\"px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors disabled:opacity-50\"\r\n              >\r\n                Decline\r\n              </button>\r\n            </div>\r\n          </form>\r\n        </>\r\n      ) : (\r\n        <form onSubmit={handleDecline} className=\"space-y-4\">\r\n          <div>\r\n            <label htmlFor=\"declineReason\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Reason (Optional)\r\n            </label>\r\n            <textarea\r\n              id=\"declineReason\"\r\n              value={declineReason}\r\n              onChange={(e) => setDeclineReason(e.target.value)}\r\n              placeholder=\"Let your tradie know why you're declining...\"\r\n              rows={3}\r\n              className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 outline-none\"\r\n              disabled={isDeclining}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"flex gap-3 pt-2\">\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isDeclining}\r\n              className=\"flex-1 inline-flex items-center justify-center px-6 py-3 bg-rose-500 hover:bg-rose-400 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isDeclining ? (\r\n                <>\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                  Declining...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <XCircle className=\"w-4 h-4 mr-2\" />\r\n                  Confirm Decline\r\n                </>\r\n              )}\r\n            </button>\r\n\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => {\r\n                setShowDeclineForm(false);\r\n                setDeclineReason(\"\");\r\n                setError(\"\");\r\n              }}\r\n              disabled={isDeclining}\r\n              className=\"px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors disabled:opacity-50\"\r\n            >\r\n              Cancel\r\n            </button>\r\n          </div>\r\n        </form>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\client\\jobs\\[id]\\ClientJobPackView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\client\\jobs\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Job' is defined but never used.","line":4,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { redirect, notFound } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { requireClientUser } from \"@/lib/auth\";\nimport { getJobById, type Job, type ClientStatus } from \"@/lib/jobs\";\nimport ClientJobPackView from \"./ClientJobPackView\";\nimport ClientAcceptanceForm from \"./ClientAcceptanceForm\";\n\n// Authenticated page using requireClientUser - must be dynamic\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction ClientStatusBadge({ status }: { status: ClientStatus }) {\n  const styles: Record<ClientStatus, string> = {\n    draft: \"bg-slate-100 text-slate-700\",\n    sent: \"bg-blue-100 text-blue-700\",\n    accepted: \"bg-emerald-100 text-emerald-700\",\n    declined: \"bg-rose-100 text-rose-700\",\n    cancelled: \"bg-slate-100 text-slate-700\",\n  };\n\n  const labels: Record<ClientStatus, string> = {\n    draft: \"Draft\",\n    sent: \"Quote Sent\",\n    accepted: \"Accepted\",\n    declined: \"Declined\",\n    cancelled: \"Cancelled\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction formatDate(dateString: string): string {\n  return new Date(dateString).toLocaleDateString(\"en-AU\", {\n    day: \"numeric\",\n    month: \"short\",\n    year: \"numeric\",\n  });\n}\n\ninterface ClientJobDetailPageProps {\n  params: Promise<{ id: string }>;\n}\n\nexport default async function ClientJobDetailPage({ params }: ClientJobDetailPageProps) {\n  // Await params (Next.js 16+ requires params to be a Promise)\n  const { id } = await params;\n  const user = await requireClientUser(`/client/jobs/${id}`);\n\n  // Load the job\n  const job = await getJobById(id);\n\n  if (!job) {\n    notFound();\n  }\n\n  // Ensure this job belongs to this client\n  const normalizedClientEmail = user.email.toLowerCase().trim();\n  const jobClientEmail = job.clientEmail?.toLowerCase().trim();\n\n  if (jobClientEmail !== normalizedClientEmail) {\n    // Job doesn't belong to this client\n    redirect(`/client/dashboard`);\n  }\n\n  const clientStatus = (job.clientStatus || \"draft\") as ClientStatus;\n  const hasJobPack = job.status === \"ai_complete\" && job.sentToClientAt;\n  const isAccepted = clientStatus === \"accepted\";\n  const isDeclined = clientStatus === \"declined\";\n\n  // Fetch the tradie's business profile for PDF exports\n  let businessProfile: {\n    legalName?: string;\n    tradingName?: string;\n    abn?: string;\n    email?: string;\n    phone?: string;\n    addressLine1?: string;\n    addressLine2?: string;\n    suburb?: string;\n    state?: string;\n    postcode?: string;\n  } | null = null;\n  \n  try {\n    const { getPrisma } = await import(\"@/lib/prisma\");\n    const prisma = getPrisma();\n    const tradieUser = await prisma.user.findFirst({\n      where: { id: job.userId },\n      select: {\n        businessName: true,\n        tradingName: true,\n        abn: true,\n        email: true,\n        businessPhone: true,\n        businessAddressLine1: true,\n        businessAddressLine2: true,\n        businessSuburb: true,\n        businessState: true,\n        businessPostcode: true,\n      },\n    });\n    if (tradieUser?.businessName) {\n      businessProfile = {\n        legalName: tradieUser.businessName || undefined,\n        tradingName: tradieUser.tradingName || undefined,\n        abn: tradieUser.abn || undefined,\n        email: tradieUser.email || undefined,\n        phone: tradieUser.businessPhone || undefined,\n        addressLine1: tradieUser.businessAddressLine1 || undefined,\n        addressLine2: tradieUser.businessAddressLine2 || undefined,\n        suburb: tradieUser.businessSuburb || undefined,\n        state: tradieUser.businessState || undefined,\n        postcode: tradieUser.businessPostcode || undefined,\n      };\n    }\n  } catch (error) {\n    console.warn(\"Failed to fetch tradie business profile:\", error);\n  }\n\n  return (\n    <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n      {/* Back Link */}\n      <div className=\"mb-6\">\n        <Link\n          href=\"/client/dashboard\"\n          className=\"inline-flex items-center text-sm text-slate-500 hover:text-slate-700\"\n        >\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n          </svg>\n          Back to Dashboard\n        </Link>\n      </div>\n\n      {/* Job Header */}\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8 mb-6\">\n        <div className=\"flex items-start justify-between mb-4\">\n          <div className=\"flex-1\">\n            <h1 className=\"text-3xl font-bold text-slate-900 mb-2\">{job.title}</h1>\n            <p className=\"text-slate-600\">\n              {job.address || \"No address provided\"}\n            </p>\n          </div>\n          <ClientStatusBadge status={clientStatus} />\n        </div>\n\n        {/* Schedule Information */}\n        {(job.scheduledStartAt || job.scheduledEndAt) && (\n          <div className=\"mt-4 pt-4 border-t border-slate-200\">\n            <div className=\"flex items-start gap-3 p-3 bg-blue-50 rounded-lg\">\n              <svg className=\"w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <div>\n                <p className=\"text-sm font-medium text-blue-900 mb-1\">Scheduled Date</p>\n                {job.scheduledStartAt && job.scheduledEndAt ? (\n                  <p className=\"text-sm text-blue-700\">\n                    {new Date(job.scheduledStartAt).toLocaleDateString(\"en-AU\", {\n                      day: \"numeric\",\n                      month: \"long\",\n                      year: \"numeric\",\n                    })} - {new Date(job.scheduledEndAt).toLocaleDateString(\"en-AU\", {\n                      day: \"numeric\",\n                      month: \"long\",\n                      year: \"numeric\",\n                    })}\n                  </p>\n                ) : job.scheduledStartAt ? (\n                  <p className=\"text-sm text-blue-700\">\n                    {new Date(job.scheduledStartAt).toLocaleDateString(\"en-AU\", {\n                      day: \"numeric\",\n                      month: \"long\",\n                      year: \"numeric\",\n                      hour: \"numeric\",\n                      minute: \"2-digit\",\n                      hour12: true,\n                    })}\n                  </p>\n                ) : null}\n              </div>\n            </div>\n          </div>\n        )}\n        {!job.scheduledStartAt && !job.scheduledEndAt && (\n          <div className=\"mt-4 pt-4 border-t border-slate-200\">\n            <div className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg\">\n              <svg className=\"w-5 h-5 text-slate-400 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n              </svg>\n              <div>\n                <p className=\"text-sm text-slate-600\">\n                  Job not scheduled yet ÔÇô your tradie will confirm dates with you.\n                </p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Quote Metadata */}\n        {(job.quoteNumber || job.quoteExpiryAt) && (\n          <div className=\"mt-4 pt-4 border-t border-slate-200\">\n            <div className=\"flex flex-wrap gap-4 text-sm\">\n              {job.quoteNumber && (\n                <div>\n                  <span className=\"text-slate-500\">Quote #:</span>{\" \"}\n                  <span className=\"font-medium text-slate-900\">\n                    {job.quoteNumber}\n                    {job.quoteVersion ? ` v${job.quoteVersion}` : \"\"}\n                  </span>\n                </div>\n              )}\n              {job.quoteExpiryAt && (\n                <div>\n                  <span className=\"text-slate-500\">Valid until:</span>{\" \"}\n                  <span className={`font-medium ${\n                    new Date(job.quoteExpiryAt) < new Date() && !isAccepted\n                      ? \"text-red-600\"\n                      : \"text-slate-900\"\n                  }`}>\n                    {formatDate(job.quoteExpiryAt)}\n                    {new Date(job.quoteExpiryAt) < new Date() && !isAccepted && \" (Expired)\"}\n                  </span>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* Expired Quote Banner */}\n        {job.quoteExpiryAt && \n         new Date(job.quoteExpiryAt) < new Date() && \n         !isAccepted && \n         !isDeclined && (\n          <div className=\"mt-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\n            <div className=\"flex items-start gap-3\">\n              <svg className=\"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n              </svg>\n              <div>\n                <p className=\"text-sm font-semibold text-red-900 mb-1\">\n                  This quote has expired\n                </p>\n                <p className=\"text-sm text-red-800\">\n                  This quote expired on {formatDate(job.quoteExpiryAt)}. Please contact your tradie to get an updated job pack.\n                </p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6 pt-6 border-t border-slate-200\">\n          <div>\n            <p className=\"text-sm text-slate-500 mb-1\">Property Type</p>\n            <p className=\"text-slate-900 font-medium\">{job.propertyType}</p>\n          </div>\n          <div>\n            <p className=\"text-sm text-slate-500 mb-1\">Created</p>\n            <p className=\"text-slate-900 font-medium\">{formatDate(job.createdAt)}</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Job Description */}\n      {job.notes && (\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Job Description</h2>\n          <p className=\"text-slate-700 whitespace-pre-wrap\">{job.notes}</p>\n        </div>\n      )}\n\n      {/* Job Pack / Documents Section */}\n      {hasJobPack ? (\n        <>\n          {/* Full Job Pack View */}\n          <ClientJobPackView job={job} businessProfile={businessProfile} />\n\n          {/* Acceptance Form */}\n          <ClientAcceptanceForm\n            jobId={job.id}\n            currentStatus={clientStatus}\n            clientEmail={user.email}\n            quoteExpiryAt={job.quoteExpiryAt}\n            quoteNumber={job.quoteNumber}\n            quoteVersion={job.quoteVersion}\n            clientAcceptedAt={job.clientAcceptedAt}\n            clientAcceptedByName={job.clientAcceptedByName}\n            clientAcceptanceNote={job.clientAcceptanceNote}\n            clientAcceptedQuoteVer={job.clientAcceptedQuoteVer}\n          />\n        </>\n      ) : (\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Job Pack Status</h2>\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <p className=\"text-slate-900 font-medium mb-1\">Your job pack is being prepared</p>\n              <p className=\"text-slate-600 text-sm\">\n                A tradie will review your job request and send you a quote. You&apos;ll receive an email once it&apos;s ready.\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Scheduled Time (if set) */}\n      {(job.scheduledStartAt || job.scheduledEndAt) && (\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Scheduled Time</h2>\n          <div className=\"space-y-2 text-slate-700\">\n            {job.scheduledStartAt && (\n              <p>\n                <span className=\"font-medium\">Start:</span>{\" \"}\n                {new Date(job.scheduledStartAt).toLocaleString(\"en-AU\", {\n                  day: \"numeric\",\n                  month: \"short\",\n                  year: \"numeric\",\n                  hour: \"2-digit\",\n                  minute: \"2-digit\",\n                })}\n              </p>\n            )}\n            {job.scheduledEndAt && (\n              <p>\n                <span className=\"font-medium\">End:</span>{\" \"}\n                {new Date(job.scheduledEndAt).toLocaleString(\"en-AU\", {\n                  day: \"numeric\",\n                  month: \"short\",\n                  year: \"numeric\",\n                  hour: \"2-digit\",\n                  minute: \"2-digit\",\n                })}\n              </p>\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\client\\jobs\\new\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2196,2199],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2196,2199],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport OvisBadge from \"@/app/components/OvisBadge\";\r\n\r\nconst PROPERTY_TYPES = [\r\n  \"House\",\r\n  \"Unit\",\r\n  \"Townhouse\",\r\n  \"Strata\",\r\n  \"Commercial\",\r\n  \"Other\",\r\n];\r\n\r\nconst TIMEFRAMES = [\r\n  \"ASAP\",\r\n  \"Within 2 weeks\",\r\n  \"Within 1 month\",\r\n  \"Flexible\",\r\n];\r\n\r\nexport default function NewClientJobPage() {\r\n  const router = useRouter();\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [formData, setFormData] = useState({\r\n    title: \"\",\r\n    propertyType: \"\",\r\n    address: \"\",\r\n    suburb: \"\",\r\n    postcode: \"\",\r\n    description: \"\",\r\n    timeframe: \"\",\r\n  });\r\n\r\n  const handleChange = (\r\n    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>\r\n  ) => {\r\n    const { name, value } = e.target;\r\n    setFormData((prev) => ({ ...prev, [name]: value }));\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // Build full address\r\n      const addressParts = [\r\n        formData.address,\r\n        formData.suburb,\r\n        formData.postcode,\r\n      ].filter(Boolean);\r\n      const fullAddress = addressParts.join(\", \");\r\n\r\n      const response = await fetch(\"/api/jobs\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          title: formData.title.trim(),\r\n          propertyType: formData.propertyType,\r\n          address: fullAddress || undefined,\r\n          notes: formData.description.trim() || undefined,\r\n          // Client-specific metadata (can be stored in notes or a separate field)\r\n          timeframe: formData.timeframe || undefined,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Failed to create job request\");\r\n      }\r\n\r\n      // Redirect to client dashboard with success message\r\n      router.push(\"/client/dashboard?created=true\");\r\n    } catch (err: any) {\r\n      setError(err.message || \"An unexpected error occurred\");\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      <div className=\"mb-6\">\r\n        <Link\r\n          href=\"/client/dashboard\"\r\n          className=\"inline-flex items-center text-sm text-slate-500 hover:text-slate-700\"\r\n        >\r\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n          </svg>\r\n          Back to Dashboard\r\n        </Link>\r\n      </div>\r\n\r\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 sm:p-8\">\r\n        <h1 className=\"text-3xl font-bold text-slate-900 mb-2\">Post a New Job Request</h1>\r\n        <p className=\"text-slate-600 mb-8\">\r\n          Tell us about the work you need done. A tradie will review your request and send you a quote.\r\n        </p>\r\n\r\n        {error && (\r\n          <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n          {/* Job Title */}\r\n          <div>\r\n            <label htmlFor=\"title\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Job Title <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              id=\"title\"\r\n              name=\"title\"\r\n              value={formData.title}\r\n              onChange={handleChange}\r\n              required\r\n              placeholder=\"e.g. Paint interior of 3-bedroom house\"\r\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              disabled={isLoading}\r\n            />\r\n          </div>\r\n\r\n          {/* Property Type */}\r\n          <div>\r\n            <label htmlFor=\"propertyType\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Property Type <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <select\r\n              id=\"propertyType\"\r\n              name=\"propertyType\"\r\n              value={formData.propertyType}\r\n              onChange={handleChange}\r\n              required\r\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white\"\r\n              disabled={isLoading}\r\n            >\r\n              <option value=\"\">Select property type...</option>\r\n              {PROPERTY_TYPES.map((type) => (\r\n                <option key={type} value={type}>\r\n                  {type}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          {/* Address Fields */}\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Property Address\r\n            </label>\r\n            <div className=\"space-y-3\">\r\n              <input\r\n                type=\"text\"\r\n                name=\"address\"\r\n                value={formData.address}\r\n                onChange={handleChange}\r\n                placeholder=\"Street address\"\r\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                disabled={isLoading}\r\n              />\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                <input\r\n                  type=\"text\"\r\n                  name=\"suburb\"\r\n                  value={formData.suburb}\r\n                  onChange={handleChange}\r\n                  placeholder=\"Suburb\"\r\n                  className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                  disabled={isLoading}\r\n                />\r\n                <input\r\n                  type=\"text\"\r\n                  name=\"postcode\"\r\n                  value={formData.postcode}\r\n                  onChange={handleChange}\r\n                  placeholder=\"Postcode\"\r\n                  pattern=\"[0-9]{4}\"\r\n                  maxLength={4}\r\n                  className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                  disabled={isLoading}\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Description */}\r\n          <div>\r\n            <label htmlFor=\"description\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Description of Work <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <textarea\r\n              id=\"description\"\r\n              name=\"description\"\r\n              value={formData.description}\r\n              onChange={handleChange}\r\n              required\r\n              rows={6}\r\n              placeholder=\"Describe the work you need done in detail. Include any specific requirements, materials, or preferences...\"\r\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-y\"\r\n              disabled={isLoading}\r\n            />\r\n          </div>\r\n\r\n          {/* Timeframe */}\r\n          <div>\r\n            <label htmlFor=\"timeframe\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Desired Timeframe\r\n            </label>\r\n            <select\r\n              id=\"timeframe\"\r\n              name=\"timeframe\"\r\n              value={formData.timeframe}\r\n              onChange={handleChange}\r\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white\"\r\n              disabled={isLoading}\r\n            >\r\n              <option value=\"\">Select timeframe...</option>\r\n              {TIMEFRAMES.map((timeframe) => (\r\n                <option key={timeframe} value={timeframe}>\r\n                  {timeframe}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          {/* Photo Upload Note */}\r\n          <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\r\n            <p className=\"text-sm text-slate-600\">\r\n              <strong>Note:</strong> Photo uploads will be available soon. For now, please include any important details in the description above.\r\n            </p>\r\n          </div>\r\n\r\n          {/* OVIS Badge */}\r\n          <div className=\"flex items-center justify-center pt-4\">\r\n            <OvisBadge variant=\"card\" size=\"sm\" />\r\n          </div>\r\n\r\n          {/* Submit Button */}\r\n          <div className=\"flex items-center justify-between pt-6 border-t border-slate-200\">\r\n            <Link\r\n              href=\"/client/dashboard\"\r\n              className=\"text-sm text-slate-600 hover:text-slate-700\"\r\n            >\r\n              Cancel\r\n            </Link>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isLoading}\r\n              className=\"inline-flex items-center px-6 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isLoading ? (\r\n                <>\r\n                  <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\r\n                  Submitting...\r\n                </>\r\n              ) : (\r\n                \"Submit Job Request\"\r\n              )}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\clients\\ClientListSearch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\clients\\ClientsListClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\clients\\[id]\\ClientNotesForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1353,1356],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1353,1356],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface Client {\n  id: string;\n  name: string;\n  tags: string | null;\n  notes: string | null;\n}\n\ninterface ClientNotesFormProps {\n  client: Client;\n}\n\nexport default function ClientNotesForm({ client }: ClientNotesFormProps) {\n  const router = useRouter();\n  const [tags, setTags] = useState(client.tags || \"\");\n  const [notes, setNotes] = useState(client.notes || \"\");\n  const [isSaving, setIsSaving] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsSaving(true);\n    setError(\"\");\n    setSuccess(false);\n\n    try {\n      const response = await fetch(`/api/clients/${client.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          tags: tags.trim() || null,\n          notes: notes.trim() || null,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || \"Failed to save\");\n      }\n\n      setSuccess(true);\n      setTimeout(() => {\n        setSuccess(false);\n        router.refresh();\n      }, 1500);\n    } catch (err: any) {\n      setError(err.message || \"Failed to save notes\");\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      {error && (\n        <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700\">\n          {error}\n        </div>\n      )}\n\n      {success && (\n        <div className=\"p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700\">\n          Notes and tags saved successfully\n        </div>\n      )}\n\n      <div>\n        <label htmlFor=\"tags\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n          Tags (comma-separated)\n        </label>\n        <input\n          type=\"text\"\n          id=\"tags\"\n          value={tags}\n          onChange={(e) => setTags(e.target.value)}\n          placeholder=\"e.g., VIP, slow payer, referral\"\n          className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\n          disabled={isSaving}\n        />\n        <p className=\"mt-1 text-xs text-slate-500\">\n          Add tags to categorize this client (e.g., &quot;VIP&quot;, &quot;slow payer&quot;, &quot;referral&quot;)\n        </p>\n      </div>\n\n      <div>\n        <label htmlFor=\"notes\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n          Internal Notes\n        </label>\n        <textarea\n          id=\"notes\"\n          value={notes}\n          onChange={(e) => setNotes(e.target.value)}\n          placeholder=\"Add private notes about this client...\"\n          rows={6}\n          className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors resize-y\"\n          disabled={isSaving}\n        />\n        <p className=\"mt-1 text-xs text-slate-500\">\n          These notes are private and will never be shown to the client\n        </p>\n      </div>\n\n      <div className=\"flex justify-end\">\n        <button\n          type=\"submit\"\n          disabled={isSaving}\n          className=\"px-6 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n        >\n          {isSaving ? (\n            <>\n              <Loader2 className=\"w-4 h-4 animate-spin\" />\n              Saving...\n            </>\n          ) : (\n            \"Save Notes & Tags\"\n          )}\n        </button>\n      </div>\n    </form>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\clients\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateClient' is defined but never used.","line":4,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { redirect, notFound } from \"next/navigation\";\r\nimport { requireActiveUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getClientById, updateClient, getJobsForClient } from \"@/lib/clientCrm\";\r\nimport { formatDateTimeForDisplay } from \"@/lib/format\";\r\nimport OmnexoraHeader from \"@/app/components/OmnexoraHeader\";\r\nimport ClientNotesForm from \"./ClientNotesForm\";\r\n\r\n// Authenticated page using requireActiveUser - must be dynamic\r\nexport const dynamic = \"force-dynamic\";\r\nexport const fetchCache = \"force-no-store\";\r\nexport const revalidate = 0;\r\n\r\ninterface ClientDetailPageProps {\r\n  params: Promise<{ id: string }>;\r\n}\r\n\r\nfunction StatusBadge({ status }: { status: string }) {\r\n  const styles: Record<string, string> = {\r\n    draft: \"bg-slate-100 text-slate-700\",\r\n    ai_pending: \"bg-amber-100 text-amber-700\",\r\n    ai_complete: \"bg-green-100 text-green-700\",\r\n    ai_failed: \"bg-red-100 text-red-700\",\r\n    pending_regeneration: \"bg-orange-100 text-orange-700\",\r\n    generating: \"bg-amber-100 text-amber-700\",\r\n    pending: \"bg-blue-100 text-blue-700\",\r\n    booked: \"bg-purple-100 text-purple-700\",\r\n    completed: \"bg-green-100 text-green-700\",\r\n    cancelled: \"bg-red-100 text-red-700\",\r\n    sent: \"bg-blue-100 text-blue-700\",\r\n    accepted: \"bg-green-100 text-green-700\",\r\n    declined: \"bg-red-100 text-red-700\",\r\n  };\r\n\r\n  const labels: Record<string, string> = {\r\n    draft: \"Draft\",\r\n    ai_pending: \"Generating...\",\r\n    ai_complete: \"Complete\",\r\n    ai_failed: \"Failed\",\r\n    pending_regeneration: \"Needs Update\",\r\n    generating: \"Regenerating...\",\r\n    pending: \"Pending\",\r\n    booked: \"Booked\",\r\n    completed: \"Completed\",\r\n    cancelled: \"Cancelled\",\r\n    sent: \"Sent\",\r\n    accepted: \"Accepted\",\r\n    declined: \"Declined\",\r\n  };\r\n\r\n  return (\r\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status] || \"bg-slate-100 text-slate-700\"}`}>\r\n      {labels[status] || status}\r\n    </span>\r\n  );\r\n}\r\n\r\nexport default async function ClientDetailPage({ params }: ClientDetailPageProps) {\r\n  const user = await requireActiveUser(`/clients/${(await params).id}`);\r\n\r\n  // Redirect clients away from CRM\r\n  if (isClient(user)) {\r\n    redirect(\"/client/dashboard\");\r\n  }\r\n\r\n  const { id: clientId } = await params;\r\n\r\n  // Load client - ensure it belongs to this user (or admin can see all)\r\n  const client = await getClientById(clientId, user.id);\r\n  \r\n  if (!client) {\r\n    // If not found, check if admin can see it\r\n    if (isAdmin(user)) {\r\n      const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\r\n      const adminClient = await prisma.client.findUnique({\r\n        where: { id: clientId },\r\n      });\r\n      if (!adminClient) {\r\n        notFound();\r\n      }\r\n      // Admin can view but we'll use the adminClient\r\n      // For now, redirect to not found - admins can access via owner's view\r\n      notFound();\r\n    } else {\r\n      notFound();\r\n    }\r\n  }\r\n\r\n  // Load jobs for this client\r\n  const jobs = await getJobsForClient(client.id, client.email, user.id);\r\n\r\n  // Calculate stats\r\n  const totalJobs = jobs.length;\r\n  const acceptedJobs = jobs.filter((j) => j.clientStatus === \"accepted\").length;\r\n  const lastJob = jobs[0];\r\n\r\n  return (\r\n    <div className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      {/* Brand Header */}\r\n      <OmnexoraHeader verificationStatus={user.verificationStatus || \"unverified\"} />\r\n\r\n      {/* Back Link */}\r\n      <div className=\"mb-6\">\r\n        <Link\r\n          href=\"/clients\"\r\n          className=\"inline-flex items-center text-sm text-slate-500 hover:text-slate-700\"\r\n        >\r\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n          </svg>\r\n          Back to Clients\r\n        </Link>\r\n      </div>\r\n\r\n      {/* Client Header Card */}\r\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6\">\r\n        <div className=\"flex items-start justify-between mb-4\">\r\n          <div>\r\n            <h1 className=\"text-2xl font-bold text-slate-900\">{client.name}</h1>\r\n            {client.company && (\r\n              <p className=\"text-lg text-slate-600 mt-1\">{client.company}</p>\r\n            )}\r\n          </div>\r\n          {client.tags && (\r\n            <div className=\"flex flex-wrap gap-1\">\r\n              {client.tags.split(\",\").map((tag, idx) => (\r\n                <span\r\n                  key={idx}\r\n                  className=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700\"\r\n                >\r\n                  {tag.trim()}\r\n                </span>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n          {client.email && (\r\n            <div>\r\n              <p className=\"text-xs text-slate-500 mb-1\">Email</p>\r\n              <a\r\n                href={`mailto:${client.email}`}\r\n                className=\"text-sm text-slate-900 hover:text-amber-600 font-medium\"\r\n              >\r\n                {client.email}\r\n              </a>\r\n            </div>\r\n          )}\r\n          {client.phone && (\r\n            <div>\r\n              <p className=\"text-xs text-slate-500 mb-1\">Phone</p>\r\n              <a\r\n                href={`tel:${client.phone}`}\r\n                className=\"text-sm text-slate-900 hover:text-amber-600 font-medium\"\r\n              >\r\n                {client.phone}\r\n              </a>\r\n            </div>\r\n          )}\r\n          {(client.suburb || client.state || client.postcode) && (\r\n            <div>\r\n              <p className=\"text-xs text-slate-500 mb-1\">Location</p>\r\n              <p className=\"text-sm text-slate-900\">\r\n                {[client.suburb, client.state, client.postcode].filter(Boolean).join(\", \")}\r\n              </p>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Internal Notes & Tags Card */}\r\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6\">\r\n        <div className=\"mb-4\">\r\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-1\">Internal Notes & Tags</h2>\r\n          <p className=\"text-xs text-slate-500\">\r\n            Private notes and tags - not visible to the client\r\n          </p>\r\n        </div>\r\n        <ClientNotesForm client={client} />\r\n      </div>\r\n\r\n      {/* Jobs List Card */}\r\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n        <div className=\"px-6 py-4 border-b border-slate-200\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h2 className=\"text-lg font-semibold text-slate-900\">Job History</h2>\r\n              <p className=\"text-sm text-slate-600 mt-1\">\r\n                {totalJobs === 0\r\n                  ? \"No jobs yet\"\r\n                  : `${totalJobs} ${totalJobs === 1 ? \"job\" : \"jobs\"} ÔÇó ${acceptedJobs} accepted`}\r\n                {lastJob && ` ÔÇó Last job: ${formatDateTimeForDisplay(lastJob.createdAt)}`}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {jobs.length === 0 ? (\r\n          <div className=\"p-12 text-center\">\r\n            <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <svg className=\"w-8 h-8 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n              </svg>\r\n            </div>\r\n            <h3 className=\"text-lg font-medium text-slate-900 mb-2\">No jobs yet</h3>\r\n            <p className=\"text-slate-500 mb-6\">\r\n              Jobs for this client will appear here once created.\r\n            </p>\r\n            <Link\r\n              href=\"/jobs/new\"\r\n              className=\"inline-flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors\"\r\n            >\r\n              Create Job for This Client\r\n            </Link>\r\n          </div>\r\n        ) : (\r\n          <div className=\"divide-y divide-slate-200\">\r\n            {jobs.map((job) => (\r\n              <Link\r\n                key={job.id}\r\n                href={`/jobs/${job.id}`}\r\n                className=\"block p-6 hover:bg-slate-50 transition-colors\"\r\n              >\r\n                <div className=\"flex items-start justify-between\">\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">{job.title}</h3>\r\n                    <div className=\"flex flex-wrap gap-3 text-sm text-slate-600\">\r\n                      <span>{job.tradeType} ÔÇó {job.propertyType}</span>\r\n                      {job.address && (\r\n                        <span className=\"text-slate-500\">ÔÇó {job.address}</span>\r\n                      )}\r\n                      <span>ÔÇó {formatDateTimeForDisplay(job.createdAt)}</span>\r\n                    </div>\r\n                    {job.totalInclGst && (\r\n                      <p className=\"text-sm font-medium text-slate-900 mt-2\">\r\n                        Total: ${job.totalInclGst.toLocaleString(\"en-AU\", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"ml-4 flex flex-col gap-2 flex-shrink-0\">\r\n                    {job.jobStatus && <StatusBadge status={job.jobStatus} />}\r\n                    {job.clientStatus && <StatusBadge status={job.clientStatus} />}\r\n                  </div>\r\n                </div>\r\n              </Link>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\clients\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\AIWarningBanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":4,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":4,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { AlertTriangle, Check, X } from \"lucide-react\";\n\ninterface AIWarningBannerProps {\n  /**\n   * Whether to show a confirmation checkbox\n   * If true, user must check the box to acknowledge the warning\n   */\n  requireConfirmation?: boolean;\n  /**\n   * Callback when user confirms/acknowledges\n   */\n  onConfirm?: (confirmed: boolean) => void;\n  /**\n   * Compact variant for smaller spaces\n   */\n  variant?: \"default\" | \"compact\";\n  /**\n   * Custom message (optional)\n   */\n  customMessage?: string;\n}\n\nexport default function AIWarningBanner({\n  requireConfirmation = false,\n  onConfirm,\n  variant = \"default\",\n  customMessage,\n}: AIWarningBannerProps) {\n  const [confirmed, setConfirmed] = useState(false);\n\n  const defaultMessage = \"This content has been generated by AI and must be reviewed by you before use. You are responsible for ensuring compliance with all applicable Australian laws and regulations, including but not limited to building codes, safety standards, workplace health and safety requirements, and consumer protection laws.\";\n\n  const message = customMessage || defaultMessage;\n\n  const handleCheckboxChange = (checked: boolean) => {\n    setConfirmed(checked);\n    if (onConfirm) {\n      onConfirm(checked);\n    }\n  };\n\n  if (variant === \"compact\") {\n    return (\n      <div className=\"p-3 bg-amber-50 border border-amber-200 rounded-lg\">\n        <div className=\"flex items-start gap-2\">\n          <AlertTriangle className=\"w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0\" />\n          <div className=\"flex-1\">\n            <p className=\"text-xs font-medium text-amber-900 mb-1\">\n              AI-Generated Content\n            </p>\n            <p className=\"text-xs text-amber-800\">\n              {message}\n            </p>\n            {requireConfirmation && (\n              <label className=\"flex items-center gap-2 mt-2 cursor-pointer\">\n                <input\n                  type=\"checkbox\"\n                  checked={confirmed}\n                  onChange={(e) => handleCheckboxChange(e.target.checked)}\n                  className=\"w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500\"\n                />\n                <span className=\"text-xs text-amber-900 font-medium\">\n                  I acknowledge that I have reviewed this AI-generated content and verified its compliance with Australian laws and regulations\n                </span>\n              </label>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-4 bg-amber-50 border-l-4 border-amber-500 rounded-lg\">\n      <div className=\"flex items-start gap-3\">\n        <AlertTriangle className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" />\n        <div className=\"flex-1\">\n          <h4 className=\"text-sm font-semibold text-amber-900 mb-2\">\n            ÔÜá´©Å AI-Generated Content Warning\n          </h4>\n          <p className=\"text-sm text-amber-800 mb-3\">\n            {message}\n          </p>\n          {requireConfirmation && (\n            <label className=\"flex items-start gap-3 cursor-pointer group\">\n              <input\n                type=\"checkbox\"\n                checked={confirmed}\n                onChange={(e) => handleCheckboxChange(e.target.checked)}\n                className=\"mt-0.5 w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500 flex-shrink-0\"\n              />\n              <span className=\"text-sm text-amber-900 font-medium group-hover:text-amber-950\">\n                I acknowledge that I have reviewed this AI-generated content and verified its accuracy and compliance with all applicable Australian laws and regulations before use.\n              </span>\n            </label>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\EmailVerificationBanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1124,1127],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1124,1127],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { X, Mail, Loader2 } from \"lucide-react\";\r\n\r\ninterface EmailVerificationBannerProps {\r\n  userEmail: string;\r\n}\r\n\r\nexport default function EmailVerificationBanner({ userEmail }: EmailVerificationBannerProps) {\r\n  const [isResending, setIsResending] = useState(false);\r\n  const [isDismissed, setIsDismissed] = useState(false);\r\n  const [resendSuccess, setResendSuccess] = useState(false);\r\n\r\n  const handleResend = async () => {\r\n    setIsResending(true);\r\n    setResendSuccess(false);\r\n    try {\r\n      const response = await fetch(\"/api/auth/send-verification-email\", {\r\n        method: \"POST\",\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        if (data.alreadyVerified) {\r\n          // User verified in another tab/window, refresh page\r\n          window.location.reload();\r\n          return;\r\n        }\r\n        throw new Error(data.error || \"Failed to resend verification email\");\r\n      }\r\n\r\n      setResendSuccess(true);\r\n      setTimeout(() => {\r\n        setResendSuccess(false);\r\n      }, 5000);\r\n    } catch (err: any) {\r\n      alert(err.message || \"Failed to resend verification email. Please try again.\");\r\n    } finally {\r\n      setIsResending(false);\r\n    }\r\n  };\r\n\r\n  if (isDismissed) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl\">\r\n      <div className=\"flex items-start gap-3\">\r\n        <Mail className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" />\r\n        <div className=\"flex-1 min-w-0\">\r\n          <p className=\"font-medium text-amber-900 mb-1\">\r\n            Your email is not verified\r\n          </p>\r\n          <p className=\"text-sm text-amber-800 mb-3\">\r\n            Some features may be limited. Please verify your email address ({userEmail}) to unlock all features.\r\n          </p>\r\n          <div className=\"flex items-center gap-2 flex-wrap\">\r\n            <button\r\n              onClick={handleResend}\r\n              disabled={isResending}\r\n              className=\"inline-flex items-center px-3 py-1.5 text-sm font-medium text-amber-900 bg-amber-100 hover:bg-amber-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isResending ? (\r\n                <>\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                  Sending...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Mail className=\"w-4 h-4 mr-2\" />\r\n                  Resend verification email\r\n                </>\r\n              )}\r\n            </button>\r\n            {resendSuccess && (\r\n              <span className=\"text-sm text-amber-700\">\r\n                Ô£ô Verification email sent! Check your inbox.\r\n              </span>\r\n            )}\r\n          </div>\r\n        </div>\r\n        <button\r\n          onClick={() => setIsDismissed(true)}\r\n          className=\"p-1 text-amber-600 hover:text-amber-800 transition-colors flex-shrink-0\"\r\n          aria-label=\"Dismiss\"\r\n        >\r\n          <X className=\"w-4 h-4\" />\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\FeedbackButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\Footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\ImpersonationBanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setImpersonatedUser' is assigned a value but never used.","line":9,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":20,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nexport default function ImpersonationBanner() {\r\n  const router = useRouter();\r\n  const [isImpersonating, setIsImpersonating] = useState(false);\r\n  const [impersonatedUser, setImpersonatedUser] = useState<{ email: string; businessName?: string } | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    checkImpersonationStatus();\r\n  }, []);\r\n\r\n  const checkImpersonationStatus = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/auth/me\");\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        // Check if we have impersonation flag in session\r\n        // For now, we'll detect it by checking if current user != real admin\r\n        // We'll enhance this with a dedicated endpoint later\r\n        setIsImpersonating(false); // Placeholder - will be enhanced\r\n      }\r\n    } catch {\r\n      // Ignore errors\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleStopImpersonating = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/impersonate\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ action: \"stop\" }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        router.refresh();\r\n        router.push(\"/admin/users\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to stop impersonation:\", error);\r\n    }\r\n  };\r\n\r\n  if (isLoading || !isImpersonating) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-amber-500 border-b border-amber-600 px-4 py-3\">\r\n      <div className=\"max-w-7xl mx-auto flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <svg className=\"w-5 h-5 text-amber-900\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\r\n          </svg>\r\n          <p className=\"text-sm font-medium text-amber-900\">\r\n            You are currently acting as:{\" \"}\r\n            <span className=\"font-semibold\">\r\n              {impersonatedUser?.email}\r\n              {impersonatedUser?.businessName && ` (${impersonatedUser.businessName})`}\r\n            </span>\r\n          </p>\r\n        </div>\r\n        <button\r\n          onClick={handleStopImpersonating}\r\n          className=\"px-4 py-1.5 bg-amber-700 hover:bg-amber-800 text-white text-sm font-medium rounded-lg transition-colors\"\r\n        >\r\n          Stop Impersonating\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\Navbar.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[512,515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[512,515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[760,763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[760,763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCurrentUser } from \"@/lib/auth\";\nimport { unstable_noStore as noStore } from \"next/cache\";\nimport NavbarClient from \"./NavbarClient\";\n\n// Force dynamic rendering to prevent static caching of auth state\n// This ensures the navbar always shows current user info\nexport const dynamic = \"force-dynamic\";\n\nexport default async function Navbar() {\n  // Prevent static caching - always fetch fresh user data\n  noStore();\n  \n  let user = null;\n  \n  try {\n    user = await getCurrentUser();\n  } catch (error: any) {\n    // Handle DYNAMIC_SERVER_USAGE errors silently (expected during build/static generation)\n    // Swallow these errors - do NOT log them\n    if (\n      error &&\n      typeof error === \"object\" &&\n      \"digest\" in error &&\n      (error as any).digest === \"DYNAMIC_SERVER_USAGE\"\n    ) {\n      user = null;\n    } else if (error?.message?.includes(\"Dynamic server usage\") || error?.message?.includes(\"couldn't be rendered statically\")) {\n      user = null;\n    } else {\n      // For other errors, log but don't crash - show logged-out state instead\n      console.error(\"Failed to get current user:\", error);\n    }\n  }\n\n  const isDemoMode = process.env.DEMO_MODE === \"true\";\n\n  return (\n    <NavbarClient\n      user={user ? { \n        email: user.email,\n        role: user.role || \"tradie\",\n        verificationStatus: user.verificationStatus || \"unverified\",\n        verifiedAt: user.verifiedAt ?? null,\n        isAdmin: user.isAdmin ?? false,\n      } : null}\n      isDemoMode={isDemoMode}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\NavbarClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\OmnexoraHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\OnboardingCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\OnboardingChecklist.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\OvisBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\OvisModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\PaginationControls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\StructuredBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\docs\\DocEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RenderSection' is defined but never used.","line":6,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RenderField' is defined but never used.","line":6,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":63},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RenderTable' is defined but never used.","line":6,"column":65,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":76},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'onSave' is defined but never used.","line":39,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saving' is assigned a value but never used.","line":50,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":50,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'issuer' is assigned a value but never used.","line":63,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":63,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadDocument'. Either include it or remove the dependency array.","line":86,"column":6,"nodeType":"ArrayExpression","endLine":86,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [jobId, docType, loadDocument]","fix":{"range":[2886,2902],"text":"[jobId, docType, loadDocument]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3848,3851],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3848,3851],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5009,5012],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5009,5012],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":200,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6561,6564],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6561,6564],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'saveDraft'. Either include it or remove the dependency array.","line":222,"column":6,"nodeType":"ArrayExpression","endLine":222,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [saveDraft]","fix":{"range":[7134,7136],"text":"[saveDraft]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":237,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7600,7603],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7600,7603],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":258,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":258,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8309,8312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8309,8312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":264,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":264,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8533,8536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8533,8536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":273,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":273,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8972,8975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8972,8975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":277,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":277,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9144,9147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9144,9147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":295,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9764,9767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9764,9767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":340,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":340,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10906,10909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10906,10909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":389,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":389,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12326,12329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12326,12329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":19,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useCallback, useRef } from \"react\";\nimport { X, Save, AlertCircle, Loader2, RefreshCw, Copy, Mail, Download, Lock, Check, FileCheck, Building2 } from \"lucide-react\";\nimport DocPreview from \"./DocPreview\";\nimport type { RenderModel, DocType, RenderSection, RenderField, RenderTable, DocumentStatus, IssuerProfile } from \"@/lib/docEngine/types\";\nimport { featureFlags } from \"@/lib/featureFlags\";\nimport { hasDocumentFeatureAccess } from \"@/lib/documentAccess\";\nimport type { SafeUser } from \"@/lib/auth\";\n\ninterface DocEditorProps {\n  jobId: string;\n  docType: DocType;\n  onClose: () => void;\n  onSave?: (model: RenderModel) => void;\n  user?: SafeUser | null;\n  planTier?: string;\n  planStatus?: string;\n  clientEmail?: string;\n  clientName?: string;\n  jobTitle?: string;\n  address?: string;\n}\n\n/**\n * Document Editor Component\n * \n * Provides a full-screen editor for document templates with:\n * - Pre-filled data from job/client/company\n * - Inline editing of all fields\n * - Auto-save on debounce\n * - OVIS warnings display\n * - Regenerate from job pack (non-destructive merge)\n */\nexport default function DocEditor({ \n  jobId, \n  docType, \n  onClose, \n  onSave,\n  user = null,\n  planTier = \"FREE\",\n  planStatus = \"TRIAL\",\n  clientEmail = \"\",\n  clientName = \"\",\n  jobTitle = \"\",\n  address = \"\",\n}: DocEditorProps) {\n  const [model, setModel] = useState<RenderModel | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [saveStatus, setSaveStatus] = useState<\"idle\" | \"saving\" | \"saved\" | \"error\">(\"idle\");\n  const [copied, setCopied] = useState(false);\n  const [downloading, setDownloading] = useState(false);\n  const [approved, setApproved] = useState(false);\n  const [approving, setApproving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [regenerating, setRegenerating] = useState(false);\n  \n  // Document lifecycle state\n  const [docStatus, setDocStatus] = useState<DocumentStatus>(\"DRAFT\");\n  const [issuedRecordId, setIssuedRecordId] = useState<string | null>(null);\n  const [issuedAt, setIssuedAt] = useState<string | null>(null);\n  const [issuer, setIssuer] = useState<IssuerProfile | null>(null);\n  \n  // Issue modal state\n  const [showIssueModal, setShowIssueModal] = useState(false);\n  const [issuing, setIssuing] = useState(false);\n  const [issueValidation, setIssueValidation] = useState<{\n    missingRequired: string[];\n    missingRecommended: string[];\n    warnings: string[];\n  } | null>(null);\n  \n  const saveTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const hasUnsavedChanges = useRef(false);\n\n  // Load draft or generate new\n  useEffect(() => {\n    if (!featureFlags.DOC_ENGINE_V1) {\n      setError(\"Document engine V1 is not enabled\");\n      setLoading(false);\n      return;\n    }\n\n    loadDocument();\n  }, [jobId, docType]);\n\n  const loadDocument = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n\n      // Try to load existing draft\n      const draftResponse = await fetch(\n        `/api/docs/draft?jobId=${encodeURIComponent(jobId)}&docType=${encodeURIComponent(docType)}`\n      );\n\n      if (draftResponse.ok) {\n        const draftData = await draftResponse.json();\n        if (draftData.draft?.data) {\n          setModel(draftData.draft.data);\n          setApproved(draftData.draft.approved ?? false);\n          // Set lifecycle state\n          setDocStatus(draftData.draft.status ?? \"DRAFT\");\n          setIssuedRecordId(draftData.draft.issuedRecordId ?? null);\n          setIssuedAt(draftData.draft.issuedAt ?? null);\n          setIssuer(draftData.draft.issuer ?? null);\n          setLoading(false);\n          return;\n        }\n      }\n\n      // No draft exists, generate from template\n      await generateFromTemplate();\n    } catch (err: any) {\n      console.error(\"[DocEditor] Load error:\", err);\n      setError(err?.message || \"Failed to load document\");\n      setLoading(false);\n    }\n  };\n\n  const generateFromTemplate = async () => {\n    try {\n      setLoading(true);\n      \n      // Call the prefill API endpoint\n      // Default: exclude markup for client-facing documents (includeMaterialsMarkup: false)\n      const response = await fetch(`/api/docs/prefill`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ \n          jobId, \n          docType,\n          includeMaterialsMarkup: false, // Default: exclude markup for client-facing docs\n        }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to generate document\");\n      }\n\n      const data = await response.json();\n      if (data.model) {\n        setModel(data.model);\n        hasUnsavedChanges.current = true;\n        // Auto-save the generated model\n        await saveDraft(data.model);\n      } else {\n        throw new Error(\"No model returned from prefill\");\n      }\n    } catch (err: any) {\n      console.error(\"[DocEditor] Generate error:\", err);\n      const errorMessage = err?.message || \"Failed to generate document\";\n      \n      // Provide more helpful error messages\n      if (errorMessage.includes(\"Document engine V1 is not enabled\")) {\n        setError(\"Document engine is not enabled. Please enable DOC_ENGINE_V1 feature flag.\");\n      } else if (errorMessage.includes(\"Unauthorized\") || errorMessage.includes(\"Forbidden\")) {\n        setError(\"You don't have permission to generate this document.\");\n      } else if (errorMessage.includes(\"Job not found\")) {\n        setError(\"Job not found. Please refresh the page and try again.\");\n      } else {\n        setError(errorMessage);\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const saveDraft = async (modelToSave: RenderModel) => {\n    try {\n      setSaving(true);\n      setSaveStatus(\"saving\");\n\n      const response = await fetch(`/api/docs/draft`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          jobId,\n          docType,\n          data: modelToSave,\n        }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to save draft\");\n      }\n\n      setSaveStatus(\"saved\");\n      hasUnsavedChanges.current = false;\n      \n      // Clear saved status after 2 seconds\n      setTimeout(() => {\n        if (saveStatus === \"saved\") {\n          setSaveStatus(\"idle\");\n        }\n      }, 2000);\n    } catch (err: any) {\n      console.error(\"[DocEditor] Save error:\", err);\n      setSaveStatus(\"error\");\n      setError(err?.message || \"Failed to save draft\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleModelChange = useCallback((updatedModel: RenderModel) => {\n    setModel(updatedModel);\n    hasUnsavedChanges.current = true;\n    setSaveStatus(\"idle\");\n\n    // Debounce auto-save\n    if (saveTimeoutRef.current) {\n      clearTimeout(saveTimeoutRef.current);\n    }\n\n    saveTimeoutRef.current = setTimeout(() => {\n      saveDraft(updatedModel);\n    }, 800);\n  }, []);\n\n  const handleRegenerate = async () => {\n    if (!confirm(\"Regenerate from Job Pack? This will only fill empty fields and won't overwrite your edits.\")) {\n      return;\n    }\n\n    try {\n      setRegenerating(true);\n      setError(null);\n\n      // Load current model for merge\n      const currentModel = model;\n      \n      // Generate fresh model (preserve markup preference from current model if available)\n      const currentIncludeMarkup = (currentModel as any)?.includeMaterialsMarkup ?? false;\n      const response = await fetch(`/api/docs/prefill`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ \n          jobId, \n          docType,\n          includeMaterialsMarkup: currentIncludeMarkup,\n        }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to regenerate\");\n      }\n\n      const freshModel = await response.json().then((d) => d.model);\n\n      // Non-destructive merge: only fill empty fields\n      const mergedModel: RenderModel = {\n        ...freshModel,\n        sections: freshModel.sections.map((section: any, idx: number) => {\n          const currentSection = currentModel?.sections[idx];\n          if (!currentSection) return section;\n\n          return {\n            ...section,\n            fields: section.fields?.map((field: any, fIdx: number) => {\n              const currentField = currentSection.fields?.[fIdx];\n              if (currentField && currentField.value !== null && currentField.value !== \"\") {\n                return currentField; // Keep user's value\n              }\n              return field; // Use fresh value\n            }),\n            table: section.table ? {\n              ...section.table,\n              rows: section.table.rows.map((row: any, rIdx: number) => {\n                const currentRow = currentSection.table?.rows[rIdx];\n                if (!currentRow) return row;\n\n                const mergedRow: any = {};\n                Object.keys(row).forEach((key) => {\n                  const currentValue = currentRow[key];\n                  if (currentValue !== null && currentValue !== \"\" && currentValue !== undefined) {\n                    mergedRow[key] = currentValue; // Keep user's value\n                  } else {\n                    mergedRow[key] = row[key]; // Use fresh value\n                  }\n                });\n                return mergedRow;\n              }),\n            } : undefined,\n          };\n        }),\n      };\n\n      setModel(mergedModel);\n      await saveDraft(mergedModel);\n    } catch (err: any) {\n      console.error(\"[DocEditor] Regenerate error:\", err);\n      setError(err?.message || \"Failed to regenerate document\");\n    } finally {\n      setRegenerating(false);\n    }\n  };\n\n  const handleClose = () => {\n    if (hasUnsavedChanges.current) {\n      if (!confirm(\"You have unsaved changes. Are you sure you want to close?\")) {\n        return;\n      }\n    }\n    onClose();\n  };\n\n  // Approve document (hides warnings in exports)\n  const handleApprove = async () => {\n    if (!model) return;\n    \n    if (!confirm(\"Approve this document? Warnings will be hidden in PDFs and exports.\")) {\n      return;\n    }\n\n    setApproving(true);\n    try {\n      // Save approval status to draft\n      const response = await fetch(`/api/docs/draft`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          jobId,\n          docType,\n          data: model,\n          approved: true,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to approve document\");\n      }\n\n      setApproved(true);\n      hasUnsavedChanges.current = false;\n    } catch (err: any) {\n      console.error(\"Failed to approve:\", err);\n      setError(err?.message || \"Failed to approve document\");\n    } finally {\n      setApproving(false);\n    }\n  };\n\n  // Issue document for client export\n  const handleIssue = async () => {\n    if (!model) return;\n    \n    setIssuing(true);\n    setIssueValidation(null);\n    \n    try {\n      const response = await fetch(`/api/docs/issue`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          jobId,\n          docType,\n          strict: true, // Require all mandatory fields\n        }),\n      });\n\n      const data = await response.json();\n      \n      if (!response.ok) {\n        // Check if it's a validation error with missing fields\n        if (data.validation) {\n          setIssueValidation(data.validation);\n        }\n        throw new Error(data.error || \"Failed to issue document\");\n      }\n\n      // Success - update state\n      setDocStatus(\"ISSUED\");\n      setIssuedRecordId(data.draft.issuedRecordId);\n      setIssuedAt(data.draft.issuedAt);\n      setIssuer(data.issuer);\n      setApproved(true);\n      setShowIssueModal(false);\n      hasUnsavedChanges.current = false;\n      \n      // Show warnings if any\n      if (data.validation?.warnings?.length > 0) {\n        alert(`Document issued successfully!\\n\\nNote: ${data.validation.warnings.join(\"\\n\")}`);\n      }\n    } catch (err: any) {\n      console.error(\"Failed to issue:\", err);\n      // Don't close modal on error - show the validation feedback\n      if (!issueValidation) {\n        setError(err?.message || \"Failed to issue document\");\n      }\n    } finally {\n      setIssuing(false);\n    }\n  };\n\n  // Convert RenderModel to plain text for copying/emailing (excludes warnings if approved)\n  const modelToText = useCallback((model: RenderModel, isApproved: boolean): string => {\n    const lines: string[] = [];\n    \n    lines.push(model.title);\n    lines.push(\"\");\n    lines.push(`Record ID: ${model.recordId}`);\n    lines.push(`Generated: ${new Date(model.timestamp).toLocaleString(\"en-AU\")}`);\n    lines.push(\"\");\n    lines.push(\"---\");\n    lines.push(\"\");\n    \n    model.sections.forEach((section) => {\n      if (section.title) {\n        lines.push(section.title.toUpperCase());\n        lines.push(\"\");\n      }\n      \n      // Add fields\n      if (section.fields && section.fields.length > 0) {\n        section.fields.forEach((field) => {\n          const value = field.value !== null && field.value !== undefined ? String(field.value) : \"\";\n          if (value || field.required) {\n            lines.push(`${field.label}: ${value || \"[Required]\"}`);\n          }\n        });\n        lines.push(\"\");\n      }\n      \n      // Add table\n      if (section.table && section.table.rows.length > 0) {\n        const columns = section.table.columns;\n        const headers = columns.map((col) => col.label).join(\" | \");\n        lines.push(headers);\n        lines.push(\"-\".repeat(headers.length));\n        \n        section.table.rows.forEach((row) => {\n          const rowValues = columns.map((col) => {\n            const value = row[col.id];\n            return value !== null && value !== undefined ? String(value) : \"\";\n          });\n          lines.push(rowValues.join(\" | \"));\n        });\n        lines.push(\"\");\n      }\n    });\n    \n    // Only include disclaimer if not approved\n    if (!isApproved) {\n      lines.push(\"---\");\n      lines.push(\"\");\n      lines.push(model.disclaimer);\n    }\n    \n    return lines.join(\"\\n\");\n  }, []);\n\n  // Check access for document features\n  const hasAccess = hasDocumentFeatureAccess(user, { planTier, planStatus, isAdmin: user?.isAdmin ?? false });\n  const accessMessage = \"A paid plan or pilot program membership is required. Free users can create job packs only.\";\n\n  // Copy document text\n  const handleCopy = useCallback(async () => {\n    if (!model) return;\n    \n    try {\n      const text = modelToText(model, approved);\n      await navigator.clipboard.writeText(text);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      console.error(\"Failed to copy:\", err);\n    }\n  }, [model, modelToText, approved]);\n\n  // Email document to client\n  const handleEmail = useCallback(() => {\n    if (!hasAccess) {\n      alert(accessMessage);\n      return;\n    }\n\n    if (!clientEmail) {\n      alert(\"Client email not set for this job\");\n      return;\n    }\n\n    if (!model) {\n      alert(\"No document content to email\");\n      return;\n    }\n\n    const text = modelToText(model, approved);\n    const docLabel = model.title;\n    const subject = `${docLabel} - ${jobTitle || \"Job\"}`;\n    const body = `Hi ${clientName || \"there\"},\\n\\nPlease find the ${docLabel.toLowerCase()} for the following job:\\n\\nJob: ${jobTitle || \"N/A\"}\\n${address ? `Address: ${address}\\n` : \"\"}\\n---\\n\\n${text}\\n\\n---\\n\\nKind regards`;\n    \n    const mailtoUrl = `mailto:${encodeURIComponent(clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n    window.location.href = mailtoUrl;\n  }, [model, hasAccess, accessMessage, clientEmail, clientName, jobTitle, address, modelToText, approved]);\n\n  // Download PDF (internal draft)\n  const handleDownloadPdf = useCallback(async (audience: \"INTERNAL\" | \"CLIENT\" = \"INTERNAL\") => {\n    if (!hasAccess) {\n      alert(accessMessage);\n      return;\n    }\n\n    if (!model) {\n      alert(\"No document content to download\");\n      return;\n    }\n\n    // For CLIENT export, must be issued or have valid issuer profile\n    if (audience === \"CLIENT\" && docStatus !== \"ISSUED\") {\n      setShowIssueModal(true);\n      return;\n    }\n\n    setDownloading(true);\n    try {\n      const response = await fetch(`/api/docs/render`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          jobId,\n          docType,\n          recordId: model.recordId,\n          renderModel: model,\n          audience,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ error: \"Failed to generate PDF\" }));\n        throw new Error(errorData.error || \"Failed to generate PDF\");\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      const filenameId = (audience === \"CLIENT\" && issuedRecordId) ? issuedRecordId : model.recordId;\n      a.download = `${docType.toLowerCase()}-${filenameId}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (err) {\n      console.error(\"Failed to download PDF:\", err);\n      alert(err instanceof Error ? err.message : \"Failed to download PDF\");\n    } finally {\n      setDownloading(false);\n    }\n  }, [model, hasAccess, accessMessage, jobId, docType, docStatus, issuedRecordId]);\n\n  useEffect(() => {\n    return () => {\n      if (saveTimeoutRef.current) {\n        clearTimeout(saveTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  if (loading) {\n    return (\n      <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n        <div className=\"bg-white rounded-lg p-8 flex flex-col items-center gap-4\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-blue-600\" />\n          <p className=\"text-slate-600\">Loading document...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error && !model) {\n    return (\n      <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n        <div className=\"bg-white rounded-lg p-8 max-w-md\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <AlertCircle className=\"w-6 h-6 text-red-600\" />\n            <h2 className=\"text-lg font-semibold text-slate-900\">Error</h2>\n          </div>\n          <p className=\"text-slate-600 mb-6\">{error}</p>\n          {error.includes(\"Document engine V1 is not enabled\") && (\n            <div className=\"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg\">\n              <p className=\"text-sm text-amber-800\">\n                <strong>Note:</strong> The template-driven document engine requires the DOC_ENGINE_V1 feature flag to be enabled.\n                <br />\n                <br />\n                Add <code className=\"bg-amber-100 px-1 rounded\">DOC_ENGINE_V1=true</code> to your <code className=\"bg-amber-100 px-1 rounded\">.env.local</code> file and restart the server.\n              </p>\n            </div>\n          )}\n          <div className=\"flex gap-3\">\n            <button\n              onClick={handleClose}\n              className=\"px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300\"\n            >\n              Close\n            </button>\n            <button\n              onClick={loadDocument}\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\n            >\n              Retry\n            </button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!model) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-slate-50 z-50 flex flex-col\">\n      {/* Header */}\n      <div className=\"bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <h2 className=\"text-xl font-semibold text-slate-900\">{model.title}</h2>\n          {/* Document status badge */}\n          {docStatus === \"ISSUED\" ? (\n            <span className=\"px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded flex items-center gap-1\">\n              <FileCheck className=\"w-3 h-3\" />\n              Issued for Client\n            </span>\n          ) : approved ? (\n            <span className=\"px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded\">\n              Approved\n            </span>\n          ) : (\n            <span className=\"px-2 py-1 bg-amber-100 text-amber-800 text-xs font-medium rounded\">\n              Draft ÔÇô Review required\n            </span>\n          )}\n          {saveStatus === \"saving\" && (\n            <span className=\"text-sm text-slate-500 flex items-center gap-2\">\n              <Loader2 className=\"w-4 h-4 animate-spin\" />\n              Saving...\n            </span>\n          )}\n          {saveStatus === \"saved\" && (\n            <span className=\"text-sm text-green-600 flex items-center gap-2\">\n              <Save className=\"w-4 h-4\" />\n              Saved\n            </span>\n          )}\n          {saveStatus === \"error\" && (\n            <span className=\"text-sm text-red-600\">Save failed</span>\n          )}\n        </div>\n        <div className=\"flex items-center gap-3\">\n          {/* Copy Button - Always available */}\n          <button\n            onClick={handleCopy}\n            disabled={!model}\n            className=\"px-3 py-2 text-sm bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 flex items-center gap-2\"\n            title=\"Copy document text\"\n          >\n            {copied ? (\n              <>\n                <Check className=\"w-4 h-4\" />\n                Copied\n              </>\n            ) : (\n              <>\n                <Copy className=\"w-4 h-4\" />\n                Copy\n              </>\n            )}\n          </button>\n          \n          {/* Email Button - Requires access */}\n          <button\n            onClick={handleEmail}\n            disabled={!hasAccess || !clientEmail || !model}\n            className=\"px-3 py-2 text-sm bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n            title={!hasAccess ? accessMessage : !clientEmail ? \"Client email not set\" : \"Email to client\"}\n          >\n            {!hasAccess ? (\n              <>\n                <Lock className=\"w-4 h-4\" />\n                Email\n              </>\n            ) : (\n              <>\n                <Mail className=\"w-4 h-4\" />\n                Email\n              </>\n            )}\n          </button>\n          \n          {/* Download Internal PDF Button */}\n          <button\n            onClick={() => handleDownloadPdf(\"INTERNAL\")}\n            disabled={!hasAccess || downloading || !model}\n            className=\"px-3 py-2 text-sm bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n            title={!hasAccess ? accessMessage : \"Download draft PDF (internal use)\"}\n          >\n            {downloading ? (\n              <>\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n                Downloading...\n              </>\n            ) : !hasAccess ? (\n              <>\n                <Lock className=\"w-4 h-4\" />\n                Draft PDF\n              </>\n            ) : (\n              <>\n                <Download className=\"w-4 h-4\" />\n                Draft PDF\n              </>\n            )}\n          </button>\n          \n          {/* Issue / Export Client PDF Button */}\n          {docStatus === \"ISSUED\" ? (\n            <button\n              onClick={() => handleDownloadPdf(\"CLIENT\")}\n              disabled={!hasAccess || downloading || !model}\n              className=\"px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              title=\"Export client-facing PDF\"\n            >\n              <FileCheck className=\"w-4 h-4\" />\n              Client PDF\n            </button>\n          ) : (\n            <button\n              onClick={() => setShowIssueModal(true)}\n              disabled={!hasAccess || !model}\n              className=\"px-3 py-2 text-sm bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              title=\"Issue document for client export\"\n            >\n              <Building2 className=\"w-4 h-4\" />\n              Issue for Client\n            </button>\n          )}\n          \n          {!approved && docStatus !== \"ISSUED\" && (\n            <button\n              onClick={handleApprove}\n              disabled={approving}\n              className=\"px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center gap-2\"\n              title=\"Approve document to hide warnings in exports\"\n            >\n              {approving ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  Approving...\n                </>\n              ) : (\n                <>\n                  <Check className=\"w-4 h-4\" />\n                  Approve\n                </>\n              )}\n            </button>\n          )}\n          <button\n            onClick={handleRegenerate}\n            disabled={regenerating}\n            className=\"px-3 py-2 text-sm bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 disabled:opacity-50 flex items-center gap-2\"\n          >\n            <RefreshCw className={`w-4 h-4 ${regenerating ? \"animate-spin\" : \"\"}`} />\n            Regenerate\n          </button>\n          <button\n            onClick={handleClose}\n            className=\"p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg\"\n          >\n            <X className=\"w-5 h-5\" />\n          </button>\n        </div>\n      </div>\n\n      {/* OVIS Warnings - Only show if not approved */}\n      {!approved && model.ovisWarnings && model.ovisWarnings.length > 0 && (\n        <div className=\"bg-amber-50 border-b border-amber-200 px-6 py-3\">\n          <div className=\"flex items-start gap-3\">\n            <AlertCircle className=\"w-5 h-5 text-amber-600 mt-0.5\" />\n            <div className=\"flex-1\">\n              <p className=\"text-sm font-medium text-amber-900 mb-1\">\n                OVIS (Output Variance & Integrity Signals)\n              </p>\n              <p className=\"text-xs text-amber-800 mb-2\">\n                OVIS highlights possible missing information or inconsistencies. OVIS checks are warnings only and not certification. Review required.\n              </p>\n              <ul className=\"list-disc list-inside text-xs text-amber-800 space-y-1\">\n                {model.ovisWarnings.map((warning) => (\n                  <li key={warning.id}>{warning.message}</li>\n                ))}\n              </ul>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Error Banner */}\n      {error && (\n        <div className=\"bg-red-50 border-b border-red-200 px-6 py-3\">\n          <div className=\"flex items-center gap-3\">\n            <AlertCircle className=\"w-5 h-5 text-red-600\" />\n            <p className=\"text-sm text-red-800\">{error}</p>\n          </div>\n        </div>\n      )}\n\n      {/* Content */}\n      <div className=\"flex-1 overflow-y-auto p-6\">\n        <DocPreview\n          model={model}\n          onModelChange={handleModelChange}\n          editable={true}\n        />\n      </div>\n\n      {/* Footer Disclaimer - Only show if not approved and not issued */}\n      {!approved && docStatus !== \"ISSUED\" && (\n        <div className=\"bg-slate-50 border-t border-slate-200 px-6 py-4\">\n          <p className=\"text-xs text-slate-600 text-center\">\n            {model.disclaimer}\n          </p>\n        </div>\n      )}\n      \n      {/* Issued info footer */}\n      {docStatus === \"ISSUED\" && issuedRecordId && (\n        <div className=\"bg-blue-50 border-t border-blue-200 px-6 py-4\">\n          <p className=\"text-xs text-blue-700 text-center\">\n            Document issued for client export ÔÇó ID: {issuedRecordId}\n            {issuedAt && ` ÔÇó Issued: ${new Date(issuedAt).toLocaleString(\"en-AU\")}`}\n          </p>\n        </div>\n      )}\n\n      {/* Issue Document Modal */}\n      {showIssueModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-[60]\">\n          <div className=\"bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 overflow-hidden\">\n            <div className=\"px-6 py-4 border-b border-slate-200 flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center\">\n                  <Building2 className=\"w-5 h-5 text-amber-600\" />\n                </div>\n                <div>\n                  <h3 className=\"text-lg font-semibold text-slate-900\">Issue Document for Client</h3>\n                  <p className=\"text-sm text-slate-500\">Create a professional client-facing export</p>\n                </div>\n              </div>\n              <button \n                onClick={() => {\n                  setShowIssueModal(false);\n                  setIssueValidation(null);\n                }}\n                className=\"p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n            \n            <div className=\"px-6 py-4\">\n              {/* Validation Errors */}\n              {issueValidation && issueValidation.missingRequired.length > 0 && (\n                <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\n                  <div className=\"flex items-start gap-3\">\n                    <AlertCircle className=\"w-5 h-5 text-red-600 mt-0.5\" />\n                    <div>\n                      <p className=\"font-medium text-red-900 mb-2\">Missing Required Business Details</p>\n                      <ul className=\"list-disc list-inside text-sm text-red-700 space-y-1\">\n                        {issueValidation.missingRequired.map((field, i) => (\n                          <li key={i}>{field}</li>\n                        ))}\n                      </ul>\n                      <a \n                        href=\"/settings/business-profile\" \n                        className=\"inline-flex items-center gap-1 mt-3 text-sm font-medium text-red-700 hover:text-red-800\"\n                      >\n                        Complete Business Profile ÔåÆ\n                      </a>\n                    </div>\n                  </div>\n                </div>\n              )}\n              \n              {/* Warning about issuing */}\n              {(!issueValidation || issueValidation.missingRequired.length === 0) && (\n                <div className=\"mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n                  <p className=\"text-sm text-amber-900\">\n                    <strong>Important:</strong> You are issuing this document on behalf of your business. \n                    Once issued, it represents your business and should be accurate, complete, and suitable for the client.\n                  </p>\n                </div>\n              )}\n              \n              {/* What happens when issued */}\n              <div className=\"space-y-3 text-sm text-slate-600\">\n                <p className=\"font-medium text-slate-900\">When you issue this document:</p>\n                <ul className=\"space-y-2\">\n                  <li className=\"flex items-start gap-2\">\n                    <Check className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span>Your business details appear as the document issuer</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <Check className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span>A unique document ID is generated for tracking</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <Check className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span>The exported PDF will be professional and client-ready</span>\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <Check className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span>Draft warnings are removed from client exports</span>\n                  </li>\n                </ul>\n              </div>\n              \n              {/* Recommended fields warning */}\n              {issueValidation && issueValidation.missingRecommended.length > 0 && (\n                <div className=\"mt-4 p-3 bg-slate-50 border border-slate-200 rounded-lg\">\n                  <p className=\"text-xs text-slate-600\">\n                    <strong>Tip:</strong> Consider adding {issueValidation.missingRecommended.join(\", \")} to your business profile for a more professional appearance.\n                  </p>\n                </div>\n              )}\n            </div>\n            \n            <div className=\"px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-3\">\n              <button\n                onClick={() => {\n                  setShowIssueModal(false);\n                  setIssueValidation(null);\n                }}\n                className=\"px-4 py-2 text-sm text-slate-700 hover:text-slate-900\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleIssue}\n                disabled={issuing || (issueValidation !== null && issueValidation.missingRequired.length > 0)}\n                className=\"px-4 py-2 text-sm bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              >\n                {issuing ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                    Issuing...\n                  </>\n                ) : (\n                  <>\n                    <FileCheck className=\"w-4 h-4\" />\n                    Confirm & Issue\n                  </>\n                )}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\docs\\DocExportButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\docs\\DocGeneratorModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2227,2230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2227,2230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":116,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3590,3593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3590,3593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { X } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { loadTemplate } from \"@/lib/docEngine/loadTemplate\";\r\nimport { generateRenderModel } from \"@/lib/docEngine/renderModel\";\r\nimport type { DocType, JobData } from \"@/lib/docEngine/types\";\r\nimport DocPreview from \"./DocPreview\";\r\nimport DocOvisPanel from \"./DocOvisPanel\";\r\nimport DocExportButton from \"./DocExportButton\";\r\n\r\ninterface DocGeneratorModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  jobId: string;\r\n  jobData: JobData;\r\n}\r\n\r\nconst DOC_TYPES: Array<{ value: DocType; label: string; description: string }> = [\r\n  {\r\n    value: \"SWMS\",\r\n    label: \"SWMS (AU-WA)\",\r\n    description: \"Safe Work Method Statement aligned with WA WorkSafe guidance\",\r\n  },\r\n  {\r\n    value: \"PAYMENT_CLAIM_WA\",\r\n    label: \"Payment Claim (AU-WA)\",\r\n    description: \"Security of Payment claim aligned with WA Construction Contracts Act 2004\",\r\n  },\r\n  {\r\n    value: \"TOOLBOX_TALK\",\r\n    label: \"Toolbox Talk (AU)\",\r\n    description: \"Safety briefing template following best practice structure\",\r\n  },\r\n  {\r\n    value: \"VARIATION_CHANGE_ORDER\",\r\n    label: \"Variation / Change Order (AU)\",\r\n    description: \"Variation or change order document for contract modifications\",\r\n  },\r\n  {\r\n    value: \"EXTENSION_OF_TIME\",\r\n    label: \"Extension of Time (AU)\",\r\n    description: \"Extension of time request for project delays\",\r\n  },\r\n  {\r\n    value: \"PROGRESS_CLAIM_TAX_INVOICE\",\r\n    label: \"Progress Claim / Tax Invoice (AU)\",\r\n    description: \"Progress claim and tax invoice for payment\",\r\n  },\r\n  {\r\n    value: \"HANDOVER_PRACTICAL_COMPLETION\",\r\n    label: \"Handover & Practical Completion (AU)\",\r\n    description: \"Handover document and practical completion certificate\",\r\n  },\r\n  {\r\n    value: \"MAINTENANCE_CARE_GUIDE\",\r\n    label: \"Maintenance & Care Guide (AU)\",\r\n    description: \"Maintenance and care guide for completed work\",\r\n  },\r\n];\r\n\r\nexport default function DocGeneratorModal({\r\n  isOpen,\r\n  onClose,\r\n  jobId,\r\n  jobData,\r\n}: DocGeneratorModalProps) {\r\n  const [selectedDocType, setSelectedDocType] = useState<DocType | null>(null);\r\n  const [renderModel, setRenderModel] = useState<any>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [isGenerating, setIsGenerating] = useState(false);\r\n  const [emailVerified, setEmailVerified] = useState<boolean | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setSelectedDocType(null);\r\n      setRenderModel(null);\r\n      setError(null);\r\n      // Check email verification status\r\n      checkEmailVerification();\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const checkEmailVerification = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/auth/me\");\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setEmailVerified(!!data.user?.emailVerifiedAt);\r\n      } else {\r\n        setEmailVerified(false);\r\n      }\r\n    } catch {\r\n      setEmailVerified(false);\r\n    }\r\n  };\r\n\r\n  const handleSelectDocType = (docType: DocType) => {\r\n    try {\r\n      setIsGenerating(true);\r\n      setError(null);\r\n\r\n      const template = loadTemplate(docType);\r\n      const model = generateRenderModel(template, jobData);\r\n      setRenderModel(model);\r\n      setSelectedDocType(docType);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to generate document\");\r\n      console.error(\"Document generation error:\", err);\r\n    } finally {\r\n      setIsGenerating(false);\r\n    }\r\n  };\r\n\r\n  const handleModelChange = (updatedModel: any) => {\r\n    setRenderModel(updatedModel);\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 overflow-y-auto\">\r\n      <div className=\"flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0\">\r\n        {/* Backdrop */}\r\n        <div\r\n          className=\"fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity\"\r\n          onClick={onClose}\r\n        />\r\n\r\n        {/* Modal */}\r\n        <div className=\"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-5xl sm:w-full\">\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-slate-50\">\r\n            <h2 className=\"text-xl font-semibold text-slate-900\">Generate Document</h2>\r\n            <button\r\n              onClick={onClose}\r\n              className=\"text-slate-400 hover:text-slate-600 transition-colors\"\r\n            >\r\n              <X className=\"w-5 h-5\" />\r\n            </button>\r\n          </div>\r\n\r\n          {/* Content */}\r\n          <div className=\"px-6 py-4 max-h-[calc(100vh-200px)] overflow-y-auto\">\r\n            {!selectedDocType ? (\r\n              // Document type selection\r\n              <div className=\"space-y-4\">\r\n                {emailVerified === false && (\r\n                  <div className=\"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\r\n                    <div className=\"flex items-start gap-3\">\r\n                      <svg className=\"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\r\n                      </svg>\r\n                      <div className=\"flex-1\">\r\n                        <h3 className=\"text-sm font-semibold text-amber-900 mb-1\">Email Verification Required</h3>\r\n                        <p className=\"text-sm text-amber-800 mb-3\">\r\n                          Please verify your email address to generate documents. Check your inbox for a verification email or{\" \"}\r\n                          <Link href=\"/settings\" className=\"underline font-medium\">\r\n                            resend verification email\r\n                          </Link>.\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                <p className=\"text-sm text-slate-600 mb-6\">\r\n                  Select a document type to generate. All documents are compliance-ready templates (AU/WA) and require review before use.\r\n                </p>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  {DOC_TYPES.map((doc) => (\r\n                    <button\r\n                      key={doc.value}\r\n                      onClick={() => handleSelectDocType(doc.value)}\r\n                      disabled={isGenerating || emailVerified === false}\r\n                      className=\"text-left p-4 border border-slate-200 rounded-lg hover:border-amber-500 hover:bg-amber-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      <h3 className=\"font-semibold text-slate-900 mb-1\">{doc.label}</h3>\r\n                      <p className=\"text-sm text-slate-600\">{doc.description}</p>\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n                {error && (\r\n                  <div className=\"mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n                    {error}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ) : (\r\n              // Document preview\r\n              <div className=\"space-y-6\">\r\n                {/* OVIS Panel */}\r\n                {renderModel && <DocOvisPanel model={renderModel} />}\r\n\r\n                {/* Document Preview - Editable */}\r\n                {renderModel && (\r\n                  <DocPreview\r\n                    model={renderModel}\r\n                    editable={true}\r\n                    onModelChange={handleModelChange}\r\n                  />\r\n                )}\r\n\r\n                {/* Export Button */}\r\n                {renderModel && (\r\n                  <div className=\"flex justify-end pt-4 border-t border-slate-200\">\r\n                    <DocExportButton\r\n                      jobId={jobId}\r\n                      docType={selectedDocType!}\r\n                      recordId={renderModel.recordId}\r\n                      renderModel={renderModel}\r\n                    />\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Footer */}\r\n          <div className=\"px-6 py-4 border-t border-slate-200 bg-slate-50 flex items-center justify-between\">\r\n            <p className=\"text-xs text-slate-500\">\r\n              Review required before use. Not certified or verified.\r\n            </p>\r\n            <button\r\n              onClick={onClose}\r\n              className=\"px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors\"\r\n            >\r\n              Close\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\docs\\DocOvisPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\docs\\DocPreview.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2089,2092],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2089,2092],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useCallback } from \"react\";\r\nimport type { RenderModel, RenderSection, RenderField, RenderTable } from \"@/lib/docEngine/types\";\r\n\r\ninterface DocPreviewProps {\r\n  model: RenderModel;\r\n  onModelChange?: (updatedModel: RenderModel) => void;\r\n  editable?: boolean;\r\n}\r\n\r\nexport default function DocPreview({ model: initialModel, onModelChange, editable = true }: DocPreviewProps) {\r\n  const [model, setModel] = useState<RenderModel>(initialModel);\r\n\r\n  const updateField = useCallback((sectionId: string, fieldId: string, value: string | number | null) => {\r\n    const updatedModel: RenderModel = {\r\n      ...model,\r\n      sections: model.sections.map((section) => {\r\n        if (section.id !== sectionId) return section;\r\n        return {\r\n          ...section,\r\n          fields: section.fields?.map((field) => {\r\n            if (field.id !== fieldId) return field;\r\n            return { ...field, value };\r\n          }),\r\n        };\r\n      }),\r\n    };\r\n    setModel(updatedModel);\r\n    onModelChange?.(updatedModel);\r\n  }, [model, onModelChange]);\r\n\r\n  const updateTableRow = useCallback((sectionId: string, rowIndex: number, columnId: string, value: string | number | null) => {\r\n    const updatedModel: RenderModel = {\r\n      ...model,\r\n      sections: model.sections.map((section) => {\r\n        if (section.id !== sectionId || !section.table) return section;\r\n        return {\r\n          ...section,\r\n          table: {\r\n            ...section.table,\r\n            rows: section.table.rows.map((row, idx) => {\r\n              if (idx !== rowIndex) return row;\r\n              return { ...row, [columnId]: value };\r\n            }),\r\n          },\r\n        };\r\n      }),\r\n    };\r\n    setModel(updatedModel);\r\n    onModelChange?.(updatedModel);\r\n  }, [model, onModelChange]);\r\n\r\n  const addTableRow = useCallback((sectionId: string) => {\r\n    const updatedModel: RenderModel = {\r\n      ...model,\r\n      sections: model.sections.map((section) => {\r\n        if (section.id !== sectionId || !section.table) return section;\r\n        const newRow: Record<string, any> = {};\r\n        section.table.columns.forEach((col) => {\r\n          newRow[col.id] = null;\r\n        });\r\n        return {\r\n          ...section,\r\n          table: {\r\n            ...section.table,\r\n            rows: [...section.table.rows, newRow],\r\n          },\r\n        };\r\n      }),\r\n    };\r\n    setModel(updatedModel);\r\n    onModelChange?.(updatedModel);\r\n  }, [model, onModelChange]);\r\n\r\n  const removeTableRow = useCallback((sectionId: string, rowIndex: number) => {\r\n    const updatedModel: RenderModel = {\r\n      ...model,\r\n      sections: model.sections.map((section) => {\r\n        if (section.id !== sectionId || !section.table) return section;\r\n        return {\r\n          ...section,\r\n          table: {\r\n            ...section.table,\r\n            rows: section.table.rows.filter((_, idx) => idx !== rowIndex),\r\n          },\r\n        };\r\n      }),\r\n    };\r\n    setModel(updatedModel);\r\n    onModelChange?.(updatedModel);\r\n  }, [model, onModelChange]);\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 space-y-8\">\r\n      {/* Header */}\r\n      <div className=\"border-b border-slate-200 pb-4\">\r\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">{model.title}</h1>\r\n        <div className=\"flex items-center gap-4 text-sm text-slate-600\">\r\n          <span>Record ID: <span className=\"font-mono font-medium\">{model.recordId}</span></span>\r\n          <span>Generated: <span className=\"font-medium\">{new Date(model.timestamp).toLocaleString(\"en-AU\")}</span></span>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Disclaimer */}\r\n      <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4\">\r\n        <div className=\"flex items-start gap-2\">\r\n          <svg className=\"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\r\n          </svg>\r\n          <p className=\"text-sm text-amber-900\">{model.disclaimer}</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Sections */}\r\n      {model.sections.map((section) => (\r\n        <SectionPreview\r\n          key={section.id}\r\n          section={section}\r\n          editable={editable}\r\n          onFieldChange={(fieldId, value) => updateField(section.id, fieldId, value)}\r\n          onTableRowChange={(rowIndex, columnId, value) => updateTableRow(section.id, rowIndex, columnId, value)}\r\n          onAddTableRow={() => addTableRow(section.id)}\r\n          onRemoveTableRow={(rowIndex) => removeTableRow(section.id, rowIndex)}\r\n        />\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface SectionPreviewProps {\r\n  section: RenderSection;\r\n  editable?: boolean;\r\n  onFieldChange?: (fieldId: string, value: string | number | null) => void;\r\n  onTableRowChange?: (rowIndex: number, columnId: string, value: string | number | null) => void;\r\n  onAddTableRow?: () => void;\r\n  onRemoveTableRow?: (rowIndex: number) => void;\r\n}\r\n\r\nfunction SectionPreview({\r\n  section,\r\n  editable = true,\r\n  onFieldChange,\r\n  onTableRowChange,\r\n  onAddTableRow,\r\n  onRemoveTableRow,\r\n}: SectionPreviewProps) {\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <h2 className=\"text-lg font-semibold text-slate-900 border-b border-slate-200 pb-2\">\r\n        {section.title}\r\n      </h2>\r\n\r\n      {/* Fields */}\r\n      {section.fields && (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n          {section.fields.map((field) => (\r\n            <FieldPreview\r\n              key={field.id}\r\n              field={field}\r\n              editable={editable}\r\n              onChange={(value) => onFieldChange?.(field.id, value)}\r\n            />\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* Table */}\r\n      {section.table && (\r\n        <TablePreview\r\n          table={section.table}\r\n          editable={editable}\r\n          onRowChange={onTableRowChange}\r\n          onAddRow={onAddTableRow}\r\n          onRemoveRow={onRemoveTableRow}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface FieldPreviewProps {\r\n  field: RenderField;\r\n  editable?: boolean;\r\n  onChange?: (value: string | number | null) => void;\r\n}\r\n\r\nfunction FieldPreview({ field, editable = true, onChange }: FieldPreviewProps) {\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\r\n    const { value, type } = e.target;\r\n    if (type === \"number\") {\r\n      const num = value === \"\" ? null : parseFloat(value);\r\n      onChange?.(isNaN(num!) ? null : num);\r\n    } else {\r\n      onChange?.(value === \"\" ? null : value);\r\n    }\r\n  };\r\n\r\n  if (!editable) {\r\n    const displayValue = field.value !== null && field.value !== undefined && field.value !== \"\"\r\n      ? String(field.value)\r\n      : field.placeholder || \"ÔÇö\";\r\n\r\n    return (\r\n      <div>\r\n        <label className=\"block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1\">\r\n          {field.label}\r\n          {field.required && <span className=\"text-red-500 ml-1\">*</span>}\r\n        </label>\r\n        <div className={`text-sm text-slate-900 ${field.value === null || field.value === \"\" ? \"text-slate-400 italic\" : \"\"}`}>\r\n          {displayValue}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <label htmlFor={field.id} className=\"block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1\">\r\n        {field.label}\r\n        {field.required && <span className=\"text-red-500 ml-1\">*</span>}\r\n      </label>\r\n      {field.type === \"textarea\" ? (\r\n        <textarea\r\n          id={field.id}\r\n          value={field.value !== null && field.value !== undefined ? String(field.value) : \"\"}\r\n          onChange={handleChange}\r\n          placeholder={field.placeholder}\r\n          className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-y min-h-[80px]\"\r\n          rows={4}\r\n        />\r\n      ) : field.type === \"select\" ? (\r\n        <select\r\n          id={field.id}\r\n          value={field.value !== null && field.value !== undefined ? String(field.value) : \"\"}\r\n          onChange={handleChange}\r\n          className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white\"\r\n        >\r\n          <option value=\"\">Select...</option>\r\n          {field.options?.map((option) => (\r\n            <option key={option} value={option}>\r\n              {option}\r\n            </option>\r\n          ))}\r\n        </select>\r\n      ) : (\r\n        <input\r\n          id={field.id}\r\n          type={field.type === \"date\" ? \"date\" : field.type === \"number\" || field.type === \"currency\" ? \"number\" : \"text\"}\r\n          value={field.value !== null && field.value !== undefined ? String(field.value) : \"\"}\r\n          onChange={handleChange}\r\n          placeholder={field.placeholder}\r\n          className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n          step={field.type === \"currency\" ? \"0.01\" : undefined}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface TablePreviewProps {\r\n  table: RenderTable;\r\n  editable?: boolean;\r\n  onRowChange?: (rowIndex: number, columnId: string, value: string | number | null) => void;\r\n  onAddRow?: () => void;\r\n  onRemoveRow?: (rowIndex: number) => void;\r\n}\r\n\r\nfunction TablePreview({ table, editable = true, onRowChange, onAddRow, onRemoveRow }: TablePreviewProps) {\r\n  const handleCellChange = (rowIndex: number, columnId: string, e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const { value, type } = e.target;\r\n    if (type === \"number\") {\r\n      const num = value === \"\" ? null : parseFloat(value);\r\n      onRowChange?.(rowIndex, columnId, isNaN(num!) ? null : num);\r\n    } else {\r\n      onRowChange?.(rowIndex, columnId, value === \"\" ? null : value);\r\n    }\r\n  };\r\n\r\n  if (table.rows.length === 0 && !editable) {\r\n    return (\r\n      <div className=\"text-sm text-slate-500 italic py-4\">\r\n        No items added yet\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <div className=\"overflow-x-auto\">\r\n        <table className=\"min-w-full border border-slate-200 rounded-lg\">\r\n          <thead className=\"bg-amber-500\">\r\n            <tr>\r\n              {table.columns.map((column) => (\r\n                <th\r\n                  key={column.id}\r\n                  className=\"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-amber-600\"\r\n                  style={{ width: column.width ? `${column.width}%` : \"auto\" }}\r\n                >\r\n                  {column.label}\r\n                </th>\r\n              ))}\r\n              {editable && <th className=\"px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider border-b border-amber-600 w-16\">Actions</th>}\r\n            </tr>\r\n          </thead>\r\n          <tbody className=\"bg-white divide-y divide-slate-200\">\r\n            {table.rows.length === 0 ? (\r\n              <tr>\r\n                <td colSpan={table.columns.length + (editable ? 1 : 0)} className=\"px-4 py-8 text-center text-sm text-slate-500\">\r\n                  No items added yet\r\n                </td>\r\n              </tr>\r\n            ) : (\r\n              table.rows.map((row, rowIndex) => (\r\n                <tr key={rowIndex} className=\"hover:bg-slate-50\">\r\n                  {table.columns.map((column) => (\r\n                    <td\r\n                      key={column.id}\r\n                      className=\"px-4 py-3 text-sm border-r border-slate-200 last:border-r-0\"\r\n                    >\r\n                      {editable ? (\r\n                        <input\r\n                          type={column.type === \"date\" ? \"date\" : column.type === \"number\" || column.type === \"currency\" ? \"number\" : \"text\"}\r\n                          value={row[column.id] !== null && row[column.id] !== undefined ? String(row[column.id]) : \"\"}\r\n                          onChange={(e) => handleCellChange(rowIndex, column.id, e)}\r\n                          placeholder={column.label}\r\n                          className=\"w-full px-2 py-1 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                          step={column.type === \"currency\" ? \"0.01\" : undefined}\r\n                        />\r\n                      ) : (\r\n                        <span className=\"text-slate-900\">\r\n                          {row[column.id] !== null && row[column.id] !== undefined && row[column.id] !== \"\"\r\n                            ? String(row[column.id])\r\n                            : \"ÔÇö\"}\r\n                        </span>\r\n                      )}\r\n                    </td>\r\n                  ))}\r\n                  {editable && (\r\n                    <td className=\"px-4 py-3 text-sm border-r border-slate-200\">\r\n                      <button\r\n                        onClick={() => onRemoveRow?.(rowIndex)}\r\n                        className=\"text-red-600 hover:text-red-800 text-xs font-medium\"\r\n                        disabled={table.rows.length <= table.minRows}\r\n                      >\r\n                        Remove\r\n                      </button>\r\n                    </td>\r\n                  )}\r\n                </tr>\r\n              ))\r\n            )}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n      {editable && (\r\n        <div className=\"flex items-center justify-between\">\r\n          <button\r\n            onClick={() => onAddRow?.()}\r\n            className=\"inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 rounded-lg transition-colors\"\r\n          >\r\n            <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\r\n            </svg>\r\n            Add Row\r\n          </button>\r\n          {table.rows.length < table.minRows && (\r\n            <p className=\"text-xs text-amber-600\">\r\n              Minimum {table.minRows} row{table.minRows !== 1 ? \"s\" : \"\"} required\r\n            </p>\r\n          )}\r\n        </div>\r\n      )}\r\n      {!editable && table.rows.length < table.minRows && (\r\n        <p className=\"text-xs text-amber-600\">\r\n          Minimum {table.minRows} row{table.minRows !== 1 ? \"s\" : \"\"} required\r\n        </p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\ui\\Badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\ui\\Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\ui\\Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\ui\\Input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\components\\ui\\SectionHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\AnalyticsSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[733,736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[733,736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { TrendingUp, TrendingDown, Minus } from \"lucide-react\";\r\nimport type { UserJobAnalytics } from \"@/lib/analytics\";\r\n\r\nexport default function AnalyticsSection() {\r\n  const [analytics, setAnalytics] = useState<UserJobAnalytics | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    async function fetchAnalytics() {\r\n      try {\r\n        const response = await fetch(\"/api/me/analytics\");\r\n        if (!response.ok) {\r\n          throw new Error(\"Failed to load analytics\");\r\n        }\r\n        const data = await response.json();\r\n        setAnalytics(data);\r\n      } catch (err: any) {\r\n        setError(err.message || \"Failed to load analytics\");\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n    fetchAnalytics();\r\n  }, []);\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\r\n        <div className=\"animate-pulse space-y-4\">\r\n          <div className=\"h-6 bg-slate-200 rounded w-32\"></div>\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n            {[1, 2, 3, 4].map((i) => (\r\n              <div key={i} className=\"h-20 bg-slate-100 rounded-lg\"></div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error || !analytics) {\r\n    return null; // Silently fail - don't break dashboard\r\n  }\r\n\r\n  const totalQuotes = analytics.quoteCounts.draft + \r\n                      analytics.quoteCounts.sent + \r\n                      analytics.quoteCounts.accepted + \r\n                      analytics.quoteCounts.declined + \r\n                      analytics.quoteCounts.cancelled;\r\n\r\n  // Calculate trend (comparing last 7 days to previous 7 days)\r\n  // We'll approximate by comparing last 7 days to last 30 days average\r\n  const avgJobsPerWeek = analytics.jobsLast30Days / 4;\r\n  const trend = analytics.jobsLast7Days > avgJobsPerWeek ? \"up\" : \r\n                analytics.jobsLast7Days < avgJobsPerWeek ? \"down\" : \"flat\";\r\n  const trendPercent = avgJobsPerWeek > 0 \r\n    ? Math.round(Math.abs((analytics.jobsLast7Days - avgJobsPerWeek) / avgJobsPerWeek) * 100)\r\n    : 0;\r\n\r\n  return (\r\n    <div className=\"mb-8\">\r\n      <div className=\"mb-4\">\r\n        <h2 className=\"text-xl font-semibold text-slate-900\">Your Numbers</h2>\r\n        <p className=\"text-sm text-slate-500 mt-1\">Quick overview of your jobs and quotes</p>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\r\n        {/* Total Jobs */}\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-slate-500 mb-1\">Total Jobs</p>\r\n              <p className=\"text-3xl font-bold text-slate-900\">{analytics.totalJobs}</p>\r\n              <p className=\"text-xs text-slate-400 mt-1\">All time</p>\r\n            </div>\r\n            <div className=\"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center\">\r\n              <svg className=\"w-6 h-6 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n              </svg>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Jobs Last 30 Days */}\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-slate-500 mb-1\">Last 30 Days</p>\r\n              <p className=\"text-3xl font-bold text-slate-900\">{analytics.jobsLast30Days}</p>\r\n              <div className=\"flex items-center gap-1 mt-1\">\r\n                {trend === \"up\" && (\r\n                  <>\r\n                    <TrendingUp className=\"w-3 h-3 text-green-600\" />\r\n                    <p className=\"text-xs text-green-600\">Up {trendPercent}%</p>\r\n                  </>\r\n                )}\r\n                {trend === \"down\" && (\r\n                  <>\r\n                    <TrendingDown className=\"w-3 h-3 text-red-600\" />\r\n                    <p className=\"text-xs text-red-600\">Down {trendPercent}%</p>\r\n                  </>\r\n                )}\r\n                {trend === \"flat\" && (\r\n                  <>\r\n                    <Minus className=\"w-3 h-3 text-slate-400\" />\r\n                    <p className=\"text-xs text-slate-400\">Steady</p>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n            <div className=\"w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center\">\r\n              <svg className=\"w-6 h-6 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6\" />\r\n              </svg>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Accepted Quotes */}\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-slate-500 mb-1\">Accepted</p>\r\n              <p className=\"text-3xl font-bold text-green-600\">{analytics.quoteCounts.accepted}</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-1\">\r\n                  {Math.round((analytics.quoteCounts.accepted / totalQuotes) * 100)}% of quotes\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\r\n              <svg className=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n              </svg>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Pending Quotes */}\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <p className=\"text-sm text-slate-500 mb-1\">Awaiting Decision</p>\r\n              <p className=\"text-3xl font-bold text-amber-600\">{analytics.quoteCounts.sent}</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-1\">\r\n                  {Math.round((analytics.quoteCounts.sent / totalQuotes) * 100)}% of quotes\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div className=\"w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center\">\r\n              <svg className=\"w-6 h-6 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n              </svg>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Quote Status Breakdown */}\r\n      {totalQuotes > 0 && (\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\r\n          <h3 className=\"text-lg font-semibold text-slate-900 mb-4\">Quote Status Breakdown</h3>\r\n          <div className=\"grid grid-cols-2 sm:grid-cols-5 gap-4\">\r\n            <div className=\"text-center\">\r\n              <p className=\"text-2xl font-bold text-slate-900\">{analytics.quoteCounts.draft}</p>\r\n              <p className=\"text-xs text-slate-500 mt-1\">Draft</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-0.5\">\r\n                  {Math.round((analytics.quoteCounts.draft / totalQuotes) * 100)}%\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div className=\"text-center\">\r\n              <p className=\"text-2xl font-bold text-amber-600\">{analytics.quoteCounts.sent}</p>\r\n              <p className=\"text-xs text-slate-500 mt-1\">Sent</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-0.5\">\r\n                  {Math.round((analytics.quoteCounts.sent / totalQuotes) * 100)}%\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div className=\"text-center\">\r\n              <p className=\"text-2xl font-bold text-green-600\">{analytics.quoteCounts.accepted}</p>\r\n              <p className=\"text-xs text-slate-500 mt-1\">Accepted</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-0.5\">\r\n                  {Math.round((analytics.quoteCounts.accepted / totalQuotes) * 100)}%\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div className=\"text-center\">\r\n              <p className=\"text-2xl font-bold text-red-600\">{analytics.quoteCounts.declined}</p>\r\n              <p className=\"text-xs text-slate-500 mt-1\">Declined</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-0.5\">\r\n                  {Math.round((analytics.quoteCounts.declined / totalQuotes) * 100)}%\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div className=\"text-center\">\r\n              <p className=\"text-2xl font-bold text-slate-600\">{analytics.quoteCounts.cancelled}</p>\r\n              <p className=\"text-xs text-slate-500 mt-1\">Cancelled</p>\r\n              {totalQuotes > 0 && (\r\n                <p className=\"text-xs text-slate-400 mt-0.5\">\r\n                  {Math.round((analytics.quoteCounts.cancelled / totalQuotes) * 100)}%\r\n                </p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\DevVerifyButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\GettingStartedCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\MatchingJobsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\MobileDashboardTiles.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4032,4035],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4032,4035],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newClientJobs' is assigned a value but never used.","line":115,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'upcomingJobs' is assigned a value but never used.","line":141,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":141,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\nimport { requireOnboardedUser } from \"@/lib/authChecks\";\nimport { getJobsForUser, type Job } from \"@/lib/jobs\";\nimport { getOnboardingStatus } from \"@/lib/onboarding-status\";\nimport { getUsersByVerificationStatus } from \"@/lib/auth\";\nimport { getUnresolvedFeedbackCount } from \"@/lib/feedback\";\nimport OmnexoraHeader from \"@/app/components/OmnexoraHeader\";\nimport EmailVerificationBanner from \"@/app/components/EmailVerificationBanner\";\nimport DevVerifyButton from \"./DevVerifyButton\";\nimport OnboardingCard from \"@/app/components/OnboardingCard\";\nimport GettingStartedCard from \"./GettingStartedCard\";\nimport VerifiedBadge from \"@/app/components/StructuredBadge\";\nimport FeedbackButton from \"@/app/components/FeedbackButton\";\nimport AnalyticsSection from \"./AnalyticsSection\";\nimport MatchingJobsSection from \"./MatchingJobsSection\";\nimport OnboardingChecklist from \"@/app/components/OnboardingChecklist\";\nimport { getClientSummariesForUser } from \"@/lib/clients\";\nimport MobileDashboardTiles from \"./MobileDashboardTiles\";\nimport OvisBadge from \"@/app/components/OvisBadge\";\n\n// RecentJobRow component for displaying job rows in the dashboard\nfunction RecentJobRow({ job }: { job: Job }) {\n  return (\n    <div className=\"flex items-center justify-between py-4 border-b border-slate-100 last:border-0\">\n      <div className=\"flex-1 min-w-0\">\n        <Link href={`/jobs/${job.id}`} className=\"text-slate-900 font-medium hover:text-amber-600 truncate block mb-1\">\n          {job.title}\n        </Link>\n        <p className=\"text-slate-500 text-sm\">\n          {job.address || \"No address provided\"} ÔÇó {new Date(job.createdAt).toLocaleDateString()}\n        </p>\n      </div>\n      <div className=\"flex items-center gap-4 ml-4\">\n        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${\n          job.status === \"ai_complete\" ? \"bg-green-100 text-green-700\" :\n          job.status === \"ai_pending\" ? \"bg-amber-100 text-amber-700\" :\n          \"bg-slate-100 text-slate-700\"\n        }`}>\n          {job.status === \"ai_complete\" ? \"Complete\" :\n           job.status === \"ai_pending\" ? \"Generating...\" :\n           \"Draft\"}\n        </span>\n      </div>\n    </div>\n  );\n}\n\nexport default async function DashboardPage() {\n  const user = await requireOnboardedUser();\n  \n  // TypeScript: user is guaranteed to be non-client after redirect above\n  const isClient = false;\n\n  // Load user data from Prisma to get business profile fields\n  // Use email to find user since KV and Prisma may use different IDs\n  // Wrap in try-catch to handle database connection issues gracefully\n  let prismaUser = null;\n  try {\n    const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n    prismaUser = await prisma.user.findUnique({\n      where: { email: user.email },\n      select: {\n        id: true,\n        role: true,\n        businessName: true,\n        tradingName: true,\n        primaryTrade: true,\n        abn: true,\n        hourlyRate: true,\n        serviceRadiusKm: true,\n        servicePostcodes: true,\n        verificationStatus: true,\n        profileCompletedAt: true,\n        emailVerifiedAt: true,\n        onboardingDismissed: true,\n        onboardingCompletedAt: true,\n        // Fields needed for onboarding status computation\n        calloutFee: true,\n        ratePerM2Interior: true,\n        ratePerM2Exterior: true,\n        ratePerLmTrim: true,\n        serviceAreaCity: true,\n      },\n    });\n  } catch (error) {\n    // Log error but don't crash - dashboard can still function without Prisma data\n    console.error(\"[dashboard] Failed to load user data from Prisma:\", error);\n  }\n\n  // Load jobs with error handling\n  let jobs: Job[] = [];\n  try {\n    jobs = await getJobsForUser(user.id);\n  } catch (error) {\n    // Log error but don't crash - dashboard can still function without jobs\n    console.error(\"Failed to load jobs:\", error);\n  }\n\n  // Load clients for onboarding checklist (only for tradies/businesses, not clients)\n  let clients: any[] = [];\n  if (!isClient && prismaUser && prismaUser.role !== \"client\") {\n    try {\n      const clientSummaries = await getClientSummariesForUser(user.id);\n      clients = clientSummaries;\n    } catch (error) {\n      // Log error but don't crash - checklist can handle empty clients\n      console.error(\"Failed to load clients for checklist:\", error);\n    }\n  }\n  \n  // Filter for client jobs (assigned via portal)\n  const clientJobs = jobs.filter(\n    (j) => j.leadSource === \"CLIENT_PORTAL\" && j.assignmentStatus === \"ASSIGNED\"\n  );\n  const newClientJobs = clientJobs\n    .filter((j) => {\n      // Show jobs that need attention (draft status or no AI pack yet)\n      return j.status === \"draft\" || j.status === \"ai_pending\" || !j.aiSummary;\n    })\n    .slice(0, 5);\n  \n  // Calculate stats\n  const totalJobs = jobs.length;\n  const completedJobs = jobs.filter((j) => j.status === \"ai_complete\").length;\n  const pendingJobs = jobs.filter((j) => j.status === \"ai_pending\").length;\n  const recentJobs = jobs.slice(0, 5);\n  const lastJob = jobs[0];\n  \n  // Calculate total quotes (jobs with quotes sent/accepted/declined)\n  const totalQuotes = jobs.filter((j) => \n    j.clientStatus === \"sent\" || \n    j.clientStatus === \"accepted\" || \n    j.clientStatus === \"declined\" ||\n    j.clientAcceptedAt || \n    j.clientDeclinedAt\n  ).length;\n  \n  // Get upcoming scheduled jobs (only for tradie/business users)\n  // Note: Clients are already redirected above, so isClient is always false here\n  const now = new Date();\n  const upcomingJobs = !isClient\n    ? jobs\n        .filter((job) => {\n          // Must have scheduledStartAt\n          if (!job.scheduledStartAt) return false;\n          // Must be in the future\n          const startDate = new Date(job.scheduledStartAt);\n          if (startDate <= now) return false;\n          // Must not be cancelled\n          if (job.jobStatus === \"cancelled\") return false;\n          // Optionally exclude completed jobs\n          if (job.jobStatus === \"completed\") return false;\n          return true;\n        })\n        .sort((a, b) => {\n          // Sort by scheduledStartAt ascending\n          const aDate = new Date(a.scheduledStartAt!).getTime();\n          const bDate = new Date(b.scheduledStartAt!).getTime();\n          return aDate - bDate;\n        })\n        .slice(0, 10) // Limit to next 10\n    : [];\n\n  // Get display name from email\n  const displayName = user.email.split(\"@\")[0];\n\n  // Get verification status and role (default values for older users)\n  const verificationStatus = user.verificationStatus || \"unverified\";\n  const userRole = user.role || \"tradie\";\n  const isVerified = verificationStatus === \"verified\";\n  const isTradie = userRole === \"tradie\";\n  const userIsAdmin = user.isAdmin ?? false;\n  const isDev = process.env.NODE_ENV !== \"production\";\n\n  // Get onboarding status (only for tradie/business users, not clients or admins)\n  let onboardingStatus = null;\n  if (prismaUser && !isClient && !userIsAdmin && prismaUser.role !== \"client\") {\n    try {\n      onboardingStatus = await getOnboardingStatus(prismaUser);\n      // Don't show if all done or dismissed\n      if (onboardingStatus.allDone || onboardingStatus.dismissed) {\n        onboardingStatus = null;\n      }\n    } catch (error) {\n      // Log error but don't crash - dashboard can still function without onboarding status\n      console.error(\"Failed to load onboarding status:\", error);\n    }\n  }\n\n  // Get pending verification and feedback counts for admins\n  let pendingVerifications = 0;\n  let unresolvedFeedback = 0;\n  if (userIsAdmin) {\n    try {\n      const pendingReviewUsers = await getUsersByVerificationStatus(\"pending\");\n      pendingVerifications = pendingReviewUsers.length;\n      unresolvedFeedback = await getUnresolvedFeedbackCount();\n    } catch {\n      // Silently fail - don't break dashboard if admin query fails\n    }\n  }\n\n  // Check onboarding checklist state (only for tradies/businesses, not clients or admins)\n  const showOnboardingChecklist = !isClient && !userIsAdmin && prismaUser && prismaUser.role !== \"client\";\n  const hasBusinessProfile = showOnboardingChecklist && prismaUser\n    ? !!(prismaUser.businessName || prismaUser.tradingName)\n    : true;\n  const hasAnyClients = showOnboardingChecklist ? clients.length > 0 : true;\n  const hasAnyJobs = showOnboardingChecklist ? jobs.length > 0 : true;\n\n  return (\n    <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n      {/* Brand Header */}\n      <OmnexoraHeader verificationStatus={verificationStatus} />\n\n      {/* Email Verification Banner */}\n      {prismaUser && !prismaUser.emailVerifiedAt && (\n        <EmailVerificationBanner userEmail={user.email} />\n      )}\n\n      {/* Dev-only verify button */}\n      {isDev && !isVerified && <DevVerifyButton />}\n\n      {/* Verification Banner for unverified tradies (show after onboarding) */}\n      {isTradie && !isVerified && prismaUser?.profileCompletedAt && (\n        <div className=\"mb-6 rounded-lg border border-emerald-300 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-emerald-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div className=\"flex-1\">\n              <p className=\"font-medium\">Nice work, your profile is set up.</p>\n              <p className=\"mt-1 text-emerald-700\">\n                To build more trust with clients and unlock full OMNEXORA features, complete business verification.\n                {(verificationStatus === \"pending\" || (verificationStatus as string) === \"pending_review\") ? (\n                  <span className=\"ml-1 font-medium\">Your verification is currently being reviewed.</span>\n                ) : (\n                  <a href=\"/settings/verification\" className=\"ml-1 font-medium underline hover:text-emerald-900\">\n                    Review verification ÔåÆ\n                  </a>\n                )}\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Legacy verification banner for users who haven't completed onboarding yet */}\n      {isTradie && !isVerified && !prismaUser?.profileCompletedAt && (\n        <div className=\"mb-6 rounded-lg border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-800\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <p className=\"font-medium\">Prototype mode</p>\n              <p className=\"mt-1 text-amber-700\">\n                Your account is not fully structured yet. Before public launch, OMNEXORA will confirm your business details (ABN, insurance, ID) so clients know they&apos;re dealing with legitimate trades.\n                {(verificationStatus === \"pending\" || (verificationStatus as string) === \"pending_review\") ? (\n                  <span className=\"ml-1 font-medium\">Your verification is currently being reviewed.</span>\n                ) : (\n                  <a href=\"/settings/verification\" className=\"ml-1 font-medium underline hover:text-amber-900\">\n                    Complete business verification ÔåÆ\n                  </a>\n                )}\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* New Onboarding Card */}\n      {onboardingStatus && (\n        <OnboardingCard\n          steps={onboardingStatus.steps}\n          allDone={onboardingStatus.allDone}\n          onDismiss={() => {\n            // This will be handled by the component's router.refresh()\n          }}\n        />\n      )}\n\n      {/* First-time onboarding checklist for tradies/businesses */}\n      {showOnboardingChecklist && (\n        <OnboardingChecklist\n          hasBusinessProfile={hasBusinessProfile}\n          hasAnyClients={hasAnyClients}\n          hasAnyJobs={hasAnyJobs}\n        />\n      )}\n\n      {/* Legacy Getting Started Card (fallback for older logic) */}\n      {!onboardingStatus && prismaUser && (\n        <GettingStartedCard\n          user={prismaUser}\n          hasJobs={totalJobs > 0}\n        />\n      )}\n\n      {/* Header */}\n      <div className=\"mb-8 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3 flex-wrap\">\n            <span>G&apos;day, {displayName}! ­ƒæï</span>\n                {isVerified && <VerifiedBadge />}\n          </h1>\n          <p className=\"mt-2 text-slate-600\">\n            {totalJobs === 0\n              ? \"Welcome to OMNEXORA! Create your first job pack to get started.\"\n              : `You have ${totalJobs} job${totalJobs === 1 ? \"\" : \"s\"}. ${lastJob ? `Last job: \"${lastJob.title}\"` : \"\"}`}\n          </p>\n          {/* OVIS Badge - Subtle line on mobile only */}\n          <div className=\"mt-3 md:hidden\">\n            <OvisBadge variant=\"card\" size=\"sm\" />\n          </div>\n        </div>\n        <div className=\"flex-shrink-0\">\n          <FeedbackButton />\n        </div>\n      </div>\n\n      {/* Quick Actions */}\n      <div className=\"mb-8\">\n        <Link\n          href=\"/jobs/new\"\n          className=\"inline-flex items-center px-6 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-xl transition-colors shadow-lg shadow-amber-500/25\"\n        >\n          <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n          </svg>\n          Create Job Pack\n        </Link>\n      </div>\n\n      {/* Mobile Dashboard Tiles - Only shown on mobile */}\n      <div className=\"md:hidden\">\n        <MobileDashboardTiles\n          totalJobs={totalJobs}\n          totalQuotes={totalQuotes}\n          completedJobs={completedJobs}\n        />\n      </div>\n\n      {/* Desktop Dashboard Content - Hidden on mobile, shown on md and up */}\n      <div className=\"hidden md:block\">\n        {/* Analytics Section */}\n        <AnalyticsSection />\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Total Jobs</p>\n              <p className=\"text-2xl font-bold text-slate-900\">{totalJobs}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Completed</p>\n              <p className=\"text-2xl font-bold text-slate-900\">{completedJobs}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Pending</p>\n              <p className=\"text-2xl font-bold text-slate-900\">{pendingJobs}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-purple-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Credits Left</p>\n              <p className=\"text-2xl font-bold text-slate-900\">Ôê×</p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n        {/* Admin Cards - Only shown for admins */}\n        {userIsAdmin && (\n        <div className=\"mb-8 grid grid-cols-1 sm:grid-cols-2 gap-4\">\n          <Link\n            href=\"/admin/verification\"\n            className=\"block bg-purple-50 rounded-xl border border-purple-200 p-5 shadow-sm hover:bg-purple-100 transition-colors\"\n          >\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center\">\n                <div className=\"w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\n                  </svg>\n                </div>\n                <div className=\"ml-3\">\n                  <p className=\"text-sm font-medium text-purple-600\">ADMIN</p>\n                  <p className=\"text-lg font-bold text-purple-900\">\n                    {pendingVerifications} pending\n                  </p>\n                </div>\n              </div>\n              <svg className=\"w-5 h-5 text-purple-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n              </svg>\n            </div>\n          </Link>\n          <Link\n            href=\"/admin/feedback\"\n            className=\"block bg-amber-50 rounded-xl border border-amber-200 p-5 shadow-sm hover:bg-amber-100 transition-colors\"\n          >\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center\">\n                <div className=\"w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center\">\n                  <svg className=\"w-5 h-5 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z\" />\n                  </svg>\n                </div>\n                <div className=\"ml-3\">\n                  <p className=\"text-sm font-medium text-amber-600\">Feedback</p>\n                  <p className=\"text-lg font-bold text-amber-900\">\n                    {unresolvedFeedback} unresolved\n                  </p>\n                </div>\n              </div>\n              <svg className=\"w-5 h-5 text-amber-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n              </svg>\n            </div>\n          </Link>\n        </div>\n        )}\n\n        {/* Recent Jobs */}\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\n        <div className=\"px-6 py-4 border-b border-slate-200\">\n          <div className=\"flex items-center justify-between\">\n            <h2 className=\"text-lg font-semibold text-slate-900\">Recent Jobs</h2>\n            <Link href=\"/jobs\" className=\"text-sm font-medium text-amber-600 hover:text-amber-500\">\n              View all ÔåÆ\n            </Link>\n          </div>\n        </div>\n        <div className=\"p-6\">\n          {recentJobs.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <svg className=\"w-8 h-8 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                </svg>\n              </div>\n              <h3 className=\"text-lg font-medium text-slate-900 mb-2\">No jobs yet</h3>\n              <p className=\"text-slate-500 mb-6\">Create your first AI job pack to get started.</p>\n              <Link\n                href=\"/jobs/new\"\n                className=\"inline-flex items-center px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white font-medium rounded-lg transition-colors text-sm\"\n              >\n                <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n                New Job\n              </Link>\n            </div>\n          ) : (\n            <div>\n              {recentJobs.map((job) => (\n                <RecentJobRow key={job.id} job={job} />\n              ))}\n            </div>\n          )}\n        </div>\n        </div>\n\n        {/* Jobs in your service area - Only shown for tradies */}\n        {isTradie && (\n          <div className=\"mt-8\">\n            <MatchingJobsSection />\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\performance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\quotes\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'displayName' is assigned a value but never used.","line":35,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\nimport { requireOnboardedUser } from \"@/lib/authChecks\";\nimport { getJobsForUser, type Job } from \"@/lib/jobs\";\nimport OmnexoraHeader from \"@/app/components/OmnexoraHeader\";\nimport VerifiedBadge from \"@/app/components/StructuredBadge\";\nimport { ArrowLeft } from \"lucide-react\";\n\nexport default async function QuotesPage() {\n  const user = await requireOnboardedUser();\n  \n  // Load jobs with error handling\n  let jobs: Job[] = [];\n  try {\n    jobs = await getJobsForUser(user.id);\n  } catch (error) {\n    console.error(\"Failed to load jobs:\", error);\n  }\n\n  // Filter jobs with quotes\n  const jobsWithQuotes = jobs.filter((j) => \n    j.clientStatus === \"sent\" || \n    j.clientStatus === \"accepted\" || \n    j.clientStatus === \"declined\" ||\n    j.clientAcceptedAt || \n    j.clientDeclinedAt ||\n    j.aiQuote\n  );\n\n  const acceptedQuotes = jobs.filter((j) => j.clientStatus === \"accepted\" || j.clientAcceptedAt);\n  const pendingQuotes = jobs.filter((j) => j.clientStatus === \"sent\" && !j.clientAcceptedAt && !j.clientDeclinedAt);\n  const declinedQuotes = jobs.filter((j) => j.clientStatus === \"declined\" || j.clientDeclinedAt);\n\n  const verificationStatus = user.verificationStatus || \"unverified\";\n  const isVerified = verificationStatus === \"verified\";\n  const displayName = user.email.split(\"@\")[0];\n\n  return (\n    <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n      <OmnexoraHeader verificationStatus={verificationStatus} />\n\n      {/* Header */}\n      <div className=\"mb-8\">\n        <Link\n          href=\"/dashboard\"\n          className=\"inline-flex items-center text-sm text-slate-600 hover:text-slate-900 mb-4\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Back to Dashboard\n        </Link>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-slate-900 flex items-center gap-3\">\n              Quotes\n              {isVerified && <VerifiedBadge />}\n            </h1>\n            <p className=\"mt-2 text-slate-600\">\n              Track all your quotes and client responses\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Stats */}\n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8\">\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Accepted</p>\n              <p className=\"text-2xl font-bold text-slate-900\">{acceptedQuotes.length}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Pending</p>\n              <p className=\"text-2xl font-bold text-slate-900\">{pendingQuotes.length}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6 shadow-sm\">\n          <div className=\"flex items-center\">\n            <div className=\"w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center\">\n              <svg className=\"w-6 h-6 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </div>\n            <div className=\"ml-4\">\n              <p className=\"text-sm text-slate-500\">Declined</p>\n              <p className=\"text-2xl font-bold text-slate-900\">{declinedQuotes.length}</p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Quotes List */}\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\n        <div className=\"px-6 py-4 border-b border-slate-200\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">All Quotes</h2>\n        </div>\n        <div className=\"p-6\">\n          {jobsWithQuotes.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <svg className=\"w-8 h-8 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                </svg>\n              </div>\n              <h3 className=\"text-lg font-medium text-slate-900 mb-2\">No quotes yet</h3>\n              <p className=\"text-slate-500 mb-6\">Create a job pack to generate your first quote.</p>\n              <Link\n                href=\"/jobs/new\"\n                className=\"inline-flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors text-sm\"\n              >\n                Create New Job\n              </Link>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {jobsWithQuotes.map((job) => (\n                <Link\n                  key={job.id}\n                  href={`/jobs/${job.id}`}\n                  className=\"block border border-slate-200 rounded-lg p-4 hover:border-amber-300 transition-colors\"\n                >\n                  <div className=\"flex items-start justify-between gap-4\">\n                    <div className=\"flex-1 min-w-0\">\n                      <h3 className=\"text-slate-900 font-medium mb-1\">{job.title}</h3>\n                      <p className=\"text-slate-600 text-sm mb-2\">\n                        {job.address || \"No address provided\"}\n                      </p>\n                      <div className=\"flex items-center gap-2\">\n                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${\n                          job.clientStatus === \"accepted\" || job.clientAcceptedAt ? \"bg-green-100 text-green-700\" :\n                          job.clientStatus === \"declined\" || job.clientDeclinedAt ? \"bg-red-100 text-red-700\" :\n                          job.clientStatus === \"sent\" ? \"bg-amber-100 text-amber-700\" :\n                          \"bg-slate-100 text-slate-700\"\n                        }`}>\n                          {job.clientStatus === \"accepted\" || job.clientAcceptedAt ? \"Accepted\" :\n                           job.clientStatus === \"declined\" || job.clientDeclinedAt ? \"Declined\" :\n                           job.clientStatus === \"sent\" ? \"Pending\" :\n                           \"Draft\"}\n                        </span>\n                        {job.clientAcceptedAt && (\n                          <span className=\"text-xs text-slate-500\">\n                            Accepted {new Date(job.clientAcceptedAt).toLocaleDateString()}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                    <svg className=\"w-5 h-5 text-slate-400 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                    </svg>\n                  </div>\n                </Link>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\dashboard\\usage\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\forgot-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\JobSearch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\JobsList.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":137,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":137,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter, useSearchParams } from \"next/navigation\";\nimport { ChevronLeft, ChevronRight, Copy, Loader2 } from \"lucide-react\";\nimport type { Job, JobStatus, JobWorkflowStatus, ClientStatus } from \"@/lib/jobs\";\nimport JobSearch from \"./JobSearch\";\n\nfunction StatusBadge({ status }: { status: JobStatus }) {\n  const styles: Record<JobStatus, string> = {\n    draft: \"bg-slate-100 text-slate-700\",\n    ai_pending: \"bg-amber-100 text-amber-700\",\n    ai_complete: \"bg-green-100 text-green-700\",\n    ai_failed: \"bg-red-100 text-red-700\",\n    pending_regeneration: \"bg-orange-100 text-orange-700\",\n    generating: \"bg-amber-100 text-amber-700\",\n  };\n\n  const labels: Record<JobStatus, string> = {\n    draft: \"Draft\",\n    ai_pending: \"Generating...\",\n    ai_complete: \"Complete\",\n    ai_failed: \"Failed\",\n    pending_regeneration: \"Needs Update\",\n    generating: \"Regenerating...\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction JobWorkflowStatusBadge({ status }: { status: JobWorkflowStatus }) {\n  const styles: Record<JobWorkflowStatus, string> = {\n    pending: \"bg-amber-100 text-amber-700\",\n    pending_confirmation: \"bg-purple-100 text-purple-700\",\n    booked: \"bg-green-100 text-green-700\",\n    completed: \"bg-blue-100 text-blue-700\",\n    cancelled: \"bg-slate-100 text-slate-500\",\n  };\n\n  const labels: Record<JobWorkflowStatus, string> = {\n    pending: \"Pending\",\n    pending_confirmation: \"Awaiting Confirmation\",\n    booked: \"Booked\",\n    completed: \"Completed\",\n    cancelled: \"Cancelled\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction ClientStatusBadge({ status }: { status: ClientStatus }) {\n  const styles: Record<ClientStatus, string> = {\n    draft: \"bg-slate-100 text-slate-600\",\n    sent: \"bg-blue-100 text-blue-700\",\n    accepted: \"bg-emerald-100 text-emerald-700\",\n    declined: \"bg-rose-100 text-rose-700\",\n    cancelled: \"bg-amber-100 text-amber-700\",\n  };\n\n  const labels: Record<ClientStatus, string> = {\n    draft: \"Draft\",\n    sent: \"Sent\",\n    accepted: \"Accepted\",\n    declined: \"Declined\",\n    cancelled: \"Cancelled\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction formatDate(dateString: string): string {\n  return new Date(dateString).toLocaleDateString(\"en-AU\", {\n    day: \"numeric\",\n    month: \"short\",\n    year: \"numeric\",\n  });\n}\n\nfunction formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleDateString(\"en-AU\", {\n    day: \"numeric\",\n    month: \"short\",\n    year: \"numeric\",\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    hour12: true,\n  });\n}\n\nfunction JobRow({ job }: { job: Job }) {\n  const router = useRouter();\n  const [isDuplicating, setIsDuplicating] = useState(false);\n  const hasSchedule = job.scheduledStartAt != null;\n\n  const handleDuplicate = async (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const confirmed = window.confirm(\n      `Create a copy of \"${job.title}\"?\\n\\nThe new job will have the same details but will be reset to draft status.`\n    );\n\n    if (!confirmed) {\n      return;\n    }\n\n    setIsDuplicating(true);\n\n    try {\n      const response = await fetch(`/api/jobs/${job.id}/duplicate`, {\n        method: \"POST\",\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        alert(data.error || \"Failed to duplicate job\");\n        setIsDuplicating(false);\n        return;\n      }\n\n      const data = await response.json();\n      // Navigate to the new job's detail page\n      router.push(`/jobs/${data.jobId}`);\n    } catch (err) {\n      alert(\"An unexpected error occurred while duplicating the job\");\n      setIsDuplicating(false);\n    }\n  };\n  \n  return (\n    <tr className=\"hover:bg-slate-50 transition-colors border-b border-slate-100\">\n      <td className=\"px-4 sm:px-6 py-4\">\n        <div className=\"flex flex-col min-w-0\">\n          <Link\n            href={`/jobs/${job.id}`}\n            className=\"text-slate-900 font-medium hover:text-amber-600 transition-colors truncate\"\n          >\n            {job.title}\n          </Link>\n          {job.address && (\n            <span className=\"text-slate-500 text-sm truncate\">{job.address}</span>\n          )}\n        </div>\n      </td>\n      <td className=\"px-4 sm:px-6 py-4 text-slate-600 text-sm\">{job.tradeType}</td>\n      <td className=\"px-4 sm:px-6 py-4\">\n        <JobWorkflowStatusBadge status={job.jobStatus || \"pending\"} />\n      </td>\n      <td className=\"px-4 sm:px-6 py-4\">\n        <ClientStatusBadge status={job.clientStatus || \"draft\"} />\n      </td>\n      <td className=\"px-4 sm:px-6 py-4\">\n        <StatusBadge status={job.status} />\n      </td>\n      <td className=\"px-4 sm:px-6 py-4\">\n        {hasSchedule ? (\n          <div className=\"flex flex-col\">\n            <span className=\"text-slate-900 text-sm font-medium\">\n              {formatDateTime(job.scheduledStartAt!)}\n            </span>\n            {job.scheduledEndAt && (\n              <span className=\"text-slate-500 text-xs\">\n                to {formatDateTime(job.scheduledEndAt)}\n              </span>\n            )}\n          </div>\n        ) : (\n          <span className=\"text-slate-400 text-sm\">Not scheduled</span>\n        )}\n      </td>\n      <td className=\"px-4 sm:px-6 py-4 text-slate-600 text-sm\">{formatDate(job.createdAt)}</td>\n      <td className=\"px-4 sm:px-6 py-4\">\n        <div className=\"flex items-center gap-2\">\n          <Link\n            href={`/jobs/${job.id}`}\n            className=\"text-amber-600 hover:text-amber-700 font-medium text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-1 rounded\"\n          >\n            View\n          </Link>\n          <button\n            onClick={handleDuplicate}\n            disabled={isDuplicating}\n            className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-1\"\n            title=\"Duplicate job\"\n          >\n            {isDuplicating ? (\n              <>\n                <Loader2 className=\"w-3 h-3 animate-spin\" />\n                <span className=\"hidden sm:inline\">Copying...</span>\n              </>\n            ) : (\n              <>\n                <Copy className=\"w-3 h-3\" />\n                <span className=\"hidden sm:inline\">Duplicate</span>\n              </>\n            )}\n          </button>\n        </div>\n      </td>\n    </tr>\n  );\n}\n\ninterface JobsListProps {\n  jobs: Job[];\n  pagination?: {\n    page: number;\n    totalPages: number;\n    totalItems: number;\n    pageSize: number;\n  };\n}\n\nexport default function JobsList({ jobs, pagination }: JobsListProps) {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [scheduleFilter, setScheduleFilter] = useState<\"all\" | \"scheduled\" | \"unscheduled\">(\"all\");\n\n  // Filter jobs based on search query and schedule filter\n  const filteredJobs = useMemo(() => {\n    let filtered = jobs;\n\n    // Apply schedule filter\n    if (scheduleFilter === \"scheduled\") {\n      filtered = filtered.filter((job) => job.scheduledStartAt != null);\n    } else if (scheduleFilter === \"unscheduled\") {\n      filtered = filtered.filter((job) => job.scheduledStartAt == null);\n    }\n\n    // Apply search query\n    if (!searchQuery.trim()) {\n      return filtered;\n    }\n\n    const query = searchQuery.toLowerCase().trim();\n    return filtered.filter((job) => {\n      // Search in title\n      if (job.title?.toLowerCase().includes(query)) return true;\n      \n      // Search in address\n      if (job.address?.toLowerCase().includes(query)) return true;\n      \n      // Search in trade type\n      if (job.tradeType?.toLowerCase().includes(query)) return true;\n      \n      // Search in property type\n      if (job.propertyType?.toLowerCase().includes(query)) return true;\n      \n      // Search in client name\n      if (job.clientName?.toLowerCase().includes(query)) return true;\n      \n      // Search in client email\n      if (job.clientEmail?.toLowerCase().includes(query)) return true;\n      \n      return false;\n    });\n  }, [jobs, searchQuery, scheduleFilter]);\n\n  if (jobs.length === 0) {\n    return null; // Empty state handled by parent\n  }\n\n  return (\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n      {/* Search Bar and Filters */}\n      <div className=\"px-6 py-4 border-b border-slate-200 space-y-3\">\n        <JobSearch\n          onSearch={setSearchQuery}\n          placeholder=\"Search by title, address, trade type, client...\"\n        />\n        <div className=\"flex items-center gap-3\">\n          <label htmlFor=\"schedule-filter\" className=\"text-sm font-medium text-slate-700\">\n            Filter:\n          </label>\n          <select\n            id=\"schedule-filter\"\n            value={scheduleFilter}\n            onChange={(e) => setScheduleFilter(e.target.value as \"all\" | \"scheduled\" | \"unscheduled\")}\n            className=\"px-3 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n          >\n            <option value=\"all\">All jobs</option>\n            <option value=\"scheduled\">Scheduled only</option>\n            <option value=\"unscheduled\">Unscheduled only</option>\n          </select>\n        </div>\n      </div>\n\n      {/* Results Count */}\n      {(searchQuery || scheduleFilter !== \"all\") && (\n        <div className=\"px-6 py-2 bg-slate-50 border-b border-slate-200\">\n          <p className=\"text-sm text-slate-600\">\n            {filteredJobs.length === 0 ? (\n              <>No jobs found matching your filters</>\n            ) : (\n              <>\n                Showing {filteredJobs.length} of {pagination ? pagination.totalItems : jobs.length} job{filteredJobs.length === 1 ? \"\" : \"s\"}\n                {searchQuery && ` matching \"${searchQuery}\"`}\n              </>\n            )}\n          </p>\n        </div>\n      )}\n\n      {/* Jobs Table */}\n      <div className=\"overflow-x-auto\">\n        {filteredJobs.length === 0 ? (\n          <div className=\"p-12 text-center\">\n            <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n              <svg className=\"w-8 h-8 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-lg font-medium text-slate-900 mb-2\">No jobs found</h3>\n            <p className=\"text-slate-500 text-sm\">\n              Try adjusting your search terms or clear the search to see all jobs.\n            </p>\n          </div>\n        ) : (\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"bg-slate-50 border-b border-slate-200\">\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Job Title\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Trade\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Job Status\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Client\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  AI Status\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Scheduled\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Created\n                </th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                  Actions\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-slate-200\">\n              {filteredJobs.map((job) => (\n                <JobRow key={job.id} job={job} />\n              ))}\n            </tbody>\n          </table>\n        )}\n      </div>\n\n      {/* Pagination Controls */}\n      {pagination && pagination.totalPages > 1 && (\n        <div className=\"px-6 py-4 border-t border-slate-200\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"text-sm text-slate-600\">\n              Showing <span className=\"font-medium\">{(pagination.page - 1) * pagination.pageSize + 1}</span> to{\" \"}\n              <span className=\"font-medium\">{Math.min(pagination.page * pagination.pageSize, pagination.totalItems)}</span> of{\" \"}\n              <span className=\"font-medium\">{pagination.totalItems}</span> jobs\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <button\n                onClick={() => {\n                  const params = new URLSearchParams(searchParams.toString());\n                  const newPage = pagination.page - 1;\n                  if (newPage === 1) {\n                    params.delete(\"page\");\n                  } else {\n                    params.set(\"page\", newPage.toString());\n                  }\n                  // Preserve clientEmail filter if present\n                  router.push(`/jobs?${params.toString()}`);\n                }}\n                disabled={pagination.page <= 1}\n                className=\"inline-flex items-center px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n              >\n                <ChevronLeft className=\"w-4 h-4 mr-1\" />\n                Previous\n              </button>\n              <div className=\"text-sm text-slate-700 px-3 py-2\">\n                Page <span className=\"font-medium\">{pagination.page}</span> of{\" \"}\n                <span className=\"font-medium\">{pagination.totalPages}</span>\n              </div>\n              <button\n                onClick={() => {\n                  const params = new URLSearchParams(searchParams.toString());\n                  params.set(\"page\", (pagination.page + 1).toString());\n                  // Preserve clientEmail filter if present\n                  router.push(`/jobs?${params.toString()}`);\n                }}\n                disabled={pagination.page >= pagination.totalPages}\n                className=\"inline-flex items-center px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n              >\n                Next\n                <ChevronRight className=\"w-4 h-4 ml-1\" />\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\AIReviewStatusControl.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\AttachmentsSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":7,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":4},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ImageIcon' is defined but never used.","line":9,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":31,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadAttachments'. Either include it or remove the dependency array.","line":45,"column":6,"nodeType":"ArrayExpression","endLine":45,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [jobId, loadAttachments]","fix":{"range":[1226,1233],"text":"[jobId, loadAttachments]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1608,1611],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1608,1611],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2919,2922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2919,2922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3688,3691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3688,3691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":158,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4300,4303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4300,4303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":318,"column":23,"nodeType":"JSXOpeningElement","endLine":322,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport {\r\n  Upload,\r\n  X,\r\n  FileText,\r\n  Image as ImageIcon,\r\n  Loader2,\r\n  Edit2,\r\n  Trash2,\r\n  Eye,\r\n} from \"lucide-react\";\r\n\r\ninterface Attachment {\r\n  id: string;\r\n  fileName: string;\r\n  mimeType: string;\r\n  fileSize: number;\r\n  kind: string;\r\n  caption: string | null;\r\n  createdAt: string;\r\n}\r\n\r\ninterface AttachmentsSectionProps {\r\n  jobId: string;\r\n}\r\n\r\nexport default function AttachmentsSection({ jobId }: AttachmentsSectionProps) {\r\n  const router = useRouter();\r\n  const [attachments, setAttachments] = useState<Attachment[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n  const [showUploadForm, setShowUploadForm] = useState(false);\r\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n  const [caption, setCaption] = useState(\"\");\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [editingCaptionId, setEditingCaptionId] = useState<string | null>(null);\r\n  const [editingCaption, setEditingCaption] = useState(\"\");\r\n\r\n  // Load attachments\r\n  useEffect(() => {\r\n    loadAttachments();\r\n  }, [jobId]);\r\n\r\n  const loadAttachments = async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/attachments`);\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to load attachments\");\r\n      }\r\n      const data = await response.json();\r\n      setAttachments(data.attachments || []);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to load attachments\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (file) {\r\n      // Validate file size (2MB)\r\n      if (file.size > 2 * 1024 * 1024) {\r\n        setError(\"File size must be less than 2MB\");\r\n        return;\r\n      }\r\n      setSelectedFile(file);\r\n      setError(null);\r\n    }\r\n  };\r\n\r\n  const handleUpload = async () => {\r\n    if (!selectedFile) {\r\n      setError(\"Please select a file\");\r\n      return;\r\n    }\r\n\r\n    setIsUploading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append(\"file\", selectedFile);\r\n      if (caption.trim()) {\r\n        formData.append(\"caption\", caption.trim());\r\n      }\r\n\r\n      const response = await fetch(`/api/jobs/${jobId}/attachments`, {\r\n        method: \"POST\",\r\n        body: formData,\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to upload attachment\");\r\n      }\r\n\r\n      // Reset form and reload\r\n      setSelectedFile(null);\r\n      setCaption(\"\");\r\n      setShowUploadForm(false);\r\n      await loadAttachments();\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to upload attachment\");\r\n    } finally {\r\n      setIsUploading(false);\r\n    }\r\n  };\r\n\r\n  const handleUpdateCaption = async (attachmentId: string) => {\r\n    try {\r\n      const response = await fetch(\r\n        `/api/jobs/${jobId}/attachments/${attachmentId}`,\r\n        {\r\n          method: \"PATCH\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({ caption: editingCaption.trim() || null }),\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to update caption\");\r\n      }\r\n\r\n      setEditingCaptionId(null);\r\n      setEditingCaption(\"\");\r\n      await loadAttachments();\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to update caption\");\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (attachmentId: string) => {\r\n    if (!confirm(\"Are you sure you want to delete this attachment?\")) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(\r\n        `/api/jobs/${jobId}/attachments/${attachmentId}`,\r\n        {\r\n          method: \"DELETE\",\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to delete attachment\");\r\n      }\r\n\r\n      await loadAttachments();\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to delete attachment\");\r\n    }\r\n  };\r\n\r\n  const formatFileSize = (bytes: number): string => {\r\n    if (bytes < 1024) return `${bytes} B`;\r\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\r\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\r\n  };\r\n\r\n  const getAttachmentUrl = (attachmentId: string) => {\r\n    return `/api/jobs/${jobId}/attachments/${attachmentId}`;\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n      <div className=\"px-6 py-4 border-b border-slate-200\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h2 className=\"text-lg font-semibold text-slate-900\">Attachments</h2>\r\n            <p className=\"text-xs text-slate-500 mt-1\">\r\n              Upload photos or documents to keep everything in one place\r\n            </p>\r\n          </div>\r\n          {!showUploadForm && (\r\n            <button\r\n              onClick={() => setShowUploadForm(true)}\r\n              className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-amber-700 bg-amber-50 hover:bg-amber-100 rounded-lg transition-colors\"\r\n            >\r\n              <Upload className=\"w-4 h-4 mr-2\" />\r\n              Add Attachment\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"p-6\">\r\n        {error && (\r\n          <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {/* Upload Form */}\r\n        {showUploadForm && (\r\n          <div className=\"mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200\">\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <label\r\n                  htmlFor=\"file-input\"\r\n                  className=\"block text-sm font-medium text-slate-700 mb-2\"\r\n                >\r\n                  Select File (max 2MB)\r\n                </label>\r\n                <input\r\n                  id=\"file-input\"\r\n                  type=\"file\"\r\n                  accept=\"image/*,application/pdf\"\r\n                  onChange={handleFileSelect}\r\n                  className=\"block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-amber-500 file:text-slate-900 hover:file:bg-amber-400 file:cursor-pointer\"\r\n                  disabled={isUploading}\r\n                />\r\n                {selectedFile && (\r\n                  <p className=\"mt-2 text-sm text-slate-600\">\r\n                    Selected: {selectedFile.name} ({formatFileSize(selectedFile.size)})\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              <div>\r\n                <label\r\n                  htmlFor=\"caption-input\"\r\n                  className=\"block text-sm font-medium text-slate-700 mb-2\"\r\n                >\r\n                  Caption (optional)\r\n                </label>\r\n                <input\r\n                  id=\"caption-input\"\r\n                  type=\"text\"\r\n                  value={caption}\r\n                  onChange={(e) => setCaption(e.target.value)}\r\n                  placeholder=\"e.g., Front elevation ÔÇô cracked render\"\r\n                  className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none text-sm\"\r\n                  disabled={isUploading}\r\n                />\r\n                <p className=\"mt-1 text-xs text-slate-500\">\r\n                  Captions help AI understand context when generating quotes\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex gap-2\">\r\n                <button\r\n                  onClick={handleUpload}\r\n                  disabled={isUploading || !selectedFile}\r\n                  className=\"flex-1 inline-flex items-center justify-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isUploading ? (\r\n                    <>\r\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                      Uploading...\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <Upload className=\"w-4 h-4 mr-2\" />\r\n                      Upload\r\n                    </>\r\n                  )}\r\n                </button>\r\n                <button\r\n                  onClick={() => {\r\n                    setShowUploadForm(false);\r\n                    setSelectedFile(null);\r\n                    setCaption(\"\");\r\n                    setError(null);\r\n                  }}\r\n                  disabled={isUploading}\r\n                  className=\"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors disabled:opacity-50\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Attachments List */}\r\n        {isLoading ? (\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <Loader2 className=\"w-6 h-6 animate-spin text-amber-500\" />\r\n          </div>\r\n        ) : attachments.length === 0 ? (\r\n          <div className=\"text-center py-12 text-slate-500\">\r\n            <Upload className=\"w-12 h-12 mx-auto mb-3 text-slate-300\" />\r\n            <p className=\"text-sm\">No attachments yet</p>\r\n            {!showUploadForm && (\r\n              <button\r\n                onClick={() => setShowUploadForm(true)}\r\n                className=\"mt-4 text-sm text-amber-600 hover:text-amber-700 font-medium\"\r\n              >\r\n                Upload your first attachment\r\n              </button>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {attachments.map((attachment) => (\r\n              <div\r\n                key={attachment.id}\r\n                className=\"border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow\"\r\n              >\r\n                {/* Thumbnail/Icon */}\r\n                <div className=\"mb-3\">\r\n                  {attachment.kind === \"IMAGE\" ? (\r\n                    <a\r\n                      href={getAttachmentUrl(attachment.id)}\r\n                      target=\"_blank\"\r\n                      rel=\"noopener noreferrer\"\r\n                      className=\"block aspect-video bg-slate-100 rounded-lg overflow-hidden\"\r\n                    >\r\n                      <img\r\n                        src={getAttachmentUrl(attachment.id)}\r\n                        alt={attachment.caption || attachment.fileName}\r\n                        className=\"w-full h-full object-cover\"\r\n                      />\r\n                    </a>\r\n                  ) : (\r\n                    <div className=\"aspect-video bg-slate-100 rounded-lg flex items-center justify-center\">\r\n                      <FileText className=\"w-12 h-12 text-slate-400\" />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* File Info */}\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"flex items-start justify-between gap-2\">\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"text-sm font-medium text-slate-900 truncate\">\r\n                        {attachment.fileName}\r\n                      </p>\r\n                      <p className=\"text-xs text-slate-500\">\r\n                        {formatFileSize(attachment.fileSize)} ÔÇó {attachment.kind}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Caption */}\r\n                  {editingCaptionId === attachment.id ? (\r\n                    <div className=\"space-y-2\">\r\n                      <input\r\n                        type=\"text\"\r\n                        value={editingCaption}\r\n                        onChange={(e) => setEditingCaption(e.target.value)}\r\n                        placeholder=\"Add a caption...\"\r\n                        className=\"w-full px-2 py-1 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                        autoFocus\r\n                      />\r\n                      <div className=\"flex gap-1\">\r\n                        <button\r\n                          onClick={() => handleUpdateCaption(attachment.id)}\r\n                          className=\"flex-1 px-2 py-1 text-xs bg-amber-500 hover:bg-amber-400 text-slate-900 rounded transition-colors\"\r\n                        >\r\n                          Save\r\n                        </button>\r\n                        <button\r\n                          onClick={() => {\r\n                            setEditingCaptionId(null);\r\n                            setEditingCaption(\"\");\r\n                          }}\r\n                          className=\"px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded transition-colors\"\r\n                        >\r\n                          Cancel\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  ) : (\r\n                    <div>\r\n                      {attachment.caption ? (\r\n                        <p className=\"text-xs text-slate-600 mb-1\">{attachment.caption}</p>\r\n                      ) : (\r\n                        <p className=\"text-xs text-slate-400 italic\">No caption</p>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Actions */}\r\n                  <div className=\"flex items-center gap-2 pt-2 border-t border-slate-100\">\r\n                    <a\r\n                      href={getAttachmentUrl(attachment.id)}\r\n                      target=\"_blank\"\r\n                      rel=\"noopener noreferrer\"\r\n                      className=\"flex-1 inline-flex items-center justify-center px-2 py-1 text-xs font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded transition-colors\"\r\n                    >\r\n                      <Eye className=\"w-3 h-3 mr-1\" />\r\n                      View\r\n                    </a>\r\n                    {editingCaptionId !== attachment.id && (\r\n                      <>\r\n                        <button\r\n                          onClick={() => {\r\n                            setEditingCaptionId(attachment.id);\r\n                            setEditingCaption(attachment.caption || \"\");\r\n                          }}\r\n                          className=\"p-1 text-slate-500 hover:text-amber-600 transition-colors\"\r\n                          title=\"Edit caption\"\r\n                        >\r\n                          <Edit2 className=\"w-3 h-3\" />\r\n                        </button>\r\n                        <button\r\n                          onClick={() => handleDelete(attachment.id)}\r\n                          className=\"p-1 text-slate-500 hover:text-red-600 transition-colors\"\r\n                          title=\"Delete\"\r\n                        >\r\n                          <Trash2 className=\"w-3 h-3\" />\r\n                        </button>\r\n                      </>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientDetailsEntry.tsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":32,"column":3,"severity":1,"nodeType":null,"fix":{"range":[1136,1228],"text":" "}},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientDetailsEntry.tsx:35:7\n  33 |   useEffect(() => {\n  34 |     if (typeof currentClientName === \"string\") {\n> 35 |       setClientName(currentClientName);\n     |       ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  36 |     } else if (currentClientName === null || currentClientName === undefined) {\n  37 |       setClientName(\"\");\n  38 |     }","line":35,"column":7,"nodeType":null,"endLine":35,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\n\nimport { useState, useTransition, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Save, Loader2, Check, AlertTriangle } from \"lucide-react\";\nimport AIWarningBanner from \"@/app/components/AIWarningBanner\";\nimport { updateClientDetails } from \"./actions\";\n\ninterface ClientDetailsEntryProps {\n  jobId: string;\n  currentClientName?: string | null;\n  currentClientEmail?: string | null;\n  planTier?: string;\n}\n\nexport default function ClientDetailsEntry({\n  jobId,\n  currentClientName,\n  currentClientEmail,\n  planTier = \"FREE\",\n}: ClientDetailsEntryProps) {\n  const router = useRouter();\n  const [clientName, setClientName] = useState(currentClientName || \"\");\n  const [clientEmail, setClientEmail] = useState(currentClientEmail || \"\");\n  const [isPending, startTransition] = useTransition();\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n  const [reviewConfirmed, setReviewConfirmed] = useState(false);\n\n  // Sync state with props when they change (e.g., after page refresh)\n  // Only update if props are valid strings (not null/undefined/NaN)\n  // eslint-disable-next-line react-hooks/set-state-in-effect -- Intentional prop sync pattern\n  useEffect(() => {\n    if (typeof currentClientName === \"string\") {\n      setClientName(currentClientName);\n    } else if (currentClientName === null || currentClientName === undefined) {\n      setClientName(\"\");\n    }\n    \n    if (typeof currentClientEmail === \"string\") {\n      setClientEmail(currentClientEmail);\n    } else if (currentClientEmail === null || currentClientEmail === undefined) {\n      setClientEmail(\"\");\n    }\n  }, [currentClientName, currentClientEmail]);\n\n  const validateEmail = (email: string) => {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n    setSuccess(false);\n\n    // Client-side validation\n    if (!clientName.trim()) {\n      setError(\"Client name is required\");\n      return;\n    }\n\n    if (!clientEmail.trim()) {\n      setError(\"Client email is required\");\n      return;\n    }\n\n    if (!validateEmail(clientEmail.trim())) {\n      setError(\"Please enter a valid email address\");\n      return;\n    }\n\n    if (!reviewConfirmed) {\n      setError(\"Please confirm that you have reviewed the AI-generated content\");\n      return;\n    }\n\n    // Validate inputs before calling Server Action\n    const trimmedName = clientName?.trim() || \"\";\n    const trimmedEmail = clientEmail?.trim().toLowerCase() || \"\";\n    \n    if (!trimmedName || !trimmedEmail) {\n      setError(\"Please fill in all required fields\");\n      return;\n    }\n\n    startTransition(async () => {\n      try {\n        const result = await updateClientDetails(\n          jobId,\n          trimmedName,\n          trimmedEmail\n        );\n\n        if (result && result.ok === true) {\n          setSuccess(true);\n          setError(\"\");\n          setTimeout(() => setSuccess(false), 3000);\n          // Refresh the page to show updated details\n          router.refresh();\n        } else {\n          // Show the actual error message from the server\n          const errorMessage = result?.message || \"Failed to save client details\";\n          setError(errorMessage);\n          setSuccess(false);\n        }\n      } catch (err) {\n        console.error(\"[ClientDetailsEntry] Error calling updateClientDetails:\", err);\n        const errorMessage = err instanceof Error \n          ? err.message \n          : \"An unexpected error occurred. Please try again.\";\n        setError(errorMessage);\n        setSuccess(false);\n      }\n    });\n  };\n\n  const hasChanges = \n    clientName !== (currentClientName || \"\") || \n    clientEmail !== (currentClientEmail || \"\");\n\n  const hasPaidPlan = planTier !== \"FREE\";\n\n  return (\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6\">\n      <div className=\"mb-6\">\n        <h2 className=\"text-lg font-semibold text-slate-900 mb-2\">\n          Enter Client Details\n        </h2>\n        <p className=\"text-sm text-slate-600\">\n          Client information is kept private and never sent to AI systems. Enter client details manually after reviewing the AI-generated job pack.\n        </p>\n      </div>\n\n      {/* Free Plan Warning Banner - Only show for non-admins */}\n      {!hasPaidPlan && (\n        <div className=\"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n          <div className=\"flex items-start gap-3\">\n            <AlertTriangle className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" />\n            <div className=\"flex-1\">\n              <p className=\"text-sm font-medium text-amber-900 mb-1\">\n                Free Plan Limitations\n              </p>\n              <p className=\"text-sm text-amber-800\">\n                You can generate job packs for free, but a paid membership is required to save client details and send job packs to clients. Upgrade your plan to unlock these features.\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* AI Warning Banner */}\n      <div className=\"mb-6\">\n        <AIWarningBanner variant=\"compact\" />\n      </div>\n\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\n        {error && (\n          <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm flex items-start gap-2\">\n            <AlertTriangle className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n            <span>{error}</span>\n          </div>\n        )}\n\n        {success && (\n          <div className=\"p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm flex items-center gap-2\">\n            <Check className=\"w-4 h-4\" />\n            <span>Client details saved successfully</span>\n          </div>\n        )}\n\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n          <div>\n            <label htmlFor=\"clientName\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Client Name <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              id=\"clientName\"\n              value={clientName}\n              onChange={(e) => setClientName(e.target.value)}\n              placeholder=\"e.g. John Smith\"\n              className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\n              required\n              disabled={isPending}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"clientEmail\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Client Email <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"email\"\n              id=\"clientEmail\"\n              value={clientEmail}\n              onChange={(e) => setClientEmail(e.target.value)}\n              placeholder=\"e.g. john@example.com\"\n              className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\n              required\n              disabled={isPending}\n            />\n          </div>\n        </div>\n\n        {/* Review Confirmation */}\n        <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n          <label className=\"flex items-start gap-3 cursor-pointer\">\n            <input\n              type=\"checkbox\"\n              checked={reviewConfirmed}\n              onChange={(e) => setReviewConfirmed(e.target.checked)}\n              className=\"mt-0.5 w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500 flex-shrink-0\"\n              disabled={isPending}\n            />\n            <span className=\"text-sm text-amber-900\">\n              <span className=\"font-semibold\">I confirm:</span> I have reviewed all AI-generated content in this job pack and ensured its accuracy and compliance with all applicable Australian laws and regulations before saving client details.\n            </span>\n          </label>\n        </div>\n\n        <div className=\"flex items-center justify-end gap-3\">\n            <button\n            type=\"submit\"\n            disabled={isPending || !hasChanges || !reviewConfirmed}\n            className=\"inline-flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n          >\n            {isPending ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                Saving...\n              </>\n            ) : (\n              <>\n                <Save className=\"w-4 h-4 mr-2\" />\n                Save Client Details\n              </>\n            )}\n          </button>\n        </div>\n      </form>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientQuoteReview.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setIsLoading' is assigned a value but never used.","line":45,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":45,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1972,1975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1972,1975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'documentSummary' is assigned a value but never used.","line":87,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":87,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { Loader2, Check, FileText, XCircle } from \"lucide-react\";\nimport QuoteAcceptanceModal from \"./QuoteAcceptanceModal\";\nimport { calculateEstimateRange } from \"@/lib/pricing\";\n\ninterface ClientQuoteReviewProps {\n  jobId: string;\n  jobTitle: string;\n  address?: string;\n  aiSummary?: string;\n  aiQuote?: string;\n  aiScopeOfWork?: string;\n  aiInclusions?: string;\n  aiExclusions?: string;\n  aiClientNotes?: string;\n  clientStatus?: string;\n  clientAcceptedAt?: string | null;\n  clientDeclinedAt?: string | null;\n  clientSignedName?: string | null;\n  clientSignedEmail?: string | null;\n  userEmail: string;\n  tradieVerificationStatus?: string | null;\n}\n\nexport default function ClientQuoteReview({\n  jobId,\n  jobTitle,\n  address,\n  aiSummary,\n  aiQuote,\n  aiScopeOfWork,\n  aiInclusions,\n  aiExclusions,\n  aiClientNotes,\n  clientStatus,\n  clientAcceptedAt,\n  clientDeclinedAt,\n  clientSignedName,\n  clientSignedEmail,\n  userEmail,\n  tradieVerificationStatus,\n}: ClientQuoteReviewProps) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [showAcceptModal, setShowAcceptModal] = useState(false);\n  const [showDeclineConfirm, setShowDeclineConfirm] = useState(false);\n  const [isDeclining, setIsDeclining] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  const handleAcceptSuccess = () => {\n    // Reload the page to show updated status\n    window.location.reload();\n  };\n\n  const handleDecline = async () => {\n    setIsDeclining(true);\n    setError(\"\");\n\n    try {\n      const response = await fetch(`/api/jobs/${jobId}/decline`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || \"Failed to decline quote.\");\n      }\n\n      // Reload the page to show updated status\n      window.location.reload();\n    } catch (err: any) {\n      console.error(\"Error declining quote:\", err);\n      setError(err.message || \"An unexpected error occurred. Please try again.\");\n      setIsDeclining(false);\n    }\n  };\n\n  // Calculate estimate range for display\n  const estimateRange = aiQuote ? calculateEstimateRange(aiQuote) : null;\n\n  // Build document summary for modal\n  const documentSummary = `Job: ${jobTitle}\n${address ? `Location: ${address}\\n` : \"\"}\n${estimateRange ? `Total Estimate: ${estimateRange.formattedRange}\\n` : \"\"}\n${aiSummary ? `\\nSummary:\\n${aiSummary}` : \"\"}`;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-8\">\n        <Loader2 className=\"w-6 h-6 text-amber-500 animate-spin\" />\n      </div>\n    );\n  }\n\n  const isTradieVerified = tradieVerificationStatus === \"verified\";\n\n  return (\n    <>\n      {/* Structured Badge for Client View */}\n      {isTradieVerified && (\n        <div className=\"mb-4 flex items-center gap-2\">\n          <div className=\"inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-medium text-emerald-700 border border-emerald-300\">\n            <svg className=\"w-3 h-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n            </svg>\n            <span>Verified by OMNEXORA</span>\n          </div>\n        </div>\n      )}\n\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\n        <div className=\"px-6 py-4 border-b border-slate-200\">\n          <h2 className=\"text-xl font-semibold text-slate-900\">Review & Accept Quote</h2>\n          <p className=\"text-sm text-slate-600 mt-1\">Review the quote details below</p>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          {/* Quote Summary */}\n          {aiSummary && (\n            <div>\n              <h3 className=\"text-sm font-medium text-slate-900 mb-2\">Summary</h3>\n              <p className=\"text-slate-700 whitespace-pre-wrap\">{aiSummary}</p>\n            </div>\n          )}\n\n          {/* Pricing */}\n          {estimateRange && (\n            <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n              <h3 className=\"text-sm font-medium text-amber-900 mb-2\">Total Estimate</h3>\n              <p className=\"text-2xl font-bold text-amber-900\">{estimateRange.formattedRange}</p>\n            </div>\n          )}\n\n          {/* Scope of Work */}\n          {aiScopeOfWork && (\n            <div>\n              <h3 className=\"text-sm font-medium text-slate-900 mb-2\">Scope of Work</h3>\n              <div className=\"text-slate-700 whitespace-pre-wrap\">{aiScopeOfWork}</div>\n            </div>\n          )}\n\n          {/* Inclusions */}\n          {aiInclusions && (\n            <div>\n              <h3 className=\"text-sm font-medium text-slate-900 mb-2\">Inclusions</h3>\n              <ul className=\"space-y-1\">\n                {aiInclusions.split(\"\\n\").filter((line) => line.trim()).map((item, i) => (\n                  <li key={i} className=\"flex items-start gap-2 text-slate-700\">\n                    <Check className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" />\n                    <span>{item.trim()}</span>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n\n          {/* Exclusions */}\n          {aiExclusions && (\n            <div>\n              <h3 className=\"text-sm font-medium text-slate-900 mb-2\">Exclusions</h3>\n              <ul className=\"space-y-1\">\n                {aiExclusions.split(\"\\n\").filter((line) => line.trim()).map((item, i) => (\n                  <li key={i} className=\"flex items-start gap-2 text-slate-700\">\n                    <span className=\"text-red-400 mr-1\">├ù</span>\n                    <span>{item.trim()}</span>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n\n          {/* Client Notes */}\n          {aiClientNotes && (\n            <div>\n              <h3 className=\"text-sm font-medium text-slate-900 mb-2\">Notes</h3>\n              <p className=\"text-slate-700 whitespace-pre-wrap\">{aiClientNotes}</p>\n            </div>\n          )}\n\n          {/* Acceptance/Decline Actions */}\n          <div className=\"pt-6 border-t border-slate-200\">\n            {clientStatus === \"accepted\" && clientAcceptedAt ? (\n              <div className=\"p-4 bg-green-50 border border-green-200 rounded-lg\">\n                <div className=\"flex items-start gap-3\">\n                  <Check className=\"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5\" />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-green-900 mb-1\">Quote Accepted & Signed</p>\n                    {clientSignedName && (\n                      <p className=\"text-sm text-green-700\">\n                        Signed by: {clientSignedName}\n                      </p>\n                    )}\n                    {clientSignedEmail && (\n                      <p className=\"text-sm text-green-700\">\n                        Email: {clientSignedEmail}\n                      </p>\n                    )}\n                    <p className=\"text-sm text-green-700\">\n                      Accepted on: {new Date(clientAcceptedAt).toLocaleString(\"en-AU\", {\n                        day: \"numeric\",\n                        month: \"long\",\n                        year: \"numeric\",\n                        hour: \"2-digit\",\n                        minute: \"2-digit\",\n                      })}\n                    </p>\n                  </div>\n                </div>\n              </div>\n            ) : clientStatus === \"declined\" && clientDeclinedAt ? (\n              <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg\">\n                <div className=\"flex items-start gap-3\">\n                  <XCircle className=\"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5\" />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-red-900 mb-1\">Quote Declined</p>\n                    <p className=\"text-sm text-red-700\">\n                      Declined on: {new Date(clientDeclinedAt).toLocaleString(\"en-AU\", {\n                        day: \"numeric\",\n                        month: \"long\",\n                        year: \"numeric\",\n                        hour: \"2-digit\",\n                        minute: \"2-digit\",\n                      })}\n                    </p>\n                  </div>\n                </div>\n              </div>\n            ) : (clientStatus === \"sent\" || clientStatus === \"draft\") ? (\n              <div className=\"space-y-4\">\n                {error && (\n                  <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700\">\n                    {error}\n                  </div>\n                )}\n                <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n                  <p className=\"text-sm text-amber-800 mb-4\">\n                    Please review the quote above. If you agree with the terms, click below to accept and sign.\n                  </p>\n                  <div className=\"flex flex-col sm:flex-row gap-3\">\n                    <button\n                      onClick={() => setShowAcceptModal(true)}\n                      className=\"flex-1 px-4 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors flex items-center justify-center gap-2\"\n                    >\n                      <FileText className=\"w-5 h-5\" />\n                      Accept & Sign Quote\n                    </button>\n                    <button\n                      onClick={() => setShowDeclineConfirm(true)}\n                      className=\"px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-900 font-semibold rounded-lg transition-colors flex items-center justify-center gap-2\"\n                      disabled={isDeclining}\n                    >\n                      <XCircle className=\"w-5 h-5\" />\n                      Decline Quote\n                    </button>\n                  </div>\n                </div>\n              </div>\n            ) : null}\n          </div>\n        </div>\n      </div>\n\n      {/* Accept Modal */}\n      <QuoteAcceptanceModal\n        isOpen={showAcceptModal}\n        onClose={() => setShowAcceptModal(false)}\n        onSuccess={handleAcceptSuccess}\n        jobId={jobId}\n        userEmail={userEmail}\n      />\n\n      {/* Decline Confirmation Modal */}\n      {showDeclineConfirm && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-slate-900 bg-opacity-75 p-4\">\n          <div className=\"relative w-full max-w-md rounded-xl bg-white p-6 shadow-xl\">\n            <h3 className=\"mb-4 text-xl font-bold text-slate-900\">Decline Quote?</h3>\n            <p className=\"mb-6 text-slate-600\">\n              Are you sure you want to decline this quote? This action cannot be undone.\n            </p>\n            {error && (\n              <div className=\"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700\">\n                {error}\n              </div>\n            )}\n            <div className=\"flex justify-end gap-3\">\n              <button\n                type=\"button\"\n                onClick={() => {\n                  setShowDeclineConfirm(false);\n                  setError(\"\");\n                }}\n                className=\"rounded-lg px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100\"\n                disabled={isDeclining}\n              >\n                Cancel\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleDecline}\n                className=\"inline-flex items-center rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed\"\n                disabled={isDeclining}\n              >\n                {isDeclining ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Declining...\n                  </>\n                ) : (\n                  \"Yes, Decline Quote\"\n                )}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientSignatureDisplay.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":66,"column":19,"nodeType":"JSXOpeningElement","endLine":70,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Loader2 } from \"lucide-react\";\r\n\r\ninterface ClientSignatureDisplayProps {\r\n  jobId: string;\r\n  clientSignatureId?: string | null;\r\n  clientSignedName?: string | null;\r\n  clientSignedEmail?: string | null;\r\n  clientAcceptedAt?: string | null;\r\n}\r\n\r\nexport default function ClientSignatureDisplay({\r\n  jobId,\r\n  clientSignatureId,\r\n  clientSignedName,\r\n  clientSignedEmail,\r\n  clientAcceptedAt,\r\n}: ClientSignatureDisplayProps) {\r\n  const [signatureImage, setSignatureImage] = useState<string | null>(null);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  useEffect(() => {\r\n    async function loadSignature() {\r\n      if (!clientSignatureId) {\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      setIsLoading(true);\r\n      try {\r\n        const response = await fetch(`/api/jobs/${jobId}/signature/${clientSignatureId}`);\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          if (data.success && data.imageDataUrl) {\r\n            setSignatureImage(data.imageDataUrl);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to load signature image:\", error);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n    loadSignature();\r\n  }, [jobId, clientSignatureId]);\r\n\r\n  if (!clientSignatureId && !clientSignedName) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6\">\r\n      <h3 className=\"text-lg font-semibold text-slate-900 mb-4\">Client Signature</h3>\r\n      {clientAcceptedAt ? (\r\n        <div className=\"space-y-4\">\r\n          {isLoading ? (\r\n            <div className=\"flex items-center justify-center py-8\">\r\n              <Loader2 className=\"w-6 h-6 text-amber-500 animate-spin\" />\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {signatureImage && (\r\n                <div className=\"border border-slate-200 rounded-lg p-4 bg-slate-50\">\r\n                  <img\r\n                    src={signatureImage}\r\n                    alt=\"Client signature\"\r\n                    className=\"max-w-full h-auto max-h-32 mx-auto\"\r\n                  />\r\n                </div>\r\n              )}\r\n              <div className=\"space-y-2 text-sm\">\r\n                {clientSignedName && (\r\n                  <div>\r\n                    <span className=\"text-slate-500\">Signed by:</span>{\" \"}\r\n                    <span className=\"font-medium text-slate-900\">{clientSignedName}</span>\r\n                  </div>\r\n                )}\r\n                {clientSignedEmail && (\r\n                  <div>\r\n                    <span className=\"text-slate-500\">Email:</span>{\" \"}\r\n                    <span className=\"font-medium text-slate-900\">{clientSignedEmail}</span>\r\n                  </div>\r\n                )}\r\n                <div>\r\n                  <span className=\"text-slate-500\">Date:</span>{\" \"}\r\n                  <span className=\"font-medium text-slate-900\">\r\n                    {new Date(clientAcceptedAt).toLocaleString(\"en-AU\", {\r\n                      day: \"numeric\",\r\n                      month: \"long\",\r\n                      year: \"numeric\",\r\n                      hour: \"2-digit\",\r\n                      minute: \"2-digit\",\r\n                    })}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      ) : (\r\n        <p className=\"text-sm text-slate-500\">No digital signature on record</p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientSignatureModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":4,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { Loader2, X, Check } from \"lucide-react\";\r\n\r\ninterface ClientSignatureModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onSuccess: () => void;\r\n  jobId: string;\r\n  docType: \"QUOTE\" | \"VARIATION\" | \"EOT\" | \"HANDOVER\";\r\n  docKey?: string | null;\r\n  documentTitle: string;\r\n  documentSummary?: string;\r\n}\r\n\r\nexport default function ClientSignatureModal({\r\n  isOpen,\r\n  onClose,\r\n  onSuccess,\r\n  jobId,\r\n  docType,\r\n  docKey,\r\n  documentTitle,\r\n  documentSummary,\r\n}: ClientSignatureModalProps) {\r\n  const canvasRef = useRef<HTMLCanvasElement>(null);\r\n  const [isDrawing, setIsDrawing] = useState(false);\r\n  const [signedName, setSignedName] = useState(\"\");\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  // Initialize canvas\r\n  useEffect(() => {\r\n    if (!isOpen || !canvasRef.current) return;\r\n\r\n    const canvas = canvasRef.current;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    // Set canvas size\r\n    canvas.width = 600;\r\n    canvas.height = 200;\r\n\r\n    // Set drawing style\r\n    ctx.strokeStyle = \"#1e293b\"; // slate-800\r\n    ctx.lineWidth = 2;\r\n    ctx.lineCap = \"round\";\r\n    ctx.lineJoin = \"round\";\r\n  }, [isOpen]);\r\n\r\n  // Reset form when modal opens/closes\r\n  useEffect(() => {\r\n    if (!isOpen) {\r\n      setSignedName(\"\");\r\n      setError(\"\");\r\n      // Clear canvas\r\n      const canvas = canvasRef.current;\r\n      if (canvas) {\r\n        const ctx = canvas.getContext(\"2d\");\r\n        if (ctx) {\r\n          ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        }\r\n      }\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const startDrawing = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\r\n    setIsDrawing(true);\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = \"touches\" in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;\r\n    const y = \"touches\" in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(x, y);\r\n  };\r\n\r\n  const draw = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\r\n    if (!isDrawing) return;\r\n\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = \"touches\" in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;\r\n    const y = \"touches\" in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;\r\n\r\n    ctx.lineTo(x, y);\r\n    ctx.stroke();\r\n  };\r\n\r\n  const stopDrawing = () => {\r\n    setIsDrawing(false);\r\n  };\r\n\r\n  const clearCanvas = () => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n\r\n    if (!signedName.trim()) {\r\n      setError(\"Please enter your full name\");\r\n      return;\r\n    }\r\n\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    // Check if canvas has signature\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    const isEmpty = imageData.data.every((channel) => channel === 0);\r\n\r\n    if (isEmpty) {\r\n      setError(\"Please draw your signature\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      const signatureImage = canvas.toDataURL(\"image/png\");\r\n\r\n      const response = await fetch(`/api/jobs/${jobId}/sign-document`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          docType,\r\n          docKey: docKey || null,\r\n          signedName: signedName.trim(),\r\n          signatureImage,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Failed to sign document\");\r\n      }\r\n\r\n      onSuccess();\r\n      onClose();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to sign document\");\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-slate-900/75 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        {/* Header */}\r\n        <div className=\"px-6 py-4 border-b border-slate-200 flex items-center justify-between sticky top-0 bg-white\">\r\n          <div>\r\n            <h2 className=\"text-lg font-semibold text-slate-900\">Sign & Accept</h2>\r\n            <p className=\"text-sm text-slate-600 mt-1\">{documentTitle}</p>\r\n          </div>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-slate-400 hover:text-slate-600 transition-colors\"\r\n            disabled={isSubmitting}\r\n          >\r\n            <X className=\"w-5 h-5\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n          {documentSummary && (\r\n            <div className=\"p-4 bg-slate-50 rounded-lg border border-slate-200\">\r\n              <h3 className=\"text-sm font-medium text-slate-900 mb-2\">Document Summary</h3>\r\n              <p className=\"text-sm text-slate-700 whitespace-pre-wrap\">{documentSummary}</p>\r\n            </div>\r\n          )}\r\n\r\n          {error && (\r\n            <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n              {error}\r\n            </div>\r\n          )}\r\n\r\n          <div>\r\n            <label htmlFor=\"signedName\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Full Name (as signature) <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              id=\"signedName\"\r\n              value={signedName}\r\n              onChange={(e) => setSignedName(e.target.value)}\r\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n              placeholder=\"Enter your full name\"\r\n              required\r\n              disabled={isSubmitting}\r\n            />\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n              Signature <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <div className=\"border-2 border-slate-300 rounded-lg bg-white overflow-hidden\">\r\n              <canvas\r\n                ref={canvasRef}\r\n                onMouseDown={startDrawing}\r\n                onMouseMove={draw}\r\n                onMouseUp={stopDrawing}\r\n                onMouseLeave={stopDrawing}\r\n                onTouchStart={startDrawing}\r\n                onTouchMove={draw}\r\n                onTouchEnd={stopDrawing}\r\n                className=\"w-full cursor-crosshair touch-none\"\r\n                style={{ height: \"200px\" }}\r\n              />\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              onClick={clearCanvas}\r\n              disabled={isSubmitting}\r\n              className=\"mt-2 text-sm text-slate-600 hover:text-slate-800\"\r\n            >\r\n              Clear signature\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-3 pt-4 border-t border-slate-200\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              disabled={isSubmitting}\r\n              className=\"flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors disabled:opacity-50\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isSubmitting}\r\n              className=\"flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isSubmitting ? (\r\n                <span className=\"flex items-center justify-center\">\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                  Signing...\r\n                </span>\r\n              ) : (\r\n                `Sign & Accept ${docType === \"QUOTE\" ? \"Quote\" : docType === \"VARIATION\" ? \"Variation\" : docType === \"EOT\" ? \"EOT\" : \"Handover\"}`\r\n              )}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientSignatureStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ClientStatusControl.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\CopyForClientButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ParsedQuote' is defined but never used.","line":12,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Copy, Check } from \"lucide-react\";\r\nimport { calculateEstimateRange } from \"@/lib/pricing\";\r\n\r\ninterface TotalEstimateQuote {\r\n  description?: string;\r\n  totalJobEstimate?: string;\r\n}\r\n\r\ninterface ParsedQuote {\r\n  totalEstimate?: TotalEstimateQuote;\r\n}\r\n\r\ninterface CopyForClientButtonProps {\r\n  title: string;\r\n  address?: string;\r\n  summary?: string;\r\n  scopeOfWork?: string;\r\n  inclusions?: string;\r\n  exclusions?: string;\r\n  quoteJson?: string;\r\n}\r\n\r\nexport default function CopyForClientButton({\r\n  title,\r\n  address,\r\n  summary,\r\n  scopeOfWork,\r\n  inclusions,\r\n  exclusions,\r\n  quoteJson,\r\n}: CopyForClientButtonProps) {\r\n  const [copied, setCopied] = useState(false);\r\n\r\n  const handleCopy = async () => {\r\n    // Calculate realistic estimate range\r\n    const estimateRange = calculateEstimateRange(quoteJson);\r\n    const priceRange = estimateRange.formattedRange !== \"N/A\" ? estimateRange.formattedRange : \"\";\r\n\r\n    // Build scope of work as numbered list\r\n    const scopeLines = scopeOfWork?.split(\"\\n\").filter((line) => line.trim()) || [];\r\n    const numberedScope = scopeLines\r\n      .map((line, i) => `${i + 1}. ${line}`)\r\n      .join(\"\\n\");\r\n\r\n    // Build inclusions as bullet list\r\n    const inclusionLines = inclusions?.split(\"\\n\").filter((line) => line.trim()) || [];\r\n    const bulletInclusions = inclusionLines.map((line) => `ÔÇó ${line}`).join(\"\\n\");\r\n\r\n    // Build exclusions as bullet list\r\n    const exclusionLines = exclusions?.split(\"\\n\").filter((line) => line.trim()) || [];\r\n    const bulletExclusions = exclusionLines.map((line) => `ÔÇó ${line}`).join(\"\\n\");\r\n\r\n    // Build the client-friendly text\r\n    const sections: string[] = [];\r\n\r\n    sections.push(`­ƒôï ${title}`);\r\n    \r\n    if (address) {\r\n      sections.push(`­ƒôì ${address}`);\r\n    }\r\n\r\n    sections.push(\"\"); // Empty line\r\n\r\n    if (summary) {\r\n      sections.push(\"SUMMARY\");\r\n      sections.push(summary);\r\n      sections.push(\"\");\r\n    }\r\n\r\n    if (numberedScope) {\r\n      sections.push(\"SCOPE OF WORK\");\r\n      sections.push(numberedScope);\r\n      sections.push(\"\");\r\n    }\r\n\r\n    if (bulletInclusions) {\r\n      sections.push(\"WHAT'S INCLUDED\");\r\n      sections.push(bulletInclusions);\r\n      sections.push(\"\");\r\n    }\r\n\r\n    if (bulletExclusions) {\r\n      sections.push(\"NOT INCLUDED\");\r\n      sections.push(bulletExclusions);\r\n      sections.push(\"\");\r\n    }\r\n\r\n    if (priceRange) {\r\n      sections.push(\"ESTIMATED PRICE\");\r\n      sections.push(priceRange);\r\n      sections.push(\"\");\r\n    }\r\n\r\n    sections.push(\"---\");\r\n    sections.push(\"Generated by OMNEXORA\");\r\n\r\n    const text = sections.join(\"\\n\");\r\n\r\n    try {\r\n      await navigator.clipboard.writeText(text);\r\n      setCopied(true);\r\n      setTimeout(() => setCopied(false), 2000);\r\n    } catch (err) {\r\n      console.error(\"Failed to copy:\", err);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <button\r\n      onClick={handleCopy}\r\n      className=\"inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg bg-amber-500 hover:bg-amber-400 text-slate-900 transition-colors\"\r\n    >\r\n      {copied ? (\r\n        <>\r\n          <Check className=\"w-4 h-4 mr-1.5\" />\r\n          <span>Copied!</span>\r\n        </>\r\n      ) : (\r\n        <>\r\n          <Copy className=\"w-4 h-4 mr-1.5\" />\r\n          <span>Copy for Client</span>\r\n        </>\r\n      )}\r\n    </button>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\DeleteJobButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\DuplicateJobButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":48,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":48,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Copy, Loader2 } from \"lucide-react\";\r\n\r\ninterface DuplicateJobButtonProps {\r\n  jobId: string;\r\n}\r\n\r\nexport default function DuplicateJobButton({ jobId }: DuplicateJobButtonProps) {\r\n  const router = useRouter();\r\n  const [isDuplicating, setIsDuplicating] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  const handleDuplicate = async () => {\r\n    // Optional: confirm with user\r\n    const confirmed = window.confirm(\r\n      \"Create a copy of this job and its job pack?\\n\\nThe new job will have the same details but will be reset to draft status.\"\r\n    );\r\n\r\n    if (!confirmed) {\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setIsDuplicating(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/duplicate`, {\r\n        method: \"POST\",\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        setError(data.error || \"Failed to duplicate job\");\r\n        setIsDuplicating(false);\r\n        return;\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      // Navigate to the new job's detail page\r\n      router.push(`/jobs/${data.jobId}`);\r\n      \r\n      // Show a brief success message (the navigation will happen immediately)\r\n      // The user will see the new job page\r\n    } catch (err) {\r\n      setError(\"An unexpected error occurred\");\r\n      setIsDuplicating(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col items-end gap-1\">\r\n      <button\r\n        onClick={handleDuplicate}\r\n        disabled={isDuplicating}\r\n        className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n      >\r\n        {isDuplicating ? (\r\n          <>\r\n            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n            <span>Duplicating...</span>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <Copy className=\"w-4 h-4 mr-2\" />\r\n            <span>Duplicate Job</span>\r\n          </>\r\n        )}\r\n      </button>\r\n      {error && (\r\n        <p className=\"text-xs text-red-600\">{error}</p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\EmailToClientButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ParsedQuote' is defined but never used.","line":13,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { calculateEstimateRange } from \"@/lib/pricing\";\n\ntype VerificationStatus = \"unverified\" | \"pending\" | \"verified\" | \"pending_review\" | \"rejected\";\n\ninterface TotalEstimateQuote {\n  description?: string;\n  totalJobEstimate?: string;\n}\n\ninterface ParsedQuote {\n  totalEstimate?: TotalEstimateQuote;\n}\n\ninterface EmailToClientButtonProps {\n  title: string;\n  clientEmail?: string;\n  clientName?: string;\n  address?: string;\n  summary?: string;\n  scopeOfWork?: string;\n  inclusions?: string;\n  exclusions?: string;\n  quoteJson?: string;\n  verificationStatus?: VerificationStatus;\n  planTier?: string;\n}\n\nexport default function EmailToClientButton({\n  title,\n  clientEmail,\n  clientName,\n  address,\n  summary,\n  scopeOfWork,\n  inclusions,\n  exclusions,\n  quoteJson,\n  verificationStatus,\n  planTier = \"FREE\",\n}: EmailToClientButtonProps) {\n  const [showAlert, setShowAlert] = useState(false);\n  const [alertMessage, setAlertMessage] = useState(\"\");\n\n  const handleEmail = () => {\n    // PLAN CHECK: Free users cannot email job packs to clients\n    const hasPaidPlan = planTier !== \"FREE\";\n    if (!hasPaidPlan) {\n      setAlertMessage(\"A paid membership is required to email job packs to clients. Please upgrade your plan to continue.\");\n      setShowAlert(true);\n      setTimeout(() => setShowAlert(false), 8000);\n      return;\n    }\n    \n    // STRUCTURING GUARD: Only structured businesses can email job packs to clients.\n    // This is a soft guard for the prototype phase. For public launch, this guard\n    // can be toggled or extended once full structuring flows are implemented.\n    // Note: Copy-to-clipboard and internal use of job packs still work for unstructured users.\n    const isVerified = verificationStatus === \"verified\";\n    if (!isVerified) {\n      setAlertMessage(\"Only structured businesses can email job packs to clients. (Prototype rule)\");\n      setShowAlert(true);\n      setTimeout(() => setShowAlert(false), 5000);\n      return;\n    }\n\n    // Check if client email is set\n    if (!clientEmail) {\n      setAlertMessage(\"Client email not set for this job.\");\n      setShowAlert(true);\n      setTimeout(() => setShowAlert(false), 3000);\n      return;\n    }\n\n    // Calculate realistic estimate range\n    const estimateRange = calculateEstimateRange(quoteJson);\n    const priceRange = estimateRange.formattedRange !== \"N/A\" ? estimateRange.formattedRange : \"\";\n\n    // Build scope of work as numbered list\n    const scopeLines = scopeOfWork?.split(\"\\n\").filter((line) => line.trim()) || [];\n    const numberedScope = scopeLines\n      .map((line, i) => `${i + 1}. ${line}`)\n      .join(\"\\n\");\n\n    // Build inclusions as bullet list\n    const inclusionLines = inclusions?.split(\"\\n\").filter((line) => line.trim()) || [];\n    const bulletInclusions = inclusionLines.map((line) => `- ${line}`).join(\"\\n\");\n\n    // Build exclusions as bullet list\n    const exclusionLines = exclusions?.split(\"\\n\").filter((line) => line.trim()) || [];\n    const bulletExclusions = exclusionLines.map((line) => `- ${line}`).join(\"\\n\");\n\n    // Build the email body\n    const sections: string[] = [];\n\n    // Greeting\n    if (clientName) {\n      sections.push(`Hi ${clientName},`);\n    } else {\n      sections.push(\"Hi,\");\n    }\n    sections.push(\"\");\n    sections.push(\"Please find below your painting quote for the following job:\");\n    sections.push(\"\");\n\n    sections.push(`JOB: ${title}`);\n    \n    if (address) {\n      sections.push(`ADDRESS: ${address}`);\n    }\n\n    sections.push(\"\");\n\n    if (summary) {\n      sections.push(\"SUMMARY\");\n      sections.push(summary);\n      sections.push(\"\");\n    }\n\n    if (numberedScope) {\n      sections.push(\"SCOPE OF WORK\");\n      sections.push(numberedScope);\n      sections.push(\"\");\n    }\n\n    if (bulletInclusions) {\n      sections.push(\"WHAT'S INCLUDED\");\n      sections.push(bulletInclusions);\n      sections.push(\"\");\n    }\n\n    if (bulletExclusions) {\n      sections.push(\"NOT INCLUDED\");\n      sections.push(bulletExclusions);\n      sections.push(\"\");\n    }\n\n    if (priceRange) {\n      sections.push(\"ESTIMATED PRICE\");\n      sections.push(priceRange);\n      sections.push(\"\");\n    }\n\n    sections.push(\"---\");\n    sections.push(\"\");\n    sections.push(\"Please let me know if you have any questions or would like to proceed.\");\n    sections.push(\"\");\n    sections.push(\"Kind regards\");\n\n    const body = sections.join(\"\\n\");\n    const subject = `Painting quote - ${title}`;\n\n    // Build mailto URL\n    const mailtoUrl = `mailto:${encodeURIComponent(clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n\n    // Open email client\n    window.location.href = mailtoUrl;\n  };\n\n  // Show a subtle visual difference for unstructured or free plan users (but still clickable to show the message)\n  const hasPaidPlan = planTier !== \"FREE\";\n  const canEmail = verificationStatus === \"verified\" && hasPaidPlan;\n\n  return (\n    <div className=\"relative\">\n      <button\n        onClick={handleEmail}\n        className={`inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ${\n          canEmail\n            ? \"bg-slate-100 hover:bg-slate-200 text-slate-700\"\n            : \"bg-slate-100 text-slate-400 cursor-not-allowed\"\n        }`}\n        title={canEmail ? \"Email job pack to client\" : (!hasPaidPlan ? \"Paid plan required\" : \"Verification required to email clients\")}\n      >\n        <svg className=\"w-4 h-4 mr-1.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n        </svg>\n        Email to Client\n        {!canEmail && (\n          <svg className=\"w-3 h-3 ml-1 text-amber-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n            <path fillRule=\"evenodd\" d=\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\" clipRule=\"evenodd\" />\n          </svg>\n        )}\n      </button>\n      \n      {/* Alert popup */}\n      {showAlert && (\n        <div className=\"absolute right-0 top-full mt-2 p-3 bg-red-50 border border-red-200 rounded-lg shadow-lg z-10 whitespace-nowrap\">\n          <div className=\"flex items-center gap-2\">\n            <svg className=\"w-4 h-4 text-red-500 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <span className=\"text-sm text-red-700\">{alertMessage}</span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\JobAssignmentPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentUserId' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2280,2283],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2280,2283],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3140,3143],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3140,3143],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Loader2, Mail, Building2, Wrench, MapPin, CheckCircle, UserPlus, AlertCircle } from \"lucide-react\";\r\nimport type { MatchedTradie } from \"@/lib/matching\";\r\n\r\ninterface JobAssignmentPanelProps {\r\n  jobId: string;\r\n  currentUserId?: string | null;\r\n  assignmentStatus?: string | null;\r\n}\r\n\r\nfunction getMatchLabel(score: number): { label: string; color: string } {\r\n  if (score >= 80) {\r\n    return { label: \"Great match\", color: \"text-emerald-700 bg-emerald-100\" };\r\n  } else if (score >= 50) {\r\n    return { label: \"Good match\", color: \"text-blue-700 bg-blue-100\" };\r\n  } else {\r\n    return { label: \"Possible match\", color: \"text-amber-700 bg-amber-100\" };\r\n  }\r\n}\r\n\r\ninterface TradieOption {\r\n  id: string;\r\n  email: string;\r\n  businessName: string | null;\r\n  primaryTrade: string | null;\r\n}\r\n\r\nexport default function JobAssignmentPanel({ \r\n  jobId, \r\n  currentUserId,\r\n  assignmentStatus \r\n}: JobAssignmentPanelProps) {\r\n  const router = useRouter();\r\n  const [matches, setMatches] = useState<MatchedTradie[]>([]);\r\n  const [allTradies, setAllTradies] = useState<TradieOption[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isAssigning, setIsAssigning] = useState<string | null>(null);\r\n  const [selectedTradieId, setSelectedTradieId] = useState(\"\");\r\n  const [isAssigningManual, setIsAssigningManual] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    async function fetchData() {\r\n      setIsLoading(true);\r\n      setError(null);\r\n      try {\r\n        // Fetch suggested matches\r\n        const matchesResponse = await fetch(`/api/jobs/${jobId}/matches`);\r\n        if (matchesResponse.ok) {\r\n          const matchesData = await matchesResponse.json();\r\n          setMatches(matchesData.matches || []);\r\n        }\r\n\r\n        // Fetch all tradies for manual selection\r\n        const tradiesResponse = await fetch(\"/api/admin/tradies\");\r\n        if (tradiesResponse.ok) {\r\n          const tradiesData = await tradiesResponse.json();\r\n          setAllTradies(tradiesData.tradies || []);\r\n        }\r\n      } catch (err: any) {\r\n        setError(err.message || \"Failed to load data\");\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n\r\n    fetchData();\r\n  }, [jobId]);\r\n\r\n  const handleAssign = async (tradieUserId: string) => {\r\n    setIsAssigning(tradieUserId);\r\n    setError(null);\r\n    setSuccess(null);\r\n\r\n    try {\r\n      const response = await fetch(`/api/admin/jobs/${jobId}/assign`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ tradieUserId }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Failed to assign job\");\r\n      }\r\n\r\n      setSuccess(`Job assigned to ${data.job?.userId ? \"tradie\" : \"selected tradie\"}`);\r\n      setTimeout(() => {\r\n        router.refresh();\r\n      }, 1500);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to assign job\");\r\n    } finally {\r\n      setIsAssigning(null);\r\n    }\r\n  };\r\n\r\n  const handleManualAssign = async () => {\r\n    if (!selectedTradieId) {\r\n      setError(\"Please select a tradie\");\r\n      return;\r\n    }\r\n\r\n    setIsAssigningManual(true);\r\n    setError(null);\r\n    setSuccess(null);\r\n\r\n    try {\r\n      await handleAssign(selectedTradieId);\r\n    } finally {\r\n      setIsAssigningManual(false);\r\n    }\r\n  };\r\n\r\n  // Don't show if already assigned\r\n  if (assignmentStatus === \"ASSIGNED\") {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n      <div className=\"px-6 py-4 border-b border-slate-200\">\r\n        <h2 className=\"text-lg font-semibold text-slate-900\">Job Assignment</h2>\r\n        <p className=\"text-xs text-slate-500 mt-1\">\r\n          Assign this client job to a tradie/business account\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"p-6 space-y-6\">\r\n        {error && (\r\n          <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3\">\r\n            <AlertCircle className=\"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5\" />\r\n            <p className=\"text-sm text-red-700\">{error}</p>\r\n          </div>\r\n        )}\r\n\r\n        {success && (\r\n          <div className=\"p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3\">\r\n            <CheckCircle className=\"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5\" />\r\n            <p className=\"text-sm text-green-700\">{success}</p>\r\n          </div>\r\n        )}\r\n\r\n        {/* Suggested Tradies Section */}\r\n        <div>\r\n          <h3 className=\"text-sm font-semibold text-slate-900 mb-3\">Suggested Tradies</h3>\r\n          {isLoading ? (\r\n            <div className=\"flex items-center justify-center py-8\">\r\n              <Loader2 className=\"w-6 h-6 animate-spin text-amber-500 mr-2\" />\r\n              <span className=\"text-slate-600\">Finding suitable tradies...</span>\r\n            </div>\r\n          ) : matches.length === 0 ? (\r\n            <div className=\"text-center py-6 p-4 bg-slate-50 rounded-lg border border-slate-200\">\r\n              <p className=\"text-sm text-slate-600\">\r\n                No strong matches found based on trade and area. You can still manually assign this job below.\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-3\">\r\n              {matches.map((tradie) => {\r\n                const matchInfo = getMatchLabel(tradie.matchScore);\r\n                const workTypes = [];\r\n                if (tradie.workTypes.residential) workTypes.push(\"Residential\");\r\n                if (tradie.workTypes.commercial) workTypes.push(\"Commercial\");\r\n                if (tradie.workTypes.strata) workTypes.push(\"Strata\");\r\n\r\n                return (\r\n                  <div\r\n                    key={tradie.userId}\r\n                    className=\"p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors\"\r\n                  >\r\n                    <div className=\"flex items-start justify-between gap-4 mb-3\">\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center gap-2 mb-1\">\r\n                          <Building2 className=\"w-4 h-4 text-slate-400 flex-shrink-0\" />\r\n                          <h4 className=\"font-semibold text-slate-900 truncate\">\r\n                            {tradie.businessName || tradie.email || \"Unknown\"}\r\n                          </h4>\r\n                        </div>\r\n                        {tradie.primaryTrade && (\r\n                          <div className=\"flex items-center gap-2 text-sm text-slate-600 mb-1\">\r\n                            <Wrench className=\"w-3 h-3\" />\r\n                            <span>{tradie.primaryTrade}</span>\r\n                          </div>\r\n                        )}\r\n                        {tradie.serviceAreaSummary && (\r\n                          <div className=\"flex items-center gap-2 text-sm text-slate-600 mb-1\">\r\n                            <MapPin className=\"w-3 h-3\" />\r\n                            <span className=\"truncate\">{tradie.serviceAreaSummary}</span>\r\n                          </div>\r\n                        )}\r\n                        {workTypes.length > 0 && (\r\n                          <div className=\"flex items-center gap-2 text-xs text-slate-500 mt-2\">\r\n                            <CheckCircle className=\"w-3 h-3\" />\r\n                            <span>{workTypes.join(\", \")}</span>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex flex-col items-end gap-2 flex-shrink-0\">\r\n                        <span\r\n                          className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${matchInfo.color}`}\r\n                        >\r\n                          {matchInfo.label}\r\n                        </span>\r\n                        <span className=\"text-xs text-slate-500\">Score: {tradie.matchScore}</span>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"pt-3 border-t border-slate-100 flex items-center justify-between\">\r\n                      {tradie.email && (\r\n                        <a\r\n                          href={`mailto:${tradie.email}`}\r\n                          className=\"inline-flex items-center gap-1.5 text-sm text-slate-600 hover:text-slate-900\"\r\n                        >\r\n                          <Mail className=\"w-4 h-4\" />\r\n                          <span>{tradie.email}</span>\r\n                        </a>\r\n                      )}\r\n                      <button\r\n                        onClick={() => handleAssign(tradie.userId)}\r\n                        disabled={isAssigning === tradie.userId || isAssigningManual}\r\n                        className=\"inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      >\r\n                        {isAssigning === tradie.userId ? (\r\n                          <>\r\n                            <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                            Assigning...\r\n                          </>\r\n                        ) : (\r\n                          <>\r\n                            <UserPlus className=\"w-4 h-4\" />\r\n                            Assign this job\r\n                          </>\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Manual Assignment Section */}\r\n        <div className=\"pt-6 border-t border-slate-200\">\r\n          <h3 className=\"text-sm font-semibold text-slate-900 mb-3\">Manual Assignment</h3>\r\n          <div className=\"flex gap-3\">\r\n            <select\r\n              value={selectedTradieId}\r\n              onChange={(e) => setSelectedTradieId(e.target.value)}\r\n              disabled={isAssigningManual || isLoading}\r\n              className=\"flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              <option value=\"\">Select a tradie...</option>\r\n              {allTradies.map((tradie) => (\r\n                <option key={tradie.id} value={tradie.id}>\r\n                  {tradie.businessName || tradie.email} {tradie.primaryTrade ? `(${tradie.primaryTrade})` : \"\"}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <button\r\n              onClick={handleManualAssign}\r\n              disabled={!selectedTradieId || isAssigningManual || isLoading}\r\n              className=\"px-6 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {isAssigningManual ? (\r\n                <>\r\n                  <Loader2 className=\"w-4 h-4 animate-spin inline mr-2\" />\r\n                  Assigning...\r\n                </>\r\n              ) : (\r\n                \"Assign to selected tradie\"\r\n              )}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\JobDocumentEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tradeType' is assigned a value but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1923,1926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1923,1926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2434,2437],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2434,2437],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":107,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":107,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Loader2, Save, X, Check, Edit2, Copy, Download, Mail, Lock } from \"lucide-react\";\r\nimport AIWarningBanner from \"@/app/components/AIWarningBanner\";\r\nimport OvisBadge from \"@/app/components/OvisBadge\";\r\n\r\ninterface JobDocumentEditorProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  title: string;\r\n  content: string | null;\r\n  jobId: string;\r\n  documentType: \"SWMS\" | \"VARIATION\" | \"EOT\" | \"PROGRESS_CLAIM\" | \"HANDOVER\" | \"MAINTENANCE\";\r\n  isConfirmed: boolean;\r\n  onSave: (content: string, confirmed: boolean) => Promise<void>;\r\n  jobTitle?: string;\r\n  tradeType?: string;\r\n  address?: string;\r\n  clientName?: string;\r\n  clientEmail?: string;\r\n  hasAccess?: boolean;\r\n  accessMessage?: string;\r\n}\r\n\r\nexport default function JobDocumentEditor({\r\n  isOpen,\r\n  onClose,\r\n  title,\r\n  content: initialContent,\r\n  jobId,\r\n  documentType,\r\n  isConfirmed,\r\n  onSave,\r\n  jobTitle = \"\",\r\n  tradeType = \"\",\r\n  address = \"\",\r\n  clientName = \"\",\r\n  clientEmail = \"\",\r\n  hasAccess = false,\r\n  accessMessage = \"\",\r\n}: JobDocumentEditorProps) {\r\n  const [content, setContent] = useState(initialContent || \"\");\r\n  const [isEditing, setIsEditing] = useState(!isConfirmed);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(\"\");\r\n  const [copied, setCopied] = useState(false);\r\n  const [isDownloading, setIsDownloading] = useState(false);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  const handleSave = async () => {\r\n    if (!content.trim()) {\r\n      setError(\"Document content cannot be empty\");\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setIsSaving(true);\r\n\r\n    try {\r\n      await onSave(content.trim(), true); // Save and confirm\r\n      setIsEditing(false);\r\n      setSuccess(\"Document saved and confirmed successfully\");\r\n      setTimeout(() => setSuccess(\"\"), 3000);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to save document\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveDraft = async () => {\r\n    if (!content.trim()) {\r\n      setError(\"Document content cannot be empty\");\r\n      return;\r\n    }\r\n\r\n    setError(\"\");\r\n    setIsSaving(true);\r\n\r\n    try {\r\n      await onSave(content.trim(), false); // Save without confirming\r\n      setSuccess(\"Draft saved successfully\");\r\n      setTimeout(() => setSuccess(\"\"), 3000);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to save draft\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCancel = () => {\r\n    setContent(initialContent || \"\");\r\n    setIsEditing(false);\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n  };\r\n\r\n  const handleCopy = async () => {\r\n    if (!content) return;\r\n    try {\r\n      await navigator.clipboard.writeText(content);\r\n      setCopied(true);\r\n      setTimeout(() => setCopied(false), 2000);\r\n    } catch (err) {\r\n      setError(\"Failed to copy to clipboard\");\r\n    }\r\n  };\r\n\r\n  const handleEmail = () => {\r\n    if (!hasAccess) {\r\n      setError(accessMessage);\r\n      return;\r\n    }\r\n\r\n    if (!clientEmail) {\r\n      setError(\"Client email not set for this job\");\r\n      return;\r\n    }\r\n\r\n    if (!content) {\r\n      setError(\"No content to email\");\r\n      return;\r\n    }\r\n\r\n    const subject = `${title} - ${jobTitle}`;\r\n    const body = `Hi ${clientName || \"there\"},\\n\\nPlease find the ${title.toLowerCase()} for the following job:\\n\\nJob: ${jobTitle}\\n${address ? `Address: ${address}\\n` : \"\"}\\n---\\n\\n${content}\\n\\n---\\n\\nKind regards`;\r\n    \r\n    const mailtoUrl = `mailto:${encodeURIComponent(clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\r\n    window.location.href = mailtoUrl;\r\n  };\r\n\r\n  const handleDownloadPdf = async () => {\r\n    if (!hasAccess) {\r\n      setError(accessMessage);\r\n      return;\r\n    }\r\n\r\n    if (!content) {\r\n      setError(\"No content to download\");\r\n      return;\r\n    }\r\n\r\n    setIsDownloading(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/documents/${documentType.toLowerCase()}/pdf`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ content }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({ error: \"Failed to generate PDF\" }));\r\n        throw new Error(errorData.error || \"Failed to generate PDF\");\r\n      }\r\n\r\n      const blob = await response.blob();\r\n      const url = window.URL.createObjectURL(blob);\r\n      const a = document.createElement(\"a\");\r\n      a.href = url;\r\n      a.download = `${documentType.toLowerCase()}-${jobId.slice(0, 8)}.pdf`;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      window.URL.revokeObjectURL(url);\r\n      document.body.removeChild(a);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to download PDF\");\r\n    } finally {\r\n      setIsDownloading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-slate-900/75 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white rounded-xl shadow-xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col\">\r\n        {/* Header */}\r\n        <div className=\"px-6 py-4 border-b border-slate-200 flex items-center justify-between\">\r\n          <div className=\"flex-1\">\r\n            <div className=\"flex items-center gap-3 mb-1\">\r\n              <h2 className=\"text-lg font-semibold text-slate-900\">{title}</h2>\r\n              <OvisBadge variant=\"inline\" size=\"sm\" />\r\n              {isConfirmed && !isEditing && (\r\n                <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700\">\r\n                  <Check className=\"w-3 h-3 mr-1\" />\r\n                  Confirmed\r\n                </span>\r\n              )}\r\n              {!isConfirmed && (\r\n                <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700\">\r\n                  Draft - Review Required\r\n                </span>\r\n              )}\r\n            </div>\r\n            <p className=\"text-xs text-slate-500\">\r\n              {isEditing ? \"Edit the document content below, then confirm to use it\" : \"Review the document content\"}\r\n            </p>\r\n          </div>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-slate-400 hover:text-slate-600 transition-colors\"\r\n            disabled={isSaving}\r\n          >\r\n            <X className=\"w-5 h-5\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* AI Warning Banner */}\r\n        <div className=\"px-6 py-4 border-b border-amber-200\">\r\n          <AIWarningBanner variant=\"compact\" />\r\n        </div>\r\n\r\n        {/* Messages */}\r\n        {error && (\r\n          <div className=\"px-6 py-3 bg-red-50 border-b border-red-200\">\r\n            <p className=\"text-sm text-red-700\">{error}</p>\r\n          </div>\r\n        )}\r\n        {success && (\r\n          <div className=\"px-6 py-3 bg-emerald-50 border-b border-emerald-200\">\r\n            <p className=\"text-sm text-emerald-700\">{success}</p>\r\n          </div>\r\n        )}\r\n\r\n        {/* Content Editor */}\r\n        <div className=\"flex-1 overflow-y-auto p-6\">\r\n          {isEditing ? (\r\n            <textarea\r\n              value={content}\r\n              onChange={(e) => setContent(e.target.value)}\r\n              className=\"w-full h-full min-h-[400px] px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none font-mono text-sm leading-relaxed\"\r\n              placeholder=\"Enter document content...\"\r\n              disabled={isSaving}\r\n            />\r\n          ) : (\r\n            <div className=\"bg-slate-50 rounded-lg p-6 border border-slate-200\">\r\n              <pre className=\"whitespace-pre-wrap font-sans text-sm text-slate-700 leading-relaxed\">\r\n                {content || \"No content available\"}\r\n              </pre>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Footer Actions */}\r\n        <div className=\"px-6 py-4 border-t border-slate-200 flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-3\">\r\n            {isEditing ? (\r\n              <>\r\n                <button\r\n                  onClick={handleSaveDraft}\r\n                  disabled={isSaving || !content.trim()}\r\n                  className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isSaving ? (\r\n                    <>\r\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                      Saving...\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <Save className=\"w-4 h-4 mr-2\" />\r\n                      Save Draft\r\n                    </>\r\n                  )}\r\n                </button>\r\n                <button\r\n                  onClick={handleCancel}\r\n                  disabled={isSaving}\r\n                  className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm disabled:opacity-50\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n              </>\r\n            ) : (\r\n              <>\r\n                <button\r\n                  onClick={() => setIsEditing(true)}\r\n                  disabled={isSaving}\r\n                  className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm disabled:opacity-50\"\r\n                >\r\n                  <Edit2 className=\"w-4 h-4 mr-2\" />\r\n                  Edit\r\n                </button>\r\n                {content && (\r\n                  <>\r\n                    <button\r\n                      onClick={handleCopy}\r\n                      className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm\"\r\n                    >\r\n                      {copied ? (\r\n                        <>\r\n                          <Check className=\"w-4 h-4 mr-2\" />\r\n                          Copied\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Copy className=\"w-4 h-4 mr-2\" />\r\n                          Copy\r\n                        </>\r\n                      )}\r\n                    </button>\r\n                    <button\r\n                      onClick={handleEmail}\r\n                      disabled={!hasAccess || !clientEmail}\r\n                      className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      title={!hasAccess ? accessMessage : !clientEmail ? \"Client email not set\" : \"Email to client\"}\r\n                    >\r\n                      {!hasAccess ? (\r\n                        <>\r\n                          <Lock className=\"w-4 h-4 mr-2\" />\r\n                          Email\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Mail className=\"w-4 h-4 mr-2\" />\r\n                          Email\r\n                        </>\r\n                      )}\r\n                    </button>\r\n                    <button\r\n                      onClick={handleDownloadPdf}\r\n                      disabled={!hasAccess || isDownloading}\r\n                      className=\"inline-flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                      title={!hasAccess ? accessMessage : \"Download PDF\"}\r\n                    >\r\n                      {isDownloading ? (\r\n                        <>\r\n                          <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                          Generating...\r\n                        </>\r\n                      ) : !hasAccess ? (\r\n                        <>\r\n                          <Lock className=\"w-4 h-4 mr-2\" />\r\n                          PDF\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Download className=\"w-4 h-4 mr-2\" />\r\n                          Download PDF\r\n                        </>\r\n                      )}\r\n                    </button>\r\n                  </>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-3\">\r\n            {isEditing && (\r\n              <button\r\n                onClick={handleSave}\r\n                disabled={isSaving || !content.trim()}\r\n                className=\"inline-flex items-center px-6 py-2 bg-emerald-500 hover:bg-emerald-400 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {isSaving ? (\r\n                  <>\r\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                    Confirming...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Check className=\"w-4 h-4 mr-2\" />\r\n                    Confirm & Save\r\n                  </>\r\n                )}\r\n              </button>\r\n            )}\r\n            {!isEditing && (\r\n              <button\r\n                onClick={onClose}\r\n                className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm\"\r\n              >\r\n                Close\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\JobDocumentModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\JobDocumentsSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Edit2' is defined but never used.","line":5,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DOCUMENT_STATUS_FIELDS' is assigned a value but never used.","line":72,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showWarning' is assigned a value but never used.","line":88,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":88,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":264,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":264,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":305,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":305,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":336,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":336,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Loader2, FileText, Check, Edit2, Copy, Download, Mail, Lock } from \"lucide-react\";\r\nimport JobDocumentEditor from \"./JobDocumentEditor\";\r\nimport OvisBadge from \"@/app/components/OvisBadge\";\r\nimport DocGeneratorModal from \"@/app/components/docs/DocGeneratorModal\";\r\nimport DocEditor from \"@/app/components/docs/DocEditor\";\r\nimport { featureFlags } from \"@/lib/featureFlags\";\r\nimport { hasDocumentFeatureAccess, getDocumentAccessMessage } from \"@/lib/documentAccess\";\r\nimport type { Job } from \"@/lib/jobs\";\r\nimport type { DocType } from \"@/lib/docEngine/types\";\r\nimport type { SafeUser } from \"@/lib/auth\";\r\n\r\ninterface JobDocumentsSectionProps {\r\n  jobId: string;\r\n  jobTitle: string;\r\n  tradeType: string;\r\n  address?: string;\r\n  clientName?: string;\r\n  clientEmail?: string;\r\n  showWarning?: boolean;\r\n  job?: Job; // Optional job object to check confirmation status\r\n  user?: SafeUser | null; // User info for access control\r\n  planTier?: string; // User plan tier\r\n  planStatus?: string; // User plan status\r\n}\r\n\r\ntype DocumentType = \"SWMS\" | \"VARIATION\" | \"EOT\" | \"PROGRESS_CLAIM\" | \"HANDOVER\" | \"MAINTENANCE\";\r\n\r\ninterface DocumentConfig {\r\n  type: DocumentType;\r\n  label: string;\r\n  apiPath: string;\r\n  description: string;\r\n}\r\n\r\nconst DOCUMENTS: DocumentConfig[] = [\r\n  {\r\n    type: \"VARIATION\",\r\n    label: \"Variation / change order\",\r\n    apiPath: \"variation\",\r\n    description: \"Use this when scope or price changes after the original quote.\",\r\n  },\r\n  {\r\n    type: \"EOT\",\r\n    label: \"Extension of time (EOT)\",\r\n    apiPath: \"eot\",\r\n    description: \"Request additional time to complete the work.\",\r\n  },\r\n  {\r\n    type: \"PROGRESS_CLAIM\",\r\n    label: \"Progress claim / tax invoice\",\r\n    apiPath: \"progress-claim\",\r\n    description: \"Invoice for completed work or progress payments.\",\r\n  },\r\n  {\r\n    type: \"HANDOVER\",\r\n    label: \"Handover & practical completion\",\r\n    apiPath: \"handover\",\r\n    description: \"Document final completion and handover to client.\",\r\n  },\r\n  {\r\n    type: \"MAINTENANCE\",\r\n    label: \"Maintenance & care guide\",\r\n    apiPath: \"maintenance\",\r\n    description: \"Provide care instructions for the completed work.\",\r\n  },\r\n];\r\n\r\nconst DOCUMENT_STATUS_FIELDS: Record<DocumentType, { textField: keyof Job; confirmedField: keyof Job }> = {\r\n  SWMS: { textField: \"swmsText\", confirmedField: \"swmsConfirmed\" }, // Kept for type compatibility but not displayed\r\n  VARIATION: { textField: \"variationText\", confirmedField: \"variationConfirmed\" },\r\n  EOT: { textField: \"eotText\", confirmedField: \"eotConfirmed\" },\r\n  PROGRESS_CLAIM: { textField: \"progressClaimText\", confirmedField: \"progressClaimConfirmed\" },\r\n  HANDOVER: { textField: \"handoverText\", confirmedField: \"handoverConfirmed\" },\r\n  MAINTENANCE: { textField: \"maintenanceText\", confirmedField: \"maintenanceConfirmed\" },\r\n};\r\n\r\nexport default function JobDocumentsSection({\r\n  jobId,\r\n  jobTitle,\r\n  tradeType,\r\n  address,\r\n  clientName,\r\n  clientEmail,\r\n  showWarning = false,\r\n  job,\r\n  user = null,\r\n  planTier = \"FREE\",\r\n  planStatus = \"TRIAL\",\r\n}: JobDocumentsSectionProps) {\r\n  const router = useRouter();\r\n  const [generatingDoc, setGeneratingDoc] = useState<DocumentType | null>(null);\r\n  const [editorOpen, setEditorOpen] = useState(false);\r\n  const [editorContent, setEditorContent] = useState<string | null>(null);\r\n  const [editorTitle, setEditorTitle] = useState(\"\");\r\n  const [editorDocType, setEditorDocType] = useState<DocumentType>(\"SWMS\");\r\n  const [editorConfirmed, setEditorConfirmed] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [docGeneratorOpen, setDocGeneratorOpen] = useState(false);\r\n  const [copiedDoc, setCopiedDoc] = useState<DocumentType | null>(null);\r\n  const [docEditorOpen, setDocEditorOpen] = useState(false);\r\n  const [docEditorType, setDocEditorType] = useState<DocType | null>(null);\r\n  const [documentStatuses, setDocumentStatuses] = useState<Record<DocumentType, { hasContent: boolean; confirmed: boolean }>>({\r\n    SWMS: { hasContent: false, confirmed: false }, // Kept for type compatibility but not displayed\r\n    VARIATION: { hasContent: false, confirmed: false },\r\n    EOT: { hasContent: false, confirmed: false },\r\n    PROGRESS_CLAIM: { hasContent: false, confirmed: false },\r\n    HANDOVER: { hasContent: false, confirmed: false },\r\n    MAINTENANCE: { hasContent: false, confirmed: false },\r\n  });\r\n\r\n  // Check if user has access to document features\r\n  const hasAccess = hasDocumentFeatureAccess(user, { planTier, planStatus, isAdmin: user?.isAdmin ?? false });\r\n  const accessMessage = getDocumentAccessMessage(user, { planTier, planStatus, isAdmin: user?.isAdmin ?? false });\r\n\r\n  // Load document statuses from job\r\n  useEffect(() => {\r\n    if (job) {\r\n      const statuses: Record<DocumentType, { hasContent: boolean; confirmed: boolean }> = {\r\n        SWMS: {\r\n          hasContent: !!job.swmsText,\r\n          confirmed: !!job.swmsConfirmed,\r\n        }, // Kept for type compatibility but not displayed\r\n        VARIATION: {\r\n          hasContent: !!job.variationText,\r\n          confirmed: !!job.variationConfirmed,\r\n        },\r\n        EOT: {\r\n          hasContent: !!job.eotText,\r\n          confirmed: !!job.eotConfirmed,\r\n        },\r\n        PROGRESS_CLAIM: {\r\n          hasContent: !!job.progressClaimText,\r\n          confirmed: !!job.progressClaimConfirmed,\r\n        },\r\n        HANDOVER: {\r\n          hasContent: !!job.handoverText,\r\n          confirmed: !!job.handoverConfirmed,\r\n        },\r\n        MAINTENANCE: {\r\n          hasContent: !!job.maintenanceText,\r\n          confirmed: !!job.maintenanceConfirmed,\r\n        },\r\n      };\r\n      setDocumentStatuses(statuses);\r\n    }\r\n  }, [job]);\r\n\r\n  const handleGenerate = async (doc: DocumentConfig) => {\r\n    setGeneratingDoc(doc.type);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/${doc.apiPath}`, {\r\n        method: \"POST\",\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || `Failed to generate ${doc.label}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      \r\n      // Handle different response formats\r\n      let content = \"\";\r\n      let title = doc.label;\r\n      \r\n      if (data.success) {\r\n        // SWMS returns { success: true, swms: content }\r\n        if (data.swms) {\r\n          content = data.swms;\r\n        } \r\n        // Other documents return { success: true, title: \"...\", body: content }\r\n        else if (data.body) {\r\n          content = data.body;\r\n          title = data.title || doc.label;\r\n        } \r\n        // Fallback formats\r\n        else if (data.document) {\r\n          content = data.document;\r\n        } else if (data.content) {\r\n          content = data.content;\r\n        } else if (typeof data === \"string\") {\r\n          content = data;\r\n        }\r\n      }\r\n\r\n      if (!content) {\r\n        throw new Error(\"No content received from server\");\r\n      }\r\n\r\n      // Save the generated content immediately (as draft)\r\n      try {\r\n        const saveResponse = await fetch(`/api/jobs/${jobId}/documents/${doc.type.toLowerCase()}`, {\r\n          method: \"PUT\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            content: content.trim(),\r\n            confirmed: false, // Not confirmed yet - user must review\r\n          }),\r\n        });\r\n\r\n        if (!saveResponse.ok) {\r\n          console.warn(\"Failed to save document draft\");\r\n        }\r\n      } catch (saveErr) {\r\n        console.warn(\"Error saving document draft:\", saveErr);\r\n      }\r\n\r\n      // Open editor with generated content\r\n      setEditorContent(content);\r\n      setEditorTitle(title);\r\n      setEditorDocType(doc.type);\r\n      setEditorConfirmed(false);\r\n      setEditorOpen(true);\r\n      router.refresh();\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : `Failed to generate ${doc.label}`;\r\n      setError(errorMessage);\r\n    } finally {\r\n      setGeneratingDoc(null);\r\n    }\r\n  };\r\n\r\n  // Map DocumentType to DocType for template engine\r\n  const mapToDocType = (docType: DocumentType): DocType => {\r\n    const mapping: Record<DocumentType, DocType> = {\r\n      VARIATION: \"VARIATION_CHANGE_ORDER\",\r\n      EOT: \"EXTENSION_OF_TIME\",\r\n      PROGRESS_CLAIM: \"PROGRESS_CLAIM_TAX_INVOICE\",\r\n      HANDOVER: \"HANDOVER_PRACTICAL_COMPLETION\",\r\n      MAINTENANCE: \"MAINTENANCE_CARE_GUIDE\",\r\n      SWMS: \"SWMS\", // Not used in new engine but kept for compatibility\r\n    };\r\n    return mapping[docType];\r\n  };\r\n\r\n  const handleOpenEditor = async (docType: DocumentType) => {\r\n    // If DOC_ENGINE_V1 is enabled, use new DocEditor\r\n    if (featureFlags.DOC_ENGINE_V1) {\r\n      const mappedDocType = mapToDocType(docType);\r\n      setDocEditorType(mappedDocType);\r\n      setDocEditorOpen(true);\r\n      return;\r\n    }\r\n\r\n    // Fallback to old editor\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/documents/${docType.toLowerCase()}`);\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setEditorContent(data.content || \"\");\r\n        setEditorConfirmed(data.confirmed || false);\r\n        setEditorTitle(DOCUMENTS.find((d) => d.type === docType)?.label || docType);\r\n        setEditorDocType(docType);\r\n        setEditorOpen(true);\r\n      } else {\r\n        setError(\"Failed to load document\");\r\n      }\r\n    } catch (err) {\r\n      setError(\"Failed to load document\");\r\n    }\r\n  };\r\n\r\n  const handleSaveDocument = async (content: string, confirmed: boolean) => {\r\n    const response = await fetch(`/api/jobs/${jobId}/documents/${editorDocType.toLowerCase()}`, {\r\n      method: \"PUT\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ content, confirmed }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const data = await response.json();\r\n      throw new Error(data.error || \"Failed to save document\");\r\n    }\r\n\r\n    // Update local status\r\n    setDocumentStatuses((prev) => ({\r\n      ...prev,\r\n      [editorDocType]: {\r\n        hasContent: true,\r\n        confirmed,\r\n      },\r\n    }));\r\n\r\n    router.refresh();\r\n  };\r\n\r\n  const handleCopyDocument = async (docType: DocumentType) => {\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/documents/${docType.toLowerCase()}`);\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        const content = data.content || \"\";\r\n        await navigator.clipboard.writeText(content);\r\n        setCopiedDoc(docType);\r\n        setTimeout(() => setCopiedDoc(null), 2000);\r\n      } else {\r\n        setError(\"Failed to copy document\");\r\n      }\r\n    } catch (err) {\r\n      setError(\"Failed to copy document\");\r\n    }\r\n  };\r\n\r\n  const handleEmailDocument = async (docType: DocumentType) => {\r\n    if (!hasAccess) {\r\n      setError(accessMessage);\r\n      return;\r\n    }\r\n\r\n    if (!clientEmail) {\r\n      setError(\"Client email not set for this job\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/documents/${docType.toLowerCase()}`);\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        const content = data.content || \"\";\r\n        const docLabel = DOCUMENTS.find((d) => d.type === docType)?.label || docType;\r\n        \r\n        const subject = `${docLabel} - ${jobTitle}`;\r\n        const body = `Hi ${clientName || \"there\"},\\n\\nPlease find attached the ${docLabel.toLowerCase()} for the following job:\\n\\nJob: ${jobTitle}\\n${address ? `Address: ${address}\\n` : \"\"}\\n---\\n\\n${content}\\n\\n---\\n\\nKind regards`;\r\n        \r\n        const mailtoUrl = `mailto:${encodeURIComponent(clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\r\n        window.location.href = mailtoUrl;\r\n      } else {\r\n        setError(\"Failed to load document for email\");\r\n      }\r\n    } catch (err) {\r\n      setError(\"Failed to email document\");\r\n    }\r\n  };\r\n\r\n  const handleDownloadPdf = async (docType: DocumentType) => {\r\n    if (!hasAccess) {\r\n      setError(accessMessage);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/documents/${docType.toLowerCase()}/pdf`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({ error: \"Failed to generate PDF\" }));\r\n        throw new Error(errorData.error || \"Failed to generate PDF\");\r\n      }\r\n\r\n      const blob = await response.blob();\r\n      const url = window.URL.createObjectURL(blob);\r\n      const a = document.createElement(\"a\");\r\n      a.href = url;\r\n      a.download = `${docType.toLowerCase()}-${jobId.slice(0, 8)}.pdf`;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      window.URL.revokeObjectURL(url);\r\n      document.body.removeChild(a);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to download PDF\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n        <div className=\"px-6 py-4 border-b border-slate-200\">\r\n          <div className=\"flex items-center justify-between gap-4 mb-2\">\r\n            <h2 className=\"text-lg font-semibold text-slate-900\">Job Documents</h2>\r\n            <OvisBadge variant=\"inline\" size=\"sm\" />\r\n          </div>\r\n          <div className=\"flex items-center justify-between\">\r\n            <p className=\"text-xs text-slate-500\">\r\n              Generate professional documents for this job. All documents must be reviewed and confirmed before use.\r\n            </p>\r\n            {featureFlags.DOC_ENGINE_V1 && (\r\n              <button\r\n                onClick={() => setDocGeneratorOpen(true)}\r\n                className=\"text-xs text-amber-600 hover:text-amber-700 font-medium underline\"\r\n              >\r\n                Generate Document ÔåÆ\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n        <div className=\"p-6\">\r\n          {error && (\r\n            <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n              <p className=\"text-sm text-red-700\">{error}</p>\r\n            </div>\r\n          )}\r\n          \r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {DOCUMENTS.map((doc) => {\r\n              const status = documentStatuses[doc.type];\r\n              const hasContent = status.hasContent;\r\n              const isConfirmed = status.confirmed;\r\n\r\n              return (\r\n                <div key={doc.type} className=\"relative\">\r\n                  <div className={`w-full p-4 border rounded-lg transition-colors ${\r\n                    isConfirmed\r\n                      ? \"border-emerald-200 bg-emerald-50\"\r\n                      : hasContent\r\n                      ? \"border-amber-200 bg-amber-50\"\r\n                      : \"border-slate-200\"\r\n                  }`}>\r\n                    <button\r\n                      onClick={() => {\r\n                        // If DOC_ENGINE_V1 is enabled, always use new editor (it will load draft or generate)\r\n                        if (featureFlags.DOC_ENGINE_V1) {\r\n                          const mappedDocType = mapToDocType(doc.type);\r\n                          setDocEditorType(mappedDocType);\r\n                          setDocEditorOpen(true);\r\n                        } else if (hasContent) {\r\n                          handleOpenEditor(doc.type);\r\n                        } else {\r\n                          handleGenerate(doc);\r\n                        }\r\n                      }}\r\n                      disabled={generatingDoc !== null}\r\n                      className=\"w-full text-left disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                      <div className=\"flex items-start gap-3 mb-3\">\r\n                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${\r\n                          isConfirmed ? \"bg-emerald-100\" : hasContent ? \"bg-amber-100\" : \"bg-amber-100\"\r\n                        }`}>\r\n                          {generatingDoc === doc.type ? (\r\n                            <Loader2 className=\"w-5 h-5 text-amber-600 animate-spin\" />\r\n                          ) : (\r\n                            <FileText className={`w-5 h-5 ${isConfirmed ? \"text-emerald-600\" : \"text-amber-600\"}`} />\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-center gap-2 mb-1\">\r\n                            <h3 className=\"font-medium text-slate-900\">{doc.label}</h3>\r\n                            {isConfirmed && (\r\n                              <Check className=\"w-4 h-4 text-emerald-600 flex-shrink-0\" />\r\n                            )}\r\n                            {hasContent && !isConfirmed && (\r\n                              <span className=\"text-xs text-amber-600 font-medium\">Draft</span>\r\n                            )}\r\n                          </div>\r\n                          <p className=\"text-xs text-slate-500\">{doc.description}</p>\r\n                          {hasContent && !isConfirmed && (\r\n                            <p className=\"text-xs text-amber-600 mt-1 font-medium\">\r\n                              Review & confirm required\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </button>\r\n                    \r\n                    {/* Action buttons - only show if document has content */}\r\n                    {hasContent && (\r\n                      <div className=\"flex items-center gap-2 pt-3 border-t border-slate-200 mt-3\">\r\n                        <button\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            handleCopyDocument(doc.type);\r\n                          }}\r\n                          className=\"inline-flex items-center px-2 py-1 text-xs font-medium text-slate-700 bg-white hover:bg-slate-50 rounded transition-colors border border-slate-300\"\r\n                          title=\"Copy to clipboard\"\r\n                        >\r\n                          {copiedDoc === doc.type ? (\r\n                            <>\r\n                              <Check className=\"w-3 h-3 mr-1\" />\r\n                              Copied\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <Copy className=\"w-3 h-3 mr-1\" />\r\n                              Copy\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                        <button\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            handleEmailDocument(doc.type);\r\n                          }}\r\n                          disabled={!hasAccess || !clientEmail}\r\n                          className=\"inline-flex items-center px-2 py-1 text-xs font-medium text-slate-700 bg-white hover:bg-slate-50 rounded transition-colors border border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                          title={!hasAccess ? accessMessage : !clientEmail ? \"Client email not set\" : \"Email to client\"}\r\n                        >\r\n                          {!hasAccess ? (\r\n                            <>\r\n                              <Lock className=\"w-3 h-3 mr-1\" />\r\n                              Email\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <Mail className=\"w-3 h-3 mr-1\" />\r\n                              Email\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                        <button\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            handleDownloadPdf(doc.type);\r\n                          }}\r\n                          disabled={!hasAccess}\r\n                          className=\"inline-flex items-center px-2 py-1 text-xs font-medium text-slate-700 bg-white hover:bg-slate-50 rounded transition-colors border border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                          title={!hasAccess ? accessMessage : \"Download PDF\"}\r\n                        >\r\n                          {!hasAccess ? (\r\n                            <>\r\n                              <Lock className=\"w-3 h-3 mr-1\" />\r\n                              PDF\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <Download className=\"w-3 h-3 mr-1\" />\r\n                              PDF\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <JobDocumentEditor\r\n        isOpen={editorOpen}\r\n        onClose={() => {\r\n          setEditorOpen(false);\r\n          setEditorContent(null);\r\n          setError(null);\r\n        }}\r\n        title={editorTitle}\r\n        content={editorContent}\r\n        jobId={jobId}\r\n        documentType={editorDocType}\r\n        isConfirmed={editorConfirmed}\r\n        onSave={handleSaveDocument}\r\n        jobTitle={jobTitle}\r\n        tradeType={tradeType}\r\n        address={address}\r\n        clientName={clientName}\r\n        clientEmail={clientEmail}\r\n        hasAccess={hasAccess}\r\n        accessMessage={accessMessage}\r\n      />\r\n\r\n      {/* Document Generator Modal - V1 */}\r\n      {featureFlags.DOC_ENGINE_V1 && (\r\n        <DocGeneratorModal\r\n          isOpen={docGeneratorOpen}\r\n          onClose={() => setDocGeneratorOpen(false)}\r\n          jobId={jobId}\r\n          jobData={{\r\n            jobId,\r\n            jobTitle,\r\n            tradeType,\r\n            propertyType: job?.propertyType || \"\",\r\n            address: address || \"\",\r\n            clientName: clientName || \"\",\r\n            clientEmail: job?.clientEmail || \"\",\r\n            businessName: \"\",\r\n            abn: \"\",\r\n            createdAt: job?.createdAt || new Date().toISOString(),\r\n            notes: job?.notes || \"\",\r\n          }}\r\n        />\r\n      )}\r\n      \r\n      {/* New DocEditor for DOC_ENGINE_V1 */}\r\n      {featureFlags.DOC_ENGINE_V1 && docEditorOpen && docEditorType && (\r\n        <DocEditor\r\n          jobId={jobId}\r\n          docType={docEditorType}\r\n          onClose={() => {\r\n            setDocEditorOpen(false);\r\n            setDocEditorType(null);\r\n            router.refresh(); // Refresh to update document statuses\r\n          }}\r\n          user={user}\r\n          planTier={planTier}\r\n          planStatus={planStatus}\r\n          clientEmail={clientEmail}\r\n          clientName={clientName}\r\n          jobTitle={jobTitle}\r\n          address={address}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\JobPackPdfButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2927,2930],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2927,2930],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { Download, Loader2 } from \"lucide-react\";\nimport { PdfDocument, formatCurrency, formatDate, formatDateTime } from \"@/lib/pdfGenerator\";\nimport { calculateEstimateRange } from \"@/lib/pricing\";\n\ninterface LabourQuote {\n  description?: string;\n  hours?: string;\n  ratePerHour?: string;\n  total?: string;\n}\n\ninterface MaterialsQuote {\n  description?: string;\n  totalMaterialsCost?: string;\n}\n\ninterface TotalEstimateQuote {\n  description?: string;\n  totalJobEstimate?: string;\n}\n\ninterface ParsedQuote {\n  labour?: LabourQuote;\n  materials?: MaterialsQuote;\n  totalEstimate?: TotalEstimateQuote;\n}\n\ninterface MaterialItem {\n  item: string;\n  quantity?: string;\n  estimatedCost?: string;\n}\n\ninterface BusinessProfile {\n  legalName?: string;\n  tradingName?: string;\n  abn?: string;\n  email?: string;\n  phone?: string;\n  addressLine1?: string;\n  addressLine2?: string;\n  suburb?: string;\n  state?: string;\n  postcode?: string;\n}\n\ninterface JobPackPdfButtonProps {\n  jobId: string;\n  jobTitle: string;\n  jobCreatedAt: string;\n  tradeType: string;\n  propertyType?: string;\n  address?: string;\n  clientName?: string;\n  notes?: string;\n  aiSummary?: string;\n  aiQuote?: string;\n  aiScopeOfWork?: string;\n  aiInclusions?: string;\n  aiExclusions?: string;\n  aiMaterials?: string;\n  aiClientNotes?: string;\n  materialsOverrideText?: string | null;\n  materialsAreRoughEstimate?: boolean;\n  materialsTotal?: number | null;\n  clientSignatureId?: string | null;\n  clientSignedName?: string | null;\n  clientSignedEmail?: string | null;\n  clientAcceptedAt?: string | null;\n  clientAcceptedByName?: string | null;\n  clientAcceptanceNote?: string | null;\n  clientAcceptedQuoteVer?: number | null;\n  quoteNumber?: string | null;\n  // Business profile for header\n  businessProfile?: BusinessProfile | null;\n}\n\nexport default function JobPackPdfButton({\n  jobId,\n  jobTitle,\n  jobCreatedAt,\n  tradeType,\n  propertyType,\n  address,\n  clientName,\n  notes,\n  aiSummary,\n  aiQuote,\n  aiScopeOfWork,\n  aiInclusions,\n  aiExclusions,\n  aiMaterials,\n  aiClientNotes,\n  materialsOverrideText,\n  materialsAreRoughEstimate,\n  materialsTotal,\n  clientSignatureId,\n  clientSignedName,\n  clientSignedEmail,\n  clientAcceptedAt,\n  clientAcceptedByName,\n  clientAcceptanceNote,\n  clientAcceptedQuoteVer,\n  quoteNumber,\n  businessProfile,\n}: JobPackPdfButtonProps) {\n  const [isGenerating, setIsGenerating] = useState(false);\n\n  const handleDownloadPdf = async () => {\n    setIsGenerating(true);\n\n    // Fetch job materials if they exist\n    let jobMaterials: Array<{\n      name: string;\n      unitLabel: string;\n      quantity: number;\n      lineTotal: number | null;\n    }> = [];\n    try {\n      const materialsRes = await fetch(`/api/jobs/${jobId}/materials`);\n      if (materialsRes.ok) {\n        const materialsData = await materialsRes.json();\n        jobMaterials = (materialsData.materials || []).map((m: any) => ({\n          name: m.name,\n          unitLabel: m.unitLabel,\n          quantity: m.quantity,\n          lineTotal: m.lineTotal,\n        }));\n      }\n    } catch (err) {\n      console.warn(\"Failed to fetch job materials for PDF:\", err);\n    }\n\n    // Fetch client signature if exists\n    let clientSignature: {\n      signedName: string;\n      signedEmail: string;\n      signedAt: string;\n      signatureImage: string | null;\n    } | null = null;\n\n    if (clientSignatureId && clientSignedName && clientAcceptedAt) {\n      try {\n        const sigResponse = await fetch(`/api/jobs/${jobId}/signature/${clientSignatureId}`);\n        if (sigResponse.ok) {\n          const sigData = await sigResponse.json();\n          if (sigData.success) {\n            clientSignature = {\n              signedName: clientSignedName,\n              signedEmail: clientSignedEmail || \"\",\n              signedAt: clientAcceptedAt,\n              signatureImage: sigData.imageDataUrl || null,\n            };\n          }\n        }\n      } catch (sigError) {\n        console.warn(\"Failed to load signature for PDF:\", sigError);\n        if (clientSignedName && clientAcceptedAt) {\n          clientSignature = {\n            signedName: clientSignedName,\n            signedEmail: clientSignedEmail || \"\",\n            signedAt: clientAcceptedAt,\n            signatureImage: null,\n          };\n        }\n      }\n    }\n\n    try {\n      const pdf = new PdfDocument();\n\n      // =========================================\n      // BUSINESS HEADER\n      // =========================================\n      if (businessProfile?.legalName) {\n        pdf.addBusinessHeader(businessProfile);\n      } else {\n        pdf.addBrandedHeader(\"Job Pack\");\n      }\n\n      // =========================================\n      // JOB TITLE\n      // =========================================\n      pdf.addTitle(jobTitle);\n      pdf.addText(\"Job Pack / Quote\", { fontSize: 10, color: [100, 116, 139] });\n      pdf.addSpace(4);\n\n      // =========================================\n      // JOB METADATA\n      // =========================================\n      const metaItems: Array<{ label: string; value: string }> = [];\n      if (tradeType) metaItems.push({ label: \"Trade\", value: tradeType });\n      if (propertyType) metaItems.push({ label: \"Property\", value: propertyType });\n      if (address) metaItems.push({ label: \"Address\", value: address });\n      if (clientName) metaItems.push({ label: \"Client\", value: clientName });\n      metaItems.push({ label: \"Date\", value: formatDate(jobCreatedAt) });\n      pdf.addMetadata(metaItems);\n\n      // =========================================\n      // AI WARNING (only if no business profile - internal draft)\n      // =========================================\n      if (!businessProfile?.legalName) {\n        pdf.addAiWarning();\n      }\n\n      // =========================================\n      // SUMMARY\n      // =========================================\n      if (aiSummary) {\n        pdf.addSectionHeading(\"Summary\");\n        pdf.addParagraph(aiSummary);\n      }\n\n      // =========================================\n      // PRICING\n      // =========================================\n      if (aiQuote) {\n        try {\n          const quote: ParsedQuote = JSON.parse(aiQuote);\n          pdf.addSectionHeading(\"Pricing\");\n\n          if (quote.labour) {\n            pdf.addSubheading(\"Labour\");\n            if (quote.labour.description) {\n              pdf.addParagraph(quote.labour.description);\n            }\n            const labourDetails: string[] = [];\n            if (quote.labour.hours) labourDetails.push(`Hours: ${quote.labour.hours}`);\n            if (quote.labour.ratePerHour) labourDetails.push(`Rate: ${quote.labour.ratePerHour}`);\n            if (quote.labour.total) labourDetails.push(`Total: ${quote.labour.total}`);\n            if (labourDetails.length > 0) {\n              pdf.addParagraph(labourDetails.join(\"  |  \"));\n            }\n          }\n\n          if (quote.materials) {\n            pdf.addSubheading(\"Materials\");\n            if (quote.materials.description) {\n              pdf.addParagraph(quote.materials.description);\n            }\n            if (quote.materials.totalMaterialsCost) {\n              pdf.addParagraph(`Total: ${quote.materials.totalMaterialsCost}`);\n            }\n          }\n\n          if (quote.totalEstimate) {\n            const estimateRange = calculateEstimateRange(aiQuote);\n            pdf.addHighlightBox({\n              label: \"Total Estimate\",\n              value: estimateRange.formattedRange,\n            });\n          }\n        } catch {\n          // Skip pricing if JSON parsing fails\n        }\n      }\n\n      // =========================================\n      // SCOPE OF WORK\n      // =========================================\n      if (aiScopeOfWork) {\n        pdf.addSectionHeading(\"Scope of Work\");\n        const scopeItems = aiScopeOfWork.split(\"\\n\").filter((line) => line.trim());\n        pdf.addNumberedList(scopeItems);\n      }\n\n      // =========================================\n      // INCLUSIONS\n      // =========================================\n      if (aiInclusions) {\n        pdf.addSectionHeading(\"What's Included\");\n        const inclusionItems = aiInclusions.split(\"\\n\").filter((line) => line.trim());\n        pdf.addInclusionsList(inclusionItems);\n      }\n\n      // =========================================\n      // EXCLUSIONS\n      // =========================================\n      if (aiExclusions) {\n        pdf.addSectionHeading(\"Not Included\");\n        const exclusionItems = aiExclusions.split(\"\\n\").filter((line) => line.trim());\n        pdf.addExclusionsList(exclusionItems);\n      }\n\n      // =========================================\n      // MATERIALS\n      // =========================================\n      const hasOverride = materialsOverrideText && materialsOverrideText.trim().length > 0;\n      const showMaterialsDisclaimer = materialsAreRoughEstimate || !hasOverride;\n      const hasJobMaterials = jobMaterials && jobMaterials.length > 0;\n\n      if (hasJobMaterials) {\n        pdf.addSectionHeading(\"Materials\");\n        \n        // Build table data\n        const headers = [\"Material\", \"Qty\", \"Unit\", \"Total\"];\n        const rows = jobMaterials.map((m) => [\n          m.name,\n          m.quantity.toString(),\n          m.unitLabel,\n          formatCurrency(m.lineTotal || 0),\n        ]);\n        \n        pdf.addTable(headers, rows, { colWidths: [80, 25, 30, 35] });\n\n        // Total row\n        const materialsTableTotal = jobMaterials.reduce((sum, m) => sum + (m.lineTotal || 0), 0);\n        const finalTotal = materialsTotal != null ? materialsTotal : materialsTableTotal;\n        pdf.addHighlightBox({\n          label: \"Materials Total\",\n          value: formatCurrency(finalTotal),\n        });\n      } else if (hasOverride) {\n        pdf.addSectionHeading(\"Materials\");\n        pdf.addText(\"Final materials notes (overrides AI suggestion)\", {\n          fontSize: 9,\n          fontWeight: \"normal\",\n          color: [59, 130, 246],\n        });\n        pdf.addSpace(4);\n        pdf.addParagraph(materialsOverrideText);\n      } else if (aiMaterials) {\n        try {\n          const materials: MaterialItem[] = JSON.parse(aiMaterials);\n          if (Array.isArray(materials) && materials.length > 0) {\n            pdf.addSectionHeading(\"Materials\");\n            \n            const headers = [\"Item\", \"Qty\", \"Est. Cost\"];\n            const rows = materials.map((m) => [\n              m.item || \"\",\n              m.quantity || \"-\",\n              m.estimatedCost || \"-\",\n            ]);\n            \n            pdf.addTable(headers, rows, { colWidths: [90, 35, 45] });\n          }\n        } catch {\n          // Skip if JSON parsing fails\n        }\n      }\n\n      // Materials disclaimer\n      if ((hasOverride || aiMaterials || hasJobMaterials) && showMaterialsDisclaimer) {\n        pdf.addText(\n          \"Note: Material prices are an estimate only and must be checked against current supplier pricing.\",\n          { fontSize: 9, color: [180, 83, 9] }\n        );\n        pdf.addSpace(6);\n      }\n\n      // =========================================\n      // CLIENT NOTES\n      // =========================================\n      if (aiClientNotes) {\n        pdf.addSectionHeading(\"Notes for Client\");\n        pdf.addParagraph(aiClientNotes);\n      }\n\n      // =========================================\n      // JOB DETAILS\n      // =========================================\n      if (notes) {\n        pdf.addSectionHeading(\"Job Details\");\n        pdf.addParagraph(notes);\n      }\n\n      // =========================================\n      // CLIENT ACCEPTANCE\n      // =========================================\n      if (clientAcceptedAt && (clientAcceptedByName || clientSignedName)) {\n        pdf.addSectionHeading(\"Client Acceptance\");\n\n        // Add signature image if available\n        if (clientSignature?.signatureImage) {\n          pdf.addImage(clientSignature.signatureImage, { width: 80, height: 30 });\n        }\n\n        const acceptedByName = clientAcceptedByName || clientSignedName || \"Unknown\";\n        pdf.addParagraph(`Accepted by: ${acceptedByName}`);\n        \n        if (clientSignedEmail) {\n          pdf.addParagraph(`Email: ${clientSignedEmail}`);\n        }\n        \n        pdf.addParagraph(`Accepted on: ${formatDateTime(clientAcceptedAt)}`);\n        \n        if (quoteNumber && clientAcceptedQuoteVer) {\n          pdf.addParagraph(`Quote: ${quoteNumber} v${clientAcceptedQuoteVer}`);\n        }\n        \n        if (clientAcceptanceNote && clientAcceptanceNote.trim()) {\n          pdf.addSubheading(\"Client note:\");\n          pdf.addParagraph(clientAcceptanceNote);\n        }\n      }\n\n      // =========================================\n      // FOOTER\n      // =========================================\n      if (businessProfile?.legalName) {\n        // Professional footer for client-facing export\n        pdf.addIssuedFooter(businessProfile.legalName, `JP-${jobId.slice(0, 8).toUpperCase()}`);\n      } else {\n        // Standard footer with AI warnings for internal use\n        pdf.addStandardFooters({ jobId });\n      }\n\n      // Save the PDF\n      const filename = `job-pack-${jobId.slice(0, 8)}.pdf`;\n      pdf.save(filename);\n    } catch (error) {\n      console.error(\"Error generating PDF:\", error);\n      alert(\"Failed to generate PDF. Please try again.\");\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  return (\n    <button\n      onClick={handleDownloadPdf}\n      disabled={isGenerating}\n      className=\"inline-flex items-center px-3 py-1.5 text-sm font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n      title=\"Download job pack as PDF\"\n    >\n      {isGenerating ? (\n        <>\n          <Loader2 className=\"w-4 h-4 mr-1.5 animate-spin\" />\n          <span>Generating...</span>\n        </>\n      ) : (\n        <>\n          <Download className=\"w-4 h-4 mr-1.5\" />\n          <span>Download PDF</span>\n        </>\n      )}\n    </button>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\JobStatusControl.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\MaterialsEditButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\MaterialsManagementSection.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":58,"column":6,"nodeType":"ArrayExpression","endLine":58,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [fetchData, jobId]","fix":{"range":[1467,1474],"text":"[fetchData, jobId]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":123,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { Plus, Edit2, Trash2, X, Save, Loader2 } from \"lucide-react\";\n\ninterface MaterialItem {\n  id: string;\n  name: string;\n  category: string | null;\n  supplier: string | null;\n  unitLabel: string;\n  unitCost: number | null;\n  notes: string | null;\n}\n\ninterface JobMaterial {\n  id: string;\n  materialItemId: string | null;\n  name: string;\n  unitLabel: string;\n  unitCost: number | null;\n  quantity: number;\n  markupPercent: number | null;\n  notes: string | null;\n  lineTotal: number | null;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface MaterialsManagementSectionProps {\n  jobId: string;\n  materialsTotal?: number | null;\n}\n\nexport default function MaterialsManagementSection({\n  jobId,\n  materialsTotal,\n}: MaterialsManagementSectionProps) {\n  const [jobMaterials, setJobMaterials] = useState<JobMaterial[]>([]);\n  const [libraryMaterials, setLibraryMaterials] = useState<MaterialItem[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState(\"\");\n  const [showAddForm, setShowAddForm] = useState(false);\n  const [editingId, setEditingId] = useState<string | null>(null);\n  const [formData, setFormData] = useState({\n    materialItemId: \"\",\n    name: \"\",\n    unitLabel: \"\",\n    unitCost: \"\",\n    quantity: \"\",\n    markupPercent: \"\",\n    notes: \"\",\n  });\n  const [librarySearch, setLibrarySearch] = useState(\"\");\n\n  useEffect(() => {\n    fetchData();\n  }, [jobId]);\n\n  const fetchData = async () => {\n    try {\n      setIsLoading(true);\n      const [materialsRes, libraryRes] = await Promise.all([\n        fetch(`/api/jobs/${jobId}/materials`),\n        fetch(\"/api/materials?includeArchived=false\"),\n      ]);\n\n      if (!materialsRes.ok || !libraryRes.ok) {\n        throw new Error(\"Failed to fetch data\");\n      }\n\n      const materialsData = await materialsRes.json();\n      const libraryData = await libraryRes.json();\n\n      setJobMaterials(materialsData.materials || []);\n      setLibraryMaterials(libraryData.materials || []);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to load materials\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleSelectFromLibrary = (material: MaterialItem) => {\n    setFormData({\n      materialItemId: material.id,\n      name: material.name,\n      unitLabel: material.unitLabel,\n      unitCost: material.unitCost?.toString() || \"\",\n      quantity: \"\",\n      markupPercent: \"\",\n      notes: material.notes || \"\",\n    });\n    setLibrarySearch(\"\");\n  };\n\n  const handleAdd = async () => {\n    if (!formData.name || !formData.unitLabel || !formData.quantity) {\n      setError(\"Name, unit label, and quantity are required\");\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/jobs/${jobId}/materials`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          materialItemId: formData.materialItemId || null,\n          name: formData.name,\n          unitLabel: formData.unitLabel,\n          unitCost: formData.unitCost ? parseFloat(formData.unitCost) : null,\n          quantity: parseFloat(formData.quantity),\n          markupPercent: formData.markupPercent ? parseFloat(formData.markupPercent) : null,\n          notes: formData.notes || null,\n        }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to add material\");\n      }\n\n      const data = await response.json();\n      setFormData({\n        materialItemId: \"\",\n        name: \"\",\n        unitLabel: \"\",\n        unitCost: \"\",\n        quantity: \"\",\n        markupPercent: \"\",\n        notes: \"\",\n      });\n      setShowAddForm(false);\n      fetchData();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to add material\");\n    }\n  };\n\n  const handleEdit = (material: JobMaterial) => {\n    setEditingId(material.id);\n    setFormData({\n      materialItemId: material.materialItemId || \"\",\n      name: material.name,\n      unitLabel: material.unitLabel,\n      unitCost: material.unitCost?.toString() || \"\",\n      quantity: material.quantity.toString(),\n      markupPercent: material.markupPercent?.toString() || \"\",\n      notes: material.notes || \"\",\n    });\n  };\n\n  const handleUpdate = async () => {\n    if (!editingId || !formData.name || !formData.unitLabel || !formData.quantity) {\n      setError(\"Name, unit label, and quantity are required\");\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/jobs/${jobId}/materials/${editingId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          name: formData.name,\n          unitLabel: formData.unitLabel,\n          unitCost: formData.unitCost ? parseFloat(formData.unitCost) : null,\n          quantity: parseFloat(formData.quantity),\n          markupPercent: formData.markupPercent ? parseFloat(formData.markupPercent) : null,\n          notes: formData.notes || null,\n        }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to update material\");\n      }\n\n      setEditingId(null);\n      setFormData({\n        materialItemId: \"\",\n        name: \"\",\n        unitLabel: \"\",\n        unitCost: \"\",\n        quantity: \"\",\n        markupPercent: \"\",\n        notes: \"\",\n      });\n      fetchData();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to update material\");\n    }\n  };\n\n  const handleDelete = async (id: string) => {\n    if (!confirm(\"Remove this material from the job?\")) {\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/jobs/${jobId}/materials/${id}`, {\n        method: \"DELETE\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to remove material\");\n      }\n\n      fetchData();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to remove material\");\n    }\n  };\n\n  const cancelEdit = () => {\n    setEditingId(null);\n    setShowAddForm(false);\n    setFormData({\n      materialItemId: \"\",\n      name: \"\",\n      unitLabel: \"\",\n      unitCost: \"\",\n      quantity: \"\",\n      markupPercent: \"\",\n      notes: \"\",\n    });\n  };\n\n  const filteredLibrary = libraryMaterials.filter((m) =>\n    m.name.toLowerCase().includes(librarySearch.toLowerCase())\n  );\n\n  if (isLoading) {\n    return (\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8 text-center\">\n        <Loader2 className=\"w-6 h-6 text-amber-600 animate-spin mx-auto mb-2\" />\n        <p className=\"text-slate-600\">Loading materials...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\n      <div className=\"px-6 py-4 border-b border-slate-200\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-lg font-semibold text-slate-900\">Materials</h2>\n            <p className=\"text-xs text-slate-500 mt-1\">\n              Manage materials line items for this job\n            </p>\n          </div>\n          {!showAddForm && !editingId && (\n            <button\n              onClick={() => {\n                setShowAddForm(true);\n                setEditingId(null);\n              }}\n              className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors text-sm\"\n            >\n              <Plus className=\"w-4 h-4\" />\n              Add Material\n            </button>\n          )}\n        </div>\n      </div>\n\n      <div className=\"p-6\">\n        {error && (\n          <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\n            {error}\n            <button\n              onClick={() => setError(\"\")}\n              className=\"ml-2 text-red-500 hover:text-red-700\"\n            >\n              Ô£ò\n            </button>\n          </div>\n        )}\n\n        {/* Materials Total Summary */}\n        {materialsTotal != null && (\n          <div className=\"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm font-medium text-amber-900\">Materials Total:</span>\n              <span className=\"text-lg font-bold text-amber-900\">\n                ${materialsTotal.toFixed(2)}\n              </span>\n            </div>\n            <p className=\"text-xs text-amber-700 mt-1\">\n              This total is included in the job quote\n            </p>\n          </div>\n        )}\n\n        {/* Add/Edit Form */}\n        {(showAddForm || editingId) && (\n          <div className=\"mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <h3 className=\"text-sm font-semibold text-slate-900\">\n                {editingId ? \"Edit Material Line Item\" : \"Add Material Line Item\"}\n              </h3>\n              <button\n                onClick={cancelEdit}\n                className=\"text-slate-400 hover:text-slate-600\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n\n            {/* Library Selection */}\n            {!editingId && (\n              <div className=\"mb-4\">\n                <label className=\"block text-xs font-medium text-slate-700 mb-2\">\n                  Select from Library (optional)\n                </label>\n                <div className=\"relative\">\n                  <input\n                    type=\"text\"\n                    placeholder=\"Search materials library...\"\n                    value={librarySearch}\n                    onChange={(e) => setLibrarySearch(e.target.value)}\n                    className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                  />\n                  {librarySearch && filteredLibrary.length > 0 && (\n                    <div className=\"absolute z-10 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-48 overflow-y-auto\">\n                      {filteredLibrary.map((material) => (\n                        <button\n                          key={material.id}\n                          onClick={() => handleSelectFromLibrary(material)}\n                          className=\"w-full px-3 py-2 text-left text-sm hover:bg-slate-50 border-b border-slate-100 last:border-0\"\n                        >\n                          <div className=\"font-medium text-slate-900\">{material.name}</div>\n                          <div className=\"text-xs text-slate-500\">\n                            {material.unitLabel}\n                            {material.unitCost != null && ` ÔÇó $${material.unitCost.toFixed(2)}`}\n                          </div>\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-xs font-medium text-slate-700 mb-1\">\n                  Material Name <span className=\"text-red-500\">*</span>\n                </label>\n                <input\n                  type=\"text\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  placeholder=\"e.g. Dulux Wash & Wear 10L\"\n                  className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs font-medium text-slate-700 mb-1\">\n                  Unit Label <span className=\"text-red-500\">*</span>\n                </label>\n                <input\n                  type=\"text\"\n                  value={formData.unitLabel}\n                  onChange={(e) => setFormData({ ...formData, unitLabel: e.target.value })}\n                  placeholder=\"e.g. Litre, Each, Box\"\n                  className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs font-medium text-slate-700 mb-1\">\n                  Unit Cost ($)\n                </label>\n                <input\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={formData.unitCost}\n                  onChange={(e) => setFormData({ ...formData, unitCost: e.target.value })}\n                  placeholder=\"0.00\"\n                  className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs font-medium text-slate-700 mb-1\">\n                  Quantity <span className=\"text-red-500\">*</span>\n                </label>\n                <input\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={formData.quantity}\n                  onChange={(e) => setFormData({ ...formData, quantity: e.target.value })}\n                  placeholder=\"0\"\n                  className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs font-medium text-slate-700 mb-1\">\n                  Markup (%)\n                </label>\n                <input\n                  type=\"number\"\n                  step=\"0.1\"\n                  value={formData.markupPercent}\n                  onChange={(e) => setFormData({ ...formData, markupPercent: e.target.value })}\n                  placeholder=\"0\"\n                  className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-xs font-medium text-slate-700 mb-1\">\n                  Notes\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  placeholder=\"Job-specific notes (optional)\"\n                  rows={2}\n                  className=\"w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n                />\n              </div>\n            </div>\n\n            <div className=\"mt-4 flex justify-end gap-3\">\n              <button\n                onClick={cancelEdit}\n                className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-slate-900\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={editingId ? handleUpdate : handleAdd}\n                className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors text-sm\"\n              >\n                <Save className=\"w-4 h-4\" />\n                {editingId ? \"Update\" : \"Add\"} Line Item\n              </button>\n            </div>\n          </div>\n        )}\n\n        {/* Materials Table */}\n        {jobMaterials.length === 0 ? (\n          <div className=\"text-center py-8 text-slate-500\">\n            <p className=\"text-sm\">No materials added yet. Click &quot;Add Material&quot; to get started.</p>\n          </div>\n        ) : (\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-sm\">\n              <thead className=\"bg-slate-50 border-b border-slate-200\">\n                <tr>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Material\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Unit\n                  </th>\n                  <th className=\"px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Qty\n                  </th>\n                  <th className=\"px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Unit Cost\n                  </th>\n                  <th className=\"px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Markup %\n                  </th>\n                  <th className=\"px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Line Total\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\n                    Actions\n                  </th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-200\">\n                {jobMaterials.map((material) => (\n                  <tr key={material.id} className=\"hover:bg-slate-50\">\n                    <td className=\"px-4 py-3\">\n                      <div className=\"text-sm font-medium text-slate-900\">{material.name}</div>\n                      {material.notes && (\n                        <div className=\"text-xs text-slate-500 mt-0.5\">{material.notes}</div>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3 text-sm text-slate-600\">{material.unitLabel}</td>\n                    <td className=\"px-4 py-3 text-sm text-slate-600 text-right\">\n                      {material.quantity}\n                    </td>\n                    <td className=\"px-4 py-3 text-sm text-slate-600 text-right\">\n                      {material.unitCost != null ? `$${material.unitCost.toFixed(2)}` : \"ÔÇö\"}\n                    </td>\n                    <td className=\"px-4 py-3 text-sm text-slate-600 text-right\">\n                      {material.markupPercent != null ? `${material.markupPercent}%` : \"ÔÇö\"}\n                    </td>\n                    <td className=\"px-4 py-3 text-sm font-medium text-slate-900 text-right\">\n                      {material.lineTotal != null ? `$${material.lineTotal.toFixed(2)}` : \"ÔÇö\"}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <button\n                          onClick={() => handleEdit(material)}\n                          className=\"text-amber-600 hover:text-amber-700\"\n                          title=\"Edit\"\n                        >\n                          <Edit2 className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDelete(material.id)}\n                          className=\"text-red-600 hover:text-red-700\"\n                          title=\"Delete\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n              {jobMaterials.length > 0 && (\n                <tfoot className=\"bg-slate-50 border-t-2 border-slate-300\">\n                  <tr>\n                    <td colSpan={5} className=\"px-4 py-3 text-sm font-semibold text-slate-900 text-right\">\n                      Total:\n                    </td>\n                    <td className=\"px-4 py-3 text-sm font-bold text-slate-900 text-right\">\n                      {materialsTotal != null ? `$${materialsTotal.toFixed(2)}` : \"ÔÇö\"}\n                    </td>\n                    <td></td>\n                  </tr>\n                </tfoot>\n              )}\n            </table>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\QuoteAcceptanceModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4459,4462],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4459,4462],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { Loader2, X, Check } from \"lucide-react\";\r\n\r\ninterface QuoteAcceptanceModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onSuccess: () => void;\r\n  jobId: string;\r\n  userEmail: string;\r\n}\r\n\r\nexport default function QuoteAcceptanceModal({\r\n  isOpen,\r\n  onClose,\r\n  onSuccess,\r\n  jobId,\r\n  userEmail,\r\n}: QuoteAcceptanceModalProps) {\r\n  const canvasRef = useRef<HTMLCanvasElement>(null);\r\n  const [isDrawing, setIsDrawing] = useState(false);\r\n  const [signedName, setSignedName] = useState(\"\");\r\n  const [email, setEmail] = useState(userEmail);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  // Initialize canvas\r\n  useEffect(() => {\r\n    if (!isOpen || !canvasRef.current) return;\r\n\r\n    const canvas = canvasRef.current;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    // Set canvas size\r\n    canvas.width = 600;\r\n    canvas.height = 200;\r\n\r\n    // Set drawing style\r\n    ctx.strokeStyle = \"#1e293b\"; // slate-800\r\n    ctx.lineWidth = 2;\r\n    ctx.lineCap = \"round\";\r\n    ctx.lineJoin = \"round\";\r\n  }, [isOpen]);\r\n\r\n  // Reset form when modal opens/closes\r\n  useEffect(() => {\r\n    if (!isOpen) {\r\n      setSignedName(\"\");\r\n      setEmail(userEmail);\r\n      setError(\"\");\r\n      setIsSubmitting(false);\r\n      if (canvasRef.current) {\r\n        const ctx = canvasRef.current.getContext(\"2d\");\r\n        if (ctx) {\r\n          ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);\r\n        }\r\n      }\r\n    }\r\n  }, [isOpen, userEmail]);\r\n\r\n  const startDrawing = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\r\n    if (!canvasRef.current) return;\r\n    const canvas = canvasRef.current;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    setIsDrawing(true);\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = \"touches\" in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;\r\n    const y = \"touches\" in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;\r\n    ctx.beginPath();\r\n    ctx.moveTo(x, y);\r\n  };\r\n\r\n  const draw = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\r\n    if (!isDrawing || !canvasRef.current) return;\r\n    const canvas = canvasRef.current;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    e.preventDefault();\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = \"touches\" in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;\r\n    const y = \"touches\" in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;\r\n    ctx.lineTo(x, y);\r\n    ctx.stroke();\r\n  };\r\n\r\n  const stopDrawing = () => {\r\n    setIsDrawing(false);\r\n  };\r\n\r\n  const clearSignature = () => {\r\n    if (!canvasRef.current) return;\r\n    const ctx = canvasRef.current.getContext(\"2d\");\r\n    if (ctx) {\r\n      ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);\r\n    }\r\n  };\r\n\r\n  const hasSignature = () => {\r\n    if (!canvasRef.current) return false;\r\n    const ctx = canvasRef.current.getContext(\"2d\");\r\n    if (!ctx) return false;\r\n    const imageData = ctx.getImageData(0, 0, canvasRef.current.width, canvasRef.current.height);\r\n    return imageData.data.some((channel) => channel !== 0);\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    setError(\"\");\r\n\r\n    // Validation\r\n    if (!signedName.trim()) {\r\n      setError(\"Please enter your full name.\");\r\n      return;\r\n    }\r\n\r\n    if (!email.trim() || !email.includes(\"@\")) {\r\n      setError(\"Please enter a valid email address.\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      // Get signature data URL (or empty string if no signature drawn)\r\n      const signatureDataUrl = hasSignature() && canvasRef.current\r\n        ? canvasRef.current.toDataURL(\"image/png\")\r\n        : \"\";\r\n\r\n      const response = await fetch(`/api/jobs/${jobId}/accept`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          name: signedName.trim(),\r\n          email: email.trim(),\r\n          signatureDataUrl,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Failed to accept quote.\");\r\n      }\r\n\r\n      onSuccess();\r\n      onClose();\r\n    } catch (err: any) {\r\n      console.error(\"Error accepting quote:\", err);\r\n      setError(err.message || \"An unexpected error occurred. Please try again.\");\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-slate-900 bg-opacity-75 p-4\">\r\n      <div className=\"relative w-full max-w-2xl rounded-xl bg-white p-6 shadow-xl\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={onClose}\r\n          className=\"absolute right-4 top-4 text-slate-400 hover:text-slate-600\"\r\n          disabled={isSubmitting}\r\n        >\r\n          <X className=\"h-6 w-6\" />\r\n        </button>\r\n\r\n        <h3 className=\"mb-4 text-2xl font-bold text-slate-900\">Accept & Sign Quote</h3>\r\n        <p className=\"mb-6 text-slate-600\">\r\n          By signing below, you agree to accept this quote and proceed with the work.\r\n        </p>\r\n\r\n        {error && (\r\n          <div className=\"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"space-y-4\">\r\n          <div>\r\n            <label htmlFor=\"signedName\" className=\"mb-2 block text-sm font-medium text-slate-700\">\r\n              Full Name <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              id=\"signedName\"\r\n              value={signedName}\r\n              onChange={(e) => setSignedName(e.target.value)}\r\n              className=\"w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-amber-500 focus:ring-1 focus:ring-amber-500\"\r\n              placeholder=\"John Doe\"\r\n              disabled={isSubmitting}\r\n              required\r\n            />\r\n          </div>\r\n\r\n          <div>\r\n            <label htmlFor=\"email\" className=\"mb-2 block text-sm font-medium text-slate-700\">\r\n              Email <span className=\"text-red-500\">*</span>\r\n            </label>\r\n            <input\r\n              type=\"email\"\r\n              id=\"email\"\r\n              value={email}\r\n              onChange={(e) => setEmail(e.target.value)}\r\n              className=\"w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-amber-500 focus:ring-1 focus:ring-amber-500\"\r\n              placeholder=\"you@example.com\"\r\n              disabled={isSubmitting}\r\n              required\r\n            />\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"mb-2 block text-sm font-medium text-slate-700\">\r\n              Your Signature <span className=\"text-slate-500 text-xs\">(optional but recommended)</span>\r\n            </label>\r\n            <div className=\"relative rounded-lg border border-slate-300 bg-slate-50\">\r\n              <canvas\r\n                ref={canvasRef}\r\n                className=\"w-full h-48 cursor-crosshair touch-none\"\r\n                onMouseDown={startDrawing}\r\n                onMouseMove={draw}\r\n                onMouseUp={stopDrawing}\r\n                onMouseLeave={stopDrawing}\r\n                onTouchStart={startDrawing}\r\n                onTouchMove={draw}\r\n                onTouchEnd={stopDrawing}\r\n              />\r\n              {!hasSignature() && (\r\n                <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center text-slate-400\">\r\n                  Draw your signature here\r\n                </div>\r\n              )}\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              onClick={clearSignature}\r\n              className=\"mt-2 text-sm font-medium text-slate-600 hover:text-slate-900\"\r\n              disabled={isSubmitting}\r\n            >\r\n              Clear Signature\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-6 flex justify-end gap-3\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onClose}\r\n            className=\"rounded-lg px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100\"\r\n            disabled={isSubmitting}\r\n          >\r\n            Cancel\r\n          </button>\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleSubmit}\r\n            className=\"inline-flex items-center rounded-lg bg-amber-500 px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-amber-400 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            disabled={isSubmitting}\r\n          >\r\n            {isSubmitting ? (\r\n              <>\r\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                Accepting...\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Check className=\"mr-2 h-4 w-4\" />\r\n                Confirm & Sign\r\n              </>\r\n            )}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\QuoteHistoryPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'jobId' is defined but never used.","line":25,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":50}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { ChevronDown, ChevronUp, Eye, X } from \"lucide-react\";\r\n\r\ninterface QuoteVersion {\r\n  id: string;\r\n  version: number;\r\n  sentAt: string;\r\n  quoteExpiryAt: string | null;\r\n  totalInclGst: number | null;\r\n  summary?: string | null;\r\n  scopeOfWork?: string | null;\r\n  inclusions?: string | null;\r\n  exclusions?: string | null;\r\n  materialsText?: string | null;\r\n  clientNotes?: string | null;\r\n}\r\n\r\ninterface QuoteHistoryPanelProps {\r\n  jobId: string;\r\n  versions: QuoteVersion[];\r\n}\r\n\r\nexport default function QuoteHistoryPanel({ jobId, versions }: QuoteHistoryPanelProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [viewingVersion, setViewingVersion] = useState<number | null>(null);\r\n\r\n  if (versions.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString(\"en-AU\", {\r\n      day: \"numeric\",\r\n      month: \"short\",\r\n      year: \"numeric\",\r\n    });\r\n  };\r\n\r\n  const formatCurrency = (amount: number | null) => {\r\n    if (amount == null) return \"ÔÇö\";\r\n    return `$${Math.round(amount).toLocaleString(\"en-AU\")}`;\r\n  };\r\n\r\n  const isExpired = (expiryDate: string | null) => {\r\n    if (!expiryDate) return false;\r\n    return new Date(expiryDate) < new Date();\r\n  };\r\n\r\n  return (\r\n    <div className=\"border-t border-slate-200 pt-6 mt-6\">\r\n      <button\r\n        onClick={() => setIsOpen(!isOpen)}\r\n        className=\"flex items-center justify-between w-full text-left\"\r\n      >\r\n        <h3 className=\"text-lg font-semibold text-slate-900\">Quote History</h3>\r\n        {isOpen ? (\r\n          <ChevronUp className=\"w-5 h-5 text-slate-500\" />\r\n        ) : (\r\n          <ChevronDown className=\"w-5 h-5 text-slate-500\" />\r\n        )}\r\n      </button>\r\n\r\n      {isOpen && (\r\n        <div className=\"mt-4 space-y-3\">\r\n          {versions.map((version) => (\r\n            <div\r\n              key={version.id}\r\n              className=\"p-4 bg-slate-50 border border-slate-200 rounded-lg\"\r\n            >\r\n              <div className=\"flex items-start justify-between\">\r\n                <div className=\"flex-1\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <span className=\"text-sm font-semibold text-slate-900\">\r\n                      v{version.version}\r\n                    </span>\r\n                    <span className=\"text-xs text-slate-500\">\r\n                      Sent {formatDate(version.sentAt)}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"text-sm text-slate-600 space-y-1\">\r\n                    {version.quoteExpiryAt && (\r\n                      <div>\r\n                        <span className=\"text-slate-500\">Expires:</span>{\" \"}\r\n                        <span className={isExpired(version.quoteExpiryAt) ? \"text-red-600 font-medium\" : \"\"}>\r\n                          {formatDate(version.quoteExpiryAt)}\r\n                          {isExpired(version.quoteExpiryAt) && \" (Expired)\"}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                    {version.totalInclGst != null && (\r\n                      <div>\r\n                        <span className=\"text-slate-500\">Total:</span>{\" \"}\r\n                        <span className=\"font-medium text-slate-900\">\r\n                          {formatCurrency(version.totalInclGst)}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                <button\r\n                  onClick={() => setViewingVersion(viewingVersion === version.version ? null : version.version)}\r\n                  className=\"ml-4 px-3 py-1.5 text-sm text-amber-600 hover:text-amber-700 hover:bg-amber-50 rounded-lg transition-colors flex items-center gap-1\"\r\n                >\r\n                  <Eye className=\"w-4 h-4\" />\r\n                  {viewingVersion === version.version ? \"Hide\" : \"View\"} Snapshot\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* Version Snapshot Modal */}\r\n      {viewingVersion && (() => {\r\n        const versionData = versions.find(v => v.version === viewingVersion);\r\n        if (!versionData) return null;\r\n        \r\n        return (\r\n          <div className=\"fixed inset-0 z-50 overflow-y-auto\">\r\n            <div className=\"flex min-h-full items-center justify-center p-4\">\r\n              <div\r\n                className=\"fixed inset-0 bg-slate-900/50 transition-opacity\"\r\n                onClick={() => setViewingVersion(null)}\r\n              />\r\n              <div className=\"relative bg-white rounded-xl shadow-xl max-w-3xl w-full p-6 z-10 max-h-[90vh] overflow-y-auto\">\r\n                <div className=\"flex items-center justify-between mb-6\">\r\n                  <h3 className=\"text-lg font-semibold text-slate-900\">\r\n                    Quote v{versionData.version} Snapshot\r\n                  </h3>\r\n                  <button\r\n                    onClick={() => setViewingVersion(null)}\r\n                    className=\"p-1 text-slate-400 hover:text-slate-600 transition-colors\"\r\n                  >\r\n                    <X className=\"w-5 h-5\" />\r\n                  </button>\r\n                </div>\r\n\r\n                <div className=\"space-y-6\">\r\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                    <div>\r\n                      <span className=\"text-slate-500\">Sent:</span>{\" \"}\r\n                      <span className=\"font-medium\">{formatDate(versionData.sentAt)}</span>\r\n                    </div>\r\n                    {versionData.quoteExpiryAt && (\r\n                      <div>\r\n                        <span className=\"text-slate-500\">Expires:</span>{\" \"}\r\n                        <span className={`font-medium ${\r\n                          isExpired(versionData.quoteExpiryAt) ? \"text-red-600\" : \"\"\r\n                        }`}>\r\n                          {formatDate(versionData.quoteExpiryAt)}\r\n                          {isExpired(versionData.quoteExpiryAt) && \" (Expired)\"}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                    {versionData.totalInclGst != null && (\r\n                      <div>\r\n                        <span className=\"text-slate-500\">Total:</span>{\" \"}\r\n                        <span className=\"font-medium text-slate-900\">\r\n                          {formatCurrency(versionData.totalInclGst)}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {versionData.summary && (\r\n                    <div>\r\n                      <h4 className=\"text-sm font-semibold text-slate-900 mb-2\">Summary</h4>\r\n                      <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{versionData.summary}</p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {versionData.scopeOfWork && (\r\n                    <div>\r\n                      <h4 className=\"text-sm font-semibold text-slate-900 mb-2\">Scope of Work</h4>\r\n                      <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{versionData.scopeOfWork}</p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {versionData.inclusions && (\r\n                    <div>\r\n                      <h4 className=\"text-sm font-semibold text-slate-900 mb-2\">Inclusions</h4>\r\n                      <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{versionData.inclusions}</p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {versionData.exclusions && (\r\n                    <div>\r\n                      <h4 className=\"text-sm font-semibold text-slate-900 mb-2\">Exclusions</h4>\r\n                      <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{versionData.exclusions}</p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {versionData.materialsText && (\r\n                    <div>\r\n                      <h4 className=\"text-sm font-semibold text-slate-900 mb-2\">Materials</h4>\r\n                      <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{versionData.materialsText}</p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {versionData.clientNotes && (\r\n                    <div>\r\n                      <h4 className=\"text-sm font-semibold text-slate-900 mb-2\">Client Notes</h4>\r\n                      <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{versionData.clientNotes}</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"mt-6 flex justify-end\">\r\n                  <button\r\n                    onClick={() => setViewingVersion(null)}\r\n                    className=\"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors\"\r\n                  >\r\n                    Close\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        );\r\n      })()}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\RegenerateButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SafetyDocumentEditor.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SafetyDocumentPdfButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SafetySection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Download' is defined but never used.","line":6,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":86,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchDocuments'. Either include it or remove the dependency array.","line":97,"column":6,"nodeType":"ArrayExpression","endLine":97,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [fetchDocuments, jobId]","fix":{"range":[2648,2655],"text":"[fetchDocuments, jobId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { Loader2, FileText, Edit2, Download, Shield, AlertTriangle, Users, RefreshCw } from \"lucide-react\";\nimport SafetyDocumentEditor from \"./SafetyDocumentEditor\";\nimport SafetyDocumentPdfButton from \"./SafetyDocumentPdfButton\";\nimport AIWarningBanner from \"@/app/components/AIWarningBanner\";\nimport OvisBadge from \"@/app/components/OvisBadge\";\n\n// User-friendly error message for safety document operations\nconst FRIENDLY_ERROR_MESSAGE = \"Safety documents aren't available right now. Please try again shortly.\";\n\ninterface BusinessProfile {\n  legalName?: string;\n  tradingName?: string;\n  abn?: string;\n  email?: string;\n  phone?: string;\n  addressLine1?: string;\n  addressLine2?: string;\n  suburb?: string;\n  state?: string;\n  postcode?: string;\n}\n\ninterface SafetySectionProps {\n  jobId: string;\n  jobTitle: string;\n  tradeType: string;\n  address?: string;\n  businessName?: string;\n  businessProfile?: BusinessProfile | null;\n}\n\ntype SafetyDocumentType = \"SWMS\" | \"RISK_ASSESSMENT\" | \"TOOLBOX_TALK\";\n\ninterface SafetyDocument {\n  id: string;\n  jobId: string;\n  type: SafetyDocumentType;\n  title: string;\n  content: string;\n  status: \"draft\" | \"generated\" | \"reviewed\";\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface DocumentConfig {\n  type: SafetyDocumentType;\n  label: string;\n  description: string;\n  icon: React.ReactNode;\n}\n\nconst DOCUMENT_CONFIGS: DocumentConfig[] = [\n  {\n    type: \"SWMS\",\n    label: \"SWMS\",\n    description: \"Safe Work Method Statement\",\n    icon: <Shield className=\"w-5 h-5\" />,\n  },\n  {\n    type: \"RISK_ASSESSMENT\",\n    label: \"Risk Assessment\",\n    description: \"Hazard identification and risk controls\",\n    icon: <AlertTriangle className=\"w-5 h-5\" />,\n  },\n  {\n    type: \"TOOLBOX_TALK\",\n    label: \"Toolbox Talk\",\n    description: \"Safety briefing outline\",\n    icon: <Users className=\"w-5 h-5\" />,\n  },\n];\n\nexport default function SafetySection({\n  jobId,\n  jobTitle,\n  tradeType,\n  address,\n  businessName,\n  businessProfile,\n}: SafetySectionProps) {\n  const router = useRouter();\n  const [documents, setDocuments] = useState<SafetyDocument[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [generating, setGenerating] = useState<SafetyDocumentType | null>(null);\n  const [editingDoc, setEditingDoc] = useState<SafetyDocument | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [emailVerified, setEmailVerified] = useState<boolean | null>(null);\n\n  useEffect(() => {\n    fetchDocuments();\n    checkEmailVerification();\n  }, [jobId]);\n\n  const checkEmailVerification = async () => {\n    try {\n      const response = await fetch(\"/api/auth/me\");\n      if (response.ok) {\n        const data = await response.json();\n        setEmailVerified(!!data.user?.emailVerifiedAt);\n      } else {\n        setEmailVerified(false);\n      }\n    } catch {\n      setEmailVerified(false);\n    }\n  };\n\n  const fetchDocuments = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      const response = await fetch(`/api/jobs/${jobId}/safety`);\n      if (!response.ok) {\n        // Try to get error from response, but don't expose raw errors\n        try {\n          const data = await response.json();\n          // Only use the error if it's a known friendly message\n          if (data.error && !data.error.includes(\"prisma\") && !data.error.includes(\"DATABASE\")) {\n            throw new Error(data.error);\n          }\n        } catch {\n          // Ignore JSON parse errors\n        }\n        throw new Error(FRIENDLY_ERROR_MESSAGE);\n      }\n      const data = await response.json();\n      setDocuments(data.documents || []);\n    } catch (err) {\n      console.error(\"Error fetching safety documents:\", err);\n      // Always show friendly message to user\n      setError(FRIENDLY_ERROR_MESSAGE);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleGenerate = async (type: SafetyDocumentType) => {\n    setGenerating(type);\n    setError(null);\n\n    try {\n      const response = await fetch(`/api/jobs/${jobId}/safety`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ type }),\n      });\n\n      if (!response.ok) {\n        let errorMessage = FRIENDLY_ERROR_MESSAGE;\n        try {\n          const data = await response.json();\n          // Only use API error if it looks safe (no internal details)\n          if (data.error && \n              !data.error.toLowerCase().includes(\"prisma\") && \n              !data.error.toLowerCase().includes(\"database\") &&\n              !data.error.toLowerCase().includes(\"schema\") &&\n              !data.error.includes(\"at \") &&\n              !data.error.includes(\".ts:\")) {\n            errorMessage = data.error;\n          }\n        } catch {\n          // Ignore JSON parse errors\n        }\n        // Set error state directly instead of throwing to avoid console errors\n        setError(errorMessage);\n        setGenerating(null);\n        return;\n      }\n\n      const data = await response.json();\n      await fetchDocuments(); // Refresh list\n      \n      // Open editor with the newly generated document\n      if (data.document) {\n        setEditingDoc(data.document);\n      }\n    } catch (err) {\n      // Handle unexpected errors (network failures, etc.)\n      console.error(\"Error generating safety document:\", err);\n      setError(FRIENDLY_ERROR_MESSAGE);\n    } finally {\n      setGenerating(null);\n    }\n  };\n\n  const handleEdit = (doc: SafetyDocument) => {\n    setEditingDoc(doc);\n  };\n\n  const handleSave = async (docId: string, updates: { title?: string; content: string; status?: string }) => {\n    const SAVE_ERROR = \"Unable to save changes right now. Please try again shortly.\";\n    \n    try {\n      const response = await fetch(`/api/jobs/${jobId}/safety/${docId}`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(updates),\n      });\n\n      if (!response.ok) {\n        let errorMessage = SAVE_ERROR;\n        try {\n          const data = await response.json();\n          // Only use API error if it looks safe\n          if (data.error && \n              !data.error.toLowerCase().includes(\"prisma\") && \n              !data.error.toLowerCase().includes(\"database\") &&\n              !data.error.includes(\"Environment variable\")) {\n            errorMessage = data.error;\n          }\n        } catch {\n          // Ignore JSON parse errors\n        }\n        throw new Error(errorMessage);\n      }\n\n      await fetchDocuments(); // Refresh list\n      setEditingDoc(null);\n    } catch (err) {\n      console.error(\"Error saving safety document:\", err);\n      const errorMessage = err instanceof Error ? err.message : SAVE_ERROR;\n      // Double-check the message doesn't contain sensitive info\n      if (errorMessage.toLowerCase().includes(\"prisma\") || \n          errorMessage.toLowerCase().includes(\"database\") ||\n          errorMessage.includes(\"Environment variable\")) {\n        setError(SAVE_ERROR);\n      } else {\n        setError(errorMessage);\n      }\n    }\n  };\n\n  const getDocument = (type: SafetyDocumentType): SafetyDocument | undefined => {\n    return documents.find((d) => d.type === type);\n  };\n\n  const getStatusBadge = (status: string) => {\n    const styles: Record<string, string> = {\n      draft: \"bg-slate-100 text-slate-700 border-slate-300\",\n      generated: \"bg-amber-100 text-amber-700 border-amber-300\",\n      reviewed: \"bg-green-100 text-green-700 border-green-300\",\n    };\n\n    const labels: Record<string, string> = {\n      draft: \"Draft\",\n      generated: \"Generated\",\n      reviewed: \"Reviewed\",\n    };\n\n    return (\n      <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ${styles[status] || styles.draft}`}>\n        {labels[status] || status}\n      </span>\n    );\n  };\n\n  if (loading) {\n    return (\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8\">\n        <div className=\"flex items-center justify-center\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-amber-500\" />\n          <span className=\"ml-2 text-slate-600\">Loading safety documents...</span>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <>\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\n        <div className=\"px-6 py-4 border-b border-slate-200\">\n          <div className=\"flex items-center justify-between gap-4 mb-2\">\n            <h2 className=\"text-lg font-semibold text-slate-900\">Safety & SWMS</h2>\n            <OvisBadge variant=\"inline\" size=\"sm\" />\n          </div>\n          <p className=\"text-xs text-slate-500\">\n            Generate and manage safety documents for this job\n          </p>\n        </div>\n        <div className=\"p-6\">\n          {error && (\n            <div className=\"mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div className=\"flex items-start gap-2\">\n                  <AlertTriangle className=\"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5\" />\n                  <p className=\"text-sm text-amber-800\">{error}</p>\n                </div>\n                <button\n                  onClick={() => {\n                    setError(null);\n                    fetchDocuments();\n                  }}\n                  className=\"inline-flex items-center px-2 py-1 text-xs font-medium text-amber-700 bg-amber-100 hover:bg-amber-200 rounded transition-colors\"\n                >\n                  <RefreshCw className=\"w-3 h-3 mr-1\" />\n                  Retry\n                </button>\n              </div>\n            </div>\n          )}\n\n          {/* Email Verification Warning */}\n          {emailVerified === false && (\n            <div className=\"mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n              <div className=\"flex items-start gap-3\">\n                <svg className=\"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n                <div className=\"flex-1\">\n                  <h3 className=\"text-sm font-semibold text-amber-900 mb-1\">Email Verification Required</h3>\n                  <p className=\"text-sm text-amber-800 mb-2\">\n                    Please verify your email address to generate safety documents. Check your inbox for a verification email or{\" \"}\n                    <Link href=\"/settings\" className=\"underline font-medium\">\n                      resend verification email\n                    </Link>.\n                  </p>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* AI Warning Banner */}\n          <div className=\"mb-4\">\n            <AIWarningBanner variant=\"compact\" />\n          </div>\n\n          <div className=\"space-y-4\">\n            {DOCUMENT_CONFIGS.map((config) => {\n              const doc = getDocument(config.type);\n              const isGenerating = generating === config.type;\n              const isDisabled = emailVerified === false;\n\n              return (\n                <div\n                  key={config.type}\n                  className={`border border-slate-200 rounded-lg p-4 transition-colors ${isDisabled ? \"opacity-60\" : \"hover:border-amber-300\"}`}\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex items-start gap-3 flex-1\">\n                      <div className=\"w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0 text-amber-600\">\n                        {config.icon}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-medium text-slate-900 mb-1\">{config.label}</h3>\n                        <p className=\"text-xs text-slate-500 mb-2\">{config.description}</p>\n                        {doc && (\n                          <div className=\"mt-2\">\n                            {getStatusBadge(doc.status)}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2 ml-4\">\n                      {doc ? (\n                        <>\n                          <button\n                            onClick={() => handleEdit(doc)}\n                            className=\"inline-flex items-center px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors\"\n                          >\n                            <Edit2 className=\"w-4 h-4 mr-1\" />\n                            Edit\n                          </button>\n                          <SafetyDocumentPdfButton\n                            document={doc}\n                            jobTitle={jobTitle}\n                            tradeType={tradeType}\n                            address={address}\n                            businessName={businessName}\n                            businessProfile={businessProfile}\n                          />\n                        </>\n                      ) : (\n                        <button\n                          onClick={() => handleGenerate(config.type)}\n                          disabled={isGenerating || generating !== null || isDisabled}\n                          className=\"inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-amber-500 hover:bg-amber-400 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                          title={isDisabled ? \"Email verification required\" : undefined}\n                        >\n                          {isGenerating ? (\n                            <>\n                              <Loader2 className=\"w-4 h-4 mr-1 animate-spin\" />\n                              Generating...\n                            </>\n                          ) : (\n                            <>\n                              <FileText className=\"w-4 h-4 mr-1\" />\n                              Generate {config.type === \"SWMS\" ? \"SWMS\" : config.label}\n                            </>\n                          )}\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      </div>\n\n      {editingDoc && (\n        <SafetyDocumentEditor\n          document={editingDoc}\n          onSave={handleSave}\n          onCancel={() => setEditingDoc(null)}\n        />\n      )}\n    </>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SafetySwmsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SaveAsTemplateButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3767,3770],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3767,3770],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Bookmark, Loader2, X, Check } from \"lucide-react\";\r\nimport type { Job } from \"@/lib/jobs\";\r\n\r\ninterface SaveAsTemplateButtonProps {\r\n  job: Job;\r\n}\r\n\r\nexport default function SaveAsTemplateButton({ job }: SaveAsTemplateButtonProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(false);\r\n  const [formData, setFormData] = useState({\r\n    title: job.title || \"\",\r\n    includeSwms: false,\r\n    includeVariationDoc: false,\r\n    includeEotDoc: false,\r\n    includeProgressClaim: false,\r\n    includeHandoverChecklist: false,\r\n    includeMaintenanceGuide: false,\r\n  });\r\n\r\n  const handleOpen = () => {\r\n    setIsOpen(true);\r\n    setError(\"\");\r\n    setSuccess(false);\r\n    // Pre-fill with job data\r\n    setFormData({\r\n      title: job.title || \"\",\r\n      includeSwms: false, // Default to false - user can enable if needed\r\n      includeVariationDoc: false,\r\n      includeEotDoc: false,\r\n      includeProgressClaim: false,\r\n      includeHandoverChecklist: false,\r\n      includeMaintenanceGuide: false,\r\n    });\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setIsOpen(false);\r\n    setError(\"\");\r\n    setSuccess(false);\r\n  };\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const { name, value, type, checked } = e.target;\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      [name]: type === \"checkbox\" ? checked : value,\r\n    }));\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setIsSaving(true);\r\n\r\n    try {\r\n      // Extract address components if address exists\r\n      let addressLine1: string | undefined;\r\n      let suburb: string | undefined;\r\n      let state: string | undefined;\r\n      let postcode: string | undefined;\r\n\r\n      if (job.address) {\r\n        // Simple parsing - split by comma\r\n        const parts = job.address.split(\",\").map((p) => p.trim());\r\n        addressLine1 = parts[0] || undefined;\r\n        if (parts.length > 1) {\r\n          // Try to extract postcode (last 4 digits)\r\n          const lastPart = parts[parts.length - 1];\r\n          const postcodeMatch = lastPart.match(/\\b(\\d{4})\\b/);\r\n          if (postcodeMatch) {\r\n            postcode = postcodeMatch[1];\r\n            suburb = parts[parts.length - 2] || undefined;\r\n          } else {\r\n            suburb = lastPart;\r\n          }\r\n        }\r\n      }\r\n\r\n      const response = await fetch(\"/api/job-templates\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          title: formData.title.trim(),\r\n          tradeType: job.tradeType,\r\n          propertyType: job.propertyType,\r\n          addressLine1,\r\n          suburb,\r\n          state,\r\n          postcode,\r\n          notes: job.notes || null,\r\n          defaultClientNotes: job.aiClientNotes || null,\r\n          defaultMaterialsNotes: job.aiMaterials || null,\r\n          includeSwms: formData.includeSwms,\r\n          includeVariationDoc: formData.includeVariationDoc,\r\n          includeEotDoc: formData.includeEotDoc,\r\n          includeProgressClaim: formData.includeProgressClaim,\r\n          includeHandoverChecklist: formData.includeHandoverChecklist,\r\n          includeMaintenanceGuide: formData.includeMaintenanceGuide,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Failed to save template\");\r\n      }\r\n\r\n      setSuccess(true);\r\n      setTimeout(() => {\r\n        handleClose();\r\n        // Optionally refresh the page or show a toast\r\n      }, 1500);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to save template\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        onClick={handleOpen}\r\n        className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors text-sm\"\r\n      >\r\n        <Bookmark className=\"w-4 h-4 mr-2\" />\r\n        Save as Template\r\n      </button>\r\n\r\n      {isOpen && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\r\n          <div className=\"bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between\">\r\n              <h2 className=\"text-xl font-semibold text-slate-900\">Save as Template</h2>\r\n              <button\r\n                onClick={handleClose}\r\n                className=\"text-slate-400 hover:text-slate-600 transition-colors\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n\r\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\r\n              {error && (\r\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n                  {error}\r\n                </div>\r\n              )}\r\n\r\n              {success && (\r\n                <div className=\"p-4 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700 text-sm flex items-center gap-2\">\r\n                  <Check className=\"w-5 h-5\" />\r\n                  <span>Template saved ÔÇô you can reuse this setup for future jobs.</span>\r\n                </div>\r\n              )}\r\n\r\n              <div>\r\n                <label htmlFor=\"template-title\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                  Template Name <span className=\"text-red-500\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  id=\"template-title\"\r\n                  name=\"title\"\r\n                  value={formData.title}\r\n                  onChange={handleChange}\r\n                  required\r\n                  placeholder=\"e.g. 3├ù2 repaint ÔÇô standard\"\r\n                  className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                  disabled={isSaving}\r\n                />\r\n                <p className=\"mt-1 text-xs text-slate-500\">\r\n                  Give this template a descriptive name so you can find it easily later.\r\n                </p>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-700 mb-3\">\r\n                  Include Documents by Default\r\n                </label>\r\n                <p className=\"text-xs text-slate-500 mb-3\">\r\n                  Select which documents should be generated automatically when using this template.\r\n                </p>\r\n                <div className=\"space-y-2\">\r\n                  {[\r\n                    { key: \"includeSwms\", label: \"SWMS (Safe Work Method Statement)\" },\r\n                    { key: \"includeVariationDoc\", label: \"Variation / Change Order\" },\r\n                    { key: \"includeEotDoc\", label: \"Extension of Time (EOT)\" },\r\n                    { key: \"includeProgressClaim\", label: \"Progress Claim / Tax Invoice\" },\r\n                    { key: \"includeHandoverChecklist\", label: \"Handover & Practical Completion\" },\r\n                    { key: \"includeMaintenanceGuide\", label: \"Maintenance & Care Guide\" },\r\n                  ].map(({ key, label }) => (\r\n                    <label key={key} className=\"flex items-start gap-3 cursor-pointer\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        name={key}\r\n                        checked={formData[key as keyof typeof formData] as boolean}\r\n                        onChange={handleChange}\r\n                        className=\"mt-1 w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\r\n                        disabled={isSaving}\r\n                      />\r\n                      <span className=\"text-sm text-slate-700\">{label}</span>\r\n                    </label>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-end gap-3 pt-4 border-t border-slate-200\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleClose}\r\n                  disabled={isSaving}\r\n                  className=\"px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={isSaving || !formData.title.trim()}\r\n                  className=\"inline-flex items-center px-6 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isSaving ? (\r\n                    <>\r\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                      Saving...\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <Bookmark className=\"w-4 h-4 mr-2\" />\r\n                      Save Template\r\n                    </>\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\ScheduleSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":73,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2529,2532],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2529,2532],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3496,3499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3496,3499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Calendar, Clock, Loader2, Save, X } from \"lucide-react\";\r\nimport { formatDateTimeForDisplay, formatDateTimeForInput } from \"@/lib/format\";\r\n\r\ninterface ScheduleSectionProps {\r\n  jobId: string;\r\n  scheduledStartAt: string | null | undefined;\r\n  scheduledEndAt: string | null | undefined;\r\n  scheduleNotes: string | null | undefined;\r\n}\r\n\r\nexport default function ScheduleSection({\r\n  jobId,\r\n  scheduledStartAt: initialScheduledStartAt,\r\n  scheduledEndAt: initialScheduledEndAt,\r\n  scheduleNotes: initialScheduleNotes,\r\n}: ScheduleSectionProps) {\r\n  const router = useRouter();\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState(false);\r\n  \r\n  const [scheduledStartAt, setScheduledStartAt] = useState(\r\n    initialScheduledStartAt ? formatDateTimeForInput(initialScheduledStartAt) : \"\"\r\n  );\r\n  const [scheduledEndAt, setScheduledEndAt] = useState(\r\n    initialScheduledEndAt ? formatDateTimeForInput(initialScheduledEndAt) : \"\"\r\n  );\r\n  const [scheduleNotes, setScheduleNotes] = useState(initialScheduleNotes || \"\");\r\n\r\n  const handleSave = async () => {\r\n    setError(null);\r\n    setSuccess(false);\r\n    setIsSaving(true);\r\n\r\n    try {\r\n      // Convert to ISO strings\r\n      const startAtISO = scheduledStartAt ? new Date(scheduledStartAt).toISOString() : null;\r\n      const endAtISO = scheduledEndAt ? new Date(scheduledEndAt).toISOString() : null;\r\n\r\n      // Validate that end is not before start\r\n      if (startAtISO && endAtISO && new Date(endAtISO) < new Date(startAtISO)) {\r\n        setError(\"End time cannot be before start time\");\r\n        setIsSaving(false);\r\n        return;\r\n      }\r\n\r\n      const response = await fetch(`/api/jobs/${jobId}/schedule`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          scheduledStartAt: startAtISO,\r\n          scheduledEndAt: endAtISO,\r\n          scheduleNotes: scheduleNotes.trim() || null,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to save schedule\");\r\n      }\r\n\r\n      setSuccess(true);\r\n      setIsEditing(false);\r\n      setTimeout(() => {\r\n        setSuccess(false);\r\n        router.refresh();\r\n      }, 2000);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to save schedule\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleClear = async () => {\r\n    setError(null);\r\n    setSuccess(false);\r\n    setIsSaving(true);\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/schedule`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          scheduledStartAt: null,\r\n          scheduledEndAt: null,\r\n          scheduleNotes: null,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to clear schedule\");\r\n      }\r\n\r\n      setScheduledStartAt(\"\");\r\n      setScheduledEndAt(\"\");\r\n      setScheduleNotes(\"\");\r\n      setSuccess(true);\r\n      setIsEditing(false);\r\n      setTimeout(() => {\r\n        setSuccess(false);\r\n        router.refresh();\r\n      }, 2000);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to clear schedule\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCancel = () => {\r\n    setIsEditing(false);\r\n    setError(null);\r\n    setScheduledStartAt(initialScheduledStartAt ? formatDateTimeForInput(initialScheduledStartAt) : \"\");\r\n    setScheduledEndAt(initialScheduledEndAt ? formatDateTimeForInput(initialScheduledEndAt) : \"\");\r\n    setScheduleNotes(initialScheduleNotes || \"\");\r\n  };\r\n\r\n  const hasSchedule = initialScheduledStartAt || initialScheduledEndAt || initialScheduleNotes;\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n      <div className=\"px-6 py-4 border-b border-slate-200\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h2 className=\"text-lg font-semibold text-slate-900\">Schedule</h2>\r\n            <p className=\"text-xs text-slate-500 mt-1\">\r\n              Set the date and time for this job\r\n            </p>\r\n          </div>\r\n          {!isEditing && (\r\n            <button\r\n              onClick={() => setIsEditing(true)}\r\n              className=\"px-3 py-1.5 text-sm font-medium text-amber-700 bg-amber-50 hover:bg-amber-100 rounded-lg transition-colors\"\r\n            >\r\n              {hasSchedule ? \"Edit\" : \"Set Schedule\"}\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"p-6\">\r\n        {error && (\r\n          <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm flex items-start gap-2\">\r\n            <X className=\"w-5 h-5 flex-shrink-0 mt-0.5\" />\r\n            <span>{error}</span>\r\n          </div>\r\n        )}\r\n\r\n        {success && (\r\n          <div className=\"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm\">\r\n            Schedule updated successfully\r\n          </div>\r\n        )}\r\n\r\n        {isEditing ? (\r\n          <div className=\"space-y-4\">\r\n            <div>\r\n              <label htmlFor=\"scheduledStartAt\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                <Clock className=\"w-4 h-4 inline mr-1\" />\r\n                Scheduled Start <span className=\"text-red-500\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"datetime-local\"\r\n                id=\"scheduledStartAt\"\r\n                value={scheduledStartAt}\r\n                onChange={(e) => setScheduledStartAt(e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"scheduledEndAt\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                <Clock className=\"w-4 h-4 inline mr-1\" />\r\n                Scheduled End <span className=\"text-slate-400\">(optional)</span>\r\n              </label>\r\n              <input\r\n                type=\"datetime-local\"\r\n                id=\"scheduledEndAt\"\r\n                value={scheduledEndAt}\r\n                onChange={(e) => setScheduledEndAt(e.target.value)}\r\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label htmlFor=\"scheduleNotes\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Schedule Notes <span className=\"text-slate-400\">(optional)</span>\r\n              </label>\r\n              <textarea\r\n                id=\"scheduleNotes\"\r\n                value={scheduleNotes}\r\n                onChange={(e) => setScheduleNotes(e.target.value)}\r\n                placeholder=\"e.g., Client prefers mornings, Access via rear driveway\"\r\n                rows={3}\r\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors resize-y\"\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-500\">\r\n                Add any special instructions or preferences for scheduling this job\r\n              </p>\r\n            </div>\r\n\r\n            <div className=\"flex gap-3 pt-2\">\r\n              <button\r\n                onClick={handleSave}\r\n                disabled={isSaving || !scheduledStartAt}\r\n                className=\"flex-1 inline-flex items-center justify-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {isSaving ? (\r\n                  <>\r\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                    <span>Saving...</span>\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Save className=\"w-4 h-4 mr-2\" />\r\n                    <span>Save Schedule</span>\r\n                  </>\r\n                )}\r\n              </button>\r\n              {hasSchedule && (\r\n                <button\r\n                  onClick={handleClear}\r\n                  disabled={isSaving}\r\n                  className=\"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors disabled:opacity-50\"\r\n                >\r\n                  Clear\r\n                </button>\r\n              )}\r\n              <button\r\n                onClick={handleCancel}\r\n                disabled={isSaving}\r\n                className=\"px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors disabled:opacity-50\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-3\">\r\n            {hasSchedule ? (\r\n              <>\r\n                {initialScheduledStartAt && (\r\n                  <div className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg\">\r\n                    <Calendar className=\"w-5 h-5 text-slate-400 mt-0.5\" />\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-slate-700\">Scheduled Start</p>\r\n                      <p className=\"text-sm text-slate-900\">{formatDateTimeForDisplay(initialScheduledStartAt)}</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                {initialScheduledEndAt && (\r\n                  <div className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg\">\r\n                    <Calendar className=\"w-5 h-5 text-slate-400 mt-0.5\" />\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-slate-700\">Scheduled End</p>\r\n                      <p className=\"text-sm text-slate-900\">{formatDateTimeForDisplay(initialScheduledEndAt)}</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                {initialScheduleNotes && (\r\n                  <div className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg\">\r\n                    <svg className=\"w-5 h-5 text-slate-400 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\r\n                    </svg>\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-slate-700\">Schedule Notes</p>\r\n                      <p className=\"text-sm text-slate-900 whitespace-pre-wrap\">{initialScheduleNotes}</p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </>\r\n            ) : (\r\n              <div className=\"text-center py-6 text-slate-500\">\r\n                <Calendar className=\"w-12 h-12 mx-auto mb-3 text-slate-300\" />\r\n                <p className=\"text-sm\">No schedule set for this job.</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SectionEditButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sectionName' is defined but never used.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\ninterface SectionEditButtonProps {\r\n  jobId: string;\r\n  sectionName: string;\r\n  fieldName: \"aiScopeOfWork\" | \"aiInclusions\" | \"aiExclusions\" | \"aiClientNotes\" | \"aiSummary\";\r\n  currentValue?: string | null;\r\n  placeholder?: string;\r\n  label: string;\r\n}\r\n\r\n/**\r\n * Reusable component for editing job pack sections\r\n * Provides a consistent edit/save pattern for all sections\r\n */\r\nexport default function SectionEditButton({\r\n  jobId,\r\n  sectionName,\r\n  fieldName,\r\n  currentValue,\r\n  placeholder = \"\",\r\n  label,\r\n}: SectionEditButtonProps) {\r\n  const router = useRouter();\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [value, setValue] = useState(currentValue || \"\");\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  const handleSave = async () => {\r\n    setIsSaving(true);\r\n    setError(\"\");\r\n    setSuccess(false);\r\n\r\n    try {\r\n      const response = await fetch(`/api/jobs/${jobId}/pack-sections`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ [fieldName]: value.trim() || null }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        setError(data.error || \"Failed to save changes\");\r\n        setIsSaving(false);\r\n        return;\r\n      }\r\n\r\n      setIsSaving(false);\r\n      setSuccess(true);\r\n      setTimeout(() => {\r\n        setIsOpen(false);\r\n        setSuccess(false);\r\n        router.refresh();\r\n      }, 1000);\r\n    } catch {\r\n      setError(\"An unexpected error occurred\");\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCancel = () => {\r\n    setValue(currentValue || \"\");\r\n    setError(\"\");\r\n    setSuccess(false);\r\n    setIsOpen(false);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        onClick={() => setIsOpen(true)}\r\n        className=\"inline-flex items-center text-xs text-slate-500 hover:text-slate-700 hover:bg-slate-100 px-2 py-1 rounded transition-colors\"\r\n        title={`Edit ${label}`}\r\n      >\r\n        <svg className=\"w-3.5 h-3.5 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\r\n        </svg>\r\n        Edit\r\n      </button>\r\n\r\n      {isOpen && (\r\n        <div className=\"fixed inset-0 bg-slate-900/75 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col\">\r\n            <div className=\"px-6 py-4 border-b border-slate-200\">\r\n              <h3 className=\"text-lg font-semibold text-slate-900\">\r\n                Edit {label}\r\n              </h3>\r\n            </div>\r\n\r\n            <div className=\"p-6 space-y-4 overflow-y-auto flex-1\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                  {label}\r\n                </label>\r\n                <textarea\r\n                  value={value}\r\n                  onChange={(e) => setValue(e.target.value)}\r\n                  rows={12}\r\n                  placeholder={placeholder}\r\n                  className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-none text-sm font-mono\"\r\n                  disabled={isSaving}\r\n                />\r\n                <p className=\"mt-2 text-xs text-slate-500\">\r\n                  Make any adjustments to this section. Changes will be saved immediately and won&apos;t trigger AI regeneration.\r\n                </p>\r\n              </div>\r\n\r\n              {error && (\r\n                <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n                  {error}\r\n                </div>\r\n              )}\r\n\r\n              {success && (\r\n                <div className=\"p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm\">\r\n                  Changes saved successfully!\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"px-6 py-4 border-t border-slate-200 flex justify-end gap-3\">\r\n              <button\r\n                onClick={handleCancel}\r\n                disabled={isSaving}\r\n                className=\"px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={handleSave}\r\n                disabled={isSaving}\r\n                className=\"px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center\"\r\n              >\r\n                {isSaving && (\r\n                  <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                  </svg>\r\n                )}\r\n                Save\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SendToClientButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SpecDocButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useState' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { hasDocumentFeatureAccess } from \"@/lib/documentAccess\";\r\nimport type { SafeUser } from \"@/lib/auth\";\r\nimport { Lock } from \"lucide-react\";\r\n\r\ninterface SpecDocButtonProps {\r\n  jobId: string;\r\n  hasScopeOfWork: boolean;\r\n  user?: SafeUser | null;\r\n  planTier?: string;\r\n  planStatus?: string;\r\n}\r\n\r\nexport default function SpecDocButton({ \r\n  jobId, \r\n  hasScopeOfWork, \r\n  user = null,\r\n  planTier = \"FREE\",\r\n  planStatus = \"TRIAL\",\r\n}: SpecDocButtonProps) {\r\n  const hasAccess = hasDocumentFeatureAccess(user, { \r\n    planTier, \r\n    planStatus, \r\n    isAdmin: user?.isAdmin ?? false \r\n  });\r\n\r\n  if (!hasScopeOfWork) {\r\n    return (\r\n      <button\r\n        disabled\r\n        className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-slate-400 bg-slate-100 rounded-lg cursor-not-allowed\"\r\n        title=\"Add scope of work to create a spec doc\"\r\n      >\r\n        <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n        </svg>\r\n        Create Spec Doc\r\n      </button>\r\n    );\r\n  }\r\n\r\n  if (!hasAccess) {\r\n    return (\r\n      <button\r\n        disabled\r\n        className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-slate-400 bg-slate-100 rounded-lg cursor-not-allowed\"\r\n        title=\"A paid plan or pilot program membership is required. Free users can create job packs only.\"\r\n      >\r\n        <Lock className=\"w-4 h-4 mr-2\" />\r\n        Create Spec Doc\r\n      </button>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Link\r\n      href={`/jobs/${jobId}/spec-doc`}\r\n      className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors\"\r\n    >\r\n      <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\r\n      </svg>\r\n      Create Spec Doc\r\n    </Link>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SuggestedTradiesPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1367,1370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1367,1370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Loader2, Mail, Building2, Wrench, MapPin, CheckCircle } from \"lucide-react\";\r\nimport type { MatchedTradie } from \"@/lib/matching\";\r\n\r\ninterface SuggestedTradiesPanelProps {\r\n  jobId: string;\r\n}\r\n\r\nfunction getMatchLabel(score: number): { label: string; color: string } {\r\n  if (score >= 80) {\r\n    return { label: \"Great match\", color: \"text-emerald-700 bg-emerald-100\" };\r\n  } else if (score >= 50) {\r\n    return { label: \"Good match\", color: \"text-blue-700 bg-blue-100\" };\r\n  } else {\r\n    return { label: \"Possible match\", color: \"text-amber-700 bg-amber-100\" };\r\n  }\r\n}\r\n\r\nexport default function SuggestedTradiesPanel({ jobId }: SuggestedTradiesPanelProps) {\r\n  const [matches, setMatches] = useState<MatchedTradie[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    async function fetchMatches() {\r\n      setIsLoading(true);\r\n      setError(null);\r\n      try {\r\n        const response = await fetch(`/api/jobs/${jobId}/matches`);\r\n        if (!response.ok) {\r\n          const data = await response.json();\r\n          throw new Error(data.error || \"Failed to load matches\");\r\n        }\r\n        const data = await response.json();\r\n        setMatches(data.matches || []);\r\n      } catch (err: any) {\r\n        setError(err.message || \"Failed to load suggested tradies\");\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n\r\n    fetchMatches();\r\n  }, [jobId]);\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n      <div className=\"px-6 py-4 border-b border-slate-200\">\r\n        <h2 className=\"text-lg font-semibold text-slate-900\">Suggested Tradies</h2>\r\n        <p className=\"text-xs text-slate-500 mt-1\">\r\n          Tradies who match this job based on trade, work type, and service area\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"p-6\">\r\n        {isLoading ? (\r\n          <div className=\"flex items-center justify-center py-8\">\r\n            <Loader2 className=\"w-6 h-6 animate-spin text-amber-500 mr-2\" />\r\n            <span className=\"text-slate-600\">Finding suitable tradies...</span>\r\n          </div>\r\n        ) : error ? (\r\n          <div className=\"text-center py-8\">\r\n            <p className=\"text-sm text-red-600\">{error}</p>\r\n          </div>\r\n        ) : matches.length === 0 ? (\r\n          <div className=\"text-center py-8\">\r\n            <p className=\"text-sm text-slate-500\">\r\n              No strong matches found based on trade and service area.\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {matches.map((tradie) => {\r\n              const matchInfo = getMatchLabel(tradie.matchScore);\r\n              const workTypes = [];\r\n              if (tradie.workTypes.residential) workTypes.push(\"Residential\");\r\n              if (tradie.workTypes.commercial) workTypes.push(\"Commercial\");\r\n              if (tradie.workTypes.strata) workTypes.push(\"Strata\");\r\n\r\n              return (\r\n                <div\r\n                  key={tradie.userId}\r\n                  className=\"p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors\"\r\n                >\r\n                  <div className=\"flex items-start justify-between gap-4 mb-3\">\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"flex items-center gap-2 mb-1\">\r\n                        <Building2 className=\"w-4 h-4 text-slate-400 flex-shrink-0\" />\r\n                        <h3 className=\"font-semibold text-slate-900 truncate\">\r\n                          {tradie.businessName || tradie.email || \"Unknown\"}\r\n                        </h3>\r\n                      </div>\r\n                      {tradie.primaryTrade && (\r\n                        <div className=\"flex items-center gap-2 text-sm text-slate-600 mb-1\">\r\n                          <Wrench className=\"w-3 h-3\" />\r\n                          <span>{tradie.primaryTrade}</span>\r\n                        </div>\r\n                      )}\r\n                      {tradie.serviceAreaSummary && (\r\n                        <div className=\"flex items-center gap-2 text-sm text-slate-600 mb-1\">\r\n                          <MapPin className=\"w-3 h-3\" />\r\n                          <span className=\"truncate\">{tradie.serviceAreaSummary}</span>\r\n                        </div>\r\n                      )}\r\n                      {workTypes.length > 0 && (\r\n                        <div className=\"flex items-center gap-2 text-xs text-slate-500 mt-2\">\r\n                          <CheckCircle className=\"w-3 h-3\" />\r\n                          <span>{workTypes.join(\", \")}</span>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex flex-col items-end gap-2 flex-shrink-0\">\r\n                      <span\r\n                        className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${matchInfo.color}`}\r\n                      >\r\n                        {matchInfo.label}\r\n                      </span>\r\n                      <span className=\"text-xs text-slate-500\">Score: {tradie.matchScore}</span>\r\n                    </div>\r\n                  </div>\r\n                  {tradie.email && (\r\n                    <div className=\"pt-3 border-t border-slate-100\">\r\n                      <a\r\n                        href={`mailto:${tradie.email}`}\r\n                        className=\"inline-flex items-center gap-1.5 text-sm text-amber-600 hover:text-amber-700 font-medium\"\r\n                      >\r\n                        <Mail className=\"w-4 h-4\" />\r\n                        <span>{tradie.email}</span>\r\n                      </a>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SwmsPdfButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\SwmsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":66,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2516,2519],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2516,2519],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5104,5107],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5104,5107],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":154,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5823,5826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5823,5826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":164,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6146,6149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6146,6149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { getCurrentUser, isClient, isAdmin } from \"@/lib/auth\";\r\nimport { getJobById, saveJob } from \"@/lib/jobs\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { isDemoUser } from \"@/lib/demo\";\r\n\r\n/**\r\n * Server Action to update client details for a job\r\n * Only accessible by non-client users who own the job, or superadmins, or demo users\r\n */\r\nexport async function updateClientDetails(\r\n  jobId: string,\r\n  clientName: string,\r\n  clientEmail: string\r\n): Promise<{ ok: boolean; message?: string }> {\r\n  try {\r\n    // ========================================================================\r\n    // Input Validation\r\n    // ========================================================================\r\n    if (!jobId || typeof jobId !== \"string\" || jobId.trim() === \"\") {\r\n      console.error(\"[updateClientDetails] Invalid jobId:\", jobId);\r\n      return { ok: false, message: \"Invalid job ID\" };\r\n    }\r\n\r\n    if (!clientName || typeof clientName !== \"string\" || clientName.trim() === \"\") {\r\n      return { ok: false, message: \"Client name is required\" };\r\n    }\r\n\r\n    if (!clientEmail || typeof clientEmail !== \"string\" || clientEmail.trim() === \"\") {\r\n      return { ok: false, message: \"Client email is required\" };\r\n    }\r\n\r\n    // Basic email validation\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    const trimmedEmail = clientEmail.trim().toLowerCase();\r\n    if (!emailRegex.test(trimmedEmail)) {\r\n      return { ok: false, message: \"Please enter a valid email address\" };\r\n    }\r\n\r\n    // ========================================================================\r\n    // Authentication & Authorization\r\n    // ========================================================================\r\n    const currentUser = await getCurrentUser();\r\n    if (!currentUser) {\r\n      return { ok: false, message: \"Not authenticated\" };\r\n    }\r\n\r\n    // Only non-client users can update client details\r\n    if (isClient(currentUser)) {\r\n      return { ok: false, message: \"Clients cannot update client details\" };\r\n    }\r\n\r\n    // Check if user is a superadmin\r\n    const isSuperAdmin = isAdmin(currentUser);\r\n    \r\n    // Check if user is a demo user\r\n    const userIsDemoUser = isDemoUser(currentUser.email);\r\n\r\n    // ========================================================================\r\n    // Get and Verify Job\r\n    // ========================================================================\r\n    let job;\r\n    try {\r\n      job = await getJobById(jobId);\r\n    } catch (getJobError: any) {\r\n      console.error(\"[updateClientDetails] Error getting job:\", {\r\n        jobId,\r\n        error: getJobError?.message,\r\n        stack: getJobError?.stack,\r\n        code: getJobError?.code,\r\n      });\r\n      return { ok: false, message: `Failed to load job: ${getJobError?.message || \"Unknown error\"}` };\r\n    }\r\n\r\n    if (!job) {\r\n      console.error(\"[updateClientDetails] Job not found:\", jobId);\r\n      return { ok: false, message: \"Job not found\" };\r\n    }\r\n\r\n    // Verify ownership - superadmins, demo users, or job owners can update\r\n    if (job.userId !== currentUser.id && !isSuperAdmin && !userIsDemoUser) {\r\n      return { ok: false, message: \"You don't have permission to edit this job.\" };\r\n    }\r\n\r\n    // ========================================================================\r\n    // Plan Check (bypass for superadmins and demo users)\r\n    // ========================================================================\r\n    if (!isSuperAdmin && !userIsDemoUser) {\r\n      const { hasPaidPlan } = await import(\"@/lib/planChecks\");\r\n      \r\n      if (!hasPaidPlan(currentUser)) {\r\n        // Get plan tier from Prisma\r\n        let planTier = \"FREE\";\r\n        try {\r\n          const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\r\n          const prismaUser = await prisma.user.findUnique({\r\n            where: { email: currentUser.email },\r\n            select: { planTier: true },\r\n          });\r\n          if (prismaUser?.planTier) {\r\n            planTier = prismaUser.planTier;\r\n          }\r\n        } catch (error) {\r\n          console.warn(\"[updateClientDetails] Failed to fetch plan tier:\", error);\r\n        }\r\n        \r\n        if (planTier === \"FREE\") {\r\n          return {\r\n            ok: false,\r\n            message: \"A paid membership is required to save client details and send job packs. Please upgrade your plan to continue.\",\r\n          };\r\n        }\r\n      }\r\n    }\r\n\r\n    // ========================================================================\r\n    // Update Job with Client Details\r\n    // ========================================================================\r\n    const trimmedName = clientName.trim();\r\n    job.clientName = trimmedName;\r\n    job.clientEmail = trimmedEmail;\r\n    \r\n    try {\r\n      await saveJob(job);\r\n      console.log(\"[updateClientDetails] Successfully saved client details:\", {\r\n        jobId,\r\n        clientName: trimmedName,\r\n        clientEmail: trimmedEmail,\r\n        userId: currentUser.id,\r\n        isSuperAdmin,\r\n        isDemoUser: userIsDemoUser,\r\n      });\r\n    } catch (saveError: any) {\r\n      console.error(\"[updateClientDetails] Error saving job to KV store:\", {\r\n        jobId,\r\n        error: saveError?.message,\r\n        stack: saveError?.stack,\r\n        code: saveError?.code,\r\n        name: saveError?.name,\r\n        cause: saveError?.cause,\r\n      });\r\n      return { \r\n        ok: false, \r\n        message: `Failed to save client details: ${saveError?.message || \"Database error. Please try again.\"}` \r\n      };\r\n    }\r\n\r\n    // ========================================================================\r\n    // Revalidate Path\r\n    // ========================================================================\r\n    try {\r\n      revalidatePath(`/jobs/${jobId}`);\r\n    } catch (revalidateError: any) {\r\n      console.warn(\"[updateClientDetails] Error revalidating path:\", {\r\n        jobId,\r\n        error: revalidateError?.message,\r\n        stack: revalidateError?.stack,\r\n      });\r\n      // Don't fail the operation if revalidation fails - data is already saved\r\n    }\r\n\r\n    return { ok: true };\r\n  } catch (error: any) {\r\n    console.error(\"[updateClientDetails] Unexpected error:\", {\r\n      error: error?.message,\r\n      stack: error?.stack,\r\n      name: error?.name,\r\n      code: error?.code,\r\n      cause: error?.cause,\r\n    });\r\n    return { \r\n      ok: false, \r\n      message: error?.message || \"An unexpected error occurred. Please try again.\" \r\n    };\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\edit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Job' is defined but never used.","line":10,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'QuoteHistoryPanel' is defined but never used.","line":34,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MaterialsManagementSection' is defined but never used.","line":38,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DocGeneratorModal' is defined but never used.","line":45,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":45,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userHasPaidPlan' is assigned a value but never used.","line":691,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":691,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\nimport { redirect, notFound } from \"next/navigation\";\nimport { Pencil } from \"lucide-react\";\nimport { requireActiveUser, isAdmin } from \"@/lib/auth\";\n\n// Authenticated page using requireActiveUser - must be dynamic\nexport const dynamic = \"force-dynamic\";\nexport const fetchCache = \"force-no-store\";\nexport const revalidate = 0;\nimport { getJobById, type Job, type JobStatus, type JobWorkflowStatus, type AIReviewStatus, type ClientStatus, type EffectiveRates } from \"@/lib/jobs\";\nimport type { UserRole } from \"@/lib/auth\";\nimport { formatEffectiveRatesForDisplay, calculateEstimateRange } from \"@/lib/pricing\";\nimport { formatDateTimeForDisplay } from \"@/lib/format\";\nimport CopyForClientButton from \"./CopyForClientButton\";\nimport EmailToClientButton from \"./EmailToClientButton\";\nimport RegenerateButton from \"./RegenerateButton\";\nimport JobStatusControl from \"./JobStatusControl\";\nimport AIReviewStatusControl from \"./AIReviewStatusControl\";\nimport ClientStatusControl from \"./ClientStatusControl\";\nimport SendToClientButton from \"./SendToClientButton\";\nimport JobPackPdfButton from \"./JobPackPdfButton\";\nimport MaterialsEditButton from \"./MaterialsEditButton\";\nimport DeleteJobButton from \"./DeleteJobButton\";\nimport SectionEditButton from \"./SectionEditButton\";\nimport SpecDocButton from \"./SpecDocButton\";\nimport JobDocumentsSection from \"./JobDocumentsSection\";\nimport SafetySection from \"./SafetySection\";\nimport ClientQuoteReview from \"./ClientQuoteReview\";\nimport ClientSignatureStatus from \"./ClientSignatureStatus\";\nimport ClientSignatureDisplay from \"./ClientSignatureDisplay\";\nimport DuplicateJobButton from \"./DuplicateJobButton\";\nimport SaveAsTemplateButton from \"./SaveAsTemplateButton\";\nimport ClientDetailsEntry from \"./ClientDetailsEntry\";\nimport QuoteHistoryPanel from \"./QuoteHistoryPanel\";\nimport ScheduleSection from \"./ScheduleSection\";\nimport SuggestedTradiesPanel from \"./SuggestedTradiesPanel\";\nimport JobAssignmentPanel from \"./JobAssignmentPanel\";\nimport MaterialsManagementSection from \"./MaterialsManagementSection\";\nimport AttachmentsSection from \"./AttachmentsSection\";\nimport VerifiedBadge from \"@/app/components/StructuredBadge\";\nimport OmnexoraHeader from \"@/app/components/OmnexoraHeader\";\nimport FeedbackButton from \"@/app/components/FeedbackButton\";\nimport AIWarningBanner from \"@/app/components/AIWarningBanner\";\nimport OvisBadge from \"@/app/components/OvisBadge\";\nimport DocGeneratorModal from \"@/app/components/docs/DocGeneratorModal\";\nimport { featureFlags } from \"@/lib/featureFlags\";\n\ninterface JobDetailPageProps {\n  params: Promise<{ id: string }>;\n}\n\n// ============================================================================\n// Type Definitions for Parsed AI Data\n// ============================================================================\n\ninterface LabourQuote {\n  description?: string;\n  hours?: string;\n  ratePerHour?: string;\n  total?: string;\n}\n\ninterface MaterialsQuote {\n  description?: string;\n  totalMaterialsCost?: string;\n}\n\ninterface TotalEstimateQuote {\n  description?: string;\n  totalJobEstimate?: string;\n}\n\ninterface ParsedQuote {\n  labour?: LabourQuote;\n  materials?: MaterialsQuote;\n  totalEstimate?: TotalEstimateQuote;\n}\n\ninterface MaterialItem {\n  item: string;\n  quantity?: string;\n  estimatedCost?: string;\n}\n\n// ============================================================================\n// Helper Components\n// ============================================================================\n\nfunction StatusBadge({ status }: { status: JobStatus }) {\n  const styles: Record<JobStatus, string> = {\n    draft: \"bg-slate-100 text-slate-700\",\n    ai_pending: \"bg-amber-100 text-amber-700\",\n    ai_complete: \"bg-green-100 text-green-700\",\n    ai_failed: \"bg-red-100 text-red-700\",\n    pending_regeneration: \"bg-orange-100 text-orange-700\",\n    generating: \"bg-amber-100 text-amber-700\",\n  };\n\n  const labels: Record<JobStatus, string> = {\n    draft: \"Draft\",\n    ai_pending: \"Job pack is being generatedÔÇª\",\n    ai_complete: \"Job pack ready.\",\n    ai_failed: \"Failed\",\n    pending_regeneration: \"Needs Update\",\n    generating: \"Regenerating...\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction JobWorkflowStatusBadge({ status }: { status: JobWorkflowStatus }) {\n  const styles: Record<JobWorkflowStatus, string> = {\n    pending: \"bg-amber-100 text-amber-700\",\n    pending_confirmation: \"bg-purple-100 text-purple-700\",\n    booked: \"bg-green-100 text-green-700\",\n    completed: \"bg-blue-100 text-blue-700\",\n    cancelled: \"bg-slate-100 text-slate-500\",\n  };\n\n  const labels: Record<JobWorkflowStatus, string> = {\n    pending: \"Pending\",\n    pending_confirmation: \"Awaiting Confirmation\",\n    booked: \"Booked\",\n    completed: \"Completed\",\n    cancelled: \"Cancelled\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction AIReviewStatusBadge({ status }: { status: AIReviewStatus }) {\n  const styles: Record<AIReviewStatus, string> = {\n    pending: \"bg-amber-100 text-amber-700\",\n    confirmed: \"bg-green-100 text-green-700\",\n  };\n\n  const labels: Record<AIReviewStatus, string> = {\n    pending: \"Pending review\",\n    confirmed: \"Confirmed\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction ClientStatusBadge({ status }: { status: ClientStatus }) {\n  const styles: Record<ClientStatus, string> = {\n    draft: \"bg-slate-100 text-slate-700\",\n    sent: \"bg-blue-100 text-blue-700\",\n    accepted: \"bg-emerald-100 text-emerald-700\",\n    declined: \"bg-rose-100 text-rose-700\",\n    cancelled: \"bg-amber-100 text-amber-700\",\n  };\n\n  const labels: Record<ClientStatus, string> = {\n    draft: \"Draft\",\n    sent: \"Sent to client\",\n    accepted: \"Accepted\",\n    declined: \"Declined\",\n    cancelled: \"Cancelled\",\n  };\n\n  return (\n    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status]}`}>\n      {labels[status]}\n    </span>\n  );\n}\n\nfunction formatDate(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"en-AU\", {\n    day: \"numeric\",\n    month: \"long\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  });\n}\n\nfunction SectionHeader({ title, icon }: { title: string; icon: React.ReactNode }) {\n  return (\n    <div className=\"flex items-center gap-2 mb-3\">\n      <div className=\"w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600\">\n        {icon}\n      </div>\n      <h3 className=\"text-lg font-semibold text-slate-900\">{title}</h3>\n    </div>\n  );\n}\n\n// ============================================================================\n// Section Components\n// ============================================================================\n\nfunction SummarySection({ content, editButton }: { content?: string; editButton?: React.ReactNode }) {\n  if (!content) return null;\n\n  const paragraphs = content.split(/\\n\\n|\\n/).filter(p => p.trim());\n\n  return (\n    <div className=\"border-b border-slate-200 pb-6\">\n      <div className=\"flex items-center justify-between\">\n        <SectionHeader\n          title=\"Summary\"\n          icon={\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n            </svg>\n          }\n        />\n        {editButton}\n      </div>\n      <div className=\"pl-10 space-y-2\">\n        {paragraphs.map((p, i) => (\n          <p key={i} className=\"text-slate-700 leading-relaxed\">{p}</p>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction PricingSection({ \n  content, \n  effectiveRates,\n  quoteNumber,\n  quoteVersion,\n  quoteExpiryAt,\n  quoteLastSentAt,\n}: { \n  content?: string; \n  effectiveRates?: EffectiveRates | null;\n  quoteNumber?: string | null;\n  quoteVersion?: number | null;\n  quoteExpiryAt?: string | null;\n  quoteLastSentAt?: string | null;\n}) {\n  if (!content) return null;\n\n  let parsedQuote: ParsedQuote | null = null;\n  try {\n    parsedQuote = JSON.parse(content);\n  } catch {\n    // Parse failed, will show fallback\n  }\n\n  // Format effective rates for display\n  const ratesDisplay = effectiveRates ? formatEffectiveRatesForDisplay(effectiveRates) : null;\n\n  // Calculate realistic estimate range\n  const estimateRange = calculateEstimateRange(content);\n\n  const formatDate = (dateString: string | null | undefined) => {\n    if (!dateString) return null;\n    return new Date(dateString).toLocaleDateString(\"en-AU\", {\n      day: \"numeric\",\n      month: \"short\",\n      year: \"numeric\",\n    });\n  };\n\n  return (\n    <div className=\"border-b border-slate-200 pb-6\">\n      <SectionHeader\n        title=\"Pricing Snapshot\"\n        icon={\n          <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n          </svg>\n        }\n      />\n      <div className=\"pl-10\">\n        {/* Quote metadata */}\n        {(quoteNumber || quoteVersion || quoteExpiryAt || quoteLastSentAt) && (\n          <div className=\"mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg space-y-1 text-sm\">\n            {quoteNumber && (\n              <div>\n                <span className=\"text-slate-500\">Quote #:</span>{\" \"}\n                <span className=\"font-medium text-slate-900\">{quoteNumber}</span>\n              </div>\n            )}\n            {quoteVersion != null && (\n              <div>\n                <span className=\"text-slate-500\">Version:</span>{\" \"}\n                <span className=\"font-medium text-slate-900\">v{quoteVersion}</span>\n              </div>\n            )}\n            {quoteLastSentAt && (\n              <div>\n                <span className=\"text-slate-500\">Last sent:</span>{\" \"}\n                <span className=\"font-medium text-slate-900\">{formatDate(quoteLastSentAt)}</span>\n              </div>\n            )}\n            {quoteExpiryAt && (\n              <div>\n                <span className=\"text-slate-500\">Valid until:</span>{\" \"}\n                <span className={`font-medium ${\n                  new Date(quoteExpiryAt) < new Date() ? \"text-red-600\" : \"text-slate-900\"\n                }`}>\n                  {formatDate(quoteExpiryAt)}\n                  {new Date(quoteExpiryAt) < new Date() && \" (Expired)\"}\n                </span>\n              </div>\n            )}\n          </div>\n        )}\n        {/* Show \"based on your rates\" if effective rates are available */}\n        {ratesDisplay && (\n          <div className=\"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg\">\n            <p className=\"text-xs text-amber-700\">\n              <span className=\"font-medium\">Based on your rates:</span> {ratesDisplay}\n            </p>\n          </div>\n        )}\n        {parsedQuote ? (\n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n            {parsedQuote.labour && (\n              <div className=\"bg-slate-50 rounded-lg p-4 border border-slate-200\">\n                <p className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">Labour</p>\n                {parsedQuote.labour.description && (\n                  <p className=\"text-sm text-slate-600 mb-2\">{parsedQuote.labour.description}</p>\n                )}\n                <div className=\"space-y-1\">\n                  {parsedQuote.labour.hours && (\n                    <p className=\"text-xs text-slate-500\">Hours: {parsedQuote.labour.hours}</p>\n                  )}\n                  {parsedQuote.labour.ratePerHour && (\n                    <p className=\"text-xs text-slate-500\">Rate: {parsedQuote.labour.ratePerHour}</p>\n                  )}\n                </div>\n                {parsedQuote.labour.total && (\n                  <p className=\"text-lg font-semibold text-slate-900 mt-2\">{parsedQuote.labour.total}</p>\n                )}\n              </div>\n            )}\n            {parsedQuote.materials && (\n              <div className=\"bg-slate-50 rounded-lg p-4 border border-slate-200\">\n                <p className=\"text-xs font-medium text-slate-500 uppercase tracking-wider mb-1\">Materials</p>\n                {parsedQuote.materials.description && (\n                  <p className=\"text-sm text-slate-600 mb-2\">{parsedQuote.materials.description}</p>\n                )}\n                {parsedQuote.materials.totalMaterialsCost && (\n                  <p className=\"text-lg font-semibold text-slate-900 mt-2\">{parsedQuote.materials.totalMaterialsCost}</p>\n                )}\n              </div>\n            )}\n            {parsedQuote.totalEstimate && (\n              <div className=\"bg-amber-50 rounded-lg p-4 border border-amber-200\">\n                <p className=\"text-xs font-medium text-amber-700 uppercase tracking-wider mb-1\">Total Estimate</p>\n                {parsedQuote.totalEstimate.description && (\n                  <p className=\"text-sm text-amber-700 mb-2\">{parsedQuote.totalEstimate.description}</p>\n                )}\n                {/* Display realistic range instead of identical min/max */}\n                <p className=\"text-lg font-bold text-amber-900 mt-2\">\n                  {estimateRange.formattedRange}\n                </p>\n              </div>\n            )}\n          </div>\n        ) : (\n          <pre className=\"text-slate-700 text-sm whitespace-pre-wrap bg-slate-50 p-4 rounded-lg border border-slate-200\">\n            {content}\n          </pre>\n        )}\n        \n        {/* Pricing disclaimer */}\n        <div className=\"mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg\">\n          <p className=\"text-xs text-amber-700 flex items-start gap-2\">\n            <svg className=\"w-4 h-4 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <span>\n              <strong>Important:</strong> All pricing shown is an estimate only. Labour hours and material costs are approximate and must be confirmed against actual site conditions and current supplier pricing before sending to clients.\n            </span>\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ScopeSection({ content, editButton }: { content?: string; editButton?: React.ReactNode }) {\n  if (!content) return null;\n\n  const lines = content.split(\"\\n\").filter(line => line.trim());\n\n  return (\n    <div className=\"border-b border-slate-200 pb-6\">\n      <div className=\"flex items-center justify-between\">\n        <SectionHeader\n          title=\"Scope of Work\"\n          icon={\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01\" />\n            </svg>\n          }\n        />\n        {editButton}\n      </div>\n      <div className=\"pl-10\">\n        {lines.length > 1 ? (\n          <ol className=\"list-decimal list-inside space-y-2\">\n            {lines.map((line, i) => (\n              <li key={i} className=\"text-slate-700 leading-relaxed\">{line}</li>\n            ))}\n          </ol>\n        ) : (\n          <p className=\"text-slate-700 leading-relaxed\">{content}</p>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ListSection({ \n  title, \n  content, \n  icon, \n  variant = \"check\",\n  editButton,\n}: { \n  title: string; \n  content?: string; \n  icon: React.ReactNode;\n  variant?: \"check\" | \"x\";\n  editButton?: React.ReactNode;\n}) {\n  if (!content) return null;\n\n  const items = content.split(\"\\n\").filter(item => item.trim());\n  if (items.length === 0) return null;\n\n  return (\n    <div className=\"border-b border-slate-200 pb-6\">\n      <div className=\"flex items-center justify-between\">\n        <SectionHeader title={title} icon={icon} />\n        {editButton}\n      </div>\n      <div className=\"pl-10\">\n        <ul className=\"space-y-2\">\n          {items.map((item, i) => (\n            <li key={i} className=\"flex items-start gap-2\">\n              {variant === \"check\" ? (\n                <svg className=\"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n              ) : (\n                <svg className=\"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                </svg>\n              )}\n              <span className=\"text-slate-700 leading-relaxed\">{item}</span>\n            </li>\n          ))}\n        </ul>\n      </div>\n    </div>\n  );\n}\n\nfunction MaterialsSection({ \n  content, \n  overrideText,\n  showRoughEstimateDisclaimer,\n  editButton,\n}: { \n  content?: string;\n  overrideText?: string | null;\n  showRoughEstimateDisclaimer?: boolean;\n  editButton?: React.ReactNode;\n}) {\n  // If override text is present, show that instead of AI content\n  const hasOverride = overrideText && overrideText.trim().length > 0;\n  \n  // Show disclaimer if rough estimate flag is set OR if there's no custom override\n  const showDisclaimer = showRoughEstimateDisclaimer || !hasOverride;\n\n  let materials: MaterialItem[] | null = null;\n  if (content && !hasOverride) {\n    try {\n      materials = JSON.parse(content);\n    } catch {\n      // Parse failed, will show fallback\n    }\n  }\n\n  // Don't render if no content and no override\n  if (!content && !hasOverride) return null;\n\n  return (\n    <div className=\"border-b border-slate-200 pb-6\">\n      <div className=\"flex items-center justify-between\">\n        <SectionHeader\n          title=\"Materials\"\n          icon={\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n            </svg>\n          }\n        />\n        {editButton}\n      </div>\n      <div className=\"pl-10\">\n        {hasOverride ? (\n          <>\n            <div className=\"mb-3\">\n              <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700\">\n                Final materials notes (overrides AI suggestion)\n              </span>\n            </div>\n            <div className=\"text-slate-700 text-sm whitespace-pre-wrap bg-slate-50 p-4 rounded-lg border border-slate-200\">\n              {overrideText}\n            </div>\n          </>\n        ) : materials && Array.isArray(materials) && materials.length > 0 ? (\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-sm\">\n              <thead>\n                <tr className=\"border-b border-slate-200\">\n                  <th className=\"text-left py-2 pr-4 font-medium text-slate-600\">Item</th>\n                  <th className=\"text-left py-2 pr-4 font-medium text-slate-600\">Quantity</th>\n                  <th className=\"text-right py-2 font-medium text-slate-600\">Est. Cost</th>\n                </tr>\n              </thead>\n              <tbody>\n                {materials.map((mat, i) => (\n                  <tr key={i} className=\"border-b border-slate-100 last:border-0\">\n                    <td className=\"py-2 pr-4 text-slate-700\">{mat.item}</td>\n                    <td className=\"py-2 pr-4 text-slate-600\">{mat.quantity || \"ÔÇö\"}</td>\n                    <td className=\"py-2 text-right text-slate-700 font-medium\">{mat.estimatedCost || \"ÔÇö\"}</td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        ) : content ? (\n          <pre className=\"text-slate-700 text-sm whitespace-pre-wrap bg-slate-50 p-4 rounded-lg border border-slate-200\">\n            {content}\n          </pre>\n        ) : null}\n\n        {/* Materials disclaimer */}\n        {showDisclaimer && (\n          <div className=\"mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg\">\n            <p className=\"text-xs text-amber-700 flex items-start gap-2\">\n              <svg className=\"w-4 h-4 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n              <span>\n                <strong>Note:</strong> Material prices are an estimate only and must be checked against current supplier pricing.\n              </span>\n            </p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction NotesSection({ content, editButton }: { content?: string; editButton?: React.ReactNode }) {\n  if (!content) return null;\n\n  const paragraphs = content.split(/\\n\\n|\\n/).filter(p => p.trim());\n\n  return (\n    <div className=\"pb-0\">\n      <div className=\"flex items-center justify-between\">\n        <SectionHeader\n          title=\"Client Notes\"\n          icon={\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z\" />\n            </svg>\n          }\n        />\n        {editButton}\n      </div>\n      <div className=\"pl-10 space-y-2\">\n        {paragraphs.map((p, i) => (\n          <p key={i} className=\"text-slate-700 leading-relaxed\">{p}</p>\n        ))}\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Main Page Component\n// ============================================================================\n\nexport default async function JobDetailPage({ params }: JobDetailPageProps) {\n  const { id } = await params;\n  \n  const user = await requireActiveUser(`/jobs/${id}`);\n\n  const job = await getJobById(id);\n  \n  if (!job) {\n    notFound();\n  }\n\n  // Security check - ensure user owns this job OR is admin (admins can view all jobs)\n  const userIsAdmin = isAdmin(user);\n  \n  if (job.userId !== user.id && !userIsAdmin) {\n    redirect(\"/jobs\");\n  }\n\n  // Handle deleted jobs - redirect to jobs list\n  if (job.isDeleted === true) {\n    redirect(\"/jobs?error=job_removed\");\n  }\n\n  // Get verification status (with default for older users)\n  const verificationStatus = user.verificationStatus || \"unverified\";\n  const userRole: UserRole = (user.role || \"tradie\") as UserRole;\n  const isVerified = verificationStatus === \"verified\";\n  \n  // Get plan info and business profile from Prisma\n  let planTier = \"FREE\";\n  let planStatus = \"TRIAL\";\n  let businessProfile: {\n    legalName?: string;\n    tradingName?: string;\n    abn?: string;\n    email?: string;\n    phone?: string;\n    addressLine1?: string;\n    addressLine2?: string;\n    suburb?: string;\n    state?: string;\n    postcode?: string;\n  } | null = null;\n  \n  try {\n    const { getPrisma } = await import(\"@/lib/prisma\"); const prisma = getPrisma();\n    const prismaUser = await prisma.user.findUnique({\n      where: { email: user.email },\n      select: { \n        planTier: true, \n        planStatus: true,\n        // Business profile fields for PDF headers\n        businessName: true,\n        tradingName: true,\n        abn: true,\n        email: true,\n        businessPhone: true,\n        businessAddressLine1: true,\n        businessAddressLine2: true,\n        businessSuburb: true,\n        businessState: true,\n        businessPostcode: true,\n      },\n    });\n    if (prismaUser?.planTier) {\n      planTier = prismaUser.planTier;\n    }\n    if (prismaUser?.planStatus) {\n      planStatus = prismaUser.planStatus;\n    }\n    // Build business profile for PDF exports\n    if (prismaUser?.businessName) {\n      businessProfile = {\n        legalName: prismaUser.businessName || undefined,\n        tradingName: prismaUser.tradingName || undefined,\n        abn: prismaUser.abn || undefined,\n        email: prismaUser.email || undefined,\n        phone: prismaUser.businessPhone || undefined,\n        addressLine1: prismaUser.businessAddressLine1 || undefined,\n        addressLine2: prismaUser.businessAddressLine2 || undefined,\n        suburb: prismaUser.businessSuburb || undefined,\n        state: prismaUser.businessState || undefined,\n        postcode: prismaUser.businessPostcode || undefined,\n      };\n    }\n  } catch (error) {\n    console.warn(\"Failed to fetch plan tier:\", error);\n  }\n  \n  // Check if user has paid plan (admin users always have access)\n  const userHasPaidPlan = userIsAdmin || planTier !== \"FREE\";\n  const userIsFreePlan = !userIsAdmin && planTier === \"FREE\";\n  \n  // Check if this is a client job (posted via client portal)\n  const isClientJob = job.leadSource === \"CLIENT_PORTAL\";\n\n  // For client view, get tradie verification status\n  let tradieVerificationStatus: string | null = null;\n  if (userRole === \"client\") {\n    // Fetch the tradie's verification status from Prisma\n    try {\n      const { getUserVerification } = await import(\"@/lib/verification\");\n      const tradieVerification = await getUserVerification(job.userId);\n      tradieVerificationStatus = tradieVerification?.status || null;\n    } catch (err) {\n      // Silently fail - don't break the page\n      console.warn(\"Failed to fetch tradie verification status:\", err);\n    }\n  }\n\n  return (\n    <div className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n      {/* Brand Header */}\n      <OmnexoraHeader verificationStatus={verificationStatus} />\n\n      {/* Structuring Banner for unstructured tradies */}\n      {userRole === \"tradie\" && verificationStatus !== \"verified\" && (\n        <div className=\"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n            </svg>\n            <div>\n              <p className=\"font-medium text-amber-800\">\n                {(verificationStatus === \"pending\" || (verificationStatus as string) === \"pending_review\") \n                  ? \"Verification in progress\" \n                  : \"Complete your business verification\"}\n              </p>\n              <p className=\"text-sm text-amber-700 mt-1\">\n                {(verificationStatus === \"pending\" || (verificationStatus as string) === \"pending_review\")\n                  ? \"Your verification is being reviewed. You'll be able to email job packs once approved.\"\n                  : \"Complete your business profile to display your \\\"Verified Trade\\\" badge and email job packs directly to clients.\"}\n              </p>\n              {verificationStatus !== \"pending\" && (verificationStatus as string) !== \"pending_review\" && (\n                <a\n                  href=\"/settings/verification\"\n                  className=\"inline-flex items-center gap-1 mt-2 text-sm font-medium text-amber-700 hover:text-amber-800\"\n                >\n                  Complete verification\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                  </svg>\n                </a>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Header */}\n      <div className=\"mb-8\">\n        <Link\n          href=\"/jobs\"\n          className=\"inline-flex items-center text-sm text-slate-500 hover:text-slate-700 mb-4\"\n        >\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n          </svg>\n          Back to Jobs\n        </Link>\n        <div className=\"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4\">\n          <div>\n            <div className=\"flex items-center gap-3 mb-2\">\n              <h1 className=\"text-3xl font-bold text-slate-900\">{job.title}</h1>\n              <StatusBadge status={job.status} />\n              <Link\n                href={`/jobs/${job.id}/edit`}\n                className=\"inline-flex items-center gap-1.5 px-3 py-1 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors\"\n              >\n                <Pencil className=\"w-4 h-4\" />\n                <span>Edit</span>\n              </Link>\n            </div>\n            <div className=\"flex flex-wrap items-center gap-4 text-slate-600 text-sm\">\n              <span className=\"flex items-center gap-1\">\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                </svg>\n                {job.tradeType}\n              </span>\n              <span className=\"flex items-center gap-1\">\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6\" />\n                </svg>\n                {job.propertyType}\n              </span>\n              <span className=\"flex items-center gap-1\">\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                {formatDate(job.createdAt)}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Sidebar - Job Info */}\n        <div className=\"lg:col-span-1\">\n          <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 sticky top-6\">\n            <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Job Information</h2>\n            <div className=\"space-y-4\">\n              {/* Job Workflow Status */}\n              <div>\n                <p className=\"text-sm text-slate-500 mb-1\">Job Status</p>\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <JobWorkflowStatusBadge status={job.jobStatus || \"pending\"} />\n                </div>\n                <div className=\"mt-2\">\n                  <JobStatusControl jobId={job.id} currentStatus={job.jobStatus || \"pending\"} />\n                </div>\n              </div>\n\n              {/* Action Required Banner - when client has responded but job status not updated */}\n              {job.clientStatus === \"accepted\" && job.jobStatus === \"pending\" && (\n                <div className=\"p-4 bg-emerald-50 border border-emerald-200 rounded-lg\">\n                  <div className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 text-emerald-500 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                    </svg>\n                    <div>\n                      <p className=\"font-semibold text-emerald-900 mb-1\">\n                        Client Accepted! ­ƒÄë\n                      </p>\n                      <p className=\"text-sm text-emerald-700\">\n                        Use &quot;Change status&quot; above to mark the job as Booked when ready to proceed.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              )}\n              {job.clientStatus === \"declined\" && job.jobStatus === \"pending\" && (\n                <div className=\"p-4 bg-rose-50 border border-rose-200 rounded-lg\">\n                  <div className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 text-rose-500 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                    </svg>\n                    <div>\n                      <p className=\"font-semibold text-rose-900 mb-1\">\n                        Client Declined\n                      </p>\n                      <p className=\"text-sm text-rose-700\">\n                        Use &quot;Change status&quot; above to mark as Cancelled, or follow up with the client.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* AI Pack Review Status */}\n              <div>\n                <p className=\"text-sm text-slate-500 mb-1\">AI Pack</p>\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <AIReviewStatusBadge status={job.aiReviewStatus || \"pending\"} />\n                </div>\n                <div className=\"mt-2\">\n                  <AIReviewStatusControl jobId={job.id} currentStatus={job.aiReviewStatus || \"pending\"} />\n                </div>\n              </div>\n\n              {/* Client Status */}\n              <div>\n                <p className=\"text-sm text-slate-500 mb-1\">Client Status</p>\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <ClientStatusBadge status={job.clientStatus || \"draft\"} />\n                  {(job.clientStatus || \"draft\") === \"accepted\" && (\n                    <span className=\"text-xs text-emerald-600 font-medium\">­ƒÄë Won job!</span>\n                  )}\n                </div>\n                {job.clientStatus === \"accepted\" && job.clientAcceptedAt && (\n                  <div className=\"mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg\">\n                    <p className=\"font-semibold text-emerald-900 mb-2\">Client Acceptance</p>\n                    <div className=\"space-y-1 text-sm text-emerald-700\">\n                      <p><span className=\"font-medium\">Status:</span> Accepted</p>\n                      <p><span className=\"font-medium\">When:</span> {formatDate(job.clientAcceptedAt)}</p>\n                      {job.clientAcceptedByName && (\n                        <p><span className=\"font-medium\">Accepted by:</span> {job.clientAcceptedByName}</p>\n                      )}\n                      {job.quoteNumber && job.clientAcceptedQuoteVer && (\n                        <p><span className=\"font-medium\">Quote:</span> {job.quoteNumber} v{job.clientAcceptedQuoteVer}</p>\n                      )}\n                      {job.clientAcceptanceNote && (\n                        <div className=\"mt-2 pt-2 border-t border-emerald-200\">\n                          <p className=\"font-medium\">Client note:</p>\n                          <p className=\"text-emerald-600 whitespace-pre-wrap\">{job.clientAcceptanceNote}</p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n                {job.clientStatus === \"declined\" && job.clientDeclinedAt && (\n                  <div className=\"mt-2 text-xs text-slate-600\">\n                    <p className=\"font-medium\">Declined</p>\n                    <p>on {formatDate(job.clientDeclinedAt)}</p>\n                  </div>\n                )}\n                {job.clientStatus === \"sent\" && (\n                  <div className=\"mt-2 text-xs text-slate-500\">\n                    <p>Awaiting client decision</p>\n                  </div>\n                )}\n                {(!job.clientStatus || job.clientStatus === \"draft\") && (\n                  <div className=\"mt-2 text-xs text-slate-500\">\n                    <p>Not sent to client yet</p>\n                  </div>\n                )}\n                {job.clientStatusUpdatedAt && job.clientStatus !== \"accepted\" && job.clientStatus !== \"declined\" && (\n                  <p className=\"text-xs text-slate-400 mt-1\">\n                    Updated: {formatDate(job.clientStatusUpdatedAt)}\n                  </p>\n                )}\n                <div className=\"mt-2\">\n                  <ClientStatusControl jobId={job.id} currentStatus={job.clientStatus || \"draft\"} />\n                </div>\n              </div>\n\n              {/* AI Generation Status */}\n              <div className=\"pt-4 border-t border-slate-200\">\n                <p className=\"text-sm text-slate-500 mb-1\">AI Generation</p>\n                <StatusBadge status={job.status} />\n              </div>\n\n              {/* Structured Account Badge (for tradie view) */}\n              {isVerified && userRole !== \"client\" && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <div className=\"inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-medium text-emerald-700 border border-emerald-300\">\n                    <svg className=\"w-3 h-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                    </svg>\n                    <span>Verified account</span>\n                  </div>\n                </div>\n              )}\n\n              {/* Client Details */}\n              {(job.clientName || job.clientEmail) && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <p className=\"text-sm text-slate-500 font-medium\">Client</p>\n                    {job.clientId && userRole !== \"client\" && (\n                      <Link\n                        href={`/clients/${job.clientId}`}\n                        className=\"text-xs text-amber-600 hover:text-amber-700 font-medium\"\n                      >\n                        View profile ÔåÆ\n                      </Link>\n                    )}\n                  </div>\n                  {job.clientName && (\n                    <p className=\"text-slate-900 font-medium\">{job.clientName}</p>\n                  )}\n                  {job.clientEmail && (\n                    <a\n                      href={`mailto:${job.clientEmail}`}\n                      className=\"text-amber-600 hover:text-amber-700 text-sm\"\n                    >\n                      {job.clientEmail}\n                    </a>\n                  )}\n                </div>\n              )}\n\n              {/* Schedule Section - Only for tradie/business users */}\n              {userRole !== \"client\" && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <ScheduleSection\n                    jobId={job.id}\n                    scheduledStartAt={job.scheduledStartAt}\n                    scheduledEndAt={job.scheduledEndAt}\n                    scheduleNotes={job.scheduleNotes}\n                  />\n                </div>\n              )}\n\n              <div className=\"pt-4 border-t border-slate-200\">\n                <p className=\"text-sm text-slate-500 mb-1\">Trade Type</p>\n                <p className=\"text-slate-900 font-medium\">{job.tradeType}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-slate-500 mb-1\">Property Type</p>\n                <p className=\"text-slate-900 font-medium\">{job.propertyType}</p>\n              </div>\n              {job.address && (\n                <div>\n                  <p className=\"text-sm text-slate-500 mb-1\">Address</p>\n                  <p className=\"text-slate-900 font-medium\">{job.address}</p>\n                </div>\n              )}\n              <div>\n                <p className=\"text-sm text-slate-500 mb-1\">Created</p>\n                <p className=\"text-slate-900 font-medium\">{formatDate(job.createdAt)}</p>\n              </div>\n              {job.notes && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <p className=\"text-sm text-slate-500 mb-2\">Your Notes</p>\n                  <p className=\"text-slate-700 text-sm whitespace-pre-wrap\">{job.notes}</p>\n                </div>\n              )}\n\n              {/* Business Status */}\n              {userRole === \"tradie\" && (\n                <div className=\"pt-4 border-t border-slate-200\">\n                  <p className=\"text-sm text-slate-500 mb-2\">Business Status</p>\n                  {verificationStatus === \"verified\" ? (\n                    <VerifiedBadge />\n                  ) : (verificationStatus === \"pending\" || (verificationStatus as string) === \"pending_review\") ? (\n                    <span className=\"inline-flex items-center gap-1 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded-full border border-amber-300\">\n                      <svg className=\"w-3 h-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z\" clipRule=\"evenodd\" />\n                      </svg>\n                      Pending\n                    </span>\n                  ) : (verificationStatus as string) === \"rejected\" ? (\n                    <span className=\"inline-flex items-center gap-1 px-2 py-0.5 bg-red-100 text-red-700 text-xs font-medium rounded-full border border-red-300\">\n                      <svg className=\"w-3 h-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clipRule=\"evenodd\" />\n                      </svg>\n                      Rejected\n                    </span>\n                  ) : (\n                    <span className=\"inline-flex items-center gap-1 px-2 py-0.5 bg-slate-100 text-slate-500 text-xs font-medium rounded-full border border-slate-200\">\n                      Pending\n                    </span>\n                  )}\n                </div>\n              )}\n\n              {/* Job Actions */}\n              <div className=\"pt-4 border-t border-slate-200 space-y-3\">\n                {/* Save as Template Button - Only for non-client users */}\n                {userRole !== \"client\" && (\n                  <SaveAsTemplateButton job={job} />\n                )}\n                {/* Duplicate Job Button - Only for non-client users */}\n                {userRole !== \"client\" && (\n                  <DuplicateJobButton jobId={job.id} />\n                )}\n                <DeleteJobButton jobId={job.id} />\n                <div>\n                  <FeedbackButton jobId={job.id} variant=\"compact\" />\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Main Content - AI Job Pack or Client View */}\n        <div className=\"lg:col-span-2\">\n          {/* Client View - Simplified job posting view */}\n          {userRole === \"client\" ? (\n            <div className=\"space-y-6\">\n              {/* Job Details Card */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8\">\n                <h2 className=\"text-2xl font-semibold text-slate-900 mb-6\">Your Job Posting</h2>\n                <div className=\"space-y-6\">\n                  <div>\n                    <h3 className=\"text-lg font-medium text-slate-900 mb-4\">Job Details</h3>\n                    <div className=\"space-y-3\">\n                      <div>\n                        <p className=\"text-sm text-slate-500 mb-1\">Title</p>\n                        <p className=\"text-slate-900 font-medium\">{job.title}</p>\n                      </div>\n                      {job.address && (\n                        <div>\n                          <p className=\"text-sm text-slate-500 mb-1\">Location</p>\n                          <p className=\"text-slate-900 font-medium\">{job.address}</p>\n                        </div>\n                      )}\n                      <div>\n                        <p className=\"text-sm text-slate-500 mb-1\">Trade Type</p>\n                        <p className=\"text-slate-900 font-medium\">{job.tradeType}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-slate-500 mb-1\">Property Type</p>\n                        <p className=\"text-slate-900 font-medium\">{job.propertyType}</p>\n                      </div>\n                      {job.notes && (\n                        <div>\n                          <p className=\"text-sm text-slate-500 mb-1\">Description</p>\n                          <p className=\"text-slate-700 whitespace-pre-wrap\">{job.notes}</p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Scheduled Date/Time - Read-only for clients */}\n                  {(job.scheduledStartAt || job.scheduledEndAt) && (\n                    <div className=\"pt-6 border-t border-slate-200\">\n                      <h3 className=\"text-lg font-medium text-slate-900 mb-4\">Scheduled Date & Time</h3>\n                      <div className=\"space-y-3\">\n                        {job.scheduledStartAt && (\n                          <div>\n                            <p className=\"text-sm text-slate-500 mb-1\">Start</p>\n                            <p className=\"text-slate-900 font-medium\">{formatDateTimeForDisplay(job.scheduledStartAt)}</p>\n                          </div>\n                        )}\n                        {job.scheduledEndAt && (\n                          <div>\n                            <p className=\"text-sm text-slate-500 mb-1\">End</p>\n                            <p className=\"text-slate-900 font-medium\">{formatDateTimeForDisplay(job.scheduledEndAt)}</p>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  <div className=\"pt-6 border-t border-slate-200\">\n                    <h3 className=\"text-lg font-medium text-slate-900 mb-4\">Status</h3>\n                    <div className=\"flex items-center gap-2\">\n                      <JobWorkflowStatusBadge status={job.jobStatus || \"pending\"} />\n                      {job.jobStatus === \"pending\" && (\n                        <p className=\"text-sm text-slate-600\">Your job posting is awaiting tradie responses.</p>\n                      )}\n                      {job.jobStatus === \"booked\" && (\n                        <p className=\"text-sm text-slate-600\">A tradie has been assigned to this job.</p>\n                      )}\n                      {job.jobStatus === \"completed\" && (\n                        <p className=\"text-sm text-slate-600\">This job has been completed.</p>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Quote Review & Signing (only show if AI pack exists) */}\n              {(job.status === \"ai_complete\" || job.status === \"pending_regeneration\") && (\n                <ClientQuoteReview\n                  jobId={job.id}\n                  jobTitle={job.title}\n                  address={job.address}\n                  aiSummary={job.aiSummary}\n                  aiQuote={job.aiQuote}\n                  aiScopeOfWork={job.aiScopeOfWork}\n                  aiInclusions={job.aiInclusions}\n                  aiExclusions={job.aiExclusions}\n                  aiClientNotes={job.aiClientNotes}\n                  clientStatus={job.clientStatus}\n                  clientAcceptedAt={job.clientAcceptedAt}\n                  clientDeclinedAt={job.clientDeclinedAt}\n                  clientSignedName={job.clientSignedName}\n                  clientSignedEmail={job.clientSignedEmail}\n                  userEmail={user.email}\n                  tradieVerificationStatus={tradieVerificationStatus}\n                />\n              )}\n            </div>\n          ) : (\n            <>\n              {/* Trade/Business View - Full AI Job Pack */}\n              {/* SWMS UI START ÔÇô job detail page */}\n              {(job.status === \"ai_pending\" || job.status === \"generating\") && (\n            <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8 text-center\">\n              <div className=\"w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <svg className=\"w-10 h-10 text-amber-500 animate-pulse\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\n                </svg>\n              </div>\n              <h3 className=\"text-xl font-semibold text-slate-900 mb-2\">\n                {job.status === \"generating\" ? \"Regenerating Job Pack\" : \"Generating Job Pack\"}\n              </h3>\n              <p className=\"text-slate-600\">\n                Our AI is creating your professional quote, scope of work, and materials list.\n                This usually takes 10-20 seconds.\n              </p>\n            </div>\n          )}\n\n          {job.status === \"ai_failed\" && (\n            <div className=\"bg-white rounded-xl border border-red-200 shadow-sm p-8 text-center\">\n              <div className=\"w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <svg className=\"w-10 h-10 text-red-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n              </div>\n              <h3 className=\"text-xl font-semibold text-slate-900 mb-2\">Generation Failed</h3>\n              <p className=\"text-slate-600 mb-6\">\n                We couldn&apos;t generate the AI job pack. This might be a temporary issue.\n              </p>\n              <RegenerateButton jobId={job.id} status={job.status} />\n            </div>\n          )}\n\n          {(job.status === \"ai_complete\" || job.status === \"pending_regeneration\") && (\n            <>\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\n                {/* Pending regeneration notice */}\n                {job.status === \"pending_regeneration\" && (\n                  <div className=\"px-6 py-3 bg-orange-50 border-b border-orange-200 flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <svg className=\"w-5 h-5 text-orange-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                      </svg>\n                      <span className=\"text-sm text-orange-700 font-medium\">\n                        Job details changed ÔÇô regenerate to update the AI job pack.\n                      </span>\n                    </div>\n                  </div>\n                )}\n                <div className=\"px-6 py-4 border-b border-slate-200\">\n                  <div className=\"flex flex-wrap items-center justify-between gap-4 mb-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <h2 className=\"text-lg font-semibold text-slate-900\">Job Pack</h2>\n                      <OvisBadge variant=\"inline\" size=\"sm\" />\n                    </div>\n                  </div>\n                  \n                  {/* Consolidated Action Buttons */}\n                  <div className=\"space-y-4\">\n                    {/* Primary Actions Row */}\n                    <div className=\"flex flex-wrap items-center gap-2\">\n                      <DuplicateJobButton jobId={job.id} />\n                      {job.aiReviewStatus !== \"confirmed\" && job.clientStatus !== \"accepted\" && (\n                        <RegenerateButton \n                          jobId={job.id} \n                          status={job.status} \n                          aiReviewStatus={job.aiReviewStatus}\n                          clientStatus={job.clientStatus}\n                        />\n                      )}\n                      <CopyForClientButton\n                        title={job.title}\n                        address={job.address}\n                        summary={job.aiSummary}\n                        scopeOfWork={job.aiScopeOfWork}\n                        inclusions={job.aiInclusions}\n                        exclusions={job.aiExclusions}\n                        quoteJson={job.aiQuote}\n                      />\n                    </div>\n\n                    {/* Client Communication Row */}\n                    <div className=\"flex flex-wrap items-center gap-2\">\n                      <EmailToClientButton\n                        title={job.title}\n                        clientEmail={job.clientEmail}\n                        clientName={job.clientName}\n                        address={job.address}\n                        summary={job.aiSummary}\n                        scopeOfWork={job.aiScopeOfWork}\n                        inclusions={job.aiInclusions}\n                        exclusions={job.aiExclusions}\n                        quoteJson={job.aiQuote}\n                        verificationStatus={user.verificationStatus || \"unverified\"}\n                        planTier={planTier}\n                      />\n                      <SendToClientButton\n                        jobId={job.id}\n                        jobTitle={job.title}\n                        clientEmail={job.clientEmail}\n                        clientName={job.clientName}\n                        sentToClientAt={job.sentToClientAt}\n                        verificationStatus={user.verificationStatus || \"unverified\"}\n                        planTier={planTier}\n                      />\n                      {(!job.clientStatus || job.clientStatus === \"draft\") && (\n                        <span className=\"text-xs text-slate-500 flex items-center gap-1\">\n                          <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                          </svg>\n                          Once emailed, job moves to &ldquo;Sent&rdquo; status\n                        </span>\n                      )}\n                    </div>\n\n                    {/* Export & Documents Row */}\n                    <div className=\"flex flex-wrap items-center gap-2\">\n                      <JobPackPdfButton\n                        jobId={job.id}\n                        jobTitle={job.title}\n                        jobCreatedAt={job.createdAt}\n                        tradeType={job.tradeType}\n                        propertyType={job.propertyType}\n                        address={job.address}\n                        clientName={job.clientName}\n                        notes={job.notes}\n                        aiSummary={job.aiSummary}\n                        aiQuote={job.aiQuote}\n                        aiScopeOfWork={job.aiScopeOfWork}\n                        aiInclusions={job.aiInclusions}\n                        aiExclusions={job.aiExclusions}\n                        aiMaterials={job.aiMaterials}\n                        aiClientNotes={job.aiClientNotes}\n                        materialsOverrideText={job.materialsOverrideText}\n                        materialsAreRoughEstimate={job.materialsAreRoughEstimate}\n                        materialsTotal={job.materialsTotal ?? null}\n                        clientSignatureId={job.clientSignatureId}\n                        clientSignedName={job.clientSignedName}\n                        clientSignedEmail={job.clientSignedEmail}\n                        clientAcceptedAt={job.clientAcceptedAt}\n                        clientAcceptedByName={job.clientAcceptedByName}\n                        clientAcceptanceNote={job.clientAcceptanceNote}\n                        clientAcceptedQuoteVer={job.clientAcceptedQuoteVer}\n                        quoteNumber={job.quoteNumber}\n                        businessProfile={businessProfile}\n                      />\n                      <SpecDocButton \n                        jobId={job.id}\n                        hasScopeOfWork={!!job.aiScopeOfWork}\n                        user={user}\n                        planTier={planTier}\n                        planStatus={planStatus}\n                      />\n                    </div>\n\n                    {/* Status Messages */}\n                    {(job.aiReviewStatus === \"confirmed\" || job.clientStatus === \"accepted\") && (\n                      <div className=\"text-xs text-slate-600 bg-blue-50 px-3 py-2 rounded-lg border border-blue-200\">\n                        <p className=\"font-medium mb-1\">\n                          {job.clientStatus === \"accepted\" \n                            ? \"Ô£ô Quote signed by client\" \n                            : \"Ô£ô Job pack confirmed\"}\n                        </p>\n                        <p className=\"text-slate-600\">\n                          {job.clientStatus === \"accepted\"\n                            ? \"This pack has been signed. Create a variation for changes.\"\n                            : \"Manual adjustments allowed. For major changes, duplicate this job.\"}\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                  {/* Client Signature Status */}\n                  <div className=\"mt-3\">\n                    <ClientSignatureStatus\n                      jobId={job.id}\n                      docType=\"QUOTE\"\n                      docKey={null}\n                      label=\"quote\"\n                    />\n                  </div>\n                </div>\n                {/* Free Plan Warning Banner - Show for free users */}\n                {userIsFreePlan && (userRole as string) !== \"client\" && (\n                  <div className=\"px-6 pt-6\">\n                    <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n                      <div className=\"flex items-start gap-3\">\n                        <svg className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                        </svg>\n                        <div className=\"flex-1\">\n                          <p className=\"text-sm font-medium text-amber-900 mb-1\">\n                            Free Plan Limitations\n                          </p>\n                          <p className=\"text-sm text-amber-800\">\n                            You can generate job packs for free, but a paid membership is required to save client details and send job packs to clients. Upgrade your plan to unlock these features.\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n                {/* Client Details Entry - Show if AI complete but no client details */}\n                {(!job.clientName || !job.clientEmail) && (\n                  <div className=\"px-6 pt-6\">\n                    <ClientDetailsEntry\n                      jobId={job.id}\n                      currentClientName={job.clientName}\n                      currentClientEmail={job.clientEmail}\n                      planTier={planTier}\n                    />\n                  </div>\n                )}\n                {/* AI Warning Banner */}\n                <div className=\"px-6 pt-6\">\n                  <AIWarningBanner />\n                </div>\n                <div className=\"p-6 space-y-6\">\n                  <SummarySection \n                    content={job.aiSummary}\n                    editButton={\n                      <SectionEditButton\n                        jobId={job.id}\n                        sectionName=\"summary\"\n                        fieldName=\"aiSummary\"\n                        currentValue={job.aiSummary}\n                        label=\"Summary\"\n                        placeholder=\"Enter a brief summary of the job...\"\n                      />\n                    }\n                  />\n                  <PricingSection \n                    content={job.aiQuote} \n                    effectiveRates={job.effectiveRates}\n                    quoteNumber={job.quoteNumber}\n                    quoteVersion={job.quoteVersion}\n                    quoteExpiryAt={job.quoteExpiryAt}\n                    quoteLastSentAt={job.quoteLastSentAt}\n                  />\n                  <ScopeSection \n                    content={job.aiScopeOfWork}\n                    editButton={\n                      <SectionEditButton\n                        jobId={job.id}\n                        sectionName=\"scope\"\n                        fieldName=\"aiScopeOfWork\"\n                        currentValue={job.aiScopeOfWork}\n                        label=\"Scope of Work\"\n                        placeholder=\"Enter the scope of work, one item per line...\"\n                      />\n                    }\n                  />\n                  <ListSection\n                    title=\"Inclusions\"\n                    content={job.aiInclusions}\n                    variant=\"check\"\n                    icon={\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                      </svg>\n                    }\n                    editButton={\n                      <SectionEditButton\n                        jobId={job.id}\n                        sectionName=\"inclusions\"\n                        fieldName=\"aiInclusions\"\n                        currentValue={job.aiInclusions}\n                        label=\"Inclusions\"\n                        placeholder=\"Enter what's included, one item per line...\"\n                      />\n                    }\n                  />\n                  <ListSection\n                    title=\"Exclusions\"\n                    content={job.aiExclusions}\n                    variant=\"x\"\n                    icon={\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                      </svg>\n                    }\n                    editButton={\n                      <SectionEditButton\n                        jobId={job.id}\n                        sectionName=\"exclusions\"\n                        fieldName=\"aiExclusions\"\n                        currentValue={job.aiExclusions}\n                        label=\"Exclusions\"\n                        placeholder=\"Enter what's not included, one item per line...\"\n                      />\n                    }\n                  />\n                  <MaterialsSection \n                    content={job.aiMaterials} \n                    overrideText={job.materialsOverrideText}\n                    showRoughEstimateDisclaimer={job.materialsAreRoughEstimate}\n                    editButton={\n                      <MaterialsEditButton \n                        jobId={job.id} \n                        currentOverrideText={job.materialsOverrideText}\n                        aiMaterials={job.aiMaterials}\n                      />\n                    }\n                  />\n                  <NotesSection \n                    content={job.aiClientNotes}\n                    editButton={\n                      <SectionEditButton\n                        jobId={job.id}\n                        sectionName=\"client-notes\"\n                        fieldName=\"aiClientNotes\"\n                        currentValue={job.aiClientNotes}\n                        label=\"Client Notes\"\n                        placeholder=\"Enter notes for the client (payment terms, timeline, access requirements, etc.)...\"\n                      />\n                    }\n                  />\n                </div>\n              </div>\n\n              {/* Attachments Section - Only for tradie/business users */}\n              <div className=\"mt-6\">\n                <AttachmentsSection jobId={job.id} />\n              </div>\n\n              {/* Client Signature Display (for trade view) */}\n              {job.clientStatus === \"accepted\" && (\n                <div className=\"mt-6\">\n                  <ClientSignatureDisplay\n                    jobId={job.id}\n                    clientSignatureId={job.clientSignatureId}\n                    clientSignedName={job.clientSignedName}\n                    clientSignedEmail={job.clientSignedEmail}\n                    clientAcceptedAt={job.clientAcceptedAt}\n                  />\n                </div>\n              )}\n              \n              {/* Job Documents Section - Replaces SWMS section */}\n              <div className=\"mt-6\">\n                <JobDocumentsSection\n                  jobId={job.id}\n                  jobTitle={job.title}\n                  tradeType={job.tradeType}\n                  address={job.address}\n                  clientName={job.clientName}\n                  clientEmail={job.clientEmail}\n                  showWarning={\n                    job.aiReviewStatus === \"confirmed\" &&\n                    (job.clientStatus === \"sent\" || job.clientStatus === \"accepted\")\n                  }\n                  job={job}\n                  user={user}\n                  planTier={planTier}\n                  planStatus={planStatus}\n                />\n              </div>\n\n              {/* Safety Section - Tradie/Business only */}\n              {(userRole as string) !== \"client\" && (\n                <div className=\"mt-6\">\n                  <SafetySection\n                    jobId={job.id}\n                    jobTitle={job.title}\n                    tradeType={job.tradeType}\n                    address={job.address}\n                    businessName={user.businessDetails?.businessName || user.businessDetails?.tradingName}\n                    businessProfile={businessProfile}\n                  />\n                </div>\n              )}\n\n              {/* Suggested Tradies Panel - Client accounts only, locked until further notice */}\n              {(userRole as string) === \"client\" && featureFlags.showSuggestedTradies && (\n                <div className=\"mt-6\">\n                  <SuggestedTradiesPanel jobId={job.id} />\n                </div>\n              )}\n            </>\n          )}\n\n          {job.status === \"draft\" && (userRole as string) !== \"client\" && (\n            <div className=\"space-y-6\">\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8 text-center\">\n                <div className=\"w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                  <svg className=\"w-10 h-10 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xl font-semibold text-slate-900 mb-2\">Draft Job</h3>\n                <p className=\"text-slate-600\">\n                  This job hasn&apos;t been processed by AI yet.\n                </p>\n              </div>\n              \n              {/* Job Documents Section - Also visible for draft jobs */}\n              <JobDocumentsSection\n                jobId={job.id}\n                jobTitle={job.title}\n                tradeType={job.tradeType}\n                address={job.address}\n                clientName={job.clientName}\n                clientEmail={job.clientEmail}\n                showWarning={false}\n                user={user}\n                planTier={planTier}\n                planStatus={planTier === \"FREE\" ? \"TRIAL\" : \"ACTIVE\"}\n              />\n\n              {/* Safety Section - Tradie/Business only */}\n              <div className=\"mt-6\">\n                <SafetySection\n                  jobId={job.id}\n                  jobTitle={job.title}\n                  tradeType={job.tradeType}\n                  address={job.address}\n                  businessName={user.businessDetails?.businessName || user.businessDetails?.tradingName}\n                  businessProfile={businessProfile}\n                />\n              </div>\n            </div>\n          )}\n\n          {/* Admin Assignment Panel - Show for client jobs that need assignment */}\n          {userIsAdmin && isClientJob && job.assignmentStatus !== \"ASSIGNED\" && (\n            <div className=\"mt-6\">\n              <JobAssignmentPanel\n                jobId={job.id}\n                currentUserId={user.id}\n                assignmentStatus={job.assignmentStatus}\n              />\n            </div>\n          )}\n\n          {/* Client Job Assignment Banner - Show for tradies viewing assigned client jobs */}\n          {!userIsAdmin && (userRole as string) !== \"client\" && job.leadSource === \"CLIENT_PORTAL\" && job.assignedAt && (\n            <div className=\"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl\">\n              <p className=\"text-sm text-blue-800\">\n                <strong>Client Job:</strong> This job was posted by a client and assigned to you on{\" \"}\n                {formatDateTimeForDisplay(job.assignedAt)}.\n              </p>\n            </div>\n          )}\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\spec-doc\\PrintButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\spec-doc\\SpecDocExportButtons.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\[id]\\spec-doc\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\new\\RateTemplateSelector.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'handleTemplateSelect' and 'selectedTemplateId'. Either include them or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [templates, tradeType, propertyType, selectedTemplateId, handleTemplateSelect]","fix":{"range":[1819,1855],"text":"[templates, tradeType, propertyType, selectedTemplateId, handleTemplateSelect]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\n\r\ninterface RateTemplate {\r\n  id: string;\r\n  name: string;\r\n  tradeType: string | null;\r\n  propertyType: string | null;\r\n  hourlyRate: number | null;\r\n  helperHourlyRate: number | null;\r\n  dayRate: number | null;\r\n  calloutFee: number | null;\r\n  minCharge: number | null;\r\n  ratePerM2Interior: number | null;\r\n  ratePerM2Exterior: number | null;\r\n  ratePerLmTrim: number | null;\r\n  materialMarkupPercent: number | null;\r\n  isDefault: boolean;\r\n}\r\n\r\ninterface RateTemplateSelectorProps {\r\n  selectedTemplateId: string | null;\r\n  onTemplateSelect: (templateId: string | null) => void;\r\n  tradeType: string;\r\n  propertyType: string;\r\n  onRatesChange?: (rates: {\r\n    labourRatePerHour: number | null;\r\n    helperRatePerHour: number | null;\r\n  }) => void;\r\n}\r\n\r\nexport default function RateTemplateSelector({\r\n  selectedTemplateId,\r\n  onTemplateSelect,\r\n  tradeType,\r\n  propertyType,\r\n  onRatesChange,\r\n}: RateTemplateSelectorProps) {\r\n  const [templates, setTemplates] = useState<RateTemplate[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    fetchTemplates();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    // Auto-select default template if none selected\r\n    if (!selectedTemplateId && templates.length > 0) {\r\n      const defaultTemplate = templates.find((t) => t.isDefault);\r\n      if (defaultTemplate) {\r\n        // Check if template matches trade/property type constraints\r\n        const matchesTrade = !defaultTemplate.tradeType || defaultTemplate.tradeType === tradeType;\r\n        const matchesProperty = !defaultTemplate.propertyType || defaultTemplate.propertyType === propertyType;\r\n        if (matchesTrade && matchesProperty) {\r\n          handleTemplateSelect(defaultTemplate.id);\r\n        }\r\n      }\r\n    }\r\n  }, [templates, tradeType, propertyType]);\r\n\r\n  useEffect(() => {\r\n    // When template changes, update rates\r\n    if (selectedTemplateId && onRatesChange) {\r\n      const template = templates.find((t) => t.id === selectedTemplateId);\r\n      if (template) {\r\n        onRatesChange({\r\n          labourRatePerHour: template.hourlyRate,\r\n          helperRatePerHour: template.helperHourlyRate,\r\n        });\r\n      }\r\n    }\r\n  }, [selectedTemplateId, templates, onRatesChange]);\r\n\r\n  const fetchTemplates = async () => {\r\n    try {\r\n      setIsLoading(true);\r\n      const response = await fetch(\"/api/rate-templates\");\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setTemplates(data.templates || []);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to fetch rate templates:\", error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleTemplateSelect = (templateId: string | null) => {\r\n    onTemplateSelect(templateId);\r\n    if (templateId && onRatesChange) {\r\n      const template = templates.find((t) => t.id === templateId);\r\n      if (template) {\r\n        onRatesChange({\r\n          labourRatePerHour: template.hourlyRate,\r\n          helperRatePerHour: template.helperHourlyRate,\r\n        });\r\n      }\r\n    } else if (!templateId && onRatesChange) {\r\n      // Clear rates when \"No template\" is selected\r\n      onRatesChange({\r\n        labourRatePerHour: null,\r\n        helperRatePerHour: null,\r\n      });\r\n    }\r\n  };\r\n\r\n  // Filter templates that match current trade/property type\r\n  const matchingTemplates = templates.filter((t) => {\r\n    const matchesTrade = !t.tradeType || t.tradeType === tradeType;\r\n    const matchesProperty = !t.propertyType || t.propertyType === propertyType;\r\n    return matchesTrade && matchesProperty;\r\n  });\r\n\r\n  // Show all templates if no matches, but mark them\r\n  const displayTemplates = matchingTemplates.length > 0 ? matchingTemplates : templates;\r\n\r\n  if (isLoading) {\r\n    return null;\r\n  }\r\n\r\n  if (templates.length === 0) {\r\n    return (\r\n      <div className=\"mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg\">\r\n        <p className=\"text-xs text-slate-600\">\r\n          No rate templates yet. <a href=\"/settings/rates\" className=\"text-amber-600 hover:text-amber-700 underline\">Create one</a> to quickly apply consistent rates.\r\n        </p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"mb-4\">\r\n      <label className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n        Rate Template <span className=\"text-slate-400 font-normal\">(optional)</span>\r\n      </label>\r\n      <select\r\n        value={selectedTemplateId || \"\"}\r\n        onChange={(e) => handleTemplateSelect(e.target.value || null)}\r\n        className=\"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white text-sm\"\r\n      >\r\n        <option value=\"\">No template (use business defaults)</option>\r\n        {displayTemplates.map((template) => {\r\n          const isMatching = matchingTemplates.includes(template);\r\n          const label = `${template.name}${template.isDefault ? \" (Default)\" : \"\"}${!isMatching ? \" (may not match trade/property type)\" : \"\"}`;\r\n          return (\r\n            <option key={template.id} value={template.id}>\r\n              {label}\r\n            </option>\r\n          );\r\n        })}\r\n      </select>\r\n      {selectedTemplateId && (\r\n        <p className=\"mt-1 text-xs text-slate-500\">\r\n          Rates from template will be pre-filled. You can adjust them below.\r\n        </p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\new\\TemplateSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Bookmark' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":4,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":30},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'templates.length'. Either include it or remove the dependency array.","line":32,"column":6,"nodeType":"ArrayExpression","endLine":32,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, templates.length]","fix":{"range":[917,925],"text":"[isOpen, templates.length]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1279,1282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1279,1282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Bookmark, Loader2, X, ChevronDown } from \"lucide-react\";\r\n\r\ninterface JobTemplate {\r\n  id: string;\r\n  title: string;\r\n  tradeType: string;\r\n  propertyType: string;\r\n  notes: string | null;\r\n  addressLine1: string | null;\r\n  suburb: string | null;\r\n  postcode: string | null;\r\n}\r\n\r\ninterface TemplateSelectorProps {\r\n  onSelectTemplate: (template: JobTemplate | null) => void;\r\n  selectedTemplateId: string | null;\r\n}\r\n\r\nexport default function TemplateSelector({ onSelectTemplate, selectedTemplateId }: TemplateSelectorProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [templates, setTemplates] = useState<JobTemplate[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    if (isOpen && templates.length === 0) {\r\n      fetchTemplates();\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const fetchTemplates = async () => {\r\n    setIsLoading(true);\r\n    setError(\"\");\r\n    try {\r\n      const response = await fetch(\"/api/job-templates\");\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to load templates\");\r\n      }\r\n      const data = await response.json();\r\n      setTemplates(data.templates || []);\r\n    } catch (err: any) {\r\n      setError(err.message || \"Failed to load templates\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSelectTemplate = (template: JobTemplate | null) => {\r\n    onSelectTemplate(template);\r\n    setIsOpen(false);\r\n  };\r\n\r\n  const selectedTemplate = templates.find((t) => t.id === selectedTemplateId);\r\n\r\n  return (\r\n    <div className=\"mb-6\">\r\n      <div className=\"flex items-center gap-3\">\r\n        <label className=\"text-sm font-medium text-slate-700\">Start from:</label>\r\n        <div className=\"relative flex-1 max-w-md\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setIsOpen(!isOpen)}\r\n            className=\"w-full flex items-center justify-between px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm\"\r\n          >\r\n            <span className={selectedTemplate ? \"text-slate-900\" : \"text-slate-500\"}>\r\n              {selectedTemplate ? selectedTemplate.title : \"Start from scratch\"}\r\n            </span>\r\n            <ChevronDown className={`w-4 h-4 text-slate-400 transition-transform ${isOpen ? \"rotate-180\" : \"\"}`} />\r\n          </button>\r\n\r\n          {isOpen && (\r\n            <>\r\n              <div\r\n                className=\"fixed inset-0 z-40\"\r\n                onClick={() => setIsOpen(false)}\r\n              />\r\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-slate-300 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto\">\r\n                <div className=\"p-2\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => handleSelectTemplate(null)}\r\n                    className=\"w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 rounded-lg transition-colors\"\r\n                  >\r\n                    Start from scratch\r\n                  </button>\r\n                  {isLoading && (\r\n                    <div className=\"p-4 text-center\">\r\n                      <Loader2 className=\"w-5 h-5 animate-spin text-amber-500 mx-auto\" />\r\n                    </div>\r\n                  )}\r\n                  {error && (\r\n                    <div className=\"p-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg\">\r\n                      {error}\r\n                    </div>\r\n                  )}\r\n                  {!isLoading && !error && templates.length === 0 && (\r\n                    <div className=\"p-4 text-center text-sm text-slate-500\">\r\n                      No templates yet. Save a job as a template to reuse it.\r\n                    </div>\r\n                  )}\r\n                  {!isLoading && !error && templates.map((template) => (\r\n                    <button\r\n                      key={template.id}\r\n                      type=\"button\"\r\n                      onClick={() => handleSelectTemplate(template)}\r\n                      className=\"w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 rounded-lg transition-colors border-b border-slate-100 last:border-0\"\r\n                    >\r\n                      <div className=\"font-medium text-slate-900\">{template.title}</div>\r\n                      <div className=\"text-xs text-slate-500 mt-0.5\">\r\n                        {template.tradeType} ÔÇó {template.propertyType}\r\n                        {template.notes && (\r\n                          <span className=\"block mt-1 line-clamp-1\">{template.notes.substring(0, 60)}...</span>\r\n                        )}\r\n                      </div>\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\new\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'businessProfile' is assigned a value but never used.","line":64,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":64,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'emailError' is assigned a value but never used.","line":70,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'formData.labourRatePerHour'. Either include it or remove the dependency array.","line":135,"column":6,"nodeType":"ArrayExpression","endLine":135,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [formData.labourRatePerHour, router]","fix":{"range":[4846,4854],"text":"[formData.labourRatePerHour, router]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":237,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8394,8397],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8394,8397],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport TemplateSelector from \"./TemplateSelector\";\r\nimport OvisBadge from \"@/app/components/OvisBadge\";\r\n\r\ntype TradeType = \"Painter\" | \"Plasterer\" | \"Carpenter\" | \"Electrician\" | \"Other\";\r\ntype UserRole = \"tradie\" | \"builder\" | \"client\" | \"supplier\" | \"admin\";\r\n\r\ninterface Helper {\r\n  id: string;\r\n  name: string;\r\n  ratePerHour: string;\r\n}\r\n\r\ninterface FormData {\r\n  clientName: string;\r\n  clientEmail: string;\r\n  title: string;\r\n  tradeType: TradeType;\r\n  propertyType: string;\r\n  address: string;\r\n  notes: string;\r\n  labourRatePerHour: string;\r\n  helperRatePerHour: string; // Legacy - kept for backwards compatibility\r\n  helpers: Helper[]; // New: array of helpers\r\n  materialsAreRoughEstimate: boolean;\r\n  rateTemplateId: string | null;\r\n}\r\n\r\ninterface JobTemplate {\r\n  id: string;\r\n  title: string;\r\n  tradeType: string;\r\n  propertyType: string;\r\n  notes: string | null;\r\n  addressLine1: string | null;\r\n  suburb: string | null;\r\n  postcode: string | null;\r\n}\r\n\r\nexport default function NewJobPage() {\r\n  const router = useRouter();\r\n  const [userRole, setUserRole] = useState<UserRole | null>(null);\r\n  const [planTier, setPlanTier] = useState<string>(\"FREE\");\r\n  const [isLoadingUser, setIsLoadingUser] = useState(true);\r\n  const [selectedTemplate, setSelectedTemplate] = useState<JobTemplate | null>(null);\r\n  const [formData, setFormData] = useState<FormData>({\r\n    clientName: \"\",\r\n    clientEmail: \"\",\r\n    title: \"\",\r\n    tradeType: \"Painter\",\r\n    propertyType: \"\",\r\n    address: \"\",\r\n    notes: \"\",\r\n    labourRatePerHour: \"\",\r\n    helperRatePerHour: \"\", // Legacy\r\n    helpers: [], // New: array of helpers\r\n    materialsAreRoughEstimate: false,\r\n    rateTemplateId: null,\r\n  });\r\n  const [businessProfile, setBusinessProfile] = useState<{\r\n    primaryTrade: string | null;\r\n    hourlyRate: number | null;\r\n  } | null>(null);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [emailError, setEmailError] = useState(\"\");\r\n\r\n  // Fetch user role, plan info, and business profile on mount\r\n  useEffect(() => {\r\n    async function fetchUserData() {\r\n      try {\r\n        const response = await fetch(\"/api/auth/me\", { cache: \"no-store\" });\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          if (data.user) {\r\n            setUserRole(data.user.role || \"tradie\");\r\n            // Get plan tier from user data\r\n            if (data.user.planTier) {\r\n              setPlanTier(data.user.planTier);\r\n            }\r\n            \r\n            // Fetch business profile for tradies to auto-fill trade type and rates\r\n            if (data.user.role !== \"client\") {\r\n              try {\r\n                const profileResponse = await fetch(\"/api/settings/business-profile\", { cache: \"no-store\" });\r\n                if (profileResponse.ok) {\r\n                  const profileData = await profileResponse.json();\r\n                  if (profileData.businessProfile) {\r\n                    setBusinessProfile({\r\n                      primaryTrade: profileData.businessProfile.primaryTrade,\r\n                      hourlyRate: profileData.businessProfile.hourlyRate,\r\n                    });\r\n                    \r\n                    // Auto-fill trade type if available\r\n                    if (profileData.businessProfile.primaryTrade) {\r\n                      const validTradeTypes: TradeType[] = [\"Painter\", \"Plasterer\", \"Carpenter\", \"Electrician\", \"Other\"];\r\n                      if (validTradeTypes.includes(profileData.businessProfile.primaryTrade as TradeType)) {\r\n                        setFormData((prev) => ({\r\n                          ...prev,\r\n                          tradeType: profileData.businessProfile.primaryTrade as TradeType,\r\n                        }));\r\n                      }\r\n                    }\r\n                    \r\n                    // Auto-fill hourly rate if available and not already set\r\n                    if (profileData.businessProfile.hourlyRate && !formData.labourRatePerHour) {\r\n                      setFormData((prev) => ({\r\n                        ...prev,\r\n                        labourRatePerHour: profileData.businessProfile.hourlyRate.toString(),\r\n                      }));\r\n                    }\r\n                  }\r\n                }\r\n              } catch (error) {\r\n                console.warn(\"Failed to fetch business profile:\", error);\r\n              }\r\n            }\r\n          } else {\r\n            router.push(\"/login\");\r\n          }\r\n        } else {\r\n          router.push(\"/login\");\r\n        }\r\n      } catch {\r\n        router.push(\"/login\");\r\n      } finally {\r\n        setIsLoadingUser(false);\r\n      }\r\n    }\r\n    fetchUserData();\r\n  }, [router]);\r\n\r\n  const isClient = userRole === \"client\";\r\n\r\n  const validateEmail = (email: string) => {\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    return emailRegex.test(email);\r\n  };\r\n\r\n  const handleChange = (\r\n    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>\r\n  ) => {\r\n    const { name, value, type } = e.target;\r\n    const checked = (e.target as HTMLInputElement).checked;\r\n    \r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      [name]: type === \"checkbox\" ? checked : value,\r\n    }));\r\n    \r\n    // Clear email error when user types\r\n    if (name === \"clientEmail\") {\r\n      setEmailError(\"\");\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setEmailError(\"\");\r\n\r\n    // Validate email before submission\r\n    if (formData.clientEmail && !validateEmail(formData.clientEmail)) {\r\n      setEmailError(\"Please enter a valid email address\");\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // Prepare data for submission\r\n      // Remove client details - they will be entered manually after AI generation\r\n      // Convert helpers array to the format expected by the API\r\n      const helpers = formData.helpers\r\n        .filter(h => h.ratePerHour && Number(h.ratePerHour) > 0)\r\n        .map(h => ({\r\n          id: h.id,\r\n          name: h.name.trim() || undefined,\r\n          ratePerHour: Number(h.ratePerHour),\r\n        }));\r\n\r\n      const submitData = {\r\n        title: formData.title,\r\n        tradeType: formData.tradeType,\r\n        propertyType: formData.propertyType,\r\n        address: formData.address,\r\n        notes: formData.notes,\r\n        labourRatePerHour: formData.labourRatePerHour ? Number(formData.labourRatePerHour) : null,\r\n        helperRatePerHour: formData.helperRatePerHour ? Number(formData.helperRatePerHour) : null, // Legacy\r\n        helpers: helpers.length > 0 ? helpers : undefined, // New: array of helpers\r\n        materialsAreRoughEstimate: formData.materialsAreRoughEstimate,\r\n        rateTemplateId: formData.rateTemplateId,\r\n        // Explicitly exclude clientName and clientEmail for privacy\r\n      };\r\n\r\n      const response = await fetch(\"/api/jobs\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(submitData),\r\n      });\r\n\r\n      let data;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"[jobs] failed to parse response:\", parseError);\r\n        setError(\"Failed to create job: Invalid response from server. Please try again.\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      if (!response.ok) {\r\n        const errorMsg = data?.error || \"Failed to create job\";\r\n        console.error(\"[jobs] error creating job:\", errorMsg, data);\r\n        setError(errorMsg);\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      // Validate response has job with id\r\n      if (!data?.job || !data.job.id) {\r\n        console.error(\"[jobs] invalid response from job creation API:\", data);\r\n        setError(\"Failed to create job: Invalid response from server. Please try again.\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      console.log(`[jobs] successfully created job ${data.job.id}, redirecting`);\r\n      \r\n      // Success - redirect to the job detail page\r\n      // Keep isLoading true to prevent double submission during navigation\r\n      router.push(`/jobs/${data.job.id}`);\r\n    } catch (err: any) {\r\n      console.error(\"[jobs] unexpected error creating job:\", err);\r\n      const errorMessage = err?.message || \"An unexpected error occurred. Please try again.\";\r\n      setError(errorMessage);\r\n      setIsLoading(false);\r\n      // Don't redirect on error - let user see the error message\r\n    }\r\n  };\r\n\r\n  if (isLoadingUser) {\r\n    return (\r\n      <div className=\"max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        <div className=\"text-center py-12\">\r\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-amber-500\"></div>\r\n          <p className=\"mt-4 text-slate-500\">Loading...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <Link\r\n          href=\"/jobs\"\r\n          className=\"inline-flex items-center text-sm text-slate-500 hover:text-slate-700 mb-4\"\r\n        >\r\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n          </svg>\r\n          Back to Jobs\r\n        </Link>\r\n        <h1 className=\"text-3xl font-bold text-slate-900\">\r\n          {isClient ? \"Post a Job\" : \"Create Job Pack\"}\r\n        </h1>\r\n        <p className=\"mt-2 text-slate-600\">\r\n          {isClient \r\n            ? \"Post your job requirements and let tradies find you. No quote generation needed.\"\r\n            : \"Create a new job pack for your client.\"}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Form */}\r\n      <form onSubmit={handleSubmit}>\r\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n          <div className=\"p-6 sm:p-8\">\r\n            <div className=\"space-y-6\">\r\n              {/* Template Selector - Only for tradie/business users */}\r\n              {!isClient && (\r\n                <TemplateSelector\r\n                  onSelectTemplate={setSelectedTemplate}\r\n                  selectedTemplateId={selectedTemplate?.id || null}\r\n                />\r\n              )}\r\n\r\n              {/* Error Message */}\r\n              {error && (\r\n                <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n                  <p className=\"text-red-700 text-sm\">{error}</p>\r\n                </div>\r\n              )}\r\n\r\n              {/* Info Notice - Client details entered after AI generation */}\r\n              {!isClient && (\r\n                <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <svg className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                    </svg>\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-amber-900 mb-1\">\r\n                        Client Privacy & Safety First\r\n                      </p>\r\n                      <p className=\"text-sm text-amber-800\">\r\n                        Client details are kept private and will be entered manually after job pack generation. You can review everything before sending.\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Free Plan Warning Banner */}\r\n              {!isClient && planTier === \"FREE\" && (\r\n                <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-lg\">\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <svg className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\r\n                    </svg>\r\n                    <div>\r\n                      <p className=\"text-sm font-medium text-amber-900 mb-1\">\r\n                        Free Plan Limitations\r\n                      </p>\r\n                      <p className=\"text-sm text-amber-800\">\r\n                        You can generate job packs for free, but a paid membership is required to save client details and send job packs to clients. Upgrade your plan to unlock these features.\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Project Details Section */}\r\n              <div className=\"pt-6 border-t border-slate-200\">\r\n                <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Project Details</h2>\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label htmlFor=\"title\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                      Job name <span className=\"text-red-500\">*</span>\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      id=\"title\"\r\n                      name=\"title\"\r\n                      value={formData.title}\r\n                      onChange={handleChange}\r\n                      placeholder=\"e.g. 3x2 repaint ÔÇô Baldivis\"\r\n                      className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n                      required\r\n                      disabled={isLoading}\r\n                    />\r\n                  </div>\r\n\r\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <div>\r\n                      <label htmlFor=\"tradeType\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                        Trade Type\r\n                      </label>\r\n                      <select\r\n                        id=\"tradeType\"\r\n                        name=\"tradeType\"\r\n                        value={formData.tradeType}\r\n                        onChange={handleChange}\r\n                        className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors bg-white\"\r\n                        disabled={isLoading}\r\n                      >\r\n                        <option value=\"Painter\">Painter</option>\r\n                        <option value=\"Plasterer\">Plasterer</option>\r\n                        <option value=\"Carpenter\">Carpenter</option>\r\n                        <option value=\"Electrician\">Electrician</option>\r\n                        <option value=\"Other\">Other</option>\r\n                      </select>\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label htmlFor=\"propertyType\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                        Type of work <span className=\"text-red-500\">*</span>\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        id=\"propertyType\"\r\n                        name=\"propertyType\"\r\n                        value={formData.propertyType}\r\n                        onChange={handleChange}\r\n                        placeholder=\"e.g. Single-storey house\"\r\n                        className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n                        required\r\n                        disabled={isLoading}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label htmlFor=\"address\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                      Property address <span className=\"text-slate-400\">(optional)</span>\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      id=\"address\"\r\n                      name=\"address\"\r\n                      value={formData.address}\r\n                      onChange={handleChange}\r\n                      placeholder=\"e.g. 123 Main St, Baldivis WA 6171\"\r\n                      className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n                      disabled={isLoading}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Job Details Section */}\r\n              <div className=\"pt-6 border-t border-slate-200\">\r\n                <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Job Details</h2>\r\n                <div>\r\n                  <label htmlFor=\"notes\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Notes for the job <span className=\"text-slate-400\">(optional)</span>\r\n                  </label>\r\n                  \r\n                  {/* Privacy Warning - Only show for tradies */}\r\n                  {!isClient && (\r\n                    <div className=\"mb-3 p-3 bg-amber-50 border border-amber-200 rounded-lg\">\r\n                      <div className=\"flex items-start gap-2\">\r\n                        <svg className=\"w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\r\n                        </svg>\r\n                        <div>\r\n                          <p className=\"text-xs font-semibold text-amber-900 mb-1\">\r\n                            Privacy reminder\r\n                          </p>\r\n                          <p className=\"text-xs text-amber-800\">\r\n                            Do not include client names, email addresses, phone numbers, or other personal information in this field. Client details will be entered manually after job pack generation.\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  <textarea\r\n                    id=\"notes\"\r\n                    name=\"notes\"\r\n                    value={formData.notes}\r\n                    onChange={handleChange}\r\n                    rows={6}\r\n                    placeholder=\"Include as much detail as possible:&#10;ÔÇó Room list and sizes&#10;ÔÇó Current condition of surfaces&#10;ÔÇó Any prep work needed&#10;ÔÇó Specific colours or products&#10;ÔÇó Access considerations&#10;ÔÇó Timeline requirements\"\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors resize-none\"\r\n                    disabled={isLoading}\r\n                  />\r\n                  <div className=\"mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200\">\r\n                    <p className=\"text-xs font-medium text-slate-600 mb-2\">­ƒÆí Example descriptions:</p>\r\n                    <ul className=\"text-xs text-slate-500 space-y-1\">\r\n                      <li>ÔÇó &quot;1x bedroom 3x3m, walls currently off-white, light prep needed&quot;</li>\r\n                      <li>ÔÇó &quot;Ceilings 2.4m high, some cracking, needs patch and sand&quot;</li>\r\n                      <li>ÔÇó &quot;Skirtings and doors semi-gloss, minor scuffs&quot;</li>\r\n                      <li>ÔÇó &quot;Access via front door, no furniture or light furniture&quot;</li>\r\n                    </ul>\r\n                  </div>\r\n                  <p className=\"mt-2 text-sm text-slate-500\">\r\n                    Include any special access or prep notes. The more detail you provide, the better your job pack will be.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Pricing Context Section - Only show for tradies */}\r\n              {!isClient && (\r\n                <div className=\"pt-6 border-t border-slate-200\">\r\n                  <h2 className=\"text-lg font-semibold text-slate-900 mb-1\">Pricing</h2>\r\n                  <p className=\"text-sm text-slate-500 mb-4\">Optional ÔÇô helps generate more accurate quotes</p>\r\n                \r\n                <div className=\"space-y-4\">\r\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                    <div>\r\n                      <label htmlFor=\"labourRatePerHour\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                        Your labour rate per hour (ex GST)\r\n                      </label>\r\n                      <div className=\"relative\">\r\n                        <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-400\">$</span>\r\n                        <input\r\n                          type=\"number\"\r\n                          id=\"labourRatePerHour\"\r\n                          name=\"labourRatePerHour\"\r\n                          value={formData.labourRatePerHour}\r\n                          onChange={handleChange}\r\n                          min=\"0\"\r\n                          step=\"1\"\r\n                          placeholder=\"50\"\r\n                          className=\"w-full pl-8 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\r\n                          disabled={isLoading}\r\n                        />\r\n                      </div>\r\n                      <p className=\"mt-1 text-xs text-slate-500\">\r\n                        If empty, we&apos;ll use your hourly rate from Business Profile settings.\r\n                      </p>\r\n                    </div>\r\n\r\n                  </div>\r\n\r\n                  {/* Multiple Helpers Section */}\r\n                  <div>\r\n                    <div className=\"flex items-center justify-between mb-2\">\r\n                      <label className=\"block text-sm font-medium text-slate-700\">\r\n                        Helpers (optional)\r\n                      </label>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          const newHelper: Helper = {\r\n                            id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n                            name: \"\",\r\n                            ratePerHour: \"\",\r\n                          };\r\n                          setFormData((prev) => ({\r\n                            ...prev,\r\n                            helpers: [...prev.helpers, newHelper],\r\n                          }));\r\n                        }}\r\n                        className=\"text-sm text-purple-600 hover:text-purple-700 font-medium\"\r\n                        disabled={isLoading}\r\n                      >\r\n                        + Add Helper\r\n                      </button>\r\n                    </div>\r\n                    {formData.helpers.length > 0 && (\r\n                      <div className=\"space-y-3\">\r\n                        {formData.helpers.map((helper, index) => (\r\n                          <div key={helper.id} className=\"flex gap-3 items-start p-3 bg-slate-50 rounded-lg border border-slate-200\">\r\n                            <div className=\"flex-1 grid grid-cols-1 sm:grid-cols-2 gap-3\">\r\n                              <div>\r\n                                <label className=\"block text-xs font-medium text-slate-600 mb-1\">\r\n                                  Helper Name/Role (optional)\r\n                                </label>\r\n                                <input\r\n                                  type=\"text\"\r\n                                  value={helper.name}\r\n                                  onChange={(e) => {\r\n                                    const updatedHelpers = [...formData.helpers];\r\n                                    updatedHelpers[index].name = e.target.value;\r\n                                    setFormData((prev) => ({ ...prev, helpers: updatedHelpers }));\r\n                                  }}\r\n                                  placeholder=\"e.g., Second Painter, Apprentice\"\r\n                                  className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors text-sm\"\r\n                                  disabled={isLoading}\r\n                                />\r\n                              </div>\r\n                              <div>\r\n                                <label className=\"block text-xs font-medium text-slate-600 mb-1\">\r\n                                  Rate per Hour (ex GST)\r\n                                </label>\r\n                                <div className=\"relative\">\r\n                                  <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm\">$</span>\r\n                                  <input\r\n                                    type=\"number\"\r\n                                    value={helper.ratePerHour}\r\n                                    onChange={(e) => {\r\n                                      const updatedHelpers = [...formData.helpers];\r\n                                      updatedHelpers[index].ratePerHour = e.target.value;\r\n                                      setFormData((prev) => ({ ...prev, helpers: updatedHelpers }));\r\n                                    }}\r\n                                    min=\"0\"\r\n                                    step=\"1\"\r\n                                    placeholder=\"40\"\r\n                                    className=\"w-full pl-8 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors text-sm\"\r\n                                    disabled={isLoading}\r\n                                  />\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => {\r\n                                const updatedHelpers = formData.helpers.filter((h) => h.id !== helper.id);\r\n                                setFormData((prev) => ({ ...prev, helpers: updatedHelpers }));\r\n                              }}\r\n                              className=\"mt-6 p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors\"\r\n                              disabled={isLoading}\r\n                              title=\"Remove helper\"\r\n                            >\r\n                              <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                              </svg>\r\n                            </button>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    )}\r\n                    {formData.helpers.length === 0 && (\r\n                      <p className=\"text-xs text-slate-500\">\r\n                        Add helpers if you usually work with additional team members. Each helper can have a name/role and hourly rate.\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"materialsAreRoughEstimate\"\r\n                      name=\"materialsAreRoughEstimate\"\r\n                      checked={formData.materialsAreRoughEstimate}\r\n                      onChange={handleChange}\r\n                      className=\"mt-0.5 h-4 w-4 rounded border-slate-300 text-amber-500 focus:ring-amber-500\"\r\n                      disabled={isLoading}\r\n                    />\r\n                    <label htmlFor=\"materialsAreRoughEstimate\" className=\"text-sm text-slate-700\">\r\n                      <span className=\"font-medium\">Treat material prices as rough estimates only</span>\r\n                      <p className=\"text-xs text-slate-500 mt-0.5\">\r\n                        Yes ÔÇô clearly state that material prices are approximate and must be checked against current supplier prices.\r\n                      </p>\r\n                    </label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              )}\r\n\r\n              {/* Submit Section */}\r\n              <div className=\"pt-6 border-t border-slate-200\">\r\n                <div className=\"mb-4 flex items-center justify-center\">\r\n                  <OvisBadge variant=\"card\" size=\"sm\" />\r\n                </div>\r\n                <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                  <p className=\"text-sm text-slate-500\">\r\n                    {isClient \r\n                      ? \"Your job post will be visible to tradies in your area. They can contact you to provide quotes.\"\r\n                      : \"AI will generate a complete job pack including quote, scope, and materials.\"}\r\n                  </p>\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <Link\r\n                      href=\"/jobs\"\r\n                      className=\"px-6 py-3 border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors\"\r\n                    >\r\n                      Cancel\r\n                    </Link>\r\n                    <button\r\n                      type=\"submit\"\r\n                      disabled={isLoading}\r\n                      className=\"px-6 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center\"\r\n                    >\r\n                      {isLoading ? (\r\n                        <>\r\n                          <svg className=\"animate-spin -ml-1 mr-2 h-5 w-5 text-slate-900\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                            <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\r\n                            <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                          </svg>\r\n                          {isClient ? \"Posting Job...\" : \"Generating AI Pack...\"}\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d={isClient ? \"M12 4v16m8-8H4\" : \"M13 10V3L4 14h7v7l9-11h-7z\"} />\r\n                          </svg>\r\n                          {isClient ? \"Post Job\" : \"Generate Job Pack\"}\r\n                        </>\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </form>\r\n\r\n      {/* Loading Overlay */}\r\n      {isLoading && (\r\n        <div className=\"fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50\">\r\n          <div className=\"bg-white rounded-2xl p-8 max-w-sm mx-4 text-center shadow-2xl\">\r\n            <div className=\"w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <svg className=\"w-8 h-8 text-amber-500 animate-pulse\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d={isClient ? \"M12 4v16m8-8H4\" : \"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\"} />\r\n              </svg>\r\n            </div>\r\n            <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">\r\n              {isClient ? \"Posting Your Job\" : \"Generating AI Job Pack\"}\r\n            </h3>\r\n            <p className=\"text-slate-600 text-sm\">\r\n              {isClient \r\n                ? \"Your job post is being created. Tradies in your area will be able to see it and contact you.\"\r\n                : \"Our AI is creating your professional quote, scope of work, and materials list. This usually takes 10-20 seconds.\"}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\jobs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":4,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'resetSuccess' is assigned a value but never used.","line":15,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":175,"column":9,"nodeType":"JSXOpeningElement","endLine":185,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { Suspense, useState, useEffect } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Footer from \"@/app/components/Footer\";\r\n\r\nfunction LoginForm() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [error, setError] = useState(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const resetSuccess = searchParams.get(\"reset\") === \"success\";\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      console.log(\"[login] attempting login for email\", email);\r\n      const response = await fetch(\"/api/auth/login\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ email, password }),\r\n      });\r\n\r\n      let data;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"[login] failed to parse response\", parseError);\r\n        setError(\"An unexpected error occurred. Please try again.\");\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      if (!response.ok) {\r\n        const errorMessage = data?.error || \"Login failed\";\r\n        console.error(\"[login] login failed\", { status: response.status, error: errorMessage });\r\n        // Show user-friendly error messages\r\n        if (response.status === 401 || response.status === 400) {\r\n          setError(\"Incorrect email or password\");\r\n        } else {\r\n          setError(errorMessage);\r\n        }\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      console.log(\"[login] login successful, redirecting\");\r\n      // After successful login, redirect to dashboard\r\n      // Server-side guards on protected pages will handle:\r\n      // - Redirecting clients to /client/dashboard\r\n      // - Redirecting non-onboarded users to /onboarding\r\n      // This avoids client-side checks that can cause flicker\r\n      \r\n      // Validate redirect to prevent open redirect attacks\r\n      const redirectParam = searchParams.get(\"redirect\");\r\n      let redirectTo = \"/dashboard\";\r\n      \r\n      if (redirectParam) {\r\n        // Only allow relative paths starting with / (not // or external URLs)\r\n        const isValidRedirect = \r\n          redirectParam.startsWith(\"/\") && \r\n          !redirectParam.startsWith(\"//\") &&\r\n          !redirectParam.includes(\":\");\r\n        \r\n        if (isValidRedirect) {\r\n          redirectTo = redirectParam;\r\n        }\r\n      }\r\n      \r\n      // Use replace to avoid adding to history, then refresh to update navbar\r\n      router.replace(redirectTo);\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"[login] unexpected error during login\", error);\r\n      setError(\"An unexpected error occurred. Please try again.\");\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl shadow-lg border border-slate-200 p-6 sm:p-8\">\r\n      <div className=\"text-center mb-8\">\r\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Welcome Back</h1>\r\n        <p className=\"text-sm text-slate-600\">Sign in to your OMNEXORA account</p>\r\n      </div>\r\n\r\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n        {searchParams.get(\"reset\") === \"success\" && (\r\n          <div className=\"p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700 text-sm\">\r\n            Password reset successful! You can now sign in with your new password.\r\n          </div>\r\n        )}\r\n        {error && (\r\n          <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <div>\r\n          <label htmlFor=\"email\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n            Email Address\r\n          </label>\r\n          <input\r\n            type=\"email\"\r\n            id=\"email\"\r\n            value={email}\r\n            onChange={(e) => setEmail(e.target.value)}\r\n            placeholder=\"you@example.com\"\r\n            className=\"w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors disabled:bg-slate-50 disabled:cursor-not-allowed\"\r\n            required\r\n            disabled={isLoading}\r\n          />\r\n        </div>\r\n        <div>\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <label htmlFor=\"password\" className=\"block text-sm font-medium text-slate-700\">\r\n              Password\r\n            </label>\r\n            <Link\r\n              href=\"/forgot-password\"\r\n              className=\"text-sm text-amber-600 hover:text-amber-500 font-medium transition-colors\"\r\n            >\r\n              Forgot password?\r\n            </Link>\r\n          </div>\r\n          <input\r\n            type=\"password\"\r\n            id=\"password\"\r\n            value={password}\r\n            onChange={(e) => setPassword(e.target.value)}\r\n            placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n            className=\"w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors disabled:bg-slate-50 disabled:cursor-not-allowed\"\r\n            required\r\n            disabled={isLoading}\r\n          />\r\n        </div>\r\n        <button\r\n          type=\"submit\"\r\n          className=\"w-full px-4 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors shadow-lg shadow-amber-500/25 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          disabled={isLoading}\r\n        >\r\n          {isLoading ? \"Signing in...\" : \"Sign In\"}\r\n        </button>\r\n      </form>\r\n\r\n      <div className=\"mt-6 pt-6 border-t border-slate-200 text-center\">\r\n        <p className=\"text-sm text-slate-600\">\r\n          Don&apos;t have an account?{\" \"}\r\n          <Link href=\"/register\" className=\"font-semibold text-amber-600 hover:text-amber-500 transition-colors\">\r\n            Sign up\r\n          </Link>\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// Force dynamic rendering to prevent static caching of auth state\r\n// This ensures the page always checks current auth status\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport default function LoginPage() {\r\n  return (\r\n    <div className=\"relative min-h-screen bg-slate-900 overflow-hidden\">\r\n      {/* Hero Background Image */}\r\n      <div className=\"absolute inset-0 w-full h-full\">\r\n        <img\r\n          src=\"/auth-hero-bg.png\"\r\n          alt=\"OMNEXORA - Sign in to your account\"\r\n          className=\"w-full h-full object-cover\"\r\n          style={{ \r\n            objectFit: 'cover',\r\n            objectPosition: 'center',\r\n            minWidth: '100%',\r\n            minHeight: '100%'\r\n          }}\r\n        />\r\n      </div>\r\n      \r\n      {/* Content Overlay */}\r\n      <div className=\"relative z-10 flex flex-col items-center justify-center min-h-screen px-4\">\r\n        <div className=\"w-full max-w-md\">\r\n          <Suspense fallback={\r\n            <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 p-8\">\r\n              <div className=\"text-center\">\r\n                <p className=\"text-slate-600\">Loading...</p>\r\n              </div>\r\n            </div>\r\n          }>\r\n            <LoginForm />\r\n          </Suspense>\r\n        </div>\r\n      </div>\r\n      <Footer />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\onboarding\\OnboardingWizard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4061,4064],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4061,4064],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":164,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5325,5328],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5325,5328],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6376,6379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6376,6379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Loader2, CheckCircle, ArrowRight, ArrowLeft } from \"lucide-react\";\r\n\r\nconst VALID_TRADE_TYPES = [\"Painter\", \"Plasterer\", \"Carpenter\", \"Electrician\", \"Other\"];\r\n\r\ninterface BusinessProfile {\r\n  businessName: string | null;\r\n  tradingName: string | null;\r\n  abn: string | null;\r\n  primaryTrade: string | null;\r\n  tradeTypes: string | null;\r\n  doesResidential: boolean;\r\n  doesCommercial: boolean;\r\n  doesStrata: boolean;\r\n  serviceRadiusKm: number | null;\r\n  servicePostcodes: string | null;\r\n  hourlyRate: number | null;\r\n  calloutFee: number | null;\r\n  ratePerM2Interior: number | null;\r\n  ratePerM2Exterior: number | null;\r\n  ratePerLmTrim: number | null;\r\n}\r\n\r\ninterface OnboardingWizardProps {\r\n  initialData: BusinessProfile;\r\n}\r\n\r\nexport default function OnboardingWizard({ initialData }: OnboardingWizardProps) {\r\n  const router = useRouter();\r\n  const [currentStep, setCurrentStep] = useState(1);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [formData, setFormData] = useState<BusinessProfile>(initialData);\r\n\r\n  const totalSteps = 4;\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\r\n    const { name, value, type } = e.target;\r\n    const checked = (e.target as HTMLInputElement).checked;\r\n\r\n    if (type === \"checkbox\") {\r\n      setFormData((prev) => ({ ...prev, [name]: checked }));\r\n    } else if (type === \"number\") {\r\n      const numValue = value === \"\" ? null : Number(value);\r\n      setFormData((prev) => ({ ...prev, [name]: numValue }));\r\n    } else {\r\n      setFormData((prev) => ({ ...prev, [name]: value === \"\" ? null : value }));\r\n    }\r\n  };\r\n\r\n  const validateStep = (step: number): boolean => {\r\n    setError(\"\");\r\n    \r\n    if (step === 1) {\r\n      // Business Details: business name, primary trade, at least one work type\r\n      if (!formData.businessName && !formData.tradingName) {\r\n        setError(\"Please enter a business name or trading name.\");\r\n        return false;\r\n      }\r\n      if (!formData.primaryTrade) {\r\n        setError(\"Please select your primary trade.\");\r\n        return false;\r\n      }\r\n      if (!formData.doesResidential && !formData.doesCommercial && !formData.doesStrata) {\r\n        setError(\"Please select at least one work type.\");\r\n        return false;\r\n      }\r\n    } else if (step === 2) {\r\n      // Service Area: radius OR postcodes\r\n      if (\r\n        (!formData.serviceRadiusKm || formData.serviceRadiusKm <= 0) &&\r\n        (!formData.servicePostcodes || formData.servicePostcodes.trim().length === 0)\r\n      ) {\r\n        setError(\"Please specify a service radius or list service postcodes/suburbs.\");\r\n        return false;\r\n      }\r\n    } else if (step === 3) {\r\n      // Pricing: at least one rate\r\n      if (\r\n        (!formData.hourlyRate || formData.hourlyRate <= 0) &&\r\n        (!formData.ratePerM2Interior || formData.ratePerM2Interior <= 0) &&\r\n        (!formData.ratePerM2Exterior || formData.ratePerM2Exterior <= 0) &&\r\n        (!formData.ratePerLmTrim || formData.ratePerLmTrim <= 0)\r\n      ) {\r\n        setError(\"Please enter at least one pricing rate (hourly rate or area/linear rates).\");\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    return true;\r\n  };\r\n\r\n  const handleNext = async () => {\r\n    if (!validateStep(currentStep)) {\r\n      return;\r\n    }\r\n\r\n    // Save progress on each step\r\n    setIsSaving(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      const profileResponse = await fetch(\"/api/settings/business-profile\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n\r\n      if (!profileResponse.ok) {\r\n        const data = await profileResponse.json();\r\n        throw new Error(data.error || \"Failed to save progress\");\r\n      }\r\n\r\n      // Move to next step on success\r\n      setCurrentStep((prev) => Math.min(prev + 1, totalSteps));\r\n    } catch (err: any) {\r\n      console.error(\"Error saving progress:\", err);\r\n      setError(err.message || \"Failed to save progress. Please try again.\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleBack = () => {\r\n    setCurrentStep((prev) => Math.max(prev - 1, 1));\r\n  };\r\n\r\n  const handleFinish = async () => {\r\n    if (!validateStep(currentStep)) {\r\n      return;\r\n    }\r\n\r\n    setIsSaving(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      // Save business profile\r\n      const profileResponse = await fetch(\"/api/settings/business-profile\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n\r\n      if (!profileResponse.ok) {\r\n        const data = await profileResponse.json();\r\n        throw new Error(data.error || \"Failed to save business profile\");\r\n      }\r\n\r\n      // Mark onboarding as complete\r\n      const completeResponse = await fetch(\"/api/onboarding/complete\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      });\r\n\r\n      if (!completeResponse.ok) {\r\n        throw new Error(\"Failed to complete onboarding\");\r\n      }\r\n\r\n      // Redirect to dashboard\r\n      router.push(\"/dashboard\");\r\n    } catch (err: any) {\r\n      console.error(\"Error completing onboarding:\", err);\r\n      setError(err.message || \"Failed to complete onboarding. Please try again.\");\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleSkip = async () => {\r\n    if (!window.confirm(\"Are you sure you want to skip onboarding? You can complete it later from Settings.\")) {\r\n      return;\r\n    }\r\n\r\n    setIsSaving(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      // Save any progress made so far\r\n      await fetch(\"/api/settings/business-profile\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n\r\n      // Mark onboarding as skipped (not completed)\r\n      const skipResponse = await fetch(\"/api/onboarding/skip\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      });\r\n\r\n      if (!skipResponse.ok) {\r\n        throw new Error(\"Failed to skip onboarding\");\r\n      }\r\n\r\n      // Redirect to dashboard\r\n      router.push(\"/dashboard\");\r\n    } catch (err: any) {\r\n      console.error(\"Error skipping onboarding:\", err);\r\n      setError(err.message || \"Failed to skip onboarding. Please try again.\");\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const getStepTitle = (step: number): string => {\r\n    switch (step) {\r\n      case 1:\r\n        return \"Business Details\";\r\n      case 2:\r\n        return \"Service Area\";\r\n      case 3:\r\n        return \"Pricing & Rates\";\r\n      case 4:\r\n        return \"Verification & Next Steps\";\r\n      default:\r\n        return \"\";\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n      {/* Progress Bar */}\r\n      <div className=\"px-6 py-4 border-b border-slate-200\">\r\n        <div className=\"flex items-center justify-between mb-2\">\r\n          <h2 className=\"text-lg font-semibold text-slate-900\">\r\n            Step {currentStep} of {totalSteps}: {getStepTitle(currentStep)}\r\n          </h2>\r\n          <span className=\"text-sm text-slate-500\">\r\n            {Math.round((currentStep / totalSteps) * 100)}% complete\r\n          </span>\r\n        </div>\r\n        <div className=\"w-full bg-slate-200 rounded-full h-2\">\r\n          <div\r\n            className=\"bg-amber-500 h-2 rounded-full transition-all duration-300\"\r\n            style={{ width: `${(currentStep / totalSteps) * 100}%` }}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Step Content */}\r\n      <div className=\"p-6\">\r\n        {error && (\r\n          <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {/* Step 1: Business Details */}\r\n        {currentStep === 1 && (\r\n          <div className=\"space-y-6\">\r\n            <div>\r\n              <h3 className=\"text-base font-medium text-slate-900 mb-4\">Tell us about your business</h3>\r\n              \r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label htmlFor=\"businessName\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Business Name <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    id=\"businessName\"\r\n                    name=\"businessName\"\r\n                    value={formData.businessName ?? \"\"}\r\n                    onChange={handleChange}\r\n                    placeholder=\"e.g. Perth Pro Painters Pty Ltd\"\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                    disabled={isSaving}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label htmlFor=\"abn\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    ABN\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    id=\"abn\"\r\n                    name=\"abn\"\r\n                    value={formData.abn ?? \"\"}\r\n                    onChange={handleChange}\r\n                    placeholder=\"e.g. 12 345 678 901\"\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                    disabled={isSaving}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label htmlFor=\"primaryTrade\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Primary Trade <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <select\r\n                    id=\"primaryTrade\"\r\n                    name=\"primaryTrade\"\r\n                    value={formData.primaryTrade ?? \"\"}\r\n                    onChange={handleChange}\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white\"\r\n                    disabled={isSaving}\r\n                  >\r\n                    <option value=\"\">Select a trade...</option>\r\n                    {VALID_TRADE_TYPES.map((trade) => (\r\n                      <option key={trade} value={trade}>\r\n                        {trade}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-slate-700 mb-3\">\r\n                    Work Types <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <div className=\"space-y-3\">\r\n                    <div className=\"flex items-start gap-3\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        id=\"doesResidential\"\r\n                        name=\"doesResidential\"\r\n                        checked={formData.doesResidential}\r\n                        onChange={handleChange}\r\n                        className=\"mt-1 w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\r\n                        disabled={isSaving}\r\n                      />\r\n                      <div className=\"flex-1\">\r\n                        <label htmlFor=\"doesResidential\" className=\"block text-sm font-medium text-slate-700\">\r\n                          Residential\r\n                        </label>\r\n                        <p className=\"text-xs text-slate-500 mt-0.5\">I work on residential properties</p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-start gap-3\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        id=\"doesCommercial\"\r\n                        name=\"doesCommercial\"\r\n                        checked={formData.doesCommercial}\r\n                        onChange={handleChange}\r\n                        className=\"mt-1 w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\r\n                        disabled={isSaving}\r\n                      />\r\n                      <div className=\"flex-1\">\r\n                        <label htmlFor=\"doesCommercial\" className=\"block text-sm font-medium text-slate-700\">\r\n                          Commercial\r\n                        </label>\r\n                        <p className=\"text-xs text-slate-500 mt-0.5\">I work on commercial properties</p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-start gap-3\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        id=\"doesStrata\"\r\n                        name=\"doesStrata\"\r\n                        checked={formData.doesStrata}\r\n                        onChange={handleChange}\r\n                        className=\"mt-1 w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\r\n                        disabled={isSaving}\r\n                      />\r\n                      <div className=\"flex-1\">\r\n                        <label htmlFor=\"doesStrata\" className=\"block text-sm font-medium text-slate-700\">\r\n                          Strata\r\n                        </label>\r\n                        <p className=\"text-xs text-slate-500 mt-0.5\">I work on strata properties</p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Step 2: Service Area */}\r\n        {currentStep === 2 && (\r\n          <div className=\"space-y-6\">\r\n            <div>\r\n              <h3 className=\"text-base font-medium text-slate-900 mb-4\">Where do you work?</h3>\r\n              \r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label htmlFor=\"serviceRadiusKm\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Service Radius (km)\r\n                  </label>\r\n                  <input\r\n                    type=\"number\"\r\n                    id=\"serviceRadiusKm\"\r\n                    name=\"serviceRadiusKm\"\r\n                    value={formData.serviceRadiusKm ?? \"\"}\r\n                    onChange={handleChange}\r\n                    placeholder=\"e.g. 50\"\r\n                    min=\"0\"\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                    disabled={isSaving}\r\n                  />\r\n                  <p className=\"mt-1 text-xs text-slate-500\">Maximum distance you travel from your base location</p>\r\n                </div>\r\n\r\n                <div className=\"relative\">\r\n                  <div className=\"absolute inset-0 flex items-center\">\r\n                    <div className=\"w-full border-t border-slate-300\" />\r\n                  </div>\r\n                  <div className=\"relative flex justify-center text-sm\">\r\n                    <span className=\"px-2 bg-white text-slate-500\">OR</span>\r\n                  </div>\r\n                </div>\r\n\r\n                <div>\r\n                  <label htmlFor=\"servicePostcodes\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Service Postcodes / Suburbs <span className=\"text-red-500\">*</span>\r\n                  </label>\r\n                  <textarea\r\n                    id=\"servicePostcodes\"\r\n                    name=\"servicePostcodes\"\r\n                    value={formData.servicePostcodes ?? \"\"}\r\n                    onChange={handleChange}\r\n                    placeholder=\"e.g. 6000, 6001, 6002 or Perth, Fremantle, Joondalup\"\r\n                    rows={4}\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-none\"\r\n                    disabled={isSaving}\r\n                  />\r\n                  <p className=\"mt-1 text-xs text-slate-500\">\r\n                    List postcodes or suburbs you service (comma or line separated)\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Step 3: Pricing & Rates */}\r\n        {currentStep === 3 && (\r\n          <div className=\"space-y-6\">\r\n            <div>\r\n              <h3 className=\"text-base font-medium text-slate-900 mb-4\">Set your pricing</h3>\r\n              <p className=\"text-sm text-slate-600 mb-4\">\r\n                Enter at least one rate. You can add more later in Settings.\r\n              </p>\r\n              \r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label htmlFor=\"hourlyRate\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Hourly Rate ($)\r\n                  </label>\r\n                  <input\r\n                    type=\"number\"\r\n                    id=\"hourlyRate\"\r\n                    name=\"hourlyRate\"\r\n                    value={formData.hourlyRate ?? \"\"}\r\n                    onChange={handleChange}\r\n                    placeholder=\"e.g. 75\"\r\n                    min=\"0\"\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                    disabled={isSaving}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label htmlFor=\"calloutFee\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                    Callout Fee ($)\r\n                  </label>\r\n                  <input\r\n                    type=\"number\"\r\n                    id=\"calloutFee\"\r\n                    name=\"calloutFee\"\r\n                    value={formData.calloutFee ?? \"\"}\r\n                    onChange={handleChange}\r\n                    placeholder=\"e.g. 150\"\r\n                    min=\"0\"\r\n                    className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                    disabled={isSaving}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"pt-4 border-t border-slate-200\">\r\n                  <p className=\"text-sm font-medium text-slate-700 mb-3\">Area & Linear Rates (optional)</p>\r\n                  \r\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <div>\r\n                      <label htmlFor=\"ratePerM2Interior\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                        Interior ($/m┬▓)\r\n                      </label>\r\n                      <input\r\n                        type=\"number\"\r\n                        id=\"ratePerM2Interior\"\r\n                        name=\"ratePerM2Interior\"\r\n                        value={formData.ratePerM2Interior ?? \"\"}\r\n                        onChange={handleChange}\r\n                        placeholder=\"e.g. 25\"\r\n                        min=\"0\"\r\n                        className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                        disabled={isSaving}\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label htmlFor=\"ratePerM2Exterior\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                        Exterior ($/m┬▓)\r\n                      </label>\r\n                      <input\r\n                        type=\"number\"\r\n                        id=\"ratePerM2Exterior\"\r\n                        name=\"ratePerM2Exterior\"\r\n                        value={formData.ratePerM2Exterior ?? \"\"}\r\n                        onChange={handleChange}\r\n                        placeholder=\"e.g. 30\"\r\n                        min=\"0\"\r\n                        className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                        disabled={isSaving}\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label htmlFor=\"ratePerLmTrim\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                        Linear Metre ($/lm)\r\n                      </label>\r\n                      <input\r\n                        type=\"number\"\r\n                        id=\"ratePerLmTrim\"\r\n                        name=\"ratePerLmTrim\"\r\n                        value={formData.ratePerLmTrim ?? \"\"}\r\n                        onChange={handleChange}\r\n                        placeholder=\"e.g. 15\"\r\n                        min=\"0\"\r\n                        className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n                        disabled={isSaving}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Step 4: Verification */}\r\n        {currentStep === 4 && (\r\n          <div className=\"space-y-6\">\r\n            <div>\r\n              <h3 className=\"text-base font-medium text-slate-900 mb-4\">Almost there!</h3>\r\n              \r\n              <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6\">\r\n                <div className=\"flex items-start gap-3\">\r\n                  <CheckCircle className=\"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5\" />\r\n                  <div>\r\n                    <p className=\"text-sm font-medium text-amber-900 mb-1\">Profile setup complete</p>\r\n                    <p className=\"text-sm text-amber-700\">\r\n                      Your business profile is ready. To build more trust with clients and unlock full OMNEXORA features, \r\n                      complete business verification.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <h4 className=\"text-sm font-medium text-slate-900 mb-2\">Next steps:</h4>\r\n                  <ul className=\"space-y-2 text-sm text-slate-600\">\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <span className=\"text-amber-500 mt-0.5\">Ô£ô</span>\r\n                      <span>Business profile completed</span>\r\n                    </li>\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <span className=\"text-slate-400 mt-0.5\">Ôùï</span>\r\n                      <span>Complete business verification (optional but recommended)</span>\r\n                    </li>\r\n                    <li className=\"flex items-start gap-2\">\r\n                      <span className=\"text-slate-400 mt-0.5\">Ôùï</span>\r\n                      <span>Create your first AI job pack</span>\r\n                    </li>\r\n                  </ul>\r\n                </div>\r\n\r\n                <div className=\"pt-4 border-t border-slate-200\">\r\n                  <a\r\n                    href=\"/settings/verification\"\r\n                    className=\"inline-flex items-center text-sm font-medium text-amber-600 hover:text-amber-700\"\r\n                  >\r\n                    Go to Verification Settings ÔåÆ\r\n                  </a>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Navigation Buttons */}\r\n        <div className=\"mt-8 pt-6 border-t border-slate-200\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleBack}\r\n              disabled={currentStep === 1 || isSaving}\r\n              className=\"inline-flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n              Back\r\n            </button>\r\n\r\n            {currentStep < totalSteps ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleNext}\r\n                disabled={isSaving}\r\n                className=\"inline-flex items-center px-6 py-2 text-sm font-semibold text-slate-900 bg-amber-500 hover:bg-amber-400 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {isSaving ? (\r\n                  <>\r\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                    Saving...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    Next\r\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\r\n                  </>\r\n                )}\r\n              </button>\r\n            ) : (\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleFinish}\r\n                disabled={isSaving}\r\n                className=\"inline-flex items-center px-6 py-2 text-sm font-semibold text-white bg-amber-600 hover:bg-amber-500 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {isSaving ? (\r\n                  <>\r\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                    Finishing...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\r\n                    Finish Setup\r\n                  </>\r\n                )}\r\n              </button>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Skip for now link */}\r\n          <div className=\"text-center\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleSkip}\r\n              disabled={isSaving}\r\n              className=\"text-sm text-slate-500 hover:text-slate-700 underline disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              Skip for now\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\onboarding\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\onboarding\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'needsOnboarding' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { redirect } from \"next/navigation\";\r\nimport { requireUser } from \"@/lib/authChecks\";\r\nimport { getPrisma } from \"@/lib/prisma\";\r\nimport { needsOnboarding, isBusinessProfileComplete } from \"@/lib/onboarding\";\r\nimport OnboardingWizard from \"./OnboardingWizard\";\r\n\r\n// Authenticated page using requireUser and Prisma - must be dynamic\r\nexport const dynamic = \"force-dynamic\";\r\nexport const fetchCache = \"force-no-store\";\r\nexport const revalidate = 0;\r\n\r\nexport default async function OnboardingPage() {\r\n  const user = await requireUser();\r\n\r\n  console.log(\"[onboarding] onboarding page accessed by user\", user?.id);\r\n\r\n  // Clients don't need onboarding\r\n  if (user.role === \"client\") {\r\n    redirect(\"/client/dashboard\");\r\n  }\r\n\r\n  // Fetch full user from Prisma with error handling\r\n  const prisma = getPrisma();\r\n  let prismaUser;\r\n  try {\r\n    prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n    });\r\n  } catch (error) {\r\n    // If database query fails, redirect to login for safety\r\n    console.error(\"[onboarding] Failed to fetch user from Prisma in onboarding:\", error);\r\n    redirect(\"/login?reason=unauthorised\");\r\n  }\r\n\r\n  if (!prismaUser) {\r\n    console.log(\"[onboarding] user not found in Prisma, redirecting to login\");\r\n    redirect(\"/login?reason=unauthorised\");\r\n  }\r\n\r\n  // If profile is already complete, redirect to dashboard\r\n  if (prismaUser.profileCompletedAt || isBusinessProfileComplete(prismaUser)) {\r\n    // Auto-complete for legacy users\r\n    if (!prismaUser.profileCompletedAt && isBusinessProfileComplete(prismaUser)) {\r\n      try {\r\n        await prisma.user.update({\r\n          where: { id: prismaUser.id },\r\n          data: { profileCompletedAt: new Date() },\r\n        });\r\n      } catch (error) {\r\n        // If update fails, log but continue - user can still proceed\r\n        console.error(\"[onboarding] Failed to update profileCompletedAt:\", error);\r\n      }\r\n    }\r\n    redirect(\"/dashboard\");\r\n  }\r\n\r\n  // Fetch current business profile data\r\n  const businessProfile = {\r\n    businessName: prismaUser.businessName,\r\n    tradingName: prismaUser.tradingName,\r\n    abn: prismaUser.abn,\r\n    primaryTrade: prismaUser.primaryTrade,\r\n    tradeTypes: prismaUser.tradeTypes,\r\n    doesResidential: prismaUser.doesResidential,\r\n    doesCommercial: prismaUser.doesCommercial,\r\n    doesStrata: prismaUser.doesStrata,\r\n    serviceRadiusKm: prismaUser.serviceRadiusKm,\r\n    servicePostcodes: prismaUser.servicePostcodes,\r\n    hourlyRate: prismaUser.hourlyRate,\r\n    calloutFee: prismaUser.calloutFee,\r\n    ratePerM2Interior: prismaUser.ratePerM2Interior,\r\n    ratePerM2Exterior: prismaUser.ratePerM2Exterior,\r\n    ratePerLmTrim: prismaUser.ratePerLmTrim,\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n        <div className=\"mb-8 text-center\">\r\n          <h1 className=\"text-3xl font-bold text-slate-900 mb-2\">Welcome to OMNEXORA</h1>\r\n          <p className=\"text-lg text-slate-600\">\r\n            Let&apos;s get your business profile set up so you can start creating AI job packs.\r\n          </p>\r\n        </div>\r\n        <OnboardingWizard initialData={businessProfile} />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":23,"column":9,"nodeType":"JSXOpeningElement","endLine":27,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useRef } from \"react\";\nimport Link from \"next/link\";\nimport OvisBadge from \"@/app/components/OvisBadge\";\nimport OvisModal from \"@/app/components/OvisModal\";\n\nexport default function Home() {\n  const [isOvisModalOpen, setIsOvisModalOpen] = useState(false);\n  const heroRef = useRef<HTMLDivElement>(null);\n\n  // Placeholder for auth state - will be replaced with real auth later\n  const isLoggedIn = false;\n\n  return (\n    <main className=\"min-h-screen\">\n      {/* Hero Section with Background Image */}\n      <section \n        ref={heroRef}\n        className=\"relative bg-slate-900\"\n      >\n        {/* Background Image - Full, Uncropped, 85% opacity */}\n        <img\n          src=\"/hero-bg.png\"\n          alt=\"OMNEXORA - Your clients get better. Your team gets faster. Your head gets quieter.\"\n          className=\"w-full h-[105%] object-cover object-top block opacity-85\"\n        />\n\n        {/* OVIS Trust Strip - positioned near top of hero */}\n        <div className=\"absolute top-[3%] sm:top-[5%] md:top-[7%] left-0 right-0 z-10 flex flex-col items-center px-4 sm:px-6 md:px-8\">\n          <div className=\"flex items-center justify-center gap-1.5 bg-slate-900/40 backdrop-blur-sm px-2 sm:px-2.5 py-1 sm:py-1 rounded-full border border-white/30\">\n            <span className=\"inline-flex items-center gap-1 text-xs font-medium text-white drop-shadow-lg\">\n              <svg className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-amber-400 drop-shadow-md\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n              <span className=\"drop-shadow-md\">OVIS Checked</span>\n            </span>\n            <button\n              onClick={() => setIsOvisModalOpen(true)}\n              className=\"p-0.5 text-amber-400 hover:text-amber-300 hover:bg-white/10 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-2 focus:ring-offset-slate-900/40\"\n              aria-label=\"What is OVIS?\"\n            >\n              <svg className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 drop-shadow-md\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n                />\n              </svg>\n            </button>\n          </div>\n        </div>\n\n\n      </section>\n\n      {/* Features Section */}\n      <section className=\"px-4 sm:px-6 md:px-8 py-16 sm:py-20 md:py-24 lg:py-28 bg-white\">\n        <div className=\"w-full max-w-6xl mx-auto\">\n          {/* Small CTA Buttons - above section header */}\n          <div className=\"flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 mb-10 sm:mb-12 md:mb-14\">\n            {isLoggedIn ? (\n              <Link\n                href=\"/dashboard\"\n                className=\"inline-flex items-center px-6 sm:px-7 md:px-8 py-2.5 sm:py-3 text-sm sm:text-base font-medium text-slate-700 bg-white hover:bg-slate-50 border border-slate-200 rounded-lg transition-colors\"\n              >\n                <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\" />\n                </svg>\n                Dashboard\n              </Link>\n            ) : (\n              <>\n                <Link\n                  href=\"/register\"\n                  className=\"inline-flex items-center px-6 sm:px-7 md:px-8 py-2.5 sm:py-3 text-sm sm:text-base font-medium text-slate-900 bg-amber-500 hover:bg-amber-400 rounded-lg transition-colors\"\n                >\n                  <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 7l5 5m0 0l-5 5m5-5H6\" />\n                  </svg>\n                  Get started\n                </Link>\n                <Link\n                  href=\"/login\"\n                  className=\"inline-flex items-center px-6 sm:px-7 md:px-8 py-2.5 sm:py-3 text-sm sm:text-base font-medium text-white bg-slate-900 hover:bg-slate-800 rounded-lg transition-colors\"\n                >\n                  <svg className=\"w-5 h-5 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1\" />\n                  </svg>\n                  Log in\n                </Link>\n              </>\n            )}\n          </div>\n\n          {/* Section Header */}\n          <div className=\"text-center mb-12 sm:mb-14 md:mb-16\">\n            <h2 className=\"text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-semibold text-slate-900 mb-4 sm:mb-5 tracking-tight\">\n              Everything You Need, All in One Place\n            </h2>\n            <p className=\"text-base sm:text-lg md:text-xl text-slate-600 max-w-2xl mx-auto mb-6 sm:mb-7 leading-relaxed\">\n              Streamline your workflow with AI-powered job packs, quotes, and safety docs.\n            </p>\n            {/* OVIS Checked Badge */}\n            <div className=\"flex justify-center\">\n              <OvisBadge variant=\"card\" size=\"md\" />\n            </div>\n          </div>\n\n          {/* Core Features Grid */}\n          <div className=\"mb-12 sm:mb-14 md:mb-16\">\n            <h3 className=\"text-xl sm:text-2xl font-semibold text-slate-900 mb-6 sm:mb-8 text-center\">Core Features</h3>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-5\">\n              {/* Feature 1: Job Pack Creation */}\n              <div className=\"bg-white rounded-lg border border-slate-100 p-5 sm:p-6 hover:border-slate-200 transition-colors\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <div className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-lg bg-amber-50 flex items-center justify-center mb-3 sm:mb-4\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                    </svg>\n                  </div>\n                  <h3 className=\"text-base sm:text-lg font-semibold text-slate-900 mb-2\">\n                    Job Pack Creation\n                  </h3>\n                  <p className=\"text-sm text-slate-600 leading-relaxed\">\n                    Generate comprehensive job packs effortlessly with AI assistance.\n                  </p>\n                </div>\n              </div>\n\n              {/* Feature 2: Smart Quote Helper */}\n              <div className=\"bg-white rounded-lg border border-slate-100 p-5 sm:p-6 hover:border-slate-200 transition-colors\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <div className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-lg bg-blue-50 flex items-center justify-center mb-3 sm:mb-4\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 7h6m0 10v-5m-6 5h.01M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z\" />\n                    </svg>\n                  </div>\n                  <h3 className=\"text-base sm:text-lg font-semibold text-slate-900 mb-2\">\n                    Smart Quote Helper\n                  </h3>\n                  <p className=\"text-sm text-slate-600 leading-relaxed\">\n                    Local pricing integration to help you create quotes faster.\n                  </p>\n                </div>\n              </div>\n\n              {/* Feature 3: Compliance-Ready Tools */}\n              <div className=\"bg-white rounded-lg border border-slate-100 p-5 sm:p-6 hover:border-slate-200 transition-colors\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <div className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-lg bg-green-50 flex items-center justify-center mb-3 sm:mb-4\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\n                    </svg>\n                  </div>\n                  <h3 className=\"text-base sm:text-lg font-semibold text-slate-900 mb-2\">\n                    Compliance-Ready Tools\n                  </h3>\n                  <p className=\"text-sm text-slate-600 leading-relaxed\">\n                    Compliance-ready templates (AU/WA) ÔÇö review required. Keep your documentation organized.\n                  </p>\n                </div>\n              </div>\n\n              {/* Feature 4: AI-Powered Assistance */}\n              <div className=\"bg-white rounded-lg border border-slate-100 p-5 sm:p-6 hover:border-slate-200 transition-colors\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <div className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-lg bg-purple-50 flex items-center justify-center mb-3 sm:mb-4\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-purple-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\n                    </svg>\n                  </div>\n                  <h3 className=\"text-base sm:text-lg font-semibold text-slate-900 mb-2\">\n                    AI-Powered Assistance\n                  </h3>\n                  <p className=\"text-sm text-slate-600 leading-relaxed\">\n                    Leverage AI to reduce admin time and improve accuracy.\n                  </p>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Benefits Section */}\n          <div className=\"mb-12 sm:mb-14 md:mb-16\">\n            <h3 className=\"text-xl sm:text-2xl md:text-3xl font-semibold text-slate-900 mb-8 sm:mb-10 text-center\">Benefits</h3>\n            {/* OVIS Checked Badge */}\n            <div className=\"flex justify-center mb-8 sm:mb-10\">\n              <OvisBadge variant=\"card\" size=\"md\" />\n            </div>\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-6 sm:gap-7 md:gap-8\">\n              <div className=\"text-center bg-white rounded-lg p-6 sm:p-7 border border-slate-100 hover:border-slate-200 transition-colors\">\n                <div className=\"inline-flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-amber-50 mb-4 sm:mb-5\">\n                  <svg className=\"w-6 h-6 sm:w-7 sm:h-7 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  </svg>\n                </div>\n                <h4 className=\"font-semibold text-slate-900 mb-2 sm:mb-3 text-base sm:text-lg md:text-xl\">Save Time</h4>\n                <p className=\"text-sm sm:text-base text-slate-600\">Reduce administrative tasks and focus on on-site work.</p>\n              </div>\n              <div className=\"text-center bg-white rounded-lg p-6 sm:p-7 border border-slate-100 hover:border-slate-200 transition-colors\">\n                <div className=\"inline-flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-blue-50 mb-4 sm:mb-5\">\n                  <svg className=\"w-6 h-6 sm:w-7 sm:h-7 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                  </svg>\n                </div>\n                <h4 className=\"font-semibold text-slate-900 mb-2 sm:mb-3 text-base sm:text-lg md:text-xl\">Work Smarter</h4>\n                <p className=\"text-sm sm:text-base text-slate-600\">AI-powered tools help you stay ahead and efficient.</p>\n              </div>\n              <div className=\"text-center bg-white rounded-lg p-6 sm:p-7 border border-slate-100 hover:border-slate-200 transition-colors\">\n                <div className=\"inline-flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-green-50 mb-4 sm:mb-5\">\n                  <svg className=\"w-6 h-6 sm:w-7 sm:h-7 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\n                  </svg>\n                </div>\n                <h4 className=\"font-semibold text-slate-900 mb-2 sm:mb-3 text-base sm:text-lg md:text-xl\">Stay Compliant</h4>\n                <p className=\"text-sm sm:text-base text-slate-600\">Compliance-ready templates (AU/WA) ÔÇö review required for peace of mind.</p>\n              </div>\n            </div>\n          </div>\n\n          {/* What's Available Now vs. Coming Soon */}\n          <div className=\"bg-slate-50 rounded-lg border border-slate-100 p-6 sm:p-8 md:p-10\">\n            <h3 className=\"text-xl sm:text-2xl md:text-3xl font-semibold text-slate-900 mb-8 sm:mb-10 text-center\">What&apos;s Available</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 sm:gap-10 md:gap-12\">\n              <div>\n                <div className=\"flex items-center gap-2 sm:gap-3 mb-4 sm:mb-5\">\n                  <div className=\"w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-green-500\"></div>\n                  <h4 className=\"font-semibold text-slate-900 text-base sm:text-lg md:text-xl\">Available Now</h4>\n                </div>\n                <ul className=\"space-y-3 sm:space-y-4 text-sm sm:text-base text-slate-600\">\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                    <span>Job packs</span>\n                  </li>\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                    <span>Quotes</span>\n                  </li>\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                    <span>Compliance tools</span>\n                  </li>\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                    <span>AI assistance</span>\n                  </li>\n                </ul>\n              </div>\n              <div>\n                <div className=\"flex items-center gap-2 sm:gap-3 mb-4 sm:mb-5\">\n                  <div className=\"w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-amber-500\"></div>\n                  <h4 className=\"font-semibold text-slate-900 text-base sm:text-lg md:text-xl\">Coming Soon</h4>\n                </div>\n                <ul className=\"space-y-3 sm:space-y-4 text-sm sm:text-base text-slate-600\">\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                    </svg>\n                    <span>Affiliate programs</span>\n                  </li>\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                    </svg>\n                    <span>Advanced supplier pricing</span>\n                  </li>\n                  <li className=\"flex items-start gap-3\">\n                    <svg className=\"w-5 h-5 sm:w-6 sm:h-6 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                    </svg>\n                    <span>Additional features</span>\n                  </li>\n                </ul>\n              </div>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Footer */}\n      <footer className=\"bg-slate-900 text-white\">\n        {/* Main Footer Content */}\n        <div className=\"max-w-6xl mx-auto px-4 sm:px-6 md:px-8 py-12 sm:py-14 md:py-16\">\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-8 sm:gap-10 lg:gap-12\">\n            {/* Brand Column */}\n            <div className=\"sm:col-span-2 lg:col-span-1\">\n              <h2 className=\"text-xl sm:text-2xl font-bold tracking-tight mb-4 text-white\">OMNEXORA</h2>\n              <p className=\"text-white text-sm sm:text-base leading-relaxed mb-6\">\n                AI-powered job packs for<br />\n                Australian tradies. Less<br />\n                paperwork, more time for<br />\n                <span className=\"font-bold text-amber-400\">what matters most</span>.\n              </p>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"inline-flex items-center gap-1.5 px-3 py-1 bg-slate-800 rounded-full text-xs font-medium text-slate-300\">\n                  <svg className=\"w-3 h-3 text-amber-400\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                    <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                  </svg>\n                  OVIS Checked\n                </span>\n              </div>\n            </div>\n\n            {/* Product Links */}\n            <div>\n              <h3 className=\"text-sm font-semibold uppercase tracking-wider text-slate-400 mb-4\">Product</h3>\n              <ul className=\"space-y-3\">\n                <li>\n                  <Link href=\"/register\" className=\"text-slate-300 hover:text-white transition-colors text-sm\">\n                    Get Started\n                  </Link>\n                </li>\n                <li>\n                  <Link href=\"/login\" className=\"text-slate-300 hover:text-white transition-colors text-sm\">\n                    Sign In\n                  </Link>\n                </li>\n                <li>\n                  <button \n                    onClick={() => setIsOvisModalOpen(true)}\n                    className=\"text-slate-300 hover:text-white transition-colors text-sm text-left\"\n                  >\n                    What is OVIS?\n                  </button>\n                </li>\n              </ul>\n            </div>\n\n            {/* Company Links */}\n            <div>\n              <h3 className=\"text-sm font-semibold uppercase tracking-wider text-slate-400 mb-4\">Company</h3>\n              <ul className=\"space-y-3\">\n                <li>\n                  <a \n                    href=\"https://v0-omnexora-marketing-website.vercel.app/about\" \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                    className=\"text-slate-300 hover:text-white transition-colors text-sm\"\n                  >\n                    About Us\n                  </a>\n                </li>\n                <li>\n                  <a \n                    href=\"https://v0-omnexora-marketing-website.vercel.app/contact\" \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                    className=\"text-slate-300 hover:text-white transition-colors text-sm\"\n                  >\n                    Contact\n                  </a>\n                </li>\n                <li>\n                  <a \n                    href=\"https://v0-omnexora-marketing-website.vercel.app/contact\" \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                    className=\"text-slate-300 hover:text-white transition-colors text-sm\"\n                  >\n                    Pilot Program <span className=\"text-slate-500 text-xs\">(Contact us for more)</span>\n                  </a>\n                </li>\n                <li>\n                  <span className=\"text-slate-500 text-sm\">Partner with Us <span className=\"text-xs\">(Launching soon)</span></span>\n                </li>\n                <li>\n                  <span className=\"text-slate-500 text-sm\">Affiliates <span className=\"text-xs\">(Coming soon)</span></span>\n                </li>\n              </ul>\n            </div>\n\n            {/* Legal Links */}\n            <div>\n              <h3 className=\"text-sm font-semibold uppercase tracking-wider text-slate-400 mb-4\">Legal</h3>\n              <ul className=\"space-y-3\">\n                <li>\n                  <span className=\"text-slate-500 text-sm\">Privacy Policy</span>\n                </li>\n                <li>\n                  <span className=\"text-slate-500 text-sm\">Terms of Service</span>\n                </li>\n              </ul>\n            </div>\n\n            {/* Join our Community */}\n            <div>\n              <h3 className=\"text-sm font-semibold uppercase tracking-wider text-slate-400 mb-4\">Join our Community</h3>\n              <div className=\"flex gap-4\">\n                {/* Facebook - Coming Soon */}\n                <div className=\"relative group\">\n                  <span className=\"text-slate-500 cursor-not-allowed\" title=\"Coming soon\">\n                    <svg className=\"w-6 h-6\" fill=\"currentColor\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                      <path fillRule=\"evenodd\" d=\"M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z\" clipRule=\"evenodd\" />\n                    </svg>\n                  </span>\n                </div>\n\n                {/* Instagram - Coming Soon */}\n                <div className=\"relative group\">\n                  <span className=\"text-slate-500 cursor-not-allowed\" title=\"Coming soon\">\n                    <svg className=\"w-6 h-6\" fill=\"currentColor\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                      <path fillRule=\"evenodd\" d=\"M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.218 2.427.465a4.902 4.902 0 011.772 1.153 4.902 4.902 0 011.153 1.772c.247.636.416 1.363.465 2.427.048 1.067.06 1.407.06 4.123v.08c0 2.643-.012 2.987-.06 4.043-.049 1.064-.218 1.791-.465 2.427a4.902 4.902 0 01-1.153 1.772 4.902 4.902 0 01-1.772 1.153c-.636.247-1.363.416-2.427.465-1.067.048-1.407.06-4.123.06h-.08c-2.643 0-2.987-.012-4.043-.06-1.064-.049-1.791-.218-2.427-.465a4.902 4.902 0 01-1.772-1.153 4.902 4.902 0 01-1.153-1.772c-.247-.636-.416-1.363-.465-2.427-.047-1.024-.06-1.379-.06-3.808v-.63c0-2.43.013-2.784.06-3.808.049-1.064.218-1.791.465-2.427a4.902 4.902 0 011.153-1.772A4.902 4.902 0 015.45 2.525c.636-.247 1.363-.416 2.427-.465C8.901 2.013 9.256 2 11.685 2h.63zm-.081 1.802h-.468c-2.456 0-2.784.011-3.807.058-.975.045-1.504.207-1.857.344-.467.182-.8.398-1.15.748-.35.35-.566.683-.748 1.15-.137.353-.3.882-.344 1.857-.047 1.023-.058 1.351-.058 3.807v.468c0 2.456.011 2.784.058 3.807.045.975.207 1.504.344 1.857.182.466.399.8.748 1.15.35.35.683.566 1.15.748.353.137.882.3 1.857.344 1.054.048 1.37.058 4.041.058h.08c2.597 0 2.917-.01 3.96-.058.976-.045 1.505-.207 1.858-.344.466-.182.8-.398 1.15-.748.35-.35.566-.683.748-1.15.137-.353.3-.882.344-1.857.048-1.055.058-1.37.058-4.041v-.08c0-2.597-.01-2.917-.058-3.96-.045-.976-.207-1.505-.344-1.858a3.097 3.097 0 00-.748-1.15 3.098 3.098 0 00-1.15-.748c-.353-.137-.882-.3-1.857-.344-1.023-.047-1.351-.058-3.807-.058zM12 6.865a5.135 5.135 0 110 10.27 5.135 5.135 0 010-10.27zm0 1.802a3.333 3.333 0 100 6.666 3.333 3.333 0 000-6.666zm5.338-3.205a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z\" clipRule=\"evenodd\" />\n                    </svg>\n                  </span>\n                </div>\n\n                {/* WhatsApp - Coming Soon */}\n                <div className=\"relative group\">\n                  <span className=\"text-slate-500 cursor-not-allowed\" title=\"Coming soon\">\n                    <svg className=\"w-6 h-6\" fill=\"currentColor\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                      <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z\"/>\n                    </svg>\n                  </span>\n                </div>\n\n                {/* TikTok - Active Link */}\n                <a \n                  href=\"https://www.tiktok.com/@omnexora\" \n                  target=\"_blank\" \n                  rel=\"noopener noreferrer\"\n                  className=\"text-slate-300 hover:text-white transition-colors\"\n                  aria-label=\"Follow us on TikTok\"\n                >\n                  <svg className=\"w-6 h-6\" fill=\"currentColor\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                    <path d=\"M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z\"/>\n                  </svg>\n                </a>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Footer Bottom */}\n        <div className=\"border-t border-slate-800\">\n          <div className=\"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\n            <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n              <p className=\"text-slate-500 text-xs sm:text-sm text-center sm:text-left\">\n                ┬® {new Date().getFullYear()} OMNEXORA. All rights reserved.\n              </p>\n              <div className=\"flex items-center gap-1 text-slate-500 text-xs\">\n                <span>Built for</span>\n                <span className=\"text-amber-500 font-medium\">Australian Tradies</span>\n                <span className=\"mx-1\">­ƒçª­ƒç║</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </footer>\n\n      {/* OVIS Modal */}\n      <OvisModal isOpen={isOvisModalOpen} onClose={() => setIsOvisModalOpen(false)} />\n    </main>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\register\\RegisterPageClient.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":70,"column":9,"nodeType":"JSXOpeningElement","endLine":80,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Footer from \"@/app/components/Footer\";\r\n\r\ntype UserRole = \"tradie\" | \"client\";\r\n\r\ninterface RegisterPageClientProps {\r\n  requireInviteCode: boolean;\r\n}\r\n\r\nexport default function RegisterPageClient({ requireInviteCode }: RegisterPageClientProps) {\r\n  const router = useRouter();\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\r\n  const [inviteCode, setInviteCode] = useState(\"\");\r\n  const [role, setRole] = useState<UserRole>(\"tradie\");\r\n  const [error, setError] = useState(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n\r\n    // Client-side validation\r\n    if (password !== confirmPassword) {\r\n      setError(\"Passwords do not match\");\r\n      return;\r\n    }\r\n\r\n    if (password.length < 8) {\r\n      setError(\"Password must be at least 8 characters\");\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      const response = await fetch(\"/api/auth/register\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ email, password, role, inviteCode: inviteCode.trim() || undefined }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        setError(data.error || \"Registration failed\");\r\n        return;\r\n      }\r\n\r\n      // Success - redirect to dashboard\r\n      router.push(\"/dashboard\");\r\n    } catch {\r\n      setError(\"An unexpected error occurred\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"relative min-h-screen bg-slate-900 overflow-hidden\">\r\n      {/* Hero Background Image */}\r\n      <div className=\"absolute inset-0 w-full h-full\">\r\n        <img\r\n          src=\"/auth-hero-bg.png\"\r\n          alt=\"OMNEXORA - Create your account\"\r\n          className=\"w-full h-full object-cover\"\r\n          style={{ \r\n            objectFit: 'cover',\r\n            objectPosition: 'center',\r\n            minWidth: '100%',\r\n            minHeight: '100%'\r\n          }}\r\n        />\r\n      </div>\r\n      \r\n      {/* Content Overlay */}\r\n      <div className=\"relative z-10 flex flex-col items-center justify-center min-h-screen px-4 py-8\">\r\n        <div className=\"w-full max-w-md\">\r\n          <div className=\"bg-white rounded-xl shadow-lg border border-slate-200 p-6 sm:p-8\">\r\n          <div className=\"text-center mb-8\">\r\n            <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Create Account</h1>\r\n            <p className=\"text-sm text-slate-600\">Start creating job packs and quotes today</p>\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n            {error && (\r\n              <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            {/* Role Selection */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-3\">\r\n                I am a...\r\n              </label>\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setRole(\"tradie\")}\r\n                  disabled={isLoading}\r\n                  className={`p-4 border-2 rounded-lg text-center transition-all focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${\r\n                    role === \"tradie\"\r\n                      ? \"border-amber-500 bg-amber-50 text-amber-900\"\r\n                      : \"border-slate-200 bg-white text-slate-600 hover:border-slate-300\"\r\n                  }`}\r\n                >\r\n                  <div className=\"text-2xl mb-1\">­ƒöº</div>\r\n                  <div className=\"font-semibold\">Tradie</div>\r\n                  <div className=\"text-xs text-slate-500\">Create job packs</div>\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setRole(\"client\")}\r\n                  disabled={isLoading}\r\n                  className={`p-4 border-2 rounded-lg text-center transition-all focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${\r\n                    role === \"client\"\r\n                      ? \"border-amber-500 bg-amber-50 text-amber-900\"\r\n                      : \"border-slate-200 bg-white text-slate-600 hover:border-slate-300\"\r\n                  }`}\r\n                >\r\n                  <div className=\"text-2xl mb-1\">­ƒÅá</div>\r\n                  <div className=\"font-semibold\">Client</div>\r\n                  <div className=\"text-xs text-slate-500\">Request work</div>\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Invite Code Field - shown when invite-only mode */}\r\n            {requireInviteCode && (\r\n              <div>\r\n                <label htmlFor=\"inviteCode\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                  Invite Code <span className=\"text-red-500\">*</span>\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  id=\"inviteCode\"\r\n                  value={inviteCode}\r\n                  onChange={(e) => setInviteCode(e.target.value)}\r\n                  placeholder=\"Enter your invite code\"\r\n                  className=\"w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors disabled:bg-slate-50 disabled:cursor-not-allowed\"\r\n                  required={requireInviteCode}\r\n                  disabled={isLoading}\r\n                />\r\n                <p className=\"mt-1 text-xs text-slate-500\">Required for registration</p>\r\n              </div>\r\n            )}\r\n\r\n            <div>\r\n              <label htmlFor=\"email\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Email Address\r\n              </label>\r\n              <input\r\n                type=\"email\"\r\n                id=\"email\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n                placeholder=\"you@example.com\"\r\n                className=\"w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors disabled:bg-slate-50 disabled:cursor-not-allowed\"\r\n                required\r\n                disabled={isLoading}\r\n              />\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"password\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Password\r\n              </label>\r\n              <input\r\n                type=\"password\"\r\n                id=\"password\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                className=\"w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors disabled:bg-slate-50 disabled:cursor-not-allowed\"\r\n                required\r\n                minLength={8}\r\n                disabled={isLoading}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-500\">Must be at least 8 characters</p>\r\n            </div>\r\n            <div>\r\n              <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium text-slate-700 mb-2\">\r\n                Confirm Password\r\n              </label>\r\n              <input\r\n                type=\"password\"\r\n                id=\"confirmPassword\"\r\n                value={confirmPassword}\r\n                onChange={(e) => setConfirmPassword(e.target.value)}\r\n                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                className=\"w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors disabled:bg-slate-50 disabled:cursor-not-allowed\"\r\n                required\r\n                minLength={8}\r\n                disabled={isLoading}\r\n              />\r\n            </div>\r\n            <button\r\n              type=\"submit\"\r\n              className=\"w-full px-4 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors shadow-lg shadow-amber-500/25 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              disabled={isLoading}\r\n            >\r\n              {isLoading ? \"Creating Account...\" : \"Create Account\"}\r\n            </button>\r\n          </form>\r\n\r\n          <div className=\"mt-6 pt-6 border-t border-slate-200 text-center\">\r\n            <p className=\"text-sm text-slate-600\">\r\n              Already have an account?{\" \"}\r\n              <Link href=\"/login\" className=\"font-semibold text-amber-600 hover:text-amber-500 transition-colors\">\r\n                Sign in\r\n              </Link>\r\n            </p>\r\n          </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <Footer />\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\register\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":15,"column":11,"nodeType":"JSXOpeningElement","endLine":25,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { getSignupMode } from \"@/lib/signup-config\";\r\nimport RegisterPageClient from \"./RegisterPageClient\";\r\nimport Footer from \"@/app/components/Footer\";\r\n\r\nexport default async function RegisterPage() {\r\n  const signupMode = getSignupMode();\r\n\r\n  // If signup is closed, show message instead of form\r\n  if (signupMode === \"closed\") {\r\n    return (\r\n      <div className=\"relative min-h-screen bg-slate-900 overflow-hidden\">\r\n        {/* Hero Background Image */}\r\n        <div className=\"absolute inset-0 w-full h-full\">\r\n          <img\r\n            src=\"/auth-hero-bg.png\"\r\n            alt=\"OMNEXORA - Registrations Closed\"\r\n            className=\"w-full h-full object-cover\"\r\n            style={{ \r\n              objectFit: 'cover',\r\n              objectPosition: 'center',\r\n              minWidth: '100%',\r\n              minHeight: '100%'\r\n            }}\r\n          />\r\n        </div>\r\n        \r\n        {/* Content Overlay */}\r\n        <div className=\"relative z-10 flex flex-col items-center justify-center min-h-screen px-4 py-8\">\r\n          <div className=\"w-full max-w-md\">\r\n            <div className=\"bg-white rounded-xl shadow-lg border border-slate-200 p-6 sm:p-8 text-center\">\r\n              <h1 className=\"text-2xl font-bold text-slate-900 mb-4\">Registrations Closed</h1>\r\n              <p className=\"text-slate-600 mb-6\">\r\n                Registrations are currently closed. Please contact support.\r\n              </p>\r\n              <Link\r\n                href=\"/login\"\r\n                className=\"inline-block px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors\"\r\n              >\r\n                Sign In\r\n              </Link>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <Footer />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Otherwise, render the registration form (invite-only or open)\r\n  const requireInviteCode = signupMode === \"invite-only\";\r\n  return <RegisterPageClient requireInviteCode={requireInviteCode} />;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\reset-password\\page.tsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/set-state-in-effect').","line":19,"column":3,"severity":1,"nodeType":null,"fix":{"range":[617,710],"text":" "}},{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\reset-password\\page.tsx:22:7\n  20 |   useEffect(() => {\n  21 |     if (!token) {\n> 22 |       setError(\"Invalid or missing reset token. Please request a new password reset link.\");\n     |       ^^^^^^^^ Avoid calling setState() directly within an effect\n  23 |     }\n  24 |   }, [token]);\n  25 |","line":22,"column":7,"nodeType":null,"endLine":22,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\n\nimport { useState, useEffect, Suspense } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { Loader2, Check, X } from \"lucide-react\";\n\nfunction ResetPasswordForm() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const token = searchParams.get(\"token\");\n\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n\n  // eslint-disable-next-line react-hooks/set-state-in-effect -- Intentional initial validation\n  useEffect(() => {\n    if (!token) {\n      setError(\"Invalid or missing reset token. Please request a new password reset link.\");\n    }\n  }, [token]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n\n    if (!token) {\n      setError(\"Invalid or missing reset token\");\n      return;\n    }\n\n    if (password.length < 8) {\n      setError(\"Password must be at least 8 characters long\");\n      return;\n    }\n\n    if (password !== confirmPassword) {\n      setError(\"Passwords do not match\");\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/reset-password\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ token, password, confirmPassword }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        setError(data.error || \"Failed to reset password\");\n        setIsLoading(false);\n        return;\n      }\n\n      setSuccess(true);\n      setIsLoading(false);\n\n      // Redirect to login after 2 seconds\n      setTimeout(() => {\n        router.push(\"/login?reset=success\");\n      }, 2000);\n    } catch {\n      setError(\"An unexpected error occurred\");\n      setIsLoading(false);\n    }\n  };\n\n  if (!token) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] px-4\">\n        <div className=\"w-full max-w-md\">\n          <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 p-8\">\n            <div className=\"text-center mb-8\">\n              <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Invalid Reset Link</h1>\n              <p className=\"text-slate-600 mb-6\">\n                This password reset link is invalid or has expired. Please request a new one.\n              </p>\n              <Link\n                href=\"/forgot-password\"\n                className=\"inline-block px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors\"\n              >\n                Request New Reset Link\n              </Link>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (success) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] px-4\">\n        <div className=\"w-full max-w-md\">\n          <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 p-8\">\n            <div className=\"text-center\">\n              <div className=\"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Check className=\"w-8 h-8 text-green-600\" />\n              </div>\n              <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Password Reset Successful</h1>\n              <p className=\"text-slate-600 mb-6\">\n                Your password has been reset. Redirecting to login...\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] px-4\">\n      <div className=\"w-full max-w-md\">\n        <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 p-8\">\n          <div className=\"text-center mb-8\">\n            <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Reset Your Password</h1>\n            <p className=\"text-slate-600\">Enter your new password below.</p>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            {error && (\n              <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm flex items-start gap-2\">\n                <X className=\"w-5 h-5 flex-shrink-0 mt-0.5\" />\n                <span>{error}</span>\n              </div>\n            )}\n\n            <div>\n              <label htmlFor=\"password\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                New Password\n              </label>\n              <input\n                type=\"password\"\n                id=\"password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\n                required\n                disabled={isLoading}\n                minLength={8}\n              />\n              <p className=\"mt-1 text-xs text-slate-500\">Must be at least 8 characters long</p>\n            </div>\n\n            <div>\n              <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n                Confirm New Password\n              </label>\n              <input\n                type=\"password\"\n                id=\"confirmPassword\"\n                value={confirmPassword}\n                onChange={(e) => setConfirmPassword(e.target.value)}\n                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\n                className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-colors\"\n                required\n                disabled={isLoading}\n                minLength={8}\n              />\n            </div>\n\n            <button\n              type=\"submit\"\n              className=\"w-full px-4 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n              disabled={isLoading}\n            >\n              {isLoading ? (\n                <span className=\"flex items-center justify-center\">\n                  <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n                  Resetting...\n                </span>\n              ) : (\n                \"Reset Password\"\n              )}\n            </button>\n          </form>\n\n          <div className=\"mt-8 pt-6 border-t border-slate-200 text-center\">\n            <p className=\"text-sm text-slate-600\">\n              Remember your password?{\" \"}\n              <Link href=\"/login\" className=\"font-semibold text-amber-600 hover:text-amber-500\">\n                Sign in\n              </Link>\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function ResetPasswordPage() {\n  return (\n    <Suspense fallback={\n      <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] px-4\">\n        <div className=\"w-full max-w-md\">\n          <div className=\"bg-white rounded-2xl shadow-xl border border-slate-200 p-8\">\n            <div className=\"text-center\">\n              <p className=\"text-slate-600\">Loading...</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    }>\n      <ResetPasswordForm />\n    </Suspense>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\business-profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\business-rates\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\materials\\MaterialsLibraryClient.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMaterials'. Either include it or remove the dependency array.","line":38,"column":6,"nodeType":"ArrayExpression","endLine":38,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchMaterials]","fix":{"range":[1036,1038],"text":"[fetchMaterials]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'editingId', 'fetchMaterials', and 'showAddForm'. Either include them or remove the dependency array.","line":69,"column":6,"nodeType":"ArrayExpression","endLine":69,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [editingId, fetchMaterials, searchQuery, showAddForm]","fix":{"range":[1897,1910],"text":"[editingId, fetchMaterials, searchQuery, showAddForm]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Plus, Search, Edit2, Trash2, X, Save } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\n\r\ninterface MaterialItem {\r\n  id: string;\r\n  name: string;\r\n  category: string | null;\r\n  supplier: string | null;\r\n  unitLabel: string;\r\n  unitCost: number | null;\r\n  notes: string | null;\r\n  isArchived: boolean;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport default function MaterialsLibraryClient() {\r\n  const [materials, setMaterials] = useState<MaterialItem[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState(\"\");\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [showAddForm, setShowAddForm] = useState(false);\r\n  const [editingId, setEditingId] = useState<string | null>(null);\r\n  const [formData, setFormData] = useState({\r\n    name: \"\",\r\n    category: \"\",\r\n    supplier: \"\",\r\n    unitLabel: \"\",\r\n    unitCost: \"\",\r\n    notes: \"\",\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchMaterials();\r\n  }, []);\r\n\r\n  const fetchMaterials = async () => {\r\n    try {\r\n      setIsLoading(true);\r\n      const params = new URLSearchParams();\r\n      if (searchQuery) params.set(\"search\", searchQuery);\r\n      params.set(\"includeArchived\", \"false\");\r\n\r\n      const response = await fetch(`/api/materials?${params.toString()}`);\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch materials\");\r\n      }\r\n\r\n      const data = await response.json();\r\n      setMaterials(data.materials || []);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to load materials\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const timeoutId = setTimeout(() => {\r\n      if (!showAddForm && !editingId) {\r\n        fetchMaterials();\r\n      }\r\n    }, 300);\r\n\r\n    return () => clearTimeout(timeoutId);\r\n  }, [searchQuery]);\r\n\r\n  const handleAdd = async () => {\r\n    if (!formData.name || !formData.unitLabel) {\r\n      setError(\"Name and unit label are required\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(\"/api/materials\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          name: formData.name,\r\n          category: formData.category || null,\r\n          supplier: formData.supplier || null,\r\n          unitLabel: formData.unitLabel,\r\n          unitCost: formData.unitCost ? parseFloat(formData.unitCost) : null,\r\n          notes: formData.notes || null,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to create material\");\r\n      }\r\n\r\n      setFormData({\r\n        name: \"\",\r\n        category: \"\",\r\n        supplier: \"\",\r\n        unitLabel: \"\",\r\n        unitCost: \"\",\r\n        notes: \"\",\r\n      });\r\n      setShowAddForm(false);\r\n      fetchMaterials();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to create material\");\r\n    }\r\n  };\r\n\r\n  const handleEdit = (material: MaterialItem) => {\r\n    setEditingId(material.id);\r\n    setFormData({\r\n      name: material.name,\r\n      category: material.category || \"\",\r\n      supplier: material.supplier || \"\",\r\n      unitLabel: material.unitLabel,\r\n      unitCost: material.unitCost?.toString() || \"\",\r\n      notes: material.notes || \"\",\r\n    });\r\n  };\r\n\r\n  const handleUpdate = async () => {\r\n    if (!editingId || !formData.name || !formData.unitLabel) {\r\n      setError(\"Name and unit label are required\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`/api/materials/${editingId}`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          name: formData.name,\r\n          category: formData.category || null,\r\n          supplier: formData.supplier || null,\r\n          unitLabel: formData.unitLabel,\r\n          unitCost: formData.unitCost ? parseFloat(formData.unitCost) : null,\r\n          notes: formData.notes || null,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to update material\");\r\n      }\r\n\r\n      setEditingId(null);\r\n      setFormData({\r\n        name: \"\",\r\n        category: \"\",\r\n        supplier: \"\",\r\n        unitLabel: \"\",\r\n        unitCost: \"\",\r\n        notes: \"\",\r\n      });\r\n      fetchMaterials();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to update material\");\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"Archive this material? It will be hidden but can be restored.\")) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`/api/materials/${id}`, {\r\n        method: \"DELETE\",\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to archive material\");\r\n      }\r\n\r\n      fetchMaterials();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to archive material\");\r\n    }\r\n  };\r\n\r\n  const cancelEdit = () => {\r\n    setEditingId(null);\r\n    setShowAddForm(false);\r\n    setFormData({\r\n      name: \"\",\r\n      category: \"\",\r\n      supplier: \"\",\r\n      unitLabel: \"\",\r\n      unitCost: \"\",\r\n      notes: \"\",\r\n    });\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-6xl mx-auto px-4 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <div>\r\n            <h1 className=\"text-2xl font-bold text-slate-900\">Materials Library</h1>\r\n            <p className=\"mt-2 text-slate-600\">\r\n              Manage your materials library for quick access when creating job quotes.\r\n            </p>\r\n          </div>\r\n          <Link\r\n            href=\"/settings\"\r\n            className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-slate-900\"\r\n          >\r\n            ÔåÉ Back to Settings\r\n          </Link>\r\n        </div>\r\n      </div>\r\n\r\n      {error && (\r\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\r\n          {error}\r\n          <button\r\n            onClick={() => setError(\"\")}\r\n            className=\"ml-2 text-red-500 hover:text-red-700\"\r\n          >\r\n            Ô£ò\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Search and Add */}\r\n      <div className=\"mb-6 flex gap-4\">\r\n        <div className=\"flex-1 relative\">\r\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400\" />\r\n          <input\r\n            type=\"text\"\r\n            placeholder=\"Search materials...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n          />\r\n        </div>\r\n        <button\r\n          onClick={() => {\r\n            setShowAddForm(true);\r\n            setEditingId(null);\r\n          }}\r\n          className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors\"\r\n        >\r\n          <Plus className=\"w-5 h-5\" />\r\n          Add Material\r\n        </button>\r\n      </div>\r\n\r\n      {/* Add/Edit Form */}\r\n      {(showAddForm || editingId) && (\r\n        <div className=\"mb-6 p-6 bg-white border border-slate-200 rounded-xl shadow-sm\">\r\n          <div className=\"flex items-center justify-between mb-4\">\r\n            <h2 className=\"text-lg font-semibold text-slate-900\">\r\n              {editingId ? \"Edit Material\" : \"Add New Material\"}\r\n            </h2>\r\n            <button\r\n              onClick={cancelEdit}\r\n              className=\"text-slate-400 hover:text-slate-600\"\r\n            >\r\n              <X className=\"w-5 h-5\" />\r\n            </button>\r\n          </div>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                Name <span className=\"text-red-500\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.name}\r\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                placeholder=\"e.g. Dulux Wash & Wear Low Sheen White\"\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                Category\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.category}\r\n                onChange={(e) => setFormData({ ...formData, category: e.target.value })}\r\n                placeholder=\"e.g. Paint, Primer, Filler\"\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                Supplier\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.supplier}\r\n                onChange={(e) => setFormData({ ...formData, supplier: e.target.value })}\r\n                placeholder=\"e.g. Paint Place, Bunnings\"\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                Unit Label <span className=\"text-red-500\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={formData.unitLabel}\r\n                onChange={(e) => setFormData({ ...formData, unitLabel: e.target.value })}\r\n                placeholder=\"e.g. Litre, 4L can, Each\"\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                Unit Cost ($)\r\n              </label>\r\n              <input\r\n                type=\"number\"\r\n                step=\"0.01\"\r\n                value={formData.unitCost}\r\n                onChange={(e) => setFormData({ ...formData, unitCost: e.target.value })}\r\n                placeholder=\"0.00\"\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              />\r\n            </div>\r\n            <div className=\"md:col-span-2\">\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                Notes\r\n              </label>\r\n              <textarea\r\n                value={formData.notes}\r\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\r\n                placeholder=\"Additional notes (finish, base, etc.)\"\r\n                rows={2}\r\n                className=\"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\r\n              />\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-4 flex justify-end gap-3\">\r\n            <button\r\n              onClick={cancelEdit}\r\n              className=\"px-4 py-2 text-sm font-medium text-slate-700 hover:text-slate-900\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              onClick={editingId ? handleUpdate : handleAdd}\r\n              className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors\"\r\n            >\r\n              <Save className=\"w-4 h-4\" />\r\n              {editingId ? \"Update\" : \"Add\"} Material\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Materials Table */}\r\n      {isLoading ? (\r\n        <div className=\"text-center py-12\">\r\n          <div className=\"text-slate-500\">Loading materials...</div>\r\n        </div>\r\n      ) : materials.length === 0 ? (\r\n        <div className=\"bg-white rounded-xl border border-slate-200 p-12 text-center\">\r\n          <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n            <Plus className=\"w-8 h-8 text-slate-400\" />\r\n          </div>\r\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-2\">No materials yet</h2>\r\n          <p className=\"text-slate-600 mb-6\">\r\n            {searchQuery\r\n              ? \"No materials match your search. Try different keywords.\"\r\n              : \"Start building your materials library by adding your first material.\"}\r\n          </p>\r\n          {!searchQuery && (\r\n            <button\r\n              onClick={() => setShowAddForm(true)}\r\n              className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors\"\r\n            >\r\n              <Plus className=\"w-5 h-5\" />\r\n              Add Your First Material\r\n            </button>\r\n          )}\r\n        </div>\r\n      ) : (\r\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead className=\"bg-slate-50 border-b border-slate-200\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\r\n                    Name\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\r\n                    Category\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\r\n                    Supplier\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\r\n                    Unit\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\r\n                    Unit Cost\r\n                  </th>\r\n                  <th className=\"px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider\">\r\n                    Actions\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"divide-y divide-slate-200\">\r\n                {materials.map((material) => (\r\n                  <tr key={material.id} className=\"hover:bg-slate-50\">\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"text-sm font-medium text-slate-900\">{material.name}</div>\r\n                      {material.notes && (\r\n                        <div className=\"text-xs text-slate-500 mt-1\">{material.notes}</div>\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 text-sm text-slate-600\">\r\n                      {material.category || \"ÔÇö\"}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 text-sm text-slate-600\">\r\n                      {material.supplier || \"ÔÇö\"}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 text-sm text-slate-600\">\r\n                      {material.unitLabel}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 text-sm text-slate-600\">\r\n                      {material.unitCost != null ? `$${material.unitCost.toFixed(2)}` : \"ÔÇö\"}\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <button\r\n                          onClick={() => handleEdit(material)}\r\n                          className=\"text-amber-600 hover:text-amber-700\"\r\n                          title=\"Edit\"\r\n                        >\r\n                          <Edit2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <button\r\n                          onClick={() => handleDelete(material.id)}\r\n                          className=\"text-red-600 hover:text-red-700\"\r\n                          title=\"Archive\"\r\n                        >\r\n                          <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\materials\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":168,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":168,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { featureFlags } from \"@/lib/featureFlags\";\n\ninterface UserInfo {\n  email: string;\n  emailVerifiedAt: string | null;\n  verificationStatus: string | null;\n  role: string | null;\n}\n\nexport default function SettingsPage() {\n  const router = useRouter();\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState(\"\");\n  const [userInfo, setUserInfo] = useState<UserInfo | null>(null);\n\n  // Fetch current user info on mount\n  useEffect(() => {\n    async function fetchSettings() {\n      try {\n        const response = await fetch(\"/api/settings\");\n        if (response.ok) {\n          const data = await response.json();\n          setUserInfo({\n            email: data.user.email,\n            emailVerifiedAt: data.user.emailVerifiedAt || null,\n            verificationStatus: data.user.verificationStatus || null,\n            role: data.user.role || null,\n          });\n        } else if (response.status === 401) {\n          router.push(\"/login\");\n        }\n      } catch {\n        setError(\"Failed to load settings\");\n      } finally {\n        setIsLoading(false);\n      }\n    }\n    fetchSettings();\n  }, [router]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[calc(100vh-4rem)]\">\n        <div className=\"text-slate-500\">Loading...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"max-w-2xl mx-auto px-4 py-8\">\n      {/* Header */}\n      <div className=\"mb-8\">\n        <Link\n          href=\"/dashboard\"\n          className=\"inline-flex items-center text-sm text-slate-600 hover:text-slate-900 mb-4\"\n        >\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n          </svg>\n          Back to Dashboard\n        </Link>\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">\n          {userInfo?.role === \"client\" ? \"Client Profile\" : \"Settings\"}\n        </h1>\n        <p className=\"text-slate-600\">\n          {userInfo?.role === \"client\" \n            ? \"Manage your client profile and account settings.\"\n            : \"Manage your account settings and preferences for the Australian construction industry.\"}\n        </p>\n      </div>\n\n      {/* Navigation Tabs - Different for clients vs tradies */}\n      {userInfo?.role !== \"client\" && (\n        <div className=\"mb-6 flex gap-1 border-b border-slate-200 overflow-x-auto\">\n          <Link\n            href=\"/settings/business-profile\"\n            className=\"px-4 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-900 whitespace-nowrap transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 rounded-t\"\n          >\n            Business Profile\n          </Link>\n          <Link\n            href=\"/settings\"\n            className=\"px-4 py-2.5 text-sm font-medium text-amber-600 border-b-2 border-amber-500 whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 rounded-t\"\n          >\n            Settings\n          </Link>\n          {featureFlags.showRateTemplates && (\n            <Link\n              href=\"/settings/rates\"\n              className=\"px-4 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-900 whitespace-nowrap transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 rounded-t\"\n            >\n              Rate Templates\n            </Link>\n          )}\n          {featureFlags.showMaterials && (\n            <Link\n              href=\"/settings/materials\"\n              className=\"px-4 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-900 whitespace-nowrap transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 rounded-t\"\n            >\n              Materials\n            </Link>\n          )}\n          <Link\n            href=\"/settings/verification\"\n            className=\"px-4 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-900 whitespace-nowrap transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 rounded-t\"\n          >\n            Verification\n          </Link>\n          {featureFlags.showSignature && (\n            <Link\n              href=\"/settings/signature\"\n              className=\"px-4 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-900 whitespace-nowrap transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 rounded-t\"\n            >\n              Signature\n            </Link>\n          )}\n        </div>\n      )}\n\n      {/* Error Message */}\n      {error && (\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\n          {error}\n        </div>\n      )}\n\n      {/* Account Info Card */}\n      {userInfo && (\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-4\">Account</h2>\n          <div className=\"space-y-3\">\n            <div>\n              <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Email</label>\n              <p className=\"mt-1 text-sm text-slate-900\">{userInfo.email}</p>\n            </div>\n            <div>\n              <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Email Verification</label>\n              <div className=\"mt-1\">\n                {userInfo.emailVerifiedAt ? (\n                  <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-300\">\n                    Ô£ô Verified\n                  </span>\n                ) : (\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700 border border-amber-300\">\n                      <svg className=\"w-3 h-3 mr-1\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z\" clipRule=\"evenodd\" />\n                      </svg>\n                      Pending\n                    </span>\n                    <button\n                      onClick={async () => {\n                        try {\n                          const response = await fetch(\"/api/auth/send-verification-email\", {\n                            method: \"POST\",\n                          });\n                          if (response.ok) {\n                            alert(\"Verification email sent! Check your inbox.\");\n                          } else {\n                            const data = await response.json();\n                            alert(data.error || \"Failed to send verification email\");\n                          }\n                        } catch (err) {\n                          alert(\"Failed to send verification email\");\n                        }\n                      }}\n                      className=\"text-xs text-amber-600 hover:text-amber-700 font-medium underline\"\n                    >\n                      Resend verification email\n                    </button>\n                  </div>\n                )}\n              </div>\n            </div>\n            {/* Admin Verification - Only for tradies */}\n            {userInfo.role !== \"client\" && (\n              <div>\n                <label className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider\">Business Verification</label>\n                <div className=\"mt-1\">\n                  {userInfo.verificationStatus === \"verified\" ? (\n                    <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700 border border-emerald-300\">\n                      <svg className=\"w-3 h-3 mr-1\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                      </svg>\n                      Verified\n                    </span>\n                  ) : userInfo.verificationStatus === \"pending\" || userInfo.verificationStatus === \"pending_review\" ? (\n                    <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700 border border-amber-300\">\n                      <svg className=\"w-3 h-3 mr-1\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z\" clipRule=\"evenodd\" />\n                      </svg>\n                      Pending Review\n                    </span>\n                  ) : (\n                    <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600 border border-slate-300\">\n                      <svg className=\"w-3 h-3 mr-1\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\n                      </svg>\n                      Not verified yet\n                    </span>\n                  )}\n                </div>\n                <p className=\"mt-1 text-xs text-slate-500\">\n                  Verified profiles help clients trust you. Submit your verification documents in the{\" \"}\n                  <Link href=\"/settings/verification\" className=\"text-amber-600 hover:text-amber-700 underline\">\n                    Verification\n                  </Link>{\" \"}\n                  section to get verified.\n                </p>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* Info Card - Only for tradies */}\n      {userInfo?.role !== \"client\" && (\n        <div className=\"mt-6 bg-amber-50 border border-amber-200 rounded-xl p-6\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <h3 className=\"text-sm font-semibold text-amber-900 mb-1\">Business Settings</h3>\n              <p className=\"text-sm text-amber-800\">\n                All business profile, pricing, and rates settings for Australian construction trades have been consolidated into the{\" \"}\n                <Link href=\"/settings/business-profile\" className=\"font-medium underline hover:text-amber-900\">\n                  Business Profile\n                </Link>{\" \"}\n                page for easier management.\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\rates\\RateTemplatesClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\rates\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\signature\\SignaturePageClient.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":270,"column":13,"nodeType":"JSXOpeningElement","endLine":274,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { Loader2, Check, X } from \"lucide-react\";\r\n\r\nexport default function SignaturePageClient() {\r\n  const router = useRouter();\r\n  const canvasRef = useRef<HTMLCanvasElement>(null);\r\n  const [isDrawing, setIsDrawing] = useState(false);\r\n  const [signatureImage, setSignatureImage] = useState<string | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  // Load existing signature\r\n  useEffect(() => {\r\n    async function fetchSignature() {\r\n      try {\r\n        const response = await fetch(\"/api/settings/signature\");\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          if (data.success && data.signatureImage) {\r\n            setSignatureImage(data.signatureImage);\r\n            // Load image onto canvas\r\n            const canvas = canvasRef.current;\r\n            if (canvas) {\r\n              const ctx = canvas.getContext(\"2d\");\r\n              if (ctx) {\r\n                const img = new Image();\r\n                img.onload = () => {\r\n                  ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n                };\r\n                img.src = data.signatureImage;\r\n              }\r\n            }\r\n          }\r\n        } else if (response.status === 401) {\r\n          router.push(\"/login\");\r\n        }\r\n      } catch {\r\n        setError(\"Failed to load signature\");\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n    fetchSignature();\r\n  }, [router]);\r\n\r\n  // Initialize canvas\r\n  useEffect(() => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    // Set canvas size\r\n    canvas.width = 600;\r\n    canvas.height = 200;\r\n\r\n    // Set drawing style\r\n    ctx.strokeStyle = \"#1e293b\"; // slate-800\r\n    ctx.lineWidth = 2;\r\n    ctx.lineCap = \"round\";\r\n    ctx.lineJoin = \"round\";\r\n  }, []);\r\n\r\n  const startDrawing = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\r\n    setIsDrawing(true);\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = \"touches\" in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;\r\n    const y = \"touches\" in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(x, y);\r\n  };\r\n\r\n  const draw = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\r\n    if (!isDrawing) return;\r\n\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = \"touches\" in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;\r\n    const y = \"touches\" in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;\r\n\r\n    ctx.lineTo(x, y);\r\n    ctx.stroke();\r\n  };\r\n\r\n  const stopDrawing = () => {\r\n    setIsDrawing(false);\r\n  };\r\n\r\n  const clearCanvas = () => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    setSignatureImage(null);\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    // Check if canvas is empty\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    const isEmpty = imageData.data.every((channel) => channel === 0);\r\n\r\n    if (isEmpty) {\r\n      setError(\"Please draw your signature before saving\");\r\n      return;\r\n    }\r\n\r\n    setIsSaving(true);\r\n    setError(\"\");\r\n    setSuccess(false);\r\n\r\n    try {\r\n      const dataUrl = canvas.toDataURL(\"image/png\");\r\n      const response = await fetch(\"/api/settings/signature\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ dataUrl }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Failed to save signature\");\r\n      }\r\n\r\n      const data = await response.json();\r\n      if (data.success) {\r\n        setSignatureImage(data.signatureImage);\r\n        setSuccess(true);\r\n        setTimeout(() => setSuccess(false), 3000);\r\n      } else {\r\n        throw new Error(\"Invalid response from server\");\r\n      }\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Failed to save signature\");\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"max-w-2xl mx-auto px-4 py-8\">\r\n        <div className=\"flex items-center justify-center py-12\">\r\n          <Loader2 className=\"w-8 h-8 text-amber-500 animate-spin\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-2xl mx-auto px-4 py-8\">\r\n      {/* Header */}\r\n      <div className=\"mb-8\">\r\n        <Link\r\n          href=\"/settings\"\r\n          className=\"inline-flex items-center text-sm text-slate-600 hover:text-slate-900 mb-4\"\r\n        >\r\n          <svg className=\"w-4 h-4 mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n          </svg>\r\n          Back to Settings\r\n        </Link>\r\n        <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">Digital Signature</h1>\r\n        <p className=\"text-slate-600\">\r\n          Draw your signature below. It will be used on quotes, job packs, and other documents.\r\n        </p>\r\n      </div>\r\n\r\n      {/* Success Message */}\r\n      {success && (\r\n        <div className=\"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2 text-green-700\">\r\n          <Check className=\"w-5 h-5\" />\r\n          <span>Signature saved successfully!</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Error Message */}\r\n      {error && (\r\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700\">\r\n          <X className=\"w-5 h-5\" />\r\n          <span>{error}</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Signature Canvas */}\r\n      <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6\">\r\n        <div className=\"mb-4\">\r\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-2\">Draw Your Signature</h2>\r\n          <p className=\"text-sm text-slate-600\">\r\n            Use your mouse or touch screen to draw your signature in the box below.\r\n          </p>\r\n        </div>\r\n\r\n        <div className=\"border-2 border-slate-300 rounded-lg bg-white overflow-hidden\">\r\n          <canvas\r\n            ref={canvasRef}\r\n            onMouseDown={startDrawing}\r\n            onMouseMove={draw}\r\n            onMouseUp={stopDrawing}\r\n            onMouseLeave={stopDrawing}\r\n            onTouchStart={startDrawing}\r\n            onTouchMove={draw}\r\n            onTouchEnd={stopDrawing}\r\n            className=\"w-full cursor-crosshair touch-none\"\r\n            style={{ height: \"200px\" }}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"mt-4 flex items-center gap-3\">\r\n          <button\r\n            onClick={handleSave}\r\n            disabled={isSaving}\r\n            className=\"inline-flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            {isSaving ? (\r\n              <>\r\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                Saving...\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Check className=\"w-4 h-4 mr-2\" />\r\n                Save Signature\r\n              </>\r\n            )}\r\n          </button>\r\n          <button\r\n            onClick={clearCanvas}\r\n            disabled={isSaving}\r\n            className=\"inline-flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors\"\r\n          >\r\n            <X className=\"w-4 h-4 mr-2\" />\r\n            Clear\r\n          </button>\r\n        </div>\r\n\r\n        {signatureImage && (\r\n          <div className=\"mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200\">\r\n            <p className=\"text-sm font-medium text-slate-700 mb-2\">Current Signature Preview:</p>\r\n            <img\r\n              src={signatureImage}\r\n              alt=\"Signature preview\"\r\n              className=\"max-w-full h-auto border border-slate-300 rounded bg-white p-2\"\r\n            />\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\signature\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\settings\\verification\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isClient' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { isClient } from \"@/lib/auth\";\n\ninterface VerificationData {\n  status: string;\n  businessName: string | null;\n  abn: string | null;\n  primaryTrade: string | null;\n  workTypes: string | null;\n  licenceNumber: string | null;\n  licenceType: string | null;\n  licenceExpiry: string | null;\n  insuranceProvider: string | null;\n  insurancePolicyNumber: string | null;\n  insuranceExpiry: string | null;\n  insuranceCoverageNotes: string | null;\n  abnEvidenceUrl: string | null;\n  licenceEvidenceUrl: string | null;\n  insuranceEvidenceUrl: string | null;\n  rejectionReason: string | null;\n}\n\ninterface UserData {\n  email: string;\n  role: string;\n}\n\nexport default function VerificationPage() {\n  const router = useRouter();\n  const [userData, setUserData] = useState<UserData | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n  const [verification, setVerification] = useState<VerificationData | null>(null);\n  const [formData, setFormData] = useState({\n    businessName: \"\",\n    abn: \"\",\n    primaryTrade: \"\",\n    workTypes: \"\",\n    licenceNumber: \"\",\n    licenceType: \"\",\n    licenceExpiry: \"\",\n    insuranceProvider: \"\",\n    insurancePolicyNumber: \"\",\n    insuranceExpiry: \"\",\n    insuranceCoverageNotes: \"\",\n    abnEvidenceUrl: \"\",\n    licenceEvidenceUrl: \"\",\n    insuranceEvidenceUrl: \"\",\n  });\n\n  // Fetch user and verification data on mount\n  useEffect(() => {\n    async function fetchData() {\n      try {\n        const userResponse = await fetch(\"/api/auth/me\");\n        if (!userResponse.ok) {\n          router.push(\"/login\");\n          return;\n        }\n        const userData = await userResponse.json();\n        setUserData(userData.user);\n\n        // Clients don't need verification\n        if (userData.user.role === \"client\") {\n          setIsLoading(false);\n          return;\n        }\n\n        // Fetch verification record\n        const verificationResponse = await fetch(\"/api/settings/verification\");\n        if (verificationResponse.ok) {\n          const data = await verificationResponse.json();\n          setVerification(data.verification);\n\n          // Pre-fill form\n          if (data.verification) {\n            setFormData({\n              businessName: data.verification.businessName || \"\",\n              abn: data.verification.abn || \"\",\n              primaryTrade: data.verification.primaryTrade || \"\",\n              workTypes: data.verification.workTypes || \"\",\n              licenceNumber: data.verification.licenceNumber || \"\",\n              licenceType: data.verification.licenceType || \"\",\n              licenceExpiry: data.verification.licenceExpiry ? new Date(data.verification.licenceExpiry).toISOString().split(\"T\")[0] : \"\",\n              insuranceProvider: data.verification.insuranceProvider || \"\",\n              insurancePolicyNumber: data.verification.insurancePolicyNumber || \"\",\n              insuranceExpiry: data.verification.insuranceExpiry ? new Date(data.verification.insuranceExpiry).toISOString().split(\"T\")[0] : \"\",\n              insuranceCoverageNotes: data.verification.insuranceCoverageNotes || \"\",\n              abnEvidenceUrl: data.verification.abnEvidenceUrl || \"\",\n              licenceEvidenceUrl: data.verification.licenceEvidenceUrl || \"\",\n              insuranceEvidenceUrl: data.verification.insuranceEvidenceUrl || \"\",\n            });\n          }\n        }\n      } catch {\n        router.push(\"/login\");\n      } finally {\n        setIsLoading(false);\n      }\n    }\n    fetchData();\n  }, [router]);\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\n    const { name, value, type } = e.target;\n    const checked = (e.target as HTMLInputElement).checked;\n\n    if (type === \"checkbox\") {\n      // Handle work types checkboxes\n      const currentTypes = formData.workTypes.split(\",\").filter((t) => t.trim());\n      if (checked) {\n        if (!currentTypes.includes(name)) {\n          setFormData((prev) => ({\n            ...prev,\n            workTypes: [...currentTypes, name].join(\",\"),\n          }));\n        }\n      } else {\n        setFormData((prev) => ({\n          ...prev,\n          workTypes: currentTypes.filter((t) => t !== name).join(\",\"),\n        }));\n      }\n    } else {\n      setFormData((prev) => ({ ...prev, [name]: value }));\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n    setSuccess(false);\n    setIsSubmitting(true);\n\n    try {\n      const response = await fetch(\"/api/settings/verification\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          ...formData,\n          licenceExpiry: formData.licenceExpiry || null,\n          insuranceExpiry: formData.insuranceExpiry || null,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        setError(data.error || \"Failed to submit verification\");\n        setIsSubmitting(false);\n        return;\n      }\n\n      setSuccess(true);\n      // Reload verification status\n      const verificationResponse = await fetch(\"/api/settings/verification\");\n      if (verificationResponse.ok) {\n        const verificationData = await verificationResponse.json();\n        setVerification(verificationData.verification);\n      }\n      setIsSubmitting(false);\n    } catch {\n      setError(\"An unexpected error occurred\");\n      setIsSubmitting(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[calc(100vh-4rem)]\">\n        <div className=\"text-slate-500\">Loading...</div>\n      </div>\n    );\n  }\n\n  // Clients don't need verification\n  if (userData?.role === \"client\") {\n    return (\n      <div className=\"max-w-2xl mx-auto px-4 py-12\">\n        <div className=\"bg-white rounded-xl border border-slate-200 p-8 text-center\">\n          <h1 className=\"text-xl font-semibold text-slate-900 mb-2\">Not Required</h1>\n          <p className=\"text-slate-600 mb-6\">\n            Business verification is only required for trade/business accounts.\n          </p>\n          <Link\n            href=\"/dashboard\"\n            className=\"inline-flex items-center px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors\"\n          >\n            Back to Dashboard\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  const status = verification?.status || \"unverified\";\n\n  return (\n    <div className=\"max-w-4xl mx-auto px-4 py-8\">\n      {/* Navigation Tabs */}\n      <div className=\"mb-6 flex gap-3 border-b border-slate-200\">\n        <Link\n          href=\"/settings\"\n          className=\"px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900\"\n        >\n          Pricing\n        </Link>\n        <Link\n          href=\"/settings/business-profile\"\n          className=\"px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900\"\n        >\n          Business Profile\n        </Link>\n        <Link\n          href=\"/settings/verification\"\n          className=\"px-4 py-2 text-sm font-medium text-amber-600 border-b-2 border-amber-500\"\n        >\n          Verification\n        </Link>\n      </div>\n\n      {/* Status Banner */}\n      {status === \"verified\" && (\n        <div className=\"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <p className=\"font-medium text-green-900\">Your account is structured.</p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {status === \"pending\" && (\n        <div className=\"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <p className=\"font-medium text-amber-900\">Your verification is being reviewed.</p>\n              <p className=\"text-sm text-amber-700 mt-1\">We&apos;ll notify you once the review is complete.</p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {status === \"rejected\" && (\n        <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <p className=\"font-medium text-red-900\">Your verification was not approved.</p>\n              {verification?.rejectionReason && (\n                <p className=\"text-sm text-red-700 mt-1\">Reason: {verification.rejectionReason}</p>\n              )}\n              <p className=\"text-sm text-red-700 mt-1\">Please update your details and resubmit.</p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {status === \"unverified\" && (\n        <div className=\"mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg\">\n          <div className=\"flex items-start gap-3\">\n            <svg className=\"w-5 h-5 text-slate-600 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n            </svg>\n            <div>\n              <p className=\"font-medium text-slate-900\">You&apos;re not verified yet.</p>\n              <p className=\"text-sm text-slate-700 mt-1\">Verified profiles help clients trust you.</p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Success Message */}\n      {success && (\n        <div className=\"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg\">\n          <p className=\"text-green-800 font-medium\">Verification details submitted. We&apos;ll review them soon.</p>\n        </div>\n      )}\n\n      {/* Form */}\n      <form onSubmit={handleSubmit} className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-6 space-y-8\">\n        {error && (\n          <div className=\"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\n            {error}\n          </div>\n        )}\n\n        {/* Business Details Section */}\n        <div className=\"space-y-4\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">Business Details</h2>\n          \n          <div>\n            <label htmlFor=\"businessName\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Business / Trading Name <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              id=\"businessName\"\n              name=\"businessName\"\n              value={formData.businessName}\n              onChange={handleChange}\n              placeholder=\"e.g. Perth Pro Painters Pty Ltd\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              required\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"abn\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              ABN <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              id=\"abn\"\n              name=\"abn\"\n              value={formData.abn}\n              onChange={handleChange}\n              placeholder=\"e.g. 12 345 678 901\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              required\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"primaryTrade\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Primary Trade <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              id=\"primaryTrade\"\n              name=\"primaryTrade\"\n              value={formData.primaryTrade}\n              onChange={handleChange}\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white\"\n              required\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            >\n              <option value=\"\">Select a trade...</option>\n              <option value=\"Painter\">Painter</option>\n              <option value=\"Plasterer\">Plasterer</option>\n              <option value=\"Carpenter\">Carpenter</option>\n              <option value=\"Electrician\">Electrician</option>\n              <option value=\"Other\">Other</option>\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Work Types <span className=\"text-red-500\">*</span>\n            </label>\n            <div className=\"space-y-2\">\n              <label className=\"flex items-center gap-2\">\n                <input\n                  type=\"checkbox\"\n                  name=\"residential\"\n                  checked={formData.workTypes.includes(\"residential\")}\n                  onChange={handleChange}\n                  className=\"w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\n                  disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n                />\n                <span className=\"text-sm text-slate-700\">Residential</span>\n              </label>\n              <label className=\"flex items-center gap-2\">\n                <input\n                  type=\"checkbox\"\n                  name=\"commercial\"\n                  checked={formData.workTypes.includes(\"commercial\")}\n                  onChange={handleChange}\n                  className=\"w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\n                  disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n                />\n                <span className=\"text-sm text-slate-700\">Commercial</span>\n              </label>\n              <label className=\"flex items-center gap-2\">\n                <input\n                  type=\"checkbox\"\n                  name=\"strata\"\n                  checked={formData.workTypes.includes(\"strata\")}\n                  onChange={handleChange}\n                  className=\"w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500\"\n                  disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n                />\n                <span className=\"text-sm text-slate-700\">Strata</span>\n              </label>\n            </div>\n          </div>\n        </div>\n\n        {/* Licence Details Section */}\n        <div className=\"space-y-4 pt-6 border-t border-slate-200\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">Licence Details</h2>\n          \n          <div>\n            <label htmlFor=\"licenceType\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Licence Type\n            </label>\n            <input\n              type=\"text\"\n              id=\"licenceType\"\n              name=\"licenceType\"\n              value={formData.licenceType}\n              onChange={handleChange}\n              placeholder=\"e.g. Painter's licence, Builder's licence\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"licenceNumber\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Licence Number\n            </label>\n            <input\n              type=\"text\"\n              id=\"licenceNumber\"\n              name=\"licenceNumber\"\n              value={formData.licenceNumber}\n              onChange={handleChange}\n              placeholder=\"e.g. WA12345\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"licenceExpiry\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Licence Expiry Date\n            </label>\n            <input\n              type=\"date\"\n              id=\"licenceExpiry\"\n              name=\"licenceExpiry\"\n              value={formData.licenceExpiry}\n              onChange={handleChange}\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"licenceEvidenceUrl\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Licence Evidence URL\n            </label>\n            <input\n              type=\"url\"\n              id=\"licenceEvidenceUrl\"\n              name=\"licenceEvidenceUrl\"\n              value={formData.licenceEvidenceUrl}\n              onChange={handleChange}\n              placeholder=\"Link to licence file / ASIC search / image\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n            <p className=\"mt-1 text-xs text-slate-500\">Paste a link to your licence document or verification page</p>\n          </div>\n        </div>\n\n        {/* Insurance Details Section */}\n        <div className=\"space-y-4 pt-6 border-t border-slate-200\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">Insurance Details</h2>\n          \n          <div>\n            <label htmlFor=\"insuranceProvider\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Insurance Provider\n            </label>\n            <input\n              type=\"text\"\n              id=\"insuranceProvider\"\n              name=\"insuranceProvider\"\n              value={formData.insuranceProvider}\n              onChange={handleChange}\n              placeholder=\"e.g. QBE, Allianz\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"insurancePolicyNumber\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Policy Number\n            </label>\n            <input\n              type=\"text\"\n              id=\"insurancePolicyNumber\"\n              name=\"insurancePolicyNumber\"\n              value={formData.insurancePolicyNumber}\n              onChange={handleChange}\n              placeholder=\"e.g. PL-123456\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"insuranceExpiry\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Insurance Expiry Date\n            </label>\n            <input\n              type=\"date\"\n              id=\"insuranceExpiry\"\n              name=\"insuranceExpiry\"\n              value={formData.insuranceExpiry}\n              onChange={handleChange}\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"insuranceCoverageNotes\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Coverage Notes\n            </label>\n            <textarea\n              id=\"insuranceCoverageNotes\"\n              name=\"insuranceCoverageNotes\"\n              value={formData.insuranceCoverageNotes}\n              onChange={handleChange}\n              placeholder=\"e.g. Public liability up to $20M\"\n              rows={3}\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none resize-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"insuranceEvidenceUrl\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              Insurance Evidence URL\n            </label>\n            <input\n              type=\"url\"\n              id=\"insuranceEvidenceUrl\"\n              name=\"insuranceEvidenceUrl\"\n              value={formData.insuranceEvidenceUrl}\n              onChange={handleChange}\n              placeholder=\"Link to insurance certificate / document\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n            <p className=\"mt-1 text-xs text-slate-500\">Paste a link to your insurance certificate or document</p>\n          </div>\n        </div>\n\n        {/* ABN Evidence Section */}\n        <div className=\"space-y-4 pt-6 border-t border-slate-200\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">ABN Evidence</h2>\n          \n          <div>\n            <label htmlFor=\"abnEvidenceUrl\" className=\"block text-sm font-medium text-slate-700 mb-2\">\n              ABN Evidence URL\n            </label>\n            <input\n              type=\"url\"\n              id=\"abnEvidenceUrl\"\n              name=\"abnEvidenceUrl\"\n              value={formData.abnEvidenceUrl}\n              onChange={handleChange}\n              placeholder=\"Link to ABN lookup / ASIC / document in Drive\"\n              className=\"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none\"\n              disabled={isSubmitting || status === \"pending\" || status === \"verified\"}\n            />\n            <p className=\"mt-1 text-xs text-slate-500\">Paste a link to ABN lookup result, ASIC record, or uploaded document</p>\n          </div>\n        </div>\n\n        {/* Submit Button */}\n        {(status === \"unverified\" || status === \"rejected\") && (\n          <div className=\"pt-6 border-t border-slate-200\">\n            <button\n              type=\"submit\"\n              disabled={isSubmitting}\n              className=\"w-full px-4 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              {isSubmitting ? \"Submitting...\" : \"Save & Submit for Review\"}\n            </button>\n            <p className=\"mt-3 text-xs text-slate-500 text-center\">\n              By submitting, you confirm that all information provided is accurate and up to date.\n            </p>\n          </div>\n        )}\n\n        {(status === \"pending\" || status === \"verified\") && (\n          <div className=\"pt-6 border-t border-slate-200\">\n            <Link\n              href=\"/dashboard\"\n              className=\"inline-flex items-center px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors\"\n            >\n              Back to Dashboard\n            </Link>\n          </div>\n        )}\n      </form>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\app\\verify-email\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":48,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":48,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":71,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, Suspense } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\n\r\nfunction VerifyEmailForm() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const [status, setStatus] = useState<\"loading\" | \"success\" | \"error\">(\"loading\");\r\n  const [error, setError] = useState(\"\");\r\n  const [isResending, setIsResending] = useState(false);\r\n\r\n  const token = searchParams.get(\"token\");\r\n\r\n  useEffect(() => {\r\n    if (!token) {\r\n      setStatus(\"error\");\r\n      setError(\"Verification link is invalid.\");\r\n      return;\r\n    }\r\n\r\n    // Verify the email\r\n    const verifyEmail = async () => {\r\n      try {\r\n        const response = await fetch(\"/api/auth/verify-email\", {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify({ token }),\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!response.ok) {\r\n          setStatus(\"error\");\r\n          setError(data.error || \"This verification link is invalid or has expired.\");\r\n          return;\r\n        }\r\n\r\n        setStatus(\"success\");\r\n\r\n        // Auto-redirect after 3 seconds\r\n        setTimeout(() => {\r\n          router.push(\"/dashboard\");\r\n        }, 3000);\r\n      } catch (err) {\r\n        setStatus(\"error\");\r\n        setError(\"An unexpected error occurred. Please try again.\");\r\n      }\r\n    };\r\n\r\n    verifyEmail();\r\n  }, [token, router]);\r\n\r\n  const handleResend = async () => {\r\n    setIsResending(true);\r\n    try {\r\n      const response = await fetch(\"/api/auth/send-verification-email\", {\r\n        method: \"POST\",\r\n      });\r\n\r\n      if (!response.ok) {\r\n        setError(\"Failed to resend verification email. Please try again.\");\r\n        return;\r\n      }\r\n\r\n      // Show success message\r\n      alert(\"Verification email sent. Check your inbox (and spam folder).\");\r\n    } catch (err) {\r\n      setError(\"Failed to resend verification email. Please try again.\");\r\n    } finally {\r\n      setIsResending(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] px-4 py-8\">\r\n      <div className=\"w-full max-w-md\">\r\n        <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8\">\r\n          <div className=\"text-center mb-6\">\r\n            <div className=\"w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              {status === \"loading\" && (\r\n                <svg className=\"w-8 h-8 text-amber-500 animate-spin\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\r\n                </svg>\r\n              )}\r\n              {status === \"success\" && (\r\n                <svg className=\"w-8 h-8 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\r\n                </svg>\r\n              )}\r\n              {status === \"error\" && (\r\n                <svg className=\"w-8 h-8 text-red-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                </svg>\r\n              )}\r\n            </div>\r\n            <h1 className=\"text-2xl font-bold text-slate-900 mb-2\">\r\n              {status === \"loading\" && \"Verifying your email...\"}\r\n              {status === \"success\" && \"Email verified!\"}\r\n              {status === \"error\" && \"Verification failed\"}\r\n            </h1>\r\n          </div>\r\n\r\n          {status === \"loading\" && (\r\n            <p className=\"text-slate-600 text-center\">\r\n              Please wait while we verify your email address.\r\n            </p>\r\n          )}\r\n\r\n          {status === \"success\" && (\r\n            <div className=\"text-center space-y-4\">\r\n              <p className=\"text-slate-600\">\r\n                Email verified. You can now use all features of OMNEXORA.\r\n              </p>\r\n              <p className=\"text-sm text-slate-500\">\r\n                Redirecting to your dashboard...\r\n              </p>\r\n              <Link\r\n                href=\"/dashboard\"\r\n                className=\"inline-block mt-4 text-amber-600 hover:text-amber-700 font-medium\"\r\n              >\r\n                Go to dashboard now ÔåÆ\r\n              </Link>\r\n            </div>\r\n          )}\r\n\r\n          {status === \"error\" && (\r\n            <div className=\"space-y-4\">\r\n              <p className=\"text-slate-600 text-center\">\r\n                {error}\r\n              </p>\r\n              <div className=\"pt-4 border-t border-slate-200 space-y-3\">\r\n                <button\r\n                  onClick={handleResend}\r\n                  disabled={isResending}\r\n                  className=\"w-full px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isResending ? \"Sending...\" : \"Resend verification email\"}\r\n                </button>\r\n                <Link\r\n                  href=\"/dashboard\"\r\n                  className=\"block w-full text-center px-4 py-2 text-slate-600 hover:text-slate-900 font-medium\"\r\n                >\r\n                  Go to dashboard\r\n                </Link>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function VerifyEmailPage() {\r\n  return (\r\n    <Suspense fallback={\r\n      <div className=\"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] px-4 py-8\">\r\n        <div className=\"w-full max-w-md\">\r\n          <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm p-8\">\r\n            <div className=\"text-center\">\r\n              <p className=\"text-slate-600\">Loading...</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    }>\r\n      <VerifyEmailForm />\r\n    </Suspense>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\adminDashboard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\analytics.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Job' is defined but never used.","line":1,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getJobsForUser, type Job, type ClientStatus } from \"./jobs\";\r\n\r\nexport type UserJobAnalytics = {\r\n  totalJobs: number;\r\n  jobsLast30Days: number;\r\n  jobsLast7Days: number;\r\n  quoteCounts: {\r\n    draft: number;\r\n    sent: number;\r\n    accepted: number;\r\n    declined: number;\r\n    cancelled: number;\r\n  };\r\n  // Note: Revenue metrics skipped for now as Job model uses aiQuote (text) not numeric total\r\n};\r\n\r\n/**\r\n * Computes analytics for a single tradie/business user\r\n * @param userId - The user's ID\r\n * @returns Analytics object with job counts and quote status breakdown\r\n */\r\nexport async function getUserJobAnalytics(userId: string): Promise<UserJobAnalytics> {\r\n  // Get all jobs for this user (excludes deleted jobs by default)\r\n  const allJobs = await getJobsForUser(userId, false);\r\n\r\n  const now = new Date();\r\n  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n\r\n  // Initialize quote counts\r\n  const quoteCounts = {\r\n    draft: 0,\r\n    sent: 0,\r\n    accepted: 0,\r\n    declined: 0,\r\n    cancelled: 0,\r\n  };\r\n\r\n  let jobsLast30Days = 0;\r\n  let jobsLast7Days = 0;\r\n\r\n  // Process each job\r\n  for (const job of allJobs) {\r\n    // Count jobs by creation date\r\n    const createdAt = new Date(job.createdAt);\r\n    if (createdAt >= thirtyDaysAgo) {\r\n      jobsLast30Days++;\r\n    }\r\n    if (createdAt >= sevenDaysAgo) {\r\n      jobsLast7Days++;\r\n    }\r\n\r\n    // Count quotes by client status\r\n    const clientStatus: ClientStatus = job.clientStatus || \"draft\";\r\n    switch (clientStatus) {\r\n      case \"draft\":\r\n        quoteCounts.draft++;\r\n        break;\r\n      case \"sent\":\r\n        quoteCounts.sent++;\r\n        break;\r\n      case \"accepted\":\r\n        quoteCounts.accepted++;\r\n        break;\r\n      case \"declined\":\r\n        quoteCounts.declined++;\r\n        break;\r\n      case \"cancelled\":\r\n        quoteCounts.cancelled++;\r\n        break;\r\n    }\r\n  }\r\n\r\n  return {\r\n    totalJobs: allJobs.length,\r\n    jobsLast30Days,\r\n    jobsLast7Days,\r\n    quoteCounts,\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\audit.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[766,769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[766,769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1806,1809],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1806,1809],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Audit logging system for admin actions\r\n * Tracks impersonation and other critical admin operations\r\n */\r\n\r\nimport { kv } from \"./kv\";\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport type AuditAction =\r\n  | \"IMPERSONATE_START\"\r\n  | \"IMPERSONATE_END\"\r\n  | \"JOB_CREATED_AS_USER\"\r\n  | \"USER_UPDATED\"\r\n  | \"VERIFICATION_APPROVED\"\r\n  | \"VERIFICATION_REJECTED\"\r\n  | \"PLAN_UPDATED\"\r\n  | \"FEEDBACK_REPLIED\";\r\n\r\nexport interface AuditLog {\r\n  id: string;\r\n  adminId: string; // The admin performing the action\r\n  actingAsUserId?: string | null; // If acting on behalf of a user\r\n  action: AuditAction;\r\n  metadata?: Record<string, any>; // Additional context\r\n  createdAt: string;\r\n}\r\n\r\n// ============================================================================\r\n// Storage Keys\r\n// ============================================================================\r\n\r\nconst AUDIT_PREFIX = \"audit:\";\r\nconst AUDIT_INDEX_KEY = \"audit:index\";\r\n\r\n// ============================================================================\r\n// Helpers\r\n// ============================================================================\r\n\r\n/**\r\n * Generates a unique ID for audit log\r\n */\r\nfunction generateAuditId(): string {\r\n  return `audit_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n// ============================================================================\r\n// CRUD Operations\r\n// ============================================================================\r\n\r\n/**\r\n * Creates a new audit log entry\r\n */\r\nexport async function createAuditLog(data: {\r\n  adminId: string;\r\n  actingAsUserId?: string | null;\r\n  action: AuditAction;\r\n  metadata?: Record<string, any>;\r\n}): Promise<AuditLog> {\r\n  const id = generateAuditId();\r\n  const now = new Date().toISOString();\r\n\r\n  const auditLog: AuditLog = {\r\n    id,\r\n    adminId: data.adminId,\r\n    actingAsUserId: data.actingAsUserId ?? null,\r\n    action: data.action,\r\n    metadata: data.metadata || {},\r\n    createdAt: now,\r\n  };\r\n\r\n  // Save audit log\r\n  await kv.set(`${AUDIT_PREFIX}${id}`, auditLog);\r\n\r\n  // Add to index (prepend so newest is first)\r\n  await kv.lpush(AUDIT_INDEX_KEY, id);\r\n\r\n  console.log(`[AUDIT] ${data.action} by admin ${data.adminId}${data.actingAsUserId ? ` (acting as ${data.actingAsUserId})` : \"\"}`);\r\n\r\n  return auditLog;\r\n}\r\n\r\n/**\r\n * Gets audit logs for a specific admin\r\n */\r\nexport async function getAuditLogsForAdmin(\r\n  adminId: string,\r\n  limit: number = 100\r\n): Promise<AuditLog[]> {\r\n  // Get all audit log IDs from index\r\n  const ids = (await kv.lrange(AUDIT_INDEX_KEY, 0, limit - 1)) as string[] | null;\r\n\r\n  if (!ids || ids.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  // Fetch all audit logs in parallel\r\n  const logs = await Promise.all(\r\n    ids.map((id) => kv.get(`${AUDIT_PREFIX}${id}`) as Promise<AuditLog | null>)\r\n  );\r\n\r\n  // Filter by admin, filter out nulls, and sort by createdAt descending\r\n  return logs\r\n    .filter((log): log is AuditLog => log !== null && log.adminId === adminId)\r\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n}\r\n\r\n/**\r\n * Gets audit logs for a specific user (actions performed on behalf of this user)\r\n */\r\nexport async function getAuditLogsForUser(\r\n  userId: string,\r\n  limit: number = 100\r\n): Promise<AuditLog[]> {\r\n  const ids = (await kv.lrange(AUDIT_INDEX_KEY, 0, limit - 1)) as string[] | null;\r\n\r\n  if (!ids || ids.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const logs = await Promise.all(\r\n    ids.map((id) => kv.get(`${AUDIT_PREFIX}${id}`) as Promise<AuditLog | null>)\r\n  );\r\n\r\n  // Filter by actingAsUserId\r\n  return logs\r\n    .filter((log): log is AuditLog => log !== null && log.actingAsUserId === userId)\r\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":344,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":344,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":376,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":376,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":404,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":404,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":467,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":467,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":618,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":618,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":648,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":648,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":683,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":683,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24437,24440],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24437,24440],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":691,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":691,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24807,24810],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24807,24810],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { kv } from \"./kv\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { cookies } from \"next/headers\";\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport type UserRole = \"tradie\" | \"builder\" | \"client\" | \"supplier\" | \"admin\";\r\nexport type VerificationStatus = \"unverified\" | \"pending\" | \"verified\";\r\n// Legacy statuses for backwards compatibility (mapped in normalizeUser)\r\ntype LegacyVerificationStatus = \"pending_review\" | \"rejected\";\r\n\r\n// Plan and billing types\r\nexport type PlanTier = \"FREE\" | \"TRIAL\" | \"FOUNDER\" | \"PRO\" | \"BUSINESS\";\r\nexport type PlanStatus = \"ACTIVE\" | \"TRIAL\" | \"PAST_DUE\" | \"CANCELLED\";\r\n\r\nexport interface TradieBusinessDetails {\r\n  businessName?: string;\r\n  tradingName?: string;\r\n  abn?: string;\r\n  tradeTypes?: string[];\r\n  serviceArea?: string;\r\n  // Service area details (for admin filtering)\r\n  serviceAreaCity?: string;\r\n  serviceAreaRadiusKm?: number;\r\n  // Insurance and licence info (prototype fields)\r\n  insuranceProvider?: string;\r\n  insuranceExpiry?: string;\r\n  licenceNumber?: string;\r\n  // Legacy document URL fields (kept for backwards compatibility)\r\n  businessDocUrl?: string;\r\n  insuranceDocUrl?: string;\r\n  licenceDocUrl?: string;\r\n  // Verification timestamps and notes\r\n  verificationSubmittedAt?: string;\r\n  verificationReviewedAt?: string;\r\n  verificationRejectionReason?: string;\r\n}\r\n\r\nexport interface User {\r\n  id: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  createdAt: string;\r\n  // Role and verification\r\n  role: UserRole;\r\n  verificationStatus: VerificationStatus;\r\n  verifiedAt: string | null;\r\n  isAdmin: boolean;\r\n  // Business details (for tradies)\r\n  businessDetails?: TradieBusinessDetails;\r\n  // Pricing settings (for tradies)\r\n  hourlyRate?: number | null;\r\n  dayRate?: number | null;\r\n  materialMarkupPercent?: number | null;\r\n  roughEstimateOnly?: boolean | null;\r\n  // Plan and billing (new fields)\r\n  planTier?: PlanTier;\r\n  planStatus?: PlanStatus;\r\n  trialEndsAt?: string | null;\r\n  // Account status and ban\r\n  accountStatus?: \"ACTIVE\" | \"SUSPENDED\" | \"BANNED\";\r\n  isBanned?: boolean;\r\n  // Activity tracking (new fields)\r\n  lastLoginAt?: string | null;\r\n  lastActivityAt?: string | null;\r\n  totalJobs?: number;\r\n  totalJobPacks?: number;\r\n  // Admin notes (internal only)\r\n  adminNotes?: string;\r\n}\r\n\r\nexport interface Session {\r\n  id: string;\r\n  userId: string;\r\n  createdAt: string;\r\n  // Impersonation support - if set, admin is acting as this user\r\n  actingAsUserId?: string | null;\r\n  realAdminId?: string | null; // Original admin ID for audit trail\r\n}\r\n\r\n// Safe user object without password hash\r\nexport type SafeUser = Omit<User, \"passwordHash\">;\r\n\r\n// ============================================================================\r\n// Constants\r\n// ============================================================================\r\n\r\nexport const SESSION_COOKIE_NAME = \"omx_session\";\r\nexport const SESSION_TTL_SECONDS = 60 * 60 * 24 * 7; // 7 days\r\n\r\n// Cookie options for session cookies\r\nexport const SESSION_COOKIE_OPTIONS = {\r\n  httpOnly: true,\r\n  secure: process.env.NODE_ENV === \"production\",\r\n  sameSite: \"lax\" as const,\r\n  path: \"/\",\r\n  maxAge: SESSION_TTL_SECONDS,\r\n};\r\n\r\n// ============================================================================\r\n// Admin Emails\r\n// ============================================================================\r\n\r\n/**\r\n * List of email addresses that have admin access.\r\n * Add emails here (lowercase) to grant admin privileges.\r\n */\r\nconst ADMIN_EMAILS: string[] = [\r\n  \"chadmspencer94@gmail.com\",\r\n  \"chad.omnexora@outlook.com\",\r\n  \"sarahkison5@gmail.com\",\r\n  // Add more admin emails as needed\r\n];\r\n\r\n// ============================================================================\r\n// Founder Emails\r\n// ============================================================================\r\n\r\n/**\r\n * List of email addresses for founder users.\r\n * Founders get FOUNDER plan tier automatically.\r\n */\r\nexport const FOUNDER_EMAILS: string[] = [\r\n  \"chadmspencer94@gmail.com\",\r\n  \"chad.omnexora@outlook.com\",\r\n  // Add more founder emails here later\r\n];\r\n\r\n/**\r\n * Checks if a user has admin privileges.\r\n * Checks role=\"admin\", the stored isAdmin flag, and the ADMIN_EMAILS list.\r\n * @param user - The user to check (SafeUser or User)\r\n * @returns True if the user is an admin\r\n */\r\nexport function isAdmin(user: SafeUser | null): boolean {\r\n  if (!user) return false;\r\n  // Check role first, then stored flag, then email list for backwards compatibility\r\n  return user.role === \"admin\" || user.isAdmin === true || ADMIN_EMAILS.includes(user.email.toLowerCase());\r\n}\r\n\r\n/**\r\n * Checks if a user is a client\r\n * @param user - The user to check\r\n * @returns true if user is a client, false otherwise\r\n */\r\nexport function isClient(user: SafeUser | null): boolean {\r\n  if (!user) return false;\r\n  return user.role === \"client\";\r\n}\r\n\r\n/**\r\n * Checks if a user is a trade/builder/business (not a client)\r\n * @param user - The user to check\r\n * @returns true if user is a trade/builder/business, false otherwise\r\n */\r\nexport function isTradeOrBusiness(user: SafeUser | null): boolean {\r\n  if (!user) return false;\r\n  return user.role === \"tradie\" || user.role === \"builder\" || user.role === \"supplier\" || user.role === \"admin\";\r\n}\r\n\r\n// ============================================================================\r\n// Test Verified Emails\r\n// ============================================================================\r\n\r\n/**\r\n * List of email addresses that should be automatically verified on registration.\r\n * Used for testing and development purposes.\r\n */\r\nconst TEST_VERIFIED_EMAILS: string[] = [\r\n  \"chadmspencer94@gmail.com_1\",\r\n  \"chadmspencer94@gmail.com_2\",\r\n  // Add more test emails here (lowercase)\r\n];\r\n\r\n// ============================================================================\r\n// User Functions\r\n// ============================================================================\r\n\r\n/**\r\n * The primary admin email that is always verified and has admin access.\r\n */\r\nconst PRIMARY_ADMIN_EMAIL = \"chad.omnexora@outlook.com\";\r\n\r\n/**\r\n * Normalizes a user object loaded from KV storage to ensure all fields are present.\r\n * Handles older user records that may be missing newer fields like verificationStatus.\r\n * Also enforces admin privileges and verified status for the primary admin email.\r\n */\r\nfunction normalizeUser(rawUser: Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string }): User {\r\n  const email = rawUser.email.toLowerCase();\r\n  const isPrimaryAdmin = email === PRIMARY_ADMIN_EMAIL;\r\n  const isAdminEmail = ADMIN_EMAILS.includes(email);\r\n  const isAnyAdmin = isPrimaryAdmin || isAdminEmail;\r\n  \r\n  // Normalize role - handle legacy roles and ensure valid role\r\n  // FORCE primary admin and admin emails to always have \"admin\" role\r\n  let role: UserRole = isAnyAdmin ? \"admin\" : (rawUser.role || \"tradie\");\r\n  // Map legacy roles if needed (backwards compatibility)\r\n  if (role !== \"tradie\" && role !== \"builder\" && role !== \"client\" && role !== \"supplier\" && role !== \"admin\") {\r\n    role = \"tradie\"; // Default fallback\r\n  }\r\n  \r\n  // If role is \"admin\", user is automatically an admin\r\n  const isAdminFromRole = role === \"admin\";\r\n  \r\n  // For primary admin and admin emails, force isAdmin=true, role=\"admin\", and verificationStatus=\"verified\"\r\n  const isAdminFlag = isAnyAdmin || isAdminFromRole ? true : (rawUser.isAdmin ?? false);\r\n  \r\n  // Normalize verification status - map legacy statuses\r\n  // Admins are automatically verified (no business verification needed)\r\n  let verificationStatus: VerificationStatus;\r\n  const rawStatus = rawUser.verificationStatus as VerificationStatus | LegacyVerificationStatus | undefined;\r\n  if (isAnyAdmin) {\r\n    verificationStatus = \"verified\";\r\n  } else if (!rawStatus) {\r\n    verificationStatus = \"unverified\";\r\n  } else if (rawStatus === \"pending_review\" || rawStatus === \"pending\") {\r\n    verificationStatus = \"pending\";\r\n  } else if (rawStatus === \"rejected\") {\r\n    verificationStatus = \"unverified\"; // Map rejected back to unverified\r\n  } else if (rawStatus === \"verified\") {\r\n    verificationStatus = \"verified\";\r\n  } else {\r\n    verificationStatus = \"unverified\"; // Default fallback\r\n  }\r\n  \r\n  const verifiedAt = isAnyAdmin \r\n    ? (rawUser.verifiedAt || new Date().toISOString())\r\n    : (rawUser.verifiedAt ?? null);\r\n  \r\n  return {\r\n    id: rawUser.id,\r\n    email: rawUser.email,\r\n    passwordHash: rawUser.passwordHash,\r\n    createdAt: rawUser.createdAt,\r\n    role,\r\n    verificationStatus,\r\n    verifiedAt,\r\n    isAdmin: isAdminFlag,\r\n    businessDetails: rawUser.businessDetails,\r\n    // Pricing settings (preserve existing values, no defaults here - handled in UI)\r\n    hourlyRate: rawUser.hourlyRate ?? null,\r\n    dayRate: rawUser.dayRate ?? null,\r\n    materialMarkupPercent: rawUser.materialMarkupPercent ?? null,\r\n    roughEstimateOnly: rawUser.roughEstimateOnly ?? null,\r\n    // Plan and billing (defaults for new fields)\r\n    planTier: rawUser.planTier ?? \"FREE\",\r\n    planStatus: rawUser.planStatus ?? \"TRIAL\",\r\n    trialEndsAt: rawUser.trialEndsAt ?? null,\r\n    // Account status and ban (defaults)\r\n    accountStatus: rawUser.accountStatus ?? (rawUser.isBanned ? \"BANNED\" : \"ACTIVE\"),\r\n    isBanned: rawUser.isBanned ?? false,\r\n    // Activity tracking (defaults)\r\n    lastLoginAt: rawUser.lastLoginAt ?? null,\r\n    lastActivityAt: rawUser.lastActivityAt ?? null,\r\n    totalJobs: rawUser.totalJobs ?? 0,\r\n    totalJobPacks: rawUser.totalJobPacks ?? 0,\r\n    // Admin notes\r\n    adminNotes: rawUser.adminNotes,\r\n  };\r\n}\r\n\r\n/**\r\n * Creates a new user in KV storage\r\n * @param email - User's email address\r\n * @param password - Plain text password (will be hashed)\r\n * @param role - User role (tradie or client), defaults to \"tradie\"\r\n * @returns The created user (without password hash)\r\n * @throws Error if user already exists\r\n */\r\nexport async function createUser(\r\n  email: string,\r\n  password: string,\r\n  role: UserRole = \"tradie\"\r\n): Promise<SafeUser> {\r\n  // Normalize email to lowercase\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n\r\n  // Generate user ID and hash password\r\n  const id = crypto.randomUUID();\r\n  const passwordHash = await bcrypt.hash(password, 12);\r\n  const createdAt = new Date().toISOString();\r\n\r\n  // Check if this is the primary admin or a test verified email\r\n  const isPrimaryAdmin = normalizedEmail === PRIMARY_ADMIN_EMAIL;\r\n  const isTestVerified = TEST_VERIFIED_EMAILS.includes(normalizedEmail);\r\n  const isFounder = FOUNDER_EMAILS.includes(normalizedEmail) || isPrimaryAdmin; // Primary admin is also a founder\r\n  \r\n  // FORCE primary admin to always have \"admin\" role, verified status, and admin flag\r\n  const finalRole: UserRole = isPrimaryAdmin ? \"admin\" : role;\r\n  const verificationStatus: VerificationStatus = (isPrimaryAdmin || isTestVerified)\r\n    ? \"verified\"\r\n    : \"unverified\";\r\n  const verifiedAt = (isPrimaryAdmin || isTestVerified) ? createdAt : null;\r\n  const isAdminFlag = isPrimaryAdmin || ADMIN_EMAILS.includes(normalizedEmail);\r\n\r\n  // Set plan tier: FOUNDER for founder emails (including primary admin), otherwise FREE\r\n  const planTier: PlanTier = isFounder ? \"FOUNDER\" : \"FREE\";\r\n  // Founders get ACTIVE status, others get TRIAL\r\n  const planStatus: PlanStatus = isFounder ? \"ACTIVE\" : \"TRIAL\";\r\n\r\n  const user: User = {\r\n    id,\r\n    email: normalizedEmail,\r\n    passwordHash,\r\n    createdAt,\r\n    role: finalRole,\r\n    verificationStatus,\r\n    verifiedAt,\r\n    isAdmin: isAdminFlag,\r\n    // Plan for new users: FOUNDER if in founder list, otherwise FREE\r\n    planTier,\r\n    planStatus,\r\n    trialEndsAt: null,\r\n    // Initialize activity tracking\r\n    lastLoginAt: null,\r\n    lastActivityAt: null,\r\n    totalJobs: 0,\r\n    totalJobPacks: 0,\r\n  };\r\n\r\n  // Atomically set user by email only if it doesn't exist (prevents race condition)\r\n  // The 'nx' option makes this an atomic check-and-set operation\r\n  const wasSet = await kv.set(`user:email:${normalizedEmail}`, user, { nx: true });\r\n  \r\n  if (!wasSet) {\r\n    throw new Error(\"User already exists\");\r\n  }\r\n\r\n  // Store user by id - rollback email entry if this fails\r\n  try {\r\n    await kv.set(`user:id:${id}`, user);\r\n    // Add to users index for admin listing\r\n    await kv.lpush(\"users:all\", id);\r\n  } catch (error) {\r\n    // Rollback: delete the email entry to maintain consistency\r\n    await kv.del(`user:email:${normalizedEmail}`);\r\n    throw error;\r\n  }\r\n\r\n  // Return safe user without password hash\r\n  const { passwordHash: _, ...safeUser } = user;\r\n  return safeUser;\r\n}\r\n\r\n/**\r\n * Verifies a user's credentials\r\n * @param email - User's email address\r\n * @param password - Plain text password to verify\r\n * @returns The user if credentials are valid, null otherwise\r\n */\r\nexport async function verifyUser(\r\n  email: string,\r\n  password: string\r\n): Promise<SafeUser | null> {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n\r\n  // Load user by email (may be an older record missing newer fields)\r\n  const rawUser = (await kv.get(`user:email:${normalizedEmail}`)) as Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string } | null;\r\n  if (!rawUser) {\r\n    return null;\r\n  }\r\n\r\n  // Compare password\r\n  const isValid = await bcrypt.compare(password, rawUser.passwordHash);\r\n  if (!isValid) {\r\n    return null;\r\n  }\r\n\r\n  // Normalize to ensure all fields are present (handles older records)\r\n  const user = normalizeUser(rawUser);\r\n\r\n  // Return safe user without password hash\r\n  const { passwordHash: _, ...safeUser } = user;\r\n  return safeUser;\r\n}\r\n\r\n/**\r\n * Gets a user by ID (internal use - includes password hash)\r\n * @param userId - The user's ID\r\n * @returns The full user object or null\r\n */\r\nexport async function getUserById(userId: string): Promise<User | null> {\r\n  const rawUser = (await kv.get(`user:id:${userId}`)) as Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string } | null;\r\n  if (!rawUser) return null;\r\n  \r\n  // Normalize to ensure all fields are present (handles older records)\r\n  return normalizeUser(rawUser);\r\n}\r\n\r\n/**\r\n * Gets a safe user by ID (no password hash)\r\n * @param userId - The user's ID\r\n * @returns The safe user object or null\r\n */\r\nexport async function getSafeUserById(userId: string): Promise<SafeUser | null> {\r\n  const rawUser = (await kv.get(`user:id:${userId}`)) as Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string } | null;\r\n  if (!rawUser) return null;\r\n  \r\n  // Normalize to ensure all fields are present (handles older records)\r\n  const user = normalizeUser(rawUser);\r\n  const { passwordHash: _, ...safeUser } = user;\r\n  return safeUser;\r\n}\r\n\r\n/**\r\n * Updates a user's data in KV storage\r\n * @param userId - The user's ID\r\n * @param updates - Partial user data to update\r\n * @returns The updated safe user or null if user not found\r\n */\r\nexport async function updateUser(\r\n  userId: string,\r\n  updates: Partial<Omit<User, \"id\" | \"email\" | \"passwordHash\" | \"createdAt\">>\r\n): Promise<SafeUser | null> {\r\n  const rawUser = (await kv.get(`user:id:${userId}`)) as Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string } | null;\r\n  if (!rawUser) return null;\r\n\r\n  // Normalize to ensure all fields are present (handles older records)\r\n  const user = normalizeUser(rawUser);\r\n\r\n  const updatedUser: User = {\r\n    ...user,\r\n    ...updates,\r\n  };\r\n\r\n  // If role is being updated to \"admin\", ensure isAdmin is true and auto-verify\r\n  if (updates.role === \"admin\") {\r\n    updatedUser.isAdmin = true;\r\n    // Admins don't need business verification - auto-verify them\r\n    if (!updatedUser.verificationStatus || updatedUser.verificationStatus !== \"verified\") {\r\n      updatedUser.verificationStatus = \"verified\";\r\n      if (!updatedUser.verifiedAt) {\r\n        updatedUser.verifiedAt = new Date().toISOString();\r\n      }\r\n    }\r\n  }\r\n  \r\n  // If isAdmin is being set to true, also ensure role is \"admin\" and auto-verify\r\n  if (updates.isAdmin === true) {\r\n    updatedUser.role = \"admin\";\r\n    updatedUser.isAdmin = true;\r\n    // Admins don't need business verification - auto-verify them\r\n    if (!updatedUser.verificationStatus || updatedUser.verificationStatus !== \"verified\") {\r\n      updatedUser.verificationStatus = \"verified\";\r\n      if (!updatedUser.verifiedAt) {\r\n        updatedUser.verifiedAt = new Date().toISOString();\r\n      }\r\n    }\r\n  }\r\n  \r\n  // If isAdmin is being set to false, reset role to \"tradie\" (default non-admin role)\r\n  if (updates.isAdmin === false) {\r\n    updatedUser.isAdmin = false;\r\n    // Only reset role if it was \"admin\" (preserve other roles like \"builder\", \"supplier\", etc.)\r\n    if (updatedUser.role === \"admin\") {\r\n      updatedUser.role = \"tradie\";\r\n    }\r\n  }\r\n\r\n  // Update both user:id and user:email entries\r\n  await kv.set(`user:id:${userId}`, updatedUser);\r\n  await kv.set(`user:email:${user.email}`, updatedUser);\r\n\r\n  const { passwordHash: _, ...safeUser } = updatedUser;\r\n  return safeUser;\r\n}\r\n\r\n/**\r\n * Gets all users with a specific verification status (for admin)\r\n * Note: This is a simple implementation - in production, use proper indexing\r\n */\r\nexport async function getUsersByVerificationStatus(\r\n  status: VerificationStatus\r\n): Promise<SafeUser[]> {\r\n  // This is a simplified implementation\r\n  // In a real app, you'd maintain an index or use a proper database\r\n  // For now, we'll store a list of user IDs that need review\r\n  const userIds = ((await kv.lrange(`admin:verification:${status}`, 0, -1)) as string[]) || [];\r\n  \r\n  // Also check legacy \"pending_review\" status if looking for \"pending\"\r\n  let legacyUserIds: string[] = [];\r\n  if (status === \"pending\") {\r\n    legacyUserIds = ((await kv.lrange(`admin:verification:pending_review`, 0, -1)) as string[]) || [];\r\n  }\r\n  \r\n  // Combine and deduplicate\r\n  const allUserIds = [...new Set([...userIds, ...legacyUserIds])];\r\n  \r\n  const users: SafeUser[] = [];\r\n  for (const id of allUserIds) {\r\n    const user = await getSafeUserById(id);\r\n    if (user) {\r\n      // Normalize status - map \"pending_review\" to \"pending\" for comparison\r\n      const userStatusStr = user.verificationStatus as string;\r\n      const normalizedStatus = userStatusStr === \"pending_review\" ? \"pending\" : user.verificationStatus;\r\n      if (normalizedStatus === status) {\r\n        users.push(user);\r\n      }\r\n    }\r\n  }\r\n  \r\n  return users;\r\n}\r\n\r\n/**\r\n * Adds a user to a verification status index (for admin tracking)\r\n */\r\nexport async function addUserToVerificationIndex(\r\n  userId: string,\r\n  status: VerificationStatus\r\n): Promise<void> {\r\n  await kv.lpush(`admin:verification:${status}`, userId);\r\n}\r\n\r\n/**\r\n * Removes a user from a verification status index\r\n */\r\nexport async function removeUserFromVerificationIndex(\r\n  userId: string,\r\n  status: VerificationStatus\r\n): Promise<void> {\r\n  await kv.lrem(`admin:verification:${status}`, 0, userId);\r\n}\r\n\r\n/**\r\n * Gets all users in the system (for admin)\r\n * Uses an index list maintained in KV. If index doesn't exist, returns empty array.\r\n * \r\n * IMPORTANT: This relies on the \"users:all\" index being maintained.\r\n * - New users are automatically added to the index in createUser()\r\n * - If you need to rebuild the index (e.g., for legacy users), you'll need to:\r\n *   1. Scan all user:email:* keys OR user:id:* keys (if possible in your KV setup)\r\n *   2. Add their IDs to the \"users:all\" list\r\n * \r\n * Note: This is a simplified implementation - in production, use proper indexing or a database\r\n */\r\nexport async function getAllUsers(): Promise<SafeUser[]> {\r\n  // Get all user IDs from the index\r\n  // This index is maintained automatically when users are created via createUser()\r\n  const userIds = ((await kv.lrange(\"users:all\", 0, -1)) as string[]) || [];\r\n  \r\n  if (userIds.length === 0) {\r\n    // Index might be empty - could mean no users, or index not initialized\r\n    // In production, you might want to log this or rebuild the index\r\n    return [];\r\n  }\r\n  \r\n  // Load all users in parallel\r\n  const users = await Promise.all(\r\n    userIds.map((id: string) => getSafeUserById(id))\r\n  );\r\n  \r\n  // Filter out nulls (users that were deleted or don't exist anymore)\r\n  // and sort by createdAt descending (newest first)\r\n  return users\r\n    .filter((user): user is SafeUser => user !== null)\r\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n}\r\n\r\n// ============================================================================\r\n// Session Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Creates a new session for a user\r\n * @param userId - The user's ID\r\n * @returns The session ID\r\n */\r\nexport async function createSession(userId: string): Promise<string> {\r\n  const sessionId = crypto.randomUUID();\r\n  const createdAt = new Date().toISOString();\r\n\r\n  const session: Session = {\r\n    id: sessionId,\r\n    userId,\r\n    createdAt,\r\n  };\r\n\r\n  // Store session with TTL\r\n  await kv.set(`session:${sessionId}`, session, { ex: SESSION_TTL_SECONDS });\r\n\r\n  return sessionId;\r\n}\r\n\r\n/**\r\n * Gets a user from a session ID\r\n * Supports impersonation: if actingAsUserId is set, returns that user instead\r\n * @param sessionId - The session ID\r\n * @returns The user if session is valid, null otherwise\r\n */\r\nexport async function getUserFromSession(\r\n  sessionId: string\r\n): Promise<SafeUser | null> {\r\n  try {\r\n    // Look up session\r\n    const session = (await kv.get(`session:${sessionId}`)) as Session | null;\r\n    if (!session) {\r\n      return null;\r\n    }\r\n\r\n    // If impersonating, return the impersonated user\r\n    const targetUserId = session.actingAsUserId || session.userId;\r\n\r\n    // Load user by id (may be an older record missing newer fields)\r\n    const rawUser = (await kv.get(`user:id:${targetUserId}`)) as Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string } | null;\r\n    if (!rawUser) {\r\n      console.error(\"[auth] getUserFromSession: user not found for session\", sessionId, \"targetUserId:\", targetUserId);\r\n      return null;\r\n    }\r\n\r\n    // Normalize to ensure all fields are present (handles older records)\r\n    const user = normalizeUser(rawUser);\r\n\r\n    // Return safe user without password hash\r\n    const { passwordHash: _, ...safeUser } = user;\r\n    return safeUser;\r\n  } catch (error) {\r\n    // If KV lookup fails, return null (session invalid)\r\n    console.error(\"[auth] Error getting user from session:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the real admin user (not impersonated) from a session\r\n * Used for audit logging when impersonating\r\n * @param sessionId - The session ID\r\n * @returns The real admin user or null\r\n */\r\nexport async function getRealUserFromSession(\r\n  sessionId: string\r\n): Promise<SafeUser | null> {\r\n  const session = (await kv.get(`session:${sessionId}`)) as Session | null;\r\n  if (!session) {\r\n    return null;\r\n  }\r\n\r\n  // Always return the real user (not the impersonated one)\r\n  const rawUser = (await kv.get(`user:id:${session.userId}`)) as Partial<User> & { id: string; email: string; passwordHash: string; createdAt: string } | null;\r\n  if (!rawUser) {\r\n    return null;\r\n  }\r\n\r\n  const user = normalizeUser(rawUser);\r\n  const { passwordHash: _, ...safeUser } = user;\r\n  return safeUser;\r\n}\r\n\r\n/**\r\n * Deletes a session\r\n * @param sessionId - The session ID to delete\r\n */\r\nexport async function deleteSession(sessionId: string): Promise<void> {\r\n  await kv.del(`session:${sessionId}`);\r\n}\r\n\r\n// ============================================================================\r\n// Cookie Helpers\r\n// ============================================================================\r\n\r\n/**\r\n * Gets the current logged-in user from the session cookie\r\n * Supports impersonation - returns the impersonated user if active\r\n * @returns The current user or null if not logged in\r\n */\r\nexport async function getCurrentUser(): Promise<SafeUser | null> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    const sessionId = cookieStore.get(SESSION_COOKIE_NAME)?.value;\r\n\r\n    if (!sessionId) {\r\n      return null;\r\n    }\r\n\r\n    const user = await getUserFromSession(sessionId);\r\n    if (user) {\r\n      console.log(\"[auth] getCurrentUser: found user\", user.id);\r\n    }\r\n    return user;\r\n  } catch (error: any) {\r\n    // Handle DYNAMIC_SERVER_USAGE errors silently (expected during build/static generation)\r\n    // These occur when Next.js tries to statically generate pages that use cookies()\r\n    // Swallow these errors and just treat as \"no user\" - do NOT log them\r\n    if (\r\n      error &&\r\n      typeof error === \"object\" &&\r\n      \"digest\" in error &&\r\n      (error as any).digest === \"DYNAMIC_SERVER_USAGE\"\r\n    ) {\r\n      return null;\r\n    }\r\n    \r\n    if (error?.message?.includes(\"Dynamic server usage\") || error?.message?.includes(\"couldn't be rendered statically\")) {\r\n      return null;\r\n    }\r\n    \r\n    // For other errors (e.g., KV unavailable), log but don't crash\r\n    // This allows the app to continue functioning in degraded mode\r\n    console.error(\"[auth] Failed to get current user from session\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if the current session is impersonating another user\r\n * @returns true if impersonating, false otherwise\r\n */\r\nexport async function isImpersonating(): Promise<boolean> {\r\n  const cookieStore = await cookies();\r\n  const sessionId = cookieStore.get(SESSION_COOKIE_NAME)?.value;\r\n\r\n  if (!sessionId) {\r\n    return false;\r\n  }\r\n\r\n  const session = (await kv.get(`session:${sessionId}`)) as Session | null;\r\n  return !!(session?.actingAsUserId);\r\n}\r\n\r\n/**\r\n * Server-side helper to assert admin privileges\r\n * Throws an error if user is not an admin/support\r\n * @param user - The user to check\r\n * @throws Error if user is not admin\r\n */\r\nexport function assertAdmin(user: SafeUser | null): void {\r\n  if (!user || !isAdmin(user)) {\r\n    throw new Error(\"Unauthorized: Admin access required\");\r\n  }\r\n}\r\n\r\n/**\r\n * Requires an active (non-suspended) user\r\n * Redirects to login if not authenticated, or to account-suspended if suspended\r\n * @param redirectTo - Optional redirect path to append to login redirect\r\n * @returns The active user (never null, redirects if issues)\r\n */\r\nexport async function requireActiveUser(redirectTo?: string): Promise<SafeUser> {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    \r\n    if (!user) {\r\n      console.log(\"[auth] requireActiveUser: no user found, redirecting to login\");\r\n      const { redirect } = await import(\"next/navigation\");\r\n      const loginPath = redirectTo ? `/login?redirect=${encodeURIComponent(redirectTo)}&reason=unauthorised` : \"/login?reason=unauthorised\";\r\n      redirect(loginPath);\r\n      // redirect() never returns, but TypeScript doesn't know that\r\n      // Use a type assertion to satisfy TypeScript - this code will never execute\r\n      return null as never;\r\n    }\r\n\r\n    console.log(\"[auth] requireActiveUser: user found\", user.id);\r\n\r\n    // Check if account is suspended (planStatus can be a string, not just PlanStatus enum)\r\n    // SUSPENDED is a valid status that can be set by admins, even though it's not in the PlanStatus type\r\n    const planStatus = user.planStatus as string | undefined;\r\n    if (planStatus === \"SUSPENDED\") {\r\n      console.log(\"[auth] requireActiveUser: account suspended, redirecting\");\r\n      const { redirect } = await import(\"next/navigation\");\r\n      redirect(\"/account-suspended\");\r\n      // redirect() never returns, but TypeScript doesn't know that\r\n      return null as never;\r\n    }\r\n\r\n    // At this point, user is guaranteed to be non-null and not suspended\r\n    return user;\r\n  } catch (error) {\r\n    // If getCurrentUser throws (shouldn't happen, but be defensive), log and redirect\r\n    console.error(\"[auth] requireActiveUser: error getting user\", error);\r\n    const { redirect } = await import(\"next/navigation\");\r\n    redirect(\"/login?reason=unauthorised\");\r\n    return null as never;\r\n  }\r\n}\r\n\r\n/**\r\n * Requires a client user\r\n * Redirects to login if not authenticated, or to /client/dashboard if not a client\r\n * @param redirectTo - Optional redirect path to append to login redirect\r\n * @returns The client user (never null, redirects if issues)\r\n */\r\nexport async function requireClientUser(redirectTo?: string): Promise<SafeUser> {\r\n  const user = await requireActiveUser(redirectTo);\r\n  \r\n  if (!isClient(user)) {\r\n    const { redirect } = await import(\"next/navigation\");\r\n    // Non-clients should go to their dashboard\r\n    redirect(\"/dashboard\");\r\n    // redirect() never returns, but TypeScript doesn't know that\r\n    return null as never;\r\n  }\r\n\r\n  return user;\r\n}\r\n\r\n/**\r\n * Requires a tradie/business/admin user (not a client)\r\n * Redirects to login if not authenticated, or to /client/dashboard if client\r\n * @param redirectTo - Optional redirect path to append to login redirect\r\n * @returns The tradie/business/admin user (never null, redirects if issues)\r\n */\r\nexport async function requireTradieUser(redirectTo?: string): Promise<SafeUser> {\r\n  const user = await requireActiveUser(redirectTo);\r\n  \r\n  if (isClient(user)) {\r\n    const { redirect } = await import(\"next/navigation\");\r\n    // Clients should go to their dashboard\r\n    redirect(\"/client/dashboard\");\r\n    // redirect() never returns, but TypeScript doesn't know that\r\n    return null as never;\r\n  }\r\n\r\n  return user;\r\n}\r\n\r\n/**\r\n * Sets the session cookie\r\n * @param sessionId - The session ID to set in the cookie\r\n */\r\nexport async function setSessionCookie(sessionId: string): Promise<void> {\r\n  const cookieStore = await cookies();\r\n  cookieStore.set(SESSION_COOKIE_NAME, sessionId, {\r\n    httpOnly: true,\r\n    secure: process.env.NODE_ENV === \"production\",\r\n    sameSite: \"lax\",\r\n    path: \"/\",\r\n    maxAge: SESSION_TTL_SECONDS,\r\n  });\r\n}\r\n\r\n/**\r\n * Clears the session cookie\r\n */\r\nexport async function clearSessionCookie(): Promise<void> {\r\n  const cookieStore = await cookies();\r\n  cookieStore.delete(SESSION_COOKIE_NAME);\r\n}\r\n\r\n/**\r\n * Starts impersonation - sets actingAsUserId in session\r\n * @param sessionId - The admin's session ID\r\n * @param targetUserId - The user ID to impersonate\r\n * @returns Updated session or null if failed\r\n */\r\nexport async function startImpersonation(\r\n  sessionId: string,\r\n  targetUserId: string\r\n): Promise<Session | null> {\r\n  const session = (await kv.get(`session:${sessionId}`)) as Session | null;\r\n  if (!session) {\r\n    return null;\r\n  }\r\n\r\n  // Verify the session belongs to an admin\r\n  const adminUser = await getUserById(session.userId);\r\n  if (!adminUser || !isAdmin(adminUser as SafeUser)) {\r\n    return null;\r\n  }\r\n\r\n  // Update session with impersonation data\r\n  const updatedSession: Session = {\r\n    ...session,\r\n    actingAsUserId: targetUserId,\r\n    realAdminId: session.userId, // Store original admin ID\r\n  };\r\n\r\n  await kv.set(`session:${sessionId}`, updatedSession, { ex: SESSION_TTL_SECONDS });\r\n\r\n  return updatedSession;\r\n}\r\n\r\n/**\r\n * Stops impersonation - clears actingAsUserId from session\r\n * @param sessionId - The admin's session ID\r\n * @returns Updated session or null if failed\r\n */\r\nexport async function stopImpersonation(sessionId: string): Promise<Session | null> {\r\n  const session = (await kv.get(`session:${sessionId}`)) as Session | null;\r\n  if (!session) {\r\n    return null;\r\n  }\r\n\r\n  // Clear impersonation data\r\n  const updatedSession: Session = {\r\n    ...session,\r\n    actingAsUserId: null,\r\n    realAdminId: null,\r\n  };\r\n\r\n  await kv.set(`session:${sessionId}`, updatedSession, { ex: SESSION_TTL_SECONDS });\r\n\r\n  return updatedSession;\r\n}\r\n\r\n/**\r\n * Updates user's last login timestamp\r\n */\r\nexport async function updateLastLogin(userId: string): Promise<void> {\r\n  await updateUser(userId, {\r\n    lastLoginAt: new Date().toISOString(),\r\n  });\r\n}\r\n\r\n/**\r\n * Updates user's last activity timestamp\r\n */\r\nexport async function updateLastActivity(userId: string): Promise<void> {\r\n  await updateUser(userId, {\r\n    lastActivityAt: new Date().toISOString(),\r\n  });\r\n}\r\n\r\n/**\r\n * Increments user's job count\r\n */\r\nexport async function incrementUserJobCount(userId: string): Promise<void> {\r\n  const user = await getUserById(userId);\r\n  if (!user) return;\r\n\r\n  await updateUser(userId, {\r\n    totalJobs: (user.totalJobs || 0) + 1,\r\n    lastActivityAt: new Date().toISOString(),\r\n  });\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\authChecks.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1644,1647],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1644,1647],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2269,2272],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2269,2272],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// lib/authChecks.ts\r\nimport { redirect } from \"next/navigation\";\r\nimport { getCurrentUser, isClient, isAdmin, type SafeUser } from \"./auth\";\r\n\r\n// Re-export isClient for convenience\r\nexport { isClient };\r\n\r\n// Custom error class for email verification\r\nclass EmailNotVerifiedError extends Error {\r\n  name = \"EmailNotVerifiedError\";\r\n  constructor(message: string = \"Email not verified\") {\r\n    super(message);\r\n  }\r\n}\r\n\r\n/**\r\n * Require that a user is logged in.\r\n * Redirects to /login if not authenticated.\r\n */\r\nexport async function requireAuthenticatedUser() {\r\n  const user = await getCurrentUser();\r\n\r\n  if (!user) {\r\n    redirect(\"/login?reason=unauthorised\");\r\n  }\r\n\r\n  return user;\r\n}\r\n\r\n/**\r\n * Alias for requireAuthenticatedUser for backwards compatibility.\r\n */\r\nexport const requireUser = requireAuthenticatedUser;\r\n\r\n/**\r\n * Require that a user is NOT logged in.\r\n * Used for /login, /register, etc.\r\n */\r\nexport async function requireUnauthenticatedUser() {\r\n  const user = await getCurrentUser();\r\n\r\n  if (!user) {\r\n    return null;\r\n  }\r\n\r\n  redirect(\"/dashboard\");\r\n}\r\n\r\n/**\r\n * Require a logged-in, ÔÇ£onboardedÔÇØ user.\r\n * For now we treat any authenticated user as onboarded so the app works.\r\n */\r\nexport async function requireOnboardedUser() {\r\n  const user = await requireAuthenticatedUser();\r\n\r\n  // TODO: when you have a real onboarding flag, enforce it here:\r\n  // if (!user.onboardingCompleted) redirect(\"/onboarding\");\r\n\r\n  return user;\r\n}\r\n\r\n/**\r\n * Require an admin user for /admin routes.\r\n */\r\nexport async function requireAdminUser() {\r\n  const user = await requireAuthenticatedUser();\r\n  const role = (user as any).role;\r\n\r\n  if (role !== \"ADMIN\" && role !== \"admin\") {\r\n    redirect(\"/dashboard\");\r\n  }\r\n\r\n  return user;\r\n}\r\n\r\n/**\r\n * Requires that a user's email is verified.\r\n * Throws EmailNotVerifiedError if email is not verified.\r\n * Admin users bypass this check.\r\n * @param user - The user to check\r\n * @throws EmailNotVerifiedError if email is not verified\r\n */\r\nexport async function requireVerifiedEmail(user: SafeUser): Promise<void> {\r\n  // Admin users bypass email verification\r\n  if (isAdmin(user)) {\r\n    return;\r\n  }\r\n\r\n  // Check if emailVerifiedAt exists on user object (might be added dynamically)\r\n  if ((user as any).emailVerifiedAt) {\r\n    return;\r\n  }\r\n\r\n  // Otherwise, check Prisma database\r\n  try {\r\n    const { getPrisma } = await import(\"./prisma\"); const prisma = getPrisma();\r\n    const prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n      select: { emailVerifiedAt: true },\r\n    });\r\n\r\n    if (!prismaUser || !prismaUser.emailVerifiedAt) {\r\n      throw new EmailNotVerifiedError(\"Email not verified\");\r\n    }\r\n  } catch (error) {\r\n    // If it's already our custom error, re-throw it\r\n    if (error instanceof EmailNotVerifiedError) {\r\n      throw error;\r\n    }\r\n    // If database query fails, assume not verified for safety\r\n    throw new EmailNotVerifiedError(\"Email not verified\");\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\clientCrm.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3215,3218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3215,3218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'kv' is assigned a value but never used.","line":219,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":219,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Client CRM helper functions\r\n * Handles finding or creating Client records for job linking\r\n */\r\n\r\nimport { getPrisma } from \"@/lib/prisma\";\r\n\r\nexport interface FindOrCreateClientArgs {\r\n  ownerUserId: string;\r\n  name: string;\r\n  email?: string | null;\r\n  phone?: string | null;\r\n  company?: string | null;\r\n  suburb?: string | null;\r\n  state?: string | null;\r\n  postcode?: string | null;\r\n}\r\n\r\n/**\r\n * Finds or creates a Client record for a tradie/business user.\r\n * Matches on ownerId + email (if provided), or ownerId + name (if no email).\r\n * Updates basic details if client exists but info has changed.\r\n */\r\nexport async function findOrCreateClientForJob(\r\n  args: FindOrCreateClientArgs\r\n): Promise<{ clientId: string }> {\r\n  const prisma = getPrisma();\r\n  const { ownerUserId, name, email, phone, company, suburb, state, postcode } = args;\r\n\r\n  // Normalize email for matching (lowercase, trim)\r\n  const normalizedEmail = email?.trim().toLowerCase() || null;\r\n\r\n  // Try to find existing client\r\n  let client = null;\r\n\r\n  if (normalizedEmail) {\r\n    // Match by owner + email (most reliable)\r\n    client = await prisma.client.findFirst({\r\n      where: {\r\n        ownerId: ownerUserId,\r\n        email: normalizedEmail,\r\n      },\r\n    });\r\n  } else {\r\n    // If no email, match by owner + name (less reliable but better than duplicates)\r\n    client = await prisma.client.findFirst({\r\n      where: {\r\n        ownerId: ownerUserId,\r\n        name: name.trim(),\r\n        email: null, // Only match if email is also null\r\n      },\r\n    });\r\n  }\r\n\r\n  if (client) {\r\n    // Update client details if they've changed (phone, suburb, etc.)\r\n    const needsUpdate =\r\n      (phone && client.phone !== phone) ||\r\n      (company && client.company !== company) ||\r\n      (suburb && client.suburb !== suburb) ||\r\n      (state && client.state !== state) ||\r\n      (postcode && client.postcode !== postcode) ||\r\n      (normalizedEmail && client.email !== normalizedEmail);\r\n\r\n    if (needsUpdate) {\r\n      client = await prisma.client.update({\r\n        where: { id: client.id },\r\n        data: {\r\n          name: name.trim(), // Update name in case it changed\r\n          email: normalizedEmail,\r\n          phone: phone || client.phone,\r\n          company: company || client.company,\r\n          suburb: suburb || client.suburb,\r\n          state: state || client.state,\r\n          postcode: postcode || client.postcode,\r\n        },\r\n      });\r\n    }\r\n\r\n    return { clientId: client.id };\r\n  }\r\n\r\n  // Create new client\r\n  const newClient = await prisma.client.create({\r\n    data: {\r\n      ownerId: ownerUserId,\r\n      name: name.trim(),\r\n      email: normalizedEmail,\r\n      phone: phone?.trim() || null,\r\n      company: company?.trim() || null,\r\n      suburb: suburb?.trim() || null,\r\n      state: state?.trim() || null,\r\n      postcode: postcode?.trim() || null,\r\n    },\r\n  });\r\n\r\n  return { clientId: newClient.id };\r\n}\r\n\r\n/**\r\n * Gets all clients for a tradie/business user\r\n */\r\nexport async function getClientsForUser(\r\n  ownerUserId: string,\r\n  options?: {\r\n    search?: string;\r\n    page?: number;\r\n    pageSize?: number;\r\n  }\r\n) {\r\n  const { search, page = 1, pageSize = 20 } = options || {};\r\n\r\n  const where: any = {\r\n    ownerId: ownerUserId,\r\n  };\r\n\r\n  // Add search filter if provided\r\n  if (search && search.trim()) {\r\n    const searchTerm = search.trim();\r\n    where.OR = [\r\n      { name: { contains: searchTerm, mode: \"insensitive\" } },\r\n      { email: { contains: searchTerm, mode: \"insensitive\" } },\r\n      { company: { contains: searchTerm, mode: \"insensitive\" } },\r\n    ];\r\n  }\r\n\r\n  const skip = (page - 1) * pageSize;\r\n  const take = pageSize;\r\n\r\n  const prisma = getPrisma();\r\n  const [clients, total] = await Promise.all([\r\n    prisma.client.findMany({\r\n      where,\r\n      orderBy: [\r\n        { updatedAt: \"desc\" }, // Most recently updated first\r\n        { createdAt: \"desc\" },\r\n      ],\r\n      skip,\r\n      take,\r\n    }),\r\n    prisma.client.count({ where }),\r\n  ]);\r\n\r\n  return {\r\n    clients,\r\n    total,\r\n    page,\r\n    pageSize,\r\n    totalPages: Math.ceil(total / pageSize),\r\n  };\r\n}\r\n\r\n/**\r\n * Gets a single client by ID, ensuring it belongs to the owner\r\n */\r\nexport async function getClientById(\r\n  clientId: string,\r\n  ownerUserId: string\r\n) {\r\n  const prisma = getPrisma();\r\n  return await prisma.client.findFirst({\r\n    where: {\r\n      id: clientId,\r\n      ownerId: ownerUserId,\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Updates a client's details\r\n */\r\nexport async function updateClient(\r\n  clientId: string,\r\n  ownerUserId: string,\r\n  data: {\r\n    name?: string;\r\n    email?: string | null;\r\n    phone?: string | null;\r\n    company?: string | null;\r\n    suburb?: string | null;\r\n    state?: string | null;\r\n    postcode?: string | null;\r\n    tags?: string | null;\r\n    notes?: string | null;\r\n  }\r\n) {\r\n  // Normalize email if provided\r\n  const normalizedEmail = data.email?.trim().toLowerCase() || null;\r\n\r\n  const prisma = getPrisma();\r\n  return await prisma.client.update({\r\n    where: {\r\n      id: clientId,\r\n      ownerId: ownerUserId, // Ensure owner matches\r\n    },\r\n    data: {\r\n      ...data,\r\n      email: normalizedEmail,\r\n      name: data.name?.trim(),\r\n      phone: data.phone?.trim() || null,\r\n      company: data.company?.trim() || null,\r\n      suburb: data.suburb?.trim() || null,\r\n      state: data.state?.trim() || null,\r\n      postcode: data.postcode?.trim() || null,\r\n      tags: data.tags?.trim() || null,\r\n      notes: data.notes?.trim() || null,\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Gets all jobs for a client (by clientId or email match)\r\n */\r\nexport async function getJobsForClient(\r\n  clientId: string,\r\n  clientEmail: string | null,\r\n  ownerUserId: string\r\n) {\r\n  const { kv } = await import(\"./kv\");\r\n  const { getJobsForUser } = await import(\"./jobs\");\r\n  \r\n  // Get all jobs for the owner\r\n  const allJobs = await getJobsForUser(ownerUserId, false);\r\n  \r\n  // Filter jobs that match this client\r\n  const clientJobs = allJobs.filter((job) => {\r\n    // Match by clientId (newer jobs)\r\n    if (job.clientId === clientId) {\r\n      return true;\r\n    }\r\n    \r\n    // Match by email (older jobs without clientId)\r\n    if (clientEmail && job.clientEmail?.toLowerCase() === clientEmail.toLowerCase()) {\r\n      return true;\r\n    }\r\n    \r\n    return false;\r\n  });\r\n  \r\n  // Sort by createdAt descending\r\n  return clientJobs.sort((a, b) => \r\n    new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\clients.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\demo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\__tests__\\evaluateOvis.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\__tests__\\validateTemplate.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\evaluateOvis.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OvisCheck' is defined but never used.","line":8,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[334,337],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[334,337],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[354,357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[354,357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1034,1037],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1034,1037],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3411,3414],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3411,3414],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * OVIS Checks Evaluation\r\n * \r\n * Evaluates OVIS rules against merged data using a simple DSL.\r\n * Rules are warnings/flags only - not assertions of compliance.\r\n */\r\n\r\nimport type { OvisCheck, DocumentTemplate } from \"./types\";\r\n\r\n/**\r\n * Get value from nested object using dot notation path\r\n */\r\nfunction getValueByPath(obj: any, path: string): any {\r\n  const parts = path.split(\".\");\r\n  let current = obj;\r\n  \r\n  for (const part of parts) {\r\n    if (current === null || current === undefined) {\r\n      return null;\r\n    }\r\n    current = current[part];\r\n  }\r\n  \r\n  return current;\r\n}\r\n\r\n/**\r\n * Evaluate a single OVIS rule\r\n * \r\n * Supported rule syntax:\r\n * - exists(path) - checks if value exists and is not null/undefined/empty\r\n * - empty(path) - checks if value is empty/null/undefined\r\n * - len(path) < N - checks if length is less than N\r\n * - len(path) === N - checks if length equals N\r\n * - equals(path, value) - checks if value equals the given value\r\n */\r\nfunction evaluateRule(rule: string, data: Record<string, any>): boolean {\r\n  const trimmed = rule.trim();\r\n  \r\n  // exists(path)\r\n  const existsMatch = trimmed.match(/^exists\\([\"']?([^\"')]+)[\"']?\\)$/);\r\n  if (existsMatch) {\r\n    const path = existsMatch[1];\r\n    const value = getValueByPath(data, path);\r\n    return value !== null && value !== undefined && value !== \"\" && \r\n           !(Array.isArray(value) && value.length === 0);\r\n  }\r\n  \r\n  // empty(path)\r\n  const emptyMatch = trimmed.match(/^empty\\([\"']?([^\"')]+)[\"']?\\)$/);\r\n  if (emptyMatch) {\r\n    const path = emptyMatch[1];\r\n    const value = getValueByPath(data, path);\r\n    return value === null || value === undefined || value === \"\" || \r\n           (Array.isArray(value) && value.length === 0);\r\n  }\r\n  \r\n  // len(path) < N\r\n  const lenLessMatch = trimmed.match(/^len\\([\"']?([^\"')]+)[\"']?\\)\\s*<\\s*(\\d+)$/);\r\n  if (lenLessMatch) {\r\n    const path = lenLessMatch[1];\r\n    const maxLen = parseInt(lenLessMatch[2], 10);\r\n    const value = getValueByPath(data, path);\r\n    if (Array.isArray(value)) {\r\n      return value.length < maxLen;\r\n    }\r\n    if (typeof value === \"string\") {\r\n      return value.length < maxLen;\r\n    }\r\n    return true; // Non-string/non-array treated as empty\r\n  }\r\n  \r\n  // len(path) === N\r\n  const lenEqualMatch = trimmed.match(/^len\\([\"']?([^\"')]+)[\"']?\\)\\s*===\\s*(\\d+)$/);\r\n  if (lenEqualMatch) {\r\n    const path = lenEqualMatch[1];\r\n    const expectedLen = parseInt(lenEqualMatch[2], 10);\r\n    const value = getValueByPath(data, path);\r\n    if (Array.isArray(value)) {\r\n      return value.length === expectedLen;\r\n    }\r\n    if (typeof value === \"string\") {\r\n      return value.length === expectedLen;\r\n    }\r\n    return false;\r\n  }\r\n  \r\n  // equals(path, value)\r\n  const equalsMatch = trimmed.match(/^equals\\([\"']?([^\"')]+)[\"']?,\\s*[\"']?([^\"')]*)[\"']?\\)$/);\r\n  if (equalsMatch) {\r\n    const path = equalsMatch[1];\r\n    const expectedValue = equalsMatch[2];\r\n    const value = getValueByPath(data, path);\r\n    return String(value) === expectedValue;\r\n  }\r\n  \r\n  // Unknown rule syntax - log warning and return false (don't trigger warning)\r\n  console.warn(`[OVIS] Unknown rule syntax: ${rule}`);\r\n  return false;\r\n}\r\n\r\n/**\r\n * Evaluate all OVIS checks for a template against merged data\r\n * Returns warnings that should be displayed to the user\r\n */\r\nexport function evaluateOvis(\r\n  template: DocumentTemplate,\r\n  mergedData: Record<string, any>\r\n): Array<{ id: string; severity: \"low\" | \"medium\" | \"high\"; message: string }> {\r\n  const warnings: Array<{ id: string; severity: \"low\" | \"medium\" | \"high\"; message: string }> = [];\r\n  \r\n  template.ovisChecks.forEach((check) => {\r\n    const ruleResult = evaluateRule(check.rule, mergedData);\r\n    \r\n    // If rule evaluates to true, it means there's a potential issue (warning)\r\n    if (ruleResult) {\r\n      warnings.push({\r\n        id: check.id,\r\n        severity: check.severity,\r\n        message: check.message,\r\n      });\r\n    }\r\n  });\r\n  \r\n  return warnings;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\loadTemplate.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1019,1022],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1019,1022],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Template Loader\r\n * \r\n * Loads and validates document templates from JSON files.\r\n */\r\n\r\nimport { validateTemplate, TemplateValidationError } from \"./validateTemplate\";\r\nimport type { DocumentTemplate, DocType } from \"./types\";\r\n\r\n// Import templates (these will be bundled at build time)\r\nimport swmsTemplate from \"../docTemplates/swms_au_wa.json\";\r\nimport paymentClaimTemplate from \"../docTemplates/payment_claim_au_wa.json\";\r\nimport toolboxTalkTemplate from \"../docTemplates/toolbox_talk_au.json\";\r\nimport variationChangeOrderTemplate from \"../docTemplates/variation_change_order_au.json\";\r\nimport extensionOfTimeTemplate from \"../docTemplates/extension_of_time_au.json\";\r\nimport progressClaimTaxInvoiceTemplate from \"../docTemplates/progress_claim_tax_invoice_au.json\";\r\nimport handoverPracticalCompletionTemplate from \"../docTemplates/handover_practical_completion_au.json\";\r\nimport maintenanceCareGuideTemplate from \"../docTemplates/maintenance_care_guide_au.json\";\r\n\r\nconst TEMPLATE_MAP: Record<DocType, any> = {\r\n  SWMS: swmsTemplate,\r\n  PAYMENT_CLAIM_WA: paymentClaimTemplate,\r\n  TOOLBOX_TALK: toolboxTalkTemplate,\r\n  VARIATION_CHANGE_ORDER: variationChangeOrderTemplate,\r\n  EXTENSION_OF_TIME: extensionOfTimeTemplate,\r\n  PROGRESS_CLAIM_TAX_INVOICE: progressClaimTaxInvoiceTemplate,\r\n  HANDOVER_PRACTICAL_COMPLETION: handoverPracticalCompletionTemplate,\r\n  MAINTENANCE_CARE_GUIDE: maintenanceCareGuideTemplate,\r\n};\r\n\r\n/**\r\n * Load and validate a template by document type\r\n */\r\nexport function loadTemplate(docType: DocType): DocumentTemplate {\r\n  const template = TEMPLATE_MAP[docType];\r\n  \r\n  if (!template) {\r\n    throw new Error(`Template not found for document type: ${docType}`);\r\n  }\r\n  \r\n  try {\r\n    validateTemplate(template);\r\n    return template as DocumentTemplate;\r\n  } catch (error) {\r\n    if (error instanceof TemplateValidationError) {\r\n      throw new Error(`Template validation failed for ${docType}: ${error.message}${error.path ? ` (at ${error.path})` : \"\"}`);\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get all available document types\r\n */\r\nexport function getAvailableDocTypes(): DocType[] {\r\n  return Object.keys(TEMPLATE_MAP) as DocType[];\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\mergeData.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Field' is defined but never used.","line":7,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[259,262],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[259,262],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[279,282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[279,282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[615,618],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[615,618],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[641,644],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[641,644],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1151,1154],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1151,1154],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1175,1178],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1175,1178],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1214,1217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1214,1217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Data Merging\r\n * \r\n * Merges job data and user overrides into template fields.\r\n */\r\n\r\nimport type { JobData, Field, DocumentTemplate } from \"./types\";\r\n\r\n/**\r\n * Get value from nested object using dot notation path\r\n */\r\nfunction getValueByPath(obj: any, path: string): any {\r\n  const parts = path.split(\".\");\r\n  let current = obj;\r\n  \r\n  for (const part of parts) {\r\n    if (current === null || current === undefined) {\r\n      return null;\r\n    }\r\n    current = current[part];\r\n  }\r\n  \r\n  return current;\r\n}\r\n\r\n/**\r\n * Set value in nested object using dot notation path\r\n */\r\nfunction setValueByPath(obj: any, path: string, value: any): void {\r\n  const parts = path.split(\".\");\r\n  let current = obj;\r\n  \r\n  for (let i = 0; i < parts.length - 1; i++) {\r\n    const part = parts[i];\r\n    if (!current[part] || typeof current[part] !== \"object\") {\r\n      current[part] = {};\r\n    }\r\n    current = current[part];\r\n  }\r\n  \r\n  current[parts[parts.length - 1]] = value;\r\n}\r\n\r\n/**\r\n * Merge job data and overrides into template fields\r\n */\r\nexport function mergeData(\r\n  template: DocumentTemplate,\r\n  jobData: JobData,\r\n  overrides?: Record<string, any>\r\n): Record<string, any> {\r\n  const merged: Record<string, any> = { ...jobData };\r\n  \r\n  // Apply overrides first (highest priority)\r\n  if (overrides) {\r\n    Object.assign(merged, overrides);\r\n  }\r\n  \r\n  // Fill in default values from template fields\r\n  template.sections.forEach((section) => {\r\n    if (section.fields) {\r\n      section.fields.forEach((field) => {\r\n        const fieldPath = field.dataPath || field.id;\r\n        const currentValue = getValueByPath(merged, fieldPath);\r\n        \r\n        // If field has no value, use default or empty value\r\n        if (currentValue === null || currentValue === undefined || currentValue === \"\") {\r\n          if (field.defaultValue !== undefined) {\r\n            setValueByPath(merged, fieldPath, field.defaultValue);\r\n          } else {\r\n            // Set appropriate empty value based on type\r\n            switch (field.type) {\r\n              case \"number\":\r\n              case \"currency\":\r\n                setValueByPath(merged, fieldPath, null);\r\n                break;\r\n              case \"multiSelect\":\r\n                setValueByPath(merged, fieldPath, []);\r\n                break;\r\n              default:\r\n                setValueByPath(merged, fieldPath, \"\");\r\n            }\r\n          }\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Handle table rows\r\n    if (section.table) {\r\n      const rowsKey = section.table.rowsKey;\r\n      if (!getValueByPath(merged, rowsKey)) {\r\n        setValueByPath(merged, rowsKey, []);\r\n      }\r\n    }\r\n  });\r\n  \r\n  return merged;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\mapCommon.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\mapEot.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mapCommon' is defined but never used.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Extension of Time (EOT) Prefill Mapper\r\n * \r\n * Maps job data to EOT document fields:\r\n * - Auto-generates EOT number (EOT-001, EOT-002...)\r\n * - Prefills job completion target if exists\r\n * - Leaves cause/days requested blank (required user input)\r\n */\r\n\r\nimport type { JobData } from \"../types\";\r\nimport { mapCommon, type CommonPrefillData } from \"./mapCommon\";\r\n\r\nexport interface EotPrefillData extends CommonPrefillData {\r\n  eotNumber?: string;\r\n  contractReference?: string;\r\n  originalCompletionDate?: string; // ISO date string\r\n  delayCause?: string; // Required, left blank for user to fill\r\n  daysRequested?: number | null; // Required\r\n  supportingInfo?: string;\r\n}\r\n\r\n/**\r\n * Generate next EOT number for a job\r\n * Format: EOT-001, EOT-002, etc.\r\n */\r\nfunction generateEotNumber(jobId: string, existingCount: number = 0): string {\r\n  const num = (existingCount + 1).toString().padStart(3, \"0\");\r\n  return `EOT-${num}`;\r\n}\r\n\r\n/**\r\n * Estimate completion date from job creation date\r\n * Default: 14 days from creation (rough estimate)\r\n */\r\nfunction estimateCompletionDate(job: JobData): string | null {\r\n  if (!job.createdAt) return null;\r\n  \r\n  try {\r\n    const created = new Date(job.createdAt);\r\n    const estimated = new Date(created);\r\n    estimated.setDate(estimated.getDate() + 14); // 2 weeks default\r\n    return estimated.toISOString().split(\"T\")[0]; // YYYY-MM-DD\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Map job data to EOT document fields\r\n */\r\nexport function mapEot(\r\n  job: JobData,\r\n  commonData: CommonPrefillData,\r\n  existingEotCount: number = 0\r\n): EotPrefillData {\r\n  const completionDate = estimateCompletionDate(job);\r\n  return {\r\n    ...commonData,\r\n    eotNumber: generateEotNumber(job.jobId || job.id || \"\", existingEotCount),\r\n    contractReference: job.jobId || job.id || \"\",\r\n    originalCompletionDate: completionDate ?? undefined,\r\n    delayCause: \"\", // Required, user must fill\r\n    daysRequested: null, // Required\r\n    supportingInfo: \"\",\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\mapHandover.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mapCommon' is defined but never used.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Handover & Practical Completion Prefill Mapper\r\n * \r\n * Maps job data to Handover document fields:\r\n * - Prefills completion date: today\r\n * - Prefills summary of works from scope\r\n * - Default defects: \"None\" but editable\r\n */\r\n\r\nimport type { JobData } from \"../types\";\r\nimport { mapCommon, type CommonPrefillData } from \"./mapCommon\";\r\n\r\nexport interface HandoverPrefillData extends CommonPrefillData {\r\n  completionDate?: string; // ISO date string, defaults to today\r\n  summaryOfWorks?: string;\r\n  defects?: string; // Default: \"None\"\r\n  documentsHandedOver?: string;\r\n  keysReturned?: boolean;\r\n  manualsProvided?: boolean;\r\n}\r\n\r\n/**\r\n * Map job data to Handover document fields\r\n */\r\nexport function mapHandover(\r\n  job: JobData,\r\n  commonData: CommonPrefillData\r\n): HandoverPrefillData {\r\n  const today = new Date().toISOString().split(\"T\")[0];\r\n  \r\n  // Build summary of works from scope\r\n  const summaryParts: string[] = [];\r\n  if (job.aiScopeOfWork) summaryParts.push(job.aiScopeOfWork);\r\n  if (job.aiSummary) summaryParts.push(job.aiSummary);\r\n  const summaryOfWorks = summaryParts.length > 0 \r\n    ? summaryParts.join(\"\\n\\n\") \r\n    : job.notes || \"\";\r\n  \r\n  return {\r\n    ...commonData,\r\n    completionDate: today,\r\n    summaryOfWorks,\r\n    defects: \"None\", // Default, but editable\r\n    documentsHandedOver: \"\",\r\n    keysReturned: false,\r\n    manualsProvided: false,\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\mapInvoice.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mapCommon' is defined but never used.","line":13,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Progress Claim / Tax Invoice Prefill Mapper\r\n * \r\n * Maps job data to Invoice document fields:\r\n * - Auto-generates invoice number (INV-0001, INV-0002...)\r\n * - Issue date: today\r\n * - Due date: today + 7 days (default)\r\n * - Prefills line items from pricing snapshot (labour/materials as two rows)\r\n * - Requires user to confirm GST and amounts\r\n */\r\n\r\nimport type { JobData } from \"../types\";\r\nimport { mapCommon, type CommonPrefillData } from \"./mapCommon\";\r\n\r\nexport interface InvoiceLineItem {\r\n  description: string;\r\n  quantity: number | null;\r\n  unit: string;\r\n  rate: number | null;\r\n  amount: number | null;\r\n}\r\n\r\nexport interface InvoicePrefillData extends CommonPrefillData {\r\n  invoiceNumber?: string;\r\n  issueDate?: string; // ISO date string, defaults to today\r\n  dueDate?: string; // ISO date string, defaults to today + 7 days\r\n  claimNumber?: string;\r\n  period?: string;\r\n  lineItems?: InvoiceLineItem[];\r\n  subtotal?: number | null;\r\n  gstAmount?: number | null;\r\n  totalInclGst?: number | null;\r\n  paymentTerms?: string;\r\n  includeMaterialsMarkup?: boolean; // Whether to include markup in materials line item (default: false for client-facing)\r\n}\r\n\r\n/**\r\n * Generate next invoice number for a job\r\n * Format: INV-0001, INV-0002, etc.\r\n */\r\nfunction generateInvoiceNumber(jobId: string, existingCount: number = 0): string {\r\n  const num = (existingCount + 1).toString().padStart(4, \"0\");\r\n  return `INV-${num}`;\r\n}\r\n\r\n/**\r\n * Parse pricing data from job.aiQuote JSON\r\n * For client-facing documents, use materialsSubtotal (excludes markup)\r\n * For internal use, can use materialsTotal (includes markup)\r\n */\r\nfunction parsePricingData(job: JobData, includeMarkup: boolean = false): {\r\n  labourSubtotal?: number;\r\n  materialsSubtotal?: number;\r\n  materialsMarkupTotal?: number;\r\n  materialsTotal?: number;\r\n  subtotal?: number;\r\n  gstAmount?: number;\r\n  totalInclGst?: number;\r\n} {\r\n  if (!job.aiQuote) {\r\n    // Fallback to job-level materials totals if available\r\n    if (job.materialsSubtotal !== undefined || job.materialsTotal !== undefined) {\r\n      return {\r\n        materialsSubtotal: job.materialsSubtotal ?? undefined,\r\n        materialsMarkupTotal: job.materialsMarkupTotal ?? undefined,\r\n        materialsTotal: includeMarkup ? (job.materialsTotal ?? undefined) : (job.materialsSubtotal ?? undefined),\r\n      };\r\n    }\r\n    return {};\r\n  }\r\n  \r\n  try {\r\n    const quote = typeof job.aiQuote === \"string\" ? JSON.parse(job.aiQuote) : job.aiQuote;\r\n    const materialsTotalFromQuote = quote.totalEstimate?.materialsTotal || quote.materialsTotal;\r\n    \r\n    // For client-facing, prefer materialsSubtotal (without markup)\r\n    // For internal use, use materialsTotal (with markup) if includeMarkup is true\r\n    const materialsAmount = includeMarkup \r\n      ? materialsTotalFromQuote \r\n      : (job.materialsSubtotal ?? materialsTotalFromQuote);\r\n    \r\n    return {\r\n      labourSubtotal: quote.totalEstimate?.labourSubtotal || quote.labourSubtotal,\r\n      materialsSubtotal: job.materialsSubtotal ?? undefined,\r\n      materialsMarkupTotal: job.materialsMarkupTotal ?? undefined,\r\n      materialsTotal: materialsAmount,\r\n      subtotal: quote.totalEstimate?.subtotal || quote.subtotal,\r\n      gstAmount: quote.totalEstimate?.gstAmount || quote.gstAmount,\r\n      totalInclGst: quote.totalEstimate?.totalJobEstimate || quote.totalInclGst || quote.total,\r\n    };\r\n  } catch {\r\n    // Fallback to job-level materials totals\r\n    if (job.materialsSubtotal !== undefined || job.materialsTotal !== undefined) {\r\n      return {\r\n        materialsSubtotal: job.materialsSubtotal ?? undefined,\r\n        materialsMarkupTotal: job.materialsMarkupTotal ?? undefined,\r\n        materialsTotal: includeMarkup ? (job.materialsTotal ?? undefined) : (job.materialsSubtotal ?? undefined),\r\n      };\r\n    }\r\n    return {};\r\n  }\r\n}\r\n\r\n/**\r\n * Map job data to Invoice document fields\r\n * @param includeMarkup - Whether to include materials markup (default: false for client-facing docs)\r\n */\r\nexport function mapInvoice(\r\n  job: JobData,\r\n  commonData: CommonPrefillData,\r\n  existingInvoiceCount: number = 0,\r\n  includeMarkup: boolean = false\r\n): InvoicePrefillData {\r\n  const today = new Date();\r\n  const dueDate = new Date(today);\r\n  dueDate.setDate(dueDate.getDate() + 7); // 7 days default\r\n  \r\n  const pricing = parsePricingData(job, includeMarkup);\r\n  \r\n  // Build line items from pricing snapshot\r\n  const lineItems: InvoiceLineItem[] = [];\r\n  \r\n  if (pricing.labourSubtotal && pricing.labourSubtotal > 0) {\r\n    lineItems.push({\r\n      description: \"Labour\",\r\n      quantity: null,\r\n      unit: \"Item\",\r\n      rate: null,\r\n      amount: pricing.labourSubtotal,\r\n    });\r\n  }\r\n  \r\n  // Use materials amount (with or without markup based on includeMarkup flag)\r\n  const materialsAmount = pricing.materialsTotal || pricing.materialsSubtotal;\r\n  if (materialsAmount && materialsAmount > 0) {\r\n    lineItems.push({\r\n      description: \"Materials\",\r\n      quantity: null,\r\n      unit: \"Item\",\r\n      rate: null,\r\n      amount: materialsAmount,\r\n    });\r\n  }\r\n  \r\n  // If no line items, add a placeholder\r\n  if (lineItems.length === 0) {\r\n    lineItems.push({\r\n      description: \"\",\r\n      quantity: null,\r\n      unit: \"\",\r\n      rate: null,\r\n      amount: null,\r\n    });\r\n  }\r\n  \r\n  return {\r\n    ...commonData,\r\n    invoiceNumber: generateInvoiceNumber(job.jobId || job.id || \"\", existingInvoiceCount),\r\n    issueDate: today.toISOString().split(\"T\")[0],\r\n    dueDate: dueDate.toISOString().split(\"T\")[0],\r\n    claimNumber: `PC-${(existingInvoiceCount + 1).toString().padStart(3, \"0\")}`,\r\n    period: \"\", // User can fill\r\n    lineItems,\r\n    subtotal: pricing.subtotal || null,\r\n    gstAmount: pricing.gstAmount || null,\r\n    totalInclGst: pricing.totalInclGst || null,\r\n    paymentTerms: \"Payment due within 14 days\",\r\n    includeMaterialsMarkup: includeMarkup,\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\mapMaintenance.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mapCommon' is defined but never used.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[982,985],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[982,985],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Maintenance & Care Guide Prefill Mapper\r\n * \r\n * Maps job data to Maintenance document fields:\r\n * - Prefills materials/finishes from materials list if available\r\n * - Otherwise uses placeholders\r\n */\r\n\r\nimport type { JobData } from \"../types\";\r\nimport { mapCommon, type CommonPrefillData } from \"./mapCommon\";\r\n\r\nexport interface MaintenancePrefillData extends CommonPrefillData {\r\n  materialsUsed?: string;\r\n  finishes?: string;\r\n  generalCare?: string;\r\n  specificInstructions?: string;\r\n  recoatInterval?: string;\r\n  warrantyInfo?: string;\r\n}\r\n\r\n/**\r\n * Parse materials from job data\r\n */\r\nfunction parseMaterials(job: JobData): string {\r\n  if (job.materialsOverrideText) {\r\n    return job.materialsOverrideText;\r\n  }\r\n  \r\n  if (job.aiMaterials) {\r\n    try {\r\n      const materials = typeof job.aiMaterials === \"string\" \r\n        ? JSON.parse(job.aiMaterials) \r\n        : job.aiMaterials;\r\n      \r\n      if (Array.isArray(materials)) {\r\n        return materials.map((m: any) => m.item || m.name || m).join(\", \");\r\n      }\r\n      \r\n      return String(materials);\r\n    } catch {\r\n      return job.aiMaterials;\r\n    }\r\n  }\r\n  \r\n  return \"\";\r\n}\r\n\r\n/**\r\n * Map job data to Maintenance document fields\r\n */\r\nexport function mapMaintenance(\r\n  job: JobData,\r\n  commonData: CommonPrefillData\r\n): MaintenancePrefillData {\r\n  const materialsUsed = parseMaterials(job);\r\n  \r\n  return {\r\n    ...commonData,\r\n    materialsUsed,\r\n    finishes: \"\", // User can fill based on materials\r\n    generalCare: \"\", // User must provide\r\n    specificInstructions: \"\", // User must provide\r\n    recoatInterval: \"5-7 years (interior)\", // Default guidance\r\n    warrantyInfo: \"\", // User can customize\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\prefill\\mapVariation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mapCommon' is defined but never used.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Variation / Change Order Prefill Mapper\r\n * \r\n * Maps job data to Variation document fields:\r\n * - Auto-generates variation number (VAR-001, VAR-002...)\r\n * - Pulls scope/inclusions/exclusions snapshot as reference text\r\n * - Leaves variationDescription blank (required user input)\r\n */\r\n\r\nimport type { JobData } from \"../types\";\r\nimport { mapCommon, type CommonPrefillData } from \"./mapCommon\";\r\n\r\nexport interface VariationPrefillData extends CommonPrefillData {\r\n  variationNumber?: string;\r\n  contractReference?: string;\r\n  originalScopeReference?: string;\r\n  variationDescription?: string; // Required, left blank for user to fill\r\n  costImpact?: number | null;\r\n  timeImpactDays?: number | null;\r\n}\r\n\r\n/**\r\n * Generate next variation number for a job\r\n * Format: VAR-001, VAR-002, etc.\r\n * In a real system, this would query existing variations for the job.\r\n * For MVP, we'll use a simple incrementing approach.\r\n */\r\nfunction generateVariationNumber(jobId: string, existingCount: number = 0): string {\r\n  const num = (existingCount + 1).toString().padStart(3, \"0\");\r\n  return `VAR-${num}`;\r\n}\r\n\r\n/**\r\n * Map job data to Variation document fields\r\n */\r\nexport function mapVariation(\r\n  job: JobData,\r\n  commonData: CommonPrefillData,\r\n  existingVariationCount: number = 0\r\n): VariationPrefillData {\r\n  // Build original scope reference from job data\r\n  const scopeParts: string[] = [];\r\n  if (job.aiScopeOfWork) scopeParts.push(`Scope: ${job.aiScopeOfWork}`);\r\n  if (job.aiInclusions) scopeParts.push(`Inclusions: ${job.aiInclusions}`);\r\n  if (job.aiExclusions) scopeParts.push(`Exclusions: ${job.aiExclusions}`);\r\n  const originalScopeReference = scopeParts.length > 0 ? scopeParts.join(\"\\n\\n\") : \"\";\r\n  \r\n  return {\r\n    ...commonData,\r\n    variationNumber: generateVariationNumber(job.jobId || job.id || \"\", existingVariationCount),\r\n    contractReference: job.jobId || job.id || \"\",\r\n    originalScopeReference,\r\n    variationDescription: \"\", // Required, user must fill\r\n    costImpact: null,\r\n    timeImpactDays: null,\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\renderModel.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[818,821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[818,821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[838,841],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[838,841],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1540,1543],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1540,1543],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":119,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3497,3500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3497,3500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":163,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5033,5036],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5033,5036],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":164,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5090,5093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5090,5093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":177,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5633,5636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5633,5636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Render Model Generation\r\n * \r\n * Converts template + merged data into a render model for UI/PDF rendering.\r\n */\r\n\r\nimport type { DocumentTemplate, RenderModel, RenderSection, RenderField, RenderTable, JobData } from \"./types\";\r\nimport { mergeData } from \"./mergeData\";\r\nimport { evaluateOvis } from \"./evaluateOvis\";\r\n\r\n/**\r\n * Generate a stable Record ID for document exports\r\n * Format: OX-<docType>-<YYYYMMDD>-<6char>\r\n */\r\nfunction generateRecordId(docType: string): string {\r\n  const date = new Date();\r\n  const dateStr = date.toISOString().slice(0, 10).replace(/-/g, \"\");\r\n  const randomStr = Math.random().toString(36).substring(2, 8).toUpperCase();\r\n  return `OX-${docType}-${dateStr}-${randomStr}`;\r\n}\r\n\r\n/**\r\n * Get value from nested object using dot notation path\r\n */\r\nfunction getValueByPath(obj: any, path: string): any {\r\n  const parts = path.split(\".\");\r\n  let current = obj;\r\n  \r\n  for (const part of parts) {\r\n    if (current === null || current === undefined) {\r\n      return null;\r\n    }\r\n    current = current[part];\r\n  }\r\n  \r\n  return current;\r\n}\r\n\r\n/**\r\n * Format ABN in Australian format (XX XXX XXX XXX)\r\n */\r\nfunction formatABN(abn: string | null | undefined): string {\r\n  if (!abn) return \"\";\r\n  const cleaned = abn.replace(/\\s/g, \"\");\r\n  if (cleaned.length === 11) {\r\n    return `${cleaned.slice(0, 2)} ${cleaned.slice(2, 5)} ${cleaned.slice(5, 8)} ${cleaned.slice(8, 11)}`;\r\n  }\r\n  return abn;\r\n}\r\n\r\n/**\r\n * Format value based on field type (Australian standards)\r\n */\r\nfunction formatFieldValue(value: any, fieldType: string, fieldId?: string): string | number | null {\r\n  if (value === null || value === undefined || value === \"\") {\r\n    return null;\r\n  }\r\n  \r\n  // Format ABN fields\r\n  if (fieldId && (fieldId.toLowerCase().includes(\"abn\") || fieldId.toLowerCase().includes(\"claimant-abn\") || fieldId.toLowerCase().includes(\"prepared-by-abn\"))) {\r\n    return formatABN(String(value));\r\n  }\r\n  \r\n  switch (fieldType) {\r\n    case \"currency\":\r\n      if (typeof value === \"number\") {\r\n        // Use Australian currency format\r\n        return new Intl.NumberFormat(\"en-AU\", {\r\n          style: \"currency\",\r\n          currency: \"AUD\",\r\n          minimumFractionDigits: 2,\r\n          maximumFractionDigits: 2,\r\n        }).format(value);\r\n      }\r\n      return String(value);\r\n    case \"number\":\r\n      if (typeof value === \"number\") {\r\n        return value;\r\n      }\r\n      const num = parseFloat(String(value));\r\n      return isNaN(num) ? null : num;\r\n    case \"date\":\r\n      if (value instanceof Date) {\r\n        // Format as Australian date (DD/MM/YYYY)\r\n        return value.toLocaleDateString(\"en-AU\", {\r\n          day: \"2-digit\",\r\n          month: \"2-digit\",\r\n          year: \"numeric\",\r\n        });\r\n      }\r\n      if (typeof value === \"string\") {\r\n        // Try to parse and format as Australian date\r\n        const date = new Date(value);\r\n        if (!isNaN(date.getTime())) {\r\n          return date.toLocaleDateString(\"en-AU\", {\r\n            day: \"2-digit\",\r\n            month: \"2-digit\",\r\n            year: \"numeric\",\r\n          });\r\n        }\r\n      }\r\n      return String(value);\r\n    case \"multiSelect\":\r\n      if (Array.isArray(value)) {\r\n        return value.join(\", \");\r\n      }\r\n      return String(value);\r\n    default:\r\n      return String(value);\r\n  }\r\n}\r\n\r\n/**\r\n * Generate render model from template and job data\r\n */\r\nexport function generateRenderModel(\r\n  template: DocumentTemplate,\r\n  jobData: JobData,\r\n  overrides?: Record<string, any>\r\n): RenderModel {\r\n  // Merge data\r\n  const merged = mergeData(template, jobData, overrides);\r\n  \r\n  // Evaluate OVIS checks\r\n  const ovisWarnings = evaluateOvis(template, merged);\r\n  \r\n  // Generate record ID and timestamp\r\n  const recordId = generateRecordId(template.docType);\r\n  const timestamp = new Date().toISOString();\r\n  \r\n  // Build render sections\r\n  const renderSections: RenderSection[] = template.sections\r\n    .sort((a, b) => (a.order || 0) - (b.order || 0))\r\n    .map((section): RenderSection => {\r\n      const renderSection: RenderSection = {\r\n        id: section.id,\r\n        title: section.title,\r\n      };\r\n      \r\n      // Process fields\r\n      if (section.fields) {\r\n        renderSection.fields = section.fields.map((field): RenderField => {\r\n          const dataPath = field.dataPath || field.id;\r\n          const rawValue = getValueByPath(merged, dataPath);\r\n          const formattedValue = formatFieldValue(rawValue, field.type, field.id);\r\n          \r\n          return {\r\n            id: field.id,\r\n            label: field.label,\r\n            type: field.type,\r\n            value: formattedValue,\r\n            required: field.required || false,\r\n            placeholder: field.placeholder,\r\n            options: field.options,\r\n          };\r\n        });\r\n      }\r\n      \r\n      // Process table\r\n      if (section.table) {\r\n        const rowsData = getValueByPath(merged, section.table.rowsKey) || [];\r\n        const rows: RenderTable[\"rows\"] = Array.isArray(rowsData) \r\n          ? rowsData.map((row: any) => {\r\n              const renderRow: Record<string, any> = {};\r\n              section.table!.columns.forEach((col) => {\r\n                const colPath = col.id;\r\n                const rawValue = row[colPath] || getValueByPath(row, colPath) || \"\";\r\n                renderRow[col.id] = formatFieldValue(rawValue, col.type || \"text\");\r\n              });\r\n              return renderRow;\r\n            })\r\n          : [];\r\n        \r\n        // Ensure minimum rows\r\n        const minRows = section.table.minRows || 0;\r\n        while (rows.length < minRows) {\r\n          const emptyRow: Record<string, any> = {};\r\n          section.table.columns.forEach((col) => {\r\n            emptyRow[col.id] = null;\r\n          });\r\n          rows.push(emptyRow);\r\n        }\r\n        \r\n        renderSection.table = {\r\n          id: section.table.id,\r\n          columns: section.table.columns,\r\n          rows,\r\n          minRows: section.table.minRows || 0,\r\n        };\r\n      }\r\n      \r\n      return renderSection;\r\n    });\r\n  \r\n  return {\r\n    docType: template.docType,\r\n    title: template.title,\r\n    disclaimer: template.disclaimer,\r\n    recordId,\r\n    timestamp,\r\n    sections: renderSections,\r\n    ovisWarnings,\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\renderPdf.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is assigned a value but never used.","line":95,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * PDF Rendering\n * \n * Renders a RenderModel to PDF using the existing PdfDocument class.\n * Optimized for Australian construction industry standards.\n * \n * Supports two audiences:\n * - INTERNAL: Shows AI/OVIS warnings and disclaimers (for drafts)\n * - CLIENT: Professional client-facing export with business header, no AI warnings\n */\n\nimport { PdfDocument, PDF_CONFIG } from \"../pdfGenerator\";\nimport type { RenderModel, RenderSection, RenderField, RenderTable, IssuerProfile, DocumentAudience } from \"./types\";\nimport { formatABN, formatBusinessAddress } from \"./validateIssuer\";\n\n/**\n * Format date in Australian format (DD/MM/YYYY)\n */\nfunction formatAustralianDate(dateString: string | null | undefined): string {\n  if (!dateString) return \"\";\n  try {\n    const date = new Date(dateString);\n    if (isNaN(date.getTime())) return dateString;\n    return date.toLocaleDateString(\"en-AU\", {\n      day: \"2-digit\",\n      month: \"2-digit\",\n      year: \"numeric\",\n    });\n  } catch {\n    return dateString;\n  }\n}\n\n/**\n * Format currency in Australian format ($X,XXX.XX)\n */\nfunction formatAustralianCurrency(value: string | number | null | undefined): string {\n  if (value === null || value === undefined || value === \"\") return \"$0.00\";\n  const num = typeof value === \"string\" ? parseFloat(value.replace(/[^0-9.-]/g, \"\")) : value;\n  if (isNaN(num)) return \"$0.00\";\n  return new Intl.NumberFormat(\"en-AU\", {\n    style: \"currency\",\n    currency: \"AUD\",\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  }).format(num);\n}\n\n// formatABN imported from validateIssuer\n\n/**\n * Options for rendering a document to PDF\n */\nexport interface RenderPdfOptions {\n  /** Whether the document has been approved (legacy parameter) */\n  approved?: boolean;\n  /** Document audience: INTERNAL (with warnings) or CLIENT (professional, no AI warnings) */\n  audience?: DocumentAudience;\n  /** Issuer profile for business header (required for CLIENT audience) */\n  issuer?: IssuerProfile | null;\n  /** Issued record ID (for client exports) */\n  issuedRecordId?: string | null;\n  /** Issue timestamp (for client exports) */\n  issuedAt?: string | null;\n}\n\n/**\n * Render a document model to PDF\n * @param model - The render model to convert to PDF\n * @param options - Rendering options including audience and issuer\n */\nexport function renderModelToPdf(\n  model: RenderModel, \n  optionsOrApproved: boolean | RenderPdfOptions = false\n): PdfDocument {\n  // Handle legacy boolean parameter for backwards compatibility\n  const options: RenderPdfOptions = typeof optionsOrApproved === \"boolean\"\n    ? { approved: optionsOrApproved }\n    : optionsOrApproved;\n\n  const {\n    approved = false,\n    audience = \"INTERNAL\",\n    issuer = null,\n    issuedRecordId = null,\n    issuedAt = null,\n  } = options;\n\n  // For CLIENT audience, we never show AI warnings\n  // For INTERNAL, we show warnings unless explicitly approved\n  const showWarnings = audience === \"INTERNAL\" && !approved;\n  const isClientExport = audience === \"CLIENT\";\n\n  const pdf = new PdfDocument();\n  const doc = pdf.getDoc();\n\n  // For CLIENT exports, add business identity header\n  if (isClientExport && issuer) {\n    renderBusinessHeader(pdf, issuer);\n    pdf.addSpace(4);\n  }\n\n  // Title with better formatting\n  pdf.addTitle(model.title);\n  pdf.addSeparator();\n\n  // Record ID and timestamp metadata (Australian format)\n  const displayRecordId = issuedRecordId || model.recordId;\n  const displayTimestamp = issuedAt \n    ? new Date(issuedAt).toLocaleDateString(\"en-AU\", {\n        day: \"numeric\",\n        month: \"long\",\n        year: \"numeric\",\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      })\n    : new Date(model.timestamp).toLocaleDateString(\"en-AU\", {\n        day: \"numeric\",\n        month: \"long\",\n        year: \"numeric\",\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n  \n  const metadata: { label: string; value: string }[] = [\n    { label: isClientExport ? \"Document ID\" : \"Record ID\", value: displayRecordId },\n  ];\n  \n  if (isClientExport) {\n    metadata.push({ label: \"Issued\", value: displayTimestamp });\n  } else {\n    metadata.push({ label: \"Generated\", value: displayTimestamp });\n  }\n\n  pdf.addMetadata(metadata);\n\n  // Only show disclaimer/warnings for INTERNAL audience when not approved\n  if (showWarnings) {\n    // Disclaimer (warning box) - AI warning\n    pdf.addAiWarning();\n    pdf.addParagraph(model.disclaimer);\n    pdf.addSeparator();\n  }\n\n  // Render sections with improved formatting\n  model.sections.forEach((section, index) => {\n    renderSectionToPdf(pdf, section, index === 0);\n  });\n\n  // Set custom footer based on audience\n  if (isClientExport && issuer) {\n    // Professional footer for client exports - NO AI/OVIS language\n    renderClientFooter(pdf, issuer, displayRecordId, displayTimestamp);\n  } else {\n    // Internal footer with warnings if applicable\n    renderInternalFooter(pdf, model, displayRecordId, displayTimestamp, showWarnings);\n  }\n\n  return pdf;\n}\n\n/**\n * Render business identity header for client-facing PDFs\n * NO AI/OVIS warnings - professional business header only\n */\nfunction renderBusinessHeader(pdf: PdfDocument, issuer: IssuerProfile): void {\n  const doc = pdf.getDoc();\n  const pageWidth = doc.internal.pageSize.width;\n  const marginLeft = PDF_CONFIG.marginLeft;\n  const marginRight = PDF_CONFIG.marginRight;\n  const maxWidth = pageWidth - marginLeft - marginRight;\n\n  // Header background (subtle)\n  doc.setFillColor(248, 250, 252); // slate-50\n  doc.rect(0, 0, pageWidth, 45, \"F\");\n  \n  // Bottom border\n  doc.setDrawColor(226, 232, 240); // slate-200\n  doc.setLineWidth(0.5);\n  doc.line(0, 45, pageWidth, 45);\n\n  let yPos = 12;\n\n  // Business legal name (large)\n  doc.setFontSize(16);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.setTextColor(15, 23, 42); // slate-900\n  doc.text(issuer.legalName || \"Business Name\", marginLeft, yPos);\n  yPos += 6;\n\n  // Trading name (if different)\n  if (issuer.tradingName && issuer.tradingName !== issuer.legalName) {\n    doc.setFontSize(10);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(71, 85, 105); // slate-600\n    doc.text(`Trading as: ${issuer.tradingName}`, marginLeft, yPos);\n    yPos += 4;\n  }\n\n  // ABN (formatted)\n  if (issuer.abn) {\n    doc.setFontSize(9);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(100, 116, 139); // slate-500\n    doc.text(`ABN: ${formatABN(issuer.abn)}`, marginLeft, yPos);\n    yPos += 4;\n  }\n\n  // Contact info on right side\n  let rightY = 12;\n  const rightX = pageWidth - marginRight;\n\n  // Phone\n  if (issuer.phone) {\n    doc.setFontSize(9);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(71, 85, 105); // slate-600\n    doc.text(issuer.phone, rightX, rightY, { align: \"right\" });\n    rightY += 4;\n  }\n\n  // Email\n  if (issuer.email) {\n    doc.setFontSize(9);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(71, 85, 105); // slate-600\n    doc.text(issuer.email, rightX, rightY, { align: \"right\" });\n    rightY += 4;\n  }\n\n  // Address\n  const fullAddress = formatBusinessAddress(issuer);\n  if (fullAddress) {\n    doc.setFontSize(8);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(100, 116, 139); // slate-500\n    const addressLines = doc.splitTextToSize(fullAddress, maxWidth / 2);\n    addressLines.forEach((line: string) => {\n      doc.text(line, rightX, rightY, { align: \"right\" });\n      rightY += 3.5;\n    });\n  }\n\n  // Set Y position after header\n  pdf.setY(55);\n}\n\n/**\n * Render professional footer for client-facing PDFs\n * NO AI/OVIS disclaimers - just professional issuer info\n */\nfunction renderClientFooter(\n  pdf: PdfDocument, \n  issuer: IssuerProfile,\n  recordId: string,\n  timestamp: string\n): void {\n  const doc = pdf.getDoc();\n  const totalPages = doc.getNumberOfPages();\n  const pageWidth = doc.internal.pageSize.width;\n  const pageHeight = doc.internal.pageSize.height;\n\n  for (let i = 1; i <= totalPages; i++) {\n    doc.setPage(i);\n    \n    // Footer line\n    doc.setDrawColor(226, 232, 240); // slate-200\n    doc.setLineWidth(0.3);\n    doc.line(PDF_CONFIG.marginLeft, pageHeight - 18, pageWidth - PDF_CONFIG.marginRight, pageHeight - 18);\n\n    // Issued by line\n    doc.setFontSize(7);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(100, 116, 139); // slate-500\n    doc.text(\n      `Issued by ${issuer.legalName}`,\n      pageWidth / 2,\n      pageHeight - 13,\n      { align: \"center\" }\n    );\n    \n    // Document ID and page number\n    doc.text(\n      `Document ID: ${recordId} | ${timestamp} | Page ${i} of ${totalPages}`,\n      pageWidth / 2,\n      pageHeight - 9,\n      { align: \"center\" }\n    );\n  }\n}\n\n/**\n * Render footer for internal/draft PDFs\n * Includes AI/OVIS warnings when appropriate\n */\nfunction renderInternalFooter(\n  pdf: PdfDocument,\n  model: RenderModel,\n  recordId: string,\n  timestamp: string,\n  showWarnings: boolean\n): void {\n  const doc = pdf.getDoc();\n  const totalPages = doc.getNumberOfPages();\n  const pageWidth = doc.internal.pageSize.width;\n  const pageHeight = doc.internal.pageSize.height;\n\n  for (let i = 1; i <= totalPages; i++) {\n    doc.setPage(i);\n    doc.setFontSize(7);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(100, 116, 139); // slate-500\n    \n    // Only show disclaimer if warnings are enabled\n    if (showWarnings) {\n      // OVIS line\n      doc.text(\n        \"OVIS Checked Output - OMNEXORA Checked Intelligence Systems\",\n        pageWidth / 2,\n        pageHeight - 20,\n        { align: \"center\" }\n      );\n      \n      // Disclaimer line\n      doc.text(\n        \"Draft generated from user inputs. Review required. Not certified or verified.\",\n        pageWidth / 2,\n        pageHeight - 15,\n        { align: \"center\" }\n      );\n    }\n    \n    // Record ID and timestamp\n    doc.text(\n      `Record ID: ${recordId} | Generated: ${timestamp} | Page ${i} of ${totalPages}`,\n      pageWidth / 2,\n      pageHeight - 10,\n      { align: \"center\" }\n    );\n  }\n}\n\nfunction renderSectionToPdf(pdf: PdfDocument, section: RenderSection, isFirstSection: boolean = false): void {\n  // Add extra space before first section\n  if (!isFirstSection) {\n    pdf.addSpace(4);\n  }\n  \n  pdf.addSectionHeading(section.title);\n\n  // Render fields with improved layout\n  if (section.fields && section.fields.length > 0) {\n    // Group fields into logical pairs for better layout\n    const fieldsToRender = [...section.fields];\n    \n    // Render fields in a grid-like layout (2 columns when possible)\n    for (let i = 0; i < fieldsToRender.length; i += 2) {\n      const field1 = fieldsToRender[i];\n      const field2 = fieldsToRender[i + 1];\n      \n      if (field1) {\n        renderFieldToPdf(pdf, field1, field2 ? 0 : undefined);\n      }\n      if (field2) {\n        renderFieldToPdf(pdf, field2, 1);\n      }\n      \n      // Add spacing between field pairs\n      if (i + 2 < fieldsToRender.length) {\n        pdf.addSpace(2);\n      }\n    }\n  }\n\n  // Render table with improved formatting\n  if (section.table) {\n    pdf.addSpace(4);\n    renderTableToPdf(pdf, section.table);\n  }\n  \n  // Add spacing after section\n  pdf.addSpace(6);\n}\n\nfunction renderFieldToPdf(pdf: PdfDocument, field: RenderField, column?: number): void {\n  const doc = pdf.getDoc();\n  const pageWidth = doc.internal.pageSize.width;\n  const marginLeft = 20;\n  const marginRight = 20;\n  const maxWidth = pageWidth - marginLeft - marginRight;\n  const fieldWidth = column !== undefined ? (maxWidth - 10) / 2 : maxWidth; // 10px gap between columns\n  const xPos = column !== undefined \n    ? marginLeft + (column * (fieldWidth + 10))\n    : marginLeft;\n\n  // Format value based on field type\n  let displayValue: string;\n  if (field.value !== null && field.value !== undefined && field.value !== \"\") {\n    if (field.type === \"currency\") {\n      displayValue = formatAustralianCurrency(field.value);\n    } else if (field.type === \"date\") {\n      displayValue = formatAustralianDate(String(field.value));\n    } else if (field.type === \"number\") {\n      const num = typeof field.value === \"number\" ? field.value : parseFloat(String(field.value));\n      displayValue = isNaN(num) ? String(field.value) : num.toLocaleString(\"en-AU\");\n    } else {\n      displayValue = String(field.value);\n    }\n  } else {\n    displayValue = field.placeholder || \"ÔÇö\";\n  }\n\n  pdf.checkNewPage(column !== undefined ? 10 : 12);\n\n  // Label with better formatting\n  doc.setFontSize(8);\n  doc.setFont(\"helvetica\", \"bold\");\n  doc.setTextColor(100, 116, 139); // slate-500\n  const labelText = `${field.label}${field.required ? \" *\" : \"\"}`;\n  doc.text(labelText, xPos, pdf.getY(), { maxWidth: fieldWidth });\n  pdf.addSpace(2);\n\n  // Value with improved formatting\n  doc.setFontSize(9);\n  doc.setFont(\"helvetica\", \"normal\");\n  const isEmpty = field.value === null || field.value === undefined || field.value === \"\";\n  if (isEmpty) {\n    doc.setTextColor(148, 163, 184); // slate-400 if empty\n  } else {\n    doc.setTextColor(15, 23, 42); // slate-900 if has value\n  }\n  \n  const lines = doc.splitTextToSize(displayValue, fieldWidth);\n  lines.forEach((line: string, lineIndex: number) => {\n    if (lineIndex > 0) pdf.checkNewPage(5);\n    doc.text(line, xPos, pdf.getY(), { maxWidth: fieldWidth });\n    pdf.addSpace(3.5);\n  });\n\n  // Only add spacing if not in a column pair or if it's the second column\n  if (column === undefined || column === 1) {\n    pdf.addSpace(2);\n  }\n}\n\nfunction renderTableToPdf(pdf: PdfDocument, table: RenderTable): void {\n  if (table.rows.length === 0) {\n    pdf.addParagraph(\"No items added yet.\");\n    return;\n  }\n\n  const doc = pdf.getDoc();\n  const pageWidth = doc.internal.pageSize.width;\n  const marginLeft = 20;\n  const marginRight = 20;\n  const maxWidth = pageWidth - marginLeft - marginRight;\n  \n  // Format table data with proper formatting\n  const headers = table.columns.map((col) => col.label);\n  const rows = table.rows.map((row) =>\n    table.columns.map((col) => {\n      const val = row[col.id];\n      if (val === null || val === undefined || val === \"\") {\n        return \"ÔÇö\";\n      }\n      \n      // Apply formatting based on column type\n      if (col.type === \"currency\") {\n        return formatAustralianCurrency(val);\n      } else if (col.type === \"number\") {\n        const num = typeof val === \"number\" ? val : parseFloat(String(val));\n        return isNaN(num) ? String(val) : num.toLocaleString(\"en-AU\");\n      } else if (col.type === \"date\") {\n        return formatAustralianDate(String(val));\n      }\n      \n      return String(val);\n    })\n  );\n\n  // Calculate column widths based on percentage\n  const totalWidth = table.columns.reduce((sum, col) => sum + (col.width || 100 / table.columns.length), 0);\n  const colWidths = table.columns.map((col) => \n    ((col.width || 100 / table.columns.length) / totalWidth) * maxWidth\n  );\n\n  // Use improved table rendering\n  pdf.addTable(headers, rows, { colWidths });\n  \n  // Add note if minimum rows not met\n  if (table.rows.length < table.minRows) {\n    pdf.addSpace(2);\n    doc.setFontSize(8);\n    doc.setFont(\"helvetica\", \"italic\");\n    doc.setTextColor(146, 64, 14); // amber-900\n    doc.text(\n      `Note: Minimum ${table.minRows} row${table.minRows !== 1 ? \"s\" : \"\"} required.`,\n      marginLeft,\n      pdf.getY()\n    );\n    pdf.addSpace(2);\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":143,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3056,3059],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3056,3059],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":146,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3143,3146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3143,3146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Document Template Engine Types\n * \n * Defines the schema for compliance-ready document templates.\n * Templates are JSON files that define document structure, fields, and OVIS checks.\n */\n\nexport type DocType = \n  | \"SWMS\" \n  | \"PAYMENT_CLAIM_WA\" \n  | \"TOOLBOX_TALK\"\n  | \"VARIATION_CHANGE_ORDER\"\n  | \"EXTENSION_OF_TIME\"\n  | \"PROGRESS_CLAIM_TAX_INVOICE\"\n  | \"HANDOVER_PRACTICAL_COMPLETION\"\n  | \"MAINTENANCE_CARE_GUIDE\";\n\nexport type FieldType = \n  | \"text\" \n  | \"textarea\" \n  | \"date\" \n  | \"select\" \n  | \"multiSelect\" \n  | \"currency\" \n  | \"number\";\n\nexport type OvisSeverity = \"low\" | \"medium\" | \"high\";\n\nexport interface Field {\n  id: string;\n  label: string;\n  type: FieldType;\n  required?: boolean;\n  placeholder?: string;\n  options?: string[]; // For select/multiSelect\n  defaultValue?: string | number;\n  dataPath?: string; // Path in job data (e.g., \"jobTitle\", \"clientName\")\n}\n\nexport interface TableColumn {\n  id: string;\n  label: string;\n  width?: number; // Percentage\n  type?: FieldType;\n}\n\nexport interface Table {\n  id: string;\n  columns: TableColumn[];\n  rowsKey: string; // Path to array in data (e.g., \"hazards\", \"tasks\")\n  minRows?: number;\n}\n\nexport interface Section {\n  id: string;\n  title: string;\n  fields?: Field[];\n  table?: Table;\n  order?: number;\n}\n\nexport interface OvisCheck {\n  id: string;\n  severity: OvisSeverity;\n  rule: string; // Simple DSL: exists(path), empty(path), len(path) < N, equals(path, value)\n  message: string;\n}\n\nexport interface DocumentTemplate {\n  schemaVersion: string;\n  jurisdiction: string; // e.g., \"AU-WA\", \"AU\"\n  docType: DocType;\n  title: string;\n  disclaimer: string; // Must include draft/review required language\n  sections: Section[];\n  ovisChecks: OvisCheck[];\n}\n\n/**\n * Render model - the processed template + data ready for UI/PDF rendering\n */\nexport interface RenderField {\n  id: string;\n  label: string;\n  type: FieldType;\n  value: string | number | null;\n  required: boolean;\n  placeholder?: string;\n  options?: string[];\n}\n\nexport interface RenderTableRow {\n  [columnId: string]: string | number | null;\n}\n\nexport interface RenderTable {\n  id: string;\n  columns: TableColumn[];\n  rows: RenderTableRow[];\n  minRows: number;\n}\n\nexport interface RenderSection {\n  id: string;\n  title: string;\n  fields?: RenderField[];\n  table?: RenderTable;\n}\n\nexport interface RenderModel {\n  docType: DocType;\n  title: string;\n  disclaimer: string;\n  recordId: string;\n  timestamp: string;\n  sections: RenderSection[];\n  ovisWarnings: Array<{\n    id: string;\n    severity: OvisSeverity;\n    message: string;\n  }>;\n}\n\n/**\n * Job data structure for merging into templates\n */\nexport interface JobData {\n  jobId?: string;\n  jobTitle?: string;\n  tradeType?: string;\n  propertyType?: string;\n  address?: string;\n  clientName?: string;\n  clientEmail?: string;\n  businessName?: string;\n  abn?: string;\n  createdAt?: string;\n  notes?: string;\n  // Materials pricing fields\n  materialsSubtotal?: number | null;\n  materialsMarkupTotal?: number | null;\n  materialsTotal?: number | null;\n  aiQuote?: string | any;\n  aiMaterials?: string;\n  materialsOverrideText?: string | null;\n  [key: string]: any; // Allow additional fields\n}\n\n/**\n * Document lifecycle status\n */\nexport type DocumentStatus = \"DRAFT\" | \"CONFIRMED\" | \"ISSUED\";/**\n * Document audience for rendering\n * - INTERNAL: Shows AI/OVIS warnings and disclaimers\n * - CLIENT: Professional client-facing export with business header, no AI warnings\n */\nexport type DocumentAudience = \"INTERNAL\" | \"CLIENT\";/**\n * Business issuer profile for document headers\n */\nexport interface IssuerProfile {\n  legalName: string;          // Required: Business legal name\n  tradingName?: string;       // Optional: Trading as / DBA name\n  abn?: string;               // Optional but required for tax invoices\n  email?: string;             // Business contact email\n  phone?: string;             // Business contact phone\n  addressLine1?: string;      // Street address\n  addressLine2?: string;      // Unit/suite/building\n  suburb?: string;            // City/suburb\n  state?: string;             // State/province\n  postcode?: string;          // Postal code\n  logoUrl?: string;           // Business logo URL\n  gstRegistered?: boolean;    // Whether registered for GST\n}/**\n * Validation result for issuer profile\n */\nexport interface IssuerValidationResult {\n  isValid: boolean;\n  missingRequired: string[];      // Fields that must be filled\n  missingRecommended: string[];   // Fields that should be filled\n  warnings: string[];             // Warning messages\n  canIssue: boolean;              // Whether document can be issued\n}/**\n * Extended RenderModel with issuer and audience info\n */\nexport interface RenderModelExtended extends RenderModel {\n  issuer?: IssuerProfile;\n  audience?: DocumentAudience;\n  status?: DocumentStatus;\n  issuedAt?: string;\n  issuedRecordId?: string;\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\validateIssuer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\docEngine\\validateTemplate.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[514,517],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[514,517],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2281,2284],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2281,2284],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2571,2574],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2571,2574],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2716,2719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2716,2719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3507,3510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3507,3510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3722,3725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3722,3725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":129,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4821,4824],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4821,4824],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":138,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5252,5255],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5252,5255],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":153,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5878,5881],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5878,5881],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Template Schema Validation\r\n * \r\n * Validates document templates against the schema at runtime.\r\n * Fails fast with readable error messages.\r\n */\r\n\r\nimport type { DocumentTemplate, Section, Field, Table, OvisCheck } from \"./types\";\r\n\r\nexport class TemplateValidationError extends Error {\r\n  constructor(message: string, public path?: string) {\r\n    super(message);\r\n    this.name = \"TemplateValidationError\";\r\n  }\r\n}\r\n\r\n/**\r\n * Validate a document template\r\n */\r\nexport function validateTemplate(template: any): template is DocumentTemplate {\r\n  if (!template || typeof template !== \"object\") {\r\n    throw new TemplateValidationError(\"Template must be an object\");\r\n  }\r\n\r\n  // Required top-level fields\r\n  if (!template.schemaVersion || typeof template.schemaVersion !== \"string\") {\r\n    throw new TemplateValidationError(\"Template must have a 'schemaVersion' string field\");\r\n  }\r\n\r\n  if (!template.jurisdiction || typeof template.jurisdiction !== \"string\") {\r\n    throw new TemplateValidationError(\"Template must have a 'jurisdiction' string field\");\r\n  }\r\n\r\n  if (!template.docType || ![\"SWMS\", \"PAYMENT_CLAIM_WA\", \"TOOLBOX_TALK\"].includes(template.docType)) {\r\n    throw new TemplateValidationError(\"Template must have a 'docType' field with value 'SWMS', 'PAYMENT_CLAIM_WA', or 'TOOLBOX_TALK'\");\r\n  }\r\n\r\n  if (!template.title || typeof template.title !== \"string\") {\r\n    throw new TemplateValidationError(\"Template must have a 'title' string field\");\r\n  }\r\n\r\n  if (!template.disclaimer || typeof template.disclaimer !== \"string\") {\r\n    throw new TemplateValidationError(\"Template must have a 'disclaimer' string field\");\r\n  }\r\n\r\n  // Validate disclaimer contains required language\r\n  const disclaimerLower = template.disclaimer.toLowerCase();\r\n  if (!disclaimerLower.includes(\"draft\") && !disclaimerLower.includes(\"review\")) {\r\n    throw new TemplateValidationError(\"Template disclaimer must mention 'draft' or 'review required'\");\r\n  }\r\n\r\n  // Validate sections\r\n  if (!Array.isArray(template.sections)) {\r\n    throw new TemplateValidationError(\"Template must have a 'sections' array\");\r\n  }\r\n\r\n  if (template.sections.length === 0) {\r\n    throw new TemplateValidationError(\"Template must have at least one section\");\r\n  }\r\n\r\n  template.sections.forEach((section: any, index: number) => {\r\n    validateSection(section, `sections[${index}]`);\r\n  });\r\n\r\n  // Validate OVIS checks\r\n  if (!Array.isArray(template.ovisChecks)) {\r\n    throw new TemplateValidationError(\"Template must have an 'ovisChecks' array\");\r\n  }\r\n\r\n  template.ovisChecks.forEach((check: any, index: number) => {\r\n    validateOvisCheck(check, `ovisChecks[${index}]`);\r\n  });\r\n\r\n  return true;\r\n}\r\n\r\nfunction validateSection(section: any, path: string): asserts section is Section {\r\n  if (!section.id || typeof section.id !== \"string\") {\r\n    throw new TemplateValidationError(`Section at ${path} must have an 'id' string field`, path);\r\n  }\r\n\r\n  if (!section.title || typeof section.title !== \"string\") {\r\n    throw new TemplateValidationError(`Section at ${path} must have a 'title' string field`, path);\r\n  }\r\n\r\n  // Section must have either fields or table\r\n  if (!section.fields && !section.table) {\r\n    throw new TemplateValidationError(`Section at ${path} must have either 'fields' or 'table'`, path);\r\n  }\r\n\r\n  if (section.fields) {\r\n    if (!Array.isArray(section.fields)) {\r\n      throw new TemplateValidationError(`Section at ${path}.fields must be an array`, path);\r\n    }\r\n\r\n    section.fields.forEach((field: any, index: number) => {\r\n      validateField(field, `${path}.fields[${index}]`);\r\n    });\r\n  }\r\n\r\n  if (section.table) {\r\n    validateTable(section.table, `${path}.table`);\r\n  }\r\n}\r\n\r\nfunction validateField(field: any, path: string): asserts field is Field {\r\n  if (!field.id || typeof field.id !== \"string\") {\r\n    throw new TemplateValidationError(`Field at ${path} must have an 'id' string field`, path);\r\n  }\r\n\r\n  if (!field.label || typeof field.label !== \"string\") {\r\n    throw new TemplateValidationError(`Field at ${path} must have a 'label' string field`, path);\r\n  }\r\n\r\n  const validTypes: string[] = [\"text\", \"textarea\", \"date\", \"select\", \"multiSelect\", \"currency\", \"number\"];\r\n  if (!field.type || !validTypes.includes(field.type)) {\r\n    throw new TemplateValidationError(`Field at ${path} must have a 'type' field with value: ${validTypes.join(\", \")}`, path);\r\n  }\r\n\r\n  if (field.options && !Array.isArray(field.options)) {\r\n    throw new TemplateValidationError(`Field at ${path}.options must be an array`, path);\r\n  }\r\n\r\n  if ((field.type === \"select\" || field.type === \"multiSelect\") && (!field.options || field.options.length === 0)) {\r\n    throw new TemplateValidationError(`Field at ${path} with type '${field.type}' must have 'options' array`, path);\r\n  }\r\n}\r\n\r\nfunction validateTable(table: any, path: string): asserts table is Table {\r\n  if (!table.id || typeof table.id !== \"string\") {\r\n    throw new TemplateValidationError(`Table at ${path} must have an 'id' string field`, path);\r\n  }\r\n\r\n  if (!Array.isArray(table.columns) || table.columns.length === 0) {\r\n    throw new TemplateValidationError(`Table at ${path} must have a 'columns' array with at least one column`, path);\r\n  }\r\n\r\n  table.columns.forEach((column: any, index: number) => {\r\n    if (!column.id || typeof column.id !== \"string\") {\r\n      throw new TemplateValidationError(`Table column at ${path}.columns[${index}] must have an 'id' string field`, path);\r\n    }\r\n\r\n    if (!column.label || typeof column.label !== \"string\") {\r\n      throw new TemplateValidationError(`Table column at ${path}.columns[${index}] must have a 'label' string field`, path);\r\n    }\r\n  });\r\n\r\n  if (!table.rowsKey || typeof table.rowsKey !== \"string\") {\r\n    throw new TemplateValidationError(`Table at ${path} must have a 'rowsKey' string field`, path);\r\n  }\r\n}\r\n\r\nfunction validateOvisCheck(check: any, path: string): asserts check is OvisCheck {\r\n  if (!check.id || typeof check.id !== \"string\") {\r\n    throw new TemplateValidationError(`OVIS check at ${path} must have an 'id' string field`, path);\r\n  }\r\n\r\n  const validSeverities: string[] = [\"low\", \"medium\", \"high\"];\r\n  if (!check.severity || !validSeverities.includes(check.severity)) {\r\n    throw new TemplateValidationError(`OVIS check at ${path} must have a 'severity' field with value: ${validSeverities.join(\", \")}`, path);\r\n  }\r\n\r\n  if (!check.rule || typeof check.rule !== \"string\") {\r\n    throw new TemplateValidationError(`OVIS check at ${path} must have a 'rule' string field`, path);\r\n  }\r\n\r\n  if (!check.message || typeof check.message !== \"string\") {\r\n    throw new TemplateValidationError(`OVIS check at ${path} must have a 'message' string field`, path);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\documentAccess.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1132,1135],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1132,1135],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1214,1217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1214,1217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Document Access Control\r\n * \r\n * Determines if a user has access to document features (PDF download, email, etc.)\r\n * based on their plan tier, admin status, and pilot program participation.\r\n * \r\n * This module is client-safe and doesn't import server-side code.\r\n */\r\n\r\nexport interface UserAccessInfo {\r\n  planTier: string;\r\n  planStatus: string;\r\n  isAdmin: boolean;\r\n}\r\n\r\n/**\r\n * Check if user has access to document features (PDF download, email to client)\r\n * \r\n * Access granted to:\r\n * - Admin users\r\n * - Users with paid plans (planTier !== \"FREE\")\r\n * - Users in pilot program (planStatus === \"TRIAL\" or planTier === \"TRIAL\")\r\n * \r\n * Free users can only create job packs, not use document features\r\n */\r\nexport function hasDocumentFeatureAccess(user: { isAdmin?: boolean } | null, accessInfo?: UserAccessInfo): boolean {\r\n  if (!user) return false;\r\n  \r\n  // Admin users always have access\r\n  const userIsAdmin = accessInfo?.isAdmin ?? user.isAdmin ?? false;\r\n  if (userIsAdmin) {\r\n    return true;\r\n  }\r\n  \r\n  // Get plan info from accessInfo or user object\r\n  const planTier = accessInfo?.planTier || (user as any).planTier || \"FREE\";\r\n  const planStatus = accessInfo?.planStatus || (user as any).planStatus || \"TRIAL\";\r\n  \r\n  // Pilot program users (TRIAL status) have access even if FREE tier\r\n  if (planStatus === \"TRIAL\" || planTier === \"TRIAL\") {\r\n    return true;\r\n  }\r\n  \r\n  // Paid plan users have access\r\n  if (planTier !== \"FREE\") {\r\n    return true;\r\n  }\r\n  \r\n  // Free users (not in pilot) do not have access\r\n  return false;\r\n}\r\n\r\n/**\r\n * Get access restriction message for display\r\n */\r\nexport function getDocumentAccessMessage(user: { isAdmin?: boolean } | null, accessInfo?: UserAccessInfo): string {\r\n  if (hasDocumentFeatureAccess(user, accessInfo)) {\r\n    return \"\";\r\n  }\r\n  \r\n  return \"A paid plan or pilot program membership is required to download PDFs and email documents. Free users can create job packs only.\";\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\email-verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\featureFlags.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\feedback.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\format.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\jobDocumentSignatures.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\jobs.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":633,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":633,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22343,22346],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22343,22346],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":825,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":825,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31306,31309],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31306,31309],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":835,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":835,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31566,31569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31566,31569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":845,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":845,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32010,32013],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32010,32013],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":861,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":861,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32412,32415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32412,32415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":862,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":862,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32492,32495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32492,32495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":946,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":946,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36002,36005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36002,36005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":996,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":996,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38247,38250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38247,38250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1005,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1005,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38639,38642],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38639,38642],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1046,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1046,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40100,40103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40100,40103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tradeType' is assigned a value but never used.","line":1055,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":1055,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1136,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1136,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43431,43434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43431,43434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { kv } from \"./kv\";\nimport { openai } from \"./openai\";\nimport { getEffectiveRates, type EffectiveRates } from \"./pricing\";\nimport type { SafeUser } from \"./auth\";\nimport { isAdmin } from \"./auth\";\n\n// Re-export EffectiveRates for use in other files\nexport type { EffectiveRates } from \"./pricing\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type TradeType = \"Painter\" | \"Plasterer\" | \"Carpenter\" | \"Electrician\" | \"Other\";\n\n// AI generation status (tracks AI pack generation state)\nexport type AIGenerationStatus = \"draft\" | \"ai_pending\" | \"ai_complete\" | \"ai_failed\" | \"pending_regeneration\" | \"generating\";\n\n// Job workflow status\n// pending_confirmation: Client has responded (accepted/declined), tradie must confirm\nexport type JobWorkflowStatus = \"pending\" | \"pending_confirmation\" | \"booked\" | \"completed\" | \"cancelled\";\n\n// AI pack review status\nexport type AIReviewStatus = \"pending\" | \"confirmed\";\n\n// Keep JobStatus as alias for backwards compatibility\nexport type JobStatus = AIGenerationStatus;\n\n// Client-facing status pipeline (tracks where job is in client workflow)\nexport type ClientStatus = \"draft\" | \"sent\" | \"accepted\" | \"declined\" | \"cancelled\";\n\nexport interface Job {\n  id: string;\n  userId: string;\n  createdAt: string;\n  updatedAt: string;\n  title: string;\n  tradeType: TradeType;\n  propertyType: string;\n  address?: string;\n  notes?: string;\n  // AI generation status (tracks generation state)\n  status: AIGenerationStatus;\n  // Job workflow status (pending, booked, completed, cancelled)\n  jobStatus?: JobWorkflowStatus;\n  // AI pack review status (pending, confirmed)\n  aiReviewStatus?: AIReviewStatus;\n  // Client details (optional for backwards compatibility with existing jobs)\n  clientName?: string;\n  clientEmail?: string;\n  // Pricing context (optional user-provided rates)\n  labourRatePerHour?: number | null;\n  helperRatePerHour?: number | null; // Legacy field - kept for backwards compatibility\n  helpers?: JobHelper[]; // New: array of helpers with names and rates\n  materialsAreRoughEstimate?: boolean;\n  // Rate template reference (optional)\n  rateTemplateId?: string | null;\n  // Effective rates used for this job (stored after generation)\n  effectiveRates?: EffectiveRates | null;\n  // Materials override (user-provided, replaces AI materials)\n  materialsOverrideText?: string | null;\n  // AI-generated fields\n  aiSummary?: string;\n  aiQuote?: string;\n  aiScopeOfWork?: string;\n  aiInclusions?: string;\n  aiExclusions?: string;\n  aiMaterials?: string;\n  aiClientNotes?: string;\n  // Email tracking\n  sentToClientAt?: string | null;\n  // Client-facing status pipeline\n  clientStatus?: ClientStatus;\n  clientStatusUpdatedAt?: string | null;\n  // Client acceptance/decline tracking\n  clientAcceptedAt?: string | null;\n  clientDeclinedAt?: string | null;\n  clientSignatureId?: string | null; // FK to Signature model in Prisma\n  clientSignedName?: string | null;\n  clientSignedEmail?: string | null;\n  // Enhanced acceptance details (tied to quote version)\n  clientAcceptedByName?: string | null; // typed full name as \"signature\"\n  clientAcceptanceNote?: string | null; // optional note from client\n  clientAcceptedQuoteVer?: number | null; // which quote version was accepted\n  // Soft delete flag (job is hidden from user but data preserved)\n  isDeleted?: boolean;\n  // SWMS (Safe Work Method Statement) fields\n  swmsText?: string | null;\n  swmsStatus?: \"NOT_STARTED\" | \"GENERATING\" | \"READY\" | \"FAILED\" | null;\n  swmsConfirmed?: boolean;\n  // Document fields (variation, EOT, progress claim, handover, maintenance)\n  variationText?: string | null;\n  variationConfirmed?: boolean;\n  eotText?: string | null;\n  eotConfirmed?: boolean;\n  progressClaimText?: string | null;\n  progressClaimConfirmed?: boolean;\n  handoverText?: string | null;\n  handoverConfirmed?: boolean;\n  maintenanceText?: string | null;\n  maintenanceConfirmed?: boolean;\n  // Scheduling fields\n  scheduledStartAt?: string | null; // ISO string\n  scheduledEndAt?: string | null; // ISO string\n  scheduleNotes?: string | null; // Optional notes about scheduling (e.g., \"Client prefers mornings\", \"Access via rear driveway\")\n  // Materials totals (aggregated from JobMaterial line items)\n  materialsSubtotal?: number | null; // sum of JobMaterial lineTotals (pre-markup)\n  materialsMarkupTotal?: number | null; // amount added from markup\n  materialsTotal?: number | null; // final materials cost used in quotes\n  // Numeric quote breakdown (optional, computed during quote generation)\n  labourHoursEstimate?: number | null;\n  labourSubtotal?: number | null;\n  subtotal?: number | null; // labour + materials\n  gstAmount?: number | null;\n  totalInclGst?: number | null;\n  // Applied rates snapshot (from user's Business & Rates settings at time of generation)\n  appliedMarginPct?: number | null; // margin % applied to materials\n  appliedDepositPct?: number | null; // deposit % requested\n  appliedGstIncluded?: boolean | null; // whether GST is included in pricing\n  // Quote metadata\n  quoteNumber?: string | null; // e.g. \"Q-2024-0012\"\n  quoteVersion?: number | null; // current version number (1, 2, 3, ...)\n  quoteExpiryAt?: string | null; // ISO string - when the current quote expires\n  quoteLastSentAt?: string | null; // ISO string - last time a quote email was sent\n  // Assignment metadata (for client job assignment workflow)\n  assignedByUserId?: string | null; // admin/user who assigned the job\n  assignedAt?: string | null; // ISO string - when the job was assigned to a tradie\n  assignmentStatus?: string | null; // e.g. \"UNASSIGNED\", \"ASSIGNED\", \"DECLINED_BY_TRADIE\"\n  leadSource?: string | null; // e.g. \"CLIENT_PORTAL\", \"MANUAL\", etc.\n  clientUserId?: string | null; // original client user ID (for client-posted jobs)\n  // Client CRM link (for tradie-created jobs)\n  clientId?: string | null; // FK to Client model in Prisma (for CRM linking)\n}\n\nexport interface JobHelper {\n  id: string; // Unique ID for this helper (for React keys)\n  name?: string; // Optional helper name/role (e.g., \"Second Painter\", \"Apprentice\")\n  ratePerHour: number; // Required hourly rate\n}\n\nexport interface CreateJobData {\n  title: string;\n  tradeType?: TradeType;\n  propertyType: string;\n  address?: string;\n  notes?: string;\n  clientName?: string;\n  clientEmail?: string;\n  labourRatePerHour?: number | null;\n  helperRatePerHour?: number | null; // Legacy - kept for backwards compatibility\n  helpers?: JobHelper[]; // New: array of helpers\n  materialsAreRoughEstimate?: boolean;\n  rateTemplateId?: string | null;\n}\n\nexport interface UpdateJobData {\n  title?: string;\n  tradeType?: TradeType;\n  propertyType?: string;\n  address?: string;\n  notes?: string;\n  clientName?: string;\n  clientEmail?: string;\n  labourRatePerHour?: number | null;\n  helperRatePerHour?: number | null; // Legacy - kept for backwards compatibility\n  helpers?: JobHelper[]; // New: array of helpers\n  materialsAreRoughEstimate?: boolean;\n}\n\n// ============================================================================\n// AI Response Shape\n// ============================================================================\n\ninterface LabourQuote {\n  description?: string;\n  hours?: string;\n  ratePerHour?: string;\n  total?: string;\n}\n\ninterface MaterialsQuote {\n  description?: string;\n  totalMaterialsCost?: string;\n}\n\ninterface TotalEstimateQuote {\n  description?: string;\n  totalJobEstimate?: string;\n}\n\ninterface QuoteResponse {\n  labour?: LabourQuote;\n  materials?: MaterialsQuote;\n  totalEstimate?: TotalEstimateQuote;\n}\n\ninterface MaterialItem {\n  item: string;\n  quantity?: string;\n  estimatedCost?: string;\n}\n\ninterface JobPackResponse {\n  summary: string;\n  quote?: QuoteResponse;\n  scopeOfWork?: string | string[];\n  inclusions?: string[];\n  exclusions?: string[];\n  materials?: MaterialItem[];\n  clientNotes?: string;\n}\n\n// ============================================================================\n// Job CRUD Functions\n// ============================================================================\n\n/**\n * Creates a new job with ai_pending status\n */\nexport async function createEmptyJob(\n  userId: string,\n  data: CreateJobData\n): Promise<Job> {\n  const id = crypto.randomUUID();\n  const now = new Date().toISOString();\n\n  const job: Job = {\n    id,\n    userId,\n    createdAt: now,\n    updatedAt: now,\n    title: data.title,\n    tradeType: data.tradeType || \"Painter\",\n    propertyType: data.propertyType,\n    address: data.address,\n    notes: data.notes,\n    clientName: data.clientName,\n    clientEmail: data.clientEmail,\n    labourRatePerHour: data.labourRatePerHour ?? null,\n    helperRatePerHour: data.helperRatePerHour ?? null, // Legacy - kept for backwards compatibility\n    helpers: data.helpers && data.helpers.length > 0 ? data.helpers : undefined, // New: array of helpers\n    materialsAreRoughEstimate: data.materialsAreRoughEstimate ?? false,\n    rateTemplateId: data.rateTemplateId ?? null,\n    status: \"ai_pending\",\n    jobStatus: \"pending\",\n    aiReviewStatus: \"pending\",\n    clientStatus: \"draft\",\n    clientStatusUpdatedAt: now,\n    // Assignment fields (will be set based on job creator)\n    assignedByUserId: null,\n    assignedAt: null,\n    assignmentStatus: null,\n    leadSource: null,\n    clientUserId: null,\n  };\n\n  // Store the job\n  await kv.set(`job:${id}`, job);\n\n  // Add job ID to user's job list atomically using lpush\n  // This prevents race conditions when multiple jobs are created concurrently\n  const userJobsKey = `user:${userId}:jobs`;\n  try {\n    await kv.lpush(userJobsKey, id);\n  } catch (error) {\n    // Rollback: delete the job to prevent orphaned entries\n    await kv.del(`job:${id}`);\n    throw error;\n  }\n\n  return job;\n}\n\n/**\n * Saves/updates an existing job\n */\nexport async function saveJob(job: Job): Promise<void> {\n  job.updatedAt = new Date().toISOString();\n  await kv.set(`job:${job.id}`, job);\n}\n\n/**\n * Gets a job by ID\n */\nexport async function getJobById(id: string): Promise<Job | null> {\n  return (await kv.get(`job:${id}`)) as Job | null;\n}\n\n/**\n * Gets all jobs for a user, sorted by createdAt descending\n */\nexport async function getJobsForUser(userId: string, includeDeleted: boolean = false): Promise<Job[]> {\n  return getJobsForUserPaginated(userId, includeDeleted).then((result) => result.items);\n}\n\n/**\n * Gets paginated jobs for a user, sorted by createdAt descending\n */\nexport async function getJobsForUserPaginated(\n  userId: string,\n  includeDeleted: boolean = false,\n  page: number = 1,\n  pageSize: number = 20\n): Promise<{ items: Job[]; page: number; pageSize: number; totalItems: number; totalPages: number }> {\n  const userJobsKey = `user:${userId}:jobs`;\n  // Get all job IDs from the Redis list\n  const allJobIds = ((await kv.lrange(userJobsKey, 0, -1)) as string[] | null) || [];\n\n  if (allJobIds.length === 0) {\n    return { items: [], page, pageSize, totalItems: 0, totalPages: 0 };\n  }\n\n  // Load all jobs in parallel (we need all to filter and sort)\n  const allJobs = await Promise.all(\n    allJobIds.map((id) => kv.get(`job:${id}`) as Promise<Job | null>)\n  );\n\n  // Filter out nulls and deleted jobs, then sort\n  const validJobs = allJobs\n    .filter((job): job is Job => job !== null)\n    .filter((job) => includeDeleted || job.isDeleted !== true)\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n\n  const totalItems = validJobs.length;\n  const totalPages = Math.ceil(totalItems / pageSize);\n  const skip = (page - 1) * pageSize;\n  const take = pageSize;\n\n  // Apply pagination\n  const paginatedJobs = validJobs.slice(skip, skip + take);\n\n  return {\n    items: paginatedJobs,\n    page,\n    pageSize,\n    totalItems,\n    totalPages,\n  };\n}\n\n/**\n * Gets all jobs for a client (by clientEmail), sorted by createdAt descending\n * This is used for client dashboards to show jobs they've posted\n * \n * Note: This implementation scans all user job lists. In production, you'd maintain\n * a client:email:jobs index similar to user:userId:jobs for better performance.\n */\nexport async function getJobsForClient(clientEmail: string, includeDeleted: boolean = false): Promise<Job[]> {\n  // Normalize email to lowercase for consistent matching\n  const normalizedEmail = clientEmail.toLowerCase().trim();\n  \n  // Get all user IDs from the users:all index\n  const { getAllUsers } = await import(\"./auth\");\n  const allUsers = await getAllUsers();\n  \n  // Collect all job IDs from all users\n  const allJobIds = new Set<string>();\n  for (const user of allUsers) {\n    const userJobsKey = `user:${user.id}:jobs`;\n    const jobIds = (await kv.lrange(userJobsKey, 0, -1)) as string[] | null;\n    if (jobIds) {\n      jobIds.forEach(id => allJobIds.add(id));\n    }\n  }\n  \n  // Load all jobs in parallel\n  const allJobs = await Promise.all(\n    Array.from(allJobIds).map((id) => kv.get(`job:${id}`) as Promise<Job | null>)\n  );\n  \n  // Filter jobs where clientEmail matches (case-insensitive)\n  const clientJobs = allJobs\n    .filter((job): job is Job => job !== null)\n    .filter((job) => {\n      if (!job.clientEmail) return false;\n      return job.clientEmail.toLowerCase().trim() === normalizedEmail;\n    });\n\n  // Filter out deleted jobs (unless includeDeleted) and sort by createdAt descending\n  return clientJobs\n    .filter((job) => includeDeleted || job.isDeleted !== true)\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n}\n\n/**\n * Soft deletes a job (sets isDeleted = true)\n * Data is preserved for potential restoration\n * @param jobId - The job's ID\n * @returns The updated job or null if not found\n */\nexport async function softDeleteJob(jobId: string): Promise<Job | null> {\n  const job = await getJobById(jobId);\n  if (!job) {\n    return null;\n  }\n\n  job.isDeleted = true;\n  job.updatedAt = new Date().toISOString();\n  await saveJob(job);\n\n  return job;\n}\n\n// TODO: Add admin-only restoreJob function in the future\n// export async function restoreJob(jobId: string): Promise<Job | null> {\n//   const job = await getJobById(jobId);\n//   if (!job) return null;\n//   job.isDeleted = false;\n//   job.updatedAt = new Date().toISOString();\n//   await saveJob(job);\n//   return job;\n// }\n\n/**\n * Clones a job for a user, creating a new job with the same core details and job pack content.\n * Resets statuses, client acceptance, and signatures to safe initial states.\n * Does NOT clone safety docs, variations, or other related documents.\n * \n * @param options - Object containing jobId and userId\n * @returns The newly created cloned job\n * @throws Error if job not found or user doesn't own the job\n */\nexport async function cloneJobForUser(options: {\n  jobId: string;\n  userId: string;\n}): Promise<Job> {\n  const { jobId, userId } = options;\n\n  // 1. Load the source job and ensure it belongs to this user\n  const sourceJob = await getJobById(jobId);\n  if (!sourceJob) {\n    throw new Error(`Job with ID ${jobId} not found`);\n  }\n\n  if (sourceJob.userId !== userId) {\n    throw new Error(`User ${userId} does not own job ${jobId}`);\n  }\n\n  // 2. Build a new job data object\n  const now = new Date().toISOString();\n  const newId = crypto.randomUUID();\n  \n  // Adjust title to indicate it's a copy\n  const newTitle = sourceJob.title.length > 0\n    ? `${sourceJob.title} (Copy)`\n    : \"Untitled job (Copy)\";\n\n  // Create the cloned job\n  const clonedJob: Job = {\n    id: newId,\n    userId: userId,\n    createdAt: now,\n    updatedAt: now,\n    \n    // Copy core fields\n    title: newTitle,\n    tradeType: sourceJob.tradeType,\n    propertyType: sourceJob.propertyType,\n    address: sourceJob.address,\n    notes: sourceJob.notes,\n    clientName: sourceJob.clientName,\n    clientEmail: sourceJob.clientEmail,\n    \n    // Copy pricing context\n    labourRatePerHour: sourceJob.labourRatePerHour,\n    helperRatePerHour: sourceJob.helperRatePerHour, // Legacy\n    helpers: sourceJob.helpers ? sourceJob.helpers.map(h => ({ ...h })) : undefined, // Deep copy helpers array\n    materialsAreRoughEstimate: sourceJob.materialsAreRoughEstimate,\n    rateTemplateId: sourceJob.rateTemplateId, // Copy rate template reference\n    effectiveRates: sourceJob.effectiveRates,\n    materialsOverrideText: sourceJob.materialsOverrideText,\n    \n    // Copy pricing snapshot fields (preserve calculated values)\n    materialsSubtotal: sourceJob.materialsSubtotal,\n    materialsMarkupTotal: sourceJob.materialsMarkupTotal,\n    materialsTotal: sourceJob.materialsTotal,\n    labourHoursEstimate: sourceJob.labourHoursEstimate,\n    labourSubtotal: sourceJob.labourSubtotal,\n    subtotal: sourceJob.subtotal,\n    gstAmount: sourceJob.gstAmount,\n    totalInclGst: sourceJob.totalInclGst,\n    \n    // Copy AI job pack content\n    aiSummary: sourceJob.aiSummary,\n    aiQuote: sourceJob.aiQuote,\n    aiScopeOfWork: sourceJob.aiScopeOfWork,\n    aiInclusions: sourceJob.aiInclusions,\n    aiExclusions: sourceJob.aiExclusions,\n    aiMaterials: sourceJob.aiMaterials,\n    aiClientNotes: sourceJob.aiClientNotes,\n    \n    // Reset statuses to safe starting point\n    // If AI content exists, mark as ai_complete so user can edit without regenerating\n    // Otherwise, mark as draft\n    status: (sourceJob.aiSummary || sourceJob.aiScopeOfWork) ? \"ai_complete\" : \"draft\",\n    jobStatus: \"pending\",\n    aiReviewStatus: \"pending\",\n    clientStatus: \"draft\",\n    clientStatusUpdatedAt: now,\n    \n    // DO NOT copy client acceptance/signature fields\n    // clientAcceptedAt, clientDeclinedAt, clientSignatureId, clientSignedName, clientSignedEmail\n    // are all undefined, which is correct\n    \n    // DO NOT copy email tracking\n    // sentToClientAt is undefined\n    \n    // DO NOT copy SWMS\n    // swmsText and swmsStatus are undefined\n    \n    // DO NOT copy quote metadata (reset for new job)\n    // quoteNumber, quoteVersion, quoteExpiryAt, quoteLastSentAt are undefined\n    \n    // DO NOT copy assignment metadata (reset for new job)\n    // assignedByUserId, assignedAt, assignmentStatus, leadSource, clientUserId are undefined\n    \n    // DO NOT copy client CRM link (will be recreated if client details are updated)\n    // clientId is undefined\n    \n    // Soft delete flag starts as false\n    isDeleted: false,\n  };\n\n  // 3. Store the new job\n  await kv.set(`job:${clonedJob.id}`, clonedJob);\n\n  // 4. Add job ID to user's job list atomically\n  const userJobsKey = `user:${userId}:jobs`;\n  try {\n    await kv.lpush(userJobsKey, clonedJob.id);\n  } catch (error) {\n    // Rollback: delete the job to prevent orphaned entries\n    await kv.del(`job:${clonedJob.id}`);\n    throw error;\n  }\n\n  // 5. Return the new job\n  return clonedJob;\n}\n\n/**\n * Gets all active jobs from all users (for matching/searching)\n * Returns jobs that are not deleted and are in a visible state\n * @param limit - Maximum number of jobs to return (default: 50)\n * @returns Array of active jobs, sorted by createdAt descending\n */\nexport async function getAllActiveJobs(limit: number = 50): Promise<Job[]> {\n  // Get all users to find their jobs\n  const { getAllUsers } = await import(\"./auth\");\n  const users = await getAllUsers();\n  \n  // Collect all job IDs from all users\n  const allJobIds: string[] = [];\n  for (const user of users) {\n    const userJobsKey = `user:${user.id}:jobs`;\n    const jobIds = (await kv.lrange(userJobsKey, 0, -1)) as string[] | null;\n    if (jobIds && jobIds.length > 0) {\n      allJobIds.push(...jobIds);\n    }\n  }\n  \n  if (allJobIds.length === 0) {\n    return [];\n  }\n  \n  // Load all jobs in parallel\n  const jobs = await Promise.all(\n    allJobIds.map((id) => kv.get(`job:${id}`) as Promise<Job | null>)\n  );\n  \n  // Filter out:\n  // - Null values (deleted jobs)\n  // - Soft-deleted jobs\n  // - Jobs that are cancelled\n  const activeJobs = jobs\n    .filter((job): job is Job => job !== null)\n    .filter((job) => job.isDeleted !== true)\n    .filter((job) => job.jobStatus !== \"cancelled\")\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())\n    .slice(0, limit);\n  \n  return activeJobs;\n}\n\n// ============================================================================\n// AI Job Pack Generator\n// ============================================================================\n\n/**\n * Generates an AI job pack for the given job\n * \n * INTEGRATION WITH BUSINESS & RATES SETTINGS:\n * - Loads user's Business & Rates settings from Prisma (hourlyRate, defaultMarginPct, \n *   defaultDepositPct, gstRegistered, tradeRatesJson, dayRate, calloutFee)\n * - Stores applied rates snapshot on job (appliedMarginPct, appliedDepositPct, appliedGstIncluded)\n *   only if not already set (preserves manual edits)\n * - Passes user rates into AI prompt so model uses exact rates instead of inventing values\n * - Includes deposit % and payment terms in client notes if configured\n * - Falls back to existing defaults if settings are missing (backwards compatible)\n * \n * @param job - The job to generate a pack for\n * @param user - The user creating/owning the job (for loading business profile rates)\n */\nexport async function generateJobPack(job: Job, user?: SafeUser): Promise<Job> {\n  try {\n    // Email verification check: require verified email for job pack generation (only for paid users)\n    // Free users can generate but cannot save client details or send to clients\n    if (user) {\n      let planTier = \"FREE\";\n      try {\n        const { getPrisma } = await import(\"./prisma\"); const prisma = getPrisma();\n        \n        // Fetch plan tier from Prisma\n        try {\n          const prismaUser = await prisma.user.findUnique({\n            where: { email: user.email },\n            select: { planTier: true },\n          });\n          if (prismaUser?.planTier) {\n            planTier = prismaUser.planTier;\n          }\n        } catch (dbError) {\n          console.warn(\"Failed to fetch plan tier for job pack generation:\", dbError);\n          // Default to FREE if fetch fails\n        }\n        \n        // Only require email verification for paid users (not free users or admins)\n        const hasPaidPlan = isAdmin(user) || planTier !== \"FREE\";\n        if (hasPaidPlan && !isAdmin(user)) {\n          try {\n            const { requireVerifiedEmail } = await import(\"./authChecks\");\n            await requireVerifiedEmail(user);\n          } catch (error: any) {\n            if (error.name === \"EmailNotVerifiedError\") {\n              throw new Error(\"EMAIL_NOT_VERIFIED: Please verify your email before generating job packs.\");\n            }\n            throw error;\n          }\n        }\n      } catch (importError) {\n        console.error(\"Error importing modules for plan check:\", importError);\n        // If imports fail, allow generation to proceed (fail-safe)\n      }\n    }\n    // Get effective rates (job override > business profile > pricing settings)\n    let effectiveRates: EffectiveRates = {};\n    if (user) {\n      effectiveRates = await getEffectiveRates({ user, job });\n      // Store effective rates on the job for future reference\n      job.effectiveRates = effectiveRates;\n      \n      // Store applied rates snapshot on job (only if not already set - preserve manual edits)\n      if (job.appliedMarginPct == null && effectiveRates.defaultMarginPct != null) {\n        job.appliedMarginPct = effectiveRates.defaultMarginPct;\n      }\n      if (job.appliedDepositPct == null && effectiveRates.defaultDepositPct != null) {\n        job.appliedDepositPct = effectiveRates.defaultDepositPct;\n      }\n      if (job.appliedGstIncluded == null && effectiveRates.gstRegistered != null) {\n        job.appliedGstIncluded = effectiveRates.gstRegistered;\n      }\n    }\n\n    // Build labour rate instructions based on effective rates or defaults\n    const defaultRates: Record<TradeType, string> = {\n      Painter: \"$50/hr\",\n      Plasterer: \"$55-60/hr\",\n      Carpenter: \"$65/hr\",\n      Electrician: \"$80-90/hr\",\n      Other: \"$50/hr\",\n    };\n\n    let labourRateInstructions = \"\";\n    if (effectiveRates.hourlyRate) {\n      labourRateInstructions = `Use AUD $${effectiveRates.hourlyRate}/hour as the base labour rate for this job.`;\n      // Handle multiple helpers from job.helpers array\n      if (job.helpers && job.helpers.length > 0) {\n        const helperDescriptions = job.helpers.map((h, idx) => {\n          const helperName = h.name ? ` (${h.name})` : \"\";\n          return `Helper ${idx + 1}${helperName}: AUD $${h.ratePerHour}/hour`;\n        }).join(\", \");\n        labourRateInstructions += ` Additional helpers: ${helperDescriptions}.`;\n      } else if (effectiveRates.helperHourlyRate) {\n        // Fallback to legacy helperHourlyRate\n        labourRateInstructions += ` Assume a second worker at AUD $${effectiveRates.helperHourlyRate}/hour where needed.`;\n      }\n    } else if (job.labourRatePerHour) {\n      // Fallback to job override if effective rates not available\n      labourRateInstructions = `Use AUD $${job.labourRatePerHour}/hour as the base labour rate for this job.`;\n      // Handle multiple helpers from job.helpers array\n      if (job.helpers && job.helpers.length > 0) {\n        const helperDescriptions = job.helpers.map((h, idx) => {\n          const helperName = h.name ? ` (${h.name})` : \"\";\n          return `Helper ${idx + 1}${helperName}: AUD $${h.ratePerHour}/hour`;\n        }).join(\", \");\n        labourRateInstructions += ` Additional helpers: ${helperDescriptions}.`;\n      } else if (job.helperRatePerHour) {\n        // Fallback to legacy helperRatePerHour\n        labourRateInstructions += ` Assume a second worker at AUD $${job.helperRatePerHour}/hour where needed.`;\n      }\n    } else {\n      labourRateInstructions = `No specific labour rate was provided. Use realistic WA rates based on trade type:\n- Painter: $50/hr\n- Plasterer: $55-60/hr\n- Carpenter: $65/hr\n- Electrician: $80-90/hr\nFor this ${job.tradeType} job, use approximately ${defaultRates[job.tradeType]}.`;\n    }\n\n    // Build materials disclaimer instructions\n    let materialsInstructions = `Material pricing MUST be clearly labelled as an estimate only. The tradie will check current supplier prices.`;\n    if (job.materialsAreRoughEstimate) {\n      materialsInstructions += `\nIMPORTANT: Emphasise that material costs are a rough estimate. Add a clear statement: \"Material prices are approximate only and must be confirmed against current supplier pricing (e.g. Dulux/Bunnings).\"`;\n    }\n\n    const systemPrompt = `You are an expert ${job.tradeType.toLowerCase()} estimator based in Western Australia, working across Perth, Mandurah, Baldivis, Rockingham and surrounding areas.\n\nLABOUR RATE GUIDELINES:\n${labourRateInstructions}\n- Always show HOURS first, then calculate: hours ├ù rate = total\n- Be realistic - no lowball estimates that make tradies look bad\n- Include adequate prep time for rough surfaces, patching, sanding, etc.\n\nMATERIALS GUIDELINES:\n${materialsInstructions}\n\nPAINT PRODUCTS (default to Dulux unless notes specify otherwise):\n- Walls: Dulux Wash & Wear (low sheen or matt)\n- Ceilings: Dulux Ceiling White (flat)\n- Trim/doors: Dulux Aquanamel (semi-gloss or gloss)\n- Exteriors: Dulux Weathershield\n\nESTIMATING TIPS:\n- Average room (3x4m): 4-6 hours for 2 coats walls + ceiling\n- Full repaint 3x2 house: 40-60 hours depending on condition\n- Add 20-30% more time if surfaces need significant prep\n- Factor in cut-in time for edges and corners\n\nSpeak in clear, practical language that Aussie tradies understand. No fluff - just actionable info.`;\n\n    // Build pricing context section for the prompt using effective rates\n    const pricingContextParts: string[] = [];\n    \n    // Use effective rates if available, otherwise fall back to job overrides\n    const hourlyRate = effectiveRates.hourlyRate ?? job.labourRatePerHour;\n    const helperRate = effectiveRates.helperHourlyRate ?? job.helperRatePerHour;\n    const dayRate = effectiveRates.dayRate;\n    const ratePerM2Interior = effectiveRates.ratePerM2Interior;\n    const ratePerM2Exterior = effectiveRates.ratePerM2Exterior;\n    const ratePerLmTrim = effectiveRates.ratePerLmTrim;\n    const calloutFee = effectiveRates.calloutFee;\n    const materialMarkup = effectiveRates.materialMarkupPercent ?? effectiveRates.defaultMarginPct;\n    const depositPct = effectiveRates.defaultDepositPct;\n    const gstRegistered = effectiveRates.gstRegistered;\n    const paymentTerms = effectiveRates.defaultPaymentTerms;\n\n    // Core rates\n    if (hourlyRate) {\n      pricingContextParts.push(`Hourly rate: $${hourlyRate}/hr`);\n    }\n    if (dayRate) {\n      pricingContextParts.push(`Day rate: $${dayRate}/day`);\n    }\n    if (helperRate) {\n      pricingContextParts.push(`Helper/2nd worker rate: $${helperRate}/hr`);\n    }\n    if (calloutFee) {\n      pricingContextParts.push(`Callout fee: $${calloutFee}`);\n    }\n    \n    // Trade-specific rates (painter focus)\n    if (ratePerM2Interior) {\n      pricingContextParts.push(`Interior rate: $${ratePerM2Interior}/m┬▓`);\n    }\n    if (ratePerM2Exterior) {\n      pricingContextParts.push(`Exterior rate: $${ratePerM2Exterior}/m┬▓`);\n    }\n    if (ratePerLmTrim) {\n      pricingContextParts.push(`Linear metre rate (trim/handrail): $${ratePerLmTrim}/lm`);\n    }\n    \n    // Painter-specific rates from tradeRatesJson\n    if (effectiveRates.tradeRates?.painter) {\n      const painterRates = effectiveRates.tradeRates.painter;\n      if (painterRates.wallsPerM2) {\n        pricingContextParts.push(`Walls per m┬▓: $${painterRates.wallsPerM2}/m┬▓`);\n      }\n      if (painterRates.ceilingsPerM2) {\n        pricingContextParts.push(`Ceilings per m┬▓: $${painterRates.ceilingsPerM2}/m┬▓`);\n      }\n      if (painterRates.trimPerM) {\n        pricingContextParts.push(`Trim per metre: $${painterRates.trimPerM}/m`);\n      }\n      if (painterRates.doorsEach) {\n        pricingContextParts.push(`Doors each: $${painterRates.doorsEach}`);\n      }\n    }\n    \n    // Pricing defaults\n    if (materialMarkup !== undefined && materialMarkup !== null) {\n      pricingContextParts.push(`Margin on materials: ${materialMarkup}%`);\n    }\n    if (depositPct !== undefined && depositPct !== null) {\n      pricingContextParts.push(`Typical deposit: ${depositPct}%`);\n    }\n    if (gstRegistered) {\n      pricingContextParts.push(`GST registered: Yes (prices include GST)`);\n    }\n    if (paymentTerms) {\n      pricingContextParts.push(`Payment terms: ${paymentTerms}`);\n    }\n    if (job.materialsAreRoughEstimate) {\n      pricingContextParts.push(`Materials: Treat all material prices as rough estimates only`);\n    }\n    \n    const pricingContext = pricingContextParts.length > 0\n      ? `**Pricing Context - USE THESE EXACT RATES:**\\n${pricingContextParts.join(\"\\n\")}\\n\\nIMPORTANT: You MUST use these exact rates when calculating labour costs, materials costs, and total estimates. Do NOT invent new rates. If any rate is missing, clearly state in your response that pricing is approximate only.`\n      : \"**Pricing Context:** No specific rates provided. Use typical WA rates for this trade, but clearly state that all pricing is approximate and must be verified.\";\n\n    // Load job materials if they exist\n    let materialsContext = \"\";\n    if (job.materialsTotal != null && job.materialsTotal > 0) {\n      const { getPrisma } = await import(\"./prisma\"); const prisma = getPrisma();\n      const jobMaterials = await (prisma as any).jobMaterial.findMany({\n        where: {\n          jobId: job.id,\n          userId: job.userId,\n        },\n        orderBy: { createdAt: \"asc\" },\n      });\n\n      if (jobMaterials.length > 0) {\n        const materialsList = jobMaterials\n          .map((m: any) => `${m.name} (${m.quantity} ${m.unitLabel})`)\n          .join(\", \");\n        materialsContext = `\\n**Materials Total:** $${job.materialsTotal.toFixed(2)}\\n**Materials List:** ${materialsList}`;\n      }\n    }\n\n    // Load attachments with captions for additional context\n    let attachmentsContext = \"\";\n    try {\n      const { getPrisma } = await import(\"./prisma\"); const prisma = getPrisma();\n      const attachments = await (prisma as any).jobAttachment.findMany({\n        where: {\n          jobId: job.id,\n          userId: job.userId,\n        },\n        select: {\n          fileName: true,\n          kind: true,\n          caption: true,\n        },\n        take: 10, // sanity limit\n        orderBy: { createdAt: \"desc\" },\n      });\n\n      if (attachments.length > 0) {\n        const attachmentLines = attachments\n          .filter((a: any) => a.caption) // Only include attachments with captions\n          .map((a: any) => `- Attachment: ${a.fileName}, Kind: ${a.kind}, Caption: \"${a.caption}\"`)\n          .join(\"\\n\");\n\n        if (attachmentLines) {\n          attachmentsContext = `\\n\\n**Additional site context from attachments (text only, no images processed):**\\n${attachmentLines}`;\n        }\n      }\n    } catch (error) {\n      // Log but don't fail job pack generation if attachment loading fails\n      console.warn(\"Failed to load attachments for AI context:\", error);\n    }\n\n    // Build client notes guidance including deposit and payment terms\n    let clientNotesGuidance = \"\";\n    \n    if (depositPct !== undefined && depositPct !== null) {\n      clientNotesGuidance += `\\n- Include payment terms: ${depositPct}% deposit required upfront, balance on completion.`;\n    }\n    if (paymentTerms) {\n      clientNotesGuidance += `\\n- Payment terms: ${paymentTerms}.`;\n    }\n    if (!depositPct && !paymentTerms) {\n      clientNotesGuidance += `\\n- Include standard payment terms (e.g. deposit required, balance on completion).`;\n    }\n\n    const userPrompt = `Generate a complete job pack for this ${job.tradeType.toLowerCase()} job:\n\n**Job Title:** ${job.title}\n**Trade Type:** ${job.tradeType}${materialsContext}\n**Property Type:** ${job.propertyType}\n**Location:** ${job.address || \"Western Australia\"}\n**Job Created:** ${job.createdAt}\n\n${pricingContext}\n\n**Job Details/Notes:**\n${job.notes || \"No additional details provided\"}${attachmentsContext}\n\nRespond with ONLY valid JSON (no markdown, no code blocks):\n{\n  \"summary\": \"Brief 2-3 sentence overview of the job\",\n  \"quote\": {\n    \"labour\": {\n      \"description\": \"What the labour covers (e.g. 2 painters, prep, 2 coats all surfaces)\",\n      \"hours\": \"XX hours\",\n      \"ratePerHour\": \"$50/hr\" or \"$100/hr for 2 painters\",\n      \"total\": \"$XXXX\"\n    },\n    \"materials\": {\n      \"description\": \"Paint and materials summary\",\n      \"totalMaterialsCost\": \"$XXX\"\n    },\n    \"totalEstimate\": {\n      \"description\": \"Complete job including labour and materials\",\n      \"totalJobEstimate\": \"$X,XXX - $X,XXX\"\n    }\n  },\n  \"scopeOfWork\": [\"Prep: wash/sand/fill as needed\", \"Prime bare areas\", \"2 coats walls\", \"2 coats ceilings\", \"...\"],\n  \"inclusions\": [\"All paint and materials\", \"Surface preparation\", \"Drop sheets and protection\", \"...\"],\n  \"exclusions\": [\"Furniture removal\", \"Repairs beyond minor patching\", \"...\"],\n  \"materials\": [\n    { \"item\": \"Dulux Wash & Wear 10L\", \"quantity\": \"2\", \"estimatedCost\": \"$350\" },\n    { \"item\": \"Dulux Ceiling White 10L\", \"quantity\": \"1\", \"estimatedCost\": \"$120\" }\n  ],\n  \"clientNotes\": \"Professional notes about payment terms${depositPct ? ` (${depositPct}% deposit required)` : \"\"}, expected timeline, access requirements, etc.${clientNotesGuidance}\"\n}\n\nIMPORTANT REMINDERS:\n- All pricing is ESTIMATE ONLY. The tradie must verify quantities and current supplier prices before sending to client.\n- Material prices are approximate and must be checked against current supplier pricing (e.g. Dulux/Bunnings).\n- Labour hours are estimates based on typical work - actual time may vary.\n- The client must understand this is a quote/estimate, not a fixed price, until quantities are confirmed on site.`;\n\n    let response;\n    try {\n      response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: userPrompt },\n        ],\n        temperature: 0.7,\n        max_tokens: 2000,\n      });\n    } catch (apiError: any) {\n      console.error(\"OpenAI API error:\", apiError);\n      throw new Error(`AI service error: ${apiError?.message || \"Failed to connect to AI service. Please try again.\"}`);\n    }\n\n    if (!response?.choices || response.choices.length === 0) {\n      throw new Error(\"AI service returned an invalid response. Please try again.\");\n    }\n\n    const content = response.choices[0]?.message?.content || \"\";\n\n    if (!content || content.trim().length === 0) {\n      throw new Error(\"AI returned empty response. Please try again.\");\n    }\n\n    // Try to parse the JSON response\n    try {\n      // Clean up potential markdown code blocks\n      let cleanContent = content.trim();\n      if (cleanContent.startsWith(\"```json\")) {\n        cleanContent = cleanContent.slice(7);\n      }\n      if (cleanContent.startsWith(\"```\")) {\n        cleanContent = cleanContent.slice(3);\n      }\n      if (cleanContent.endsWith(\"```\")) {\n        cleanContent = cleanContent.slice(0, -3);\n      }\n      cleanContent = cleanContent.trim();\n\n      const parsed: JobPackResponse = JSON.parse(cleanContent);\n\n      // Map parsed fields onto the job with proper type handling\n      // All string fields must be validated to prevent runtime errors if AI returns wrong types\n      job.aiSummary = typeof parsed.summary === \"string\" ? parsed.summary : \"\";\n      job.aiQuote = parsed.quote ? JSON.stringify(parsed.quote) : \"\";\n      job.aiScopeOfWork = Array.isArray(parsed.scopeOfWork)\n        ? parsed.scopeOfWork.join(\"\\n\")\n        : (typeof parsed.scopeOfWork === \"string\" ? parsed.scopeOfWork : \"\");\n      job.aiInclusions = Array.isArray(parsed.inclusions)\n        ? parsed.inclusions.join(\"\\n\")\n        : (typeof parsed.inclusions === \"string\" ? parsed.inclusions : \"\");\n      job.aiExclusions = Array.isArray(parsed.exclusions)\n        ? parsed.exclusions.join(\"\\n\")\n        : (typeof parsed.exclusions === \"string\" ? parsed.exclusions : \"\");\n      job.aiMaterials = Array.isArray(parsed.materials)\n        ? JSON.stringify(parsed.materials)\n        : (typeof parsed.materials === \"string\" ? parsed.materials : \"\");\n      job.aiClientNotes = typeof parsed.clientNotes === \"string\" ? parsed.clientNotes : \"\";\n      job.status = \"ai_complete\";\n    } catch (parseError: any) {\n      // If JSON parsing fails, throw a more descriptive error\n      console.error(\"Failed to parse AI response as JSON:\", parseError);\n      console.error(\"AI response content:\", content.substring(0, 500));\n      throw new Error(`Failed to parse AI response. The AI may have returned invalid JSON. Please try again.`);\n    }\n\n    await saveJob(job);\n    return job;\n  } catch (error: any) {\n    console.error(\"Error generating job pack:\", error);\n    \n    // Preserve specific error messages\n    if (error?.message?.includes(\"EMAIL_NOT_VERIFIED\")) {\n      job.status = \"ai_failed\";\n      await saveJob(job);\n      throw error; // Re-throw email verification errors as-is\n    }\n    \n    // For other errors, provide a more helpful message\n    const errorMessage = error?.message || \"An unexpected error occurred while generating the job pack\";\n    job.status = \"ai_failed\";\n    await saveJob(job);\n    throw new Error(errorMessage);\n  }\n}\n\n/**\n * Generates a SWMS (Safe Work Method Statement) for the given job\n * @param job - The job to generate a SWMS for\n * @param user - The user creating/owning the job (for loading business profile)\n */\nexport async function generateSWMS(job: Job, user?: SafeUser): Promise<Job> {\n  try {\n    // Set status to generating\n    job.swmsStatus = \"GENERATING\";\n    await saveJob(job);\n\n    // Load user business profile from Prisma if available\n    let userPrimaryTrade: string | null = null;\n    let userTradeTypes: string | null = null;\n    \n    if (user) {\n      try {\n        const { getPrisma } = await import(\"./prisma\"); const prisma = getPrisma();\n        const prismaUser = await prisma.user.findUnique({\n          where: { id: user.id },\n        });\n        if (prismaUser) {\n          // Type assertion needed because Prisma types may not be fully up to date\n          const userData = prismaUser as any;\n          userPrimaryTrade = userData.primaryTrade || null;\n          userTradeTypes = userData.tradeTypes || null;\n        }\n      } catch (error) {\n        console.warn(\"Failed to load Prisma user for SWMS:\", error);\n      }\n    }\n\n    const tradeType = userPrimaryTrade || job.tradeType;\n    const tradeTypes = userTradeTypes ? userTradeTypes.split(\",\").map(t => t.trim()).join(\", \") : null;\n\n    const systemPrompt = `You are an expert safety consultant specialising in Australian construction and trades work safety compliance. You create comprehensive Safe Work Method Statements (SWMS) that comply with Australian Work Health and Safety (WHS) regulations.\n\nYour SWMS documents must be:\n- Clear, structured, and professional\n- Compliant with Australian WHS standards\n- Specific to the trade and work type described\n- Practical and actionable for tradies on site\n- Well-formatted with clear headings and sections\n\nFormat your response as structured text with clear sections using headings and bullet points.`;\n\n    const userPrompt = `Generate a comprehensive Safe Work Method Statement (SWMS) for this ${job.tradeType.toLowerCase()} job:\n\n**Job Title:** ${job.title}\n**Trade Type:** ${job.tradeType}${tradeTypes ? ` (Specialisations: ${tradeTypes})` : \"\"}\n**Property Type:** ${job.propertyType}\n**Location:** ${job.address || \"Western Australia\"}\n\n${job.aiScopeOfWork ? `**Scope of Work:**\\n${job.aiScopeOfWork}` : \"\"}\n\n${job.notes ? `**Additional Job Details:**\\n${job.notes}` : \"\"}\n\nCreate a complete SWMS document with the following sections:\n\n1. **Scope of Works**\n   - Clear description of the work to be performed\n   - Location and site details\n   - Duration and timing considerations\n\n2. **Key Hazards**\n   - List all identified hazards relevant to this trade and work type\n   - Include physical, chemical, environmental, and ergonomic hazards\n   - Be specific to the work described\n\n3. **Risk Controls**\n   - For each hazard, specify control measures\n   - Include engineering controls, administrative controls, and PPE\n   - Reference Australian standards where relevant\n\n4. **Personal Protective Equipment (PPE) Required**\n   - List all required PPE items\n   - Specify when and where each item must be worn\n   - Include any special requirements\n\n5. **Step-by-Step Work Process**\n   - Detailed sequence of work steps\n   - Include safety controls embedded in each step\n   - Reference hazards and controls from earlier sections\n\n6. **Emergency Procedures**\n   - First aid procedures\n   - Emergency contact information\n   - Incident reporting requirements\n   - Evacuation procedures if applicable\n\nFormat the response as clear, structured text with section headings. Use bullet points and numbered lists where appropriate. Make it professional and suitable for site use.`;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: 0.7,\n      max_tokens: 3000,\n    });\n\n    const content = response.choices[0]?.message?.content || \"\";\n\n    if (content.trim()) {\n      job.swmsText = content.trim();\n      job.swmsStatus = \"READY\";\n    } else {\n      job.swmsStatus = \"FAILED\";\n    }\n\n    await saveJob(job);\n    return job;\n  } catch (error: any) {\n    console.error(\"[jobs] error generating SWMS:\", error);\n    job.swmsStatus = \"FAILED\";\n    await saveJob(job);\n    \n    // Provide more helpful error messages\n    if (error?.message?.includes(\"API key\") || error?.code === \"invalid_api_key\") {\n      throw new Error(\"OpenAI API key is not configured. Please contact support.\");\n    }\n    \n    const errorMessage = error?.message || \"Failed to generate SWMS. Please try again.\";\n    throw new Error(errorMessage);\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\kv.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[465,468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[465,468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'args' is defined but never used.","line":14,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[799,802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[799,802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2100,2103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2100,2103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":65,"column":22,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":65,"endColumn":43,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Create a KV instance that handles missing environment variables gracefully\r\n// In development, allow the app to start without KV (will fail when KV features are used)\r\nconst kvRestApiUrl = process.env.KV_REST_API_URL;\r\nconst kvRestApiToken = process.env.KV_REST_API_TOKEN;\r\n\r\n// Helper function to create a proxy that returns null/empty results instead of throwing\r\n// This allows the app to work in a degraded mode without KV\r\nfunction createKvFallbackProxy(): any {\r\n  return new Proxy({}, {\r\n    get(_target, prop) {\r\n      // Common KV methods that are used in the codebase\r\n      const kvMethods = [\"get\", \"set\", \"del\", \"keys\", \"exists\", \"mget\", \"mset\", \"hget\", \"hset\", \"hgetall\", \"sadd\", \"smembers\", \"srem\"];\r\n      if (kvMethods.includes(prop as string)) {\r\n        return async (...args: any[]) => {\r\n          // Return null/empty results instead of throwing errors\r\n          // This allows the app to continue functioning without KV\r\n          console.warn(\r\n            `[kv] KV store is not configured. Operation '${String(prop)}' returned null. ` +\r\n            `Please set KV_REST_API_URL and KV_REST_API_TOKEN in your .env.local file. ` +\r\n            `For local development, use Upstash Redis (free tier at https://upstash.com/)`\r\n          );\r\n          \r\n          // Return appropriate defaults based on method\r\n          if (prop === \"get\" || prop === \"hget\") {\r\n            return null;\r\n          }\r\n          if (prop === \"keys\" || prop === \"smembers\" || prop === \"hgetall\") {\r\n            return [];\r\n          }\r\n          if (prop === \"exists\") {\r\n            return 0;\r\n          }\r\n          // For set/delete operations, return success (no-op)\r\n          return \"OK\";\r\n        };\r\n      }\r\n      // For any other property access, return another proxy\r\n      return new Proxy({}, {\r\n        get() {\r\n          return async () => {\r\n            console.warn(\"[kv] KV store is not configured. Please set KV_REST_API_URL and KV_REST_API_TOKEN in your .env.local file.\");\r\n            return null;\r\n          };\r\n        },\r\n      });\r\n    },\r\n  });\r\n}\r\n\r\nlet kvInstance: any;\r\n\r\nif (!kvRestApiUrl || !kvRestApiToken) {\r\n  if (process.env.NODE_ENV === \"production\") {\r\n    throw new Error(\r\n      \"Missing KV_REST_API_URL or KV_REST_API_TOKEN environment variables. Please set them in your environment.\"\r\n    );\r\n  }\r\n  // Use fallback proxy for development (returns null instead of throwing)\r\n  kvInstance = createKvFallbackProxy();\r\n} else {\r\n  // Try to import @vercel/kv - it may throw if env vars are invalid\r\n  try {\r\n    // Use dynamic import with error handling\r\n    // eslint-disable-next-line @typescript-eslint/no-require-imports\r\n    const vercelKv = require(\"@vercel/kv\");\r\n    kvInstance = vercelKv.kv;\r\n  } catch (error) {\r\n    // If import/initialization fails, use the fallback proxy\r\n    console.warn(\"[kv] Failed to initialize Vercel KV, using fallback proxy:\", error instanceof Error ? error.message : String(error));\r\n    kvInstance = createKvFallbackProxy();\r\n  }\r\n}\r\n\r\nexport { kvInstance as kv };\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\matching.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\materials.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[538,541],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[538,541],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1427,1430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1427,1430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getPrisma } from \"@/lib/prisma\";\r\nimport { getJobById, saveJob } from \"./jobs\";\r\n\r\n/**\r\n * Recalculates materials totals for a job based on JobMaterial line items\r\n * Updates the Job record in KV with the new totals\r\n */\r\nexport async function recalcJobMaterialsTotals(jobId: string, userId: string): Promise<{\r\n  materialsSubtotal: number;\r\n  materialsMarkupTotal: number;\r\n  materialsTotal: number;\r\n}> {\r\n  const prisma = getPrisma();\r\n  // Load all JobMaterial rows for this job/user\r\n  const jobMaterials = await (prisma as any).jobMaterial.findMany({\r\n    where: {\r\n      jobId,\r\n      userId,\r\n    },\r\n  });\r\n\r\n  let materialsSubtotal = 0;\r\n  let materialsMarkupTotal = 0;\r\n  let materialsTotal = 0;\r\n\r\n  // Calculate line totals and update each line item\r\n  for (const line of jobMaterials) {\r\n    const unitCost = line.unitCost ? Number(line.unitCost) : 0;\r\n    const quantity = line.quantity || 0;\r\n    const markupPercent = line.markupPercent || 0;\r\n\r\n    // Calculate base cost for this line\r\n    const baseCost = unitCost * quantity;\r\n\r\n    // Calculate markup amount\r\n    const markupAmount = baseCost * (markupPercent / 100);\r\n\r\n    // Calculate line total\r\n    const lineTotal = baseCost + markupAmount;\r\n\r\n    // Update lineTotal in database if it changed\r\n    const currentLineTotal = line.lineTotal ? Number(line.lineTotal) : null;\r\n    if (currentLineTotal !== lineTotal) {\r\n      await (prisma as any).jobMaterial.update({\r\n        where: { id: line.id },\r\n        data: { lineTotal: lineTotal },\r\n      });\r\n    }\r\n\r\n    // Accumulate totals\r\n    materialsSubtotal += baseCost;\r\n    materialsMarkupTotal += markupAmount;\r\n    materialsTotal += lineTotal;\r\n  }\r\n\r\n  // Update the Job record in KV\r\n  const job = await getJobById(jobId);\r\n  if (job && job.userId === userId) {\r\n    job.materialsSubtotal = materialsSubtotal;\r\n    job.materialsMarkupTotal = materialsMarkupTotal;\r\n    job.materialsTotal = materialsTotal;\r\n    await saveJob(job);\r\n  }\r\n\r\n  return {\r\n    materialsSubtotal,\r\n    materialsMarkupTotal,\r\n    materialsTotal,\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\onboarding-guard.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[703,706],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[703,706],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { redirect } from \"next/navigation\";\r\nimport { getCurrentUser } from \"./auth\";\r\nimport { getPrisma } from \"./prisma\";\r\nimport { needsOnboarding, isBusinessProfileComplete } from \"./onboarding\";\r\n\r\n/**\r\n * Server-side guard that redirects users to onboarding if their profile is incomplete.\r\n * Call this at the top of protected pages for tradie/business users.\r\n * \r\n * @param currentPath - The current pathname (to avoid redirect loops)\r\n * @returns The Prisma user object (never null, redirects if needed)\r\n */\r\nexport async function requireCompleteProfile(currentPath?: string): Promise<{\r\n  id: string;\r\n  email: string;\r\n  role: string;\r\n  profileCompletedAt: Date | null;\r\n  [key: string]: any;\r\n}> {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    \r\n    if (!user) {\r\n      console.log(\"[onboarding] requireCompleteProfile: no user found, redirecting to login\");\r\n      redirect(\"/login?reason=unauthorised\");\r\n      return null as never;\r\n    }\r\n\r\n    console.log(\"[onboarding] requireCompleteProfile: checking profile for user\", user.id);\r\n\r\n    // Clients don't need onboarding\r\n    const prisma = getPrisma();\r\n    if (user.role === \"client\") {\r\n      // Return a minimal user object for clients\r\n      try {\r\n        const prismaUser = await prisma.user.findUnique({\r\n          where: { email: user.email },\r\n        });\r\n        if (!prismaUser) {\r\n          console.log(\"[onboarding] requireCompleteProfile: client user not found in Prisma, redirecting to login\");\r\n          redirect(\"/login?reason=unauthorised\");\r\n          return null as never;\r\n        }\r\n        return prismaUser;\r\n      } catch (error) {\r\n        // If database query fails, redirect to login for safety\r\n        console.error(\"[onboarding] Failed to fetch client user from Prisma:\", error);\r\n        redirect(\"/login?reason=unauthorised\");\r\n        return null as never;\r\n      }\r\n    }\r\n\r\n    // Fetch full user from Prisma to check onboarding status\r\n    let prismaUser;\r\n    try {\r\n      prismaUser = await prisma.user.findUnique({\r\n        where: { email: user.email },\r\n      });\r\n    } catch (error) {\r\n      // If database query fails, redirect to login for safety\r\n      console.error(\"[onboarding] Failed to fetch user from Prisma:\", error);\r\n      redirect(\"/login?reason=unauthorised\");\r\n      return null as never;\r\n    }\r\n\r\n    if (!prismaUser) {\r\n      console.log(\"[onboarding] requireCompleteProfile: user not found in Prisma, redirecting to login\");\r\n      redirect(\"/login?reason=unauthorised\");\r\n      return null as never;\r\n    }\r\n\r\n    // Skip onboarding check for these paths\r\n    const skipPaths = [\"/onboarding\", \"/logout\", \"/settings\", \"/api\"];\r\n    const shouldSkip = currentPath && skipPaths.some(path => currentPath.startsWith(path));\r\n    \r\n    if (shouldSkip) {\r\n      return prismaUser;\r\n    }\r\n\r\n    // Check if user needs onboarding\r\n    let needsOnboardingCheck = false;\r\n    try {\r\n      needsOnboardingCheck = needsOnboarding(prismaUser);\r\n    } catch (onboardingError) {\r\n      // If check fails, assume user needs onboarding (safe default)\r\n      console.error(\"[onboarding] Error checking onboarding status:\", onboardingError);\r\n      needsOnboardingCheck = true;\r\n    }\r\n\r\n    if (needsOnboardingCheck) {\r\n      console.log(\"[onboarding] requireCompleteProfile: user needs onboarding, redirecting\");\r\n      redirect(\"/onboarding\");\r\n      return null as never;\r\n    }\r\n\r\n    // Auto-complete for legacy users who already have complete profiles\r\n    if (!prismaUser.profileCompletedAt && isBusinessProfileComplete(prismaUser)) {\r\n      // Silently mark as complete (don't redirect, just update)\r\n      try {\r\n        await prisma.user.update({\r\n          where: { id: prismaUser.id },\r\n          data: { profileCompletedAt: new Date() },\r\n        });\r\n        // Return updated user\r\n        return {\r\n          ...prismaUser,\r\n          profileCompletedAt: new Date(),\r\n        };\r\n      } catch (error) {\r\n        // If update fails, just return the existing user without the update\r\n        console.error(\"[onboarding] Failed to update profileCompletedAt:\", error);\r\n        return prismaUser;\r\n      }\r\n    }\r\n\r\n    return prismaUser;\r\n  } catch (error) {\r\n    // Catch any unexpected errors and redirect to login\r\n    console.error(\"[onboarding] requireCompleteProfile: unexpected error\", error);\r\n    redirect(\"/login?reason=unauthorised\");\r\n    return null as never;\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\onboarding-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\onboarding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\openai.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\pagination.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\password-reset.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\pdfGenerator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cellHeight' is assigned a value but never used.","line":704,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":704,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Professional PDF Generator Utility for OMNEXORA\n * \n * This module provides a robust, well-formatted PDF generation system\n * with proper text handling, spacing, and page management.\n */\n\nimport { jsPDF } from \"jspdf\";\n\n// ============================================================================\n// CONFIGURATION\n// ============================================================================\n\nexport const PDF_CONFIG = {\n  // Page dimensions (A4)\n  pageWidth: 210,\n  pageHeight: 297,\n  \n  // Margins\n  marginTop: 25,\n  marginBottom: 30,\n  marginLeft: 20,\n  marginRight: 20,\n  \n  // Typography\n  fonts: {\n    title: { size: 20, weight: \"bold\" as const },\n    heading1: { size: 14, weight: \"bold\" as const },\n    heading2: { size: 12, weight: \"bold\" as const },\n    body: { size: 10, weight: \"normal\" as const },\n    small: { size: 9, weight: \"normal\" as const },\n    tiny: { size: 8, weight: \"normal\" as const },\n  },\n  \n  // Spacing\n  lineHeight: 1.4,\n  paragraphSpacing: 6,\n  sectionSpacing: 12,\n  \n  // Colors (RGB)\n  colors: {\n    primary: [245, 158, 11] as [number, number, number],      // amber-500\n    primaryDark: [217, 119, 6] as [number, number, number],   // amber-600\n    text: [15, 23, 42] as [number, number, number],           // slate-900\n    textMuted: [100, 116, 139] as [number, number, number],   // slate-500\n    textLight: [148, 163, 184] as [number, number, number],   // slate-400\n    success: [22, 163, 74] as [number, number, number],       // green-600\n    error: [220, 38, 38] as [number, number, number],         // red-600\n    warning: [146, 64, 14] as [number, number, number],       // amber-900\n    warningBg: [254, 243, 199] as [number, number, number],   // amber-50\n    warningBorder: [251, 191, 36] as [number, number, number], // amber-400\n    border: [226, 232, 240] as [number, number, number],      // slate-200\n    bgLight: [241, 245, 249] as [number, number, number],     // slate-100\n    white: [255, 255, 255] as [number, number, number],\n  },\n};\n\n// ============================================================================\n// PDF DOCUMENT CLASS\n// ============================================================================\n\nexport class PdfDocument {\n  private doc: jsPDF;\n  private y: number;\n  private pageNumber: number;\n  private config: typeof PDF_CONFIG;\n  private maxWidth: number;\n  private footerCallback?: (doc: jsPDF, pageNum: number, totalPages: number) => void;\n\n  constructor(options?: { orientation?: \"portrait\" | \"landscape\" }) {\n    this.doc = new jsPDF({\n      orientation: options?.orientation || \"portrait\",\n      unit: \"mm\",\n      format: \"a4\",\n    });\n    this.config = PDF_CONFIG;\n    this.y = this.config.marginTop;\n    this.pageNumber = 1;\n    this.maxWidth = this.config.pageWidth - this.config.marginLeft - this.config.marginRight;\n  }\n\n  // -------------------------------------------------------------------------\n  // Page Management\n  // -------------------------------------------------------------------------\n\n  /**\n   * Check if there's enough space for content, add new page if needed\n   */\n  checkNewPage(requiredSpace: number = 20): boolean {\n    const availableSpace = this.config.pageHeight - this.config.marginBottom - this.y;\n    if (availableSpace < requiredSpace) {\n      this.addPage();\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Add a new page\n   */\n  addPage(): void {\n    this.doc.addPage();\n    this.pageNumber++;\n    this.y = this.config.marginTop;\n  }\n\n  /**\n   * Get current Y position\n   */\n  getY(): number {\n    return this.y;\n  }\n\n  /**\n   * Set Y position\n   */\n  setY(y: number): void {\n    this.y = y;\n  }\n\n  /**\n   * Add vertical spacing\n   */\n  addSpace(mm: number): void {\n    this.y += mm;\n  }\n\n  // -------------------------------------------------------------------------\n  // Text Rendering\n  // -------------------------------------------------------------------------\n\n  /**\n   * Clean text to prevent encoding issues\n   */\n  private cleanText(text: string): string {\n    if (!text) return \"\";\n    \n    return text\n      // Remove any weird Unicode artifacts\n      .replace(/[\\u0000-\\u001F\\u007F-\\u009F]/g, \"\")\n      // Normalize whitespace\n      .replace(/\\s+/g, \" \")\n      // Remove markdown-style formatting artifacts\n      .replace(/\\*\\*/g, \"\")\n      .replace(/\\*/g, \"\")\n      .replace(/#{1,6}\\s*/g, \"\")\n      // Convert common HTML entities\n      .replace(/&amp;/g, \"&\")\n      .replace(/&lt;/g, \"<\")\n      .replace(/&gt;/g, \">\")\n      .replace(/&nbsp;/g, \" \")\n      .replace(/&quot;/g, '\"')\n      // Fix common encoding issues\n      .replace(/├óÔé¼\"/g, \"ÔÇö\")\n      .replace(/├óÔé¼╦£/g, \"'\")\n      .replace(/├óÔé¼Ôäó/g, \"'\")\n      .replace(/├óÔé¼┼ô/g, '\"')\n      .replace(/├óÔé¼/g, '\"')\n      .trim();\n  }\n\n  /**\n   * Add text with automatic wrapping and page breaks\n   */\n  addText(\n    text: string,\n    options?: {\n      fontSize?: number;\n      fontWeight?: \"normal\" | \"bold\";\n      color?: [number, number, number];\n      align?: \"left\" | \"center\" | \"right\";\n      maxWidth?: number;\n      indent?: number;\n    }\n  ): void {\n    const {\n      fontSize = this.config.fonts.body.size,\n      fontWeight = \"normal\",\n      color = this.config.colors.text,\n      align = \"left\",\n      maxWidth = this.maxWidth,\n      indent = 0,\n    } = options || {};\n\n    const cleanedText = this.cleanText(text);\n    if (!cleanedText) return;\n\n    this.doc.setFontSize(fontSize);\n    this.doc.setFont(\"helvetica\", fontWeight);\n    this.doc.setTextColor(...color);\n\n    const effectiveWidth = maxWidth - indent;\n    const lines = this.doc.splitTextToSize(cleanedText, effectiveWidth);\n    const lineHeight = fontSize * 0.4;\n\n    for (const line of lines) {\n      this.checkNewPage(lineHeight + 2);\n      \n      let xPos = this.config.marginLeft + indent;\n      if (align === \"center\") {\n        xPos = this.config.pageWidth / 2;\n      } else if (align === \"right\") {\n        xPos = this.config.pageWidth - this.config.marginRight;\n      }\n\n      this.doc.text(line, xPos, this.y, { align });\n      this.y += lineHeight;\n    }\n  }\n\n  /**\n   * Add a title (large, bold text)\n   */\n  addTitle(text: string, options?: { color?: [number, number, number] }): void {\n    this.addText(text, {\n      fontSize: this.config.fonts.title.size,\n      fontWeight: \"bold\",\n      color: options?.color || this.config.colors.text,\n    });\n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  /**\n   * Add a section heading with underline\n   */\n  addSectionHeading(text: string): void {\n    this.checkNewPage(20);\n    this.addSpace(this.config.sectionSpacing);\n    \n    // Heading text\n    this.doc.setFontSize(this.config.fonts.heading1.size);\n    this.doc.setFont(\"helvetica\", \"bold\");\n    this.doc.setTextColor(...this.config.colors.text);\n    this.doc.text(this.cleanText(text).toUpperCase(), this.config.marginLeft, this.y);\n    this.y += 6;\n\n    // Underline\n    this.doc.setDrawColor(...this.config.colors.border);\n    this.doc.setLineWidth(0.5);\n    this.doc.line(\n      this.config.marginLeft,\n      this.y,\n      this.config.pageWidth - this.config.marginRight,\n      this.y\n    );\n    this.y += 6;\n  }\n\n  /**\n   * Add a subsection heading\n   */\n  addSubheading(text: string): void {\n    this.checkNewPage(15);\n    this.addSpace(this.config.paragraphSpacing);\n    this.addText(text, {\n      fontSize: this.config.fonts.heading2.size,\n      fontWeight: \"bold\",\n    });\n    this.addSpace(2);\n  }\n\n  /**\n   * Add a paragraph of body text\n   */\n  addParagraph(text: string): void {\n    this.addText(text, {\n      fontSize: this.config.fonts.body.size,\n      fontWeight: \"normal\",\n    });\n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  /**\n   * Add a bullet list\n   */\n  addBulletList(items: string[], options?: { bulletColor?: [number, number, number] }): void {\n    const bulletColor = options?.bulletColor || this.config.colors.text;\n    const bulletIndent = 8;\n\n    for (const item of items) {\n      const cleanItem = this.cleanText(item);\n      if (!cleanItem) continue;\n\n      this.checkNewPage(10);\n      \n      // Bullet point\n      this.doc.setTextColor(...bulletColor);\n      this.doc.setFontSize(this.config.fonts.body.size);\n      this.doc.text(\"ÔÇó\", this.config.marginLeft, this.y);\n      \n      // Item text\n      this.doc.setTextColor(...this.config.colors.text);\n      const lines = this.doc.splitTextToSize(cleanItem, this.maxWidth - bulletIndent);\n      for (let i = 0; i < lines.length; i++) {\n        if (i > 0) this.checkNewPage(5);\n        this.doc.text(lines[i], this.config.marginLeft + bulletIndent, this.y);\n        this.y += this.config.fonts.body.size * 0.4;\n      }\n      this.y += 2;\n    }\n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  /**\n   * Add a numbered list\n   */\n  addNumberedList(items: string[]): void {\n    const numberIndent = 10;\n\n    for (let i = 0; i < items.length; i++) {\n      const cleanItem = this.cleanText(items[i]);\n      if (!cleanItem) continue;\n\n      this.checkNewPage(10);\n      \n      // Number\n      this.doc.setFontSize(this.config.fonts.body.size);\n      this.doc.setFont(\"helvetica\", \"bold\");\n      this.doc.setTextColor(...this.config.colors.text);\n      this.doc.text(`${i + 1}.`, this.config.marginLeft, this.y);\n      \n      // Item text\n      this.doc.setFont(\"helvetica\", \"normal\");\n      const lines = this.doc.splitTextToSize(cleanItem, this.maxWidth - numberIndent);\n      for (let j = 0; j < lines.length; j++) {\n        if (j > 0) this.checkNewPage(5);\n        this.doc.text(lines[j], this.config.marginLeft + numberIndent, this.y);\n        this.y += this.config.fonts.body.size * 0.4;\n      }\n      this.y += 3;\n    }\n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  /**\n   * Add inclusions list (with green checkmarks)\n   */\n  addInclusionsList(items: string[]): void {\n    for (const item of items) {\n      const cleanItem = this.cleanText(item);\n      if (!cleanItem) continue;\n\n      this.checkNewPage(10);\n      \n      // Checkmark\n      this.doc.setTextColor(...this.config.colors.success);\n      this.doc.setFontSize(this.config.fonts.body.size);\n      this.doc.text(\"\\u2713\", this.config.marginLeft, this.y); // Unicode checkmark\n      \n      // Item text\n      this.doc.setTextColor(...this.config.colors.text);\n      const lines = this.doc.splitTextToSize(cleanItem, this.maxWidth - 8);\n      for (let i = 0; i < lines.length; i++) {\n        if (i > 0) this.checkNewPage(5);\n        this.doc.text(lines[i], this.config.marginLeft + 8, this.y);\n        this.y += this.config.fonts.body.size * 0.4;\n      }\n      this.y += 2;\n    }\n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  /**\n   * Add exclusions list (with red X marks)\n   */\n  addExclusionsList(items: string[]): void {\n    for (const item of items) {\n      const cleanItem = this.cleanText(item);\n      if (!cleanItem) continue;\n\n      this.checkNewPage(10);\n      \n      // X mark\n      this.doc.setTextColor(...this.config.colors.error);\n      this.doc.setFontSize(this.config.fonts.body.size);\n      this.doc.text(\"\\u2717\", this.config.marginLeft, this.y); // Unicode X mark\n      \n      // Item text\n      this.doc.setTextColor(...this.config.colors.text);\n      const lines = this.doc.splitTextToSize(cleanItem, this.maxWidth - 8);\n      for (let i = 0; i < lines.length; i++) {\n        if (i > 0) this.checkNewPage(5);\n        this.doc.text(lines[i], this.config.marginLeft + 8, this.y);\n        this.y += this.config.fonts.body.size * 0.4;\n      }\n      this.y += 2;\n    }\n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  // -------------------------------------------------------------------------\n  // Special Elements\n  // -------------------------------------------------------------------------\n\n  /**\n   * Add branded header with OMNEXORA logo\n   */\n  addBrandedHeader(subtitle?: string): void {\n    // Amber banner\n    this.doc.setFillColor(...this.config.colors.primary);\n    this.doc.rect(0, 0, this.config.pageWidth, 35, \"F\");\n\n    // Logo text\n    this.doc.setFontSize(22);\n    this.doc.setFont(\"helvetica\", \"bold\");\n    this.doc.setTextColor(...this.config.colors.white);\n    this.doc.text(\"OMNEXORA\", this.config.marginLeft, 18);\n\n    // Subtitle\n    if (subtitle) {\n      this.doc.setFontSize(10);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.text(subtitle, this.config.marginLeft, 26);\n    }\n\n    this.y = 50;\n    this.doc.setTextColor(...this.config.colors.text);\n  }\n\n  /**\n   * Add business identity header for professional documents\n   * Shows business name, trading name, ABN, contact details\n   */\n  addBusinessHeader(issuer: {\n    legalName?: string;\n    tradingName?: string;\n    abn?: string;\n    email?: string;\n    phone?: string;\n    addressLine1?: string;\n    addressLine2?: string;\n    suburb?: string;\n    state?: string;\n    postcode?: string;\n  }): void {\n    // Header background (subtle)\n    this.doc.setFillColor(248, 250, 252); // slate-50\n    this.doc.rect(0, 0, this.config.pageWidth, 45, \"F\");\n    \n    // Bottom border\n    this.doc.setDrawColor(226, 232, 240); // slate-200\n    this.doc.setLineWidth(0.5);\n    this.doc.line(0, 45, this.config.pageWidth, 45);\n\n    let yPos = 12;\n\n    // Business legal name (large)\n    if (issuer.legalName) {\n      this.doc.setFontSize(16);\n      this.doc.setFont(\"helvetica\", \"bold\");\n      this.doc.setTextColor(15, 23, 42); // slate-900\n      this.doc.text(issuer.legalName, this.config.marginLeft, yPos);\n      yPos += 6;\n    }\n\n    // Trading name (if different)\n    if (issuer.tradingName && issuer.tradingName !== issuer.legalName) {\n      this.doc.setFontSize(10);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(71, 85, 105); // slate-600\n      this.doc.text(`Trading as: ${issuer.tradingName}`, this.config.marginLeft, yPos);\n      yPos += 4;\n    }\n\n    // ABN (formatted)\n    if (issuer.abn) {\n      this.doc.setFontSize(9);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(100, 116, 139); // slate-500\n      // Format ABN: XX XXX XXX XXX\n      const abnClean = issuer.abn.replace(/\\s/g, \"\");\n      const abnFormatted = abnClean.length === 11 \n        ? `${abnClean.slice(0, 2)} ${abnClean.slice(2, 5)} ${abnClean.slice(5, 8)} ${abnClean.slice(8, 11)}`\n        : issuer.abn;\n      this.doc.text(`ABN: ${abnFormatted}`, this.config.marginLeft, yPos);\n      yPos += 4;\n    }\n\n    // Contact info on right side\n    let rightY = 12;\n    const rightX = this.config.pageWidth - this.config.marginRight;\n\n    // Phone\n    if (issuer.phone) {\n      this.doc.setFontSize(9);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(71, 85, 105); // slate-600\n      this.doc.text(issuer.phone, rightX, rightY, { align: \"right\" });\n      rightY += 4;\n    }\n\n    // Email\n    if (issuer.email) {\n      this.doc.setFontSize(9);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(71, 85, 105); // slate-600\n      this.doc.text(issuer.email, rightX, rightY, { align: \"right\" });\n      rightY += 4;\n    }\n\n    // Address\n    const addressParts: string[] = [];\n    if (issuer.addressLine1) addressParts.push(issuer.addressLine1);\n    if (issuer.addressLine2) addressParts.push(issuer.addressLine2);\n    const locality: string[] = [];\n    if (issuer.suburb) locality.push(issuer.suburb);\n    if (issuer.state) locality.push(issuer.state);\n    if (issuer.postcode) locality.push(issuer.postcode);\n    if (locality.length > 0) addressParts.push(locality.join(\" \"));\n    \n    if (addressParts.length > 0) {\n      const fullAddress = addressParts.join(\", \");\n      this.doc.setFontSize(8);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(100, 116, 139); // slate-500\n      const addressLines = this.doc.splitTextToSize(fullAddress, this.maxWidth / 2);\n      addressLines.forEach((line: string) => {\n        this.doc.text(line, rightX, rightY, { align: \"right\" });\n        rightY += 3.5;\n      });\n    }\n\n    // Set Y position after header\n    this.y = 55;\n    this.doc.setTextColor(...this.config.colors.text);\n  }\n\n  /**\n   * Add professional footer for issued documents (no AI warnings)\n   */\n  addIssuedFooter(issuerName: string, documentId?: string): void {\n    const totalPages = this.doc.getNumberOfPages();\n    const timestamp = new Date().toLocaleString(\"en-AU\", {\n      day: \"numeric\",\n      month: \"short\",\n      year: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n    \n    for (let i = 1; i <= totalPages; i++) {\n      this.doc.setPage(i);\n      \n      // Footer line\n      this.doc.setDrawColor(226, 232, 240); // slate-200\n      this.doc.setLineWidth(0.3);\n      this.doc.line(this.config.marginLeft, this.config.pageHeight - 18, this.config.pageWidth - this.config.marginRight, this.config.pageHeight - 18);\n\n      this.doc.setFontSize(7);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(100, 116, 139); // slate-500\n      \n      // Issued by line\n      this.doc.text(\n        `Issued by ${issuerName}`,\n        this.config.pageWidth / 2,\n        this.config.pageHeight - 13,\n        { align: \"center\" }\n      );\n      \n      // Document ID and page number\n      let footerText = timestamp;\n      if (documentId) {\n        footerText = `Document: ${documentId} | ${timestamp}`;\n      }\n      footerText += ` | Page ${i} of ${totalPages}`;\n      \n      this.doc.text(\n        footerText,\n        this.config.pageWidth / 2,\n        this.config.pageHeight - 9,\n        { align: \"center\" }\n      );\n    }\n  }\n\n  /**\n   * Add AI content warning box\n   */\n  addAiWarning(): void {\n    this.checkNewPage(35);\n    \n    const boxHeight = 28;\n    const boxY = this.y - 2;\n\n    // Warning box background\n    this.doc.setFillColor(...this.config.colors.warningBg);\n    this.doc.rect(this.config.marginLeft, boxY, this.maxWidth, boxHeight, \"F\");\n    \n    // Warning box border\n    this.doc.setDrawColor(...this.config.colors.warningBorder);\n    this.doc.setLineWidth(0.5);\n    this.doc.rect(this.config.marginLeft, boxY, this.maxWidth, boxHeight);\n\n    // Warning title\n    this.doc.setFontSize(9);\n    this.doc.setFont(\"helvetica\", \"bold\");\n    this.doc.setTextColor(...this.config.colors.warning);\n    this.doc.text(\"AI-GENERATED CONTENT WARNING\", this.config.marginLeft + 4, this.y + 4);\n\n    // Warning text\n    this.doc.setFontSize(8);\n    this.doc.setFont(\"helvetica\", \"normal\");\n    this.doc.setTextColor(120, 53, 15);\n    const warningText = \"This document contains AI-generated content that must be reviewed before use. You are responsible for ensuring compliance with all applicable Australian laws and regulations.\";\n    const warningLines = this.doc.splitTextToSize(warningText, this.maxWidth - 8);\n    let warningY = this.y + 10;\n    for (const line of warningLines) {\n      this.doc.text(line, this.config.marginLeft + 4, warningY);\n      warningY += 4;\n    }\n\n    this.y = boxY + boxHeight + 10;\n    this.doc.setTextColor(...this.config.colors.text);\n  }\n\n  /**\n   * Add a highlighted box (for totals, key info, etc.)\n   */\n  addHighlightBox(content: { label: string; value: string }, options?: { bgColor?: [number, number, number] }): void {\n    this.checkNewPage(25);\n    \n    const boxHeight = 20;\n    const bgColor = options?.bgColor || this.config.colors.warningBg;\n\n    this.doc.setFillColor(...bgColor);\n    this.doc.rect(this.config.marginLeft, this.y - 2, this.maxWidth, boxHeight, \"F\");\n\n    this.doc.setFontSize(12);\n    this.doc.setFont(\"helvetica\", \"bold\");\n    this.doc.setTextColor(...this.config.colors.text);\n    this.doc.text(content.label, this.config.marginLeft + 4, this.y + 6);\n\n    this.doc.setFontSize(14);\n    this.doc.text(content.value, this.config.marginLeft + 4, this.y + 14);\n\n    this.y += boxHeight + 8;\n  }\n\n  /**\n   * Add a simple table with improved formatting for Australian standards\n   */\n  addTable(headers: string[], rows: string[][], options?: { colWidths?: number[] }): void {\n    const colWidths = options?.colWidths || headers.map(() => this.maxWidth / headers.length);\n    const rowHeight = 9; // Slightly increased for better readability\n    const cellPadding = 3; // Increased padding\n    const headerHeight = rowHeight + 2;\n\n    // Header row with better styling\n    this.checkNewPage(headerHeight + 10);\n    const headerY = this.y;\n    \n    // Header background\n    this.doc.setFillColor(245, 158, 11); // amber-500\n    this.doc.rect(this.config.marginLeft, headerY - 2, this.maxWidth, headerHeight, \"F\");\n    \n    // Header border\n    this.doc.setDrawColor(217, 119, 6); // amber-600\n    this.doc.setLineWidth(0.5);\n    this.doc.rect(this.config.marginLeft, headerY - 2, this.maxWidth, headerHeight, \"S\");\n    \n    this.doc.setFontSize(this.config.fonts.small.size);\n    this.doc.setFont(\"helvetica\", \"bold\");\n    this.doc.setTextColor(255, 255, 255); // white text on amber background\n    \n    let xPos = this.config.marginLeft + cellPadding;\n    for (let i = 0; i < headers.length; i++) {\n      const headerText = this.cleanText(headers[i]);\n      // Allow text wrapping in headers if needed\n      const lines = this.doc.splitTextToSize(headerText, colWidths[i] - (cellPadding * 2));\n      lines.forEach((line: string, lineIndex: number) => {\n        this.doc.text(line, xPos, headerY + (lineIndex * 4) + 4);\n      });\n      xPos += colWidths[i];\n    }\n    this.y = headerY + headerHeight;\n\n    // Data rows with alternating colors and borders\n    this.doc.setFont(\"helvetica\", \"normal\");\n    this.doc.setTextColor(...this.config.colors.text);\n    \n    for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {\n      const row = rows[rowIndex];\n      const isEvenRow = rowIndex % 2 === 0;\n      \n      this.checkNewPage(rowHeight);\n      \n      // Alternating row background for better readability\n      if (isEvenRow) {\n        this.doc.setFillColor(248, 250, 252); // slate-50\n        this.doc.rect(this.config.marginLeft, this.y - 2, this.maxWidth, rowHeight, \"F\");\n      }\n      \n      // Row border\n      this.doc.setDrawColor(226, 232, 240); // slate-200\n      this.doc.setLineWidth(0.3);\n      this.doc.rect(this.config.marginLeft, this.y - 2, this.maxWidth, rowHeight, \"S\");\n      \n      xPos = this.config.marginLeft + cellPadding;\n      for (let i = 0; i < row.length; i++) {\n        const cellText = this.cleanText(row[i] || \"\");\n        // Allow text wrapping in cells\n        const lines = this.doc.splitTextToSize(cellText, colWidths[i] - (cellPadding * 2));\n        const cellHeight = Math.max(rowHeight, lines.length * 4 + 2);\n        \n        lines.forEach((line: string, lineIndex: number) => {\n          this.doc.text(line, xPos, this.y + (lineIndex * 4) + 3);\n        });\n        xPos += colWidths[i];\n      }\n      this.y += rowHeight;\n    }\n    \n    // Bottom border\n    this.doc.setDrawColor(203, 213, 225); // slate-300\n    this.doc.setLineWidth(0.5);\n    this.doc.line(this.config.marginLeft, this.y - 2, this.config.marginLeft + this.maxWidth, this.y - 2);\n    \n    this.addSpace(this.config.paragraphSpacing);\n  }\n\n  /**\n   * Add horizontal line separator\n   */\n  addSeparator(): void {\n    this.checkNewPage(5);\n    this.doc.setDrawColor(...this.config.colors.border);\n    this.doc.setLineWidth(0.3);\n    this.doc.line(\n      this.config.marginLeft,\n      this.y,\n      this.config.pageWidth - this.config.marginRight,\n      this.y\n    );\n    this.y += 5;\n  }\n\n  /**\n   * Add metadata row (label: value format)\n   */\n  addMetadata(items: Array<{ label: string; value: string }>): void {\n    this.doc.setFontSize(this.config.fonts.small.size);\n    this.doc.setTextColor(...this.config.colors.textMuted);\n    \n    for (const item of items) {\n      if (!item.value) continue;\n      this.checkNewPage(6);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.text(`${item.label}: ${this.cleanText(item.value)}`, this.config.marginLeft, this.y);\n      this.y += 5;\n    }\n    this.addSpace(this.config.paragraphSpacing);\n    this.doc.setTextColor(...this.config.colors.text);\n  }\n\n  /**\n   * Add image (with error handling)\n   */\n  addImage(dataUrl: string, options?: { width?: number; height?: number }): boolean {\n    if (!dataUrl) return false;\n    \n    try {\n      this.checkNewPage(options?.height || 40);\n      \n      const width = options?.width || 80;\n      const height = options?.height || 30;\n      \n      this.doc.addImage(\n        dataUrl,\n        \"PNG\",\n        this.config.marginLeft,\n        this.y,\n        width,\n        height\n      );\n      \n      this.y += height + 8;\n      return true;\n    } catch (error) {\n      console.warn(\"Failed to add image to PDF:\", error);\n      return false;\n    }\n  }\n\n  // -------------------------------------------------------------------------\n  // Footer Management\n  // -------------------------------------------------------------------------\n\n  /**\n   * Set footer callback for all pages\n   */\n  setFooter(callback: (doc: jsPDF, pageNum: number, totalPages: number) => void): void {\n    this.footerCallback = callback;\n  }\n\n  /**\n   * Add standard OMNEXORA footer to all pages\n   */\n  addStandardFooters(options?: { jobId?: string }): void {\n    const totalPages = this.doc.getNumberOfPages();\n    const timestamp = new Date().toLocaleString(\"en-AU\", {\n      day: \"numeric\",\n      month: \"short\",\n      year: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n    \n    for (let i = 1; i <= totalPages; i++) {\n      this.doc.setPage(i);\n      this.doc.setFontSize(8);\n      this.doc.setFont(\"helvetica\", \"normal\");\n      this.doc.setTextColor(...this.config.colors.textLight);\n      \n      // OVIS line\n      this.doc.text(\n        \"OVIS Checked Output - OMNEXORA Checked Intelligence Systems\",\n        this.config.pageWidth / 2,\n        this.config.pageHeight - 20,\n        { align: \"center\" }\n      );\n      \n      // Footer line\n      let footerText = `Generated by OMNEXORA  |  ${timestamp}`;\n      if (options?.jobId) {\n        footerText += `  |  Job ${options.jobId.slice(0, 8)}`;\n      }\n      footerText += `  |  Page ${i} of ${totalPages}`;\n      \n      this.doc.text(\n        footerText,\n        this.config.pageWidth / 2,\n        this.config.pageHeight - 10,\n        { align: \"center\" }\n      );\n    }\n  }\n\n  // -------------------------------------------------------------------------\n  // Document Output\n  // -------------------------------------------------------------------------\n\n  /**\n   * Get the jsPDF instance for advanced operations\n   */\n  getDoc(): jsPDF {\n    return this.doc;\n  }\n\n  /**\n   * Save the PDF with the given filename\n   */\n  save(filename: string): void {\n    this.doc.save(filename);\n  }\n\n  /**\n   * Get PDF as blob\n   */\n  getBlob(): Blob {\n    return this.doc.output(\"blob\");\n  }\n\n  /**\n   * Get PDF as base64 string\n   */\n  getBase64(): string {\n    return this.doc.output(\"datauristring\");\n  }\n}\n\n// ============================================================================\n// UTILITY FUNCTIONS\n// ============================================================================\n\n/**\n * Parse structured text content into sections\n */\nexport function parseStructuredContent(content: string): Array<{ type: \"heading\" | \"text\" | \"list\"; content: string }> {\n  const sections: Array<{ type: \"heading\" | \"text\" | \"list\"; content: string }> = [];\n  \n  if (!content) return sections;\n\n  const lines = content.split(\"\\n\");\n  let currentText = \"\";\n  let currentList: string[] = [];\n\n  const flushText = () => {\n    if (currentText.trim()) {\n      sections.push({ type: \"text\", content: currentText.trim() });\n      currentText = \"\";\n    }\n  };\n\n  const flushList = () => {\n    if (currentList.length > 0) {\n      sections.push({ type: \"list\", content: currentList.join(\"\\n\") });\n      currentList = [];\n    }\n  };\n\n  for (const line of lines) {\n    const trimmed = line.trim();\n    \n    // Skip empty lines\n    if (!trimmed) {\n      if (currentText) currentText += \" \";\n      continue;\n    }\n\n    // Check for headings (## or ** at start)\n    if (trimmed.match(/^#{1,6}\\s/) || trimmed.match(/^\\*\\*[^*]+\\*\\*$/)) {\n      flushText();\n      flushList();\n      sections.push({\n        type: \"heading\",\n        content: trimmed.replace(/^#{1,6}\\s*/, \"\").replace(/\\*\\*/g, \"\"),\n      });\n      continue;\n    }\n\n    // Check for numbered headings (1. **Title**)\n    if (trimmed.match(/^\\d+\\.\\s+\\*\\*/)) {\n      flushText();\n      flushList();\n      sections.push({\n        type: \"heading\",\n        content: trimmed.replace(/^\\d+\\.\\s+\\*\\*/, \"\").replace(/\\*\\*$/, \"\"),\n      });\n      continue;\n    }\n\n    // Check for bullet points\n    if (trimmed.match(/^[-ÔÇó*]\\s/)) {\n      flushText();\n      currentList.push(trimmed.replace(/^[-ÔÇó*]\\s+/, \"\"));\n      continue;\n    }\n\n    // Check for numbered list items\n    if (trimmed.match(/^\\d+\\.\\s/) && !trimmed.match(/^\\d+\\.\\s+\\*\\*/)) {\n      flushText();\n      currentList.push(trimmed.replace(/^\\d+\\.\\s+/, \"\"));\n      continue;\n    }\n\n    // Regular text\n    flushList();\n    currentText += (currentText ? \" \" : \"\") + trimmed;\n  }\n\n  flushText();\n  flushList();\n\n  return sections;\n}\n\n/**\n * Format currency for Australian locale\n */\nexport function formatCurrency(amount: number): string {\n  return new Intl.NumberFormat(\"en-AU\", {\n    style: \"currency\",\n    currency: \"AUD\",\n  }).format(amount);\n}\n\n/**\n * Format date for Australian locale\n */\nexport function formatDate(dateString: string): string {\n  return new Date(dateString).toLocaleDateString(\"en-AU\", {\n    day: \"numeric\",\n    month: \"long\",\n    year: \"numeric\",\n  });\n}\n\n/**\n * Format datetime for Australian locale\n */\nexport function formatDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"en-AU\", {\n    day: \"numeric\",\n    month: \"long\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\planChecks.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[483,486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[483,486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[888,891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[888,891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { SafeUser } from \"./auth\";\r\nimport { isAdmin } from \"./auth\";\r\n\r\n/**\r\n * Checks if a user has a paid plan (not FREE tier)\r\n * @param user - The user to check\r\n * @returns True if user has a paid plan\r\n */\r\nexport function hasPaidPlan(user: SafeUser | null): boolean {\r\n  if (!user) return false;\r\n  \r\n  // Admin users always have access\r\n  if (isAdmin(user)) {\r\n    return true;\r\n  }\r\n  \r\n  // Check plan tier - FREE is the only unpaid tier\r\n  const planTier = (user as any).planTier || \"FREE\";\r\n  return planTier !== \"FREE\";\r\n}\r\n\r\n/**\r\n * Checks if a user is on the FREE plan\r\n * @param user - The user to check\r\n * @returns True if user is on FREE plan\r\n */\r\nexport function isFreePlan(user: SafeUser | null): boolean {\r\n  if (!user) return true;\r\n  \r\n  // Admin users are never on free plan\r\n  if (isAdmin(user)) {\r\n    return false;\r\n  }\r\n  \r\n  const planTier = (user as any).planTier || \"FREE\";\r\n  return planTier === \"FREE\";\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\pricing.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2776,2779],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2776,2779],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Pricing helper functions for computing effective rates\r\n * Combines user business profile rates with job-level overrides\r\n */\r\n\r\nimport type { SafeUser } from \"./auth\";\r\nimport type { Job } from \"./jobs\";\r\nimport { getPrisma } from \"./prisma\";\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface EffectiveRates {\r\n  hourlyRate?: number;\r\n  helperHourlyRate?: number;\r\n  dayRate?: number;\r\n  ratePerM2Interior?: number;\r\n  ratePerM2Exterior?: number;\r\n  ratePerLmTrim?: number;\r\n  calloutFee?: number;\r\n  minCharge?: number;\r\n  materialMarkupPercent?: number;\r\n  // Business & Rates settings\r\n  defaultMarginPct?: number | null;\r\n  defaultDepositPct?: number | null;\r\n  gstRegistered?: boolean;\r\n  defaultPaymentTerms?: string | null;\r\n  tradeRates?: {\r\n    painter?: {\r\n      wallsPerM2?: number;\r\n      ceilingsPerM2?: number;\r\n      trimPerM?: number;\r\n      doorsEach?: number;\r\n    };\r\n  } | null;\r\n}\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Computes effective rates for a job by combining:\r\n * 1. Job-level overrides (if present)\r\n * 2. RateTemplate (if job has rateTemplateId)\r\n * 3. User business profile rates (from Prisma)\r\n * 4. User pricing settings (from KV)\r\n * \r\n * Uses the rateResolver helper for consistent hierarchy.\r\n * \r\n * @param user - The user object from KV (SafeUser)\r\n * @param job - The job object (optional, for job-level overrides)\r\n * @returns Effective rates to use for quote generation\r\n */\r\nexport async function getEffectiveRates(args: {\r\n  user: SafeUser;\r\n  job?: Job | null;\r\n}): Promise<EffectiveRates> {\r\n  const { user, job } = args;\r\n  \r\n  // Import rateResolver\r\n  const { resolveEffectiveRates } = await import(\"./rateResolver\");\r\n  \r\n  // Load business profile rates from Prisma\r\n  let prismaUser = null;\r\n  let rateTemplate = null;\r\n  \r\n  try {\r\n    // Load business profile and Business & Rates settings\r\n    const prisma = getPrisma();\r\n    prismaUser = await prisma.user.findUnique({\r\n      where: { email: user.email },\r\n      select: {\r\n        hourlyRate: true,\r\n        dayRate: true,\r\n        calloutFee: true,\r\n        ratePerM2Interior: true,\r\n        ratePerM2Exterior: true,\r\n        ratePerLmTrim: true,\r\n        gstRegistered: true,\r\n        defaultMarginPct: true,\r\n        defaultDepositPct: true,\r\n        defaultPaymentTerms: true,\r\n        tradeRatesJson: true,\r\n      },\r\n    });\r\n\r\n    // Load rate template if job has rateTemplateId\r\n    if (job?.rateTemplateId) {\r\n      rateTemplate = await (prisma as any).rateTemplate.findUnique({\r\n        where: { id: job.rateTemplateId },\r\n      });\r\n    }\r\n  } catch (error) {\r\n    // If Prisma lookup fails, continue without template/profile\r\n    console.warn(\"Failed to load Prisma data for rates:\", error);\r\n  }\r\n\r\n  // Use rateResolver for consistent hierarchy\r\n  const businessProfile = prismaUser ? {\r\n    hourlyRate: prismaUser.hourlyRate,\r\n    calloutFee: prismaUser.calloutFee,\r\n    ratePerM2Interior: prismaUser.ratePerM2Interior,\r\n    ratePerM2Exterior: prismaUser.ratePerM2Exterior,\r\n    ratePerLmTrim: prismaUser.ratePerLmTrim,\r\n  } : null;\r\n\r\n  const resolvedRates = resolveEffectiveRates({\r\n    job: job || ({} as Job),\r\n    rateTemplate: rateTemplate ? {\r\n      id: rateTemplate.id,\r\n      userId: rateTemplate.userId,\r\n      name: rateTemplate.name,\r\n      tradeType: rateTemplate.tradeType,\r\n      propertyType: rateTemplate.propertyType,\r\n      hourlyRate: rateTemplate.hourlyRate,\r\n      helperHourlyRate: rateTemplate.helperHourlyRate,\r\n      dayRate: rateTemplate.dayRate,\r\n      calloutFee: rateTemplate.calloutFee,\r\n      minCharge: rateTemplate.minCharge,\r\n      ratePerM2Interior: rateTemplate.ratePerM2Interior,\r\n      ratePerM2Exterior: rateTemplate.ratePerM2Exterior,\r\n      ratePerLmTrim: rateTemplate.ratePerLmTrim,\r\n      materialMarkupPercent: rateTemplate.materialMarkupPercent,\r\n      isDefault: rateTemplate.isDefault,\r\n      createdAt: rateTemplate.createdAt,\r\n      updatedAt: rateTemplate.updatedAt,\r\n    } : null,\r\n    businessProfile,\r\n  });\r\n\r\n  // Fallback to KV pricing settings for material markup if not in template\r\n  if (resolvedRates.materialMarkupPercent == null && user.materialMarkupPercent != null) {\r\n    resolvedRates.materialMarkupPercent = user.materialMarkupPercent;\r\n  }\r\n\r\n  // Add Business & Rates settings from Prisma\r\n  if (prismaUser) {\r\n    // Use defaultMarginPct from Business & Rates if materialMarkupPercent not already set\r\n    if (resolvedRates.materialMarkupPercent == null && prismaUser.defaultMarginPct != null) {\r\n      resolvedRates.materialMarkupPercent = Number(prismaUser.defaultMarginPct);\r\n    }\r\n    \r\n    resolvedRates.defaultMarginPct = prismaUser.defaultMarginPct ? Number(prismaUser.defaultMarginPct) : null;\r\n    resolvedRates.defaultDepositPct = prismaUser.defaultDepositPct ? Number(prismaUser.defaultDepositPct) : null;\r\n    resolvedRates.gstRegistered = prismaUser.gstRegistered ?? false;\r\n    resolvedRates.defaultPaymentTerms = prismaUser.defaultPaymentTerms ?? null;\r\n    \r\n    // Parse tradeRatesJson if present\r\n    if (prismaUser.tradeRatesJson) {\r\n      try {\r\n        resolvedRates.tradeRates = JSON.parse(prismaUser.tradeRatesJson);\r\n      } catch {\r\n        resolvedRates.tradeRates = null;\r\n      }\r\n    }\r\n    \r\n    // Add dayRate if not already set from template\r\n    if (resolvedRates.dayRate == null && prismaUser.dayRate != null) {\r\n      resolvedRates.dayRate = prismaUser.dayRate;\r\n    }\r\n  }\r\n\r\n  return resolvedRates;\r\n}\r\n\r\n/**\r\n * Formats effective rates for display in UI\r\n * Shows which rates are being used and their source\r\n */\r\nexport function formatEffectiveRatesForDisplay(rates: EffectiveRates): string {\r\n  const parts: string[] = [];\r\n  \r\n  if (rates.hourlyRate) {\r\n    parts.push(`$${rates.hourlyRate}/hr`);\r\n  }\r\n  if (rates.ratePerM2Interior) {\r\n    parts.push(`$${rates.ratePerM2Interior}/m┬▓ interior`);\r\n  }\r\n  if (rates.ratePerM2Exterior) {\r\n    parts.push(`$${rates.ratePerM2Exterior}/m┬▓ exterior`);\r\n  }\r\n  if (rates.ratePerLmTrim) {\r\n    parts.push(`$${rates.ratePerLmTrim}/lm`);\r\n  }\r\n  if (rates.calloutFee) {\r\n    parts.push(`$${rates.calloutFee} callout`);\r\n  }\r\n\r\n  return parts.length > 0 ? parts.join(\", \") : \"default rates\";\r\n}\r\n\r\n/**\r\n * Extracts numeric value from a currency string (e.g., \"$1,385.50\" -> 1385.50)\r\n */\r\nfunction extractNumericValue(currencyString: string): number | null {\r\n  // Remove currency symbols, commas, and spaces, then parse\r\n  const cleaned = currencyString.replace(/[$,┬úÔé¼┬Ñ\\s]/g, \"\");\r\n  const parsed = parseFloat(cleaned);\r\n  return isNaN(parsed) ? null : parsed;\r\n}\r\n\r\n/**\r\n * Formats a number as currency with commas (e.g., 1385.5 -> \"$1,386\")\r\n */\r\nfunction formatCurrency(value: number): string {\r\n  return `$${Math.round(value).toLocaleString(\"en-AU\")}`;\r\n}\r\n\r\n/**\r\n * Calculates a realistic estimate range from a quote\r\n * \r\n * Takes the total estimate from a quote and derives a range:\r\n * - Low: 5% below base (rounded to nearest $10)\r\n * - High: 10% above base (rounded to nearest $10)\r\n * \r\n * @param quoteJson - The JSON string containing the quote\r\n * @returns Object with baseTotal, lowEstimate, highEstimate, and formattedRange\r\n */\r\nexport interface EstimateRange {\r\n  baseTotal: number | null;\r\n  lowEstimate: number | null;\r\n  highEstimate: number | null;\r\n  formattedRange: string;\r\n}\r\n\r\nexport function calculateEstimateRange(quoteJson: string | undefined | null): EstimateRange {\r\n  if (!quoteJson) {\r\n    return {\r\n      baseTotal: null,\r\n      lowEstimate: null,\r\n      highEstimate: null,\r\n      formattedRange: \"N/A\",\r\n    };\r\n  }\r\n\r\n  try {\r\n    const quote = JSON.parse(quoteJson);\r\n    const totalEstimateText = quote.totalEstimate?.totalJobEstimate;\r\n\r\n    if (!totalEstimateText || typeof totalEstimateText !== \"string\") {\r\n      return {\r\n        baseTotal: null,\r\n        lowEstimate: null,\r\n        highEstimate: null,\r\n        formattedRange: \"N/A\",\r\n      };\r\n    }\r\n\r\n    // Try to extract numeric value from the total estimate string\r\n    // Handle formats like \"$1,385.50\", \"$1,385.50 ÔÇô $1,385.50\", \"$1,350 - $1,550\", etc.\r\n    const rangeMatch = totalEstimateText.match(/\\$[\\d,]+\\.?\\d*/g);\r\n    let baseTotal: number | null = null;\r\n\r\n    if (rangeMatch && rangeMatch.length > 0) {\r\n      // If there's a range, use the first value as base\r\n      // If identical min/max, use that value\r\n      const firstValue = extractNumericValue(rangeMatch[0]);\r\n      const secondValue = rangeMatch[1] ? extractNumericValue(rangeMatch[1]) : null;\r\n      \r\n      if (firstValue !== null) {\r\n        // If both values exist and are different, use the average\r\n        if (secondValue !== null && Math.abs(firstValue - secondValue) > 1) {\r\n          baseTotal = (firstValue + secondValue) / 2;\r\n        } else {\r\n          // Use the first value as base\r\n          baseTotal = firstValue;\r\n        }\r\n      }\r\n    } else {\r\n      // Try to extract any number from the string\r\n      baseTotal = extractNumericValue(totalEstimateText);\r\n    }\r\n\r\n    // Fallback: try to calculate from labour + materials if available\r\n    if (baseTotal === null) {\r\n      let labourTotal = 0;\r\n      let materialsTotal = 0;\r\n\r\n      if (quote.labour?.total) {\r\n        const labourValue = extractNumericValue(quote.labour.total);\r\n        if (labourValue !== null) labourTotal = labourValue;\r\n      }\r\n\r\n      if (quote.materials?.totalMaterialsCost) {\r\n        const materialsValue = extractNumericValue(quote.materials.totalMaterialsCost);\r\n        if (materialsValue !== null) materialsTotal = materialsValue;\r\n      }\r\n\r\n      if (labourTotal > 0 || materialsTotal > 0) {\r\n        baseTotal = labourTotal + materialsTotal;\r\n      }\r\n    }\r\n\r\n    if (baseTotal === null || baseTotal <= 0) {\r\n      return {\r\n        baseTotal: null,\r\n        lowEstimate: null,\r\n        highEstimate: null,\r\n        formattedRange: \"N/A\",\r\n      };\r\n    }\r\n\r\n    // Calculate range: 5% below, 10% above\r\n    const low = baseTotal * 0.95;\r\n    const high = baseTotal * 1.10;\r\n\r\n    // Round to nearest $10\r\n    const lowRounded = Math.round(low / 10) * 10;\r\n    const highRounded = Math.round(high / 10) * 10;\r\n\r\n    // Ensure low < high\r\n    if (lowRounded >= highRounded) {\r\n      // Fallback: use base ┬▒ $50\r\n      return {\r\n        baseTotal,\r\n        lowEstimate: Math.max(0, Math.round(baseTotal - 50)),\r\n        highEstimate: Math.round(baseTotal + 50),\r\n        formattedRange: `${formatCurrency(Math.max(0, Math.round(baseTotal - 50)))} ÔÇô ${formatCurrency(Math.round(baseTotal + 50))}`,\r\n      };\r\n    }\r\n\r\n    return {\r\n      baseTotal,\r\n      lowEstimate: lowRounded,\r\n      highEstimate: highRounded,\r\n      formattedRange: `${formatCurrency(lowRounded)} ÔÇô ${formatCurrency(highRounded)}`,\r\n    };\r\n  } catch (error) {\r\n    console.error(\"Error calculating estimate range:\", error);\r\n    return {\r\n      baseTotal: null,\r\n      lowEstimate: null,\r\n      highEstimate: null,\r\n      formattedRange: \"N/A\",\r\n    };\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\prisma.ts","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-var').","line":4,"column":3,"severity":1,"nodeType":null,"fix":{"range":[67,101],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { PrismaClient } from \"@prisma/client\";\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var __prisma: PrismaClient | undefined;\n}\n\n/**\n * Get the Prisma client instance (lazy initialization).\n *\n * This function creates/returns a singleton Prisma client only when called,\n * avoiding build-time errors when database env vars are not available.\n *\n * Supports both SQLite (DATABASE_URL) for local development and Postgres\n * (POSTGRES_PRISMA_URL or POSTGRES_URL) for production.\n * MUST be called inside request handlers only - never at module top level.\n */\nexport function getPrisma(): PrismaClient {\n  // Check for SQLite first (local development), then Postgres (production)\n  const datasourceUrl =\n    process.env.DATABASE_URL ||\n    process.env.POSTGRES_PRISMA_URL ||\n    process.env.POSTGRES_URL;\n\n  if (!datasourceUrl) {\n    throw new Error(\n      \"Database configuration error: missing DATABASE_URL (SQLite) or POSTGRES_URL/POSTGRES_PRISMA_URL (Postgres). Please set DATABASE_URL in .env.local for local development (e.g., file:./prisma/dev.db)\"\n    );\n  }\n\n  if (process.env.NODE_ENV === \"production\") {\n    return new PrismaClient({ datasourceUrl });\n  }\n\n  if (!global.__prisma) {\n    global.__prisma = new PrismaClient({ datasourceUrl });\n  }\n\n  return global.__prisma;\n}\n\nexport async function safeDbQuery<T>(\n  queryFn: () => Promise<T>,\n  fallbackError = \"Database operation failed. Please try again.\"\n): Promise<{ data: T | null; error: string | null }> {\n  try {\n    const data = await queryFn();\n    return { data, error: null };\n  } catch (err) {\n    console.error(\"[prisma] Database query error:\", err);\n    return { data: null, error: fallbackError };\n  }\n}\n\nexport function isPrismaError(error: unknown): boolean {\n  if (error instanceof Error) {\n    const message = error.message.toLowerCase();\n    return (\n      message.includes(\"prisma\") ||\n      message.includes(\"database\") ||\n      message.includes(\"sqlite\") ||\n      message.includes(\"postgresql\") ||\n      message.includes(\"connection\") ||\n      message.includes(\"p1\") ||\n      message.includes(\"p2\") ||\n      message.includes(\"environment variable not found\")\n    );\n  }\n  return false;\n}\n\nexport function getSafeErrorMessage(\n  error: unknown,\n  fallback = \"An unexpected error occurred. Please try again.\"\n): string {\n  if (isPrismaError(error)) {\n    return \"Service temporarily unavailable. Please try again shortly.\";\n  }\n\n  if (error instanceof Error) {\n    const msg = error.message;\n    if (\n      !msg.includes(\"prisma\") &&\n      !msg.includes(\"schema.prisma\") &&\n      !msg.includes(\"DATABASE_URL\") &&\n      !msg.includes(\"POSTGRES\") &&\n      !msg.includes(\"at \") &&\n      !msg.includes(\".ts:\") &&\n      !msg.includes(\".js:\")\n    ) {\n      return msg;\n    }\n  }\n\n  return fallback;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\quotes.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1345,1348],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1345,1348],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Quote number and version management helpers\r\n */\r\n\r\nimport { getJobById, saveJob } from \"./jobs\";\r\nimport { getPrisma } from \"./prisma\";\r\n\r\n/**\r\n * Ensures a job has a quote number, generating one if needed.\r\n * Format: Q-{YYYY}-{NNNN} (e.g. Q-2024-0012)\r\n */\r\nexport async function ensureQuoteNumber(jobId: string): Promise<string> {\r\n  const job = await getJobById(jobId);\r\n  if (!job) {\r\n    throw new Error(`Job ${jobId} not found`);\r\n  }\r\n\r\n  // If quote number already exists, return it\r\n  if (job.quoteNumber) {\r\n    return job.quoteNumber;\r\n  }\r\n\r\n  // Generate a new quote number\r\n  const currentYear = new Date().getFullYear();\r\n  \r\n  // For MVP, use a simple sequence based on timestamp\r\n  // In production, you might want a per-user or global sequence counter\r\n  const timestamp = Date.now();\r\n  const sequence = (timestamp % 10000).toString().padStart(4, \"0\");\r\n  \r\n  const quoteNumber = `Q-${currentYear}-${sequence}`;\r\n\r\n  // Save the quote number to the job\r\n  job.quoteNumber = quoteNumber;\r\n  await saveJob(job);\r\n\r\n  return quoteNumber;\r\n}\r\n\r\n/**\r\n * Gets the next quote version number for a job.\r\n * Returns max(version) + 1, or 1 if none exist.\r\n */\r\nexport async function getNextQuoteVersion(jobId: string): Promise<number> {\r\n  try {\r\n    const prisma = getPrisma();\r\n    const existingVersions = await (prisma as any).jobQuoteVersion.findMany({\r\n      where: { jobId },\r\n      select: { version: true },\r\n      orderBy: { version: \"desc\" },\r\n      take: 1,\r\n    });\r\n\r\n    if (existingVersions.length === 0) {\r\n      return 1;\r\n    }\r\n\r\n    const maxVersion = existingVersions[0].version;\r\n    return maxVersion + 1;\r\n  } catch (error) {\r\n    console.error(\"Error getting next quote version:\", error);\r\n    // Fallback: return 1 if query fails\r\n    return 1;\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\rateResolver.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\signup-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\lib\\verification.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3925,3928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3925,3928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getPrisma } from \"./prisma\";\r\nimport type { UserVerification } from \"@prisma/client\";\r\n\r\nexport type VerificationStatus = \"unverified\" | \"pending\" | \"verified\" | \"rejected\";\r\n\r\nexport interface UserVerificationData {\r\n  // Business details\r\n  businessName?: string | null;\r\n  abn?: string | null;\r\n  primaryTrade?: string | null;\r\n  workTypes?: string | null;\r\n  \r\n  // Licence\r\n  licenceNumber?: string | null;\r\n  licenceType?: string | null;\r\n  licenceExpiry?: Date | string | null;\r\n  \r\n  // Insurance\r\n  insuranceProvider?: string | null;\r\n  insurancePolicyNumber?: string | null;\r\n  insuranceExpiry?: Date | string | null;\r\n  insuranceCoverageNotes?: string | null;\r\n  \r\n  // Evidence URLs\r\n  abnEvidenceUrl?: string | null;\r\n  licenceEvidenceUrl?: string | null;\r\n  insuranceEvidenceUrl?: string | null;\r\n}\r\n\r\n/**\r\n * Gets the verification record for a user, or returns a default object if none exists\r\n */\r\nexport async function getUserVerification(userId: string): Promise<UserVerification | null> {\r\n  const prisma = getPrisma();\r\n  return prisma.userVerification.findUnique({\r\n    where: { userId },\r\n  });\r\n}\r\n\r\n/**\r\n * Creates or updates a user's verification record (user-facing submission)\r\n * Does NOT change status - that's admin-only\r\n */\r\nexport async function upsertUserVerification(\r\n  userId: string,\r\n  data: UserVerificationData\r\n): Promise<UserVerification> {\r\n  // Parse dates if provided as strings\r\n  const licenceExpiry = data.licenceExpiry\r\n    ? typeof data.licenceExpiry === \"string\"\r\n      ? new Date(data.licenceExpiry)\r\n      : data.licenceExpiry\r\n    : null;\r\n  \r\n  const insuranceExpiry = data.insuranceExpiry\r\n    ? typeof data.insuranceExpiry === \"string\"\r\n      ? new Date(data.insuranceExpiry)\r\n      : data.insuranceExpiry\r\n    : null;\r\n\r\n  const prisma = getPrisma();\r\n  return prisma.userVerification.upsert({\r\n    where: { userId },\r\n    create: {\r\n      userId,\r\n      status: \"unverified\", // Will be set to \"pending\" by API route when submitted\r\n      businessName: data.businessName || null,\r\n      abn: data.abn || null,\r\n      primaryTrade: data.primaryTrade || null,\r\n      workTypes: data.workTypes || null,\r\n      licenceNumber: data.licenceNumber || null,\r\n      licenceType: data.licenceType || null,\r\n      licenceExpiry: licenceExpiry,\r\n      insuranceProvider: data.insuranceProvider || null,\r\n      insurancePolicyNumber: data.insurancePolicyNumber || null,\r\n      insuranceExpiry: insuranceExpiry,\r\n      insuranceCoverageNotes: data.insuranceCoverageNotes || null,\r\n      abnEvidenceUrl: data.abnEvidenceUrl || null,\r\n      licenceEvidenceUrl: data.licenceEvidenceUrl || null,\r\n      insuranceEvidenceUrl: data.insuranceEvidenceUrl || null,\r\n    },\r\n    update: {\r\n      businessName: data.businessName || null,\r\n      abn: data.abn || null,\r\n      primaryTrade: data.primaryTrade || null,\r\n      workTypes: data.workTypes || null,\r\n      licenceNumber: data.licenceNumber || null,\r\n      licenceType: data.licenceType || null,\r\n      licenceExpiry: licenceExpiry,\r\n      insuranceProvider: data.insuranceProvider || null,\r\n      insurancePolicyNumber: data.insurancePolicyNumber || null,\r\n      insuranceExpiry: insuranceExpiry,\r\n      insuranceCoverageNotes: data.insuranceCoverageNotes || null,\r\n      abnEvidenceUrl: data.abnEvidenceUrl || null,\r\n      licenceEvidenceUrl: data.licenceEvidenceUrl || null,\r\n      insuranceEvidenceUrl: data.insuranceEvidenceUrl || null,\r\n      // Don't update status here - that's admin-only\r\n      // Don't update adminNotes or rejectionReason here\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Admin-only: Updates verification status and admin notes\r\n */\r\nexport async function updateVerificationStatus(\r\n  userId: string,\r\n  status: VerificationStatus,\r\n  adminData?: {\r\n    adminNotes?: string | null;\r\n    rejectionReason?: string | null;\r\n    reviewerId?: string | null;\r\n  }\r\n): Promise<UserVerification> {\r\n  const updateData: any = {\r\n    status,\r\n    updatedAt: new Date(),\r\n  };\r\n\r\n  if (adminData) {\r\n    if (adminData.adminNotes !== undefined) {\r\n      updateData.adminNotes = adminData.adminNotes;\r\n    }\r\n    if (adminData.rejectionReason !== undefined) {\r\n      updateData.rejectionReason = adminData.rejectionReason;\r\n    }\r\n    if (adminData.reviewerId !== undefined) {\r\n      updateData.reviewedByAdminId = adminData.reviewerId;\r\n    }\r\n  }\r\n\r\n  // If status is verified, clear rejection reason\r\n  if (status === \"verified\") {\r\n    updateData.rejectionReason = null;\r\n  }\r\n\r\n  const prisma = getPrisma();\r\n  // Also update the User's verificationStatus field for backwards compatibility\r\n  await prisma.user.update({\r\n    where: { id: userId },\r\n    data: {\r\n      verificationStatus: status,\r\n      verifiedAt: status === \"verified\" ? new Date() : null,\r\n    },\r\n  });\r\n\r\n  return prisma.userVerification.update({\r\n    where: { userId },\r\n    data: updateData,\r\n  });\r\n}\r\n\r\n/**\r\n * Gets all verification records with a specific status, sorted by createdAt desc\r\n */\r\nexport async function getVerificationsByStatus(\r\n  status: VerificationStatus\r\n): Promise<UserVerification[]> {\r\n  const prisma = getPrisma();\r\n  return prisma.userVerification.findMany({\r\n    where: { status },\r\n    orderBy: { createdAt: \"desc\" },\r\n    include: {\r\n      user: {\r\n        select: {\r\n          id: true,\r\n          email: true,\r\n          role: true,\r\n          createdAt: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Gets all verification records, sorted by status (pending first) then createdAt desc\r\n */\r\nexport async function getAllVerifications(): Promise<UserVerification[]> {\r\n  try {\r\n    const prisma = getPrisma();\r\n    const verifications = await prisma.userVerification.findMany({\r\n      orderBy: [\r\n        { status: \"asc\" }, // pending comes before verified/rejected\r\n        { createdAt: \"desc\" },\r\n      ],\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            role: true,\r\n            createdAt: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n    \r\n    // Filter out any verifications with missing user relations (orphaned records)\r\n    return verifications.filter(v => v.user !== null);\r\n  } catch (error) {\r\n    console.error(\"[verification] error fetching all verifications:\", error);\r\n    // Return empty array instead of throwing - allows admin page to load gracefully\r\n    return [];\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\middleware.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_req' is defined but never used.","line":5,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// middleware.ts ÔÇô minimal pass-through middleware\r\nimport type { NextRequest } from \"next/server\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nexport function middleware(_req: NextRequest) {\r\n  // For now, just continue the request pipeline.\r\n  // All auth + onboarding logic is handled in the app routes themselves.\r\n  return NextResponse.next();\r\n}\r\n\r\n// If you later want to limit middleware to specific routes, you can use:\r\n//\r\n// export const config = {\r\n//   matcher: [\"/dashboard/:path*\", \"/clients/:path*\", \"/jobs/:path*\"],\r\n// };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\scripts\\demo-seed.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\scripts\\exportUsersFromPostgres.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1649,1652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1649,1652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Export Users from Postgres Database\r\n * \r\n * This script reads all users from the Postgres database (POSTGRES_DATABASE_URL)\r\n * and exports them to scripts/users-export.json in a format ready for import.\r\n */\r\n\r\n// Load environment variables from .env.local\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport { config } from \"dotenv\";\r\n\r\n// Load .env.local file\r\nconst envPath = path.join(process.cwd(), \".env.local\");\r\nif (fs.existsSync(envPath)) {\r\n  config({ path: envPath });\r\n} else {\r\n  // Also try .env as fallback\r\n  config();\r\n}\r\n\r\nimport { Client } from \"pg\";\r\n\r\nconst POSTGRES_DATABASE_URL = process.env.POSTGRES_DATABASE_URL;\r\n\r\nif (!POSTGRES_DATABASE_URL) {\r\n  console.error(\"Error: POSTGRES_DATABASE_URL environment variable is not set.\");\r\n  console.error(\"Please set it in your .env.local file.\");\r\n  process.exit(1);\r\n}\r\n\r\ninterface ExportedUser {\r\n  id: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  createdAt: string;\r\n  role: string;\r\n  verificationStatus: string;\r\n  verifiedAt: string | null;\r\n  planTier: string;\r\n  planStatus: string;\r\n  trialEndsAt: string | null;\r\n  lastLoginAt: string | null;\r\n  lastActivityAt: string | null;\r\n  totalJobs: number;\r\n  totalJobPacks: number;\r\n  businessName: string | null;\r\n  tradingName: string | null;\r\n  abn: string | null;\r\n  tradeTypes: string | null; // Will be stored as comma-separated or JSON string\r\n  serviceArea: string | null;\r\n  serviceAreaCity: string | null;\r\n  serviceAreaRadiusKm: number | null;\r\n}\r\n\r\nasync function exportUsers() {\r\n  // Parse connection string and add SSL if needed for managed Postgres services\r\n  const clientConfig: any = {\r\n    connectionString: POSTGRES_DATABASE_URL,\r\n    // Add SSL support for managed Postgres (Vercel, Supabase, etc.)\r\n    ssl: process.env.POSTGRES_SSL !== \"false\" ? {\r\n      rejectUnauthorized: false, // Allow self-signed certificates\r\n    } : false,\r\n    // Increase connection timeout\r\n    connectionTimeoutMillis: 30000, // 30 seconds\r\n  };\r\n\r\n  const client = new Client(clientConfig);\r\n\r\n  try {\r\n    console.log(\"Connecting to Postgres database...\");\r\n    console.log(\"Note: If connection times out, check:\");\r\n    console.log(\"  1. Your network/VPN connection\");\r\n    console.log(\"  2. Database IP whitelisting\");\r\n    console.log(\"  3. Firewall rules\");\r\n    console.log(\"  4. Connection string in .env.local\\n\");\r\n    \r\n    await client.connect();\r\n    console.log(\"Connected successfully.\");\r\n\r\n    // Query all users from the users table\r\n    const query = `\r\n      SELECT \r\n        id,\r\n        email,\r\n        \"passwordHash\",\r\n        \"createdAt\",\r\n        role,\r\n        \"verificationStatus\",\r\n        \"verifiedAt\",\r\n        \"planTier\",\r\n        \"planStatus\",\r\n        \"trialEndsAt\",\r\n        \"lastLoginAt\",\r\n        \"lastActivityAt\",\r\n        \"totalJobs\",\r\n        \"totalJobPacks\",\r\n        \"businessName\",\r\n        \"tradingName\",\r\n        abn,\r\n        \"tradeTypes\",\r\n        \"serviceArea\",\r\n        \"serviceAreaCity\",\r\n        \"serviceAreaRadiusKm\"\r\n      FROM users\r\n      ORDER BY \"createdAt\" ASC\r\n    `;\r\n\r\n    console.log(\"Fetching users from Postgres...\");\r\n    const result = await client.query(query);\r\n\r\n    const users: ExportedUser[] = result.rows.map((row) => {\r\n      // Convert Date objects to ISO strings for JSON serialization\r\n      // Handle tradeTypes - if it's an array, convert to comma-separated string\r\n      let tradeTypes: string | null = null;\r\n      if (row.tradeTypes) {\r\n        if (Array.isArray(row.tradeTypes)) {\r\n          tradeTypes = row.tradeTypes.join(\",\");\r\n        } else if (typeof row.tradeTypes === \"string\") {\r\n          tradeTypes = row.tradeTypes;\r\n        }\r\n      }\r\n\r\n      return {\r\n        id: row.id,\r\n        email: row.email,\r\n        passwordHash: row.passwordHash,\r\n        createdAt: row.createdAt ? new Date(row.createdAt).toISOString() : new Date().toISOString(),\r\n        role: row.role || \"tradie\",\r\n        verificationStatus: row.verificationStatus || \"unverified\",\r\n        verifiedAt: row.verifiedAt ? new Date(row.verifiedAt).toISOString() : null,\r\n        planTier: row.planTier || \"FREE\",\r\n        planStatus: row.planStatus || \"TRIAL\",\r\n        trialEndsAt: row.trialEndsAt ? new Date(row.trialEndsAt).toISOString() : null,\r\n        lastLoginAt: row.lastLoginAt ? new Date(row.lastLoginAt).toISOString() : null,\r\n        lastActivityAt: row.lastActivityAt ? new Date(row.lastActivityAt).toISOString() : null,\r\n        totalJobs: row.totalJobs ?? 0,\r\n        totalJobPacks: row.totalJobPacks ?? 0,\r\n        businessName: row.businessName || null,\r\n        tradingName: row.tradingName || null,\r\n        abn: row.abn || null,\r\n        tradeTypes,\r\n        serviceArea: row.serviceArea || null,\r\n        serviceAreaCity: row.serviceAreaCity || null,\r\n        serviceAreaRadiusKm: row.serviceAreaRadiusKm ?? null,\r\n      };\r\n    });\r\n\r\n    // Ensure scripts directory exists\r\n    const scriptsDir = path.join(process.cwd(), \"scripts\");\r\n    if (!fs.existsSync(scriptsDir)) {\r\n      fs.mkdirSync(scriptsDir, { recursive: true });\r\n    }\r\n\r\n    // Write to JSON file\r\n    const outputPath = path.join(scriptsDir, \"users-export.json\");\r\n    fs.writeFileSync(outputPath, JSON.stringify(users, null, 2), \"utf-8\");\r\n\r\n    console.log(`\\nÔ£à Export completed successfully!`);\r\n    console.log(`   Exported ${users.length} users to ${outputPath}`);\r\n  } catch (error) {\r\n    console.error(\"Error exporting users:\", error);\r\n    process.exit(1);\r\n  } finally {\r\n    await client.end();\r\n    console.log(\"Database connection closed.\");\r\n  }\r\n}\r\n\r\n// Run the export\r\nexportUsers().catch((error) => {\r\n  console.error(\"Fatal error:\", error);\r\n  process.exit(1);\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\scripts\\importUsersToSqlite.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updated' is assigned a value but never used.","line":83,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":83,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Import Users to SQLite Database\r\n * \r\n * This script reads users from scripts/users-export.json and imports them\r\n * into the SQLite database using Prisma Client (configured via DATABASE_URL).\r\n * Uses upsert by id, so it's safe to run multiple times.\r\n */\r\n\r\n// Load environment variables from .env.local\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport { config } from \"dotenv\";\r\n\r\n// Load .env.local file\r\nconst envPath = path.join(process.cwd(), \".env.local\");\r\nif (fs.existsSync(envPath)) {\r\n  config({ path: envPath });\r\n} else {\r\n  // Also try .env as fallback\r\n  config();\r\n}\r\n\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface ExportedUser {\r\n  id: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  createdAt: string;\r\n  role: string;\r\n  verificationStatus: string;\r\n  verifiedAt: string | null;\r\n  planTier: string;\r\n  planStatus: string;\r\n  trialEndsAt: string | null;\r\n  lastLoginAt: string | null;\r\n  lastActivityAt: string | null;\r\n  totalJobs: number;\r\n  totalJobPacks: number;\r\n  businessName: string | null;\r\n  tradingName: string | null;\r\n  abn: string | null;\r\n  tradeTypes: string | null;\r\n  serviceArea: string | null;\r\n  serviceAreaCity: string | null;\r\n  serviceAreaRadiusKm: number | null;\r\n}\r\n\r\nfunction parseDate(dateString: string | null): Date | null {\r\n  if (!dateString) return null;\r\n  try {\r\n    return new Date(dateString);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function importUsers() {\r\n  try {\r\n    const exportPath = path.join(process.cwd(), \"scripts\", \"users-export.json\");\r\n\r\n    if (!fs.existsSync(exportPath)) {\r\n      console.error(`Error: Export file not found at ${exportPath}`);\r\n      console.error(\"Please run 'npm run export:users' first to create the export file.\");\r\n      process.exit(1);\r\n    }\r\n\r\n    console.log(`Reading users from ${exportPath}...`);\r\n    const fileContent = fs.readFileSync(exportPath, \"utf-8\");\r\n    const users: ExportedUser[] = JSON.parse(fileContent);\r\n\r\n    if (users.length === 0) {\r\n      console.warn(\"Warning: No users found in export file.\");\r\n      return;\r\n    }\r\n\r\n    console.log(`Found ${users.length} users to import.`);\r\n    console.log(\"Importing users (upserting by id)...\\n\");\r\n\r\n    let imported = 0;\r\n    const updated = 0;\r\n    let errors = 0;\r\n\r\n    for (const user of users) {\r\n      try {\r\n        // Convert date strings to Date objects, handling nulls\r\n        const createdAt = parseDate(user.createdAt) || new Date();\r\n        const verifiedAt = parseDate(user.verifiedAt);\r\n        const trialEndsAt = parseDate(user.trialEndsAt);\r\n        const lastLoginAt = parseDate(user.lastLoginAt);\r\n        const lastActivityAt = parseDate(user.lastActivityAt);\r\n\r\n        // Use upsert to create or update by id\r\n        const result = await prisma.user.upsert({\r\n          where: { id: user.id },\r\n          update: {\r\n            email: user.email,\r\n            passwordHash: user.passwordHash,\r\n            createdAt,\r\n            role: user.role || \"tradie\",\r\n            verificationStatus: user.verificationStatus || \"unverified\",\r\n            verifiedAt,\r\n            planTier: user.planTier || \"FREE\",\r\n            planStatus: user.planStatus || \"TRIAL\",\r\n            trialEndsAt,\r\n            lastLoginAt,\r\n            lastActivityAt,\r\n            totalJobs: user.totalJobs ?? 0,\r\n            totalJobPacks: user.totalJobPacks ?? 0,\r\n            businessName: user.businessName,\r\n            tradingName: user.tradingName,\r\n            abn: user.abn,\r\n            tradeTypes: user.tradeTypes, // Store as string (comma-separated or JSON)\r\n            serviceArea: user.serviceArea,\r\n            serviceAreaCity: user.serviceAreaCity,\r\n            serviceAreaRadiusKm: user.serviceAreaRadiusKm,\r\n          },\r\n          create: {\r\n            id: user.id,\r\n            email: user.email,\r\n            passwordHash: user.passwordHash,\r\n            createdAt,\r\n            role: user.role || \"tradie\",\r\n            verificationStatus: user.verificationStatus || \"unverified\",\r\n            verifiedAt,\r\n            planTier: user.planTier || \"FREE\",\r\n            planStatus: user.planStatus || \"TRIAL\",\r\n            trialEndsAt,\r\n            lastLoginAt,\r\n            lastActivityAt,\r\n            totalJobs: user.totalJobs ?? 0,\r\n            totalJobPacks: user.totalJobPacks ?? 0,\r\n            businessName: user.businessName,\r\n            tradingName: user.tradingName,\r\n            abn: user.abn,\r\n            tradeTypes: user.tradeTypes,\r\n            serviceArea: user.serviceArea,\r\n            serviceAreaCity: user.serviceAreaCity,\r\n            serviceAreaRadiusKm: user.serviceAreaRadiusKm,\r\n          },\r\n        });\r\n\r\n        // Check if it was created or updated by querying if createdAt matches\r\n        // (Simpler approach: assume first run = create, subsequent = update)\r\n        // For better tracking, we could check existence first, but upsert handles both\r\n        // Let's just track total processed\r\n        if (result) {\r\n          // Check if user existed before (rough check by comparing createdAt in DB vs export)\r\n          // Actually, simpler: just count all as processed\r\n          imported++;\r\n        }\r\n      } catch (error) {\r\n        errors++;\r\n        console.error(`ÔØî Error importing user ${user.email} (${user.id}):`, error);\r\n      }\r\n    }\r\n\r\n    console.log(\"\\nÔ£à Import completed!\");\r\n    console.log(`   Processed: ${imported} users`);\r\n    if (errors > 0) {\r\n      console.log(`   Errors: ${errors} users failed to import`);\r\n    }\r\n    console.log(\r\n      \"\\nNote: Upsert was used, so existing users were updated and new users were created.\"\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Fatal error during import:\", error);\r\n    process.exit(1);\r\n  } finally {\r\n    await prisma.$disconnect();\r\n    console.log(\"\\nDatabase connection closed.\");\r\n  }\r\n}\r\n\r\n// Run the import\r\nimportUsers().catch((error) => {\r\n  console.error(\"Fatal error:\", error);\r\n  process.exit(1);\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\scripts\\make-admin.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[716,719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[716,719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1931,1934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1931,1934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2464,2467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2464,2467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * One-off script to make a user an admin\r\n * Usage: npx ts-node --project scripts/tsconfig.json scripts/make-admin.ts <email>\r\n * \r\n * NOTE: This is a dev-only script. Do not use in production.\r\n * For production, use the /admin/users UI or API.\r\n */\r\n\r\nimport { getPrisma } from \"../lib/prisma\";\r\nimport { updateUser } from \"../lib/auth\";\r\nimport { kv } from \"../lib/kv\";\r\n\r\nasync function makeAdmin(email: string) {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n  \r\n  console.log(`Making ${normalizedEmail} an admin...`);\r\n  const prisma = getPrisma();\r\n  \r\n  try {\r\n    // First, try to find user in KV store (primary source)\r\n    const kvUser = (await kv.get(`user:email:${normalizedEmail}`)) as any;\r\n    \r\n    if (kvUser && kvUser.id) {\r\n      // Update in KV store (primary)\r\n      await updateUser(kvUser.id, {\r\n        isAdmin: true,\r\n        role: \"admin\",\r\n        verificationStatus: \"verified\",\r\n        verifiedAt: new Date().toISOString(),\r\n      });\r\n      console.log(`Ô£ô Updated user in KV store`);\r\n      console.log(`  User ID: ${kvUser.id}`);\r\n      console.log(`  Email: ${kvUser.email}`);\r\n      console.log(`  Role: admin`);\r\n      console.log(`  isAdmin: true`);\r\n    } else {\r\n      console.log(`ÔÜá User not found in KV store, checking Prisma...`);\r\n    }\r\n    \r\n    // Also update in Prisma if user exists there\r\n    try {\r\n      const prismaUser = await prisma.user.findUnique({\r\n        where: { email: normalizedEmail },\r\n      });\r\n      \r\n      if (prismaUser) {\r\n        await prisma.user.update({\r\n          where: { id: prismaUser.id },\r\n          data: {\r\n            role: \"admin\",\r\n          },\r\n        });\r\n        console.log(`Ô£ô Updated user in Prisma database`);\r\n        console.log(`  Prisma User ID: ${prismaUser.id}`);\r\n        console.log(`  Role: admin`);\r\n      } else {\r\n        console.log(`ÔÜá User not found in Prisma database`);\r\n      }\r\n    } catch (prismaError: any) {\r\n      console.warn(`ÔÜá Could not update Prisma (non-critical):`, prismaError.message);\r\n    }\r\n    \r\n    if (!kvUser || !kvUser.id) {\r\n      console.error(`Ô£ù User with email ${normalizedEmail} not found in KV store`);\r\n      console.error(`  Make sure the user has signed up and created an account first.`);\r\n      process.exit(1);\r\n    }\r\n    \r\n    console.log(`\\nÔ£ô Successfully made ${normalizedEmail} an admin`);\r\n    console.log(`  The user can now access /admin pages and has full admin privileges.`);\r\n  } catch (error: any) {\r\n    console.error(`Ô£ù Error: ${error.message}`);\r\n    console.error(error);\r\n    process.exit(1);\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n}\r\n\r\nconst email = process.argv[2];\r\nif (!email) {\r\n  console.error(\"Usage: npx ts-node --project scripts/tsconfig.json scripts/make-admin.ts <email>\");\r\n  console.error(\"Example: npx ts-node --project scripts/tsconfig.json scripts/make-admin.ts sarahkison5@gmail.com\");\r\n  process.exit(1);\r\n}\r\n\r\nmakeAdmin(email);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\chadm\\Downloads\\dev\\omnexora-mvp\\omnexora-mvp\\scripts\\migrate-primary-admin.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1392,1395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1392,1395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2536,2539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2536,2539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2658,2661],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2658,2661],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":83,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3181,3184],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3181,3184],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4383,4386],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4383,4386],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4505,4508],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4505,4508],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Migration script to update primary admin email from chadmspencer94@gmail.com to chad.omnexora@outlook.com\r\n * \r\n * This script is idempotent - safe to run multiple times.\r\n * \r\n * Usage: npx ts-node --project scripts/tsconfig.json scripts/migrate-primary-admin.ts\r\n * \r\n * What it does:\r\n * 1. Ensures chad.omnexora@outlook.com exists as a superadmin\r\n * 2. Keeps chadmspencer94@gmail.com as an admin (but not primary admin)\r\n * 3. Updates both users to have proper admin privileges\r\n */\r\n\r\nimport { kv } from \"../lib/kv\";\r\nimport { updateUser } from \"../lib/auth\";\r\nimport { getPrisma } from \"../lib/prisma\";\r\n\r\nconst OLD_PRIMARY_ADMIN = \"chadmspencer94@gmail.com\";\r\nconst NEW_PRIMARY_ADMIN = \"chad.omnexora@outlook.com\";\r\n\r\nasync function migratePrimaryAdmin() {\r\n  const prisma = getPrisma();\r\n  console.log(\"Starting primary admin migration...\");\r\n  console.log(`Old primary admin: ${OLD_PRIMARY_ADMIN}`);\r\n  console.log(`New primary admin: ${NEW_PRIMARY_ADMIN}`);\r\n  console.log(\"\");\r\n\r\n  // ========================================================================\r\n  // Update NEW primary admin (chad.omnexora@outlook.com)\r\n  // ========================================================================\r\n  console.log(`[1] Ensuring ${NEW_PRIMARY_ADMIN} is a superadmin...`);\r\n  \r\n  try {\r\n    const newAdminKV = (await kv.get(`user:email:${NEW_PRIMARY_ADMIN.toLowerCase()}`)) as any;\r\n    \r\n    if (newAdminKV && newAdminKV.id) {\r\n      // Update existing user to be superadmin\r\n      await updateUser(newAdminKV.id, {\r\n        role: \"admin\",\r\n        isAdmin: true,\r\n        verificationStatus: \"verified\",\r\n        verifiedAt: newAdminKV.verifiedAt || new Date().toISOString(),\r\n        planTier: \"FOUNDER\",\r\n        planStatus: \"ACTIVE\",\r\n      });\r\n      console.log(`  Ô£ô Updated ${NEW_PRIMARY_ADMIN} in KV store (ID: ${newAdminKV.id})`);\r\n    } else {\r\n      console.log(`  ÔÜá ${NEW_PRIMARY_ADMIN} not found in KV store - user needs to register first`);\r\n    }\r\n    \r\n    // Update in Prisma if exists\r\n    try {\r\n      const newAdminPrisma = await prisma.user.findUnique({\r\n        where: { email: NEW_PRIMARY_ADMIN.toLowerCase() },\r\n      });\r\n      \r\n      if (newAdminPrisma) {\r\n        await prisma.user.update({\r\n          where: { id: newAdminPrisma.id },\r\n          data: {\r\n            role: \"admin\",\r\n            planTier: \"FOUNDER\",\r\n            planStatus: \"ACTIVE\",\r\n          },\r\n        });\r\n        console.log(`  Ô£ô Updated ${NEW_PRIMARY_ADMIN} in Prisma database`);\r\n      }\r\n    } catch (prismaError: any) {\r\n      console.warn(`  ÔÜá Could not update Prisma (non-critical):`, prismaError.message);\r\n    }\r\n  } catch (error: any) {\r\n    console.error(`  Ô£ù Error updating ${NEW_PRIMARY_ADMIN}:`, error.message);\r\n  }\r\n\r\n  console.log(\"\");\r\n\r\n  // ========================================================================\r\n  // Keep OLD primary admin as regular admin (chadmspencer94@gmail.com)\r\n  // ========================================================================\r\n  console.log(`[2] Ensuring ${OLD_PRIMARY_ADMIN} remains as admin...`);\r\n  \r\n  try {\r\n    const oldAdminKV = (await kv.get(`user:email:${OLD_PRIMARY_ADMIN.toLowerCase()}`)) as any;\r\n    \r\n    if (oldAdminKV && oldAdminKV.id) {\r\n      // Keep as admin but not primary admin\r\n      await updateUser(oldAdminKV.id, {\r\n        role: \"admin\",\r\n        isAdmin: true,\r\n        verificationStatus: \"verified\",\r\n        verifiedAt: oldAdminKV.verifiedAt || new Date().toISOString(),\r\n        planTier: \"FOUNDER\",\r\n        planStatus: \"ACTIVE\",\r\n      });\r\n      console.log(`  Ô£ô Updated ${OLD_PRIMARY_ADMIN} in KV store (ID: ${oldAdminKV.id})`);\r\n      console.log(`  Ôä╣ ${OLD_PRIMARY_ADMIN} is now a regular admin (not primary admin)`);\r\n    } else {\r\n      console.log(`  ÔÜá ${OLD_PRIMARY_ADMIN} not found in KV store`);\r\n    }\r\n    \r\n    // Update in Prisma if exists\r\n    try {\r\n      const oldAdminPrisma = await prisma.user.findUnique({\r\n        where: { email: OLD_PRIMARY_ADMIN.toLowerCase() },\r\n      });\r\n      \r\n      if (oldAdminPrisma) {\r\n        await prisma.user.update({\r\n          where: { id: oldAdminPrisma.id },\r\n          data: {\r\n            role: \"admin\",\r\n            planTier: \"FOUNDER\",\r\n            planStatus: \"ACTIVE\",\r\n          },\r\n        });\r\n        console.log(`  Ô£ô Updated ${OLD_PRIMARY_ADMIN} in Prisma database`);\r\n      }\r\n    } catch (prismaError: any) {\r\n      console.warn(`  ÔÜá Could not update Prisma (non-critical):`, prismaError.message);\r\n    }\r\n  } catch (error: any) {\r\n    console.error(`  Ô£ù Error updating ${OLD_PRIMARY_ADMIN}:`, error.message);\r\n  }\r\n\r\n  console.log(\"\");\r\n  console.log(\"Migration complete!\");\r\n  console.log(\"\");\r\n  console.log(\"Summary:\");\r\n  console.log(`  - Primary admin: ${NEW_PRIMARY_ADMIN}`);\r\n  console.log(`  - Regular admin: ${OLD_PRIMARY_ADMIN}`);\r\n  console.log(\"\");\r\n  console.log(\"Note: Both emails are in ADMIN_EMAILS and FOUNDER_EMAILS arrays in lib/auth.ts\");\r\n}\r\n\r\n// Run migration\r\nmigratePrimaryAdmin()\r\n  .then(() => {\r\n    console.log(\"Migration script finished successfully\");\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error(\"Migration script failed:\", error);\r\n    process.exit(1);\r\n  });\r\n\r\n","usedDeprecatedRules":[]}]
